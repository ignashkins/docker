; /* /bitrix/js/im/common.min.js?1599568296353923*/
; /* /bitrix/js/im/window.min.js?159956819317813*/
; /* /bitrix/js/im/im.min.js?1599568296672551*/
; /* /bitrix/js/im/call/simple_vad.min.js?15995682282434*/
; /* /bitrix/js/im/call/controller.min.js?159956829635715*/
; /* /bitrix/js/im/call/engine.min.js?159956829611520*/
; /* /bitrix/js/im/call/hardware.min.js?15995682964177*/
; /* /bitrix/js/im/call/hardware_dialog.min.js?15995682281614*/
; /* /bitrix/js/im/call/abstract_call.min.js?15995682963690*/
; /* /bitrix/js/im/call/plain_call.min.js?159956829641352*/
; /* /bitrix/js/im/call/voximplant_call.min.js?159956829835429*/
; /* /bitrix/js/im/call/util.min.js?15995682966289*/
; /* /bitrix/js/im/call/view.min.js?159956829650925*/
; /* /bitrix/js/im/call/notification.min.js?15995682286073*/
; /* /bitrix/js/im/call/notification_conference.min.js?15995682965523*/
; /* /bitrix/js/im/call/invite_popup.min.js?15995682968269*/
; /* /bitrix/js/im/call/floating_video.min.js?159956822815062*/
; /* /bitrix/js/im/call/logger.min.js?15995682962518*/
; /* /bitrix/js/im/call/video_strategy.min.js?15995682964901*/

; /* Start:"a:4:{s:4:"full";s:44:"/bitrix/js/im/common.min.js?1599568296353923";s:6:"source";s:23:"/bitrix/js/im/common.js";s:3:"min";s:27:"/bitrix/js/im/common.min.js";s:3:"map";s:27:"/bitrix/js/im/common.map.js";}"*/
(function(e){if(e.BX.MessengerCommon)return;var s=e.BX;var t=function(){this.BXIM={};this.sendBotCommand=false;this.sendBotCommandBlock={};this.tryCheckConnect={};this.externalLink={}};t.prototype.setBxIm=function(e){this.BXIM=e};t.prototype.isIntranet=function(){return this.BXIM.bitrixIntranet};t.prototype.isPage=function(){return typeof s.MessengerWindow!="undefined"};t.prototype.isPopupPage=function(){return typeof s.MessengerWindow!="undefined"&&this.BXIM.context=="POPUP-FULLSCREEN"&&this.BXIM.bitrixIntranet};t.prototype.isDesktop=function(){return typeof s.desktop!="undefined"&&s.desktop.apiReady};t.prototype.getDefaultZIndex=function(){var e=1e3;if(typeof s.SidePanel!=="undefined"&&s.SidePanel.Instance.isOpen()){var t=s.SidePanel.Instance.getTopSlider();if(t){e=t.getZindex()-s.PopupWindow.getOption("popupZindex")}}return e};t.prototype.isSliderEnable=function(){return typeof s.SidePanel!=="undefined"};t.prototype.isSliderSupport=function(){return this.isSliderEnable()&&(!this.isDesktop()||this.isDesktop()&&s.desktop.enableInVersion(44))};t.prototype.isSliderBindingsEnable=function(){return this.isSliderSupport()&&typeof s.SidePanel.Instance.isAnchorBinding!=="undefined"};t.prototype.isMobile=function(){return this.BXIM.mobileVersion};t.prototype.hideLinesKeyboard=function(){if(this.textPanelShowed){this.textPanelShowed=false;BXMobileApp.UI.Page.TextPanel.hide()}};t.prototype.isSessionBlocked=function(e){var t=s.MessengerCommon.linesGetSession(this.BXIM.messenger.chat[e]);if(t&&t.blockDate!==0&&new Date(t.blockDate*1e3)<new Date){return true}return false};t.prototype.isMobileNative=function(){return false};t.prototype.isLinesOperator=function(){return this.BXIM.messenger.openlines&&this.BXIM.messenger.openlines.queue&&this.BXIM.messenger.openlines.queue.length>0};t.prototype.isBot=function(e){return typeof this.BXIM.messenger.bot[e]!="undefined"};t.prototype.isBirthday=function(e){var s=new Date;var t=("0"+s.getDate().toString()).substr(-2)+"-"+("0"+(s.getMonth()+1).toString()).substr(-2);return e==t};t.prototype.getDebugInfo=function(){return{context:this.BXIM.context,design:this.BXIM.design,isDesktop:this.isDesktop()?"Y":"N",isPage:this.isPage()?"Y":"N",isMobile:this.isMobile()?"Y":"N",vInitedCall:s.localStorage.get("vInitedCall")?"Y":"N",desktopStatus:this.BXIM.desktopStatus?"Y":"N",hasActiveCall:s.MessengerCalls.hasActiveCall()?"Y":"N",hasActiveCallTab:this.BXIM.callController.hasActiveCall()?"Y":"N",appVersion:navigator.appVersion}};t.prototype.checkInternetConnection=function(e,t,r,i){if(typeof e!="function"){e=function(){if(typeof BXIM!="undefined"){BXIM.messenger.connectionStatus("online",false)}}}if(typeof t!="function")t=function(){};if(typeof r!="number")r=1;if(!i&&r>1)i=+new Date;if(typeof BXIM!="undefined"){BXIM.messenger.connectionStatus("connecting")}s.ajax({url:"//www.bitrixsoft.com/200.ok."+ +new Date,method:"GET",dataType:"html",skipAuthCheck:true,skipBxHeader:true,timeout:1,onsuccess:function(a){if(a=="OK"){console.log("Checking internet connection... success!");delete s.MessengerCommon.tryCheckConnect[i];e()}else{if(typeof BXIM!="undefined"){BXIM.messenger.connectionStatus("offline")}console.log("Checking internet connection... failure!");if(r==1){delete s.MessengerCommon.tryCheckConnect[i];t()}else{if(typeof BXIM!="undefined"){BXIM.messenger.connectionStatus("connecting")}clearTimeout(s.MessengerCommon.tryCheckConnect[i]);s.MessengerCommon.tryCheckConnect[i]=setTimeout(function(){s.MessengerCommon.checkInternetConnection(e,t,r-1,i)},5e3)}}},onfailure:function(){console.log("Checking internet connection... failure!");if(r==1){delete s.MessengerCommon.tryCheckConnect[i];t()}else{clearTimeout(s.MessengerCommon.tryCheckConnect[i]);s.MessengerCommon.tryCheckConnect[i]=setTimeout(function(){s.MessengerCommon.checkInternetConnection(e,t,r-1,i)},5e3)}}});return true};t.prototype.pinDialog=function(e,t){this.recentListElementPin(e,t);s.rest.callMethod("im.recent.pin",{DIALOG_ID:e,ACTION:t?"Y":"N"})};t.prototype.muteMessageChat=function(e,t,r){var i=0;if(e.toString().substr(0,4)=="chat"){i=e.toString().substr(4);if(!this.BXIM.messenger.chat[i])return false}else{i=this.BXIM.messenger.userChat[e];if(!i)return false}r=r!=false;if(!this.BXIM.messenger.userChatBlockStatus[i])this.BXIM.messenger.userChatBlockStatus[i]={};if(typeof t=="undefined"){if(typeof this.BXIM.messenger.userChatBlockStatus[i][this.BXIM.userId]=="undefined"){t=true}else{t=!this.BXIM.messenger.userChatBlockStatus[i][this.BXIM.userId]}}else{t=Boolean(t)}this.BXIM.messenger.userChatBlockStatus[i][this.BXIM.userId]=t;this.BXIM.messenger.chat[i].mute_list[this.BXIM.userId]=t;this.BXIM.messenger.dialogStatusRedraw();this.BXIM.messenger.updateMessageCount();var a=this.BXIM.messenger.userChatBlockStatus[i][this.BXIM.userId]?"Y":"N";if(r){s.ajax({url:this.BXIM.pathToAjax+"?CHAT_MUTE&V="+this.BXIM.revision+"&logTag="+s.MessengerCommon.getLogTrackingParams({name:"im.chat.mute",dialog:s.MessengerCommon.getDialogDataForTracking("chat"+i),data:{timMuteAction:a}}),method:"POST",dataType:"json",timeout:60,data:{IM_CHAT_MUTE:"Y",CHAT_ID:i,MUTE:a,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()}})}};t.prototype.MobileActionEqual=function(e){if(!this.isMobile())return true;for(var s=0;s<arguments.length;s++){if(arguments[s]==this.BXIM.mobileAction)return true}return false};t.prototype.MobileActionNotEqual=function(e){if(!this.isMobile())return false;for(var s=0;s<arguments.length;s++){if(arguments[s]==this.BXIM.mobileAction)return false}return true};t.prototype.isScrollMax=function(s,t){if(!s)return true;t=typeof t=="number"?t:0;if(this.isMobile()){var r=e.orientation==0?screen.height-125:screen.width-113;return document.body.scrollHeight-r-r/2<=s.scrollTop}else{return s.scrollHeight-s.offsetHeight-t<=s.scrollTop}};t.prototype.isScrollMin=function(e){if(!e)return false;return 0==e.scrollTop};t.prototype.enableScroll=function(e,t,r){if(!e)return false;if(this.BXIM.messenger.isBodyScroll)return false;r=r!==false;t=400;var i=this.BXIM.messenger.unreadMessage[this.BXIM.messenger.currentTab]&&this.BXIM.messenger.unreadMessage[this.BXIM.messenger.currentTab][0]?s("im-message-"+this.BXIM.messenger.unreadMessage[this.BXIM.messenger.currentTab][0]):null;if(i){var a=i.parentNode.parentNode.parentNode.parentNode.parentNode.previousElementSibling?i.parentNode.parentNode.parentNode.parentNode.parentNode.previousElementSibling:i.parentNode.parentNode.parentNode.parentNode.parentNode;var n=this.isElementVisibleOnScreen(a,e,true);if(!n.top){this.scrollToNode(i.parentNode.parentNode.parentNode.parentNode.parentNode);return false}}return r&&this.isScrollMax(e,t)};t.prototype.preventDefault=function(t){t=t||e.event;if(t.stopPropagation)t.stopPropagation();else t.cancelBubble=true;if(typeof BXIM!="undefined"&&BXIM.messenger&&BXIM.messenger.closeMenuPopup)BXIM.messenger.closeMenuPopup();if(typeof s!="undefined"&&s.calendar&&s.calendar.get().popup)s.calendar.get().popup.close()};t.prototype.countObject=function(e){var s=0;for(var t in e){if(e.hasOwnProperty(t)){s++}}return s};t.prototype.isElementCoordsBelow=function(e,s,t,r){if(this.isMobile()){return true}if(!s||typeof s.getElementsByClassName=="undefined"){return false}t=t?t:0;var i=this.getElementCoords(e,s);i.bottom=i.top+e.offsetHeight;var a=i.top>=t;var n=i.bottom>t;if(r){return{top:a,bottom:n,coords:i}}else{return a||n}};t.prototype.isElementVisibleOnScreen=function(e,s,t){if(this.isMobile()){return BitrixMobile.Utils.isElementVisibleOnScreen(e)}if(!s||typeof s.getElementsByClassName=="undefined"){return false}var r=this.getElementCoords(e,s);r.bottom=r.top+e.offsetHeight;var i=s.scrollTop;var a=i+s.clientHeight;var n=r.top>=0&&r.top<a;var o=r.bottom>0&&r.bottom<s.clientHeight;if(t){return{result:n||o,top:n,bottom:o,coords:r}}else{return n||o}};t.prototype.getElementCoords=function(e,s){if(this.isMobile()){return BitrixMobile.Utils.getElementCoords(e)}if(!s||typeof s.getElementsByClassName=="undefined"){return false}var t=e.getBoundingClientRect();var r=s.getBoundingClientRect();return{originTop:t.top,originLeft:t.left,top:t.top-r.top,left:t.left-r.left}};t.prototype.getDateFormatType=function(e){e=e?e.toString().toUpperCase():"DEFAULT";var t=[];if(e=="MESSAGE_TITLE"){t=[["tommorow","tommorow"],["today","today"],["yesterday","yesterday"],["",s.Main.Date.convertBitrixFormat(s.message("IM_M_MESSAGE_TITLE_FORMAT_DATE"))]]}else if(e=="MESSAGE"){t=[["",s.message("IM_M_MESSAGE_FORMAT_TIME")]]}else if(e=="RECENT_TITLE"){t=[["tommorow","today"],["today","today"],["yesterday","yesterday"],["",s.Main.Date.convertBitrixFormat(s.message("IM_CL_RESENT_FORMAT_DATE"))]]}else if(e=="RECENT_OL_TITLE"){t=[["tommorow","tommorow"],["today","today"],["yesterday","yesterday"],["",s.Main.Date.convertBitrixFormat(s.message("IM_CL_RESENT_FORMAT_DATE"))]]}else{t=[["tommorow","tommorow, "+s.message("IM_M_MESSAGE_FORMAT_TIME")],["today","today, "+s.message("IM_M_MESSAGE_FORMAT_TIME")],["yesterday","yesterday, "+s.message("IM_M_MESSAGE_FORMAT_TIME")],["",s.Main.Date.convertBitrixFormat(s.message("FORMAT_DATETIME"))]]}return t};t.prototype.formatDate=function(e,t){if(typeof t=="undefined"){t=this.getDateFormatType("DEFAULT")}if(!s.type.isDate(e)){if(typeof e=="string"){e=new Date(e)}console.log(e,t);console.trace()}return s.Main.Date.format(t,Math.round(e.getTime()/1e3)+parseInt(s.message("SERVER_TZ_OFFSET"))+parseInt(s.message("USER_TZ_OFFSET")),Math.round((new Date).getTime()/1e3)+parseInt(s.message("SERVER_TZ_OFFSET"))+parseInt(s.message("USER_TZ_OFFSET")),true)};t.prototype.getNowDate=function(e){var s=new Date;if(e===true){s=new Date(s.getFullYear(),s.getMonth(),s.getDate(),0,0,0)}return s};t.prototype.formatUrl=function(e){if(this.isMobile()&&this.BXIM.webComponent&&currentDomain){if(e&&e.indexOf("/")===0){e=currentDomain+e;return encodeURI(e)}}return e};t.prototype.isBlankAvatar=function(e){return e==""||e.toString().indexOf(this.BXIM.pathToBlankImage)>=0};t.prototype.getDefaultAvatar=function(e){return"/bitrix/js/im/images/default-avatar-"+e+".png"};t.prototype.hideErrorImage=function(e,t){if(t){s.remove(e.parentNode);return true}var r=e.src;if(e.parentNode&&e.parentNode.parentNode){e.parentNode.parentNode.className="bx-messenger-message";e.parentNode.parentNode.innerHTML='<a href="'+r+'" target="_blank">'+r+"</a>"}return true};t.prototype.prepareText=function(e,t,r,i,a,n){var o=e;t=t==true;r=r==true;i=i==true;a=a?a:false;o=s.util.trim(o);if(o.indexOf("/me")==0){o=o.substr(4);o="<i>"+o+"</i>"}else if(o.indexOf("/loud")==0){o=o.substr(6);o="<b>"+o+"</b>"}var l="&gt;&gt;";if(r&&o.indexOf(l)>=0){var m=false;var h=o.split("<br />");for(var g=0;g<h.length;g++){if(h[g].substring(0,l.length)==l){h[g]=h[g].replace(l,'<div class="bx-messenger-content-quote"><span class="bx-messenger-content-quote-icon"></span><div class="bx-messenger-content-quote-wrap">');while(++g<h.length&&h[g].substring(0,l.length)==l){h[g]=h[g].replace(l,"")}h[g-1]+="</div></div>";m=true}}o=h.join("<br />")}if(t){o=s.util.htmlspecialchars(o)}o=this.decodeBbCode(o,r);if(r){o=o.replace(/------------------------------------------------------<br \/>(.*?)\[(.*?)\]<br \/>(.*?)------------------------------------------------------(<br \/>)?/g,function(e,s,t,r,i,a){return(a>0?"<br>":"")+'<div class="bx-messenger-content-quote"><span class="bx-messenger-content-quote-icon"></span><div class="bx-messenger-content-quote-wrap"><div class="bx-messenger-content-quote-name">'+s+' <span class="bx-messenger-content-quote-time">'+t+"</span></div>"+r+"</div></div><br />"});o=o.replace(/------------------------------------------------------<br \/>(.*?)------------------------------------------------------(<br \/>)?/g,function(e,s,t,r,i){return(i>0?"<br>":"")+'<div class="bx-messenger-content-quote"><span class="bx-messenger-content-quote-icon"></span><div class="bx-messenger-content-quote-wrap">'+s+"</div></div><br />"})}if(t){o=o.replace(/\n/gi,"<br />")}o=o.replace(/\t/gi,"&nbsp;&nbsp;&nbsp;&nbsp;");if(i){var p=false;o=o.replace(/<a(.*?)>(http[s]{0,1}:\/\/.*?)<\/a>/gi,function(e,t,r,i){if(!r.match(/(\.(jpg|jpeg|png|gif)\?|\.(jpg|jpeg|png|gif)$)/i)||r.toLowerCase().indexOf("/docs/pub/")>0||r.toLowerCase().indexOf("logout=yes")>0){return e}else if(s.MessengerCommon.isMobile()){p=true;return(i>0?"<br />":"")+'<span class="bx-messenger-file-image"><span class="bx-messenger-file-image-src"><img src="'+r+'" class="bx-messenger-file-image-text" onclick="BXIM.messenger.openPhotoGallery(this.src);" onerror="BX.MessengerCommon.hideErrorImage(this)"></span></span>'}else{p=true;var a=typeof this.BXIM.messenger.getChatId!="undefined"?this.BXIM.messenger.getChatId():this.BXIM.messenger.currentTab;return(i>0?"<br />":"")+'<span class="bx-messenger-file-image"><a'+t+' target="_blank" class="bx-messenger-file-image-src"><img src="'+r+'" data-viewer="null" data-viewer-group-by="'+a+'" data-title="'+s.util.jsencode(r)+'" class="bx-messenger-file-image-text" onerror="BX.MessengerCommon.hideErrorImage(this)"></a></span>'}});if(p){o=o.replace(/<\/span>(\n?)<br(\s\/?)>/gi,"</span>").replace(/<br(\s\/?)>(\n?)<br(\s\/?)>(\n?)<span/gi,"<br /><span")}}if(a){o=o.replace(new RegExp("("+a.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")+")","ig"),'<span class="bx-messenger-highlight">$1</span>')}if(this.BXIM.settings.enableBigSmile){var I=false;o=o.replace(/^(\s*<img\s+src=[^>]+?data-code=[^>]+?data-definition="UHD"[^>]+?style="width:)(\d+)(px[^>]+?height:)(\d+)(px[^>]+?class="bx-smile"\s*\/?>\s*)$/,function e(s,t,r,i,a,n){I=true;return t+parseInt(r,10)*1.6+i+parseInt(a,10)*1.6+n});if(n&&I){n.oneSmileInMessage=true}}if(o.substr(-6)=="<br />"){o=o.substr(0,o.length-6)}o=o.replace(/<br><br \/>/gi,"<br />");o=o.replace(/<br \/><br>/gi,"<br />");return o};t.prototype.trimText=function(e){return s.util.trim(e)};t.prototype.purifyText=function(e,t){e=e?e.toString():"";if(e){e=this.trimText(e);if(e.indexOf("/me")==0){e=e.substr(4)}else if(e.indexOf("/loud")==0){e=e.substr(6)}if(e.substr(-6)=="<br />"){e=e.substr(0,e.length-6)}e=e.replace(/<br><br \/>/gi,"<br />");e=e.replace(/<br \/><br>/gi,"<br />");e=e.replace(/\[[buis]\](.*?)\[\/[buis]\]/gi,"$1");e=e.replace(/\[CODE\]\n?([\0-\uFFFF]*?)\[\/CODE\]/gi,"$1");e=e.replace(/\[url\](.*?)\[\/url\]/gi,"$1");e=e.replace(/\[RATING=([1-5]{1})\]/gi,function(e,t){return"["+s.message("IM_F_RATING")+"] "});e=e.replace(/\[ATTACH=([0-9]{1,})\]/gi,function(e,t){return"["+s.message("IM_F_ATTACH")+"] "});e=e.replace(/\[USER=([0-9]{1,})\](.*?)\[\/USER\]/gi,"$2");e=e.replace(/\[CHAT=([0-9]{1,})\](.*?)\[\/CHAT\]/gi,"$2");e=e.replace(/\[SEND=([0-9]{1,})\](.*?)\[\/SEND\]/gi,"$2");e=e.replace(/\[PUT=([0-9]{1,})\](.*?)\[\/PUT\]/gi,"$2");e=e.replace(/\[CALL=([0-9]{1,})\](.*?)\[\/CALL\]/gi,"$2");e=e.replace(/\[PCH=([0-9]{1,})\](.*?)\[\/PCH\]/gi,"$2");e=e.replace(/<img.*?data-code="([^"]*)".*?>/gi,"$1");e=e.replace(/<span.*?title="([^"]*)".*?>.*?<\/span>/gi,"($1)");e=e.replace(/<img.*?title="([^"]*)".*?>/gi,"($1)");e=e.replace(/\[ATTACH=([0-9]{1,})\]/gi,function(e,t,r){return t==1e4?"":"["+s.message("IM_F_ATTACH")+"] "});e=e.replace(/<s>([^"]*)<\/s>/gi," ");e=e.replace(/\[s\]([^"]*)\[\/s\]/gi," ");e=e.replace(/\[icon\=([^\]]*)\]/gi,function(e){var t=e.match(/title\=(.*[^\s\]])/i);if(t&&t[1]){t=t[1];if(t.indexOf("width=")>-1){t=t.substr(0,t.indexOf("width="))}if(t.indexOf("height=")>-1){t=t.substr(0,t.indexOf("height="))}if(t.indexOf("size=")>-1){t=t.substr(0,t.indexOf("size="))}if(t){t="("+this.trimText(t)+")"}}else{t="("+s.message("IM_M_ICON")+")"}return t}.bind(this));e=e.replace("<br />"," ").replace(/<\/?[^>]+>/gi,"").replace(/------------------------------------------------------(.*?)------------------------------------------------------/gim," ["+s.message("IM_M_QUOTE_BLOCK")+"] ");e=this.trimText(e)}if(e.length<=0){if(t&&t.FILE_ID&&t.FILE_ID.length>0){e="["+s.message("IM_F_FILE")+"]"}else if(t&&t.ATTACH&&t.ATTACH.length>0){e="["+s.message("IM_F_ATTACH")+"]"}else{e=s.message("IM_M_DELETED")}}return e};t.prototype.decodeBbCode=function(e,t,r){t=typeof t?false:t;var i=[];e=e.replace(/\[CODE\]\n?([\0-\uFFFF]*?)\[\/CODE\]/gi,function(e,s){var t=i.length;i.push(s);return"####REPLACEMENT_MARK_"+t+"####"});e=e.replace(/\[LIKE\]/gi,'<span class="bx-smile bx-im-smile-like" title="'+s.message("IM_MESSAGE_LIKE")+'"></span>');e=e.replace(/\[DISLIKE\]/gi,'<span class="bx-smile bx-im-smile-dislike" title="'+s.message("IM_MESSAGE_DISLIKE")+'"></span>');e=e.replace(/\[USER=([0-9]{1,})\](.*?)\[\/USER\]/gi,s.delegate(function(e,s,r){var i="";if(this.BXIM.messenger.openChatFlag&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)]&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)].type=="livechat")return r;s=parseInt(s);if(!t&&r&&s>0)i='<span class="bx-messenger-ajax '+(s==this.BXIM.userId?"bx-messenger-ajax-self":"")+'" data-entity="user" data-userId="'+s+'">'+r+"</span>";else i=r;return i},this));e=e.replace(/\[CHAT=(imol\|)?([0-9]{1,})\](.*?)\[\/CHAT\]/gi,function(e,s,r,i){var a="";r=parseInt(r);if(!t&&i&&r>0&&typeof BXIM!="undefined"){if(s){a='<span class="bx-messenger-ajax" data-entity="openlines" data-sessionId="'+r+'">'+i+"</span>"}else{a='<span class="bx-messenger-ajax" data-entity="chat" data-chatId="'+r+'">'+i+"</span>"}}else{a=i}return a});e=e.replace(/\[PCH=([0-9]{1,})\](.*?)\[\/PCH\]/gi,function(e,s,r){var i="";s=parseInt(s);if(!t&&r&&s>0)i='<span class="bx-messenger-ajax" data-entity="phoneCallHistory" data-historyId="'+s+'">'+r+"</span>";else i=r;return i});e=e.replace(/\[SEND(?:=(.+?))?\](.+?)?\[\/SEND\]/gi,function(e,r,i){var a="";i=i?i:r;r=(r?r:i).replace("<br />","\n");if(!t&&i){i=i.replace(/<([\w]+)[^>]*>(.*?)<\\1>/i,"$2",i);i=i.replace(/\[([\w]+)[^\]]*\](.*?)\[\/\1\]/i,"$2",i);a='<span class="bx-messenger-command" data-entity="send" title="'+s.message("IM_BB_SEND")+'">'+i+"</span>";a+='<span class="bx-messenger-command-data">'+r+"</span>"}else{a=i}return a});e=e.replace(/\[PUT(?:=(.+?))?\](.+?)?\[\/PUT\]/gi,function(e,r,i){var a="";i=i?i:r;r=(r?r:i).replace("<br />","\n");if(!t&&i){i=i.replace(/<([\w]+)[^>]*>(.*?)<\/\1>/i,"$2",i);i=i.replace(/\[([\w]+)[^\]]*\](.*?)\[\/\1\]/i,"$2",i);a='<span class="bx-messenger-command" data-entity="put" title="'+s.message("IM_BB_PUT")+'">'+i+"</span>";a+='<span class="bx-messenger-command-data">'+r+"</span>"}else{a=i}return a});e=e.replace(/\[CALL(?:=(.+?))?\](.+?)?\[\/CALL\]/gi,function(e,r,i){var a="";i=i?i:r;r=r?r:i;if(!t&&i)a='<span class="bx-messenger-command" data-entity="call" data-command="'+s.util.htmlspecialchars(r)+'">'+i+"</span>";else a=i;return a});var a=0;if(this.BXIM.settings.enableBigSmile){a=s.util.trim(e.replace(/\[icon\=([^\]]*)\]/gi,"")).length}e=e.replace(/\[icon\=([^\]]*)\]/gi,s.delegate(function(e){var t=e.match(/icon\=(\S+[^\s.,> )\];\'\"!?])/i);if(t&&t[1]){t=t[1]}else{return""}var r={src:t,border:0};var i=e.match(/size\=(\d+)/i);if(i&&i[1]){r["width"]=i[1];r["height"]=i[1]}else{var n=e.match(/width\=(\d+)/i);if(n&&n[1]){r["width"]=n[1]}var o=e.match(/height\=(\d+)/i);if(o&&o[1]){r["height"]=o[1]}if(r["width"]&&!r["height"]){r["height"]=r["width"]}else if(r["height"]&&!r["width"]){r["width"]=r["height"]}else if(r["height"]&&r["width"]){}else{r["width"]=20;r["height"]=20}}r["width"]=r["width"]>100?100:r["width"];r["height"]=r["height"]>100?100:r["height"];if(this.BXIM.settings.enableBigSmile&&a==0&&r["width"]==r["height"]&&r["width"]==20){r["width"]=40;r["height"]=40}var l=e.match(/title\=(.*[^\s\]])/i);if(l&&l[1]){l=l[1];if(l.indexOf("width=")>-1){l=l.substr(0,l.indexOf("width="))}if(l.indexOf("height=")>-1){l=l.substr(0,l.indexOf("height="))}if(l.indexOf("size=")>-1){l=l.substr(0,l.indexOf("size="))}if(l){l=s.util.trim(l);r["title"]=l;r["alt"]=l}}else{r["title"]=s.message("IM_M_ICON");r["alt"]=r["title"]}return s.create("img",{attrs:r,props:{className:"bx-smile bx-icon"}}).outerHTML},this));e=e.replace(/\[RATING\=([1-5]{1})\]/gi,s.delegate(function(e,s){return this.linesVoteHeadNodes(0,s,false).outerHTML},this));if(i.length>0){for(var n=0;n<i.length;n++){e=e.replace("####REPLACEMENT_MARK_"+n+"####",!t?'<div class="bx-messenger-code">'+i[n]+"</div>":i[n])}}return e};t.prototype.openLink=function(e,t){t=t||"_blank";var r=s.create("a",{attrs:{href:e,style:"display:none",target:t}});document.body.appendChild(r);r.click();document.body.removeChild(r);return true};t.prototype.clipboardCopy=function(e,t){document.execCommand(t==true?"cut":"copy");var r=s.create("textarea",{style:{position:"absolute",opacity:0,top:-1e3,left:-1e3}});document.body.insertBefore(r,document.body.firstChild);r.focus();document.execCommand("paste");var i=r.value;var a=null;if(typeof e=="function"){a=e(r.value)}else if(typeof e=="string"){a=e}if(a){i=r.value=a;r.selectionStart=0;document.execCommand("copy")}s.remove(r);return i};t.prototype.clipboardCut=function(){return this.clipboardCopy(null,true)};t.prototype.prepareTextBack=function(e,t){var r=e;t=t===true;r=s.util.htmlspecialcharsback(r);r=r.replace(/<(\/*)([buis]+)>/gi,"[$1$2]");r=r.replace(/<img.*?data-code="([^"]*)".*?>/gi,"$1");r=r.replace(/<a.*?href="([^"]*)".*?>.*?<\/a>/gi,"$1");if(!t){r=r.replace(/\[CODE\]\n?([\0-\uFFFF]*?)(<br\/?>)?\[\/CODE\]/gi,"["+s.message("IM_M_CODE_BLOCK")+"]");r=r.replace(/------------------------------------------------------(.*?)------------------------------------------------------/gim,"["+s.message("IM_M_QUOTE_BLOCK")+"]")}r=r.split("&nbsp;&nbsp;&nbsp;&nbsp;").join("\t");r=r.split("&nbsp;").join(" ");r=r.split("<br />").join("\n");return r};t.prototype.addMentionList=function(e,s,t){if(!e||!s)return false;if(!this.BXIM.messenger.mentionList[e])this.BXIM.messenger.mentionList[e]={};this.BXIM.messenger.mentionList[e][s]=t};t.prototype.prepareMention=function(e,s){if(!this.BXIM.messenger.mentionList[e])return s;for(var t in this.BXIM.messenger.mentionList[e]){var r=this.BXIM.messenger.mentionList[e][t];if(!r){continue}if(r.toString().substr(0,4)=="chat"){s=s.split(t).join("[CHAT="+r.toString().substr(4)+"]"+t+"[/CHAT]")}else{s=s.split(t).join("[USER="+r+"]"+t+"[/USER]")}}this.clearMentionList(e);return s};t.prototype.clearMentionList=function(e){delete this.BXIM.messenger.mentionList[e]};t.prototype.getRecipientByChatId=function(e){var s=0;if(this.BXIM.messenger.chat[e]){s="chat"+e}else{for(var t in this.BXIM.messenger.userChat){if(this.BXIM.messenger.userChat[t]==e){s=t;break}}}return s};t.prototype.getUserIdByChatId=function(e){var s=0;for(var t in this.BXIM.messenger.userChat){if(this.BXIM.messenger.userChat[t]==e){s=t;break}}return s};t.prototype.getUserParam=function(e,t){e=typeof e=="undefined"?this.BXIM.userId:e;t=typeof t=="boolean"?t:false;if(e&&(e.toString().substr(0,4)=="chat"||e.toString().substr(0,2)=="sg"||e.toString().substr(0,3)=="crm")){var r=e.toString().substr(0,4)=="chat"?e.toString().substr(4):e;if(t||!(this.BXIM.messenger.chat[r]&&this.BXIM.messenger.chat[r].id)){this.BXIM.messenger.chat[r]={id:r,name:s.message("IM_M_LOAD_USER"),owner:0,work_position:"",avatar:this.BXIM.pathToBlankImage,type:"chat",color:"#556574",fake:true,date_create:false};if(t){this.BXIM.messenger.chat[r].fake=false}}return this.BXIM.messenger.chat[r]}else{if(t||!(this.BXIM.messenger.users[e]&&this.BXIM.messenger.users[e].id)){var i=parseInt(e)?this.BXIM.path.profileTemplate.replace("#user_id#",e):"";this.BXIM.messenger.users[e]={id:e,avatar:this.BXIM.pathToBlankImage,name:s.message("IM_M_LOAD_USER"),profile:i,status:"guest",work_position:"",extranet:false,network:false,color:"#556574",fake:true,last_activity_date:new Date(0),mobile_last_date:new Date(0),absent:false,idle:false};this.BXIM.messenger.hrphoto[e]="/bitrix/js/im/images/hidef-avatar-v3.png";if(t){this.BXIM.messenger.users[e].fake=false}}return this.BXIM.messenger.users[e]}};t.prototype.userInChat=function(e,s){if(!this.BXIM.messenger.userInChat[e])return false;if(typeof s=="undefined"){s=this.BXIM.userId}else{s=parseInt(s)}var t=false;if(typeof this.BXIM.messenger.userInChat[e].indexOf!="undefined"){if(this.BXIM.messenger.userInChat[e].indexOf(s.toString())>-1||this.BXIM.messenger.userInChat[e].indexOf(parseInt(s))>-1){t=true}}else{for(var r=0;r<this.BXIM.messenger.userInChat[e].length;r++){if(parseInt(this.BXIM.messenger.userInChat[e][r])==parseInt(s)){t=true;break}}}return t};t.prototype.onOnlineStatusCallback=function(e,s,t,r,i){console.log("Run callback for",i,e,s,t,r)};t.prototype.getUserStatus=function(e,t){t=t!==false;var r=this.getOnlineData(e);var i="offline";var a="";var n="";var o="";if(!e){i="guest";a=s.message("IM_STATUS_GUEST")}else if(e.network){i="network";a=s.message("IM_STATUS_NETWORK");if(e.bot&&this.BXIM.messenger.bot[e.id]&&this.BXIM.messenger.bot[e.id].type=="support24"){i="support24"}}else if(e.bot){i="bot";a=s.message("IM_STATUS_BOT")}else if(e.connector){i=e.status=="offline"?"lines":"lines-online";a=s.message("IM_CL_USER_LINES")}else if(e.status=="guest"){i="guest";a=s.message("IM_STATUS_GUEST")}else if(this.getCurrentUser()==e.id){i=e.status?e.status.toString():"online";a=i?s.message("IM_STATUS_"+i.toUpperCase()):""}else if(!r.isOnline){i="offline";a=s.message("IM_STATUS_OFFLINE")}else if(this.getUserMobileStatus(e)){i="mobile";a=s.message("IM_STATUS_MOBILE")}else if(this.getUserIdleStatus(e,r)){i="idle";a=s.message("IM_STATUS_AWAY_TITLE").replace("#TIME#",this.getUserIdle(e))}else{i=e.status?e.status.toString():"offline";a=s.message("IM_STATUS_"+i.toUpperCase())}if(e&&this.isBirthday(e.birthday)&&(e.status=="online"||!r.isOnline)){n=i;o=a;i="birthday";if(r.isOnline){a=s.message("IM_M_BIRTHDAY_MESSAGE_SHORT")}else{a=s.message("IM_STATUS_OFFLINE")}}else if(e&&e.absent){n=i;o=a;i="vacation";if(r.isOnline){a=s.message("IM_STATUS_ONLINE")}else{a=s.message("IM_STATUS_VACATION")}}return t?i:{status:i,statusText:a,originStatus:n?n:i,originStatusText:o?o:a}};t.prototype.getOnlineData=function(e){var t={};if(e){if(e.id==this.getCurrentUser()){e.last_activity_date=new Date;e.mobile_last_date=new Date(0);e.idle=false}t=s.user.getOnlineStatus(e.last_activity_date)}return t};t.prototype.getUserIdle=function(e){if(!e){return""}var s="";if(e.idle){var t=((new Date).getTime()-e.idle.getTime())/1e3>=3600?"Hdiff":"idiff";s=this.formatDate(e.idle,[["s60","sdiff"],["i60","idiff"],["H24","Hdiff"],["","ddiff"]])}return s};t.prototype.getUserMobileStatus=function(e){if(!e)return false;return e.mobile_last_date&&new Date-e.mobile_last_date<parseInt(s.message("LIMIT_ONLINE"))*1e3&&e.last_activity_date-e.mobile_last_date<300*1e3};t.prototype.getUserIdleStatus=function(e,t){if(!e)return"";t=t?t:s.user.getOnlineStatus(e.last_activity_date);return e.idle&&t.isOnline};t.prototype.getUserPosition=function(e,t){t=t===true;if(!e)return"";var r="";if(t&&e.last_activity_date&&!(e.bot||e.network)){r=this.getUserLastDate(e);if(r){return r}}if(e.work_position){r=e.work_position}else if(e.extranet||e.network){r=s.message("IM_CL_USER_EXTRANET")}else if(e.bot){r=s.message("IM_CL_BOT")}else{r=this.isIntranet()?s.message("IM_CL_USER"):s.message("IM_CL_USER_B24")}return r};t.prototype.getUserLastDate=function(e){if(!e){return""}var t="";var r={};if(e.bot||e.network){t=""}else if(e.absent&&!this.getUserMobileStatus(e)){r=this.getOnlineData(e);t=s.message("IM_STATUS_VACATION_TITLE").replace("#DATE#",s.Main.Date.format(s.Main.Date.convertBitrixFormat(s.message("FORMAT_DATE")),e.absent.getTime()/1e3));if(r.isOnline&&e.idle){t=s.message("IM_STATUS_AWAY_TITLE").replace("#TIME#",this.getUserIdle(e))}else if(r.isOnline&&!r.lastSeenText){t=s.message("IM_STATUS_ONLINE")+". "+t}else if(r.lastSeenText){t=s.message("IM_LS_"+(e.gender=="F"?"F":"M")).replace("#POSITION#",t).replace("#LAST_SEEN#",r.lastSeenText)}}else if(e.last_activity_date){r=this.getOnlineData(e);if(r.isOnline&&e.idle&&!this.getUserMobileStatus(e)){t=s.message("IM_STATUS_AWAY_TITLE").replace("#TIME#",this.getUserIdle(e))}else if(r.isOnline&&!r.lastSeenText){if(this.isMobile()&&this.getUserMobileStatus(e)){t=s.message("IM_STATUS_MOBILE")}else{t=s.message("IM_STATUS_ONLINE")}}else if(r.lastSeenText){t=s.message("IM_LS_SHORT_"+(e.gender=="F"?"F":"M")).replace("#LAST_SEEN#",r.lastSeenText)}}return t};t.prototype.isIntranet=function(){return this.BXIM.bitrixIntranet};t.prototype.getCurrentUser=function(){return this.BXIM.userId};t.prototype.getDialogId=function(){if(this.BXIM.messenger.currentTab.toString().substr(0,4)=="chat"){return this.BXIM.messenger.currentTab}return parseInt(this.BXIM.messenger.currentTab)};t.prototype.getLogTrackingParams=function(e){if(typeof e!=="object"||!e){e={}}var t=e.name||"tracking";var r=e.data||[];var i=e.dialog||null;var a=e.message||null;var n=e.files||null;var o=[];t=encodeURIComponent(t);if(r&&!s.type.isArray(r)&&typeof r==="object"){var l=[];for(var m in r){if(r.hasOwnProperty(m)){l.push(encodeURIComponent(m)+"="+encodeURIComponent(r[m]))}}r=l}else if(!s.type.isArray(r)){r=[]}if(i){o.push("timType="+i.type);if(i.type==="lines"){o.push("timLinesType="+i.entityId.split("|")[0])}}if(n){var h="file";if(s.type.isArray(n)&&n[0]){h=n[0].type}else{h=n.type}o.push("timMessageType="+h)}else if(a){o.push("timMessageType=text")}if(navigator.userAgent&&navigator.userAgent.toLowerCase().indexOf("bitrixmobile")>-1){o.push("timDevice=bitrixMobile")}else if(navigator.userAgent&&navigator.userAgent.toLowerCase().indexOf("bitrixdesktop")>-1){o.push("timDevice=bitrixDesktop")}else if(navigator.userAgent.toLowerCase().indexOf("iphone")>-1||navigator.userAgent.toLowerCase().indexOf("ipad")>-1||navigator.userAgent.toLowerCase().indexOf("android")>-1){o.push("timDevice=mobile")}else{o.push("timDevice=web")}return t+(r.length?"&"+r.join("&"):"")+(o.length?"&"+o.join("&"):"")};t.prototype.getDialogDataForTracking=function(e){var s={type:"private",entityId:"",entityTypeId:""};if(e.toString().indexOf("chat")===0){s.type="chat";var t=e.toString().substr(4);if(this.BXIM.messenger.chat[t]){s.type=this.BXIM.messenger.chat[t].type;s.entityTypeId=this.BXIM.messenger.chat[t].entity_type_id;s.entityId=this.BXIM.messenger.chat[t].entity_id}}return s};t.prototype.getChatUsers=function(){if(this.BXIM.messenger.currentTab.toString().substr(0,4)!="chat"){return[].push(parseInt(this.BXIM.messenger.currentTab))}var e=this.BXIM.messenger.currentTab.toString().substr(4);var s=[];if(this.BXIM.messenger.userInChat[e]){s=this.BXIM.messenger.userInChat[e].map(function(e){return parseInt(e)})}return s};t.prototype.setColor=function(e,t){if(!this.BXIM.init&&this.isDesktop()){s.desktop.onCustomEvent("bxSaveColor",[{color:e,chatId:t}]);return false}if(typeof e!="string"){return false}else{e=e.toUpperCase()}if(typeof t!="undefined"){if(typeof this.BXIM.messenger.chat[t]=="undefined"){return false}}else{t=0;if(this.BXIM.userColor==e){return false}}s.ajax({url:this.BXIM.pathToAjax+"?SET_COLOR&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_SET_COLOR:"Y",COLOR:e,CHAT_ID:t,sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(e){if(e.ERROR==""){if(parseInt(e.CHAT_ID)==0){this.BXIM.userColor=e.COLOR;if(this.isPage()){setTimeout(function(){s.MessengerWindow.setUserInfo(s.MessengerCommon.getUserParam())},500)}}}},this)})};t.prototype.checkRestriction=function(e,s){if(!this.BXIM.messenger.chat[e])return null;if(!this.BXIM.messenger.chat[e].entity_type)return false;var t=this.BXIM.messenger.chat[e].entity_type;if(typeof this.BXIM.messenger.userChatOptions[t]=="undefined"||typeof this.BXIM.messenger.userChatOptions[t][s]=="undefined")return false;if(!this.BXIM.messenger.userChatOptions[t][s])return true;return false};t.prototype.getEntityTypePath=function(e){if(!this.BXIM.messenger.chat[e])return null;if(!this.BXIM.messenger.chat[e].entity_type)return null;var t=this.BXIM.messenger.chat[e].entity_type;if(t=="CRM"){var r=this.BXIM.messenger.chat[e].entity_id.toString().split("|");if(!this.BXIM.path.crm[r[0]]){return null}return{PATH:this.BXIM.path.crm[r[0]].replace("#ID#",r[1]),TITLE:s.message("IM_M_OL_GOTO_CRM")}}else{if(typeof this.BXIM.messenger.userChatOptions[t]=="undefined")return null;if(!this.BXIM.messenger.userChatOptions[t]["PATH"])return null;return{PATH:this.BXIM.messenger.userChatOptions[t]["PATH"].replace("#ID#",this.BXIM.messenger.chat[e].entity_id),TITLE:this.BXIM.messenger.userChatOptions[t]["PATH_TITLE"]}}};t.prototype.renameChat=function(e,t){e=parseInt(e);if(this.BXIM.messenger.popupMessengerConnectionStatusState!="online"||!t||e<=0)return false;t=s.util.trim(t);if(t.length<=0||this.BXIM.messenger.chat[e].name==s.util.htmlspecialchars(t))return false;var r=this.BXIM.messenger.chat[e].name;this.BXIM.messenger.chat[e].name=s.util.htmlspecialchars(t);s.ajax({url:this.BXIM.pathToAjax+"?CHAT_RENAME&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{IM_CHAT_RENAME:"Y",CHAT_ID:e,CHAT_TITLE:t,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(s){if(s.ERROR){if(this.BXIM.messenger.popupMessengerPanelChatTitle){this.BXIM.messenger.popupMessengerPanelChatTitle.innerHTML=r}this.BXIM.messenger.chat[e].name=r}},this)});return true};t.prototype.userListRedraw=function(e){if(this.isMobile()){if(!this.MobileActionEqual("RECENT")){return false}}if(this.BXIM.messenger.recentList&&this.BXIM.messenger.contactListSearchText!=null&&this.BXIM.messenger.contactListSearchText.length==0){this.recentListRedraw(e)}else if(this.BXIM.messenger.chatList){this.chatListRedraw(e)}else{this.contactListRedraw(e);if(this.BXIM.messenger.recentListExternal){this.recentListRedraw(e)}}};t.prototype.contactListRedraw=function(e){if(this.BXIM.messenger.popupMessenger==null)return false;e=e||{};if(!this.isMobile()){this.BXIM.messenger.chatList=false;this.BXIM.messenger.contactList=true;this.BXIM.messenger.recentList=false;if(this.BXIM.messenger.popupPopupMenu!=null&&this.BXIM.messenger.popupPopupMenu.uniquePopupId.replace("bx-messenger-popup-","")=="contactList"){this.BXIM.messenger.popupPopupMenu.close()}}if(this.BXIM.messenger.contactListSearchText.length>0){this.contactListPrepareSearch("contactList",this.BXIM.messenger.popupContactListElementsWrap,this.BXIM.messenger.contactListSearchText,e.FORCE?{}:{params:false,timeout:this.isMobile()?500:100})}else{if(this.BXIM.messenger.redrawContactListTimeout["contactList"])clearTimeout(this.BXIM.messenger.redrawContactListTimeout["contactList"]);this.BXIM.messenger.popupContactListElementsWrap.innerHTML="";this.BXIM.messenger.popupContactListElementsWrap.appendChild(this.contactListPrepare());if(this.isMobile()){BitrixMobile.LazyLoad.showImages()}}e.SEND=e.SEND==true;if(!this.isMobile()&&e.SEND){s.localStorage.set("mrd",{viewGroup:this.BXIM.settings.viewGroup,viewOffline:this.BXIM.settings.viewOffline},5)}};t.prototype.contactListPrepareSearch=function(e,t,r,i){if(!t)return false;if(this.BXIM.messenger.openLinesFlag&&(e=="popupChatDialogContactListElements"&&this.BXIM.messenger.popupChatDialogDestType=="CHAT_EXTEND"||e=="popupTransferDialogContactListElements")){i.viewOffline=true;i.viewOnlyIntranet=true;i.viewOnlyBusiness=true;i.viewChat=false;i.viewOfflineWithPhones=false}var a={listName:e,groupOpen:true,viewSelf:e=="contactList",viewOffline:true,viewOnlyBusiness:false,viewGroup:true,viewChat:true,viewBot:true,viewTransferViQueue:false,viewTransferOlQueue:false,viewOpenChat:true,viewOfflineWithPhones:false,extra:false,searchText:r,callback:{empty:function(){}}};if(i!=false){for(var n in i){if(n=="timeout"||n=="params")continue;a[n]=i[n]}}var o=i.timeout?i.timeout:0;if(o>0){clearTimeout(this.BXIM.messenger.redrawContactListTimeout[e]);this.BXIM.messenger.redrawContactListTimeout[e]=setTimeout(s.delegate(function(){t.innerHTML="";t.appendChild(this.contactListPrepare(a));if(this.isMobile()){BitrixMobile.LazyLoad.showImages()}},this),o)}else{t.innerHTML="";t.appendChild(this.contactListPrepare(a));if(this.isMobile()){BitrixMobile.LazyLoad.showImages()}}};t.prototype.contactListPrepare=function(e){e=typeof e=="object"?e:{};return this.chatListPrepare(e)};t.prototype.contactListClickItem=function(e){this.BXIM.messenger.closeMenuPopup();var t=s.proxy_context.getAttribute("data-userId");if(t.toString().substr(0,9)=="structure"){var r=t.toString().substr(9);var i=this.BXIM.messenger.groups[r].name.split(" / ")[0];this.BXIM.messenger.popupContactListSearchInput.value=i;this.BXIM.messenger.contactListSearchText=t;this.contactListPrepareSearch("contactList",this.BXIM.messenger.popupContactListElementsWrap,this.BXIM.messenger.contactListSearchText,{});return s.PreventDefault(e)}if(this.BXIM.messenger.contactList){s.MessengerCommon.recentListElementToTop(s.proxy_context.getAttribute("data-userId"))}if(this.isMobile()||!this.BXIM.messenger.chatList){this.BXIM.messenger.popupContactListSearchInput.value="";this.BXIM.messenger.contactListSearchText="";s.localStorage.set("mns",this.BXIM.messenger.contactListSearchText,5);this.BXIM.messenger.chatList=false;this.BXIM.messenger.recentList=true;this.BXIM.messenger.contactList=false;this.BXIM.messenger.contactListShowed={};this.BXIM.messenger.realSearch=!this.BXIM.options.contactListLoad;this.userListRedraw()}if(this.isMobile()){this.BXIM.messenger.openMessenger(s.proxy_context.getAttribute("data-userId"),s.proxy_context)}else{this.BXIM.messenger.openMessenger(s.proxy_context.getAttribute("data-userId"));if(this.BXIM.callController.hasActiveCall()){this.BXIM.callController.fold()}}return s.PreventDefault(e)};t.prototype.contactListGetFromServer=function(t){if(this.BXIM.messenger.contactListLoad)return false;if(!s.type.isFunction(t))t=s.DoNothing;this.BXIM.messenger.contactListLoad=true;s.ajax({url:this.BXIM.pathToAjax+"?CONTACT_LIST&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_CONTACT_LIST:"Y",IM_AJAX_CALL:"Y",DESKTOP:this.isDesktop()?"Y":"N",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(r){if(r&&r.BITRIX_SESSID){s.message({bitrix_sessid:r.BITRIX_SESSID})}if(r.ERROR==""){for(var i in r.USERS){r.USERS[i].last_activity_date=new Date(r.USERS[i].last_activity_date);r.USERS[i].mobile_last_date=new Date(r.USERS[i].mobile_last_date);r.USERS[i].idle=r.USERS[i].idle?new Date(r.USERS[i].idle):false;r.USERS[i].absent=r.USERS[i].absent?new Date(r.USERS[i].absent):false;this.BXIM.messenger.users[i]=r.USERS[i]}for(var i in r.GROUPS)this.BXIM.messenger.groups[i]=r.GROUPS[i];for(var i in r.CHATS){if(this.BXIM.messenger.chat[i]&&this.BXIM.messenger.chat[i].fake)r.CHATS[i].fake=true;else if(!this.BXIM.messenger.chat[i])r.CHATS[i].fake=true;r.CHATS[i].date_create=new Date(r.CHATS[i].date_create);this.BXIM.messenger.chat[i]=r.CHATS[i]}for(var i in r.PHONES){this.BXIM.messenger.phones[i]={};for(var a in r.PHONES[i]){this.BXIM.messenger.phones[i][a]=s.util.htmlspecialcharsback(r.PHONES[i][a])}}for(var i in r.USER_IN_GROUP){if(typeof this.BXIM.messenger.userInGroup[i]=="undefined"||typeof this.BXIM.messenger.userInGroup[i].users=="undefined"||!this.BXIM.messenger.userInGroup[i].users.length){this.BXIM.messenger.userInGroup[i]=r.USER_IN_GROUP[i]}else{for(var a=0;a<r.USER_IN_GROUP[i].users.length;a++)this.BXIM.messenger.userInGroup[i].users.push(r.USER_IN_GROUP[i].users[a]);this.BXIM.messenger.userInGroup[i].users=s.util.array_unique(this.BXIM.messenger.userInGroup[i].users)}}this.userListRedraw();if(!this.isMobile()){this.BXIM.messenger.dialogStatusRedraw();if(this.BXIM.messenger.popupChatDialogContactListElements!=null){this.contactListPrepareSearch("popupChatDialogContactListElements",this.BXIM.messenger.popupChatDialogContactListElements,this.BXIM.messenger.popupChatDialogContactListSearch.value,{viewOffline:true,viewChat:false,viewOpenChat:this.BXIM.messenger.popupChatDialogContactListElementsType=="MENTION"})}if(this.BXIM.webrtc.popupTransferDialogContactListElements!=null){this.contactListPrepareSearch("popupTransferDialogContactListElements",this.BXIM.webrtc.popupTransferDialogContactListElements,this.BXIM.webrtc.popupTransferDialogContactListSearch.value,{viewChat:false,viewOpenChat:false,viewOffline:false,viewBot:false,viewOnlyIntranet:true,viewOfflineWithPhones:true})}if(this.BXIM.messenger.popupTransferDialogContactListElements!=null){this.contactListPrepareSearch("popupTransferDialogContactListElements",this.BXIM.messenger.popupTransferDialogContactListElements,this.BXIM.messenger.popupTransferDialogContactListSearch.value,{viewChat:false,viewOpenChat:false,viewOffline:false,viewBot:false,viewTransferOlQueue:true,viewOnlyIntranet:true,viewOfflineWithPhones:false})}}t()}else{this.BXIM.messenger.contactListLoad=false;if(r.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;setTimeout(s.delegate(this.contactListGetFromServer,this),2e3);s.onCustomEvent(e,"onImError",[r.ERROR,r.BITRIX_SESSID])}else if(r.ERROR=="AUTHORIZE_ERROR"){this.BXIM.messenger.sendAjaxTry++;if(this.isDesktop()||this.isMobile()){setTimeout(s.delegate(this.contactListGetFromServer,this),1e4)}s.onCustomEvent(e,"onImError",[r.ERROR])}}},this),onfailure:s.delegate(function(){this.BXIM.messenger.sendAjaxTry=0;this.BXIM.messenger.contactListLoad=false},this)})};t.prototype.contactListRealSearch=function(e,t){if(!this.BXIM.messenger.realSearch)return false;this.contactListRealSearchText=e;clearTimeout(this.BXIM.messenger.contactListSearchTimeout);this.BXIM.messenger.contactListSearchTimeout=setTimeout(s.delegate(function(){if(this.contactListRealSearchText.length<3){this.BXIM.messenger.realSearchFound=true;return false}s.ajax({url:this.BXIM.pathToAjax+"?CONTACT_LIST_SEARCH&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_CONTACT_LIST_SEARCH:"Y",SEARCH:this.contactListRealSearchText,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(e){this.BXIM.messenger.realSearchFound=true;this.BXIM.messenger.userInGroup["search"]={id:"search",users:[]};for(var s in e.USERS){if(this.BXIM.messenger.users[s]){continue}e.USERS[s].last_activity_date=new Date(e.USERS[s].mobile_last_date);e.USERS[s].mobile_last_date=new Date(e.USERS[s].mobile_last_date);e.USERS[s].idle=e.USERS[s].idle?new Date(e.USERS[s].idle):false;e.USERS[s].absent=e.USERS[s].absent?new Date(e.USERS[s].absent):false;this.BXIM.messenger.users[s]=e.USERS[s];this.BXIM.messenger.userInGroup["search"]["users"].push(s);if(e.USERS[s].bot&&e.USERS[s].network){this.BXIM.messenger.bot[s]={type:"network"};this.BXIM.messenger.users[s].extranet=false}}if(typeof t!="undefined"){t()}else if(this.BXIM.messenger.contactList){this.contactListRedraw({FORCE:true})}},this),onfailure:s.delegate(function(){this.BXIM.messenger.realSearchFound=true},this)})},this),1500)};t.prototype.contactListSearchClear=function(e){if(!this.BXIM.messenger.popupContactListSearchInput)return;clearTimeout(this.BXIM.messenger.contactListSearchTimeout);clearTimeout(this.BXIM.messenger.redrawChatListTimeout);clearTimeout(this.BXIM.messenger.redrawRecentListTimeout);if(this.BXIM.messenger.redrawContactListTimeout["contactList"])clearTimeout(this.BXIM.messenger.redrawContactListTimeout["contactList"]);this.BXIM.messenger.realSearch=!this.BXIM.options.contactListLoad;this.BXIM.messenger.realSearchFound=true;this.BXIM.messenger.popupContactListSearchInput.value="";this.BXIM.messenger.contactListSearchText=s.util.trim(this.BXIM.messenger.popupContactListSearchInput.value);s.localStorage.set("mns",this.BXIM.messenger.contactListSearchText,5);s.addClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-normal");s.removeClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-active bx-messenger-box-contact-hover");this.BXIM.messenger.popupContactListActive=false;this.BXIM.messenger.popupContactListHovered=false;clearTimeout(this.BXIM.messenger.popupContactListWrapAnimation);this.BXIM.messenger.chatList=false;this.BXIM.messenger.recentList=true;this.BXIM.messenger.contactList=false;this.BXIM.messenger.contactListShowed={};this.BXIM.messenger.userInGroup["search"]={id:"search",users:[]};this.userListRedraw()};t.prototype.contactListSearch=function(e){if(e.keyCode==16||e.keyCode==18||e.keyCode==20||e.keyCode==244||e.keyCode==91)return false;if(e.keyCode==37||e.keyCode==39)return true;if(this.BXIM.messenger.popupContactListSearchInput.value!=this.BXIM.messenger.contactListSearchLastText||this.BXIM.messenger.popupContactListSearchInput.value==""){}else if(e.keyCode==224||e.keyCode==18||e.keyCode==17){return true}if(e.keyCode==38||e.keyCode==40){return true}if(this.isMobile()){this.BXIM.messenger.chatList=false;this.BXIM.messenger.recentList=false;this.BXIM.messenger.contactList=true;if(!app.enableInVersion(10)){setTimeout(function(){document.body.scrollTop=0},100)}}else{if(e.keyCode==27){if(this.BXIM.messenger.realSearch){this.BXIM.messenger.realSearchFound=true}if(this.BXIM.messenger.contactListSearchText<=0&&!this.BXIM.messenger.chatList){this.BXIM.messenger.popupContactListSearchInput.value="";if(!this.isMobile()&&this.BXIM.messenger.popupMessenger&&!this.BXIM.messenger.desktop.ready()&&!this.BXIM.callController.hasActiveCall()){this.BXIM.messenger.popupMessenger.destroy();return true}}else{this.contactListSearchClear();this.BXIM.messenger.popupMessengerTextarea.focus();return true}}this.BXIM.messenger.chatList=false;this.BXIM.messenger.recentList=false;this.BXIM.messenger.contactList=true;if(e.keyCode==13){var t=true;var r=s.findChildByClassName(this.BXIM.messenger.popupContactListElementsWrap,"bx-messenger-cl-item");if(r){this.recentListElementToTop(r.getAttribute("data-userId"));this.BXIM.messenger.openMessenger(r.getAttribute("data-userid"))}else{var r=s.findChildByClassName(this.BXIM.messenger.popupContactListElementsWrap,"bx-messenger-chatlist-search-button");if(r){t=false;this.BXIM.messenger.chatListSearchAction(r);return true}}if(t){if(this.BXIM.messenger.realSearch){this.BXIM.messenger.realSearchFound=true}this.BXIM.messenger.popupContactListSearchInput.value=""}}}if(this.BXIM.messenger.popupContactListSearchInput.value==this.BXIM.messenger.contactListSearchLastText){return true}this.BXIM.messenger.contactListSearchText=s.util.trim(this.BXIM.messenger.popupContactListSearchInput.value);this.BXIM.messenger.contactListSearchLastText=this.BXIM.messenger.contactListSearchText;if(this.BXIM.messenger.realSearch){this.BXIM.messenger.realSearchFound=this.BXIM.messenger.contactListSearchText.length<3}if(!this.isMobile()){s.localStorage.set("mns",this.BXIM.messenger.contactListSearchText,5)}if(this.BXIM.messenger.contactListSearchText==""){if(this.BXIM.messenger.realSearch){this.BXIM.messenger.realSearchFound=true;this.BXIM.messenger.realSearch=!this.BXIM.options.contactListLoad}this.BXIM.messenger.chatList=false;this.BXIM.messenger.recentList=true;this.BXIM.messenger.contactList=false;s.addClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-normal");s.removeClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-active bx-messenger-box-contact-hover");this.BXIM.messenger.popupContactListActive=false;this.BXIM.messenger.popupContactListHovered=false;clearTimeout(this.BXIM.messenger.popupContactListWrapAnimation)}else{s.addClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-active");s.removeClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-hover bx-messenger-box-contact-normal");this.BXIM.messenger.popupContactListActive=true;this.BXIM.messenger.popupContactListHovered=true;clearTimeout(this.BXIM.messenger.popupContactListWrapAnimation);this.contactListRealSearch(this.BXIM.messenger.contactListSearchText)}this.userListRedraw()};t.prototype.recentListRedraw=function(e){clearTimeout(this.BXIM.messenger.redrawRecentListTimeout);if(this.MobileActionNotEqual("RECENT"))return false;if(this.BXIM.messenger.recentList&&this.BXIM.messenger.popupMessenger){if(!this.isMobile()){if(this.BXIM.messenger.popupMessenger==null)return false;this.BXIM.messenger.chatList=false;this.BXIM.messenger.recentList=true;this.BXIM.messenger.contactList=false}if(this.BXIM.messenger.popupContactListActive){s.addClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-normal");s.removeClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-active bx-messenger-box-contact-hover");this.BXIM.messenger.popupContactListActive=false;this.BXIM.messenger.popupContactListHovered=false;clearTimeout(this.BXIM.messenger.popupContactListWrapAnimation)}if(this.BXIM.messenger.contactListSearchText==null||this.BXIM.messenger.contactListSearchText.length>0){this.BXIM.messenger.contactListSearchText="";this.BXIM.messenger.popupContactListSearchInput.value=""}if(this.BXIM.messenger.redrawContactListTimeout["contactList"])clearTimeout(this.BXIM.messenger.redrawContactListTimeout["contactList"]);if(!this.isMobile()&&this.BXIM.messenger.popupPopupMenu!=null&&this.BXIM.messenger.popupPopupMenu.uniquePopupId.replace("bx-messenger-popup-","")=="contactList"){this.BXIM.messenger.popupPopupMenu.close()}this.BXIM.messenger.popupContactListElementsWrap.innerHTML="";if(this.isPage()&&s.MessengerWindow.currentTab=="im-ol"){s.addClass(this.BXIM.messenger.popupContactListElementsWrap,"bx-messenger-recent-lines-wrap");this.BXIM.messenger.popupContactListElementsWrap.appendChild(this.recentLinesListPrepare(e))}else{s.removeClass(this.BXIM.messenger.popupContactListElementsWrap,"bx-messenger-recent-lines-wrap");this.BXIM.messenger.popupContactListElementsWrap.appendChild(this.recentListPrepare(e))}if(this.BXIM.messenger.recentListExternal){this.BXIM.messenger.recentListExternal.innerHTML=this.BXIM.messenger.popupContactListElementsWrap.innerHTML}if(this.isMobile()){BitrixMobile.LazyLoad.showImages()}}else if(this.BXIM.messenger.recentListExternal){this.BXIM.messenger.recentListExternal.innerHTML="";this.BXIM.messenger.recentListExternal.appendChild(this.recentListPrepare(e))}};t.prototype.recentListPrepare=function(e){var t=document.createDocumentFragment();var r={};e=typeof e=="object"?e:{};var i=e.showOnlyChat;if(!this.BXIM.messenger.recentListLoad){t.appendChild(s.create("div",{props:{className:"bx-messenger-cl-item-load"},html:s.message("IM_CL_LOAD")}));this.recentListGetFromServer();return t}if(this.isMobile()){BitrixMobile.LazyLoad.clearImages()}for(var a in this.BXIM.messenger.unreadMessage){if(this.inRecentList(a))continue;if(a.toString().substr(0,4)=="chat"){var n=this.BXIM.messenger.chat[a.toString().substr(4)];if(n&&n.entity_type=="LINES"&&this.BXIM.settings.linesTabEnable){continue}}else{var n=this.BXIM.messenger.users[a]}if(typeof n=="undefined"||typeof n.name=="undefined"){this.readMessage(a,true,true);continue}var o=Math.max.apply(Math,this.BXIM.messenger.unreadMessage[a]);if(this.BXIM.messenger.message[o]){this.BXIM.messenger.recent.push({chatId:this.BXIM.messenger.message[o].chatId,date:this.BXIM.messenger.message[o].date,id:o,params:{},recipientId:a.toString().substr(0,4)=="chat"?a:this.BXIM.userId,senderId:this.BXIM.messenger.message[o].senderId,text:this.BXIM.messenger.message[o].text,userId:a,userIsChat:a.toString().substr(0,4)=="chat"})}}this.BXIM.messenger.recent.sort(function(e,s){var t=e.date.getTime();var r=s.date.getTime();if(t>r){return-1}else if(t<r){return 1}else{if(e>s){return-1}else if(e<s){return 1}else{return 0}}});s.MessengerCalls.get().forEach(function(e){if(!r["calls"]){r["calls"]=true;t.appendChild(s.create("div",{props:{className:"bx-messenger-recent-group bx-messenger-recent-group-calls"},children:[s.create("span",{props:{className:"bx-messenger-recent-group-title"},html:s.message("IM_RECENT_CALLS")})]}))}var i=s.MessengerCalls.drawElement(e);if(i){t.appendChild(i)}});this.BXIM.messenger.recentListIndex=[];var l=this.isMobile()?49:999999;var m={};for(var h=0;h<this.BXIM.messenger.recent.length;h++){if(!this.BXIM.messenger.recent[h].pinned){continue}if(typeof this.BXIM.messenger.recent[h].userIsChat=="undefined"){this.BXIM.messenger.recent[h].userIsChat=this.BXIM.messenger.recent[h].recipientId.toString().substr(0,4)=="chat"}var g=s.clone(this.BXIM.messenger.recent[h]);if(h>l){if(!this.BXIM.messenger.unreadMessage[g.userId]||this.BXIM.messenger.unreadMessage[g.userId]&&this.BXIM.messenger.unreadMessage[g.userId].length==0){continue}}var p="";if(g.userIsChat){var n=this.BXIM.messenger.chat[g.userId.toString().substr(4)];if(typeof n=="undefined"||typeof n.name=="undefined"||this.isPage()&&n.entity_type=="LINES"&&this.BXIM.settings.linesTabEnable&&this.isLinesOperator())continue;var I="chat"+n.id}else if(!i){var n=this.BXIM.messenger.users[g.userId];if(typeof n=="undefined"||typeof n.name=="undefined")continue;if(typeof n.active!="undefined"&&!n.active&&!this.BXIM.messenger.unreadMessage[n.id])continue;var I=n.id}else{continue}m[I]=true;if(!r["favorites"]){r["favorites"]=true;t.appendChild(s.create("div",{props:{className:"bx-messenger-recent-group bx-messenger-recent-group-pinned"},children:[s.create("span",{props:{className:"bx-messenger-recent-group-title"},html:s.message("IM_RECENT_PINNED")})]}))}var d=this.drawContactListElement({id:I,data:n,text:g.text,textSenderId:g.senderId,textParams:g.params,pinned:g.pinned});if(d){t.appendChild(d);this.BXIM.messenger.recentListIndex.push(I)}}var r={};for(var h=0;h<this.BXIM.messenger.recent.length;h++){if(this.BXIM.messenger.recent[h].pinned){continue}if(typeof this.BXIM.messenger.recent[h].userIsChat=="undefined"){this.BXIM.messenger.recent[h].userIsChat=this.BXIM.messenger.recent[h].recipientId.toString().substr(0,4)=="chat"}var g=s.clone(this.BXIM.messenger.recent[h]);if(h>l){if(!this.BXIM.messenger.unreadMessage[g.userId]||this.BXIM.messenger.unreadMessage[g.userId]&&this.BXIM.messenger.unreadMessage[g.userId].length==0){continue}}var p="";if(g.userIsChat){var n=this.BXIM.messenger.chat[g.userId.toString().substr(4)];if(typeof n=="undefined"||typeof n.name=="undefined"||this.isPage()&&n.entity_type=="LINES"&&this.BXIM.settings.linesTabEnable&&this.isLinesOperator())continue;var I="chat"+n.id}else if(!i){var n=this.BXIM.messenger.users[g.userId];if(typeof n=="undefined"||typeof n.name=="undefined")continue;if(typeof n.active!="undefined"&&!n.active&&!this.BXIM.messenger.unreadMessage[n.id])continue;var I=n.id}else{continue}m[I]=true;if(g.date){g.date=this.formatDate(g.date,this.getDateFormatType("RECENT_TITLE"));if(!r[g.date]){r[g.date]=true;t.appendChild(s.create("div",{props:{className:"bx-messenger-recent-group"},children:[s.create("span",{props:{className:"bx-messenger-recent-group-title"},html:g.date})]}))}}else{if(!r["never"]){r["never"]=true;t.appendChild(s.create("div",{props:{className:"bx-messenger-recent-group"},children:[s.create("span",{props:{className:"bx-messenger-recent-group-title"},html:s.message("IM_RESENT_NEVER")})]}))}}var d=this.drawContactListElement({id:I,data:n,text:g.text,textSenderId:g.senderId,textParams:g.params});if(d){t.appendChild(d);this.BXIM.messenger.recentListIndex.push(I)}}if(t.childNodes.length<=0){t.appendChild(s.create("div",{props:{className:"bx-messenger-cl-item-empty"},html:s.message("IM_M_CL_EMPTY")}))}return t};t.prototype.recentLinesListPrepare=function(e){var t=document.createDocumentFragment();e=typeof e=="object"?e:{};if(!this.BXIM.messenger.recentListLoad){t.appendChild(s.create("div",{props:{className:"bx-messenger-cl-item-load"},html:s.message("IM_CL_LOAD")}));this.recentListGetFromServer();return t}if(this.isMobile()){BitrixMobile.LazyLoad.clearImages()}var r={};var i=false;for(var a=0;a<this.BXIM.messenger.openlines.queue.length;a++){r[this.BXIM.messenger.openlines.queue[a].id]=parseInt(this.BXIM.messenger.openlines.queue[a].priority);if(!i&&r[this.BXIM.messenger.openlines.queue[a].id]>0){i=true}}var n={};var o=this.isMobile()?49:999999;var l=[];this.BXIM.messenger.recentListIndex=[];var m={};for(var a=0;a<this.BXIM.messenger.recent.length;a++){if(typeof this.BXIM.messenger.recent[a].userIsChat=="undefined"){this.BXIM.messenger.recent[a].userIsChat=this.BXIM.messenger.recent[a].recipientId.toString().substr(0,4)=="chat"}var h=this.BXIM.messenger.recent[a];if(a>o){if(!this.BXIM.messenger.unreadMessage[h.userId]||this.BXIM.messenger.unreadMessage[h.userId]&&this.BXIM.messenger.unreadMessage[h.userId].length==0){continue}}var g="";if(typeof h.userIsChat=="undefined"){h.userIsChat=h.recipientId.toString().substr(0,4)=="chat"}if(h.userIsChat){var p=this.BXIM.messenger.chat[h.userId.toString().substr(4)];if(typeof p=="undefined"||typeof p.name=="undefined"||p.entity_type!="LINES")continue;h.chatId=p.id;var I="chat"+p.id}else{continue}m[I]=true;if(i&&!n[h.chatId]){var d=p.entity_id.toString().split("|");n[h.chatId]=r[d[1]]?r[d[1]]:0}var c=p.entity_data_1.toString().split("|");if(typeof c[6]!="undefined"){c=parseInt(c[6])-(i?n[h.chatId]:0);h.dateStart=new Date(c*1e3)}else{c=typeof c[5]!="undefined"?parseInt(c[5]):0;h.dateStart=new Date(c*1e3)}l.push(h)}l.sort(s.delegate(function(e,s){if(!this.BXIM.messenger.chat[e.chatId])return-1;if(!this.BXIM.messenger.chat[s.chatId])return 1;var t=e.dateStart.getTime();var r=s.dateStart.getTime();if(t<r){return-1}else if(t>r){return 1}else{return 0}},this));var M={};var u={};for(var f in this.BXIM.messenger.unreadMessage){if(m[f])continue;u[f]=true}for(var f in u){if(f.toString().substr(0,4)=="chat"){var B=this.BXIM.messenger.chat[f.toString().substr(4)];if(!B||B.entity_type!="LINES"){continue}}else{continue}if(!M["30days"]){M["30days"]=true;t.appendChild(s.create("div",{props:{className:"bx-messenger-recent-group"},children:[s.create("span",{props:{className:"bx-messenger-recent-group-title"},html:""})]}))}var h={text:"",textSenderId:0,textParams:{}};var X=Math.max.apply(Math,this.BXIM.messenger.unreadMessage[f]);if(this.BXIM.messenger.message[X]){h.text=this.BXIM.messenger.message[X].text;h.textSenderId=this.BXIM.messenger.message[X].senderId;h.textParams=this.BXIM.messenger.message[X].params}var b=this.drawContactListElement({id:f,data:B,text:h.text,textSenderId:h.senderId,textParams:h.params,showLastMessage:h.text!=""});if(b){t.appendChild(b);this.BXIM.messenger.recentListIndex.push(B.id)}}if(this.BXIM.settings.linesNewGroupEnable){for(var a=0;a<l.length;a++){if(a>o){if(!this.BXIM.messenger.unreadMessage[h.userId]||this.BXIM.messenger.unreadMessage[h.userId]&&this.BXIM.messenger.unreadMessage[h.userId].length==0){continue}}var h=s.clone(l[a]);var g="";if(h.userIsChat){var p=this.BXIM.messenger.chat[h.userId.toString().substr(4)];if(typeof p=="undefined"||typeof p.name=="undefined"||p.entity_type!="LINES"||parseInt(p.owner)!=0){continue}if(h.senderId!=0&&this.BXIM.messenger.users[h.senderId]&&!this.BXIM.messenger.users[h.senderId].connector&&!this.BXIM.messenger.users[h.senderId].bot&&!(h.params&&h.params.CLASS=="bx-messenger-content-item-system")){continue}var I="chat"+p.id}else{continue}if(!M["groupNew"]){t.appendChild(s.create("div",{props:{className:"bx-messenger-recent-group"},children:[s.create("span",{props:{className:"bx-messenger-recent-group-title bx-messenger-recent-category-title bx-messenger-recent-category-title-red-2"},html:s.message("IM_OL_LIST_NEW")})]}));M["groupNew"]=true}if(h.date){h.date=this.formatDate(h.dateStart,this.getDateFormatType("RECENT_OL_TITLE"));if(!M[h.date]){M[h.date]=true;t.appendChild(s.create("div",{props:{className:"bx-messenger-recent-group"},children:[s.create("span",{props:{className:"bx-messenger-recent-group-title"},html:h.date})]}))}}else{if(!M["never"]){M["never"]=true;t.appendChild(s.create("div",{props:{className:"bx-messenger-recent-group"},children:[s.create("span",{props:{className:"bx-messenger-recent-group-title"},html:s.message("IM_RESENT_NEVER")})]}))}}var b=this.drawContactListElement({id:I,data:p,text:h.text,textSenderId:h.senderId,textParams:h.params});if(b){t.appendChild(b)}}}var M={};for(var a=0;a<l.length;a++){if(a>o){if(!this.BXIM.messenger.unreadMessage[h.userId]||this.BXIM.messenger.unreadMessage[h.userId]&&this.BXIM.messenger.unreadMessage[h.userId].length==0){continue}}var h=s.clone(l[a]);var g="";if(h.userIsChat){var p=this.BXIM.messenger.chat[h.userId.toString().substr(4)];if(typeof p=="undefined"||typeof p.name=="undefined"||p.entity_type!="LINES"||parseInt(p.owner)==0&&this.BXIM.settings.linesNewGroupEnable){continue}if(h.senderId!=0&&this.BXIM.messenger.users[h.senderId]&&!this.BXIM.messenger.users[h.senderId].connector&&!this.BXIM.messenger.users[h.senderId].bot&&!(h.params&&h.params.CLASS=="bx-messenger-content-item-system")){continue}var I="chat"+p.id}else{continue}if(!M["groupUnanswered"]){t.appendChild(s.create("div",{props:{className:"bx-messenger-recent-group"},children:[s.create("span",{props:{className:"bx-messenger-recent-group-title bx-messenger-recent-category-title bx-messenger-recent-category-title-red"},html:s.message("IM_OL_LIST_UNANSWERED")})]}));M["groupUnanswered"]=true}if(h.date){h.date=this.formatDate(h.dateStart,this.getDateFormatType("RECENT_OL_TITLE"));if(!M[h.date]){M[h.date]=true;t.appendChild(s.create("div",{props:{className:"bx-messenger-recent-group"},children:[s.create("span",{props:{className:"bx-messenger-recent-group-title"},html:h.date})]}))}}else{if(!M["never"]){M["never"]=true;t.appendChild(s.create("div",{props:{className:"bx-messenger-recent-group"},children:[s.create("span",{props:{className:"bx-messenger-recent-group-title"},html:s.message("IM_RESENT_NEVER")})]}))}}var b=this.drawContactListElement({id:I,data:p,text:h.text,textSenderId:h.senderId,textParams:h.params});if(b){t.appendChild(b)}}l.sort(function(e,s){var t=e.date.getTime();var r=s.date.getTime();if(t>r){return-1}else if(t<r){return 1}else{if(e>s){return-1}else if(e<s){return 1}else{return 0}}});var M={};for(var a=0;a<l.length;a++){if(a>o){if(!this.BXIM.messenger.unreadMessage[h.userId]||this.BXIM.messenger.unreadMessage[h.userId]&&this.BXIM.messenger.unreadMessage[h.userId].length==0){continue}}var h=s.clone(l[a]);var g="";if(h.userIsChat){var p=this.BXIM.messenger.chat[h.userId.toString().substr(4)];if(typeof p=="undefined"||typeof p.name=="undefined"||p.entity_type!="LINES")continue;if(h.senderId==0||!this.BXIM.messenger.users[h.senderId]||this.BXIM.messenger.users[h.senderId]&&(this.BXIM.messenger.users[h.senderId].connector||this.BXIM.messenger.users[h.senderId].bot)||h.params&&h.params.CLASS=="bx-messenger-content-item-system"){continue}var I="chat"+p.id}else{continue}if(!M["groupAnswered"]){t.appendChild(s.create("div",{props:{className:"bx-messenger-recent-group"},children:[s.create("span",{props:{className:"bx-messenger-recent-group-title bx-messenger-recent-category-title bx-messenger-recent-category-title-green"},html:s.message("IM_OL_LIST_ANSWERED")})]}));M["groupAnswered"]=true}if(h.date){h.date=this.formatDate(h.date,this.getDateFormatType("RECENT_OL_TITLE"));if(!M[h.date]){M[h.date]=true;t.appendChild(s.create("div",{props:{className:"bx-messenger-recent-group"},children:[s.create("span",{props:{className:"bx-messenger-recent-group-title"},html:h.date})]}))}}else{if(!M["never"]){M["never"]=true;t.appendChild(s.create("div",{props:{className:"bx-messenger-recent-group"},children:[s.create("span",{props:{className:"bx-messenger-recent-group-title"},html:s.message("IM_RESENT_NEVER")})]}))}}var b=this.drawContactListElement({id:I,data:p,text:h.text,textSenderId:h.senderId,textParams:h.params});if(b){t.appendChild(b)}}if(t.childNodes.length<=0){t.appendChild(s.create("div",{props:{className:"bx-messenger-cl-item-empty"},html:s.message("IM_M_OL_EMPTY")}))}return t};t.prototype.recentListAdd=function(e){e.date=e.date?e.date:new Date;if(!e.skipDateCheck){for(var t=0;t<this.BXIM.messenger.recent.length;t++){if(this.BXIM.messenger.recent[t].userId==e.userId&&Math.floor(this.BXIM.messenger.recent[t].date.getTime()/1e3)>Math.floor(e.date.getTime()/1e3)){return false}}}var r=[];r.push(e);for(var t=0;t<this.BXIM.messenger.recent.length;t++){if(this.BXIM.messenger.recent[t].userId==e.userId)e.pinned=this.BXIM.messenger.recent[t].pinned===true;else r.push(this.BXIM.messenger.recent[t])}this.BXIM.messenger.recent=r;if(!e.skipRedraw&&this.BXIM.messenger.recentList){if(this.isMobile()){clearTimeout(this.BXIM.messenger.redrawRecentListTimeout);this.BXIM.messenger.redrawRecentListTimeout=setTimeout(s.delegate(function(){this.recentListRedraw()},this),300)}else{this.recentListRedraw()}}};t.prototype.inRecentList=function(e){if(!e)return false;var s=false;for(var t=0;t<this.BXIM.messenger.recent.length;t++){if(this.BXIM.messenger.recent[t].userId==e){s=true;break}}return s};t.prototype.recentListHide=function(e,t){if(!e)return false;var r=[];var i=false;for(var a=0;a<this.BXIM.messenger.recent.length;a++){if(!i&&this.BXIM.messenger.recent[a].userId==e){i=true;continue}r.push(this.BXIM.messenger.recent[a])}this.BXIM.messenger.recent=r;if(this.BXIM.messenger.recentList)this.recentListRedraw();if(!this.isMobile())s.localStorage.set("mrlr",e,5);t=t!=false;if(t){s.ajax({url:this.BXIM.pathToAjax+"?RECENT_HIDE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{IM_RECENT_HIDE:"Y",DIALOG_ID:e,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()}})}this.readMessage(e,t,false);if(e.toString().substr(0,4)=="chat"){if(this.isMobile()){app.onCustomEvent("onPullClearWatch",{id:"IM_PUBLIC_"+e.substr(4)})}else{s.PULL.clearWatch("IM_PUBLIC_"+e.substr(4))}}delete this.BXIM.messenger.showMessage[e];delete this.BXIM.messenger.history[e];if(this.BXIM.messenger.currentTab==e){this.BXIM.messenger.currentTab=0;this.BXIM.messenger.extraOpen(s.create("div",{attrs:{style:"padding-top: 300px"},props:{className:"bx-messenger-box-empty"},html:s.message("IM_M_EMPTY")}))}};t.prototype.recentListElementUpdate=function(e,s,t){if(e.toString().substr(0,4)=="chat"){for(var r=0;r<this.BXIM.messenger.recent.length;r++){if(this.BXIM.messenger.recent[r].userIsChat&&this.BXIM.messenger.recent[r].recipientId==e){if(this.BXIM.messenger.recent[r].id==s){this.BXIM.messenger.recent[r].text=t}break}}}else{for(var r=0;r<this.BXIM.messenger.recent.length;r++){if(!this.BXIM.messenger.recent[r].userIsChat&&this.BXIM.messenger.recent[r].userId==e){if(this.BXIM.messenger.recent[r].id==s){this.BXIM.messenger.recent[r].text=t}break}}}};t.prototype.recentListElementToTop=function(e){var t=false;for(var r=0;r<this.BXIM.messenger.recent.length;r++){if(this.BXIM.messenger.recent[r].userId==e){t=true;this.BXIM.messenger.recent[r].date=new Date;break}}if(!t){var i="";var a=this.getLastMessageInDialog(e);if(a){if(a.text){i=a.text}else if(a.params&&a.params.FILE_ID&&a.params.FILE_ID.length>1){i="["+s.message("IM_F_FILE")+"]"}else if(a.params&&a.params.ATTACH&&a.params.ATTACH.length>1){item.text="["+s.message("IM_F_ATTACH")+"]"}}if(!i){var n=this.getUserParam(e);if(n.type=="chat"){i=s.message("IM_CL_CHAT_NEW")}else if(n.type=="open"){i=s.message("IM_CL_OPEN_CHAT_NEW")}else if(n.type=="call"){i=s.message("IM_CL_PHONE")}else if(n.type=="lines"){i=s.message("IM_CL_LINES")}else{i=s.util.htmlspecialcharsback(this.getUserPosition(this.BXIM.messenger.users[e],true))}}this.BXIM.messenger.recent.push({id:"tempSort"+ +new Date,date:new Date,skipDateCheck:true,recipientId:e,senderId:e,text:s.MessengerCommon.prepareText(i,true),userId:e,params:{}})}if(this.BXIM.messenger.recentList||this.BXIM.messenger.recentListExternal)this.recentListRedraw();if(!this.isMobile())s.localStorage.set("mrlr",e,5)};t.prototype.recentListElementPin=function(e,s){var t=false;for(var r=0;r<this.BXIM.messenger.recent.length;r++){if(this.BXIM.messenger.recent[r].userId==e){t=true;if(this.BXIM.messenger.recent[r].pinned==s){return true}this.BXIM.messenger.recent[r].pinned=s;break}}if(t&&(this.BXIM.messenger.recentList||this.BXIM.messenger.recentListExternal))this.recentListRedraw();return true};t.prototype.recentListGetSortIndex=function(){var e={};var s=0;if(this.BXIM.messenger.recent.length<=0){this.recentListGetFromServer()}for(var t=0;t<this.BXIM.messenger.recent.length;t++){s=this.BXIM.messenger.recent.length-t;e[this.BXIM.messenger.recent[t].userId]=s}return e};t.prototype.recentListGetFromServer=function(){if(this.BXIM.messenger.recentListLoad)return false;this.BXIM.messenger.recentListLoad=true;s.ajax({url:this.BXIM.pathToAjax+"?RECENT_LIST&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_RECENT_LIST:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(t){if(t&&t.BITRIX_SESSID){s.message({bitrix_sessid:t.BITRIX_SESSID})}if(t.ERROR==""){this.BXIM.messenger.recent=[];for(var r in t.RECENT){t.RECENT[r].date=new Date(t.RECENT[r].date);this.BXIM.messenger.recent.push(t.RECENT[r])}var i=false;for(var r in this.BXIM.messenger.unreadMessage){for(var a=0;a<this.BXIM.messenger.unreadMessage[r].length;a++){if(!i||this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[r][a]]&&i.SEND_DATE.getTime()<=this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[r][a]].date.getTime()){i={ID:this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[r][a]].id,SEND_DATE:this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[r][a]].date,RECIPIENT_ID:this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[r][a]].recipientId,SENDER_ID:this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[r][a]].senderId,USER_ID:this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[r][a]].senderId,SEND_MESSAGE:this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[r][a]].text,PARAMS:this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[r][a]].params}}}}if(i){this.recentListAdd({userId:i.RECIPIENT_ID.toString().substr(0,4)=="chat"?i.RECIPIENT_ID:i.USER_ID,id:i.ID,date:i.SEND_DATE,recipientId:i.RECIPIENT_ID,senderId:i.SENDER_ID,text:i.SEND_MESSAGE,userIsChat:i.RECIPIENT_ID.toString().substr(0,4)=="chat",params:i.PARAMS},true)}for(var r in t.CHAT){if(this.BXIM.messenger.chat[r]&&this.BXIM.messenger.chat[r].fake)t.CHAT[r].fake=true;else if(!this.BXIM.messenger.chat[r])t.CHAT[r].fake=true;t.CHAT[r].date_create=new Date(t.CHAT[r].date_create);this.BXIM.messenger.chat[r]=t.CHAT[r]}for(var r in t.USERS){t.USERS[r].last_activity_date=new Date(t.USERS[r].last_activity_date);t.USERS[r].mobile_last_date=new Date(t.USERS[r].mobile_last_date);t.USERS[r].idle=t.USERS[r].idle?new Date(t.USERS[r].idle):false;t.USERS[r].absent=t.USERS[r].absent?new Date(t.USERS[r].absent):false;this.BXIM.messenger.users[r]=t.USERS[r]}if(this.BXIM.messenger.recentList||this.BXIM.messenger.recentListExternal)this.recentListRedraw();this.BXIM.messenger.smile=t.SMILE;this.BXIM.messenger.smileSet=t.SMILE_SET;this.BXIM.settingsNotifyBlocked=t.NOTIFY_BLOCKED;if(!this.isMobile())this.BXIM.messenger.dialogStatusRedraw();if(this.BXIM.messenger.recent.length==0){this.BXIM.messenger.popupContactListElementsWrap.innerHTML="";this.BXIM.messenger.popupContactListElementsWrap.appendChild(this.chatListPrepare())}}else{this.BXIM.messenger.recentListLoad=false;if(t.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;setTimeout(s.delegate(this.recentListGetFromServer,this),2e3);s.onCustomEvent(e,"onImError",[t.ERROR,t.BITRIX_SESSID])}else if(t.ERROR=="AUTHORIZE_ERROR"){this.BXIM.messenger.sendAjaxTry++;if(this.isDesktop()||this.isMobile()){setTimeout(s.delegate(this.recentListGetFromServer,this),1e4)}s.onCustomEvent(e,"onImError",[t.ERROR])}}},this),onfailure:s.delegate(function(){this.BXIM.messenger.sendAjaxTry=0;this.BXIM.messenger.recentListLoad=false},this)})};t.prototype.getDialogCounter=function(e){if(!this.BXIM.messenger.unreadMessage[e]){return 0}if(this.BXIM.messenger.unreadMessage[e].length>=100){return"99+"}return this.BXIM.messenger.unreadMessage[e].length};t.prototype.getVideoconfLink=function(e){if(!e||!this.BXIM.messenger.chat[e.substr(4)]||!this.BXIM.messenger.chat[e.substr(4)].public){return null}return this.BXIM.messenger.chat[e.substr(4)].public.link};t.prototype.getVideoconfLinkByCode=function(e){if(!e){return null}return location.origin.replace("http://","https://")+"/video/"+e};t.prototype.drawContactListElement=function(e){if(!e||!e.id)return null;e.userIsChat=e.id.toString().substr(0,4)=="chat";e.userIsQueue=e.id.toString().substr(0,5)=="queue";e.userIsStructure=e.id.toString().substr(0,9)=="structure";e.extraClass=e.extraClass||"";e.showLastMessage=e.showLastMessage===false?false:true;e.showCounter=e.showCounter===false?false:true;e.data=e.data?e.data:{};if(this.BXIM.userId==e.data.id&&e.data.extranet){return null}var t="";var r="";var i="";var a="";if(e.showCounter){if(this.BXIM.messenger.unreadMessage[e.id]&&this.BXIM.messenger.unreadMessage[e.id].length>0){r="bx-messenger-cl-status-new-message";i='<span class="bx-messenger-cl-count-digit">'+(this.BXIM.messenger.unreadMessage[e.id].length<100?this.BXIM.messenger.unreadMessage[e.id].length:"99+")+"</span>"}if(this.countWriting(e.id))a="bx-messenger-cl-status-writing"}if(e.userIsQueue){e.data.avatar="";e.data.color=this.BXIM.messenger.users[this.BXIM.userId].color}else if(e.userIsStructure){e.data.avatar="";e.data.color=this.BXIM.messenger.users[this.BXIM.userId].color}if(!e.data.avatar)e.data.avatar=this.BXIM.pathToBlankImage;var n="";var o=e.data.avatar;var l="";if(this.isMobile()){if(this.BXIM.messenger.currentTab==e.id){l="bx-messenger-cl-item-active "}var m="mobile-rc-avatar-id-"+e.data.id;n='id="'+m+'" data-src="'+e.data.avatar+'"';o=this.BXIM.pathToBlankImage;BitrixMobile.LazyLoad.registerImage(m,function(e){return!e.node.parentNode.parentNode.classList.contains("bx-messenger-hide")||e.node.parentNode.parentNode.parentNode.classList.contains("bx-messenger-chatlist-show-all")})}var h="";var g=false;if(this.BXIM.settings.viewLastMessage&&e.showLastMessage&&e.id){var p="";if(e.textSenderId==this.BXIM.userId)p='<span class="bx-messenger-cl-user-reply"></span>';if(e.text){e.text=this.purifyText(e.text,e.textParams)}h=p+e.text}if(!h){if(e.userIsChat){if(e.data.type=="call"){h=s.message("IM_CL_PHONE")}else if(e.data.type=="lines"){h=s.message("IM_CL_LINES")}else if(e.data.type=="open"){h=s.message("IM_CL_OPEN_CHAT_NEW")}else{h=s.message("IM_CL_CHAT_NEW")}}else if(e.userIsQueue){if(e.data.type=="olQueue"){h=s.message("IM_CL_OL_QUEUE")}else if(e.data.type=="viQueue"){h=s.message("IM_CL_VI_QUEUE")}}else if(e.userIsStructure){h=s.message("IM_CL_STRUCTURE")}else{h=this.getUserPosition(this.BXIM.messenger.users[e.id],true)}}if(e.userIsChat){if(e.data.type=="lines"){var I=this.linesGetSession(this.BXIM.messenger.chat[e.id.substr(4)]);g=I.crm=="Y";t+=" bx-messenger-cl-avatar-"+this.linesGetSource(this.BXIM.messenger.chat[e.id.substr(4)])}else if(e.data.entity_type=="CRM"){g=true;t+=" bx-messenger-cl-avatar-type-crm"}else{t="bx-messenger-cl-item-chat-"+e.data.type}}else if(e.userIsQueue){if(e.data.type=="olQueue"){t=" bx-messenger-cl-avatar-lines"}else if(e.data.type=="viQueue"){t=" bx-messenger-cl-avatar-call"}}else if(e.userIsStructure){t=" bx-messenger-cl-avatar-structure"}var d=this.isBlankAvatar(e.data.avatar)?'style="background-color: '+e.data.color+'"':"";var c=e.userIsChat&&d?"bx-messenger-cl-avatar-status-hide":"";var M=e.data.name;if(!e.userIsChat&&!e.userIsQueue&&!e.userIsStructure&&this.BXIM.userId==e.data.id){M=M+" (<b><i>"+s.message("IM_YOU")+"</i></b>)"}var u="";var f="bx-messenger-cl-item  bx-messenger-cl-id-"+(e.userIsChat?"chat":"")+(e.userIsQueue?"queue":"")+e.data.id+" "+l;if(e.userIsChat){u="bx-messenger-cl-avatar-"+e.data.type+" "+(this.BXIM.messenger.generalChatId==e.data.id?" bx-messenger-cl-item-chat-general":"");f+="bx-messenger-cl-item-chat "+r+" "+a+" "+t+" "+(this.BXIM.messenger.generalChatId==e.data.id?"bx-messenger-cl-item-chat-general":"")}else if(e.userIsQueue){f+=t}else if(e.userIsStructure){f+=t}else{f+="bx-messenger-cl-status-"+this.getUserStatus(this.BXIM.messenger.users[e.data.id])+" "+r+" "+a}f+=" "+e.extraClass;if(e.pinned){f+=" bx-messenger-cl-item-pinned"}return s.create("span",{props:{className:f},attrs:{"data-userId":e.id,"data-name":s.util.htmlspecialcharsback(e.data.name),"data-status":this.getUserStatus(this.BXIM.messenger.users[e.data.id]),"data-avatar":e.data.avatar,"data-userIsChat":e.userIsChat,"data-isPinned":e.pinned,"data-userIsQueue":e.userIsQueue},html:'<span class="bx-messenger-cl-count">'+i+"</span>"+'<span title="'+e.data.name+'" class="bx-messenger-cl-avatar '+u+" "+c+'">'+'<img class="bx-messenger-cl-avatar-img'+(this.isBlankAvatar(e.data.avatar)?" bx-messenger-cl-avatar-img-default":"")+'" src="'+o+'" '+n+" "+d+">"+(g?'<span class="bx-messenger-cl-crm"></span>':"")+(!e.userIsQueue&&!e.userIsStructure?'<span class="bx-messenger-cl-status"></span>':"")+"</span>"+'<span class="bx-messenger-cl-user">'+'<div class="bx-messenger-cl-user-title'+(e.data.extranet&&e.data.type!="lines"?" bx-messenger-user-extranet":"")+'" title="'+e.data.name+'">'+M+"</div>"+'<div class="bx-messenger-cl-user-desc">'+h+"</div>"+"</span>"})};t.prototype.chatListRedraw=function(e){if(this.MobileActionNotEqual("RECENT")||this.BXIM.messenger.popupMessenger==null)return false;s.addClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-active");s.removeClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-hover bx-messenger-box-contact-normal");this.BXIM.messenger.popupContactListActive=true;this.BXIM.messenger.popupContactListHovered=true;clearTimeout(this.BXIM.messenger.popupContactListWrapAnimation);if(!this.isMobile()){if(this.BXIM.messenger.popupMessenger==null)return false}this.BXIM.messenger.chatList=true;this.BXIM.messenger.recentList=false;this.BXIM.messenger.contactList=false;clearTimeout(this.BXIM.messenger.redrawChatListTimeout);clearTimeout(this.BXIM.messenger.redrawRecentListTimeout);if(this.BXIM.messenger.redrawContactListTimeout["contactList"])clearTimeout(this.BXIM.messenger.redrawContactListTimeout["contactList"]);if(!this.isMobile()&&this.BXIM.messenger.popupPopupMenu!=null&&this.BXIM.messenger.popupPopupMenu.uniquePopupId.replace("bx-messenger-popup-","")=="contactList"){this.BXIM.messenger.popupPopupMenu.close()}if(this.BXIM.messenger.popupContactListElementsWrap){s.removeClass(this.BXIM.messenger.popupContactListElementsWrap,"bx-messenger-recent-lines-wrap");this.BXIM.messenger.popupContactListElementsWrap.innerHTML="";this.BXIM.messenger.popupContactListElementsWrap.appendChild(this.chatListPrepare(e))}if(this.isMobile()){BitrixMobile.LazyLoad.showImages()}};t.prototype.chatListPrepare=function(e){var t=document.createDocumentFragment();var r={};e=typeof e=="object"?e:{};var i=typeof e.listName!="undefined"?e.listName:"contactList";var a=typeof e.searchText!="undefined"?e.searchText:this.BXIM.messenger.contactListSearchText;var n=!(a!=null&&a.length==0);var o=n&&a.substr(0,9)=="structure"?a.substr(9):0;var l=this.BXIM.messenger.realSearch&&!this.BXIM.messenger.realSearchFound;var m=typeof e.viewOnlyIntranet!="undefined"?e.viewOnlyIntranet:false;var h=typeof e.viewOnlyBusiness!="undefined"?e.viewOnlyBusiness:false;var g=typeof e.extra!="undefined"?e.extra:true;var p=typeof e.viewOffline!="undefined"?e.viewOffline:n||!this.BXIM.settings?true:this.BXIM.settings.viewOffline;var I=typeof e.viewOfflineWithPhones!="undefined"?e.viewOfflineWithPhones:false;var d=typeof e.viewChat!="undefined"?e.viewChat:true;var c=typeof e.viewOpenChat!="undefined"?e.viewOpenChat:true;var M=typeof e.viewSelf!="undefined"?e.viewSelf:true;var u=typeof e.viewTransferViQueue!="undefined"?e.viewTransferViQueue:false;var f=typeof e.viewTransferOlQueue!="undefined"?e.viewTransferOlQueue:false;var B=typeof e.viewBot!="undefined"?e.viewBot:true;var X=typeof e.callback!="undefined"?e.callback:{};var b=n&&a.length>=3&&this.BXIM.messenger.realSearchAvailable&&!this.BXIM.messenger.realSearch&&!m;var E=i=="contactList"||i=="popupChatDialogContactListElements"&&(this.BXIM.messenger.popupChatDialogContactListElementsType=="CHAT_ADD"||this.BXIM.messenger.popupChatDialogContactListElementsType=="CHAT_EXTEND"||this.BXIM.messenger.popupChatDialogContactListElementsType=="CHAT_CREATE"&&this.BXIM.messenger.chatCreateType!="private");var C=i=="contactList";if(typeof X.empty!="function"){X.empty=function(){}}if(!this.BXIM.messenger.contactListLoad){t.appendChild(s.create("div",{props:{className:"bx-messenger-cl-item-load"},html:s.message("IM_CL_LOAD")}));this.contactListGetFromServer();return t}if(this.isMobile()){BitrixMobile.LazyLoad.clearImages()}var _=this.BXIM.messenger.popupContactListElementsSize;var S=46;var T=29;var v=26;var y=0;var A=n?5:3;var L=[];if(f){L.push({id:"olQueue",name:s.message("IM_CTL_CHAT_OL_QUEUE"),title:"",more:s.message("IM_CL_MORE_QUEUE")})}else if(u){L.push({id:"viQueue",name:s.message("IM_CTL_CHAT_VI_QUEUE"),title:"",more:s.message("IM_CL_MORE_QUEUE")})}var N=this.BXIM.messenger.users;if(n&&o){L.push({id:"private",name:s.message("IM_CTL_CHAT_PRIVATE_NEW"),title:s.message("IM_CL_CREATE_PRIVATE_NEW"),more:s.message("IM_CL_MORE_PRIVATE_NEW")});N={};if(this.BXIM.messenger.userInGroup[o]){for(var x=0;x<this.BXIM.messenger.userInGroup[o].users.length;x++){N[this.BXIM.messenger.userInGroup[o].users[x]]=this.BXIM.messenger.users[this.BXIM.messenger.userInGroup[o].users[x]]}}}else if(n){L.push({id:"private",name:s.message("IM_CTL_CHAT_PRIVATE_NEW"),title:s.message("IM_CL_CREATE_PRIVATE_NEW"),more:s.message("IM_CL_MORE_PRIVATE_NEW")});L.push({id:"bot",name:s.message("IM_CTL_CHAT_BOT"),title:"",more:s.message("IM_CL_MORE_BOT")});L.push({id:"open",name:s.message("IM_CTL_CHAT_OPEN_NEW"),title:s.message("IM_CL_CREATE_OPEN_NEW"),more:s.message("IM_CL_MORE_OPEN_NEW"),skip:!this.BXIM.messenger.openChatEnable||this.BXIM.userExtranet});L.push({id:"chat",name:s.message("IM_CTL_CHAT_CHAT_NEW"),title:s.message("IM_CL_CREATE_CHAT_NEW"),more:s.message("IM_CL_MORE_CHAT_NEW")});L.push({id:"lines",name:s.message("IM_CTL_CHAT_LINES"),title:"",more:s.message("IM_CL_MORE_LINES")});L.push({id:"call",name:s.message("IM_CTL_CHAT_CALL"),title:"",more:s.message("IM_CL_MORE_CALL"),skip:!this.BXIM.webrtc.phoneEnabled});L.push({id:"ol",name:s.message("IM_CTL_CHAT_OL"),title:"",more:s.message("IM_CTL_CHAT_OL"),skip:this.BXIM.userExtranet});L.push({id:"extranet",name:s.message("IM_CTL_CHAT_EXTRANET"),title:s.message("IM_CL_CREATE_PRIVATE_NEW"),more:s.message("IM_CL_MORE_EXTRANET_NEW")});L.push({id:"structure",name:this.BXIM.bitrixIntranet?s.message("IM_CTL_CHAT_STRUCTURE"):s.message("IM_CL_GROUP"),title:"",more:this.BXIM.bitrixIntranet?s.message("IM_CL_MORE_STRUCTURE"):s.message("IM_CL_MORE_GROUP"),skip:!E});L.push({id:"blocked",name:s.message("IM_CTL_CHAT_BLOCKED"),title:"",more:s.message("IM_CL_MORE_EXTRANET_NEW")})}else{L.push({id:"open",name:s.message("IM_CTL_CHAT_OPEN_NEW"),title:s.message("IM_CL_CREATE_OPEN_NEW"),more:s.message("IM_CL_MORE_OPEN_NEW"),skip:!this.BXIM.messenger.openChatEnable||this.BXIM.userExtranet});L.push({id:"chat",name:s.message("IM_CTL_CHAT_CHAT_NEW"),title:s.message("IM_CL_CREATE_CHAT_NEW"),more:s.message("IM_CL_MORE_CHAT_NEW")});L.push({id:"lines",name:s.message("IM_CTL_CHAT_LINES"),title:"",more:s.message("IM_CL_MORE_LINES")});L.push({id:"call",name:s.message("IM_CTL_CHAT_CALL"),title:"",more:s.message("IM_CL_MORE_CALL"),skip:!this.BXIM.webrtc.phoneEnabled});L.push({id:"private",name:s.message("IM_CTL_CHAT_PRIVATE_NEW"),title:s.message("IM_CL_CREATE_PRIVATE_NEW"),more:s.message("IM_CL_MORE_PRIVATE_NEW")});L.push({id:"bot",name:s.message("IM_CTL_CHAT_BOT"),title:"",more:s.message("IM_CL_MORE_BOT")});L.push({id:"ol",name:s.message("IM_CTL_CHAT_OL"),title:"",more:s.message("IM_CTL_CHAT_OL"),skip:this.BXIM.userExtranet});L.push({id:"extranet",name:s.message("IM_CTL_CHAT_EXTRANET"),title:s.message("IM_CL_CREATE_PRIVATE_NEW"),more:s.message("IM_CL_MORE_EXTRANET_NEW")});L.push({id:"structure",name:this.BXIM.bitrixIntranet?s.message("IM_CTL_CHAT_STRUCTURE"):s.message("IM_CTL_CHAT_GROUP"),title:"",more:this.BXIM.bitrixIntranet?s.message("IM_CL_MORE_STRUCTURE"):s.message("IM_CL_MORE_GROUP"),skip:!E});L.push({id:"blocked",name:s.message("IM_CTL_CHAT_BLOCKED"),title:"",more:s.message("IM_CL_MORE_EXTRANET_NEW")})}for(var x=0;x<L.length;x++){if(L[x].skip)continue;y++}var R=_-T*y;var D=parseInt(R/S);var w=Math.max(parseInt(R/y/S),A);var O=0;var k=0;for(var x=0;x<L.length;x++){L[x].countElement=0;if(L[x].skip)continue;L[x].countElement=w}var P=[];if(n){a=a+"";if(!this.isMobile()&&this.BXIM.language=="ru"&&s.correctText){var U=s.correctText(a);if(U!=a){a=a+" "+U}}P=a.split(" ")}var H=this.recentListGetSortIndex();var G={};var F=[];for(var x=0;x<L.length;x++){G[x]=[];if(L[x].id=="private"||L[x].id=="extranet"||L[x].id=="blocked"||L[x].id=="bot"||L[x].id=="ol"){if(!B&&L[x].id=="bot")L[x].skip=true;if(m&&L[x].id=="extranet")L[x].skip=true;if(!d&&L[x].id=="ol")L[x].skip=true;if(L[x].skip)continue;for(var j in N){if(!N.hasOwnProperty(j))continue;if(!M&&j==this.BXIM.userId)continue;if(this.BXIM.messenger.users[j].external_auth_id==="imconnector"||this.BXIM.messenger.users[j].external_auth_id==="call"){continue}if(typeof this.BXIM.messenger.users[j].active!="undefined"&&!this.BXIM.messenger.users[j].active)continue;if(h&&this.BXIM.messenger.businessUsers&&!this.BXIM.messenger.users[j].bot&&this.BXIM.messenger.businessUsers.indexOf(j.toString())==-1)continue;if(!p){var W=this.getUserStatus(this.BXIM.messenger.users[j]);if(I&&this.userHasPhone(j)){}else if(W=="offline"){continue}}var V=this.BXIM.messenger.userChat[j];if(L[x].id=="blocked"){if(!this.BXIM.messenger.userChatBlockStatus[V]||!this.BXIM.messenger.userChatBlockStatus[V][this.BXIM.userId]){continue}}else{if(this.BXIM.messenger.userChatBlockStatus[V]&&this.BXIM.messenger.userChatBlockStatus[V][this.BXIM.userId]){continue}}if(L[x].id=="extranet"){if(!this.BXIM.messenger.users[j].extranet)continue}else{if(this.BXIM.messenger.users[j].extranet)continue}if(L[x].id=="ol"){if(!this.BXIM.messenger.users[j].bot)continue;if(!this.BXIM.messenger.bot[j]||this.BXIM.messenger.bot[j].type!="network"&&this.BXIM.messenger.bot[j].type!="support24")continue}else if(L[x].id=="bot"){if(!this.BXIM.messenger.users[j].bot||!this.BXIM.messenger.bot[j])continue;if(this.BXIM.messenger.bot[j]&&this.BXIM.messenger.bot[j].type=="network")continue;if(this.BXIM.messenger.popupChatDialogDestType=="CALL_INVITE_USER"){continue}if(this.BXIM.messenger.openChatFlag){var Y=this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)];if(Y&&Y.entity_type!="LINES"&&this.BXIM.messenger.bot[j].type=="openline"){continue}else if(Y&&Y.entity_type=="LINES"&&!this.BXIM.messenger.bot[j].openline){continue}else if(this.BXIM.messenger.bot[j].type=="network"||this.BXIM.messenger.bot[j].type=="support24"){continue}}else{if(this.BXIM.messenger.bot[j].type=="network"||this.BXIM.messenger.bot[j].type=="support24"||this.BXIM.messenger.bot[j].type=="openline"){continue}}}else{if(this.BXIM.messenger.users[j].bot)continue}if(n&&o){}else if(n){var K=this.BXIM.messenger.users[j];if(!K){continue}var q=K.name.toLowerCase()+(K.search_mark?" "+K.search_mark:"");var J=K.work_position?(" "+K.work_position).toLowerCase():"";var Q=true;if(!H[j]){H[j]=0}for(var $=0;$<P.length;$++){if(q.indexOf(P[$].toLowerCase())>=0){H[j]+=100+P[$].length;Q=false}if(J.indexOf(P[$].toLowerCase())>=0){H[j]+=50+P[$].length;Q=false}}if(Q){continue}}if(L[x].id=="bot"){G[x].push(this.BXIM.messenger.users[j])}else if(L[x].id=="ol"){G[x].push(this.BXIM.messenger.users[j])}else{G[x].push(this.BXIM.messenger.users[j])}}if(L[x].id=="bot"){G[x].sort(s.delegate(function(e,s){var t=H[e.id]?H[e.id]:0;var r=H[s.id]?H[s.id]:0;if(this.BXIM.messenger.bot[e.id]&&this.BXIM.messenger.bot[e.id]["code"]=="marta"){t=1e7}if(this.BXIM.messenger.bot[s.id]&&this.BXIM.messenger.bot[s.id]["code"]=="marta"){r=1e7}if(t>r){return-1}else if(t<r){return 1}else{return 0}},this))}else if(n){G[x].sort(function(e,s){var t=H[e.id]?H[e.id]:0;var r=H[s.id]?H[s.id]:0;if(t>r){return-1}else if(t<r){return 1}else{return 0}})}else{G[x].sort(function(e,s){var t=H[e.id]?H[e.id]:0;var r=H[s.id]?H[s.id]:0;if(BXIM&&e.id==BXIM.userId){t=1e7}if(BXIM&&s.id==BXIM.userId){r=1e7}if(t>r){return-1}else if(t<r){return 1}else{return 0}})}}else if(L[x].id=="chat"||L[x].id=="open"||L[x].id=="call"||L[x].id=="lines"){if(!d&&L[x].id!="open")L[x].skip=true;if(!c&&L[x].id=="open")L[x].skip=true;if(L[x].skip)continue;for(var V in this.BXIM.messenger.chat){if(!this.BXIM.messenger.chat.hasOwnProperty(V)){continue}if(this.BXIM.messenger.chat[V].type=="chat"||this.BXIM.messenger.chat[V].type=="open"||this.BXIM.messenger.chat[V].type=="call"||this.BXIM.messenger.chat[V].type=="lines"){if(this.BXIM.messenger.chat[V].type!=L[x].id){continue}}else if(L[x].id!="chat"){continue}if(this.BXIM.messenger.generalChatId==V&&(!this.BXIM.messenger.openChatEnable||this.BXIM.userExtranet)){continue}if(n){var z=true;for(var $=0;$<P.length;$++){if(this.BXIM.messenger.chat[V].name.toLowerCase().indexOf(P[$].toLowerCase())>=0){z=false;break}}if(z){continue}}G[x].push(this.BXIM.messenger.chat[V])}G[x].sort(s.delegate(function(e,s){var t=H["chat"+e.id]?H["chat"+e.id]:0;var r=H["chat"+s.id]?H["chat"+s.id]:0;if(this.BXIM.messenger.generalChatId==e.id){t=1e7}else if(this.BXIM.messenger.userChatBlockStatus[e.id]&&this.BXIM.messenger.userChatBlockStatus[e.id][this.BXIM.userId]){t=-1}if(this.BXIM.messenger.generalChatId==s.id){r=1e7}else if(this.BXIM.messenger.userChatBlockStatus[r.id]&&this.BXIM.messenger.userChatBlockStatus[r.id][this.BXIM.userId]){r=-1}if(t>r){return-1}else if(t>r){return-1}else if(t<r){return 1}else{return 0}},this))}else if(L[x].id=="olQueue"){if(!this.BXIM.messenger.openlines)continue;if(!this.BXIM.messenger.openlines.queue)continue;this.BXIM.messenger.openlines.queue.sort(function(e,s){if(e.transfer_count>s.transfer_count){return-1}else if(e.transfer_count<s.transfer_count){return 1}else{if(e.id>s.id){return 1}else if(e.id<s.id){return-1}else{return 0}}});for(var Z=0;Z<this.BXIM.messenger.openlines.queue.length;Z++){if(n){var ee=true;for(var $=0;$<P.length;$++){if(this.BXIM.messenger.openlines.queue[Z].name.toLowerCase().indexOf(P[$].toLowerCase())>=0){ee=false;break}}if(ee){continue}}G[x].push(s.clone(this.BXIM.messenger.openlines.queue[Z]))}}else if(L[x].id=="structure"){if(L[x].skip){continue}for(var se in this.BXIM.messenger.groups){if(!this.BXIM.messenger.userInGroup[se]||this.BXIM.messenger.userInGroup[se].length<=0)continue;if(i=="popupChatDialogContactListElements"&&this.BXIM.messenger.userInGroup[se].length>200)continue;if(!C&&se.toString().substr(0,2)=="SG")continue;if(n){var ee=true;for(var $=0;$<P.length;$++){if(this.BXIM.messenger.groups[se].name.toLowerCase().indexOf(P[$].toLowerCase())>=0){ee=false;break}}if(ee){continue}}G[x].push(this.BXIM.messenger.groups[se])}G[x].sort(s.delegate(function(e,s){var t=e.id;var r=s.id;if(this.BXIM.messenger.userInGroup[t]&&this.BXIM.messenger.userInGroup[t].users.indexOf(this.BXIM.userId.toString())>-1){t=-1}if(this.BXIM.messenger.userInGroup[r]&&this.BXIM.messenger.userInGroup[r].users.indexOf(this.BXIM.userId.toString())>-1){r=-1}if(t>r){return 1}else if(t<r){return-1}else{return 0}},this))}if(L[x].countElement>G[x].length){O+=G[x].length;k+=L[x].countElement-G[x].length}else{F.push(x);O+=L[x].countElement}}if(O<D){var te=0;var re=F.length;for(var x=0;x<k;x++){if(F[te]&&L[F[te]]){L[F[te]].countElement=L[F[te]].countElement+1}te=te==re-1?0:te+1}}for(var x=0;x<L.length;x++){if(L[x].skip)continue;if(n&&G[x].length<=0){if(!b||L[x].id!="extranet"){continue}}if(G[x].length<=0&&!(L[x].id=="private"||L[x].id=="open"||L[x].id=="chat"||b&&L[x].id=="extranet"))continue;t.appendChild(s.create("div",{props:{className:"bx-messenger-chatlist-group"},children:[!g||L[x].id=="lines"||L[x].id=="call"||L[x].id=="blocked"||L[x].id=="bot"||L[x].id=="ol"?null:s.create("span",{attrs:{"data-type":L[x].id},props:{title:L[x].title,className:"bx-messenger-chatlist-group-add"}}),s.create("span",{props:{className:"bx-messenger-chatlist-group-title"},html:L[x].name})]}));if(G[x].length<=0){if(b&&L[x].id=="extranet"){t.appendChild(s.create("div",{props:{className:"bx-messenger-chatlist-search-button-wrap"},children:[s.create("span",{props:{className:"bx-messenger-chatlist-search-button"},html:this.BXIM.bitrixIntranet?s.message("IM_SEARCH_B24"):s.message("IM_SEARCH_SITE")})]}))}continue}var ie=[];var ae=1;for(var ne=0;ne<G[x].length;ne++){var oe=ae<=L[x].countElement;ae++;if(L[x].id=="private"||L[x].id=="extranet"||L[x].id=="bot"||L[x].id=="ol"){var K=G[x][ne];var le=this.drawContactListElement({id:K.id,data:K,showLastMessage:false,showCounter:g,extraClass:oe?"":"bx-messenger-hide"});if(le){ie.push(le)}}else if(L[x].id=="chat"||L[x].id=="open"||L[x].id=="call"||L[x].id=="lines"){var me=G[x][ne];var le=this.drawContactListElement({id:"chat"+me.id,data:me,showLastMessage:false,showCounter:g,extraClass:oe?"bx-messenger-chatlist-chat":"bx-messenger-chatlist-chat bx-messenger-hide"});if(le){ie.push(le)}}else if(L[x].id=="olQueue"||L[x].id=="viQueue"){var he=G[x][ne];he.type=L[x].id;var le=this.drawContactListElement({id:"queue"+he.id,data:he,showLastMessage:false,showCounter:false,extraClass:oe?"bx-messenger-chatlist-chat":"bx-messenger-chatlist-chat bx-messenger-hide"});if(le){ie.push(le)}}else if(L[x].id=="structure"){var ge=G[x][ne];var le=this.drawContactListElement({id:"structure"+ge.id,data:ge,showLastMessage:false,showCounter:false,extraClass:oe?"bx-messenger-chatlist-chat":"bx-messenger-chatlist-chat bx-messenger-hide"});if(le){ie.push(le)}}}if(L[x].countElement<G[x].length){ie.push(s.create("div",{props:{className:"bx-messenger-chatlist-more-wrap"},children:[s.create("span",{attrs:{"data-id":L[x].id,"data-text":s.message("IM_CL_MORE").replace("#COUNT#",G[x].length-L[x].countElement),"data-title":L[x].more},props:{title:L[x].more,className:"bx-messenger-chatlist-more"},html:this.BXIM.messenger.contactListShowed[L[x].id]?s.message("IM_CL_HIDE"):s.message("IM_CL_MORE").replace("#COUNT#",G[x].length-L[x].countElement)})]}))}if(ie.length>0){t.appendChild(s.create("div",{props:{className:"bx-messenger-chatlist-category"+(this.BXIM.messenger.contactListShowed[L[x].id]?" bx-messenger-chatlist-show-all":"")},children:ie}));if(b&&L[x].id=="extranet"){t.appendChild(s.create("div",{props:{className:"bx-messenger-chatlist-search-button-wrap"},children:[s.create("span",{props:{className:"bx-messenger-chatlist-search-button"},html:s.message("IM_SEARCH_B24")})]}))}}}if(l){t.appendChild(s.create("div",{props:{className:"bx-messenger-cl-item-search"},html:s.message("IM_M_CL_SEARCH")}))}else if(t.childNodes.length<=0){t.appendChild(s.create("div",{props:{className:"bx-messenger-cl-item-empty"},html:s.message("IM_M_CL_EMPTY")}));X.empty()}return t};t.prototype.userHasPhone=function(e){return this.BXIM.messenger.users.hasOwnProperty(e)&&this.BXIM.messenger.users[e].phone_device||this.BXIM.messenger.phones.hasOwnProperty(e)&&(this.BXIM.messenger.phones[e].hasOwnProperty("PERSONAL_MOBILE")||this.BXIM.messenger.phones[e].hasOwnProperty("PERSONAL_PHONE")||this.BXIM.messenger.phones[e].hasOwnProperty("WORK_PHONE"))};t.prototype.prepareCommandList=function(e){e=typeof e=="string"?e:"";var t=s.clone(this.BXIM.messenger.command);var r=[];var i=[];for(var a=0;a<t.length;a++){if(this.BXIM.messenger.openChatFlag){if(s.MessengerCommon.userInChat(this.BXIM.messenger.currentTab.toString().substr(4),t[a].bot_id)){r.push(t[a])}else{i.push(t[a])}}else{if(this.BXIM.messenger.currentTab==parseInt(t[a].bot_id)){r.push(t[a])}else{i.push(t[a])}}}for(var a=0;a<i.length;a++){r.push(i[a])}var n=[];var o="";for(var a=0;a<r.length;a++){if(e==""||r[a].command.indexOf(e)===1){if(this.BXIM.userExtranet&&!r[a].extranet)continue;if(!r[a].common){if(this.BXIM.messenger.openChatFlag){if(!s.MessengerCommon.userInChat(this.BXIM.messenger.currentTab.toString().substr(4),r[a].bot_id)){continue}}else if(this.BXIM.messenger.currentTab!=parseInt(r[a].bot_id)){continue}}if(r[a].context!=""){if(r[a].context=="chat"){if(!this.BXIM.messenger.openChatFlag){continue}}else if(r[a].context=="user"){if(this.BXIM.messenger.openChatFlag){continue}}else if(e==""){continue}}if(o!=r[a].category){o=r[a].category;n.push({type:"category",title:o})}if(r[a].command=="/>>"){r[a].command=">>"}r[a].type="item";n.push(r[a])}}return n};t.prototype.drawMessage=function(t,r,i,a){if(typeof r!="object"||this.BXIM.messenger.popupMessenger==null)return false;var n=this.BXIM.messenger.popupMessengerBodyWrap;var o="default";var l=false;var m=true;var h=true;if(typeof t=="object"){l=true;o=t.placeholderName||"custom";n=t.placeholder;m=t.showKeyboard==false?false:true;h=t.showReply==false?false:true}else if(t!=this.BXIM.messenger.currentTab||t==0||!this.MobileActionEqual("DIALOG")){return false}if(r.dropDuplicate){var g=s.findChildByClassName(n,"bx-messenger-content-item-id-"+r.id);if(g){s.remove(g)}r.dropDuplicate=false}a=a==true;i=a?false:i;var p=false;var I=false;var d=r.params&&r.params.IS_EDITED=="Y";var c=r.params&&r.params.IS_DELETED=="Y";var M=c?s.message("IM_M_DELETED"):r.text;var u=r.id.toString().indexOf("temp")==0;var f=u&&r.retry;var B=r.senderId==0;var X=this.BXIM.ppServerStatus;var b=r.params&&r.params.MENU&&r.params.MENU!="N";if(u){M=this.decodeBbCode(M);M=M.replace(/(^|[^"'])((https|http):\/\/([\S]+)\.(jpg|jpeg|png|gif)(\?[\S]+)?)/gi,function(e,t,r){if(!r.match(/(\.(jpg|jpeg|png|gif)\?|\.(jpg|jpeg|png|gif)$)/i)||r.toLowerCase().indexOf("/docs/pub/")>0||r.toLowerCase().indexOf("logout=yes")>0){return e}else if(s.MessengerCommon.isMobile()){return t+'<span class="bx-messenger-file-image"><span class="bx-messenger-file-image-src"><img src="'+r+'" class="bx-messenger-file-image-text" onclick="BXIM.messenger.openPhotoGallery(this.src);" onerror="BX.MessengerCommon.hideErrorImage(this)"></span></span>'}else{return t+'<span class="bx-messenger-file-image"><a href="'+r+'" target="_blank" class="bx-messenger-file-image-src"><img src="'+r+'" class="bx-messenger-file-image-text" onerror="BX.MessengerCommon.hideErrorImage(this)"></a></span>'}})}if(l){p=r.chatId&&this.BXIM.messenger.chat[r.chatId]?true:false;I=p&&r.chatId==this.BXIM.messenger.generalChatId;if(p&&this.BXIM.messenger.chat[r.chatId].type=="call"){X=false}else if(p&&this.BXIM.messenger.chat[r.chatId].type=="lines"){var E=this.linesGetSource(this.BXIM.messenger.chat[r.chatId]);if(!(E=="livechat")){X=false}}else if(!p&&this.BXIM.messenger.bot[r.recipientId]&&(this.BXIM.messenger.bot[r.recipientId].type=="network"||this.BXIM.messenger.bot[r.recipientId].type=="support24")){X=false}}else{if(r.senderId==this.BXIM.userId){if(this.BXIM.messenger.popupMessengerLastMessage>0&&this.BXIM.messenger.message[this.BXIM.messenger.popupMessengerLastMessage]&&this.BXIM.messenger.message[this.BXIM.messenger.popupMessengerLastMessage].recipientId==this.BXIM.messenger.currentTab){if(this.BXIM.messenger.popupMessengerLastMessage<r.id){this.BXIM.messenger.popupMessengerLastMessage=r.id}}else{this.BXIM.messenger.popupMessengerLastMessage=r.id}}this.BXIM.messenger.openChatFlag=this.BXIM.messenger.currentTab.toString().substr(0,4)=="chat";p=this.BXIM.messenger.openChatFlag&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)]&&(this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)].type=="chat"||this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)].type=="open");I=p&&r.chatId==this.BXIM.messenger.generalChatId;if(this.BXIM.messenger.openChatFlag&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)]&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)].type=="call"){X=false}else if(this.BXIM.messenger.openChatFlag&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)]&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)].type=="lines"){var E=this.linesGetSource(this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)]);if(!(E=="livechat")){X=false}}else if(!this.BXIM.messenger.openChatFlag&&this.BXIM.messenger.bot[this.BXIM.messenger.currentTab]&&(this.BXIM.messenger.bot[this.BXIM.messenger.currentTab].type=="network"||this.BXIM.messenger.bot[this.BXIM.messenger.currentTab].type=="support24")){X=false}}if(typeof r.params!="object"){r.params={}}if(r.params.DATE_TEXT){for(var C=0;C<r.params.DATE_TEXT.length;C++){if(r.params.DATE_TS&&r.params.DATE_TS[C]){M=M.split(r.params.DATE_TEXT[C]).join('<span class="bx-messenger-ajax bx-messenger-ajax-black" data-entity="date" data-messageId="'+r.id+'" data-ts="'+r.params.DATE_TS[C]+'">'+r.params.DATE_TEXT[C]+"</span>")}}}var _=X&&typeof r.params.LIKE=="object"&&r.params.LIKE.length>0?r.params.LIKE.length:"";var S=X&&typeof r.params.LIKE=="object"&&s.util.in_array(this.BXIM.userId,r.params.LIKE);var T=this.diskDrawFiles(r.chatId,r.params.FILE_ID);if(T.length>0){T=s.create("div",{props:{className:"bx-messenger-file-box"+(M!=""?" bx-messenger-file-box-with-message":"")},children:T})}else{T=null}var v=h?this.drawMessageReply(r.id):null;var y=null;var A=[];if(r.params.ATTACH){for(var C=0;C<r.params.ATTACH.length;C++){A[C]=r.params.ATTACH[C]}var L=/\[ATTACH=([0-9]{1,})\]/gm;var N=[];while((N=L.exec(M))!==null){for(var C=0;C<A.length;C++){if(r.params.ATTACH[C].ID==N[1]){y=s.create("div",{props:{className:"bx-messenger-attach-box"},children:s.MessengerCommon.drawAttach(r.id,r.chatId,[A[C]])});M=M.replace("[ATTACH="+N[1]+"]",y.innerHTML);delete A[C]}}}}if(r.params.LINK_ACTIVE&&r.params.LINK_ACTIVE.length>0&&r.params.LINK_ACTIVE.indexOf(this.BXIM.userId.toString())<0){M=M.replace(/<a.*?href="([^"]*)".*?>(.*?)<\/a>/gi,"$2")}var x="";if(r.params.CLASS){x=r.params.CLASS}var R=null;if(r.params.IMOL_SID&&parseInt(r.params.IMOL_SID)>0){R=s.create("div",{props:{className:"bx-messenger-message-extra"},html:s.message("IM_OL_DIALOG_NUMBER").replace("#NUMBER#",r.params.IMOL_SID)})}if(r.params.IMOL_FORM&&this.BXIM.messenger.chat[r.chatId]&&this.BXIM.messenger.chat[r.chatId].type=="livechat"){var D=r.params.IMOL_FORM.toString().substr(-6)=="-delay";var w=D?r.params.IMOL_FORM.substr(0,r.params.IMOL_FORM.lastIndexOf("-delay")):r.params.IMOL_FORM;if(this.BXIM.messenger.popupMessengerLiveChatDelayedFormMid<r.id&&this.BXIM.messenger.popupMessengerLiveChatFormType!=w){this.BXIM.messenger.popupMessengerLiveChatDelayedFormMid=r.id;this.BXIM.messenger.popupMessengerLiveChatDelayedForm=D?w:null;this.BXIM.messenger.linesLivechatFormHide();clearTimeout(this.BXIM.messenger.popupMessengerLiveChatActionTimeout);this.BXIM.messenger.popupMessengerLiveChatActionTimeout=setTimeout(s.delegate(function(){this.BXIM.messenger.linesLivechatFormShow(w)},this),D?3e4:5e3)}}y=s.MessengerCommon.drawAttach(r.id,r.chatId,A);if(y.length>0){y=s.create("div",{props:{className:"bx-messenger-attach-box"},children:y})}else{y=null}var O=null;if(m&&r.params.KEYBOARD){O=this.drawKeyboard(r.recipientId,r.id,r.params.KEYBOARD)}var k=false;if(!T&&!y&&M.length<=0){k=true}if(r.system&&r.system=="Y"){B=true;r.senderId=0}var P=false;var U=this.BXIM.messenger.users[r.senderId];if(!B&&(typeof U=="undefined"||U.id<=0)){P=true;k=true}if(r.params&&U&&U.id>0&&(r.params.AVATAR||r.params.NAME||r.params.USER_ID)){U=s.clone(U);if(r.params.AVATAR){U.avatar=r.params.AVATAR}if(r.params.NAME){U.name=r.params.NAME;U.first_name=r.params.NAME.split(" ")[0]}r=s.clone(r);if(parseInt(r.params.USER_ID)){r.senderId="network"+r.params.USER_ID}}var H=this.linesVoteDraw(r.id);if(H){M=H;r.system="Y"}else{x=x.replace("bx-messenger-content-item-vote","");var G=this.linesVoteResultDraw(r.id,M);if(G){M=G}}if(!l){if(!this.BXIM.messenger.history[t])this.BXIM.messenger.history[t]=[];if(parseInt(r.id)>0&&this.BXIM.messenger.history[t].indexOf(r.id.toString())==-1)this.BXIM.messenger.history[t].push(r.id);var F=0;if(!P){var j=false;if(this.BXIM.messenger.unreadMessage[t]&&s.util.in_array(r.id,this.BXIM.messenger.unreadMessage[t]))j=true}}var W=false;var V=null;if(a){V=n.firstChild;if(V){if(s.hasClass(V,"bx-messenger-content-empty")||s.hasClass(V,"bx-messenger-content-load")){s.remove(V)}else if(s.hasClass(V,"bx-messenger-content-group")){V=V.nextSibling}}}else{V=n.lastChild;if(V&&(s.hasClass(V,"bx-messenger-content-empty")||s.hasClass(V,"bx-messenger-content-load"))){s.remove(V)}else if(V&&s.hasClass(V,"bx-messenger-content-item-notify")){if(r.senderId==this.BXIM.messenger.currentTab||!this.countWriting(this.BXIM.messenger.currentTab)){s.remove(V);W=false;V=n.lastChild}else{W=true;V=n.lastChild.previousSibling}}}if(!P){var Y=this.formatDate(r.date,this.getDateFormatType("MESSAGE_TITLE"));var K=typeof s.translit!="undefined"?s.translit(Y):Y;if(typeof this.messageGroup!="object"){this.messageGroup={}}if(typeof this.messageGroup[o]!="object"){this.messageGroup[o]={}}if(!this.messageGroup[o][K]){this.messageGroup[o][K]=true;var q=[];if(this.BXIM.desktop&&this.isPage()){q=[s.create("a",{attrs:{name:"bx-im-go-"+r.date},props:{className:"bx-messenger-content-group-link"}}),s.create("a",{attrs:{id:"bx-im-go-"+K,href:"#bx-im-go-"+r.date},props:{className:"bx-messenger-content-group-title"+(this.BXIM.language=="ru"?" bx-messenger-lowercase":"")},html:Y})]}else{q=[s.create("a",{attrs:{name:"bx-im-go-"+r.date},props:{className:"bx-messenger-content-group-link"}}),s.create("div",{attrs:{id:"bx-im-go-"+K},props:{className:"bx-messenger-content-group-title"+(this.BXIM.language=="ru"?" bx-messenger-lowercase":"")},html:Y})]}var J=s.create("div",{props:{className:"bx-messenger-content-group"+(Y==s.message("FD_TODAY")?" bx-messenger-content-group-today":"")},children:q});if(a){n.insertBefore(J,n.firstChild);V=J.nextSibling}else{if(W&&V.nextElementSibling){n.insertBefore(J,V.nextElementSibling);V=J}else{n.appendChild(J)}}}}var Q=false;var $=false;var z=null;if(typeof M=="string"){if(M.length>0){var Z=M.replace(/<img.*?data-code="([^"]*)".*?>/gi,"$1").replace(/<\/?[^>]+>/gi," ").replace(/(https|http):\/\/([\S]+)\.(jpg|jpeg|png|gif)(\?[\S]+)?/gi,function(e){return""}).trim();if(!Z){Q=true}}if(this.BXIM.settings.enableRichLink&&r.params.URL_ONLY=="Y"&&r.params.URL_ID&&r.params.URL_ID.length>0&&r.params.ATTACH&&r.params.ATTACH.length>0){$=true}var ee={oneSmileInMessage:false};z=s.create("span",{props:{className:"bx-messenger-message"},attrs:{id:"im-message-"+r.id},html:this.prepareText(M,false,true,true,!this.BXIM.messenger.openChatFlag||r.senderId==this.BXIM.userId?false:this.BXIM.messenger.users[this.BXIM.userId].name,ee)});var se=ee.oneSmileInMessage}else{z=s.create("span",{props:{className:"bx-messenger-message"},attrs:{id:"im-message-"+r.id},children:[M]});var se=false}var te=r.params.LARGE_FONT=="Y"&&this.BXIM.settings.enableBigSmile;if(!k){if(V)F=V.getAttribute("data-messageId");if(B){var re=s.create("div",{attrs:{"data-type":"system","data-senderId":"0","data-messageId":r.id,"data-blockmessageid":r.id},props:{className:"bx-messenger-content-item bx-messenger-content-item-id-"+r.id+" bx-messenger-content-item-notice "+x},children:[R,s.create("span",{props:{className:"bx-messenger-content-item-content"+(se?" bx-messenger-content-item-content-transparent":"")+(Q?" bx-messenger-content-item-content-without-padding":"")+($&&!c?" bx-messenger-content-item-content-rich-link":"")+(c||d?" bx-messenger-message-edited":"")+(te?" bx-messenger-content-item-content-large-font":"")},children:[!I?[]:s.create("span",{attrs:{title:(b?s.message("IM_M_MENU_APP_EXISTS")+" ":"")+s.message("IM_M_OPEN_EXTRA_TITLE").replace("#SHORTCUT#",s.browser.IsMac()?"CMD":"CTRL")},props:{className:"bx-messenger-content-item-menu"+(b?" bx-messenger-content-item-menu-with-apps":"")}}),!this.isMobile()||!X?null:s.create("span",{props:{className:"bx-messenger-content-item-like"+(S?" bx-messenger-content-item-liked":"")+(_<=0?" bx-messenger-content-like-digit-off":"")},children:[s.create("span",{attrs:{"data-messageId":r.id},props:{className:"bx-messenger-content-like-button"},html:""}),s.create("span",{attrs:{title:_>0?s.message("IM_MESSAGE_LIKE_LIST"):""},props:{className:"bx-messenger-content-like-digit"},html:_})],events:this.isMobile()?{click:s.delegate(function(e){this.BXIM.messageLike(r.id);return s.PreventDefault(e)},this)}:{}}),typeof U=="undefined"||U.id<=0?[]:s.create("span",{props:{className:"bx-messenger-content-item-avatar"},children:[s.create("span",{props:{className:"bx-messenger-content-item-arrow"}}),s.create("span",{props:{className:"bx-messenger-content-item-avatar-block"},children:[s.create("img",{props:{className:"bx-messenger-content-item-avatar-img"+(s.MessengerCommon.isBlankAvatar(U.avatar)?" bx-messenger-content-item-avatar-img-default":"")},attrs:{src:this.formatUrl(U.avatar),style:this.isBlankAvatar(U.avatar)?"background-color: "+U.color:""}}),this.BXIM.messenger.openChatFlag?s.create("span",{props:{className:"bx-messenger-content-item-avatar-name"},attrs:{title:s.util.htmlspecialcharsback(U.name)},html:U.first_name?U.first_name:U.name.split(" ")[0]}):null]})]}),s.create("span",{props:{className:"bx-messenger-content-item-status"},children:[]}),s.create("span",{props:{className:"bx-messenger-content-item-text-center"},children:[s.create("span",{props:{className:"bx-messenger-content-item-text-message"},children:[s.create("span",{props:{className:"bx-messenger-content-item-text-wrap"+(a?" bx-messenger-content-item-text-wrap-append":"")+(c?" bx-messenger-message-deleted":" ")},children:[T,z,y]})]}),s.create("span",{props:{className:"bx-messenger-content-item-params"},children:[s.create("span",{props:{className:"bx-messenger-content-item-date"},html:this.formatDate(r.date,this.getDateFormatType("MESSAGE"))})]}),s.create("span",{props:{className:"bx-messenger-clear"}})]})]}),O,v]});if(r.system&&r.system=="Y"&&j)s.addClass(re,"bx-messenger-content-item-new")}else if(r.senderId==this.BXIM.userId){var re=s.create("div",{attrs:{"data-type":"self","data-senderId":r.senderId,"data-messageDate":r.date,"data-messageId":r.id,"data-blockmessageid":r.id},props:{className:"bx-messenger-content-item bx-messenger-content-item-id-"+r.id+" bx-messenger-content-item-1 "+x},children:[R,s.create("span",{props:{className:"bx-messenger-content-item-content"+(se?" bx-messenger-content-item-content-transparent":"")+(Q?" bx-messenger-content-item-content-without-padding":"")+($&&!c?" bx-messenger-content-item-content-rich-link":"")+(c||d?" bx-messenger-message-edited":"")+(te?" bx-messenger-content-item-content-large-font":"")},children:[s.create("span",{attrs:{title:(b?s.message("IM_M_MENU_APP_EXISTS")+" ":"")+s.message("IM_M_OPEN_EXTRA_TITLE").replace("#SHORTCUT#",s.browser.IsMac()?"CMD":"CTRL")},props:{className:"bx-messenger-content-item-menu"+(b?" bx-messenger-content-item-menu-with-apps":"")}}),!this.isMobile()||!X?null:s.create("span",{props:{className:"bx-messenger-content-item-like"+(S?" bx-messenger-content-item-liked":"")+(_<=0?" bx-messenger-content-like-digit-off":"")},children:[s.create("span",{attrs:{"data-messageId":r.id},props:{className:"bx-messenger-content-like-button"},html:""}),s.create("span",{attrs:{title:_>0?s.message("IM_MESSAGE_LIKE_LIST"):""},props:{className:"bx-messenger-content-like-digit"},html:_})],events:this.isMobile()?{click:s.delegate(function(e){this.BXIM.messageLike(r.id);return s.PreventDefault(e)},this)}:{}}),s.create("span",{props:{className:"bx-messenger-content-item-avatar"},children:[s.create("span",{props:{className:"bx-messenger-content-item-arrow"}}),s.create("span",{props:{className:"bx-messenger-content-item-avatar-block"},children:[s.create("img",{props:{className:"bx-messenger-content-item-avatar-img"+(s.MessengerCommon.isBlankAvatar(U.avatar)?" bx-messenger-content-item-avatar-img-default":"")},attrs:{src:this.formatUrl(U.avatar),style:this.isBlankAvatar(U.avatar)?"background-color: "+U.color:""}}),this.BXIM.messenger.openChatFlag?s.create("span",{props:{className:"bx-messenger-content-item-avatar-name"},attrs:{title:s.util.htmlspecialcharsback(U.name)},html:U.first_name?U.first_name:U.name.split(" ")[0]}):null]})]}),f?s.create("span",{props:{className:"bx-messenger-content-item-status"},children:[s.create("span",{attrs:{title:s.message("IM_M_RETRY"),"data-messageid":r.id,"data-chat":parseInt(r.recipientId)>0?"Y":"N"},props:{className:"bx-messenger-content-item-error"},children:[s.create("span",{props:{className:"bx-messenger-content-item-error-icon"}})]})]}):s.create("span",{props:{className:"bx-messenger-content-item-status"},children:u?[s.create("span",{props:{className:"bx-messenger-content-item-progress"}})]:[]}),s.create("span",{props:{className:"bx-messenger-content-item-text-center"},children:[s.create("span",{props:{className:"bx-messenger-content-item-text-message"},children:[s.create("span",{props:{className:"bx-messenger-content-item-text-wrap"+(a?" bx-messenger-content-item-text-wrap-append":"")+(c?" bx-messenger-message-deleted":" ")},children:[T,z,y]})]}),s.create("span",{props:{className:"bx-messenger-content-item-params"},children:[!X||this.isMobile()?null:s.create("span",{props:{className:"bx-messenger-content-item-like"+(S?" bx-messenger-content-item-liked":"")+(_<=0?" bx-messenger-content-like-digit-off":"")},children:[s.create("span",{html:"&nbsp;"}),s.create("span",{attrs:{title:_>0?s.message("IM_MESSAGE_LIKE_LIST"):""},props:{className:"bx-messenger-content-like-digit"},html:_}),s.create("span",{attrs:{"data-messageId":r.id},props:{className:"bx-messenger-content-like-button"},html:s.message("IM_MESSAGE_LIKE")})]}),s.create("span",{props:{className:"bx-messenger-content-item-date"},html:f?s.message("IM_M_NOT_DELIVERED"):this.formatDate(r.date,this.getDateFormatType("MESSAGE"))})]}),s.create("span",{props:{className:"bx-messenger-clear"}})]})]}),O,v]})}else{var re=s.create("div",{attrs:{"data-type":"other","data-senderId":r.senderId,"data-messageDate":r.date,"data-messageId":r.id,"data-blockmessageid":r.id},props:{className:"bx-messenger-content-item bx-messenger-content-item-id-"+r.id+" bx-messenger-content-item-2"+(j?" bx-messenger-content-item-new":"")+" "+x},children:[R,s.create("span",{props:{className:"bx-messenger-content-item-content"+(se?" bx-messenger-content-item-content-transparent":"")+(Q?" bx-messenger-content-item-content-without-padding":"")+($&&!c?" bx-messenger-content-item-content-rich-link":"")+(c||d?" bx-messenger-message-edited":"")+(te?" bx-messenger-content-item-content-large-font":"")},children:[s.create("span",{attrs:{title:(b?s.message("IM_M_MENU_APP_EXISTS")+" ":"")+s.message("IM_M_OPEN_EXTRA_TITLE").replace("#SHORTCUT#",s.browser.IsMac()?"CMD":"CTRL")},props:{className:"bx-messenger-content-item-menu"+(b?" bx-messenger-content-item-menu-with-apps":"")}}),!this.isMobile()||!X?null:s.create("span",{props:{className:"bx-messenger-content-item-like"+(S?" bx-messenger-content-item-liked":"")+(_<=0?" bx-messenger-content-like-digit-off":"")},children:[s.create("span",{attrs:{"data-messageId":r.id},props:{className:"bx-messenger-content-like-button"},html:""}),s.create("span",{attrs:{title:_>0?s.message("IM_MESSAGE_LIKE_LIST"):""},props:{className:"bx-messenger-content-like-digit"},html:_})],events:this.isMobile()?{click:s.delegate(function(e){this.BXIM.messageLike(r.id);return s.PreventDefault(e)},this)}:{}}),s.create("span",{attrs:{title:s.util.htmlspecialcharsback(U.name)},props:{className:"bx-messenger-content-item-avatar bx-messenger-content-item-avatar-button"},children:[s.create("span",{props:{className:"bx-messenger-content-item-arrow"}}),s.create("span",{props:{className:"bx-messenger-content-item-avatar-block"},children:[s.create("img",{props:{className:"bx-messenger-content-item-avatar-img"+(s.MessengerCommon.isBlankAvatar(U.avatar)?" bx-messenger-content-item-avatar-img-default":"")},attrs:{src:this.formatUrl(U.avatar),style:this.isBlankAvatar(U.avatar)?"background-color: "+U.color:""}}),this.BXIM.messenger.openChatFlag||U.bot?s.create("span",{props:{className:"bx-messenger-content-item-avatar-name"},attrs:{title:s.util.htmlspecialcharsback(U.name)},html:U.first_name?U.first_name:U.name.split(" ")[0]}):null]})]}),s.create("span",{props:{className:"bx-messenger-content-item-status"},children:[]}),s.create("span",{props:{className:"bx-messenger-content-item-text-center"},children:[s.create("span",{props:{className:"bx-messenger-content-item-text-message"},children:[s.create("span",{props:{className:"bx-messenger-content-item-text-wrap"+(a?" bx-messenger-content-item-text-wrap-append":"")+(c?" bx-messenger-message-deleted":" ")},children:[T,z,y]})]}),s.create("span",{props:{className:"bx-messenger-content-item-params"},children:[!X||this.isMobile()?null:s.create("span",{props:{className:"bx-messenger-content-item-like"+(S?" bx-messenger-content-item-liked":"")+(_<=0?" bx-messenger-content-like-digit-off":"")},children:[s.create("span",{html:"&nbsp;"}),s.create("span",{attrs:{title:_>0?s.message("IM_MESSAGE_LIKE_LIST"):""},props:{className:"bx-messenger-content-like-digit"},html:_}),s.create("span",{attrs:{"data-messageId":r.id},props:{className:"bx-messenger-content-like-button"},html:s.message("IM_MESSAGE_LIKE")})]}),s.create("span",{props:{className:"bx-messenger-content-item-date"},html:this.formatDate(r.date,this.getDateFormatType("MESSAGE"))})]}),s.create("span",{props:{className:"bx-messenger-clear"}})]})]}),O,v]})}}else if(P){re=s.create("div",{attrs:{id:"im-message-"+r.id,"data-messageDate":r.date,"data-messageId":r.id,"data-blockmessageid":r.id},props:{className:"bx-messenger-content-item-text-wrap bx-messenger-item-skipped"}})}if(re&&(!k||P)){var ie=null;if(V&&V.getAttribute("data-senderId")!=r.senderId){ie=s.create("div",{props:{className:"bx-messenger-item-delimiter"}})}if(a){n.insertBefore(re,V);if(ie){n.insertBefore(ie,V)}}else if(W&&V&&V.nextElementSibling){n.insertBefore(re,V.nextElementSibling);if(ie){n.insertBefore(ie,V.nextElementSibling)}}else{if(ie){n.appendChild(ie)}n.appendChild(re)}}if(!l&&!P&&i!==false&&this.enableScroll(this.BXIM.messenger.popupMessengerBody,this.BXIM.messenger.popupMessengerBody.offsetHeight)){if(this.isMobile()&&document.body.offsetHeight<=e.innerHeight){this.BXIM.messenger.popupMessengerBody.scrollTop=0}else if(this.BXIM.animationSupport){if(this.BXIM.messenger.popupMessengerBodyAnimation!=null)this.BXIM.messenger.popupMessengerBodyAnimation.stop();(this.BXIM.messenger.popupMessengerBodyAnimation=new s.easing({duration:800,start:{scroll:this.BXIM.messenger.popupMessengerBody.scrollTop},finish:{scroll:this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)},transition:s.easing.makeEaseInOut(s.easing.transitions.quart),step:s.delegate(function(e){this.BXIM.messenger.popupMessengerBody.scrollTop=e.scroll},this)})).animate()}else{this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)}}if(r.params.SENDING=="Y"||r.params.IS_DELIVERED=="N"){this.drawProgessMessage(r.id)}return F};t.prototype.drawMessageReply=function(e){var t=null;if(!(this.BXIM.messenger.message[e]&&this.BXIM.messenger.message[e].params&&this.BXIM.messenger.message[e].params.CHAT_ID>0)){return t}var r=this.BXIM.messenger.message[e].params.CHAT_ID;var i=this.BXIM.messenger.message[e].chatId;var a=this.BXIM.messenger.message[e].params.CHAT_LAST_DATE?new Date(this.BXIM.messenger.message[e].params.CHAT_LAST_DATE):"";var n=this.BXIM.messenger.message[e].params.CHAT_MESSAGE||0;t=s.create("div",{props:{className:"bx-messenger-content-reply"},attrs:{id:"im-message-content-reply-"+e,"data-messageId":e,"data-chatid":r},children:[s.create("span",{props:{className:"bx-messenger-content-reply-block"},children:[s.create("span",{props:{className:"bx-messenger-content-reply-comment"},children:[s.create("span",{props:{className:"bx-messenger-content-reply-answer"},events:{click:s.delegate(function(){this.joinParentChat(s.proxy_context.getAttribute("data-messageId"),s.proxy_context.getAttribute("data-chatId"))},this)},attrs:{"data-messageId":e,"data-chatId":r},html:n+" "+this.getMessagePlural("IM_R_COMMENT",n)}),s.create("span",{props:{className:"bx-messenger-content-reply-date"},html:a?", "+this.formatDate(a):""})]}),s.create("div",{props:{className:"bx-messenger-content-reply-clear"}})]}),s.create("span",{props:{className:"bx-messenger-content-reply-join"},children:[s.create("span",{props:{className:"bx-messenger-content-reply-join-button"},html:s.message("IM_M_OPEN"),events:{click:s.delegate(function(){this.joinParentChat(s.proxy_context.getAttribute("data-messageId"),s.proxy_context.getAttribute("data-chatId"))},this)},attrs:{"data-messageId":e,"data-chatId":r}})]}),s.create("div",{props:{className:"bx-messenger-content-reply-clear"}})]});return t};t.prototype.joinParentChat=function(e,t){if(!e||!t)return false;if(this.BXIM.messenger.blockJoinChat[t])return false;if(this.BXIM.messenger.chat[t]){this.BXIM.messenger.blockJoinChat[t]=false;this.BXIM.messenger.openMessenger("chat"+t)}else{this.BXIM.messenger.blockJoinChat[t]=true;s.ajax({url:this.BXIM.pathToAjax+"?PARENT_CHAT_JOIN&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:60,data:{IM_PARENT_CHAT_JOIN:"Y",CHAT_ID:t,MESSAGE_ID:e,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(){this.BXIM.messenger.blockJoinChat[t]=false;this.BXIM.messenger.openMessenger("chat"+t)},this),onfailure:s.delegate(function(){this.BXIM.messenger.blockJoinChat[t]=false},this)})}};t.prototype.openReplyDialog=function(e){if(this.isMobile()){alert(s.message("IM_AV_NEXT_VERSION"));return false}this.BXIM.messenger.openMessengerPanel();this.BXIM.messenger.popupMessengerBodyPanelTitleName.innerHTML=s.message("IM_R_DIALOG_TITLE");var t=this.drawMessageReply(e);if(t){this.BXIM.messenger.popupMessengerBodyPanelTitleDesc.innerHTML="";this.BXIM.messenger.popupMessengerBodyPanelTitleDesc.appendChild(t)}else{this.BXIM.messenger.popupMessengerBodyPanelTitleDesc.innerHTML=s.message("IM_R_COMMENT_ZERO")}this.BXIM.messenger.popupMessengerBodyPanelWrap.innerHTML="";s.adjust(this.BXIM.messenger.popupMessengerBodyPanelWrap,{children:[this.BXIM.messenger.popupMessengerBodyPanelWrapMessage=s.create("div",{props:{className:"bx-messenger-body-panel-wrap-message"}}),this.BXIM.messenger.popupMessengerBodyPanelWrapMessages=s.create("div",{props:{className:"bx-messenger-body-panel-wrap-message-list"}}),s.create("div",{props:{className:"bx-messenger-body-panel-wrap-message-textarea"},children:[this.popupMessengerTextareaPlace=s.create("div",{props:{className:"bx-messenger-textarea-place"},children:[s.create("div",{props:{className:"bx-messenger-textarea-send"},children:[s.create("a",{attrs:{href:"#send"},props:{className:"bx-messenger-textarea-send-button"},events:{click:s.delegate(this.sendMessage,this)}})]}),this.popupMessengerBodyPanelSmileButton=s.create("div",{attrs:{title:s.message("IM_SMILE_MENU")},props:{className:"bx-messenger-textarea-smile"},events:{click:s.delegate(function(e){this.openSmileMenu();return s.PreventDefault(e)},this)}}),s.create("div",{props:{className:"bx-messenger-textarea"},children:[this.popupMessengerPanelTextarea=s.create("textarea",{props:{value:"",className:"bx-messenger-textarea-input"}}),this.popupMessengerPanelTextareaPlaceholder=s.create("div",{props:{className:"bx-messenger-textarea-placeholder"},html:s.message("IM_M_TA_TEXT")})]}),s.create("div",{props:{className:"bx-messenger-textarea-clear"}})]})]})]});if(typeof this.messageGroup!="object"){this.messageGroup={}}this.messageGroup["reply"]={};this.drawMessage({placeholder:this.BXIM.messenger.popupMessengerBodyPanelWrapMessage,placeholderName:"reply",showKeyboard:false,showReply:false},this.BXIM.messenger.message[e]);if(t){this.BXIM.messenger.popupMessengerBodyPanelWrapMessages.innerHTML='<div class="bx-messenger-content-empty"><span class="bx-messenger-content-load-text">'+s.message("IM_R_LOAD_COMMENT")+"</span></div>"}else{this.BXIM.messenger.popupMessengerBodyPanelWrapMessages.innerHTML='<div class="bx-messenger-content-empty"><span class="bx-messenger-content-load-text">'+s.message("IM_R_NO_COMMENT")+"</span></div>"}this.messageGroup["replyMessages"]={};if(t){setTimeout(s.delegate(function(){if(!this.BXIM.messenger.message[e]||this.BXIM.messenger.message[e].params||this.BXIM.messenger.message[e].params.CHAT_ID<=0){return false}var t="chat"+this.BXIM.messenger.message[e].params.CHAT_ID;this.loadLastMessage(t,s.delegate(function(e,t,r){if(!t){this.BXIM.messenger.popupMessengerBodyPanelWrapMessages.innerHTML='<div class="bx-messenger-content-empty"><span class="bx-messenger-content-load-text">'+s.message("IM_F_ERROR")+"</span></div>";return false}this.BXIM.messenger.popupMessengerBodyPanelWrapMessages.innerHTML="";var i=s.util.shuffle(this.BXIM.messenger.showMessage[e]);for(var a=0;a<i.length;a++){this.drawMessage({placeholder:this.BXIM.messenger.popupMessengerBodyPanelWrapMessages,placeholderName:"replyMessages",showKeyboard:false,showReply:false},this.BXIM.messenger.message[i[a]])}},this))},this),1e3)}return true};t.prototype.checkProgessMessage=function(){for(messageId in this.BXIM.messenger.popupMessengerSendingTimeout){if(!this.BXIM.messenger.message[messageId]||!this.BXIM.messenger.message[messageId].params||!this.BXIM.messenger.message[messageId].params.SENDING_TS){delete this.BXIM.messenger.popupMessengerSendingTimeout[messageId]}else if(parseInt(this.BXIM.messenger.message[messageId].params.SENDING_TS)+86400<(new Date).getTime()/1e3){this.drawProgessMessage(messageId)}}};t.prototype.drawProgessMessage=function(e,t){var r=s("im-message-"+e);if(!r)return false;s.addClass(r.parentNode.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress");s.MessengerTimer.start("progressMessage",e,5e3,function(e){var t=s("im-message-"+e);if(!t)return false;s.addClass(t.parentNode.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress-start")});r.parentNode.parentNode.parentNode.previousSibling.innerHTML="";var i=true;if(this.BXIM.messenger.message[e]&&this.BXIM.messenger.message[e].params&&(this.BXIM.messenger.message[e].params.SENDING=="Y"&&parseInt(this.BXIM.messenger.message[e].params.SENDING_TS)+86400<(new Date).getTime()/1e3||this.BXIM.messenger.message[e].params.IS_DELIVERED=="N")){delete this.BXIM.messenger.popupMessengerSendingTimeout[e];this.BXIM.messenger.message[e].params.IS_DELIVERED="N";this.BXIM.messenger.message[e].params.SENDING="N";this.BXIM.messenger.message[e].params.SENDING_TS=0;i=false;var a=s.findChildByClassName(r.parentNode.parentNode.parentNode,"bx-messenger-content-item-date");if(a)a.innerHTML=s.message("IM_M_NOT_DELIVERED")}if(this.BXIM.messenger.message[e]&&this.BXIM.messenger.message[e].params&&this.BXIM.messenger.message[e].params.SENDING=="Y"){this.BXIM.messenger.popupMessengerSendingTimeout[e]=this.BXIM.messenger.message[e].params.SENDING_TS}if(!i){if(this.BXIM.messenger.message[e]){s.addClass(r.parentNode.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress-error");s.MessengerTimer.stop("progressMessage",e,true)}}else if(typeof t=="object"||t===true){if(this.BXIM.messenger.message[e]){this.BXIM.messenger.errorMessage[this.BXIM.messenger.currentTab]=true;s.addClass(r.parentNode.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress-error");s.MessengerTimer.stop("progressMessage",e,true);t.chat=t.chat?t.chat:parseInt(this.BXIM.messenger.message[e].recipientId)>0?"Y":"N";s.adjust(r.parentNode.parentNode.parentNode.previousSibling,{children:[s.create("span",{attrs:{title:t.title?t.title:"","data-messageid":e,"data-chat":t.chat},props:{className:"bx-messenger-content-item-error"},children:[s.create("span",{props:{className:"bx-messenger-content-item-error-icon"}})]})]})}else{s.MessengerTimer.stop("progressMessage",e,true);s.removeClass(r.parentNode.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress");s.removeClass(r.parentNode.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress-start");s.removeClass(r.parentNode.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress-error")}}else{s.adjust(r.parentNode.parentNode.parentNode.previousSibling,{children:[s.create("span",{props:{className:"bx-messenger-content-item-progress"}})]})}return true};t.prototype.clearProgessMessage=function(e){delete this.BXIM.messenger.popupMessengerSendingTimeout[e];var t=s("im-message-"+e);if(!t)return false;if(this.BXIM.messenger.message[e]&&this.BXIM.messenger.message[e].params&&(this.BXIM.messenger.message[e].params.SENDING=="Y"||this.BXIM.messenger.message[e].params.IS_DELIVERED=="N")){return false}s.MessengerTimer.stop("progressMessage",e,true);s.removeClass(t.parentNode.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress");s.removeClass(t.parentNode.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress-start");s.removeClass(t.parentNode.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress-error");t.parentNode.parentNode.parentNode.previousSibling.innerHTML="";return true};t.prototype.startWriting=function(e,t,r){if(t==this.BXIM.userId){this.BXIM.messenger.writingList[e]=true;this.drawWriting(e);clearTimeout(this.BXIM.messenger.writingListTimeout[e]);this.BXIM.messenger.writingListTimeout[e]=setTimeout(s.delegate(function(){this.endWriting(e)},this),29500)}else{if(!this.BXIM.messenger.writingList[t])this.BXIM.messenger.writingList[t]={};if(!this.BXIM.messenger.writingListTimeout[t])this.BXIM.messenger.writingListTimeout[t]={};this.BXIM.messenger.writingList[t][e]=true;this.drawWriting(e,t);clearTimeout(this.BXIM.messenger.writingListTimeout[t][e]);this.BXIM.messenger.writingListTimeout[t][e]=setTimeout(s.delegate(function(){this.endWriting(e,t)},this),29500)}};t.prototype.drawWriting=function(t,r,i){i=typeof i=="undefined"?true:i;if(r==this.BXIM.userId)return false;if(!r||r.toString().substr(0,4)!=="chat"){r=""}if(this.BXIM.messenger.popupMessenger!=null&&this.MobileActionEqual("RECENT","DIALOG")){if(this.BXIM.messenger.writingList[t]||r&&this.countWriting(r)>0){var a=s.findChildrenByClassName(this.BXIM.messenger.recentListExternal,"bx-messenger-cl-id-"+(r?r:t));if(a){for(var n=0;n<a.length;n++)s.addClass(a[n],"bx-messenger-cl-status-writing")}var a=s.findChildrenByClassName(this.BXIM.messenger.popupContactListElementsWrap,"bx-messenger-cl-id-"+(r?r:t));if(a){for(var n=0;n<a.length;n++)s.addClass(a[n],"bx-messenger-cl-status-writing")}if(this.MobileActionEqual("DIALOG")&&(this.BXIM.messenger.currentTab==t||r&&this.BXIM.messenger.currentTab==r)){if(r){var o=[];for(var n in this.BXIM.messenger.writingList[r]){if(this.BXIM.messenger.writingList[r].hasOwnProperty(n)&&this.BXIM.messenger.users[n]){o.push(this.BXIM.messenger.users[n].name)}}this.drawNotifyMessage(r,"writing",s.message("IM_M_WRITING").replace("#USER_NAME#",o.join(", ")))}else{if(!this.isMobile()){this.BXIM.messenger.popupMessengerPanelAvatar.parentNode.className="bx-messenger-panel-avatar bx-messenger-panel-avatar-status-writing"}this.drawNotifyMessage(t,"writing",s.message("IM_M_WRITING").replace("#USER_NAME#",this.BXIM.messenger.users[t].name))}}}else if(!this.BXIM.messenger.writingList[t]||r&&this.countWriting(r)==0){var a=s.findChildrenByClassName(this.BXIM.messenger.recentListExternal,"bx-messenger-cl-id-"+(r?r:t));if(a){for(var n=0;n<a.length;n++)s.removeClass(a[n],"bx-messenger-cl-status-writing")}var a=s.findChildrenByClassName(this.BXIM.messenger.popupContactListElementsWrap,"bx-messenger-cl-id-"+(r?r:t));if(a){for(var n=0;n<a.length;n++)s.removeClass(a[n],"bx-messenger-cl-status-writing")}if(this.MobileActionEqual("DIALOG")&&(this.BXIM.messenger.currentTab==t||this.BXIM.messenger.currentTab==r)){if(!r){if(!this.isMobile())this.BXIM.messenger.popupMessengerPanelAvatar.parentNode.className="bx-messenger-panel-avatar bx-messenger-panel-avatar-status-"+this.getUserStatus(this.BXIM.messenger.users[t])}var l=this.BXIM.messenger.popupMessengerBodyWrap.lastChild;if(l&&s.hasClass(l,"bx-messenger-content-item-notify")&&this.BXIM.messenger.popupMessengerBody){if(!r&&this.BXIM.messenger.readedList[t]){this.drawReadMessage(t,this.BXIM.messenger.readedList[t].messageId,this.BXIM.messenger.readedList[t].date,false)}else if(r&&this.BXIM.messenger.readedList[r]){this.drawReadMessageChat(r,false)}else if(s.MessengerCommon.enableScroll(this.BXIM.messenger.popupMessengerBody,this.BXIM.messenger.popupMessengerBody.offsetHeight)){if(this.isMobile()&&document.body.offsetHeight<=e.innerHeight){this.BXIM.messenger.popupMessengerBody.scrollTop=0}else if(this.BXIM.animationSupport){if(this.BXIM.messenger.popupMessengerBodyAnimation!=null)this.BXIM.messenger.popupMessengerBodyAnimation.stop();(this.BXIM.messenger.popupMessengerBodyAnimation=new s.easing({duration:800,start:{scroll:this.BXIM.messenger.popupMessengerBody.scrollTop},finish:{scroll:this.BXIM.messenger.popupMessengerBody.scrollTop-l.offsetHeight},transition:s.easing.makeEaseInOut(s.easing.transitions.quart),step:s.delegate(function(e){this.BXIM.messenger.popupMessengerBody.scrollTop=e.scroll},this),complete:s.delegate(function(){s.remove(l)},this)})).animate()}else if(i){this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollTop-l.offsetHeight;s.remove(l)}}else{this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollTop-l.offsetHeight;s.remove(l)}}}}}};t.prototype.endWriting=function(e,s,t){t=typeof t=="undefined"?true:t;if(s.toString().substr(0,4)=="chat"){if(this.BXIM.messenger.writingListTimeout[s]&&this.BXIM.messenger.writingListTimeout[s][e])clearTimeout(this.BXIM.messenger.writingListTimeout[s][e]);if(this.BXIM.messenger.writingList[s]&&this.BXIM.messenger.writingList[s][e])delete this.BXIM.messenger.writingList[s][e]}else{clearTimeout(this.BXIM.messenger.writingListTimeout[e]);delete this.BXIM.messenger.writingList[e]}this.drawWriting(e,s,t)};t.prototype.sendWriting=function(t){if(!this.BXIM.ppServerStatus||t=="create"||t==this.BXIM.userId)return false;if(!this.BXIM.messenger.writingSendList[t]){clearTimeout(this.BXIM.messenger.writingSendListTimeout[t]);this.BXIM.messenger.writingSendList[t]=true;var r="N";if(t.toString().substr(0,4)=="chat"&&this.BXIM.messenger.linesSilentMode&&this.BXIM.messenger.linesSilentMode[t.toString().substr(4)]){r="Y"}s.ajax({url:this.BXIM.pathToAjax+"?START_WRITING&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_START_WRITING:"Y",DIALOG_ID:t,OL_SILENT:r,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(t){if(t&&t.BITRIX_SESSID){s.message({bitrix_sessid:t.BITRIX_SESSID})}if(t.ERROR=="AUTHORIZE_ERROR"&&this.isDesktop()&&this.BXIM.messenger.sendAjaxTry<3){this.BXIM.messenger.sendAjaxTry++;s.onCustomEvent(e,"onImError",[t.ERROR])}else if(t.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;s.onCustomEvent(e,"onImError",[t.ERROR,t.BITRIX_SESSID])}else{if(t.ERROR=="AUTHORIZE_ERROR"||t.ERROR=="SESSION_ERROR"){s.onCustomEvent(e,"onImError",[t.ERROR])}}},this)});this.BXIM.messenger.writingSendListTimeout[t]=setTimeout(s.delegate(function(){this.endSendWriting(t)},this),3e4)}};t.prototype.endSendWriting=function(e){clearTimeout(this.BXIM.messenger.writingSendListTimeout[e]);this.BXIM.messenger.writingSendList[e]=false};t.prototype.countWriting=function(e){var s=0;if(this.BXIM.messenger.writingList[e]){if(typeof this.BXIM.messenger.writingList[e]=="object"){for(var t in this.BXIM.messenger.writingList[e]){if(this.BXIM.messenger.writingList[e].hasOwnProperty(t)){s++}}}else{s=1}}return s};t.prototype.leaveFromChat=function(e,t){if(!this.BXIM.messenger.chat[e])return false;t=t!=false;if(!t){if(this.BXIM.messenger.chat[e].type!="open"||this.BXIM.messenger.users[this.BXIM.userId].extranet){delete this.BXIM.messenger.chat[e];delete this.BXIM.messenger.userInChat[e];delete this.BXIM.messenger.unreadMessage["chat"+e];delete this.BXIM.messenger.showMessage["chat"+e];if(this.BXIM.messenger.popupMessenger!=null){if(this.BXIM.messenger.currentTab=="chat"+e){this.BXIM.messenger.currentTab=0;this.BXIM.messenger.openChatFlag=false;this.BXIM.messenger.openCallFlag=false;this.BXIM.messenger.openLinesFlag=false;this.BXIM.messenger.extraClose()}}}else{for(var r=0;r<this.BXIM.messenger.userInChat[e].length;r++){if(this.BXIM.userId==parseInt(this.BXIM.messenger.userInChat[e][r])){delete this.BXIM.messenger.userInChat[e][r];break}}this.BXIM.messenger.dialogStatusRedraw();delete this.BXIM.messenger.unreadMessage["chat"+e];delete this.BXIM.messenger.showMessage["chat"+e]}this.recentListHide("chat"+e,false);this.userListRedraw();this.BXIM.messenger.updateMessageCount();this.BXIM.updateCounter()}else{s.ajax({url:this.BXIM.pathToAjax+"?CHAT_LEAVE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{IM_CHAT_LEAVE:"Y",CHAT_ID:e,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(e){if(e.ERROR==""){this.readMessage("chat"+e.CHAT_ID,true,false);if(this.BXIM.messenger.chat[e.CHAT_ID].type!="open"||this.BXIM.messenger.users[this.BXIM.userId].extranet){delete this.BXIM.messenger.showMessage[e.CHAT_ID];delete this.BXIM.messenger.userInChat[e.CHAT_ID];delete this.BXIM.messenger.unreadMessage[e.CHAT_ID];delete this.BXIM.messenger.chat[e.CHAT_ID];if(this.BXIM.messenger.popupMessenger!=null){if(this.BXIM.messenger.currentTab=="chat"+e.CHAT_ID){this.BXIM.messenger.currentTab=0;this.BXIM.messenger.openChatFlag=false;this.BXIM.messenger.openCallFlag=false;this.BXIM.messenger.openLinesFlag=false;s.localStorage.set("mct",this.BXIM.messenger.currentTab,15);this.BXIM.messenger.extraClose()}}}else{for(var t=0;t<this.BXIM.messenger.userInChat[e.CHAT_ID].length;t++){if(this.BXIM.userId==parseInt(this.BXIM.messenger.userInChat[e.CHAT_ID][t])){delete this.BXIM.messenger.userInChat[e.CHAT_ID][t];break}}delete this.BXIM.messenger.unreadMessage[e.CHAT_ID];this.BXIM.messenger.dialogStatusRedraw()}this.recentListHide("chat"+e.CHAT_ID,false);this.userListRedraw();s.localStorage.set("mcl",e.CHAT_ID,5);this.BXIM.messenger.updateMessageCount();this.BXIM.updateCounter()}},this)})}};t.prototype.isSlider=function(){return location.href.toString().indexOf("SIDE_SLIDER")>0};t.prototype.closeSlider=function(){if(!this.isSlider()){return false}s.SidePanel.Instance.close();return true};t.prototype.dialogCloseCurrent=function(e){if(this.closeSlider()){return true}this.BXIM.messenger.currentTab=0;this.BXIM.messenger.openChatFlag=false;this.BXIM.messenger.openCallFlag=false;this.BXIM.messenger.openLinesFlag=false;this.BXIM.messenger.extraClose()};t.prototype.pullEvent=function(){if(typeof s.PULL==="undefined"){return false}var t=s.delegate(function(t,r,i){if(this.isMobile()){this.BXIM.checkRevision(i.revision_im_mobile)}else{this.BXIM.checkRevision(i.revision_im_web)}if(t=="generalChatId"){this.BXIM.messenger.generalChatId=r.id}else if(t=="updateSettings"){for(var a in r){this.BXIM.settings[a]=r[a]}}else if(t=="generalChatAccess"){if(this.BXIM.messenger.canSendMessageGeneralChat&&r.status=="blocked"){if(this.MobileActionEqual("DIALOG")){this.BXIM.messenger.canSendMessageGeneralChat=false;if(this.isMobile()){this.BXIM.messenger.dialogStatusRedrawDelay()}else{this.BXIM.messenger.redrawChatHeader({userRedraw:false})}}}else if(this.isMobile()&&this.MobileActionEqual("DIALOG")){console.log("NOTICE: Window reload, because CHANGE ALLOW OPTIONS for general chat");location.reload()}else if(this.isDesktop()){console.log("NOTICE: Window reload, because CHANGE ALLOW OPTIONS for general chat");location.reload()}}else if(t=="desktopOffline"){this.BXIM.desktopStatus=false}else if(t=="desktopOnline"){this.BXIM.desktopStatus=true}else if(t=="readMessage"){if(this.MobileActionNotEqual("RECENT","DIALOG"))return false;this.readMessage(r.userId,false,false,true)}else if(t=="readMessageChat"){if(this.MobileActionNotEqual("RECENT","DIALOG"))return false;this.readMessage("chat"+r.chatId,false,false,true)}else if(t=="readMessageChatOpponent"){if(this.MobileActionNotEqual("RECENT","DIALOG"))return false;if(!this.BXIM.messenger.readedList["chat"+r.chatId]){this.BXIM.messenger.readedList["chat"+r.chatId]={}}this.BXIM.messenger.readedList["chat"+r.chatId][r.userId]={messageId:r.lastId,date:new Date(r.date)};this.drawReadMessageChat("chat"+r.chatId)}else if(t=="readMessageOpponent"){if(this.MobileActionNotEqual("RECENT","DIALOG"))return false;this.drawReadMessage(r.userId,r.lastId,new Date(r.date));if(typeof this.BXIM.messenger.users[r.userId]!="undefined"){this.BXIM.messenger.users[r.userId].idle=false;this.BXIM.messenger.users[r.userId].last_activity_date=new Date;if(this.BXIM.messenger.currentTab.toString()==r.userId.toString()){var n=s.MessengerCommon.getUserLastDate(this.BXIM.messenger.users[r.userId]);if(this.isMobile()){BXMobileApp.UI.Page.TopBar.title.setDetailText(n)}else if(this.BXIM.messenger.popupMessengerPanelLastDate){this.BXIM.messenger.popupMessengerPanelLastDate.innerHTML=n?". "+n:""}}}if(typeof this.BXIM.messenger.users[r.userId]!="undefined"){this.BXIM.messenger.users[r.userId].idle=false;this.BXIM.messenger.users[r.userId].last_activity_date=new Date;if(this.BXIM.messenger.currentTab.toString()==r.userId.toString()){var n=s.MessengerCommon.getUserLastDate(this.BXIM.messenger.users[r.userId]);if(this.isMobile()){BXMobileApp.UI.Page.TopBar.title.setDetailText(n)}else if(this.BXIM.messenger.popupMessengerPanelLastDate){this.BXIM.messenger.popupMessengerPanelLastDate.innerHTML=n?". "+n:""}}}}else if(t=="unreadMessageOpponent"){if(this.MobileActionNotEqual("RECENT","DIALOG"))return false;var o=this.BXIM.messenger.popupMessengerBodyWrap.lastChild;if(o&&s.hasClass(o,"bx-messenger-content-item-notify")){if(r.userId==this.BXIM.messenger.currentTab||!this.countWriting(this.BXIM.messenger.currentTab)){s.remove(o)}}if(typeof this.BXIM.messenger.users[r.userId]!="undefined"){this.BXIM.messenger.users[r.userId].idle=false;this.BXIM.messenger.users[r.userId].last_activity_date=new Date;if(this.BXIM.messenger.currentTab.toString()==r.userId.toString()){var n=s.MessengerCommon.getUserLastDate(this.BXIM.messenger.users[r.userId]);if(this.isMobile()){BXMobileApp.UI.Page.TopBar.title.setDetailText(n)}else if(this.BXIM.messenger.popupMessengerPanelLastDate){this.BXIM.messenger.popupMessengerPanelLastDate.innerHTML=n?". "+n:""}}}}else if(t=="unreadMessageChatOpponent"){if(this.MobileActionNotEqual("RECENT","DIALOG"))return false;if(!this.BXIM.messenger.readedList["chat"+r.chatId]){this.BXIM.messenger.readedList["chat"+r.chatId]={}}delete this.BXIM.messenger.readedList["chat"+r.chatId][r.userId];this.drawReadMessageChat("chat"+r.chatId);if(typeof this.BXIM.messenger.users[r.userId]!="undefined"){this.BXIM.messenger.users[r.userId].idle=false;this.BXIM.messenger.users[r.userId].last_activity_date=new Date;if(this.BXIM.messenger.currentTab.toString()==r.userId.toString()){var n=s.MessengerCommon.getUserLastDate(this.BXIM.messenger.users[r.userId]);if(this.isMobile()){BXMobileApp.UI.Page.TopBar.title.setDetailText(n)}else if(this.BXIM.messenger.popupMessengerPanelLastDate){this.BXIM.messenger.popupMessengerPanelLastDate.innerHTML=n?". "+n:""}}}}else if(t=="startWriting"){if(this.MobileActionNotEqual("RECENT","DIALOG"))return false;if(this.isBot(r.userId)&&!r.DEFERRED&&this.BXIM.messenger.showMessage[r.dialogId]&&this.BXIM.messenger.showMessage[r.dialogId].length){var l=this.BXIM.messenger.bot[r.userId];if(l.type=="human"){var m=s.clone({command:t,params:r,extra:i});setTimeout(s.delegate(function(){m.params.DEFERRED=true;if(this.isMobile()){s.onCustomEvent(e,"onPull-im",[m])}else{s.onCustomEvent(e,"onPullEvent-im",[m.command,m.params,m.extra])}},this),1e3);return false}}if(typeof this.BXIM.messenger.users[r.userId]!="undefined"){this.BXIM.messenger.users[r.userId].idle=false;this.BXIM.messenger.users[r.userId].last_activity_date=new Date;if(this.BXIM.messenger.currentTab.toString()==r.userId.toString()){var n=s.MessengerCommon.getUserLastDate(this.BXIM.messenger.users[r.userId]);if(this.isMobile()){BXMobileApp.UI.Page.TopBar.title.setDetailText(n)}else if(this.BXIM.messenger.popupMessengerPanelLastDate){this.BXIM.messenger.popupMessengerPanelLastDate.innerHTML=n?". "+n:""}}}this.startWriting(r.userId,r.dialogId,r.userName)}else if(t=="addBot"||t=="updateBot"){if(this.BXIM.userExtranet)return false;this.BXIM.messenger.bot[r.bot.id]=r.bot;r.user.last_activity_date=new Date(r.user.last_activity_date);r.user.mobile_last_date=new Date(r.user.mobile_last_date);r.user.idle=r.user.idle?new Date(r.user.idle):false;r.user.absent=r.user.absent?new Date(r.user.absent):false;this.BXIM.messenger.users[r.user.id]=r.user;if(typeof r.userInGroup!="undefined"){for(var a in r.userInGroup){if(typeof this.BXIM.messenger.userInGroup[a]=="undefined"||typeof this.BXIM.messenger.userInGroup[a].users=="undefined"||!this.BXIM.messenger.userInGroup[a].users.length){this.BXIM.messenger.userInGroup[a]=r.userInGroup[a]}else{for(var h=0;h<r.userInGroup[a].users.length;h++)this.BXIM.messenger.userInGroup[a].users.push(r.userInGroup[a].users[h]);this.BXIM.messenger.userInGroup[a].users=s.util.array_unique(this.BXIM.messenger.userInGroup[a].users)}}}}else if(t=="updateUser"){r.user.last_activity_date=new Date(r.user.last_activity_date);r.user.mobile_last_date=new Date(r.user.mobile_last_date);r.user.idle=r.user.idle?new Date(r.user.idle):false;r.user.absent=r.user.absent?new Date(r.user.absent):false;this.BXIM.messenger.users[r.user.id]=r.user;this.BXIM.messenger.redrawChatHeader()}else if(t=="deleteBot"){if(this.BXIM.messenger.bot[r.botId]){delete this.BXIM.messenger.bot[r.botId]}if(this.BXIM.messenger.users[r.botId]){delete this.BXIM.messenger.users[r.botId]}this.recentListHide(r.botId,false);if(this.BXIM.messenger.currentTab==r.botId){this.BXIM.messenger.openMessenger("general")}}else if(t=="chatMuteNotify"){this.muteMessageChat(r.dialogId,r.mute,false)}else if(t=="message"||t=="messageChat"){if(this.MobileActionNotEqual("RECENT","DIALOG"))return false;if(!r.deferred&&this.BXIM.ppStatus&&!this.BXIM.ppServerStatus&&this.BXIM.lastRecordId>=r.message.id){return false}if(r.message.senderId!=this.BXIM.userId){s.onCustomEvent("onImMessageReceive",[{command:t,params:r}])}var g=r.message.senderId;if(r.message.recipientId.toString().substr(0,4)=="chat"){g=r.message.recipientId}if(this.sendBotCommandBlock[r.message.senderId]){for(var p in this.sendBotCommandBlock[r.message.senderId]){delete this.sendBotCommandBlock[r.message.senderId][p];var I=s("im-message-keyboard-"+p);if(I){var d=s.findChildrenByClassName(I,"bx-messenger-keyboard-button-block",false);for(var a=0;a<d.length;a++){s.removeClass(d[a],"bx-messenger-keyboard-button-progress");s.removeClass(d[a],"bx-messenger-keyboard-button-block")}}}}if(this.isBot(r.message.senderId)&&!r.deferred&&this.BXIM.messenger.showMessage[g]&&this.BXIM.messenger.showMessage[g].length){var l=this.BXIM.messenger.bot[r.message.senderId];if(l.type=="human"){if(r.chat[g]&&r.chat[g].entity_type=="LINES"){c=1e3}else{var c=r.message.text.split(" ").length*300+1e3;if(c>5e3){c=5e3}}var m=s.clone({command:t,params:r,extra:i,waitTime:c});setTimeout(s.delegate(function(){m.params.deferred=true;if(this.isMobile()){s.onCustomEvent(e,"onPull-im",[m])}else{s.onCustomEvent(e,"onPullEvent-im",[m.command,m.params,m.extra])}},this),c);return false}}if(r.chatId&&this.BXIM.messenger.linesWritingList[r.chatId]){var M=this.BXIM.messenger.linesWritingList[r.chatId].id;var u=s.findChildByClassName(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-content-item-id-"+M);if(u){s.remove(u);delete this.BXIM.messenger.linesWritingList[r.chatId]}}var f={};f.MESSAGE={};f.USERS_MESSAGE={};r.message.date=new Date(r.message.date);for(var a in r.chat){r.chat[a].date_create=new Date(r.chat[a].date_create);this.BXIM.messenger.chat[a]=r.chat[a]}for(var a in r.userInChat){this.BXIM.messenger.userInChat[a]=r.userInChat[a]}for(var a in r.userBlockChat){this.BXIM.messenger.userChatBlockStatus[a]=r.userBlockChat[a]}var B={};for(var a in r.users){if(this.BXIM.messenger.users[a]&&this.BXIM.messenger.users[a].status!=r.users[a].status&&Math.round(r.message.date.getTime()/1e3)+180>Math.round(new Date/1e3)){B[a]=this.BXIM.messenger.users[a].status;this.BXIM.messenger.users[a].status=r.users[a].status}}if(this.MobileActionEqual("RECENT")){for(var a in B){if(!this.BXIM.messenger.users[a])continue;var X=s.findChildrenByClassName(this.BXIM.messenger.recentListExternal,"bx-messenger-cl-id-"+a);if(X!=null){for(var h=0;h<X.length;h++){var b=s.MessengerCommon.getUserStatus(this.BXIM.messenger.users[a]);s.removeClass(X[h],"bx-messenger-cl-status-"+B[a]);s.addClass(X[h],"bx-messenger-cl-status-"+b);X[h].setAttribute("data-status",b)}}var X=s.findChildrenByClassName(this.BXIM.messenger.popupContactListElementsWrap,"bx-messenger-cl-id-"+a);if(X!=null){for(var h=0;h<X.length;h++){var b=s.MessengerCommon.getUserStatus(this.BXIM.messenger.users[a]);s.removeClass(X[h],"bx-messenger-cl-status-"+B[a]);s.addClass(X[h],"bx-messenger-cl-status-"+b);X[h].setAttribute("data-status",b)}}}}X=null;f.USERS=r.users;if(this.MobileActionEqual("DIALOG")){for(var a in r.files){if(!this.BXIM.disk.files[r.chatId])this.BXIM.disk.files[r.chatId]={};if(this.BXIM.disk.files[r.chatId][a])continue;r.files[a].date=new Date(r.files[a].date);this.BXIM.disk.files[r.chatId][a]=r.files[a]}}if(r.message.templateFileId&&r.message.templateId&&r.chatId&&this.BXIM.messenger.message[r.message.templateId]){this.clearProgessMessage(r.message.templateId);if(s("im-message-"+r.message.templateId)){s("im-message-"+r.message.templateId).id="im-message-"+r.message.id;var E=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-messageid":""+r.message.templateId}},true);if(E){E.setAttribute("data-messageid",""+r.message.id+"");if(E.getAttribute("data-blockmessageid")==""+r.message.templateId){E.setAttribute("data-blockmessageid",""+r.message.id+"")}s.removeClass(E,"bx-messenger-content-item-id-"+r.message.templateId);s.addClass(E,"bx-messenger-content-item-id-"+r.message.id);s.removeClass(E,"bx-messenger-content-item-content-progress")}else{var C=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-blockmessageid":""+r.message.templateId}},true);if(C){C.setAttribute("data-blockmessageid",""+r.message.id+"")}}}this.BXIM.messenger.message[r.message.templateId]=r.message;this.BXIM.messenger.message[r.message.id]=r.message;this.BXIM.messenger.showMessage[r.dialogId].push(r.message.id.toString());delete this.BXIM.messenger.message[r.message.templateId];this.BXIM.disk.files[r.chatId][r.message.templateFileId]=r.files[r.message.params.FILE_ID[0]];this.diskRedrawFile(r.chatId,r.message.templateFileId);return}else{f.MESSAGE[r.message.id]=r.message}this.BXIM.lastRecordId=parseInt(r.message.id)>this.BXIM.lastRecordId?parseInt(r.message.id):this.BXIM.lastRecordId;var _=r.message.text;if(!_||_.length<=0){if(r.message.params&&r.message.params.FILE_ID&&r.message.params.FILE_ID.length>0){_="["+s.message("IM_F_FILE")+"]"}else if(r.message.params&&r.message.params.ATTACH&&r.message.params.ATTACH.length>0){_="["+s.message("IM_F_ATTACH")+"]"}else{_=s.message("IM_M_DELETED")}}if(r.message.senderId==this.BXIM.userId){if(this.BXIM.messenger.sendMessageFlag>0&&r.message.system!="Y"||this.BXIM.messenger.message[r.message.id]){return}if(this.isMobile()){if(r.message.params["FILE_ID"]&&r.message.params["FILE_ID"].length>0){var S=false;r.message.params["FILE_ID"].forEach(function(e){if(this.BXIM.disk.messageBlock[e]){delete this.BXIM.disk.messageBlock[e];S=true}}.bind(this));if(S){return}}}this.readMessage(r.message.recipientId,false,false);f.USERS_MESSAGE[r.message.recipientId]=[r.message.id];this.updateStateVar(f);s.MessengerCommon.recentListAdd({userId:r.message.recipientId,id:r.message.id,date:r.message.date,recipientId:r.message.recipientId,senderId:r.message.system=="Y"?0:r.message.senderId,text:_,userIsChat:t=="messageChat",params:r.message.params},true)}else{f.UNREAD_MESSAGE={};if(typeof r.message.params.NOTIFY==="undefined"||r.message.params.NOTIFY==="Y"||r.message.params.NOTIFY.indexOf(parseInt(this.BXIM.userId))>-1){f.UNREAD_MESSAGE[t=="messageChat"?r.message.recipientId:r.message.senderId]=[r.message.id]}f.USERS_MESSAGE[t=="messageChat"?r.message.recipientId:r.message.senderId]=[r.message.id];if(t=="message")this.endWriting(r.message.senderId,0,false);else this.endWriting(r.message.senderId,r.message.recipientId,false);if(t=="messageChat"&&!s.MessengerCommon.userInChat(r.message.chatId)){if(this.isMobile()){var T=this.BXIM.currentTab.toString().substr(0,4)==="chat"&&this.BXIM.messenger.chat[this.BXIM.currentTab.substr(4)]&&this.BXIM.messenger.chat[this.BXIM.currentTab.substr(4)].type==="lines";if(T){s.MessengerCommon.hideLinesKeyboard()}}this.updateStateVar(f);return}else{this.updateStateVar(f);var v=r.notify!==true&&r.notify.indexOf(parseInt(this.BXIM.userId))==-1?this.inRecentList(t=="messageChat"?r.message.recipientId:r.message.senderId):true;if(v){this.recentListAdd({userId:t=="messageChat"?r.message.recipientId:r.message.senderId,id:r.message.id,date:r.message.date,recipientId:r.message.recipientId,senderId:r.message.senderId,text:_,userIsChat:t=="messageChat",params:r.message.params},true)}}}s.localStorage.set("mfm",this.BXIM.messenger.flashMessage,80)}else if(t=="messageDeleteComplete"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;if(!this.BXIM.messenger.message[r.id])return false;var g=0;if(r.type=="private"){g=r.fromUserId==this.BXIM.userId&&r.toUserId?r.toUserId:r.fromUserId;this.endWriting(g,0,false)}else{g="chat"+r.chatId;this.endWriting(r.senderId,g,false)}if(this.BXIM.messenger.currentTab==g&&s("im-message-"+r.id)){var y=s("im-message-"+r.id).parentNode.parentNode.parentNode.parentNode.parentNode;if(y.getAttribute("data-messageId")==y.getAttribute("data-blockMessageId")){s.remove(y)}else{y=s("im-message-"+r.id).parentNode;if(y.nextSibling&&s.hasClass(y.nextSibling,"bx-messenger-hr")){s.remove(y.nextSibling)}else if(!y.nextSibling&&s.hasClass(y.previousSibling,"bx-messenger-hr")){s.remove(y.previousSibling)}s.remove(y)}}this.recentListElementUpdate(g,r.id,r.text);if(this.BXIM.messenger.recentList||this.BXIM.messenger.recentListExternal)this.recentListRedraw();delete this.BXIM.messenger.message[r.id];this.BXIM.messenger.showMessage[g].sort(s.delegate(function(e,s){if(!this.BXIM.messenger.message[e]||!this.BXIM.messenger.message[s]){return 0}var t=this.BXIM.messenger.message[e].date.getTime();var r=this.BXIM.messenger.message[s].date.getTime();if(t<r){return-1}else if(t>r){return 1}else{if(e<s){return-1}else if(e>s){return 1}else{return 0}}},this))}else if(t=="messageUpdate"||t=="messageDelete"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;for(var A in this.sendBotCommandBlock){if(this.sendBotCommandBlock[A][r.id]){delete this.sendBotCommandBlock[A][r.id];var I=s("im-message-keyboard-"+r.id);if(I){var d=s.findChildrenByClassName(I,"bx-messenger-keyboard-button-block",false);for(var a=0;a<d.length;a++){s.removeClass(d[a],"bx-messenger-keyboard-button-progress");s.removeClass(d[a],"bx-messenger-keyboard-button-block")}}}}if(this.BXIM.messenger.message[r.id]){if(!this.BXIM.messenger.message[r.id].params)this.BXIM.messenger.message[r.id].params={};var g=0;if(t=="messageDelete"){r.text=s.message("IM_M_DELETED");if(!this.BXIM.messenger.message[r.id].params){this.BXIM.messenger.message[r.id].params={}}this.BXIM.messenger.message[r.id].params.IS_DELETED="Y"}else if(t=="messageUpdate"){this.BXIM.messenger.message[r.id].params=r.params}this.BXIM.messenger.message[r.id].text=r.text;if(r.type=="private"){g=r.fromUserId==this.BXIM.userId&&r.toUserId?r.toUserId:r.fromUserId;this.endWriting(g,0,false)}else{g="chat"+r.chatId;this.endWriting(r.senderId,g,false)}this.recentListElementUpdate(g,r.id,r.text);if(this.BXIM.messenger.currentTab==g&&s("im-message-"+r.id)){var L=s("im-message-"+r.id);if(r.params&&r.params.IS_EDITED=="Y"){s.addClass(L.parentNode.parentNode.parentNode.parentNode,"bx-messenger-message-edited")}var N=false;if(t=="messageDelete"){s.addClass(L.parentNode,"bx-messenger-message-deleted");var x=s("im-message-keyboard-"+r.id);s.remove(x);s.removeClass(L.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-rich-link")}else if(t=="messageUpdate"){if(r.params){if(r.params.DATE_TEXT){var R=this.prepareText(this.BXIM.messenger.message[r.id].text,false,true,true);for(var a=0;a<r.params.DATE_TEXT.length;a++){R=R.split(r.params.DATE_TEXT[a]).join('<span class="bx-messenger-ajax bx-messenger-ajax-black" data-entity="date" data-messageId="'+r.id+'" data-ts="'+r.params.DATE_TS[a]+'">'+r.params.DATE_TEXT[a]+"</span>")}L.innerHTML=R;N=true}if(r.params.IS_EDITED=="Y"){s.removeClass(L.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-without-padding")}if(r.params.URL_ONLY=="Y"&&this.BXIM.settings.enableRichLink){s.addClass(L.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-rich-link")}else{s.removeClass(L.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-rich-link")}if(r.params.LARGE_FONT=="Y"&&this.BXIM.settings.enableBigSmile){s.addClass(L.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-large-font")}else{s.removeClass(L.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-large-font")}if(r.params.ATTACH){var D=s.MessengerCommon.drawAttach(r.id,this.BXIM.messenger.message[r.id].chatId,r.params.ATTACH);if(L.nextElementSibling&&s.hasClass(L.nextElementSibling,"bx-messenger-attach-box")){L.nextElementSibling.innerHTML="";if(D.length>0){s.adjust(L.nextElementSibling,{children:D})}}else if(D.length>0){D=s.create("div",{props:{className:"bx-messenger-attach-box"},children:D});if(L.nextElementSibling){L.parentNode.insertBefore(D,L.nextElementSibling)}else{L.parentNode.appendChild(D)}}}if(r.params.KEYBOARD){var I=s("im-message-keyboard-"+r.id);var w=s.MessengerCommon.drawKeyboard(this.BXIM.messenger.currentTab,r.id,r.params.KEYBOARD);if(I){I.innerHTML=w?w.innerHTML:""}}}else if(typeof r.params!="undefined"&&r.params==""){if(L.nextElementSibling&&s.hasClass(L.nextElementSibling,"bx-messenger-attach-box")){s.remove(L.nextElementSibling)}}}if(!N){L.innerHTML=s.MessengerCommon.prepareText(this.BXIM.messenger.message[r.id].text,false,true,true)}s.addClass(L,"bx-messenger-message-edited-anim");if(L.previousSibling&&s.hasClass(L.previousSibling,"bx-messenger-file-box")){s.addClass(L.previousSibling,"bx-messenger-file-box-with-message")}setTimeout(s.delegate(function(){s.removeClass(L,"bx-messenger-message-edited-anim")},this),1e3)}if(this.BXIM.messenger.recentList||this.BXIM.messenger.recentListExternal)this.recentListRedraw()}}else if(t=="messageParamsUpdate"){if(this.MobileActionNotEqual("DIALOG"))return false;if(!this.BXIM.messenger.message[r.id])return false;if(this.BXIM.messenger.message[r.id].params&&this.BXIM.messenger.message[r.id].params.IS_DELETED=="Y")return false;var O=typeof r.animation=="undefined"?null:r.animation;for(var A in this.sendBotCommandBlock){if(this.sendBotCommandBlock[A][r.id]){delete this.sendBotCommandBlock[A][r.id];var I=s("im-message-keyboard-"+r.id);if(I){var d=s.findChildrenByClassName(I,"bx-messenger-keyboard-button-block",false);for(var a=0;a<d.length;a++){s.removeClass(d[a],"bx-messenger-keyboard-button-progress");s.removeClass(d[a],"bx-messenger-keyboard-button-block")}}}}this.BXIM.messenger.message[r.id].params=r.params;if(r.type=="private"){g=r.fromUserId==this.BXIM.userId?r.toUserId:r.fromUserId}else{g="chat"+r.chatId}var L=s("im-message-"+r.id);if(this.BXIM.messenger.currentTab==g&&L){var k=L.parentNode.parentNode.parentNode.parentNode.parentNode;if(r.params){if(r.params.DATE_TEXT){var R=this.prepareText(this.BXIM.messenger.message[r.id].text,false,true,true);for(var a=0;a<r.params.DATE_TEXT.length;a++){R=R.split(r.params.DATE_TEXT[a]).join('<span class="bx-messenger-ajax bx-messenger-ajax-black" data-entity="date" data-messageId="'+r.id+'" data-ts="'+r.params.DATE_TS[a]+'">'+r.params.DATE_TEXT[a]+"</span>")}L.innerHTML=R}if(r.params.FILE_ID){var P=s.MessengerCommon.diskDrawFiles(this.BXIM.messenger.message[r.id].chatId,r.params.FILE_ID);if(L.previousElementSibling&&s.hasClass(L.previousElementSibling,"bx-messenger-file-box")){L.previousElementSibling.innerHTML="";if(P.length>0){s.adjust(L.previousElementSibling,{children:P})}}else if(P.length>0){P=s.create("div",{props:{className:"bx-messenger-file-box"+(r.text!=""?" bx-messenger-file-box-with-message":"")},children:P});if(L.previousElementSibling){L.parentNode.insertBefore(P,L.previousElementSibling)}else{L.parentNode.insertBefore(P,L)}}if(L.innerHTML!=""&&L.previousElementSibling&&s.hasClass(L.previousElementSibling,"bx-messenger-file-box")){s.addClass(L.previousElementSibling,"bx-messenger-file-box-with-message")}}if(r.params.ATTACH){var D=s.MessengerCommon.drawAttach(r.id,this.BXIM.messenger.message[r.id].chatId,r.params.ATTACH);if(L.nextElementSibling&&s.hasClass(L.nextElementSibling,"bx-messenger-attach-box")){L.nextElementSibling.innerHTML="";if(D.length>0){s.adjust(L.nextElementSibling,{children:D})}}else if(D.length>0){D=s.create("div",{props:{className:"bx-messenger-attach-box"},children:D});if(L.nextElementSibling){L.parentNode.insertBefore(D,L.nextElementSibling)}else{L.parentNode.appendChild(D)}}if(O!="N"){O="Y"}}if(r.params.KEYBOARD){var I=s("im-message-keyboard-"+r.id);var w=s.MessengerCommon.drawKeyboard(this.BXIM.messenger.currentTab,r.id,r.params.KEYBOARD);if(I){I.innerHTML=w?w.innerHTML:""}if(O!="N"){O="Y"}}if(r.params.CHAT_USER||r.params.CHAT_ID||r.params.CHAT_MESSAGE||r.params.CHAT_LAST_DATE){var U=s("im-message-content-reply-"+r.id);var H=s.MessengerCommon.drawMessageReply(r.id);if(U){U.innerHTML=H?H.innerHTML:""}}if(r.params&&r.params.URL_ONLY=="Y"&&this.BXIM.settings.enableRichLink){s.addClass(L.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-rich-link")}else if(r.params&&r.params.URL_ONLY=="N"){s.removeClass(L.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-rich-link")}if(r.params&&r.params.LARGE_FONT=="Y"&&this.BXIM.settings.enableBigSmile){s.addClass(L.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-large-font")}else if(r.params&&r.params.LARGE_FONT=="N"){s.removeClass(L.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-large-font")}if(r.params&&r.params.IS_EDITED=="Y"){s.removeClass(L.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-without-padding");s.addClass(L.parentNode.parentNode.parentNode.parentNode,"bx-messenger-message-edited");if(O!="N"){O="Y"}}}else if(typeof r.params!="undefined"&&r.params==""){if(L.nextElementSibling&&s.hasClass(L.nextElementSibling,"bx-messenger-attach-box")){s.remove(L.nextElementSibling);if(O!="N"){O="Y"}}}if(r.params&&typeof r.params.CLASS!="undefined"){var G=s.findParent(L,{className:"bx-messenger-content-item"});s.addClass(G,r.params.CLASS)}if(r.params&&typeof r.params.MENU!="undefined"){var G=s.findParent(L,{className:"bx-messenger-content-item"});var F=s.findChildByClassName(G,"bx-messenger-content-item-menu");if(!r.params.MENU||r.params.MENU=="N"||r.params.MENU.length<=0){s.removeClass(F,"bx-messenger-content-item-menu-with-apps")}else{s.addClass(F,"bx-messenger-content-item-menu-with-apps")}}if(r.params&&r.params.IS_DELIVERED){if(r.params.IS_DELIVERED=="N"){this.drawProgessMessage(r.id)}else{this.clearProgessMessage(r.id)}}if(r.params&&r.params.SENDING){if(r.params.SENDING=="Y"){this.drawProgessMessage(r.id)}else{this.clearProgessMessage(r.id)}}if(r.params.IMOL_SID&&parseInt(r.params.IMOL_SID)>0){var j=s.findChildByClassName(k,"bx-messenger-message-extra");if(!j){k.insertBefore(s.create("div",{props:{className:"bx-messenger-message-extra"},html:s.message("IM_OL_DIALOG_NUMBER").replace("#NUMBER#",r.params.IMOL_SID)}),k.firstChild);if(this.isElementVisibleOnScreen(k,BXIM.messenger.popupMessengerBody)){this.linesBodyScroll()}}}if(r.params.IMOL_FORM&&this.BXIM.messenger.chat[r.chatId]&&this.BXIM.messenger.chat[r.chatId].type=="livechat"){var W=r.params.IMOL_FORM.toString().substr(-6)=="-delay";var V=W?r.params.IMOL_FORM.substr(0,r.params.IMOL_FORM.lastIndexOf("-delay")):r.params.IMOL_FORM;if(this.BXIM.messenger.popupMessengerLiveChatDelayedFormMid<r.id&&this.BXIM.messenger.popupMessengerLiveChatFormType!=V){this.BXIM.messenger.popupMessengerLiveChatDelayedFormMid=r.id;this.BXIM.messenger.linesLivechatFormHide();clearTimeout(this.BXIM.messenger.popupMessengerLiveChatActionTimeout);this.BXIM.messenger.popupMessengerLiveChatActionTimeout=setTimeout(s.delegate(function(){this.BXIM.messenger.linesLivechatFormShow(V)},this),W?3e4:5e3)}}if(r.params.IMOL_VOTE&&L){var Y=this.linesVoteDraw(r.id);if(Y){s.cleanNode(L);L.appendChild(Y)}if(O!="N"){O="Y"}}else if(typeof r.params.IMOL_VOTE_SID!="undefined"&&L){var _=s.findChildByClassName(L,"bx-messenger-content-item-vote-message-text");if(_){var Y=this.linesVoteResultDraw(r.id,_.innerHTML);if(Y){s.cleanNode(L);L.appendChild(Y)}}}if(O=="Y"){s.addClass(L,"bx-messenger-message-edited-anim");setTimeout(s.delegate(function(){s.removeClass(L,"bx-messenger-message-edited-anim")},this),1e3)}}}else if(t=="messageLike"){if(this.MobileActionNotEqual("DIALOG"))return false;var K=s.util.in_array(this.BXIM.userId,r.users);var q=r.users.length>0?r.users.length:"";if(!this.BXIM.messenger.message[r.id]){return false}if(typeof this.BXIM.messenger.message[r.id].params!="object"){this.BXIM.messenger.message[r.id].params={}}this.BXIM.messenger.message[r.id].params.LIKE=r.users;if(s("im-message-"+r.id)){var E=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-blockmessageid":""+r.id+""}},false);if(E){var J=s.findChildByClassName(E,"bx-messenger-content-item-like");if(J){var Q=s.findChildByClassName(J,"bx-messenger-content-like-digit",false);var $=s.findChildByClassName(J,"bx-messenger-content-like-button",false);if(K){s.addClass(J,"bx-messenger-content-item-liked")}else{s.removeClass(J,"bx-messenger-content-item-liked")}if(q>0){Q.setAttribute("title",s.message("IM_MESSAGE_LIKE_LIST"));s.removeClass(Q.parentNode,"bx-messenger-content-like-digit-off")}else{Q.setAttribute("title","");s.addClass(Q.parentNode,"bx-messenger-content-like-digit-off")}if(Q.innerHTML<q){var z=s.findChildByClassName(E,"bx-messenger-content-item-content",false);s.addClass(z,"bx-messenger-content-item-plus-like");setTimeout(function(){s.removeClass(z,"bx-messenger-content-item-plus-like")},500)}Q.innerHTML=q}}}}else if(t=="promotionRead"){s.MessengerPromo.read(r.id)}else if(t=="fileUpload"){if(this.MobileActionNotEqual("DIALOG"))return false;if(this.BXIM.disk.filesProgress[r.fileTmpId])return false;r.fileParams.date=new Date(r.fileParams.date);if(this.BXIM.disk.files[r.fileChatId]&&this.BXIM.disk.files[r.fileChatId][r.fileId]){r.fileParams["preview"]=this.BXIM.disk.files[r.fileChatId][r.fileId]["preview"]}if(!this.BXIM.disk.files[r.fileChatId])this.BXIM.disk.files[r.fileChatId]={};this.BXIM.disk.files[r.fileChatId][r.fileId]=r.fileParams;this.diskRedrawFile(r.fileChatId,r.fileId);if(this.BXIM.messenger.popupMessengerBody&&s.MessengerCommon.enableScroll(this.BXIM.messenger.popupMessengerBody,this.BXIM.messenger.popupMessengerBody.offsetHeight)){if(this.isMobile()&&document.body.offsetHeight<=e.innerHeight){this.BXIM.messenger.popupMessengerBody.scrollTop=0}else if(this.BXIM.animationSupport){if(this.BXIM.messenger.popupMessengerBodyAnimation!=null)this.BXIM.messenger.popupMessengerBodyAnimation.stop();(this.BXIM.messenger.popupMessengerBodyAnimation=new s.easing({duration:800,start:{scroll:this.BXIM.messenger.popupMessengerBody.scrollTop},finish:{scroll:this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)},transition:s.easing.makeEaseInOut(s.easing.transitions.quart),step:s.delegate(function(e){this.BXIM.messenger.popupMessengerBody.scrollTop=e.scroll},this)})).animate()}else if(this.BXIM.messenger.popupMessengerBody){this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)}}}else if(t=="fileUnRegister"){if(this.MobileActionNotEqual("DIALOG"))return false;for(var Z in r.files){if(this.BXIM.disk.filesRegister[r.chatId]){delete this.BXIM.disk.filesRegister[r.chatId][r.files[Z]]}if(this.BXIM.disk.files[r.chatId]&&this.BXIM.disk.files[r.chatId][r.files[Z]]){this.BXIM.disk.files[r.chatId][r.files[Z]].status="error";s.MessengerCommon.diskRedrawFile(r.chatId,r.files[Z])}delete this.BXIM.disk.filesProgress[Z]}this.drawTab(this.getRecipientByChatId(r.chatId))}else if(t=="fileDelete"){if(this.MobileActionNotEqual("DIALOG"))return false;delete this.BXIM.disk.files[r.chatId][r.fileId];this.drawTab(this.getRecipientByChatId(r.chatId))}else if(t=="chatRename"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;if(this.BXIM.messenger.chat[r.chatId]){this.BXIM.messenger.chat[r.chatId].name=s.util.htmlspecialchars(r.name);this.BXIM.messenger.redrawChatHeader()}}else if(t=="chatAvatar"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;this.BXIM.messenger.updateChatAvatar(r.chatId,r.avatar)}else if(t=="chatChangeColor"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;if(this.BXIM.messenger.chat[r.chatId]){this.BXIM.messenger.chat[r.chatId].color=r.color;this.BXIM.messenger.redrawChatHeader()}}else if(t=="chatHide"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;this.recentListHide(r.dialogId,false);if(!this.isMobile()&&r.dialogId==this.currentTab){s.MessengerCommon.dialogCloseCurrent()}}else if(t=="chatShow"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;if(s.type.isPlainObject(r.chat)){for(a in r.chat){r.chat[a].date_create=new Date(r.chat[a].date_create);this.BXIM.messenger.chat[a]=r.chat[a];this.BXIM.messenger.unreadMessage["chat"+a]=[r.message.id]}}if(s.type.isPlainObject(r.userInChat)){for(a in r.userInChat){this.BXIM.messenger.userInChat[a]=r.userInChat[a]}}var ee={};ee.MESSAGE={};ee.USERS_MESSAGE={};ee.UNREAD_MESSAGE={};ee.USERS=r.users;ee.MESSAGE[r.message.id]=r.message;ee.UNREAD_MESSAGE[r.message.recipientId]=[r.message.id];this.updateStateVar(ee);s.MessengerCommon.recentListAdd({senderId:r.message.system=="Y"?0:r.message.senderId,userIsChat:true,userId:r.message.recipientId,id:r.message.id,date:new Date(r.message.date),recipientId:r.message.recipientId,text:r.message.text,params:r.message.params,skipDateCheck:true,userInChat:true},true)}else if(t=="chatPin"){if(this.MobileActionNotEqual("RECENT"))return false;this.recentListElementPin(r.dialogId,r.active)}else if(t=="chatUserAdd"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;for(var a in r.users){r.users[a].last_activity_date=new Date(r.users[a].last_activity_date);r.users[a].mobile_last_date=new Date(r.users[a].mobile_last_date);r.users[a].idle=r.users[a].idle?new Date(r.users[a].idle):false;r.users[a].absent=r.users[a].absent?new Date(r.users[a].absent):false;this.BXIM.messenger.users[a]=r.users[a]}if(!this.BXIM.messenger.chat[r.chatId]){this.BXIM.messenger.chat[r.chatId]={id:r.chatId,name:r.chatId,owner:r.chatOwner,extranet:r.chatExtranet,fake:true,date_create:""}}else{this.BXIM.messenger.chat[r.chatId].extranet=r.chatExtranet;if(this.BXIM.messenger.userInChat[r.chatId]){for(a=0;a<r.newUsers.length;a++)this.BXIM.messenger.userInChat[r.chatId].push(r.newUsers[a])}else this.BXIM.messenger.userInChat[r.chatId]=r.newUsers;this.BXIM.messenger.redrawChatHeader()}}else if(t=="chatOwner"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;if(!this.BXIM.messenger.chat[r.chatId])return false;this.BXIM.messenger.chat[r.chatId].owner=r.userId;if(!this.isMobile()&&this.BXIM.messenger.currentTab=="chat"+r.chatId){this.BXIM.messenger.redrawChatHeader()}}else if(t=="chatUserLeave"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;if(r.userId==this.BXIM.userId){this.readMessage("chat"+r.chatId,true,false,true);this.leaveFromChat(r.chatId,false);if(this.BXIM.callController.hasActiveCall()&&this.BXIM.callController.currentCall.associatedEntity.id=="chat"+r.chatId){this.BXIM.callController.currentCall.hangup()}if(r.message.length>0){this.BXIM.openConfirm({title:s.util.htmlspecialchars(r.chatTitle),message:r.message})}}else if(this.MobileActionEqual("DIALOG")){if(!this.BXIM.messenger.chat[r.chatId]||!this.BXIM.messenger.userInChat[r.chatId])return false;var se=[];for(var a=0;a<this.BXIM.messenger.userInChat[r.chatId].length;a++)if(this.BXIM.messenger.userInChat[r.chatId][a]!=r.userId)se.push(this.BXIM.messenger.userInChat[r.chatId][a]);this.BXIM.messenger.userInChat[r.chatId]=se;this.BXIM.messenger.redrawChatHeader()}}else if(t=="deleteNotifies"){if(this.MobileActionNotEqual("NOTIFY"))return false;if(this.BXIM.notify.skipMassDelete){return true}for(var a in r.id){if(r.id[a]>0){delete this.BXIM.notify.notify[a];delete this.BXIM.notify.flashNotify[a];delete this.BXIM.notify.unreadNotify[a]}}this.BXIM.notify.updateNotifyCount(false);if(this.BXIM.messenger.popupMessenger!=null&&this.BXIM.notifyOpen)this.BXIM.notify.openNotify(true)}else if(t=="notify"){if(this.MobileActionNotEqual("NOTIFY"))return false;r.date=new Date(r.date);var f={};f.UNREAD_NOTIFY={};f.UNREAD_NOTIFY[r.id]=[r.id];this.BXIM.messenger.notify.notify[r.id]=r;if(this.BXIM.ppStatus&&!this.BXIM.ppServerStatus&&this.BXIM.lastRecordId>=r.message.id){this.BXIM.messenger.notify.flashNotify[r.id]=false}else{this.BXIM.messenger.notify.flashNotify[r.id]=r.silent!="Y"}if(r.settingName=="im|like"&&r.originalTag.substr(0,10)=="RATING|IM|"){var te=r.originalTag.split("|");if(this.BXIM.messenger.message[te[4]]&&this.BXIM.messenger.message[te[4]].recipientId==this.BXIM.messenger.currentTab&&this.BXIM.windowFocus){delete f.UNREAD_NOTIFY[r.id];this.BXIM.notify.flashNotify[r.id]=false;this.BXIM.notify.viewNotify(r.id)}}if(r.silent=="N")this.BXIM.notify.changeUnreadNotify(f.UNREAD_NOTIFY);s.localStorage.set("mfn",this.BXIM.notify.flashNotify,80);this.BXIM.lastRecordId=parseInt(r.id)>this.BXIM.lastRecordId?parseInt(r.id):this.BXIM.lastRecordId}else if(t=="readNotifyList"){if(this.MobileActionNotEqual("NOTIFY"))return false;this.BXIM.notify.initNotifyCount=r.counter;r.list.forEach(function(e){delete this.BXIM.notify.unreadNotify[e]}.bind(this));this.BXIM.notify.viewNotifyMarkupUpdate();this.BXIM.notify.updateNotifyCount(false)}else if(t=="massReadNotify"){if(this.MobileActionNotEqual("NOTIFY"))return false;if(!s.type.isArray(r.idList))return false;var re=r.idList;this.BXIM.notify.initNotifyCount=0;for(var a in this.BXIM.notify.unreadNotify){var ie=this.BXIM.notify.notify[this.BXIM.notify.unreadNotify[a]];if(ie&&ie.type!=1&&re.indexOf(ie.id)>=0){delete this.BXIM.notify.unreadNotify[a]}}this.BXIM.notify.updateNotifyCount(false)}else if(t=="confirmNotify"){if(this.MobileActionNotEqual("NOTIFY"))return false;var ae=parseInt(r.id);if(this.BXIM.notify.notify[ae]){if(this.isMobile()){delete this.BXIM.notify.notify[ae]}else{this.BXIM.notify.notify[ae].confirmMessages=r.confirmMessages}}delete this.BXIM.notify.unreadNotify[ae];delete this.BXIM.notify.flashNotify[ae];this.BXIM.notify.updateNotifyCount(false);if(this.BXIM.messenger.popupMessenger!=null&&this.BXIM.notifyOpen)this.BXIM.notify.openNotify(true)}else if(t=="readNotifyOne"){if(this.MobileActionNotEqual("NOTIFY"))return false;if(this.BXIM.notify.unreadNotify[r.id]){this.BXIM.notify.viewNotify(r.id,true,false)}}else if(t=="unreadNotifyList"){if(this.MobileActionNotEqual("NOTIFY"))return false;r.list.forEach(function(e){this.BXIM.notify.viewNotify(e,false,false)}.bind(this))}else if(t=="deleteCommand"){if(this.MobileActionNotEqual("DIALOG"))return false;for(var a=0;a<this.BXIM.messenger.command.length;a++){if(!this.BXIM.messenger.command[a]||this.BXIM.messenger.command[a].id!=r.commandId){continue}delete this.BXIM.messenger.command[a];if(this.commandPopup!=null){this.commandPopup.destroy()}break}}else if(t=="deleteAppIcon"){if(this.MobileActionNotEqual("DIALOG"))return false;for(var a=0;a<this.BXIM.messenger.textareaIcon.length;a++){if(!this.BXIM.messenger.textareaIcon[a]||this.BXIM.messenger.textareaIcon[a].id!=r.iconId){continue}delete this.BXIM.messenger.textareaIcon[a];if(this.popupSmileMenu!=null){this.popupSmileMenu.destroy()}var E=s.findChildByClassName(this.BXIM.messenger.popupMessengerTextareaIconBox,"bx-messenger-textarea-icon-marketplace-"+r.iconId,true);if(E){s.remove(E)}break}}else if(t=="updateAppIcon"){if(this.MobileActionNotEqual("DIALOG"))return false;for(var a=0;a<this.BXIM.messenger.textareaIcon.length;a++){if(!this.BXIM.messenger.textareaIcon[a]||this.BXIM.messenger.textareaIcon[a].id!=r.iconId){continue}if(r.context){this.BXIM.messenger.textareaIcon[a].context=r.context}if(r.js){this.BXIM.messenger.textareaIcon[a].js=r.js}if(r.iframe){this.BXIM.messenger.textareaIcon[a].iframe=r.iframe}if(r.iframeWidth){this.BXIM.messenger.textareaIcon[a].iframeWidth=r.iframeWidth}if(r.iframeHeight){this.BXIM.messenger.textareaIcon[a].iframeHeight=r.iframeHeight}if(r.userId!=this.BXIM.userId&&this.popupSmileMenu!=null){this.popupIframeMenu.destroy()}break}}else if(t=="chatUpdateParam"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;if(this.BXIM.messenger.chat[r.chatId]){if(r.name=="name"){r.value=s.util.htmlspecialchars(r.value)}this.BXIM.messenger.chat[r.chatId][r.name]=r.value;if(this.BXIM.messenger.currentTab.toString().substr(4)==r.chatId){this.BXIM.messenger.redrawChatHeader();if(this.isMobile()){this.BXIM.messenger.dialogStatusRedraw()}}if(this.BXIM.messenger.chat[r.chatId].type=="livechat"&&r.fieldName=="entity_data_1"){var ne=this.livechatGetSession(r.chatId);ne.readedTime=ne.readedTime?new Date(ne.readedTime):false;this.drawReadMessage("chat"+r.chatId,ne.readedId,ne.readedTime);if(ne.showForm=="N"){if(!this.BXIM.messenger.popupMessengerLiveChatLastSend||this.BXIM.messenger.popupMessengerLiveChatLastSend+1e3<+new Date){this.BXIM.messenger.linesLivechatFormHide()}}}if(this.MobileActionEqual("RECENT")&&(this.BXIM.messenger.recentList||this.BXIM.messenger.recentListExternal)){this.recentListRedraw()}}}},this);var r=s.delegate(function(e,t){if(this.isMobile()){t=e.params;e=e.command}if(e=="list"||e=="userStatus"){var r=false;var i=false;for(var a in t.users){if(typeof this.BXIM.messenger.users[a]=="undefined"){continue}if(!r&&this.BXIM.messenger.recentListIndex.indexOf(a.toString())>=0){var n=this.BXIM.messenger.users[a];var o=t.users[a];var l=n.idle?n.idle.getTime():0;var m=o.idle?new Date(o.idle).getTime():0;var h=n.mobile_last_date?n.mobile_last_date.getTime():0;var g=o.mobile_last_date?new Date(o.mobile_last_date).getTime():0;if(n.status!==o.status||l!==m||h!==g){r=true}}if(this.BXIM.messenger.currentTab.toString()==a.toString()){i=true}this.BXIM.messenger.users[a].status=t.users[a].status;this.BXIM.messenger.users[a].color=t.users[a].color;this.BXIM.messenger.users[a].idle=t.users[a].idle?new Date(t.users[a].idle):false;this.BXIM.messenger.users[a].mobile_last_date=new Date(t.users[a].mobile_last_date);this.BXIM.messenger.users[a].last_activity_date=new Date(t.users[a].last_activity_date)}if(r){s.MessengerCommon.userListRedraw()}if(i){this.BXIM.messenger.dialogStatusRedraw()}}},this);var i=s.delegate(function(e,s){if(this.isMobile()){s=e.params;e=e.command}if(e=="linesAnswer"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;if(!this.BXIM.messenger.chat[s.chatId])return false;this.BXIM.messenger.chat[s.chatId].owner=this.BXIM.userId;this.BXIM.messenger.redrawChatHeader();if(this.BXIM.messenger.popupMessengerTextarea){this.BXIM.messenger.popupMessengerTextarea.focus()}}else if(e=="queueItemUpdate"){if(typeof this.BXIM.messenger.openlines=="undefined"){this.BXIM.messenger.openlines.queue=[s]}else{var t=true;for(var r=0,i=this.BXIM.messenger.openlines.queue.length;r<i;r++){if(this.BXIM.messenger.openlines.queue[r].id==s.id){this.BXIM.messenger.openlines.queue[r].name=s.name;this.BXIM.messenger.openlines.queue[r].priority=s.priority;this.BXIM.messenger.openlines.queue[r].queue_type=s.queue_type;t=false;break}}if(t){this.BXIM.messenger.openlines.queue.push(s)}}}else if(e=="queueItemDelete"){if(typeof this.BXIM.messenger.openlines=="undefined"||this.BXIM.messenger.openlines.queue.length<=0)return true;var a=[];for(var r=0,i=this.BXIM.messenger.openlines.queue.length;r<i;r++){if(this.BXIM.messenger.openlines.queue[r].id!=s.id){a.push(this.BXIM.messenger.openlines.queue[r])}}this.BXIM.messenger.openlines.queue=a}},this);if(this.isMobile()){console.warn("MOBILE!");BXMobileApp.addCustomEvent("onPull-im",s.delegate(function(e){console.log(e);var s=e.data;if(typeof s=="undefined"){t(e["command"],e["params"],e["extra"])}else{for(var r=0;r<s.length;r++){t(s[r]["command"],s[r]["params"],s[r]["extra"])}}},this));BXMobileApp.addCustomEvent("onPullOnline",r);BXMobileApp.addCustomEvent("onPull-imopenlines",i)}else{s.addCustomEvent("onPullOnlineEvent",r);s.addCustomEvent("onPullEvent-im",t);s.addCustomEvent("onPullEvent-imopenlines",i)}s.PULL.subscribe({type:"client",moduleId:"imopenlines",command:"linesMessageWrite",callback:function(e,t){if(!this.BXIM.messenger.chat[e.operatorChatId]||!this.BXIM.messenger.chat[e.operatorChatId].entity_id){return}var r=this.BXIM.messenger.chat[e.operatorChatId].id;var i="chat"+r;var a=0;var n=s.MessengerCommon.linesGetSession(this.BXIM.messenger.chat[e.operatorChatId]);if(n){a=n.id}var o=this.BXIM.messenger.chat[e.operatorChatId].entity_id.toString().split("|");var l=0;var m=0;if(o[2]&&o[3]){l=o[2];m=o[3]}var h=s.md5(a+"/"+l+"/"+m);if(e.infoString===h){if(this.BXIM.messenger.linesWritingList[r]){this.BXIM.messenger.linesWritingList[r].text=e.text;var g=this.BXIM.messenger.linesWritingList[r].id;var p=s.findChildByClassName(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-content-item-id-"+g);if(p){if(e.text===""){clearTimeout(this.BXIM.messenger.linesWritingListTimeout[r]);s.remove(p);delete this.BXIM.messenger.linesWritingList[r];s.MessengerCommon.endWriting(m,i)}else{var I=s("im-message-"+g);I.innerText=e.text;clearTimeout(this.BXIM.messenger.linesWritingListTimeout[r]);this.BXIM.messenger.linesWritingListTimeout[r]=setTimeout(s.delegate(function(){s.remove(p);delete this.BXIM.messenger.linesWritingList[r];s.MessengerCommon.endWriting(m,i)},this),29500)}}}else{if(e.text===""){return}var d={id:"ol-writing-"+Date.now(),senderId:m,text:e.text,date:new Date,params:{CLASS:"bx-messenger-content-item-lines-writing"}};this.BXIM.messenger.linesWritingList[r]=d;if(i!==BXIM.messenger.currentTab){return}s.MessengerCommon.drawMessage(BXIM.messenger.currentTab,d);s.MessengerCommon.startWriting(m,i);var c=s.findChildByClassName(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-content-item-id-"+d.id);clearTimeout(this.BXIM.messenger.linesWritingListTimeout[r]);this.BXIM.messenger.linesWritingListTimeout[r]=setTimeout(s.delegate(function(){s.remove(c);delete this.BXIM.messenger.linesWritingList[r];s.MessengerCommon.endWriting(m,i)},this),29500)}}}})};t.prototype.updateStateVar=function(e,t,r){r=r!==false;if(typeof e.CHAT!="undefined"){for(var i in e.CHAT){e.CHAT[i].date_create=new Date(e.CHAT[i].date_create);this.BXIM.messenger.chat[i]=e.CHAT[i]}}if(typeof e.USER_IN_CHAT!="undefined"){for(var i in e.USER_IN_CHAT){this.BXIM.messenger.userInChat[i]=e.USER_IN_CHAT[i]}}if(typeof e.USER_BLOCK_CHAT!="undefined"){for(var i in e.USER_BLOCK_CHAT){this.BXIM.messenger.userChatBlockStatus[i]=e.USER_BLOCK_CHAT[i]}}if(typeof e.USERS!="undefined"){for(var i in e.USERS){e.USERS[i].last_activity_date=new Date(e.USERS[i].last_activity_date);e.USERS[i].mobile_last_date=new Date(e.USERS[i].mobile_last_date);e.USERS[i].idle=e.USERS[i].idle?new Date(e.USERS[i].idle):false;e.USERS[i].absent=e.USERS[i].absent?new Date(e.USERS[i].absent):false;this.BXIM.messenger.users[i]=e.USERS[i]}}if(typeof e.USER_IN_GROUP!="undefined"){for(var i in e.USER_IN_GROUP){if(typeof this.BXIM.messenger.userInGroup[i]=="undefined"||typeof this.BXIM.messenger.userInGroup[i].users=="undefined"||!this.BXIM.messenger.userInGroup[i].users.length){this.BXIM.messenger.userInGroup[i]=e.USER_IN_GROUP[i]}else{for(var a=0;a<e.USER_IN_GROUP[i].users.length;a++)this.BXIM.messenger.userInGroup[i].users.push(e.USER_IN_GROUP[i].users[a]);this.BXIM.messenger.userInGroup[i].users=s.util.array_unique(this.BXIM.messenger.userInGroup[i].users)}}}if(typeof e.UNREAD_MESSAGE==="undefined"){e.UNREAD_MESSAGE={}}if(typeof e.MESSAGE!="undefined"){for(var i in e.MESSAGE){if(e.MESSAGE[i].params.NOTIFY==="N"||typeof e.MESSAGE[i].params.NOTIFY==="object"&&e.MESSAGE[i].params.NOTIFY.indexOf(parseInt(this.BXIM.userId))<=-1){var n=e.MESSAGE[i].messageType==="P"?e.MESSAGE[i].senderId:e.MESSAGE[i].recipientId;if(e.UNREAD_MESSAGE[n]){e.UNREAD_MESSAGE[n]=e.UNREAD_MESSAGE[n].filter(function(s){return s!=e.MESSAGE[i].id})}}e.MESSAGE[i].date=new Date(e.MESSAGE[i].date);if(this.BXIM.messenger.message[i]&&this.BXIM.messenger.message[i].dropDuplicate){e.MESSAGE[i].dropDuplicate=true}this.BXIM.messenger.message[i]=e.MESSAGE[i];this.BXIM.lastRecordId=parseInt(i)>this.BXIM.lastRecordId?parseInt(i):this.BXIM.lastRecordId}}this.changeUnreadMessage(e.UNREAD_MESSAGE,t);if(typeof e.USERS_MESSAGE!="undefined"){for(var i in e.USERS_MESSAGE){e.USERS_MESSAGE[i].sort(s.delegate(function(e,s){e=parseInt(e);s=parseInt(s);if(!this.BXIM.messenger.message[e]||!this.BXIM.messenger.message[s]){return 0}var t=this.BXIM.messenger.message[e].date.getTime();var r=this.BXIM.messenger.message[s].date.getTime();if(t<r){return-1}else if(t>r){return 1}else{if(e<s){return-1}else if(e>s){return 1}else{return 0}}},this));for(var a=0;a<e.USERS_MESSAGE[i].length;a++){if(!e.USERS_MESSAGE[i][a])continue;e.USERS_MESSAGE[i][a]=e.USERS_MESSAGE[i][a].toString();if(this.BXIM.messenger.message[e.USERS_MESSAGE[i][a]].dropDuplicate||!this.BXIM.messenger.showMessage[i]||!s.util.in_array(e.USERS_MESSAGE[i][a],this.BXIM.messenger.showMessage[i])){if(!this.BXIM.messenger.showMessage[i]){this.BXIM.messenger.showMessage[i]=[]}this.BXIM.messenger.showMessage[i].push(e.USERS_MESSAGE[i][a]);if(this.BXIM.messenger.history[i])this.BXIM.messenger.history[i]=s.util.array_merge(this.BXIM.messenger.history[i],e.USERS_MESSAGE[i]);else this.BXIM.messenger.history[i]=e.USERS_MESSAGE[i];if(r&&this.BXIM.messenger.currentTab==i&&this.MobileActionEqual("DIALOG"))this.drawMessage(i,this.BXIM.messenger.message[e.USERS_MESSAGE[i][a]])}}}}};t.prototype.changeUnreadMessage=function(e,t){if(s.type.isArray(e)){return}t=t!=false;var r=false;var i=false;var a=true;var n=this.isMobile()?"online":this.BXIM.settings.status;for(var o in e){if(o.toString().substr(0,4)=="chat"){if(!s.MessengerCommon.userInChat(o.toString().substr(4))){continue}}var l=false;if(this.BXIM.xmppStatus&&o.toString().substr(0,4)!="chat"){if(!(this.BXIM.messenger.popupMessenger!=null&&this.BXIM.messenger.currentTab==o&&this.BXIM.isFocus())){i=true;if(this.BXIM.messenger.unreadMessage[o])this.BXIM.messenger.unreadMessage[o]=s.util.array_unique(s.util.array_merge(this.BXIM.messenger.unreadMessage[o],e[o]));else this.BXIM.messenger.unreadMessage[o]=e[o]}l=true}if(!l){if(this.BXIM.messenger.popupMessenger!=null&&this.BXIM.messenger.currentTab==o&&this.BXIM.isFocus()){if(typeof this.BXIM.messenger.flashMessage[o]=="undefined")this.BXIM.messenger.flashMessage[o]={};for(var m=0;m<e[o].length;m++){if(this.BXIM.isFocus())this.BXIM.messenger.flashMessage[o][e[o][m]]=false;if(this.BXIM.messenger.message[e[o][m]]&&this.BXIM.messenger.message[e[o][m]].senderId==this.BXIM.messenger.currentTab)r=true}this.readMessage(o,true,true,true)}else if(this.isMobile()&&this.BXIM.messenger.currentTab==o){var h=this.BXIM.messenger.currentTab;this.BXIM.isFocusMobile(s.delegate(function(e){if(e){s.MessengerCommon.readMessage(h,true,true,true)}},this));if(this.BXIM.messenger.unreadMessage[h])this.BXIM.messenger.unreadMessage[h]=s.util.array_unique(s.util.array_merge(this.BXIM.messenger.unreadMessage[h],e[h]));else this.BXIM.messenger.unreadMessage[h]=e[h]}else{i=true;if(typeof this.BXIM.messenger.flashMessage[o]=="undefined"){this.BXIM.messenger.flashMessage[o]={};var g=o.toString().substr(0,4)=="chat"&&this.BXIM.messenger.chat[o.toString().substr(4)]&&this.BXIM.messenger.chat[o.toString().substr(4)].type=="lines";for(var m=0;m<e[o].length;m++){if(g&&this.BXIM.messenger.unreadMessage[o]&&this.BXIM.messenger.unreadMessage[o].length>0){var p=this.BXIM.messenger.message[e[o][m]].senderId;if(p==0||this.BXIM.messenger.users[p].extranet){this.BXIM.messenger.flashMessage[o][e[o][m]]=false;continue}}var I=this.BXIM.messenger.message[e[o][m]].text.match(new RegExp("("+this.BXIM.messenger.users[this.BXIM.userId].name.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")+")","ig"));if(n!="dnd"||I){this.BXIM.messenger.flashMessage[o][e[o][m]]=t}}}else{var g=o.toString().substr(0,4)=="chat"&&this.BXIM.messenger.chat[o.toString().substr(4)]&&this.BXIM.messenger.chat[o.toString().substr(4)].type=="lines";for(var m=0;m<e[o].length;m++){var I=this.BXIM.messenger.message[e[o][m]].text.match(new RegExp("("+this.BXIM.messenger.users[this.BXIM.userId].name.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")+")","ig"));if(n!="dnd"||I){if(!t&&!this.BXIM.isFocus()){this.BXIM.messenger.flashMessage[o][e[o][m]]=false}else{if(g&&this.BXIM.messenger.unreadMessage[o]&&this.BXIM.messenger.unreadMessage[o].length>0){var p=this.BXIM.messenger.message[e[o][m]].senderId;if(p==0||this.BXIM.messenger.users[p].extranet){this.BXIM.messenger.flashMessage[o][e[o][m]]=false;continue}}if(typeof this.BXIM.messenger.flashMessage[o][e[o][m]]=="undefined"){this.BXIM.messenger.flashMessage[o][e[o][m]]=true}}}}}if(this.BXIM.messenger.unreadMessage[o])this.BXIM.messenger.unreadMessage[o]=s.util.array_unique(s.util.array_merge(this.BXIM.messenger.unreadMessage[o],e[o]));else this.BXIM.messenger.unreadMessage[o]=e[o]}}if(this.MobileActionEqual("DIALOG")&&this.BXIM.messenger.popupMessenger!=null&&this.BXIM.messenger.currentTab==o){a=true}}if(a){this.BXIM.messenger.dialogStatusRedraw(this.isMobile()?{type:1,slidingPanelRedrawDisable:true,userRedraw:false}:{userRedraw:false})}if(this.MobileActionEqual("RECENT")&&this.BXIM.messenger.popupMessenger!=null&&!this.BXIM.messenger.recentList&&i)s.MessengerCommon.userListRedraw();if(this.isMobile()&&this.MobileActionEqual("RECENT")&&app.enableInVersion(13)){clearTimeout(this.newMessageTimeout);this.newMessageTimeout=setTimeout(s.proxy(function(){this.BXIM.messenger.newMessage()},this),1e3)}else if(!this.isMobile()){this.BXIM.messenger.newMessage(t);this.BXIM.messenger.updateMessageCount(t);if(t&&r&&n!="dnd"){this.BXIM.playSound("newMessage2")}}};t.prototype.redrawDateMarks=function(){if(!this.BXIM.messenger.popupMessengerBodyWrap)return false;if(typeof this.BXIM.messenger.popupMessengerBodyWrap.getElementsByClassName=="undefined")return false;var e={};var t=this.BXIM.messenger.popupMessengerBodyWrap.getElementsByClassName("bx-messenger-content-group");var r=this.BXIM.messenger.popupMessengerBody.getBoundingClientRect().top;for(var i=0;i<t.length;i++){e=s.MessengerCommon.isElementCoordsBelow(t[i],this.BXIM.messenger.popupMessengerBody,33,true);if(t[i].className!="bx-messenger-content-group bx-messenger-content-group-today"){t[i].className="bx-messenger-content-group "+(e.top?"":"bx-messenger-content-group-float");t[i].firstChild.nextSibling.style.marginLeft=e.top?"":Math.round(t[i].offsetWidth/2-t[i].firstChild.nextSibling.offsetWidth/2)+"px";t[i].firstChild.nextSibling.style.marginTop=e.top?"":-e.coords.top+14+"px"}if(!e.top&&t[i-1]){t[i-1].className="bx-messenger-content-group";t[i-1].firstChild.nextSibling.style.marginLeft="";t[i-1].firstChild.nextSibling.style.marginTop=""}}};t.prototype.unreadMessage=function(e){if(!this.BXIM.messenger.message[e]){return false}var t=this.BXIM.messenger.message[e];var r="";if(t.recipientId.toString().substr(0,4)=="chat"){r=t.recipientId}else{r=t.senderId}s.rest.callMethod("im.dialog.unread",{DIALOG_ID:r,MESSAGE_ID:e});showMessage=this.BXIM.messenger.showMessage[r];showMessage.sort(function(e,s){if(e<s){return-1}else if(e>s){return 1}else{return 0}});this.BXIM.messenger.unreadMessage[r]=[];for(var i=0;i<showMessage.length;i++){if(parseInt(showMessage[i])>=parseInt(e)){if(!this.BXIM.messenger.unreadMessage[r])this.BXIM.messenger.unreadMessage[r]=[];this.BXIM.messenger.unreadMessage[r].push(showMessage[i])}}this.skipReadMessage=true;this.drawTab();this.userListRedraw();setTimeout(s.delegate(function(){this.skipReadMessage=false},this),1e3)};t.prototype.readMessage=function(t,r,i,a){if(!t||this.skipReadMessage){return false}a=a==true||this.isMobile();if(!a&&(!this.BXIM.messenger.unreadMessage[t]||this.BXIM.messenger.unreadMessage[t].length<=0)){return false}if(this.BXIM.callController.hasActiveCall()&&this.BXIM.callController.hasVisibleCall()){return false}if(t.toString().substring(0,4)=="chat"){var n=t.toString().substring(4);if(this.BXIM.messenger.chat[n]&&this.BXIM.messenger.chat[n].type=="lines"&&this.BXIM.messenger.chat[n].owner==0){return false}}if(s.SidePanel&&s.SidePanel.Instance.isOpen()&&s.SidePanel.Instance.isOnTop()&&this.BXIM.messenger.popupMessenger){var o=s.SidePanel.Instance.getTopSlider();if(!(o.url==="/desktop_app/"||o.url.startsWith("im:slider"))){return false}}r=r!=false;i=i!==false;var l={};for(var m in this.BXIM.messenger.unreadMessage){if(t==m)continue;l[m]=true}if(this.BXIM.messenger.recentListExternal){var h=s.findChildrenByClassName(this.BXIM.messenger.recentListExternal,"bx-messenger-cl-status-new-message");if(h!=null){for(var m=0;m<h.length;m++){var g=h[m].getAttribute("data-userId");if(!l[g]){h[m].firstChild.innerHTML="";s.removeClass(h[m],"bx-messenger-cl-status-new-message")}}}}if(this.BXIM.messenger.popupMessenger!=null){var h=s.findChildrenByClassName(this.BXIM.messenger.popupContactListElementsWrap,"bx-messenger-cl-status-new-message");if(h!=null){for(var m=0;m<h.length;m++){var g=h[m].getAttribute("data-userId");if(!l[g]){h[m].firstChild.innerHTML="";s.removeClass(h[m],"bx-messenger-cl-status-new-message")}}}h=s.findChildrenByClassName(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-content-item-new",false);if(h!=null)for(var m=0;m<h.length;m++)if(h[m].getAttribute("data-notifyType")!=1)s.removeClass(h[m],"bx-messenger-content-item-new")}var p=0;if(Math&&this.BXIM.messenger.unreadMessage[t])p=Math.max.apply(Math,this.BXIM.messenger.unreadMessage[t]);if(this.BXIM.messenger.unreadMessage[t]){var I=s.clone(this.BXIM.messenger.unreadMessage[t]);delete this.BXIM.messenger.unreadMessage[t]}if(this.BXIM.messenger.flashMessage[t])delete this.BXIM.messenger.flashMessage[t];s.localStorage.set("mfm",this.BXIM.messenger.flashMessage,80);if(!this.isMobile()){this.BXIM.messenger.updateMessageCount(r);this.BXIM.updateCounter()}if(i){var d={IM_READ_MESSAGE:"Y",USER_ID:t,TAB:this.BXIM.messenger.currentTab,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()};if(parseInt(p)>0)d["LAST_ID"]=p;var c=s.ajax({url:this.BXIM.pathToAjax+"?READ_MESSAGE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,skipAuthCheck:true,data:d,onsuccess:s.delegate(function(r){if(r){if(r.BITRIX_SESSID)s.message({bitrix_sessid:r.BITRIX_SESSID});if(r.ERROR==""){s.onCustomEvent(e,"onImMessageRead",[t]);this.BXIM.messenger.setUpdateStateStep()}else{this.BXIM.messenger.unreadMessage[t]=I;if(r.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;setTimeout(s.delegate(function(){this.readMessage(t,false,true)},this),2e3);s.onCustomEvent(e,"onImError",[r.ERROR,r.BITRIX_SESSID])}else if(r.ERROR=="AUTHORIZE_ERROR"){this.BXIM.messenger.sendAjaxTry++;if(this.isDesktop()||this.isMobile()){setTimeout(s.delegate(function(){this.readMessage(t,false,true)},this),1e4)}s.onCustomEvent(e,"onImError",[r.ERROR])}}}else{this.BXIM.messenger.unreadMessage[t]=I}},this),onfailure:s.delegate(function(){this.BXIM.messenger.unreadMessage[t]=I;this.BXIM.messenger.sendAjaxTry=0;try{if(typeof c=="object"&&c.status==0)s.onCustomEvent(e,"onImError",["CONNECT_ERROR"])}catch(e){}},this)})}if(r){s.localStorage.set("mrm",t,5);s.localStorage.set("mnnb",true,1)}};t.prototype.drawReadMessageChat=function(e,t){if(!this.BXIM.messenger.readedList[e]){return false}var r=Math.max.apply(Math,this.BXIM.messenger.showMessage[e]);var i=0;var a={};var n=0;var o=false;for(var l in this.BXIM.messenger.readedList[e]){if(l==this.BXIM.userId)continue;if(this.BXIM.messenger.message[r]&&this.BXIM.messenger.message[r].senderId==l)continue;if(this.BXIM.messenger.readedList[e][l].messageId>=r){if(!a[l]){a[l]={}}if(!o||o.getTime()>this.BXIM.messenger.readedList[e][l].date.getTime()){n=l;o=this.BXIM.messenger.readedList[e][l].date}a[l]=this.BXIM.messenger.readedList[e][l];i++}}if(i>0){this.BXIM.messenger.readedList[e]=a}else{this.BXIM.messenger.readedList[e]=false;var m=this.BXIM.messenger.popupMessengerBodyWrap?this.BXIM.messenger.popupMessengerBodyWrap.lastChild:null;if(m&&s.hasClass(m,"bx-messenger-content-item-notify")){if(!this.countWriting(e)){s.remove(m)}}return false}if(!this.countWriting(e)){var h=this.getUserParam(n);var g='<span title="'+this.formatDate(o)+'">'+h.name+"</span>";if(i>1){if(this.isMobile()){g=s.message("IM_M_READED_CHAT_MORE").replace("#USER#",g).replace("#LINK_START#","<b>").replace("#LINK_END#","</b>").replace("#COUNT#",i-1)}else{g=s.message("IM_M_READED_CHAT_MORE").replace("#USER#",g).replace("#LINK_START#",'<span class="bx-messenger-ajax" data-entity="readedList">').replace("#LINK_END#","</span>").replace("#COUNT#",i-1)}}t=t!=false;this.drawNotifyMessage(e,"readed",s.message("IM_M_READED_CHAT").replace("#USERS#",g),t)}};t.prototype.drawReadMessage=function(e,t,r,i){var a=Math.max.apply(Math,this.BXIM.messenger.showMessage[e]);if(a!=t||this.BXIM.messenger.message[a].senderId==e||!r){this.BXIM.messenger.readedList[e]=false;return false}this.BXIM.messenger.readedList[e]={messageId:t,date:r};if(!this.countWriting(e)){i=i!=false;this.drawNotifyMessage(e,"readed",s.message("IM_M_READED").replace("#DATE#",this.formatDate(r)),i)}};t.prototype.drawNotifyMessage=function(t,r,i,a){if(this.BXIM.messenger.popupMessenger==null||t!=this.BXIM.messenger.currentTab||typeof i=="undefined"||typeof r=="undefined"||t==0)return false;if(!this.BXIM.messenger.popupMessengerBodyWrap)return false;var n=this.BXIM.messenger.popupMessengerBodyWrap.lastChild;if(!n||s.hasClass(n,"bx-messenger-content-empty"))return false;var o=s.create("div",{attrs:{"data-type":"notify"},props:{className:"bx-messenger-content-item bx-messenger-content-item-notify"},children:[s.create("span",{props:{className:"bx-messenger-content-item-content"},children:[s.create("span",{props:{className:"bx-messenger-content-item-text-center"},children:[s.create("span",{props:{className:"bx-messenger-content-item-text-message"},html:'<span class="bx-messenger-content-item-notify-icon-'+r+'"></span>'+this.prepareText(i,false,true,true)})]})]})]});var l=true;if(s.hasClass(n,"bx-messenger-content-item-notify")){l=false;s.remove(n)}this.BXIM.messenger.popupMessengerBodyWrap.appendChild(o);a=a!=false;if(l&&this.BXIM.messenger.popupMessengerBody&&s.MessengerCommon.enableScroll(this.BXIM.messenger.popupMessengerBody,this.BXIM.messenger.popupMessengerBody.offsetHeight)){if(this.isMobile()&&document.body.offsetHeight<=e.innerHeight){this.BXIM.messenger.popupMessengerBody.scrollTop=0}else if(this.BXIM.animationSupport&&a){if(this.BXIM.messenger.popupMessengerBodyAnimation!=null)this.BXIM.messenger.popupMessengerBodyAnimation.stop();(this.BXIM.messenger.popupMessengerBodyAnimation=new s.easing({duration:1200,start:{scroll:this.BXIM.messenger.popupMessengerBody.scrollTop},finish:{scroll:this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)},transition:s.easing.makeEaseInOut(s.easing.transitions.quart),step:s.delegate(function(e){this.BXIM.messenger.popupMessengerBody.scrollTop=e.scroll},this)})).animate()}else{this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)}}};t.prototype.loadHistory=function(e,t,r){t=typeof t=="undefined"?true:t;r=typeof r=="undefined"?false:r;if(!this.BXIM.messenger.historyEndOfList[e])this.BXIM.messenger.historyEndOfList[e]={};if(!this.BXIM.messenger.historyLoadFlag[e])this.BXIM.messenger.historyLoadFlag[e]={};if(this.BXIM.messenger.historyLoadFlag[e]&&this.BXIM.messenger.historyLoadFlag[e][t]){if(this.isMobile())app.pullDownLoadingStop();return}if(this.isMobile()){t=false}else{if(t){if(this.BXIM.messenger.historySearch!=""||this.BXIM.messenger.historyDateSearch!="")return;if(!(this.BXIM.messenger.popupHistoryItems.scrollTop>this.BXIM.messenger.popupHistoryItems.scrollHeight-this.BXIM.messenger.popupHistoryItems.offsetHeight-100))return}else{if(this.BXIM.messenger.showMessage[e]&&this.BXIM.messenger.showMessage[e].length>0&&this.BXIM.messenger.popupMessengerBody.scrollTop>=5)return}}if(!this.BXIM.messenger.historyEndOfList[e]||!this.BXIM.messenger.historyEndOfList[e][t]){var i=[];if(t){i=s.findChildrenByClassName(this.BXIM.messenger.popupHistoryBodyWrap,"bx-messenger-history-item")}else{i=s.findChildrenByClassName(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-content-item-text-wrap")}if(!this.isMobile()&&i.length<20&&!r){return false}if(i.length>0)this.BXIM.messenger.historyOpenPage[e]=Math.floor(i.length/20)+1;else this.BXIM.messenger.historyOpenPage[e]=1;var a=null;if(!this.isMobile()&&!r){a=s.create("div",{props:{className:"bx-messenger-content-load-more-history"},children:[s.create("span",{props:{className:"bx-messenger-content-load-img"}}),s.create("span",{props:{className:"bx-messenger-content-load-text"},html:s.message("IM_M_LOAD_MESSAGE")})]});if(t){this.BXIM.messenger.popupHistoryBodyWrap.appendChild(a)}else{this.BXIM.messenger.popupMessengerBodyWrap.insertBefore(a,this.BXIM.messenger.popupMessengerBodyWrap.firstChild)}}else if(r){a=s.create("div",{props:{className:"bx-messenger-content-load-more-history"},children:[s.create("span",{props:{className:"bx-messenger-content-load-img"}}),s.create("span",{props:{className:"bx-messenger-content-load-text"},html:s.message("IM_M_LOAD_MESSAGE")})]});var n=s.findChildByClassName(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-content-empty");if(n){n.innerHTML="";n.appendChild(a)}else{n=s.findChildByClassName(this.BXIM.messenger.popupMessengerBodyWrap,"bx-notifier-content-link-history-empty");this.BXIM.messenger.popupMessengerBodyWrap.insertBefore(a,n);s.remove(n)}}if(!this.BXIM.messenger.historyLoadFlag[e])this.BXIM.messenger.historyLoadFlag[e]={};this.BXIM.messenger.historyLoadFlag[e][t]=true;s.ajax({url:this.BXIM.pathToAjax+"?HISTORY_LOAD_MORE&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_HISTORY_LOAD_MORE:"Y",USER_ID:e,PAGE_ID:this.BXIM.messenger.historyOpenPage[e],IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(r){if(a)s.remove(a);if(this.isMobile())app.pullDownLoadingStop();this.BXIM.messenger.historyLoadFlag[e][t]=false;if(r.MESSAGE&&r.MESSAGE.length==0){this.BXIM.messenger.historyEndOfList[e][t]=true;var i=s.findChildByClassName(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-content-empty");if(i){i.appendChild(s.create("span",{props:{className:"bx-messenger-content-load-text"},html:s.message("IM_M_NO_MESSAGE")}))}return}for(var n in r.FILES){if(!this.BXIM.disk.files[r.CHAT_ID])this.BXIM.disk.files[r.CHAT_ID]={};if(this.BXIM.disk.files[r.CHAT_ID][n])continue;r.FILES[n].date=new Date(r.FILES[n].date);this.BXIM.disk.files[r.CHAT_ID][n]=r.FILES[n]}var o=0;for(var n in r.MESSAGE){r.MESSAGE[n].date=new Date(r.MESSAGE[n].date);this.BXIM.messenger.message[n]=r.MESSAGE[n];o++}if(o<20){this.BXIM.messenger.historyEndOfList[e][t]=true}for(var n in r.USERS_MESSAGE){if(t){if(this.BXIM.messenger.history[n])this.BXIM.messenger.history[n]=s.util.array_merge(this.BXIM.messenger.history[n],r.USERS_MESSAGE[n]);else this.BXIM.messenger.history[n]=r.USERS_MESSAGE[n]}else{if(this.BXIM.messenger.showMessage[n])this.BXIM.messenger.showMessage[n]=s.util.array_unique(s.util.array_merge(r.USERS_MESSAGE[n],this.BXIM.messenger.showMessage[n]));else this.BXIM.messenger.showMessage[n]=r.USERS_MESSAGE[n]}}for(var n in r.USERS){r.USERS[n].last_activity_date=new Date(r.USERS[n].last_activity_date);r.USERS[n].mobile_last_date=new Date(r.USERS[n].mobile_last_date);r.USERS[n].idle=r.USERS[n].idle?new Date(r.USERS[n].idle):false;r.USERS[n].absent=r.USERS[n].absent?new Date(r.USERS[n].absent):false;this.BXIM.messenger.users[n]=r.USERS[n]}for(var n in r.PHONES){this.BXIM.messenger.phones[n]={};for(var l in r.PHONES[n]){this.BXIM.messenger.phones[n][l]=s.util.htmlspecialcharsback(r.PHONES[n][l])}}for(var n in r.USER_IN_GROUP){if(typeof this.BXIM.messenger.userInGroup[n]=="undefined"||typeof this.BXIM.messenger.userInGroup[n].users=="undefined"||!this.BXIM.messenger.userInGroup[n].users.length){this.BXIM.messenger.userInGroup[n]=r.USER_IN_GROUP[n]}else{for(var l=0;l<r.USER_IN_GROUP[n].users.length;l++)this.BXIM.messenger.userInGroup[n].users.push(r.USER_IN_GROUP[n].users[l]);this.BXIM.messenger.userInGroup[n].users=s.util.array_unique(this.BXIM.messenger.userInGroup[n].users)}}if(t){for(var n=0;n<r.USERS_MESSAGE[e].length;n++){var m=this.BXIM.messenger.message[r.USERS_MESSAGE[e][n]];if(m){if(s("im-message-history-"+m.id))continue;var h=s.MessengerCommon.formatDate(m.date,s.MessengerCommon.getDateFormatType("MESSAGE_TITLE"));var g=typeof s.translit!="undefined"?s.translit(h):h;if(!s("bx-im-history-"+g)){var p=s.create("div",{props:{className:"bx-messenger-content-group bx-messenger-content-group-history"},children:[s.create("div",{attrs:{id:"bx-im-history-"+g},props:{className:"bx-messenger-content-group-title"+(this.BXIM.language=="ru"?" bx-messenger-lowercase":"")},html:h})]});this.BXIM.messenger.popupHistoryBodyWrap.appendChild(p)}var m=this.BXIM.messenger.drawMessageHistory(m);if(m)this.BXIM.messenger.popupHistoryBodyWrap.appendChild(m)}}}else{var I=this.BXIM.messenger.popupMessengerBodyWrap.firstChild?this.BXIM.messenger.popupMessengerBodyWrap.firstChild.nextSibling:null;if(I){I=s("im-message-"+I.getAttribute("data-blockmessageid"))}if(r.USERS_MESSAGE[e]){for(var n=0;n<r.USERS_MESSAGE[e].length;n++){var m=this.BXIM.messenger.message[r.USERS_MESSAGE[e][n]];if(m){if(s("im-message-"+m.id))continue;s.MessengerCommon.drawMessage(e,m,false,true)}}}if(I){this.scrollToNode(I.parentNode.parentNode.parentNode.parentNode.parentNode)}else{this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)}}},this),onfailure:s.delegate(function(){if(a)s.remove(a);if(this.isMobile())app.pullDownLoadingStop()},this)})}};t.prototype.loadMessageByDate=function(t,r,i){s.ajax({url:this.BXIM.pathToAjax+"?LOAD_MESSAGE_BY_DATE&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_LOAD_MESSAGE_BY_DATE:"Y",CHAT_ID:t,LAST_LOAD:r,FIRST_MESSAGE_ID:i,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(a){if(a&&a.BITRIX_SESSID){s.message({bitrix_sessid:a.BITRIX_SESSID})}if(a.ERROR==""){var n=a.DIALOG_ID;this.BXIM.messenger.sendAjaxTry=0;for(var o in a.USERS){a.USERS[o].last_activity_date=new Date(a.USERS[o].last_activity_date);a.USERS[o].mobile_last_date=new Date(a.USERS[o].mobile_last_date);a.USERS[o].idle=a.USERS[o].idle?new Date(a.USERS[o].idle):false;a.USERS[o].absent=a.USERS[o].absent?new Date(a.USERS[o].absent):false;this.BXIM.messenger.users[o]=a.USERS[o]}for(var o in a.PHONES){this.BXIM.messenger.phones[o]={};for(var l in a.PHONES[o]){this.BXIM.messenger.phones[o][l]=s.util.htmlspecialcharsback(a.PHONES[o][l])}}for(var o in a.USER_IN_GROUP){if(typeof this.BXIM.messenger.userInGroup[o]=="undefined"||typeof this.BXIM.messenger.userInGroup[o].users=="undefined"||!this.BXIM.messenger.userInGroup[o].users.length){this.BXIM.messenger.userInGroup[o]=a.USER_IN_GROUP[o]}else{for(var l=0;l<a.USER_IN_GROUP[o].users.length;l++)this.BXIM.messenger.userInGroup[o].users.push(a.USER_IN_GROUP[o].users[l]);this.BXIM.messenger.userInGroup[o].users=s.util.array_unique(this.BXIM.messenger.userInGroup[o].users)}}for(var o in a.FILES){if(!this.BXIM.messenger.disk.files[a.CHAT_ID])this.BXIM.messenger.disk.files[a.CHAT_ID]={};a.FILES[o].date=new Date(a.FILES[o].date);this.BXIM.messenger.disk.files[a.CHAT_ID][o]=a.FILES[o]}this.BXIM.messenger.sendAjaxTry=0;var m=0;for(var o in a.MESSAGE){m++;a.MESSAGE[o].date=new Date(a.MESSAGE[o].date);this.BXIM.messenger.message[o]=a.MESSAGE[o];this.BXIM.lastRecordId=parseInt(o)>this.BXIM.lastRecordId?parseInt(o):this.BXIM.lastRecordId}for(var o in a.USERS_MESSAGE){if(this.BXIM.messenger.showMessage[o])this.BXIM.messenger.showMessage[o]=s.util.array_unique(s.util.array_merge(a.USERS_MESSAGE[o],this.BXIM.messenger.showMessage[o]));else this.BXIM.messenger.showMessage[o]=a.USERS_MESSAGE[o]}for(var o in a.DELETE_MESSAGE){delete this.BXIM.messenger.message[o];if(this.BXIM.messenger.currentTab==a.DIALOG_ID&&s("im-message-"+o)){var h=s("im-message-"+o).parentNode.parentNode.parentNode.parentNode.parentNode;if(h.getAttribute("data-messageId")==h.getAttribute("data-blockMessageId")){s.remove(h)}else{h=s("im-message-"+o).parentNode;if(h.nextSibling&&s.hasClass(h.nextSibling,"bx-messenger-hr")){s.remove(h.nextSibling)}else if(!h.nextSibling&&s.hasClass(h.previousSibling,"bx-messenger-hr")){s.remove(h.previousSibling)}s.remove(h)}}}for(var o in a.CHAT){a.CHAT[o].date_create=new Date(a.CHAT[o].date_create);this.BXIM.messenger.chat[o]=a.CHAT[o]}for(var o in a.USER_IN_CHAT){this.BXIM.messenger.userInChat[o]=a.USER_IN_CHAT[o]}for(var o in a.USER_BLOCK_CHAT){this.BXIM.messenger.userChatBlockStatus[o]=a.USER_BLOCK_CHAT[o]}this.changeUnreadMessage(a.UNREAD_MESSAGE)}else{if(a.ERROR=="SESSION_ERROR"&&this.sendAjaxTry<2){this.sendAjaxTry++;setTimeout(s.delegate(function(){this.loadMessageByDate(t,r,i)},this),1e3);s.onCustomEvent(e,"onImError",[a.ERROR,a.BITRIX_SESSID])}else if(a.ERROR=="AUTHORIZE_ERROR"){this.sendAjaxTry++;if(s.MessengerCommon.isDesktop()||this.isMobile()){setTimeout(s.delegate(function(){this.loadMessageByDate(t,r,i)},this),1e4)}s.onCustomEvent(e,"onImError",[a.ERROR])}}},this),onfailure:s.delegate(function(){this.sendAjaxTry=0},this)})};t.prototype.loadUserData=function(e){s.ajax({url:this.BXIM.pathToAjax+"?USER_DATA_LOAD&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_USER_DATA_LOAD:"Y",USER_ID:e,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(t){if(t.ERROR==""){this.BXIM.messenger.userChat[e]=t.CHAT_ID;s.MessengerCommon.getUserParam(e,true);this.BXIM.messenger.users[e].name=s.message("IM_M_USER_NO_ACCESS");for(var r in t.USERS){t.USERS[r].last_activity_date=new Date(t.USERS[r].last_activity_date);t.USERS[r].mobile_last_date=new Date(t.USERS[r].mobile_last_date);t.USERS[r].idle=t.USERS[r].idle?new Date(t.USERS[r].idle):false;t.USERS[r].absent=t.USERS[r].absent?new Date(t.USERS[r].absent):false;this.BXIM.messenger.users[r]=t.USERS[r]}for(var r in t.PHONES){this.BXIM.messenger.phones[r]={};for(var i in t.PHONES[r]){this.BXIM.messenger.phones[r][i]=s.util.htmlspecialcharsback(t.PHONES[r][i])}}for(var r in t.USER_IN_GROUP){if(typeof this.BXIM.messenger.userInGroup[r]=="undefined"||typeof this.BXIM.messenger.userInGroup[r].users=="undefined"||!this.BXIM.messenger.userInGroup[r].users.length){this.BXIM.messenger.userInGroup[r]=t.USER_IN_GROUP[r]}else{for(var i=0;i<t.USER_IN_GROUP[r].users.length;i++)this.BXIM.messenger.userInGroup[r].users.push(t.USER_IN_GROUP[r].users[i]);this.BXIM.messenger.userInGroup[r].users=s.util.array_unique(this.BXIM.messenger.userInGroup[r].users)}}if(this.isMobile()){this.BXIM.messenger.dialogStatusRedrawDelay()}else{this.BXIM.messenger.dialogStatusRedraw()}}else{this.BXIM.messenger.redrawTab[e]=true;if(t.ERROR=="ACCESS_DENIED"&&this.BXIM.messenger.currentTab==e){this.BXIM.messenger.currentTab=0;this.BXIM.messenger.openChatFlag=false;this.BXIM.messenger.openCallFlag=false;this.BXIM.messenger.openLinesFlag=false;this.BXIM.messenger.extraClose()}}},this)})};t.prototype.loadChatData=function(e){s.ajax({url:this.BXIM.pathToAjax+"?CHAT_DATA_LOAD&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_CHAT_DATA_LOAD:"Y",CHAT_ID:e,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(e){if(e.ERROR==""){if(this.BXIM.messenger.chat[e.CHAT_ID].fake){this.BXIM.messenger.chat[e.CHAT_ID].name=s.message("IM_M_USER_NO_ACCESS")}for(var t in e.CHAT){e.CHAT[t].date_create=new Date(e.CHAT[t].date_create);this.BXIM.messenger.chat[t]=e.CHAT[t]}for(var t in e.USER_IN_CHAT){this.BXIM.messenger.userInChat[t]=e.USER_IN_CHAT[t]}for(var t in e.USER_BLOCK_CHAT){this.BXIM.messenger.userChatBlockStatus[t]=e.USER_BLOCK_CHAT[t]}for(var t in e.USERS){e.USERS[t].last_activity_date=new Date(e.USERS[t].last_activity_date);e.USERS[t].mobile_last_date=new Date(e.USERS[t].mobile_last_date);e.USERS[t].idle=e.USERS[t].idle?new Date(e.USERS[t].idle):false;e.USERS[t].absent=e.USERS[t].absent?new Date(e.USERS[t].absent):false;this.BXIM.messenger.users[t]=e.USERS[t]}for(var t in e.USER_IN_GROUP){if(typeof this.BXIM.messenger.userInGroup[t]=="undefined"||typeof this.BXIM.messenger.userInGroup[t].users=="undefined"||!this.BXIM.messenger.userInGroup[t].users.length){this.BXIM.messenger.userInGroup[t]=e.USER_IN_GROUP[t]}else{for(var r=0;r<e.USER_IN_GROUP[t].users.length;r++)this.BXIM.messenger.userInGroup[t].users.push(e.USER_IN_GROUP[t].users[r]);this.BXIM.messenger.userInGroup[t].users=s.util.array_unique(this.BXIM.messenger.userInGroup[t].users)}}if(this.BXIM.messenger.currentTab=="chat"+e.CHAT_ID){if(this.BXIM.messenger.chat[e.CHAT_ID]&&this.BXIM.messenger.chat[e.CHAT_ID].type=="call"){this.BXIM.messenger.openCallFlag=true}else if(this.BXIM.messenger.chat[e.CHAT_ID]&&this.BXIM.messenger.chat[e.CHAT_ID].type=="lines"){this.BXIM.messenger.openLinesFlag=true}this.drawTab(this.BXIM.messenger.currentTab)}}},this)})};t.prototype.loadLastMessage=function(t,r){if(this.BXIM.messenger.loadLastMessageTimeout[t])return false;r=typeof r=="function"?r:function(e,s,t){};var i=0;var a=false;if(t.toString().substr(0,4)=="chat"){i=t.toString().substr(4);a=true}else if(t.toString().substr(0,2)=="sg"){i=t.toString().substr(2);a=true}else if(t.toString().substr(0,3)=="crm"){i=t.toString().substr(4);a=true}this.BXIM.messenger.historyWindowBlock=true;delete this.BXIM.messenger.redrawTab[t];this.BXIM.messenger.loadLastMessageTimeout[t]=true;if(this.BXIM.messenger.popupMessengerDialog&&this.BXIM.messenger.currentTab==t){if(a&&(!this.BXIM.messenger.chat[i]||this.BXIM.messenger.chat[i].fake)||!a&&(!this.BXIM.messenger.users[t]||this.BXIM.messenger.users[t].fake)){s.addClass(this.BXIM.messenger.popupMessengerDialog,"bx-messenger-chat-load-last-message")}}var n=s.delegate(function(){this.BXIM.messenger.loadLastMessageTimeout[t]=false;r(t,false,{});if(this.BXIM.messenger.popupMessengerDialog&&this.BXIM.messenger.currentTab==t){s.removeClass(this.BXIM.messenger.popupMessengerDialog,"bx-messenger-chat-load-last-message")}if(this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;clearTimeout(this.BXIM.messenger.loadLastMessageTimeout);this.BXIM.messenger.loadLastMessageTimeout=setTimeout(s.delegate(function(){s.MessengerCommon.loadLastMessage(t)},this),2e3);return true}this.BXIM.messenger.historyWindowBlock=false;this.BXIM.messenger.redrawTab[t]=true;if(!this.BXIM.messenger.showMessage[t]||this.BXIM.messenger.showMessage[t].length<=0){this.BXIM.messenger.popupMessengerBodyWrap.innerHTML="";var e=[s.create("div",{props:{className:"bx-messenger-content-empty"},children:[s.create("span",{props:{className:"bx-messenger-content-load-text"},html:s.message("IM_M_LOAD_ERROR")})]})];s.adjust(this.BXIM.messenger.popupMessengerBodyWrap,{children:e});if(this.isMobile()&&this.MobileActionEqual("DIALOG")){BXMobileApp.UI.Page.TopBar.title.setText(s.message("IM_F_ERROR"));BXMobileApp.UI.Page.TopBar.title.setDetailText("")}}else{this.BXIM.messenger.tooltip(this.BXIM.messenger.popupMessengerBody,s.message("IM_M_LOAD_ERROR"),{offsetTop:-10,offsetLeft:50,bindOptions:{position:"top"}});var i=s.findChildByClassName(this.BXIM.messenger.popupMessengerBodyWrap,"bx-notifier-content-link-history");if(i){s.remove(i)}}},this);var o=s.delegate(function(i){this.BXIM.messenger.loadLastMessageTimeout[t]=false;if(this.BXIM.messenger.popupMessengerDialog&&this.BXIM.messenger.currentTab==i.USER_ID){s.removeClass(this.BXIM.messenger.popupMessengerDialog,"bx-messenger-chat-load-last-message")}this.BXIM.checkRevision(this.isMobile()?i.MOBILE_REVISION:i.REVISION);if(!i){n();return false}if(i&&i.BITRIX_SESSID){s.message({bitrix_sessid:i.BITRIX_SESSID})}if(i.ERROR==""){if(this.isMobile()){this.BXIM.disk.setChatParams(parseInt(i.CHAT_ID),parseInt(i.DISK_FOLDER_ID))}if(a){if(i.USER_ID.toString().substr(0,2)=="sg"){if(this.BXIM.messenger.currentTab==i.USER_ID){this.BXIM.messenger.currentTab="chat"+i.CHAT_ID}delete this.BXIM.messenger.chat[i.USER_ID];i.USER_ID="chat"+i.CHAT_ID;s.MessengerCommon.getUserParam(i.USER_ID)}else if(i.USER_ID.toString().substr(0,3)=="crm"){if(this.BXIM.messenger.currentTab==i.USER_ID){this.BXIM.messenger.currentTab="chat"+i.CHAT_ID}delete this.BXIM.messenger.chat[i.USER_ID];i.USER_ID="chat"+i.CHAT_ID;s.MessengerCommon.getUserParam(i.USER_ID)}}else{this.BXIM.messenger.userChat[t]=i.CHAT_ID;s.MessengerCommon.getUserParam(t,true);this.BXIM.messenger.users[t].name=s.message("IM_M_USER_NO_ACCESS")}for(var o in i.USERS){i.USERS[o].last_activity_date=new Date(i.USERS[o].last_activity_date);i.USERS[o].mobile_last_date=new Date(i.USERS[o].mobile_last_date);i.USERS[o].idle=i.USERS[o].idle?new Date(i.USERS[o].idle):false;i.USERS[o].absent=i.USERS[o].absent?new Date(i.USERS[o].absent):false;this.BXIM.messenger.users[o]=i.USERS[o]}for(var o in i.PHONES){this.BXIM.messenger.phones[o]={};for(var l in i.PHONES[o]){this.BXIM.messenger.phones[o][l]=s.util.htmlspecialcharsback(i.PHONES[o][l])}}for(var o in i.USER_IN_GROUP){if(typeof this.BXIM.messenger.userInGroup[o]=="undefined"||typeof this.BXIM.messenger.userInGroup[o].users=="undefined"||!this.BXIM.messenger.userInGroup[o].users.length){this.BXIM.messenger.userInGroup[o]=i.USER_IN_GROUP[o]}else{for(var l=0;l<i.USER_IN_GROUP[o].users.length;l++)this.BXIM.messenger.userInGroup[o].users.push(i.USER_IN_GROUP[o].users[l]);this.BXIM.messenger.userInGroup[o].users=s.util.array_unique(this.BXIM.messenger.userInGroup[o].users)}}if(!a&&i.USER_LOAD=="Y")s.MessengerCommon.userListRedraw();for(var o in i.FILES){if(!this.BXIM.messenger.disk.files[i.CHAT_ID])this.BXIM.messenger.disk.files[i.CHAT_ID]={};i.FILES[o].date=new Date(i.FILES[o].date);this.BXIM.messenger.disk.files[i.CHAT_ID][o]=i.FILES[o]}this.BXIM.messenger.sendAjaxTry=0;var m=0;for(var o in i.MESSAGE){m++;i.MESSAGE[o].date=new Date(i.MESSAGE[o].date);this.BXIM.messenger.message[o]=i.MESSAGE[o];this.BXIM.lastRecordId=parseInt(o)>this.BXIM.lastRecordId?parseInt(o):this.BXIM.lastRecordId}if(m<=0){delete this.BXIM.messenger.redrawTab[i.USER_ID]}for(var o in i.USERS_MESSAGE){if(this.BXIM.messenger.showMessage[o])this.BXIM.messenger.showMessage[o]=s.util.array_unique(s.util.array_merge(i.USERS_MESSAGE[o],this.BXIM.messenger.showMessage[o]));else this.BXIM.messenger.showMessage[o]=i.USERS_MESSAGE[o]}if(a&&this.BXIM.messenger.chat[i.USER_ID.toString().substr(4)]&&this.BXIM.messenger.chat[i.USER_ID.toString().substr(4)].fake){this.BXIM.messenger.chat[i.USER_ID.toString().substr(4)].name=s.message("IM_M_USER_NO_ACCESS")}for(var o in i.CHAT){i.CHAT[o].date_create=new Date(i.CHAT[o].date_create);this.BXIM.messenger.chat[o]=i.CHAT[o]}for(var o in i.USER_IN_CHAT){this.BXIM.messenger.userInChat[o]=i.USER_IN_CHAT[o]}for(var o in i.USER_BLOCK_CHAT){this.BXIM.messenger.userChatBlockStatus[o]=i.USER_BLOCK_CHAT[o]}if(this.isMobile()&&typeof fabric!="undefined"){fabric.Answers.sendCustomEvent("imOpenDialog",{});if(i.CHAT&&i.CHAT[i.CHAT_ID]){if(i.CHAT[i.CHAT_ID].type=="lines")fabric.Answers.sendCustomEvent("imOpenDialogLines",{});else fabric.Answers.sendCustomEvent("imOpenDialogChat",{})}else{fabric.Answers.sendCustomEvent("imOpenDialogPrivate",{})}}if(i.OPENLINES.canVoteAsHead){if(!this.BXIM.messenger.openlines.canVoteAsHead){this.BXIM.messenger.openlines.canVoteAsHead={}}for(var o in i.OPENLINES.canVoteAsHead){this.BXIM.messenger.openlines.canVoteAsHead[o]=i.OPENLINES.canVoteAsHead[o]}}if(this.BXIM.messenger.currentTab==i.USER_ID){if(this.BXIM.messenger.currentTab.toString().substr(0,4)=="chat"&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)]&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)].type=="call"){this.BXIM.messenger.openCallFlag=true}}if(i.NETWORK_ID!=""){this.BXIM.messenger.currentTab=i.USER_ID?i.USER_ID:0;delete this.BXIM.messenger.users[i.NETWORK_ID];if(!this.BXIM.messenger.bot[i.USER_ID]){this.BXIM.messenger.bot[i.USER_ID]=this.BXIM.messenger.bot[i.NETWORK_ID]}delete this.BXIM.messenger.bot[i.NETWORK_ID];if(this.MobileActionEqual("RECENT")){var h=0;for(var o=0;o<this.BXIM.messenger.recent.length;o++){if(this.BXIM.messenger.recent[o].userId==i.NETWORK_ID){h++;this.BXIM.messenger.recent[o].userId=i.USER_ID;this.BXIM.messenger.recent[o].recipientId=i.USER_ID;this.BXIM.messenger.recent[o].senderId=i.USER_ID}else if(this.BXIM.messenger.recent[o].userId==i.USER_ID){h++}}if(h>1){for(var o=0;o<this.BXIM.messenger.recent.length;o++){if(this.BXIM.messenger.recent[o].userId==i.USER_ID){this.recentListHide(i.USER_ID,false);break}}}s.MessengerCommon.userListRedraw()}else if(this.isMobile()&&this.MobileActionEqual("DIALOG")){app.onCustomEvent("onImDialogNetworkOpen",{NETWORK_ID:i.NETWORK_ID,USER_ID:i.USER_ID,USER:this.BXIM.messenger.users[i.USER_ID]})}}if(a){for(var o in i.READED_LIST){for(var g in i.READED_LIST[o]){i.READED_LIST[o][g].date=new Date(i.READED_LIST[o][g].date)}this.BXIM.messenger.readedList[o]=i.READED_LIST[o]}}else{for(var o in i.READED_LIST){i.READED_LIST[o].date=new Date(i.READED_LIST[o].date);this.BXIM.messenger.readedList[o]=i.READED_LIST[o]}}if(a&&this.BXIM.messenger.chat[i.CHAT_ID]&&this.BXIM.messenger.chat[i.CHAT_ID].type=="livechat"){var p=this.livechatGetSession(i.CHAT_ID);if(p.readed=="Y"){p.readedTime=p.readedTime?new Date(p.readedTime):new Date;this.BXIM.messenger.readedList["chat"+i.CHAT_ID]={messageId:p.readedId,date:p.readedTime}}}this.changeUnreadMessage(i.UNREAD_MESSAGE);this.drawTab(i.USER_ID,this.BXIM.messenger.currentTab==i.USER_ID,m);if(this.BXIM.messenger.currentTab==i.USER_ID&&this.BXIM.messenger.readedList[i.USER_ID]){if(this.BXIM.messenger.openChatFlag){this.drawReadMessageChat(i.USER_ID,false)}else{this.drawReadMessage(i.USER_ID,this.BXIM.messenger.readedList[i.USER_ID].messageId,this.BXIM.messenger.readedList[i.USER_ID].date,false)}}this.BXIM.messenger.historyWindowBlock=false;if(this.BXIM.isFocus()){this.readMessage(i.USER_ID,true,false)}if(this.isMobile()){setTimeout(s.delegate(function(){this.BXIM.messenger.autoScroll()},this),100)}s.onCustomEvent(e,"onImLoadLastMessage",[t,true,i]);r(t,true,i)}else{this.BXIM.messenger.redrawTab[t]=true;if(i.ERROR=="ACCESS_DENIED"&&this.BXIM.messenger.currentTab==t){this.BXIM.messenger.currentTab=0;this.BXIM.messenger.openChatFlag=false;this.BXIM.messenger.openCallFlag=false;this.BXIM.messenger.openLinesFlag=false;this.BXIM.messenger.extraClose()}else if(i.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;setTimeout(s.delegate(function(){this.loadLastMessage(t)},this),2e3);s.onCustomEvent(e,"onImError",[i.ERROR,i.BITRIX_SESSID])}else if(i.ERROR=="AUTHORIZE_ERROR"){this.BXIM.messenger.sendAjaxTry++;if(this.isDesktop()||this.isMobile()){setTimeout(s.delegate(function(){this.loadLastMessage(t)},this),1e4)}s.onCustomEvent(e,"onImError",[i.ERROR])}r(t,false,i)}},this);var l=this.isMobile()||this.BXIM.isFocus();if(a&&this.BXIM.messenger.chat[i]&&this.BXIM.messenger.chat[i].owner==0&&this.BXIM.messenger.chat[i].type=="lines"){l=false}var m=s.ajax({url:this.BXIM.pathToAjax+"?LOAD_LAST_MESSAGE&D="+t+"&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,data:{IM_LOAD_LAST_MESSAGE:"Y",CHAT:a?"Y":"N",USER_ID:t,USER_LOAD:"Y",TAB:this.BXIM.messenger.currentTab,READ:l?"Y":"N",MOBILE:this.isMobile()?"Y":"N",FOCUS:!this.isMobile()||typeof BXMobileAppContext!="object"||BXMobileAppContext.isBackground()?"N":"Y",SEARCH_MARK:!a&&this.BXIM.messenger.users[t]&&this.BXIM.messenger.users[t].search_mark?this.BXIM.messenger.users[t].search_mark:"",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:o,onprogress:function(e){if(e.position==0&&e.totalSize==0){n()}},onfailure:n})};t.prototype.openDialog=function(e,t,r){var i=s.MessengerCommon.getUserParam(e);if(i.id<=0)return false;e=e?e:0;this.BXIM.messenger.currentTab=e;if(e.toString().substr(0,4)=="chat"){this.BXIM.messenger.openChatFlag=true;if(this.BXIM.messenger.chat[e.toString().substr(4)]&&this.BXIM.messenger.chat[e.toString().substr(4)].type=="call")this.BXIM.messenger.openCallFlag=true;else if(this.BXIM.messenger.chat[e.toString().substr(4)]&&this.BXIM.messenger.chat[e.toString().substr(4)].type=="lines")this.BXIM.messenger.openLinesFlag=true}s.localStorage.set("mct",this.BXIM.messenger.currentTab,15);if(this.isMobile()){this.BXIM.messenger.dialogStatusRedrawDelay()}else{this.BXIM.messenger.dialogStatusRedraw()}if(!this.isMobile()){if(this.BXIM.messenger.popupMessengerPanel){this.BXIM.messenger.popupMessengerPanel.className=this.BXIM.messenger.openChatFlag?"bx-messenger-panel bx-messenger-hide":"bx-messenger-panel"}if(this.BXIM.messenger.openChatFlag){this.BXIM.messenger.popupMessengerPanelChat.className=this.BXIM.messenger.openCallFlag?"bx-messenger-panel bx-messenger-hide":"bx-messenger-panel";this.BXIM.messenger.popupMessengerPanelCall.className=this.BXIM.messenger.openCallFlag?"bx-messenger-panel":"bx-messenger-panel bx-messenger-hide"}else{this.BXIM.messenger.popupMessengerPanelChat.className="bx-messenger-panel bx-messenger-hide";this.BXIM.messenger.popupMessengerPanelCall.className="bx-messenger-panel bx-messenger-hide"}}t=t==true;r=r===true;var a=[];if(typeof this.BXIM.messenger.showMessage[e]!="undefined"&&this.BXIM.messenger.showMessage[e].length>0){if(this.BXIM.messenger.showMessage[e]&&this.BXIM.messenger.unreadMessage[e]&&this.BXIM.messenger.showMessage[e].length!=0&&this.BXIM.messenger.showMessage[e].length==this.BXIM.messenger.unreadMessage[e].length){this.drawTab(e,true);s.addClass(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-loading");var n=s.create("div",{props:{className:"bx-notifier-content-link-history"},children:[s.create("span",{props:{className:"bx-messenger-content-load-img"}}),s.create("span",{props:{className:"bx-messenger-content-load-text"},html:s.message("IM_M_LOAD_MESSAGE")})]});this.BXIM.messenger.redrawTab[e]=true;this.BXIM.messenger.popupMessengerBodyWrap.insertBefore(n,this.BXIM.messenger.popupMessengerBodyWrap.firstChild);if(this.isMobile()){setTimeout(s.delegate(function(){this.BXIM.messenger.autoScroll()},this),100)}}else if(!i.fake&&this.BXIM.messenger.showMessage[e].length>=15){if(this.isMobile()&&this.BXIM.webComponent){this.drawTab(e,true);this.BXIM.messenger.redrawTab[e]=true}else{this.BXIM.messenger.redrawTab[e]=false}}else{this.drawTab(e,true);this.BXIM.messenger.redrawTab[e]=true}}else if(this.BXIM.messenger.popupMessengerConnectionStatusState!="online"){s.addClass(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-loading");a=[s.create("div",{props:{className:"bx-messenger-content-empty"},children:[s.create("span",{props:{className:"bx-messenger-content-load-text"},html:s.message("IM_M_LOAD_ERROR")})]})];this.BXIM.messenger.redrawTab[e]=true}else if(typeof this.BXIM.messenger.showMessage[e]=="undefined"){s.addClass(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-loading");a=[s.create("div",{props:{className:"bx-messenger-content-load"},children:[s.create("span",{props:{className:"bx-messenger-content-load-img"}}),s.create("span",{props:{className:"bx-messenger-content-load-text"},html:s.message("IM_M_LOAD_MESSAGE")})]})];this.BXIM.messenger.redrawTab[e]=true}else if(this.BXIM.messenger.redrawTab[e]&&this.BXIM.messenger.showMessage[e].length==0){s.addClass(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-loading");a=[s.create("div",{props:{className:"bx-messenger-content-load"},children:[s.create("span",{props:{className:"bx-messenger-content-load-img"}}),s.create("span",{props:{className:"bx-messenger-content-load-text"},html:s.message("IM_M_LOAD_MESSAGE")})]})];this.BXIM.messenger.showMessage[e]=[]}else{var o="";if(this.isBot(e)&&this.BXIM.messenger.users[e]){o=s.message("IM_M_NO_MESSAGE_BOT").replace("#BOT_NAME#",this.BXIM.messenger.users[e].name)}else{o=s.message(this.BXIM.settings.loadLastMessage?"IM_M_NO_MESSAGE_2":"IM_M_NO_MESSAGE")}s.removeClass(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-loading");a=[s.create("div",{props:{className:"bx-messenger-content-empty"},children:[s.create("span",{props:{className:"bx-messenger-content-load-text"},html:o})]})]}if(a.length>0){this.BXIM.messenger.popupMessengerBodyWrap.innerHTML="";s.adjust(this.BXIM.messenger.popupMessengerBodyWrap,{children:a})}if(t)this.BXIM.messenger.extraClose();if(r&&this.BXIM.callController.hasActiveCall())this.BXIM.callController.showChat();if(this.isMobile()){BXMobileApp.UI.Page.TextPanel.setText(this.BXIM.messenger.textareaHistory[e]?this.BXIM.messenger.textareaHistory[e]:"")}else{this.BXIM.messenger.popupMessengerTextarea.value=this.BXIM.messenger.textareaHistory[e]?this.BXIM.messenger.textareaHistory[e]:""}if(this.BXIM.messenger.redrawTab[e]){if(this.BXIM.settings.loadLastMessage||e.toString().substr(0,2)=="sg"||e.toString().substr(0,3)=="crm"||e.toString().substr(0,7)=="network"){this.loadLastMessage(e)}else{if(this.BXIM.messenger.openChatFlag)s.MessengerCommon.loadChatData(e.toString().substr(4));else s.MessengerCommon.loadUserData(e);delete this.BXIM.messenger.redrawTab[e];this.drawTab(e,true)}}else{this.drawTab(e,true)}if(!this.BXIM.messenger.redrawTab[e]){if(this.isMobile()){this.BXIM.isFocusMobile(s.delegate(function(t){if(t){s.MessengerCommon.readMessage(e)}},this))}else if(this.BXIM.isFocus()){this.readMessage(e)}}if(!this.isMobile())this.BXIM.messenger.resizeMainWindow();if(s.MessengerCommon.countWriting(e)){if(this.BXIM.messenger.openChatFlag)s.MessengerCommon.drawWriting(0,e);else s.MessengerCommon.drawWriting(e)}else if(this.BXIM.messenger.readedList[e]){if(this.BXIM.messenger.openChatFlag){this.drawReadMessageChat(e,false)}else{this.drawReadMessage(e,this.BXIM.messenger.readedList[e].messageId,this.BXIM.messenger.readedList[e].date,false)}}s.onCustomEvent("onImDialogOpen",[{id:e}]);if(this.isMobile()){BXMobileApp.onCustomEvent("onImDialogOpen",{id:e},true)}};t.prototype.drawTab=function(e,t,r,i){r=r||0;i=i!==false;if(!e){e=this.BXIM.messenger.currentTab}if(this.BXIM.messenger.popupMessenger==null||e!=this.BXIM.messenger.currentTab)return false;if(typeof this.messageGroup!="object"){this.messageGroup={}}this.messageGroup["default"]={};var a=true;if(this.BXIM.messenger.openChatFlag){var n=e.toString().substr(4);if(this.BXIM.messenger.chat[n]){if(this.BXIM.messenger.chat[n].type=="open"){if(!s.MessengerCommon.userInChat(n)){if(this.isMobile()){BXMobileApp.onCustomEvent("onPullExtendWatch",{id:"IM_PUBLIC_"+n,force:this.BXIM.messenger.redrawTab[e]?false:true},true)}else{s.PULL.extendWatch("IM_PUBLIC_"+n,this.BXIM.messenger.redrawTab[e]?false:true)}}}else if(this.BXIM.messenger.chat[n].type=="lines"){a=false}}}if(this.isPage()&&i){if(a){if(s.MessengerWindow.currentTab!="im"){s.MessengerWindow.changeTab("im")}}else if(this.BXIM.settings.linesTabEnable){if(s.MessengerWindow.currentTab!="im-ol"){s.MessengerWindow.changeTab("im-ol")}}}if(this.isMobile()){this.BXIM.messenger.dialogStatusRedrawDelay()}else{this.BXIM.messenger.dialogStatusRedraw()}this.BXIM.messenger.popupMessengerBodyWrap.innerHTML="";s.removeClass(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-loading");if(!this.BXIM.messenger.showMessage[e]||this.BXIM.messenger.showMessage[e].length<=0){var o="";var l=null;if(this.isBot(e)&&this.BXIM.messenger.users[e]){o=s.message("IM_M_NO_MESSAGE_BOT").replace("#BOT_NAME#",this.BXIM.messenger.users[e].name)}else{o=s.message(this.BXIM.settings.loadLastMessage?"IM_M_NO_MESSAGE_2":"IM_M_NO_MESSAGE");l=s.create("span",{props:{className:"bx-notifier-content-link-history bx-notifier-content-link-history-empty"},children:[s.create("span",{props:{className:"bx-notifier-item-button bx-notifier-item-button-white"},html:s.message("IM_M_NO_MESSAGE_LOAD")})],events:{click:s.delegate(function(){this.loadHistory(this.BXIM.messenger.currentTab,false,true)},this)}})}this.BXIM.messenger.popupMessengerBodyWrap.appendChild(s.create("div",{props:{className:"bx-messenger-content-empty"},children:[s.create("span",{props:{className:"bx-messenger-content-load-text"},html:o}),l]}))}if(this.BXIM.messenger.showMessage[e])this.BXIM.messenger.showMessage[e].sort(s.delegate(function(e,s){if(!this.BXIM.messenger.message[e]||!this.BXIM.messenger.message[s]){return 0}var t=this.BXIM.messenger.message[e].date.getTime();var r=this.BXIM.messenger.message[s].date.getTime();if(t<r){return-1}else if(t>r){return 1}else{if(e<s){return-1}else if(e>s){return 1}else{return 0}}},this));else this.BXIM.messenger.showMessage[e]=[];for(var m=0;m<this.BXIM.messenger.showMessage[e].length;m++){if(this.isMobile()&&this.BXIM.webComponent&&this.BXIM.messenger.showMessage[e][m].toString().indexOf("temp")==0){continue}s.MessengerCommon.drawMessage(e,this.BXIM.messenger.message[this.BXIM.messenger.showMessage[e][m]],false)}if(r>0&&r<20){if(!this.BXIM.messenger.openChatFlag||this.BXIM.messenger.chat[e.toString().substr(4)]){var h=false;if(this.BXIM.messenger.openChatFlag&&this.BXIM.messenger.chat[e.toString().substr(4)].date_create){if(this.BXIM.messenger.chat[e.toString().substr(4)].date_create.getTime()/1e3+25e5>(new Date).getTime()/1e3){h=true}}if(!h){var l=s.create("span",{props:{className:"bx-notifier-content-link-history bx-notifier-content-link-history-empty"},children:[s.create("span",{props:{className:"bx-notifier-item-button bx-notifier-item-button-white"},html:s.message("IM_M_NO_MESSAGE_LOAD")})],events:{click:s.delegate(function(){this.loadHistory(this.BXIM.messenger.currentTab,false,true)},this)}});this.BXIM.messenger.popupMessengerBodyWrap.insertBefore(l,this.BXIM.messenger.popupMessengerBodyWrap.firstChild)}}}if(this.BXIM.messenger.chat[n]){if(this.BXIM.messenger.chat[n].entity_type=="LINES"){var g=s.MessengerCommon.linesGetSession(this.BXIM.messenger.chat[n]);var p;if(parseInt(g.id)>0){for(m=0;m<this.BXIM.messenger.openlines.queue.length;m++){if(this.BXIM.messenger.openlines.queue[m].id==g.lineId){p=this.BXIM.messenger.openlines.queue[m];break}}if(p&&p.queue_type=="all"){if(!s.MessengerCommon.isSessionBlocked(n)){s.style(this.BXIM.messenger.popupMessengerTextareaOpenLinesSkip,"display","none")}else{s.style(this.BXIM.messenger.popupMessengerTextareaOpenLinesSkip,"display","inline-block")}}else{s.style(this.BXIM.messenger.popupMessengerTextareaOpenLinesSkip,"display","inline-block")}}}}t=t!=false;if(t){if(this.BXIM.messenger.popupMessengerBodyAnimation!=null)this.BXIM.messenger.popupMessengerBodyAnimation.stop();if(this.BXIM.messenger.unreadMessage[e]&&this.BXIM.messenger.unreadMessage[e].length>0){var I=s("im-message-"+this.BXIM.messenger.unreadMessage[e][0]);if(I&&I.parentNode.parentNode.parentNode.parentNode.parentNode){this.scrollToNode(I.parentNode.parentNode.parentNode.parentNode.parentNode)}else{this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)}}else{this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)}}s.onCustomEvent("onImDrawTab",[{id:e,hasMessage:this.BXIM.messenger.showMessage[e]&&this.BXIM.messenger.showMessage[e].length>0}]);if(s.MessengerCommon.countWriting(e)){if(this.BXIM.messenger.openChatFlag)s.MessengerCommon.drawWriting(0,e);else s.MessengerCommon.drawWriting(e)}else if(this.BXIM.messenger.readedList[e]){if(this.BXIM.messenger.openChatFlag){this.drawReadMessageChat(e,false)}else{this.drawReadMessage(e,this.BXIM.messenger.readedList[e].messageId,this.BXIM.messenger.readedList[e].date,false)}}if(this.BXIM.messenger.linesWritingList[n]){var d="chat"+n;if(d===BXIM.messenger.currentTab){s.MessengerCommon.drawMessage(BXIM.messenger.currentTab,BXIM.messenger.linesWritingList[n]);var c=s.findChildByClassName(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-content-item-id-"+BXIM.messenger.linesWritingList[n].id);clearTimeout(this.BXIM.messenger.linesWritingListTimeout[n]);this.BXIM.messenger.linesWritingListTimeout[n]=setTimeout(s.delegate(function(){s.remove(c);delete this.BXIM.messenger.linesWritingList[n]},this),29500)}}delete this.BXIM.messenger.redrawTab[e]};t.prototype.scrollToNode=function(t){var r=s(t);var i=navigator.userAgent.indexOf("Edge")>-1;if(!i&&r.scrollIntoView){r.scrollIntoView(true)}else{var a=s.pos(r);e.scrollTo(a.left,a.top)}};t.prototype.sendMessageAjax=function(t,r,i,a){if(this.BXIM.messenger.popupMessengerConnectionStatusState!="online")return false;s.MessengerCommon.drawProgessMessage("temp"+t);if(this.BXIM.messenger.sendMessageFlag<0)this.BXIM.messenger.sendMessageFlag=0;clearTimeout(this.BXIM.messenger.sendMessageTmpTimeout["temp"+t]);if(this.BXIM.messenger.sendMessageTmp[t])return false;this.BXIM.messenger.sendMessageTmp[t]=true;a=a==true;this.BXIM.messenger.sendMessageFlag++;var n="N";if(a&&this.BXIM.messenger.linesSilentMode&&this.BXIM.messenger.linesSilentMode[r.toString().substr(4)]){n="Y"}this.recentListAdd({id:"temp"+t,date:new Date,skipDateCheck:true,recipientId:r,senderId:this.BXIM.userId,text:s.util.htmlspecialchars(i),userId:r,userIsChat:a,params:{CLASS:n=="Y"?"bx-messenger-content-item-system":""}},true);s.onCustomEvent("onImBeforeMessageSend",[{recipientId:r,messageText:i}]);var o=s.ajax({url:this.BXIM.pathToAjax+"?MESSAGE_SEND&V="+this.BXIM.revision+"&logTag="+s.MessengerCommon.getLogTrackingParams({name:"im.message.add",dialog:s.MessengerCommon.getDialogDataForTracking(r)}),method:"POST",dataType:"json",skipAuthCheck:true,timeout:120,data:{IM_SEND_MESSAGE:"Y",CHAT:a?"Y":"N",ID:"temp"+t,RECIPIENT_ID:r,MESSAGE:i,OL_SILENT:n,TAB:this.BXIM.messenger.currentTab,USER_TZ_OFFSET:s.message("USER_TZ_OFFSET"),IM_AJAX_CALL:"Y",FOCUS:!this.isMobile()||typeof BXMobileAppContext!="object"||BXMobileAppContext.isBackground()?"N":"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(n){if(this.isMobile()&&typeof fabric!="undefined"){fabric.Answers.sendCustomEvent("imMessageSend",{})}this.BXIM.messenger.sendMessageFlag--;if(n&&n.BITRIX_SESSID){s.message({bitrix_sessid:n.BITRIX_SESSID})}if(n&&n.ERROR==""){this.BXIM.messenger.sendAjaxTry=0;this.BXIM.messenger.message[n.TMP_ID].text=n.SEND_MESSAGE;this.BXIM.messenger.message[n.TMP_ID].id=n.ID;this.BXIM.messenger.message[n.TMP_ID].date=new Date(n.SEND_DATE);if(n.SEND_MESSAGE_PARAMS){this.BXIM.messenger.message[n.TMP_ID].params=n.SEND_MESSAGE_PARAMS}for(var o in n.SEND_MESSAGE_FILES){if(!this.BXIM.messenger.disk.files[n.CHAT_ID])this.BXIM.messenger.disk.files[n.CHAT_ID]={};if(this.BXIM.messenger.disk.files[n.CHAT_ID][o])continue;n.SEND_MESSAGE_FILES[o].date=new Date(n.SEND_MESSAGE_FILES[o].date);this.BXIM.messenger.disk.files[n.CHAT_ID][o]=n.SEND_MESSAGE_FILES[o]}this.BXIM.messenger.message[n.ID]=this.BXIM.messenger.message[n.TMP_ID];if(this.BXIM.messenger.popupMessengerLastMessage==n.TMP_ID)this.BXIM.messenger.popupMessengerLastMessage=n.ID;delete this.BXIM.messenger.message[n.TMP_ID];var l=this.BXIM.messenger.message[n.ID];var m=s.util.array_search(""+n.TMP_ID+"",this.BXIM.messenger.showMessage[n.RECIPIENT_ID]);if(this.BXIM.messenger.showMessage[n.RECIPIENT_ID][m])this.BXIM.messenger.showMessage[n.RECIPIENT_ID][m]=""+n.ID+"";for(var o=0;o<this.BXIM.messenger.recent.length;o++){if(this.BXIM.messenger.recent[o].id==n.TMP_ID){this.BXIM.messenger.recent[o].id=""+n.ID+"";break}}if(n.RECIPIENT_ID==this.BXIM.messenger.currentTab){var h=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-messageid":""+n.TMP_ID+""}},true);if(h){h.setAttribute("data-messageid",""+n.ID+"");if(h.getAttribute("data-blockmessageid")==""+n.TMP_ID+""){h.setAttribute("data-blockmessageid",""+n.ID+"")}else{var g=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-blockmessageid":""+n.TMP_ID+""}},true);if(g){g.setAttribute("data-blockmessageid",""+n.ID+"")}}var p=s.findChild(h,{attribute:{"data-messageid":""+n.TMP_ID+""}},true);if(p){p.setAttribute("data-messageid",""+n.ID+"")}}s.MessengerCommon.clearProgessMessage(n.TMP_ID);var I=s("im-message-"+n.TMP_ID);if(I){I.id="im-message-"+n.ID;var d={oneSmileInMessage:false};I.innerHTML=s.MessengerCommon.prepareText(n.SEND_MESSAGE,false,true,true,null,d);if(d.oneSmileInMessage){var c=s.findChildByClassName(h,"bx-messenger-content-item-content");if(c){s.addClass(c,"bx-messenger-content-item-content-transparent")}}}var M=s.findChildByClassName(h,"bx-messenger-content-item-date");if(M)M.innerHTML=s.MessengerCommon.formatDate(l.date,s.MessengerCommon.getDateFormatType("MESSAGE"))}if(this.BXIM.messenger.history[n.RECIPIENT_ID])this.BXIM.messenger.history[n.RECIPIENT_ID].push(l.id);else this.BXIM.messenger.history[n.RECIPIENT_ID]=[l.id];this.BXIM.messenger.updateStateVeryFastCount=2;this.BXIM.messenger.updateStateFastCount=5;this.BXIM.messenger.setUpdateStateStep();if(n.SEND_MESSAGE_PARAMS){if(n.SEND_MESSAGE_PARAMS.URL_ONLY=="Y"&&this.BXIM.settings.enableRichLink){s.addClass(h.firstElementChild,"bx-messenger-content-item-content-rich-link")}if(n.SEND_MESSAGE_PARAMS.LARGE_FONT=="Y"&&this.BXIM.settings.enableBigSmile){s.addClass(h.firstElementChild,"bx-messenger-content-item-content-large-font")}if(n.RECIPIENT_ID.toString().substr(0,4)=="chat"){if(this.isMobile()){s.onCustomEvent(e,"onPull-im",[{command:"messageParamsUpdate",params:{id:n.ID,type:"chat",chatId:n.CHAT_ID,senderId:n.SENDER_ID,params:n.SEND_MESSAGE_PARAMS,animation:"N"},extra:{revision_im_web:this.BXIM.revision,revision_im_mobile:this.BXIM.revision}}])}else{s.onCustomEvent(e,"onPullEvent-im",["messageParamsUpdate",{id:n.ID,type:"chat",chatId:n.CHAT_ID,senderId:n.SENDER_ID,params:n.SEND_MESSAGE_PARAMS,animation:"N"},{revision_im_web:this.BXIM.revision,revision_im_mobile:this.BXIM.revision}])}}else{if(this.isMobile()){s.onCustomEvent(e,"onPull-im",[{command:"messageParamsUpdate",params:{id:n.ID,type:"private",chatId:n.CHAT_ID,fromUserId:n.SENDER_ID,toUserId:n.RECIPIENT_ID,senderId:n.SENDER_ID,params:n.SEND_MESSAGE_PARAMS,animation:"N"},extra:{revision_im_web:this.BXIM.revision,revision_im_mobile:this.BXIM.revision}}])}else{s.onCustomEvent(e,"onPullEvent-im",["messageParamsUpdate",{id:n.ID,type:"private",chatId:n.CHAT_ID,fromUserId:n.SENDER_ID,toUserId:n.RECIPIENT_ID,senderId:n.SENDER_ID,params:n.SEND_MESSAGE_PARAMS,animation:"N"},{revision_im_web:this.BXIM.revision,revision_im_mobile:this.BXIM.revision}])}}}s.MessengerCommon.updateStateVar(n,true,true);s.localStorage.set("msm",{id:n.ID,recipientId:n.RECIPIENT_ID,date:n.SEND_DATE,text:n.SEND_MESSAGE,senderId:this.BXIM.userId,MESSAGE:n.MESSAGE,USERS_MESSAGE:n.USERS_MESSAGE,USERS:n.USERS,USER_IN_GROUP:n.USER_IN_GROUP},5);if(this.isMobile()&&document.body.offsetHeight<=e.innerHeight){this.BXIM.messenger.popupMessengerBody.scrollTop=0}else if(this.BXIM.animationSupport){if(this.BXIM.messenger.popupMessengerBodyAnimation!=null)this.BXIM.messenger.popupMessengerBodyAnimation.stop();(this.BXIM.messenger.popupMessengerBodyAnimation=new s.easing({duration:800,start:{scroll:this.BXIM.messenger.popupMessengerBody.scrollTop},finish:{scroll:this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)},transition:s.easing.makeEaseInOut(s.easing.transitions.quart),step:s.delegate(function(e){this.BXIM.messenger.popupMessengerBody.scrollTop=e.scroll},this)})).animate()}else{this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)}if(this.MobileActionEqual("RECENT")&&(this.BXIM.messenger.recentList||this.BXIM.messenger.recentListExternal))this.recentListRedraw()}else{if(n&&n.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;setTimeout(s.delegate(function(){this.BXIM.messenger.sendMessageTmp[t]=false;this.sendMessageAjax(t,r,i,a)},this),2e3);s.onCustomEvent(e,"onImError",[n.ERROR,n.BITRIX_SESSID])}else if(n&&n.ERROR=="AUTHORIZE_ERROR"){this.BXIM.messenger.sendAjaxTry++;if(this.isDesktop()||this.isMobile()){setTimeout(s.delegate(function(){this.BXIM.messenger.sendMessageTmp[t]=false;this.sendMessageAjax(t,r,i,a)},this),1e4)}s.onCustomEvent(e,"onImError",[n.ERROR])}else{this.BXIM.messenger.sendMessageTmp[t]=false;var h=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-messageid":"temp"+t}},true);var M=s.findChildByClassName(h,"bx-messenger-content-item-date");if(M){if(n.ERROR=="SESSION_ERROR"||n.ERROR=="AUTHORIZE_ERROR"||n.ERROR=="UNKNOWN_ERROR"||n.ERROR=="IM_MODULE_NOT_INSTALLED")M.innerHTML=s.message("IM_M_NOT_DELIVERED");else M.innerHTML=n.ERROR}s.onCustomEvent(e,"onImError",["SEND_ERROR",n.ERROR,n.TMP_ID,n.SEND_DATE,n.SEND_MESSAGE,n.RECIPIENT_ID]);s.MessengerCommon.drawProgessMessage("temp"+t,{title:s.message("IM_M_RETRY"),chat:a?"Y":"N"});if(this.BXIM.messenger.message["temp"+t])this.BXIM.messenger.message["temp"+t].retry=true}}},this),onfailure:s.delegate(function(){this.BXIM.messenger.sendMessageFlag--;this.BXIM.messenger.sendMessageTmp[t]=false;var r=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-messageid":"temp"+t}},true);var i=s.findChildByClassName(r,"bx-messenger-content-item-date");if(i)i.innerHTML=s.message("IM_M_NOT_DELIVERED");s.MessengerCommon.drawProgessMessage("temp"+t,{title:s.message("IM_M_RETRY"),chat:a?"Y":"N"});this.BXIM.messenger.sendAjaxTry=0;try{if(typeof o=="object"&&o.status==0)s.onCustomEvent(e,"onImError",["CONNECT_ERROR"])}catch(e){}if(this.BXIM.messenger.message["temp"+t])this.BXIM.messenger.message["temp"+t].retry=true},this)})};t.prototype.sendMessageRetry=function(){var e=this.BXIM.messenger.currentTab;var t=[];for(var r=0;r<this.BXIM.messenger.showMessage[e].length;r++){var i=this.BXIM.messenger.message[this.BXIM.messenger.showMessage[e][r]];if(!i||i.id.toString().indexOf("temp")!=0)continue;i.text=s.MessengerCommon.prepareTextBack(i.text);t.push(i)}if(t.length<=0)return false;t.sort(function(e,s){e=e.id.substr(4);s=s.id.substr(4);if(e<s){return-1}else if(e>s){return 1}else{return 0}});for(var r=0;r<t.length;r++){this.sendMessageRetryTimeout(t[r],100*r)}};t.prototype.sendMessageRetryTimeout=function(e,t){clearTimeout(this.BXIM.messenger.sendMessageTmpTimeout[e.id]);this.BXIM.messenger.sendMessageTmpTimeout[e.id]=setTimeout(s.delegate(function(){s.MessengerCommon.sendMessageAjax(e.id.substr(4),e.recipientId,e.text,e.recipientId.toString().substr(0,4)=="chat")},this),t)};t.prototype.getLastMessageInDialog=function(e){var s=false;if(this.BXIM.messenger.showMessage[e]&&this.BXIM.messenger.showMessage[e].length>0){var t=this.BXIM.messenger.showMessage[e][this.BXIM.messenger.showMessage[e].length-1];s=this.BXIM.messenger.message[t]}return s};t.prototype.joinToChat=function(e){if(this.BXIM.messenger.blockJoinChat[e]){return false}if(this.BXIM.messenger.chat[e]&&!(this.BXIM.messenger.chat[e].type=="open"||this.BXIM.messenger.chat[e].type=="announcement")){return false}if(s.MessengerCommon.userInChat(e))return false;this.BXIM.messenger.blockJoinChat[e]=true;s.ajax({url:this.BXIM.pathToAjax+"?CHAT_JOIN&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:60,data:{IM_CHAT_JOIN:"Y",CHAT_ID:e,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false;this.BXIM.messenger.popupMessengerTextarea.disabled=false;this.BXIM.messenger.popupMessengerTextarea.focus()},this),onfailure:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this)})};t.prototype.messageUrlAttachDelete=function(e,t){if(e.toString().substr(0,4)=="temp"||!this.BXIM.messenger.message[e]||!this.BXIM.messenger.message[e].params||!this.BXIM.messenger.message[e].params.ATTACH||!this.BXIM.messenger.message[e].params.URL_ID||this.BXIM.messenger.message[e].params.URL_ID.indexOf(parseInt(t))==-1&&this.BXIM.messenger.message[e].params.URL_ID.indexOf(t.toString())==-1){return false}for(var r=0;r<this.BXIM.messenger.message[e].params.ATTACH.length;r++){if(!this.BXIM.messenger.message[e].params.ATTACH[r])continue;if(this.BXIM.messenger.message[e].params.ATTACH[r].ID==t){delete this.BXIM.messenger.message[e].params.ATTACH[r];break}}for(var r=0;r<this.BXIM.messenger.message[e].params.URL_ID.length;r++){if(!this.BXIM.messenger.message[e].params.URL_ID[r])continue;if(this.BXIM.messenger.message[e].params.URL_ID[r]==t){delete this.BXIM.messenger.message[e].params.URL_ID[r];break}}var i=s("im-message-"+e);var a=s.MessengerCommon.drawAttach(e,this.BXIM.messenger.message[e].chatId,this.BXIM.messenger.message[e].params.ATTACH);i.nextElementSibling.innerHTML="";if(a.length>0){s.adjust(i.nextElementSibling,{children:a})}if(a.length<=0){s.removeClass(i.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-rich-link")}s.ajax({url:this.BXIM.pathToAjax+"?URL_ATTACH_DELETE&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_URL_ATTACH_DELETE:"Y",ID:e,ATTACH_ID:t,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()}});return true};t.prototype.messageLike=function(e,t){if(e.toString().substr(0,4)=="temp"||!this.BXIM.messenger.message[e]||this.BXIM.messenger.popupMessengerLikeBlock[e]){return false}t=typeof t=="undefined"?false:t;if(!this.BXIM.messenger.message[e].params){this.BXIM.messenger.message[e].params={}}if(!this.BXIM.messenger.message[e].params.LIKE){this.BXIM.messenger.message[e].params.LIKE=[]}var r=s.util.in_array(this.BXIM.userId,this.BXIM.messenger.message[e].params.LIKE);if(!t){var i=r?"minus":"plus";if(i=="plus"){this.BXIM.messenger.message[e].params.LIKE.push(this.BXIM.userId);r=true}else{var a=[];for(var n=0;n<this.BXIM.messenger.message[e].params.LIKE.length;n++){if(this.BXIM.messenger.message[e].params.LIKE[n]!=this.BXIM.userId){a.push(this.BXIM.messenger.message[e].params.LIKE[n])}}this.BXIM.messenger.message[e].params.LIKE=a;r=false}}var o=this.BXIM.messenger.message[e].params.LIKE.length>0?this.BXIM.messenger.message[e].params.LIKE.length:"";if(s("im-message-"+e)){var l=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-blockmessageid":""+e+""}},false);var m=s.findChildByClassName(l,"bx-messenger-content-item-like");var h=s.findChildByClassName(l,"bx-messenger-content-like-digit",false);if(r){s.addClass(m,"bx-messenger-content-item-liked")}else{s.removeClass(m,"bx-messenger-content-item-liked")}if(o>0){h.setAttribute("title",s.message("IM_MESSAGE_LIKE_LIST"));s.removeClass(h.parentNode,"bx-messenger-content-like-digit-off")}else{h.setAttribute("title","");s.addClass(h.parentNode,"bx-messenger-content-like-digit-off")}h.innerHTML=o}if(this.isMobile()){app.exec("callVibration")}if(!t){clearTimeout(this.BXIM.messenger.popupMessengerLikeBlockTimeout[e]);this.BXIM.messenger.popupMessengerLikeBlockTimeout[e]=setTimeout(s.delegate(function(){this.BXIM.messenger.popupMessengerLikeBlock[e]=true;s.ajax({url:this.BXIM.pathToAjax+"?MESSAGE_LIKE&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_LIKE_MESSAGE:"Y",ID:e,ACTION:i,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(t){if(t.ERROR==""){this.BXIM.messenger.message[e].params.LIKE=t.LIKE}this.BXIM.messenger.popupMessengerLikeBlock[e]=false;s.MessengerCommon.messageLike(e,true)},this),onfailure:s.delegate(function(s){this.BXIM.messenger.popupMessengerLikeBlock[e]=false},this)})},this),1e3)}return true};t.prototype.messageIsLike=function(e){return this.BXIM.messenger.message[e]&&this.BXIM.messenger.message[e].params&&typeof this.BXIM.messenger.message[e].params.LIKE=="object"&&s.util.in_array(this.BXIM.userId,this.BXIM.messenger.message[e].params.LIKE)};t.prototype.checkEditMessage=function(e,t){t=t||"list";if(this.BXIM.messenger.openLinesFlag){var r=this.linesGetSource(this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)])}var i=false;if(this.BXIM.messenger.bot[this.BXIM.messenger.currentTab]&&(this.BXIM.messenger.bot[this.BXIM.messenger.currentTab].type!="network"&&this.BXIM.messenger.bot[this.BXIM.messenger.currentTab].type!="support24")){return i}if(this.BXIM.ppServerStatus&&parseInt(e)!=0&&e.toString().substr(0,4)!="temp"&&this.BXIM.messenger.message[e]&&this.BXIM.messenger.message[e].date.getTime()/1e3+259200>(new Date).getTime()/1e3&&(!this.BXIM.messenger.message[e].params||this.BXIM.messenger.message[e].params.IS_DELETED!="Y")&&s("im-message-"+e)&&s.util.in_array(e,this.BXIM.messenger.showMessage[this.BXIM.messenger.currentTab])){if(this.BXIM.messenger.openLinesFlag){if(this.BXIM.messenger.message[e].senderId==this.BXIM.userId){if(t=="edit"){i=this.BXIM.messenger.openlines.canUpdateOwnMessage.indexOf(r)>-1}else if(t=="delete"){i=this.BXIM.messenger.openlines.canDeleteOwnMessage.indexOf(r)>-1}}else if(this.BXIM.messenger.openlines.canDeleteMessage.indexOf(r)>-1&&t=="delete"){i=true}if(i&&r!="network"){if(!this.BXIM.messenger.message[e].params||typeof this.BXIM.messenger.message[e].params.CONNECTOR_MID=="undefined"||this.BXIM.messenger.message[e].params.CONNECTOR_MID.length<=0){i=false}}}else if(this.BXIM.messenger.message[e].senderId==this.BXIM.userId){i=true}}return i};t.prototype.editMessageAjax=function(e,t){if(this.BXIM.messenger.popupMessengerConnectionStatusState!="online")return false;this.BXIM.messenger.editMessageCancel();if(!s.MessengerCommon.checkEditMessage(e,"edit"))return false;if(t==s.MessengerCommon.prepareTextBack(this.BXIM.messenger.message[e].text,true))return false;t=t.replace("    ","\t");t=s.util.trim(t);if(t.length<=0){s.MessengerCommon.deleteMessageAjax(e);return false}t=s.MessengerCommon.prepareMention(this.BXIM.messenger.currentTab,t);s.MessengerCommon.drawProgessMessage(e);s.ajax({url:this.BXIM.pathToAjax+"?MESSAGE_EDIT&V="+this.BXIM.revision+"&logTag="+s.MessengerCommon.getLogTrackingParams({name:"im.message.update",dialog:s.MessengerCommon.getDialogDataForTracking(this.BXIM.messenger.message[e].recipientId)}),method:"POST",dataType:"json",timeout:30,data:{IM_EDIT_MESSAGE:"Y",ID:e,MESSAGE:t,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(t){s.MessengerCommon.clearProgessMessage(e)},this),onfailure:s.delegate(function(){s.MessengerCommon.clearProgessMessage(e)},this)})};t.prototype.deleteMessageAjax=function(e){this.BXIM.messenger.editMessageCancel();if(this.BXIM.isAdmin&&this.BXIM.messenger.openChatFlag&&this.BXIM.messenger.message[e].chatId&&this.BXIM.messenger.generalChatId==this.BXIM.messenger.message[e].chatId){}else if(!s.MessengerCommon.checkEditMessage(e,"delete")){return false}s.MessengerCommon.drawProgessMessage(e);s.ajax({url:this.BXIM.pathToAjax+"?MESSAGE_DELETE&V="+this.BXIM.revision+"&logTag="+s.MessengerCommon.getLogTrackingParams({name:"im.message.delete",dialog:s.MessengerCommon.getDialogDataForTracking(this.BXIM.messenger.message[e].recipientId)}),method:"POST",dataType:"json",timeout:30,data:{IM_DELETE_MESSAGE:"Y",ID:e,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(t){if(t.ERROR)return false;if(this.BXIM.messenger.message[e]){this.BXIM.messenger.message[e].isNowDeleted=true}s.MessengerCommon.clearProgessMessage(e)},this),onfailure:s.delegate(function(){s.MessengerCommon.clearProgessMessage(e)},this)});return true};t.prototype.shareMessageAjax=function(e,t,r){s.MessengerCommon.drawProgessMessage(e);s.ajax({url:this.BXIM.pathToAjax+"?MESSAGE_SHARE&TYPE="+t+"&V="+this.BXIM.revision+"&logTag="+s.MessengerCommon.getLogTrackingParams({name:"im.message.share",dialog:s.MessengerCommon.getDialogDataForTracking(this.BXIM.messenger.message[e].recipientId),data:{timShareType:t.toString().toLowerCase()}}),method:"POST",dataType:"json",timeout:30,data:{IM_SHARE_MESSAGE:"Y",ID:e,TYPE:t,DATE:r?r:0,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(t){s.MessengerCommon.clearProgessMessage(e);if(t.ERROR)return false},this),onfailure:s.delegate(function(){s.MessengerCommon.clearProgessMessage(e)},this)});return true};t.prototype.drawKeyboard=function(e,t,r){if(!r||r=="N")return null;var i=null;var a=[];var n=null;var o=null;for(var l=0;l<r.length;l++){if(r[l].TYPE=="NEWLINE"){n=s.create("div",{props:{className:"bx-messenger-keyboard-new-line"}})}else{if(r[l].CONTEXT&&(this.isMobile()&&r[l].CONTEXT=="DESKTOP"||!this.isMobile()&&r[l].CONTEXT=="MOBILE")){continue}var m="";if(r[l].WIDTH){m=m+"width: "+r[l].WIDTH+"px;"}else if(r[l].DISPLAY=="BLOCK"){m=m+"width: 225px;"}if(r[l].BG_COLOR){m=m+"background-color: "+r[l].BG_COLOR+";"}if(r[l].TEXT_COLOR){m=m+"color: "+r[l].TEXT_COLOR+";"}if(r[l].DISABLED&&r[l].DISABLED=="Y"){o='<span class="bx-messenger-keyboard-button-text" data-disabled="Y" style="'+m+'">'+r[l].TEXT+"</span>"}else{if(r[l].LINK){o='<a href="'+r[l].LINK+'" target="_blank" class="bx-messenger-keyboard-button-text" style="'+m+'">'+r[l].TEXT+"</a>"}else if(r[l].FUNCTION){var h=r[l].FUNCTION.toString().replace("#MESSAGE_ID#",t).replace("#DIALOG_ID#",e).replace("#USER_ID#",this.BXIM.userId);o='<a href="javascript:void(1);" onclick="'+h+'; BX.PreventDefault(event);" class="bx-messenger-keyboard-button-text" style="'+m+'">'+r[l].TEXT+"</a>"}else if(r[l].APP_ID){r[l].APP_PARAMS=r[l].APP_PARAMS?r[l].APP_PARAMS:"";o='<a href="javascript:void(1);" onclick="BXIM.messenger.textareaIconDialogClick('+parseInt(r[l].APP_ID)+", "+t+", '"+s.util.htmlspecialchars(r[l].APP_PARAMS)+'\'); BX.PreventDefault(event);" class="bx-messenger-keyboard-button-text" style="'+m+'">'+r[l].TEXT+"</a>"}else{o='<span class="bx-messenger-keyboard-button-text" data-dialogId="'+e+'" data-messageId="'+t+'" data-blockAfterClick="'+r[l].BLOCK+'" data-command="'+s.util.htmlspecialchars(r[l].COMMAND)+'" data-commandParams="'+s.util.htmlspecialchars(r[l].COMMAND_PARAMS)+'" data-botId="'+r[l].BOT_ID+'" style="'+m+'">'+r[l].TEXT+"</span>"}}n=s.create("span",{props:{className:"bx-messenger-keyboard-button bx-messenger-keyboard-button-"+r[l].DISPLAY.toLowerCase()},children:[o]})}a.push(n)}if(a.length>0){i=s.create("div",{attrs:{id:"im-message-keyboard-"+t},props:{className:"bx-messenger-keyboard"},children:a})}return i};t.prototype.clickButtonKeyboard=function(){if(s.proxy_context.tagName=="A")return true;if(this.sendBotCommand)return true;var e=s.proxy_context.getAttribute("data-dialogId");var t=s.proxy_context.getAttribute("data-messageId");var r=s.proxy_context.getAttribute("data-botId");var i=s.proxy_context.getAttribute("data-command");var a=s.proxy_context.getAttribute("data-commandParams");var n=s.proxy_context.getAttribute("data-disabled");var o=s.proxy_context.getAttribute("data-blockAfterClick");if(n=="Y"||s.hasClass(s.proxy_context,"bx-messenger-keyboard-button-block"))return true;this.sendBotCommand=true;if(!this.sendBotCommandBlock[r]){this.sendBotCommandBlock[r]={}}this.sendBotCommandBlock[r][t]=true;if(o=="Y"){var l=s("im-message-keyboard-"+t);if(l){var m=s.findChildrenByClassName(l,"bx-messenger-keyboard-button-text",false);for(var h=0;h<m.length;h++){s.addClass(m[h],"bx-messenger-keyboard-button-block")}}}s.addClass(s.proxy_context,"bx-messenger-keyboard-button-progress bx-messenger-keyboard-button-block");s.ajax({url:this.BXIM.pathToCallAjax+"?BOT_COMMAND&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_BOT_COMMAND:"Y",BOT_ID:r,COMMAND:i,COMMAND_PARAMS:a,DIALOG_ID:e,MESSAGE_ID:t,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(e){this.sendBotCommand=false},this),onfailure:s.delegate(function(){this.sendBotCommand=false},this)});return true};t.prototype.drawAttach=function(e,t,r,i){if(!r||r.length==0)return[];var a=[];if(typeof r!="object"){a.push(r)}else{a=r}i=i||{};var n=this.getUserIdByChatId(t);var o=[];for(var l=0;l<a.length;l++){var m=a[l];if(!m)continue;var h="";if(typeof m.COLOR!="undefined"){h=m.COLOR}else if(n&&this.BXIM.messenger.users[n]){h=this.BXIM.messenger.users[n].color}else if(this.BXIM.messenger.chat[t]){h=this.BXIM.messenger.chat[t].color}else if(this.BXIM.messenger.users[this.BXIM.userId]){h=this.BXIM.messenger.users[this.BXIM.userId].color}if(typeof m["BLOCKS"]!="object"){continue}var g=typeof m["ID"]!="undefined"?m["ID"]:0;var p=[];var I=false;if(g&&this.BXIM.messenger.message[e]&&this.BXIM.messenger.message[e].params&&this.BXIM.messenger.message[e].params.URL_ID&&(this.BXIM.messenger.message[e].params.URL_ID.indexOf(g)>-1||this.BXIM.messenger.message[e].params.URL_ID.indexOf(parseInt(g))>-1)){if(!this.BXIM.settings.enableRichLink){continue}if(this.BXIM.messenger.message[e].senderId==this.BXIM.userId){I=true}}if(I){p.push(s.create("span",{props:{className:"bx-messenger-attach-delete"},attrs:{"data-attachId":g,"data-messageId":e,"data-action":"url"}}))}for(var d=0;d<m["BLOCKS"].length;d++){var c=m["BLOCKS"][d];var M=null;if(c.USER&&c.USER.length>0){var u=[];for(var f=0;f<c.USER.length;f++){var B=null;if(c.USER[f].NETWORK_ID){B=s.create("span",{props:{className:"bx-messenger-attach-user-name bx-messenger-ajax"},attrs:{"data-entity":"network","data-networkId":c.USER[f].NETWORK_ID},html:c.USER[f].NAME})}else if(c.USER[f].BOT_ID){if(this.BXIM.messenger.users[c.USER[f].BOT_ID]){c.USER[f].NAME=this.BXIM.messenger.users[c.USER[f].BOT_ID].name;c.USER[f].AVATAR=this.BXIM.messenger.users[c.USER[f].BOT_ID].avatar}else if(!this.BXIM.messenger.bot[c.USER[f].BOT_ID]){c.USER[f].AVATAR=""}B=s.create("span",{props:{className:"bx-messenger-attach-user-name bx-messenger-ajax"},attrs:{"data-entity":"user","data-userId":c.USER[f].BOT_ID},html:c.USER[f].NAME})}else if(c.USER[f].USER_ID){B=s.create("span",{props:{className:"bx-messenger-attach-user-name bx-messenger-ajax "+(c.USER[f].USER_ID==this.BXIM.userId?"bx-messenger-ajax-self":"")},attrs:{"data-entity":"user","data-userId":c.USER[f].USER_ID},html:c.USER[f].NAME});if(this.BXIM.messenger.users[c.USER[f].USER_ID]){c.USER[f].AVATAR=this.BXIM.messenger.users[c.USER[f].USER_ID].avatar}}else if(c.USER[f].CHAT_ID){B=s.create("span",{props:{className:"bx-messenger-attach-user-name bx-messenger-ajax"},attrs:{"data-entity":"chat","data-chatId":c.USER[f].CHAT_ID},html:c.USER[f].NAME})}else if(c.USER[f].LINK){B=s.create("a",{attrs:{href:s.util.htmlspecialcharsback(c.USER[f].LINK),target:"_blank"},props:{className:"bx-messenger-attach-user-name"},html:c.USER[f].NAME})}else{B=s.create("span",{props:{className:"bx-messenger-attach-user-name"},html:c.USER[f].NAME})}var X="user";if(c.USER[f].AVATAR_TYPE=="CHAT"){X="chat"}else if(c.USER[f].AVATAR_TYPE=="BOT"){X="bot"}var b=s.create("span",{props:{className:"bx-messenger-attach-user"},children:[s.create("span",{props:{className:"bx-messenger-attach-user-avatar"},children:[c.USER[f].AVATAR?s.create("img",{attrs:{src:s.util.htmlspecialcharsback(this.formatUrl(c.USER[f].AVATAR))},props:{className:"bx-messenger-attach-user-avatar-img"}}):s.create("span",{attrs:{style:"background-color: "+h},props:{className:"bx-messenger-attach-user-avatar-img bx-messenger-attach-"+X+"-avatar-default "}})]}),B]});u.push(b)}M=s.create("span",{props:{className:"bx-messenger-attach-users"},children:u})}else if(c.LINK&&c.LINK.length>0){var E=[];for(var f=0;f<c.LINK.length;f++){var B=s.create("span",{props:{className:"bx-messenger-attach-link-name"},html:c.LINK[f].NAME?c.LINK[f].NAME:c.LINK[f].LINK});if(c.LINK[f].NETWORK_ID){B=s.create("span",{props:{className:"bx-messenger-ajax "},attrs:{"data-entity":"network","data-networkId":c.LINK[f].NETWORK_ID},children:[B]})}else if(c.LINK[f].USER_ID){B=s.create("span",{props:{className:"bx-messenger-ajax "+(c.LINK[f].USER_ID==this.BXIM.userId?"bx-messenger-ajax-self":"")},attrs:{"data-entity":"user","data-userId":c.LINK[f].USER_ID},children:[B]})}else if(c.LINK[f].CHAT_ID){B=s.create("span",{props:{className:"bx-messenger-ajax"},attrs:{"data-entity":"chat","data-chatId":c.LINK[f].CHAT_ID},children:[B]})}else{B=s.create("span",{props:{className:"bx-messenger-attach-link-name"},children:[s.create("a",{attrs:{href:s.util.htmlspecialcharsback(c.LINK[f].LINK),target:"_blank"},html:c.LINK[f].NAME?c.LINK[f].NAME:c.LINK[f].LINK})]})}var C=null;if(c.LINK[f].DESC){C=s.create("span",{props:{className:"bx-messenger-attach-link-desc"},html:c.LINK[f].DESC})}var _=null;if(c.LINK[f].HTML){_=s.create("div",{props:{className:"bx-messenger-attach-link-html"},html:c.LINK[f].HTML});var S=s.create("span",{props:{className:"bx-messenger-attach-link"+(c.LINK[f].PREVIEW?" bx-messenger-attach-link-with-preview":"")},children:[B,C,_]})}else if(c.LINK[f].PREVIEW){_=s.create("span",{props:{className:"bx-messenger-file-image-src"},children:[s.create("img",{attrs:{src:s.util.htmlspecialcharsback(c.LINK[f].PREVIEW),onerror:"BX.MessengerCommon.hideErrorImage(this, true)"},props:{className:"bx-messenger-file-image-text"}})]});var S=s.create("div",{children:[B,C,_]})}else{var S=s.create("div",{children:[B,C]})}E.push(S)}M=s.create("span",{props:{className:"bx-messenger-attach-links"},children:E})}else if(c.RICH_LINK&&c.RICH_LINK.length>0){var E=[];for(var f=0;f<c.RICH_LINK.length;f++){var T=null;var B=s.create("span",{props:{className:"bx-messenger-attach-rich-link-name"},html:c.RICH_LINK[f].NAME?c.RICH_LINK[f].NAME:c.RICH_LINK[f].LINK});if(c.RICH_LINK[f].NETWORK_ID){B=s.create("span",{props:{className:"bx-messenger-ajax "},attrs:{"data-entity":"network","data-networkId":c.RICH_LINK[f].NETWORK_ID},children:[B]})}else if(c.RICH_LINK[f].USER_ID){B=s.create("span",{props:{className:"bx-messenger-ajax "+(c.RICH_LINK[f].USER_ID==this.BXIM.userId?"bx-messenger-ajax-self":"")},attrs:{"data-entity":"user","data-userId":c.RICH_LINK[f].USER_ID},children:[B]})}else if(c.RICH_LINK[f].CHAT_ID){B=s.create("span",{props:{className:"bx-messenger-ajax"},attrs:{"data-entity":"chat","data-chatId":c.RICH_LINK[f].CHAT_ID},children:[B]})}else{if(c.RICH_LINK[f].HTML){B=s.create("span",{props:{className:"bx-messenger-attach-rich-link-name"},children:[s.create("a",{attrs:{href:s.util.htmlspecialcharsback(c.RICH_LINK[f].LINK),target:"_blank"},html:c.RICH_LINK[f].NAME?c.RICH_LINK[f].NAME:c.RICH_LINK[f].LINK})]})}T=s.create("div",{props:{className:"bx-messenger-attach-rich-link-source"},html:s.create("a",{attrs:{href:s.util.htmlspecialcharsback(c.RICH_LINK[f].LINK)}}).hostname})}var C=null;if(c.RICH_LINK[f].DESC){C=s.create("span",{props:{className:"bx-messenger-attach-rich-link-desc"},html:c.RICH_LINK[f].DESC})}var _=null;if(c.RICH_LINK[f].HTML){_=s.create("div",{props:{className:"bx-messenger-attach-rich-link-html"},html:c.RICH_LINK[f].HTML});var S=s.create("span",{props:{className:"bx-messenger-attach-rich-link"+(c.RICH_LINK[f].PREVIEW?" bx-messenger-attach-rich-link-with-preview":"")},children:[B,C,_]})}else if(c.RICH_LINK[f].PREVIEW){_=s.create("span",{props:{className:"bx-messenger-file-image-src"},children:[s.create("img",{attrs:{src:s.util.htmlspecialcharsback(c.RICH_LINK[f].PREVIEW),onerror:"BX.MessengerCommon.hideErrorImage(this, true)"},props:{className:"bx-messenger-file-image-text"}})]});var S=s.create("a",{attrs:{href:s.util.htmlspecialcharsback(c.RICH_LINK[f].LINK),target:"_blank"},props:{className:"bx-messenger-file-image"},children:[_,s.create("span",{props:{className:"bx-messenger-attach-rich-link-panel"},children:[B,C,T]})]})}else{var S=s.create("a",{attrs:{href:s.util.htmlspecialcharsback(c.RICH_LINK[f].LINK),target:"_blank"},props:{className:"bx-messenger-file-image bx-messenger-file-image-without-preview"},children:[s.create("span",{props:{className:"bx-messenger-attach-rich-link-panel"},children:[B,C,T]})]})}E.push(S)}M=s.create("span",{props:{className:"bx-messenger-attach-rich-links"},children:E})}else if(c.MESSAGE&&c.MESSAGE.length>0){M=s.create("span",{props:{className:"bx-messenger-attach-message"},html:this.decodeBbCode(c.MESSAGE)})}else if(c.HTML&&c.HTML.length>0){M=s.create("span",{props:{className:"bx-messenger-attach-message"},html:c.HTML})}else if(c.GRID&&c.GRID.length>0){var v=[];for(var f=0;f<c.GRID.length;f++){var y=this.decodeBbCode(c.GRID[f].VALUE);if(c.GRID[f].USER_ID){y='<span class="bx-messenger-ajax '+(c.GRID[f].USER_ID==this.BXIM.userId?"bx-messenger-ajax-self":"")+'" data-entity="user" data-userId="'+c.GRID[f].USER_ID+'">'+y+"</span>"}else if(c.GRID[f].CHAT_ID){y='<span class="bx-messenger-ajax" data-entity="chat" data-chatId="'+c.GRID[f].CHAT_ID+'">'+y+"</span>"}else if(c.GRID[f].LINK){y='<a href="'+c.GRID[f].LINK+'" target="_blank">'+y+"</a>"}var A=c.GRID[f].WIDTH?"width: "+c.GRID[f].WIDTH+"px":"";var L=c.GRID[f].HEIGHT?"max-height: "+c.GRID[f].HEIGHT+"px;":"";var N=0;var x=null;var R=null;if(L){R=s.create("div",{props:{className:"bx-messenger-attach bx-messenger-attach-block-name"},attrs:{style:"position: absolute; left: -1000px;"+(c.GRID[f].DISPLAY=="ROW"?A:"")},html:y});document.body.appendChild(R);if(c.GRID[f].HEIGHT>=R.offsetHeight){L=""}else{N=R.offsetHeight}s.remove(R)}if(L){x=s.create("span",{props:{className:"bx-messenger-attach-block bx-messenger-attach-block-"+c.GRID[f].DISPLAY.toLowerCase()+" bx-messenger-attach-block-spoiler"},attrs:{style:c.GRID[f].DISPLAY=="LINE"||c.GRID[f].DISPLAY=="CARD"?A:""},children:[s.create("div",{props:{className:"bx-messenger-attach-block-name"},attrs:{style:c.GRID[f].DISPLAY=="ROW"?A:""},children:[s.create("span",{props:{className:"bx-messenger-attach-block-spoiler-name"},html:c.GRID[f].NAME}),s.create("span",{props:{className:"bx-messenger-attach-block-spoiler-icon"}})]}),s.create("div",{props:{className:"bx-messenger-attach-block-value"},attrs:{style:L+(c.GRID[f].COLOR?"color: "+c.GRID[f].COLOR:""),"data-min-height":c.GRID[f].HEIGHT,"data-max-height":N},children:[s.create("span",{html:y})]})]})}else{var D=c.GRID[f].DISPLAY;if((D=="row"||D=="column")&&(!c.GRID[f].NAME||!c.GRID[f].VALUE)){D="BLOCK"}x=s.create("span",{props:{className:"bx-messenger-attach-block bx-messenger-attach-block-"+D.toLowerCase()},attrs:{style:D=="LINE"||D=="CARD"?A:""},children:[!c.GRID[f].NAME?null:s.create("div",{props:{className:"bx-messenger-attach-block-name"},attrs:{style:D=="ROW"?A:""},html:c.GRID[f].NAME}),!c.GRID[f].VALUE?null:s.create("div",{props:{className:"bx-messenger-attach-block-value"},attrs:{style:c.GRID[f].COLOR?"color: "+c.GRID[f].COLOR:""},html:y})]})}v.push(x)}M=s.create("span",{props:{className:"bx-messenger-attach-blocks"},children:v})}else if(c.DELIMITER){var w="";if(c.DELIMITER.SIZE){w+="width: "+c.DELIMITER.SIZE+"px;"}if(c.DELIMITER.COLOR){w+="background-color: "+c.DELIMITER.COLOR}if(w){w={style:w}}M=s.create("span",{props:{className:"bx-messenger-attach-delimiter"},attrs:w})}else if(c.IMAGE&&c.IMAGE.length>0){var O=[];for(var f=0;f<c.IMAGE.length;f++){if(!c.IMAGE[f].NAME){c.IMAGE[f].NAME=""}if(!c.IMAGE[f].PREVIEW){c.IMAGE[f].PREVIEW=c.IMAGE[f].LINK}var k=s.create("a",{props:{className:"bx-messenger-file-image-src"},attrs:{href:s.util.htmlspecialcharsback(c.IMAGE[f].LINK),target:"_blank",title:c.IMAGE[f].NAME},children:[s.create("img",{attrs:{src:s.util.htmlspecialcharsback(c.IMAGE[f].PREVIEW),onerror:"BX.MessengerCommon.hideErrorImage(this)"},props:{className:"bx-messenger-attach-image bx-messenger-file-image-link"}})]});O.push(k)}M=s.create("span",{props:{className:"bx-messenger-attach-images"},children:O})}else if(c.FILE&&c.FILE.length>0){var P=[];for(var f=0;f<c.FILE.length;f++){var U=c.FILE[f].NAME?c.FILE[f].NAME:c.FILE[f].LINK;if(this.isMobile()){if(U.length>20){U=U.substr(0,7)+"..."+U.substr(U.length-10,U.length)}}else{if(U.length>43){U=U.substr(0,20)+"..."+U.substr(U.length-20,U.length)}}U=s.create("span",{attrs:{title:c.FILE[f].NAME},props:{className:"bx-messenger-file-title"},children:[s.create("span",{props:{className:"bx-messenger-file-title-name"},html:U})]});var H=s.create("div",{props:{className:"bx-messenger-file"},children:[s.create("div",{props:{className:"bx-messenger-file-attrs"},children:[s.create("a",{props:{className:"bx-messenger-file-title-href"},attrs:{href:s.util.htmlspecialcharsback(c.FILE[f].LINK),target:"_blank"},children:[U]}),c.FILE[f].SIZE?s.create("span",{props:{className:"bx-messenger-file-size"},html:s.UploaderUtils.getFormattedSize(c.FILE[f].SIZE)}):null]}),s.create("div",{props:{className:"bx-messenger-file-download"},children:[s.create("a",{attrs:{href:s.util.htmlspecialcharsback(c.FILE[f].LINK),target:"_blank"},props:{className:"bx-messenger-file-download-link bx-messenger-file-download-pc"},html:s.message("IM_F_DOWNLOAD")})]})]});P.push(H)}M=s.create("span",{props:{className:"bx-messenger-attach-files"},children:P})}p.push(M)}if(p.length>0){o.push(s.create("div",{props:{className:"bx-messenger-attach"},attrs:{style:h=="transparent"?"border: 0; padding-left: 0;":"border-color: "+h},children:p}))}}return o};t.prototype.diskDrawFiles=function(e,t,r){if(!this.BXIM.disk.enable||!e||!t)return[];var i=[];if(typeof t!="object"){i.push(t)}else{i=t}r=r||{};var a=true;var n=[];for(var o=0;o<i.length;o++){var l=this.BXIM.disk.files[e]&&this.BXIM.disk.files[e][i[o]];if(!l){var l={id:i[o],chatId:e};var m=r.boxId?r.boxId:"im-file";n.push(s.create("div",{attrs:{id:m+"-"+l.id,"data-chatId":l.chatId,"data-fileId":l.id,"data-boxId":m},props:{className:"bx-messenger-file"},children:[s.create("span",{props:{className:"bx-messenger-file-deleted"},html:s.message("IM_F_DELETED")})]}));continue}if(this.isDesktop()){if(!this.BXIM.desktop.enableInVersion(43)){if(l.type=="audio"){l.viewerAttrs=null}}if(!this.BXIM.desktop.enableInVersion(47)){if(l.type=="video"){l.viewerAttrs=null}}}if(r.status){if(typeof r.status!="object"){r.status=[r.status]}if(!s.util.in_array(l.status,r.status)){continue}}var h=null;var g=false;if(l.preview||l.urlPreview){var p=null;if(l.preview&&typeof l.preview!="string"){p=l.preview;if(l.urlPreview){l.preview=""}}else{p=s.create("img",{attrs:{src:this.formatUrl(l.urlPreview?l.urlPreview:l.preview),height:l.image?l.image.height>400?"400":l.image.height:"auto"},props:{className:"bx-messenger-file-image-text bx-messenger-file-image-type-"+l.type},events:{load:function(){this.parentNode.style.background="#fff";this.removeAttribute("height")}}})}if(a){var I=null;if(l.type=="video"){if(this.isMobile()){I=s.create("div",{props:{className:"bx-messenger-file-image-type-video-button"},children:[s.create("div",{events:{click:s.delegate(function(e){s.localStorage.set("impmh",true,1);app.openDocument({url:this.formatUrl(l.urlDownload),filename:l.name.toString().toLowerCase()});return s.PreventDefault(e)},this)},props:{className:"bx-messenger-file-image-type-video-button-play"}})]})}else{I=s.create("div",{props:{className:"bx-messenger-file-image-type-video-button"},children:[s.create("div",{props:{className:"bx-messenger-file-image-type-video-button-play"}})]})}}if(l.type=="video"&&l.urlDownload||l.type!="video"&&l.urlPreview&&l.urlShow){if(this.isMobile()){h=s.create("div",{props:{className:"bx-messenger-file-preview"},children:[s.create("span",{props:{className:"bx-messenger-file-image"},children:[s.create("span",{events:{click:s.delegate(function(){var e=this.BXIM.disk.files[s.proxy_context.dataset.chatid][s.proxy_context.dataset.diskid];var t=s.findParent(s.proxy_context,{className:"bx-messenger-content-item"});if(t&&t.getAttribute("data-messageid").indexOf("temp")==0){return false}if(e.type=="image"){this.BXIM.messenger.openPhotoGallery(e.urlShow);s.localStorage.set("impmh",true,1)}else{s.localStorage.set("impmh",true,1);app.openDocument({url:e.urlShow,filename:e.name.toString().toLowerCase()})}},this)},attrs:{"data-chatId":l.chatId,"data-diskId":l.id},props:{className:"bx-messenger-file-image-src"},children:[I,p]})]})]})}else{h=s.create("div",{props:{className:"bx-messenger-file-preview"},children:[s.create("span",{props:{className:"bx-messenger-file-image"},children:[s.create("a",{dataset:l.viewerAttrs,attrs:{href:this.formatUrl(l.urlShow),target:"_blank"},props:{className:"bx-messenger-file-image-src"},children:[I,p]})]})]});g=true}}else{h=s.create("div",{props:{className:"bx-messenger-file-preview"},children:[s.create("span",{props:{className:"bx-messenger-file-image"},children:[s.create("span",{props:{className:"bx-messenger-file-image-src"},children:[p]})]})]})}}else{h=s.create("div",{props:{className:"bx-messenger-file-preview"},children:[s.create("span",{props:{className:"bx-messenger-file-image"},children:[s.create("span",{props:{className:"bx-messenger-file-image-src"},children:[p]})]})]})}}var d=l.name;if(this.isMobile()){if(d.length>20){d=d.substr(0,7)+"..."+d.substr(d.length-10,d.length)}}else{if(d.length>43){d=d.substr(0,20)+"..."+d.substr(d.length-20,d.length)}}if(l.type==="audio"&&(l.viewerAttrs||this.isMobile())){c=s.create("div",{props:{className:"bx-messenger-audioplayer-container bx-messenger-audioplayer-container-dark"},children:[s.create("div",{props:{className:"bx-messenger-audioplayer-controls-container"},children:[s.create("div",{props:{className:"bx-messenger-audioplayer-control bx-messenger-audioplayer-control-play"}})]}),s.create("div",{props:{className:"bx-messenger-audioplayer-timeline-container"},children:[s.create("div",{props:{className:"bx-messenger-audioplayer-track-mask"}}),s.create("div",{props:{className:"bx-messenger-audioplayer-track"}})]})],events:!this.isMobile()?null:{click:function(){s.localStorage.set("impmh",true,1);app.openDocument({url:l.urlDownload,filename:l.name.toString().toLowerCase()})}},dataset:l.viewerAttrs})}else{var c=s.create("span",{attrs:{title:l.name},props:{className:"bx-messenger-file-title"},children:[s.create("span",{props:{className:"bx-messenger-file-title-name"},html:d})]});if(a&&(l.urlShow||l.urlDownload)){if(this.isMobile())c=s.create("span",{props:{className:"bx-messenger-file-title-href"},events:{click:function(){s.localStorage.set("impmh",true,1);app.openDocument({url:l.urlDownload,filename:l.name.toString().toLowerCase()})}},children:[c]});else c=s.create("a",{dataset:g?null:l.viewerAttrs,props:{className:"bx-messenger-file-title-href"},attrs:{href:this.formatUrl(l.urlShow?l.urlShow:l.urlDownload),target:"_blank"},children:[c]})}c=s.create("div",{props:{className:"bx-messenger-file-attrs"},children:[c,s.create("span",{props:{className:"bx-messenger-file-size"},html:s.UploaderUtils.getFormattedSize(l.size)})]})}var M=null;if(l.status=="done"){if(!this.isMobile()){M=s.create("div",{props:{className:"bx-messenger-file-download"},children:[!l.urlDownload||!a?null:s.create("a",{attrs:{href:this.formatUrl(l.urlDownload),target:"_blank"},props:{className:"bx-messenger-file-download-link bx-messenger-file-download-pc"},html:s.message("IM_F_DOWNLOAD")}),!l.urlDownload||!this.BXIM.disk.enable||this.BXIM.context=="LINES"?null:s.create("span",{props:{className:"bx-messenger-file-download-link bx-messenger-file-download-disk"},html:s.message("IM_F_DOWNLOAD_DISK"),events:{click:s.delegate(function(){var e=s.proxy_context.parentNode.parentNode.getAttribute("data-chatId");var t=s.proxy_context.parentNode.parentNode.getAttribute("data-fileId");var r=s.proxy_context.parentNode.parentNode.getAttribute("data-boxId");this.BXIM.disk.saveToDisk(e,t,{boxId:r})},this)}})]})}else{M=s.create("div",{props:{className:"bx-messenger-file-download"},children:[]})}}else if(l.status=="upload"){var u={};var f="";var B=null;var X="";var b="";if(l.authorId==this.BXIM.userId&&l.progress>=0){b=s.message("IM_F_UPLOAD_2").replace("#PERCENT#",l.progress);u={width:l.progress+"%"};B=s.create("span",{attrs:{title:s.message("IM_F_CANCEL")},props:{className:"bx-messenger-file-delete"}})}else{b=s.message("IM_F_UPLOAD");X=" bx-messenger-file-progress-infinite"}M=s.create("div",{props:{className:"bx-messenger-progress-box"},children:[s.create("span",{attrs:{title:b},props:{className:"bx-messenger-file-progress"},children:[s.create("span",{props:{className:"bx-messenger-file-progress-line"+X},style:u})]}),B]})}else if(l.status=="error"){M=s.create("span",{props:{className:"bx-messenger-file-status-error"},html:l.errorText?l.errorText:s.message("IM_F_ERROR")})}if(!M)return false;if(i.length==1&&r.showInner=="Y"){n=[h,c,M]}else{var m=r.boxId?r.boxId:"im-file";n.push(s.create("div",{attrs:{id:m+"-"+l.id,"data-chatId":l.chatId,"data-fileId":l.id,"data-boxId":m},props:{className:"bx-messenger-file"},children:[h,c,M]}))}}return n};t.prototype.diskRedrawFile=function(e,t,r){r=r||{};var i=r.boxId?r.boxId:"im-file";var a=s(i+"-"+t);if(a){var n=this.diskDrawFiles(e,t,{showInner:"Y",boxId:i});if(n){a.innerHTML="";s.adjust(a,{children:n})}}};t.prototype.diskChatDialogFileInited=function(t,r,i){i.messageText=i.messageText||"";var a=i.form.CHAT_ID.value;if(!this.BXIM.disk.files[a])this.BXIM.disk.files[a]={};this.BXIM.disk.files[a][t]={id:t,templateId:t,chatId:a,date:new Date,type:r.isImage?"image":"file",preview:r.isImage?r.canvas:"",name:r.name,size:r.file.size,status:"upload",progress:-1,authorId:this.BXIM.userId,authorName:this.BXIM.messenger.users[this.BXIM.userId].name,urlPreview:"",urlShow:"",urlDownload:""};var n=0;if(this.BXIM.messenger.chat[a]&&this.BXIM.messenger.chat[a].type!="private"){n="chat"+a}else{for(var o in this.BXIM.messenger.userChat){if(this.BXIM.messenger.userChat[o]==a){n=o;break}}}if(!n)return false;var l="N";if(n.toString().substr(0,4)=="chat"&&this.BXIM.messenger.linesSilentMode&&this.BXIM.messenger.linesSilentMode[a]){l="Y"}var m=[this.BXIM.disk.files[a][t].id];var h="file";var g="tempFile"+this.BXIM.disk.fileTmpId+(new Date).getTime();this.BXIM.messenger.message[g]={id:g,chatId:a,senderId:this.BXIM.userId,recipientId:n,date:new Date,text:s.MessengerCommon.prepareText(i.messageText,true),params:{FILE_ID:m,CLASS:l=="Y"?"bx-messenger-content-item-system":""}};if(!this.BXIM.messenger.showMessage[n])this.BXIM.messenger.showMessage[n]=[];this.BXIM.messenger.showMessage[n].push(g);s.MessengerCommon.drawMessage(n,this.BXIM.messenger.message[g]);s.MessengerCommon.drawProgessMessage(g);this.recentListAdd({id:g,date:new Date,skipDateCheck:true,recipientId:n,senderId:this.BXIM.userId,text:i.messageText?i.messageText:"["+s.message("IM_F_FILE")+"]",userId:n,userIsChat:n.toString().substr(0,4)=="chat",params:{}},true);this.BXIM.messenger.popupMessengerFileFormRegChatId.value=a;r.regTmpMessageId=this.BXIM.messenger.popupMessengerFileFormRegMessageId.value=g;r.regHiddenMessageId=this.BXIM.messenger.popupMessengerFileFormRegMessageHidden.value=l;r.regParams=this.BXIM.messenger.popupMessengerFileFormRegParams.value=JSON.stringify({FILE_TMP_ID:this.BXIM.disk.files[a][t].id,TEXT:i.messageText});this.BXIM.disk.OldBeforeUnload=e.onbeforeunload;e.onbeforeunload=function(){return s.message("IM_F_EFP")};this.BXIM.disk.fileTmpId++;i.messageText=""};t.prototype.diskChatDialogFileRegister=function(t,r){r=r||"";clearTimeout(this.BXIM.disk.timeout[t]);this.BXIM.disk.timeout[t]=setTimeout(s.delegate(function(){var i=0;if(this.BXIM.messenger.chat[t]&&this.BXIM.messenger.chat[t].type!="private"){i="chat"+t}else{for(var a in this.BXIM.messenger.userChat){if(this.BXIM.messenger.userChat[a]==t){i=a;break}}}if(!i)return false;var n="N";if(i.toString().substr(0,4)=="chat"&&this.BXIM.messenger.linesSilentMode&&this.BXIM.messenger.linesSilentMode[t]){n="Y"}var o=[];var l="file";for(var m in this.BXIM.disk.filesRegister[t]){l=this.BXIM.disk.filesRegister[t][m].type;o.push(m)}var h="tempFile"+this.BXIM.disk.fileTmpId;this.BXIM.messenger.message[h]={id:h,chatId:t,senderId:this.BXIM.userId,recipientId:i,date:new Date,text:s.MessengerCommon.prepareText(r,true),params:{FILE_ID:o,CLASS:n=="Y"?"bx-messenger-content-item-system":""}};if(!this.BXIM.messenger.showMessage[i])this.BXIM.messenger.showMessage[i]=[];this.BXIM.messenger.showMessage[i].push(h);s.MessengerCommon.drawMessage(i,this.BXIM.messenger.message[h]);s.MessengerCommon.drawProgessMessage(h);this.recentListAdd({id:h,date:new Date,skipDateCheck:true,recipientId:i,senderId:this.BXIM.userId,text:r?r:"["+s.message("IM_F_FILE")+"]",userId:i,userIsChat:i.toString().substr(0,4)=="chat",params:{}},true);this.BXIM.messenger.sendMessageFlag++;this.BXIM.messenger.popupMessengerFileFormInput.setAttribute("disabled",true);this.BXIM.disk.OldBeforeUnload=e.onbeforeunload;e.onbeforeunload=function(){return s.message("IM_F_EFP")};s.ajax({url:this.BXIM.pathToFileAjax+"?FILE_REGISTER&V="+this.BXIM.revision+"&logTag="+s.MessengerCommon.getLogTrackingParams({name:"im.file.register",dialog:s.MessengerCommon.getDialogDataForTracking(i),data:{timFileType:l}}),method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_FILE_REGISTER:"Y",CHAT_ID:t,RECIPIENT_ID:i,TEXT:r,MESSAGE_TMP_ID:h,FILES:JSON.stringify(this.BXIM.disk.filesRegister[t]),OL_SILENT:n,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(r){if(r.ERROR!=""){this.BXIM.messenger.sendMessageFlag--;delete this.BXIM.messenger.message[h];s.MessengerCommon.drawTab(i);e.onbeforeunload=this.BXIM.disk.OldBeforeUnload;this.BXIM.disk.filesRegister[t]={};if(this.BXIM.disk.formAgents["imDialog"]["clear"])this.BXIM.disk.formAgents["imDialog"].clear();return false}this.BXIM.messenger.sendMessageFlag--;var a=[];var n={};for(var o in r.FILE_ID){var l=r.FILE_ID[o];delete this.BXIM.disk.filesRegister[r.CHAT_ID][l.TMP_ID];if(parseInt(l.FILE_ID)>0){n[l.TMP_ID]=l.FILE_ID;this.BXIM.disk.filesProgress[l.TMP_ID]=l.FILE_ID;this.BXIM.disk.filesMessage[l.TMP_ID]=r.MESSAGE_ID;this.BXIM.disk.files[r.CHAT_ID][l.FILE_ID]={};for(var m in this.BXIM.disk.files[r.CHAT_ID][l.TMP_ID])this.BXIM.disk.files[r.CHAT_ID][l.FILE_ID][m]=this.BXIM.disk.files[r.CHAT_ID][l.TMP_ID][m];this.BXIM.disk.files[r.CHAT_ID][l.FILE_ID]["id"]=l.FILE_ID;delete this.BXIM.disk.files[r.CHAT_ID][l.TMP_ID];this.BXIM.disk.files[r.CHAT_ID][l.FILE_ID]["name"]=l.FILE_NAME;if(s("im-file-"+l.TMP_ID)){s("im-file-"+l.TMP_ID).setAttribute("data-fileId",l.FILE_ID);s("im-file-"+l.TMP_ID).id="im-file-"+l.FILE_ID;s.MessengerCommon.diskRedrawFile(r.CHAT_ID,l.FILE_ID)}a.push(l.FILE_ID)}else{this.BXIM.disk.files[r.CHAT_ID][l.TMP_ID]["status"]="error";s.MessengerCommon.diskRedrawFile(r.CHAT_ID,l.TMP_ID)}}this.BXIM.messenger.message[r.MESSAGE_ID]=s.clone(this.BXIM.messenger.message[r.MESSAGE_TMP_ID]);this.BXIM.messenger.message[r.MESSAGE_ID]["id"]=r.MESSAGE_ID;this.BXIM.messenger.message[r.MESSAGE_ID]["params"]["FILE_ID"]=a;if(r.MESSAGE_TEXT){this.BXIM.messenger.message[r.MESSAGE_ID]["text"]=r.MESSAGE_TEXT}if(this.BXIM.messenger.popupMessengerLastMessage==r.MESSAGE_TMP_ID)this.BXIM.messenger.popupMessengerLastMessage=r.MESSAGE_ID;delete this.BXIM.messenger.message[r.MESSAGE_TMP_ID];var g=s.util.array_search(""+r.MESSAGE_TMP_ID+"",this.BXIM.messenger.showMessage[r.RECIPIENT_ID]);if(this.BXIM.messenger.showMessage[r.RECIPIENT_ID][g])this.BXIM.messenger.showMessage[r.RECIPIENT_ID][g]=""+r.MESSAGE_ID+"";if(s("im-message-"+r.MESSAGE_TMP_ID)){if(r.MESSAGE_TEXT){s("im-message-"+r.MESSAGE_TMP_ID).innerHTML=r.MESSAGE_TEXT}s("im-message-"+r.MESSAGE_TMP_ID).id="im-message-"+r.MESSAGE_ID;var p=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-messageid":""+r.MESSAGE_TMP_ID}},true);if(p){p.setAttribute("data-messageid",""+r.MESSAGE_ID+"");if(p.getAttribute("data-blockmessageid")==""+r.MESSAGE_TMP_ID)p.setAttribute("data-blockmessageid",""+r.MESSAGE_ID+"")}else{var I=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-blockmessageid":""+r.MESSAGE_TMP_ID}},true);if(I){I.setAttribute("data-blockmessageid",""+r.MESSAGE_ID+"")}}var d=s.findChildByClassName(p,"bx-messenger-content-item-date");if(d)d.innerHTML=s.MessengerCommon.formatDate(this.BXIM.messenger.message[r.MESSAGE_ID].date,s.MessengerCommon.getDateFormatType("MESSAGE"))}s.MessengerCommon.clearProgessMessage(r.MESSAGE_ID);if(this.BXIM.messenger.history[r.RECIPIENT_ID])this.BXIM.messenger.history[r.RECIPIENT_ID].push(r.MESSAGE_ID);else this.BXIM.messenger.history[r.RECIPIENT_ID]=[r.MESSAGE_ID];var c="N";if(r.RECIPIENT_ID.toString().substr(0,4)=="chat"&&this.BXIM.messenger.linesSilentMode&&this.BXIM.messenger.linesSilentMode[r.CHAT_ID]){c="Y"}this.BXIM.messenger.popupMessengerFileFormRegChatId.value=r.CHAT_ID;this.BXIM.messenger.popupMessengerFileFormRegMessageId.value=r.MESSAGE_ID;this.BXIM.messenger.popupMessengerFileFormRegMessageHidden.value=c;this.BXIM.messenger.popupMessengerFileFormRegParams.value=JSON.stringify(n);this.BXIM.disk.formAgents["imDialog"].submit();this.BXIM.messenger.popupMessengerFileFormInput.removeAttribute("disabled")},this),onfailure:s.delegate(function(){this.BXIM.messenger.sendMessageFlag--;delete this.BXIM.messenger.message[h];this.BXIM.disk.filesRegister[t]={};s.MessengerCommon.drawTab(i);e.onbeforeunload=this.BXIM.disk.OldBeforeUnload;if(this.BXIM.disk.formAgents["imDialog"]["clear"])this.BXIM.disk.formAgents["imDialog"].clear()},this)});this.BXIM.disk.fileTmpId++},this),500)};t.prototype.diskChatDialogFileStart=function(e,t,r,i){var a=r.streams.packages.getItem(i).data;var n=a.CHAT_ID;var o=this.BXIM.disk.files[n][e.id].id;if(!this.BXIM.disk.files[a.CHAT_ID][o])return false;this.BXIM.disk.files[n][o].progress=parseInt(t);s.MessengerCommon.diskRedrawFile(n,o)};t.prototype.diskChatDialogFileProgress=function(e,t,r,i){var a=r.streams.packages.getItem(i).data;var n=a.CHAT_ID;var o=this.BXIM.disk.files[n][e.id].id;if(!this.BXIM.disk.files[a.CHAT_ID][o])return false;this.BXIM.disk.files[n][o].progress=parseInt(t);s.MessengerCommon.diskRedrawFile(n,o)};t.prototype.diskChatDialogFileDone=function(s,t,r,i){e.onbeforeunload=this.BXIM.disk.OldBeforeUnload};t.prototype.diskChatDialogFileError=function(t,r,i,a){var n=i.streams.packages.getItem(a).data;this.clearProgessMessage(n.REG_MESSAGE_ID);var o=n.CHAT_ID;var l=this.BXIM.disk.files[o][t.id].id;if(!this.BXIM.disk.files[n.CHAT_ID][l])return false;t.deleteFile();this.BXIM.disk.files[n.CHAT_ID][l].status="error";this.BXIM.disk.files[n.CHAT_ID][l].errorText=r.error;s.MessengerCommon.diskRedrawFile(n.CHAT_ID,l);e.onbeforeunload=this.BXIM.disk.OldBeforeUnload};t.prototype.diskChatDialogUploadError=function(t,r,i){var a=t.post.REG_PARAMS?JSON.parse(t.post.REG_PARAMS):{};var n={};for(var o in a){if(this.BXIM.disk.filesMessage[o]){delete this.BXIM.disk.filesMessage[o]}if(this.BXIM.disk.files[t.post.REG_CHAT_ID]){if(this.BXIM.disk.files[t.post.REG_CHAT_ID][a[o]]){this.BXIM.disk.files[t.post.REG_CHAT_ID][a[o]].status="error";s.MessengerCommon.diskRedrawFile(t.post.REG_CHAT_ID,a[o])}if(this.BXIM.disk.files[t.post.REG_CHAT_ID][o]){this.BXIM.disk.files[t.post.REG_CHAT_ID][o].status="error";s.MessengerCommon.diskRedrawFile(t.post.REG_CHAT_ID,o)}}delete this.BXIM.disk.filesProgress[o]}e.onbeforeunload=this.BXIM.disk.OldBeforeUnload;s.MessengerCommon.drawTab(this.getRecipientByChatId(t.post.REG_CHAT_ID))};t.prototype.phoneCheckDesktop=function(e){e=e===true;var t=new s.Promise;if(e&&this.isMobile()){t.resolve();return t}s.desktopUtils.runningCheck(function(){t.reject()},function(){t.resolve()});return t};t.prototype.pullPhoneEvent=function(){if(this.BXIM.options.frameMode){return false}var e=s.delegate(function(e,t){if(this.isMobile()){t=e.params;e=e.command;console.info("pull info: ",e,t)}if(e=="invite"){if(this.isMobile()&&t["PULL_TIME_AGO"]&&t["PULL_TIME_AGO"]>30)return false;if(!this.BXIM.webrtc.phoneSupport())return false;if(this.BXIM.callController.hasActiveCall()){return false}if(s.localStorage.get("viInitedCall")||s.localStorage.get("viExternalCard")){return false}this.phoneCheckDesktop(true).then(function(){if(t.CRM&&t.CRM.FOUND){this.BXIM.webrtc.phoneCrm=t.CRM}else{this.BXIM.webrtc.phoneCrm={}}this.BXIM.webrtc.phonePortalCall=t.portalCall?true:false;if(this.BXIM.webrtc.phonePortalCall&&t.portalCallData){for(var e in t.portalCallData.users){t.portalCallData.users[e].last_activity_date=new Date(t.portalCallData.users[e].last_activity_date);t.portalCallData.users[e].mobile_last_date=new Date(t.portalCallData.users[e].mobile_last_date);t.portalCallData.users[e].idle=t.portalCallData.users[e].idle?new Date(t.portalCallData.users[e].idle):false;t.portalCallData.users[e].absent=t.portalCallData.users[e].absent?new Date(t.portalCallData.users[e].absent):false;this.BXIM.messenger.users[e]=t.portalCallData.users[e]}for(var e in t.portalCallData.hrphoto)this.BXIM.messenger.hrphoto[e]=t.portalCallData.hrphoto[e];t.callerId=this.BXIM.messenger.users[t.portalCallUserId].name;t.phoneNumber="";if(this.isMobile()){this.BXIM.webrtc.phoneCrm.FOUND="Y";this.BXIM.webrtc.phoneCrm.CONTACT={NAME:t.portalCallData.users[t.portalCallUserId].name,PHOTO:t.portalCallData.users[t.portalCallUserId].avatar}}}this.BXIM.webrtc.phoneCallConfig=t.config?t.config:{};this.BXIM.webrtc.phoneCallTime=0;this.BXIM.repeatSound("ringtone",5e3);if(this.isPage()){s.MessengerWindow.changeTab("im")}s.MessengerCommon.phoneCommand("wait",{CALL_ID:t.callId,DEBUG_INFO:this.getDebugInfo()});if(t.isTransfer){this.BXIM.webrtc.phoneTransferEnabled=true}this.BXIM.webrtc.phoneIncomingWait({chatId:t.chatId,callId:t.callId,callerId:t.callerId,lineNumber:t.lineNumber,companyPhoneNumber:t.phoneNumber,isCallback:t.isCallback,showCrmCard:t.showCrmCard,crmEntityType:t.crmEntityType,crmEntityId:t.crmEntityId,crmActivityId:t.crmActivityId,crmActivityEditUrl:t.crmActivityEditUrl,portalCall:t.portalCall,portalCallUserId:t.portalCallUserId,portalCallData:t.portalCallData,config:t.config})}.bind(this))}else if(e=="answer_self"){if(this.BXIM.webrtc.callSelfDisabled||this.BXIM.webrtc.phoneCallId!=t.callId)return false;this.BXIM.stopRepeatSound("ringtone");this.BXIM.stopRepeatSound("dialtone");this.BXIM.webrtc.callInit=false;this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.callAbort();if(this.isMobile()){this.BXIM.webrtc.callOverlayClose()}else{this.BXIM.webrtc.phoneCallView.close()}this.BXIM.webrtc.callInit=true;this.BXIM.webrtc.phoneCallId=t.callId}else if(e=="timeout"){if(this.BXIM.webrtc.phoneTransferCallId===t.callId){return this.BXIM.webrtc.errorInviteTransfer(t.failedCode,t.failedReason)}else if(this.BXIM.webrtc.phoneCallId!=t.callId){return false}clearInterval(this.BXIM.webrtc.phoneConnectedInterval);s.localStorage.remove("viInitedCall");var r=this.BXIM.webrtc.phoneCallExternal;this.BXIM.stopRepeatSound("ringtone");this.BXIM.stopRepeatSound("dialtone");this.BXIM.webrtc.callInit=false;var i=this.BXIM.webrtc.phoneNumber;this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.callAbort();if(this.BXIM.webrtc.phoneCallView){this.BXIM.webrtc.phoneCallView.setCallState(s.PhoneCallView.CallState.idle,{failedCode:t.failedCode})}if(r&&t.failedCode==486){if(this.isMobile()){this.BXIM.webrtc.callOverlayProgress("offline");this.BXIM.webrtc.callOverlayStatus(s.message("IM_PHONE_ERROR_BUSY_PHONE"));this.BXIM.webrtc.callOverlayState(s.MobileCallUI.form.state.CALLBACK)}else if(this.BXIM.webrtc.phoneCallView){this.BXIM.webrtc.phoneCallView.setProgress("offline");this.BXIM.webrtc.phoneCallView.setStatusText(s.message("IM_PHONE_ERROR_BUSY_PHONE"));this.BXIM.webrtc.phoneCallView.setUiState(s.PhoneCallView.UiState.sipPhoneError)}}else if(r&&t.failedCode==480){if(this.isMobile()){this.BXIM.webrtc.callOverlayProgress("error");this.BXIM.webrtc.callOverlayStatus(s.message("IM_PHONE_ERROR_NA_PHONE"));this.BXIM.webrtc.callOverlayState(s.MobileCallUI.form.state.FINISHED)}else if(this.BXIM.webrtc.phoneCallView){this.BXIM.webrtc.phoneCallView.setProgress("error");this.BXIM.webrtc.phoneCallView.setStatusText(s.message("IM_PHONE_ERROR_NA_PHONE"));this.BXIM.webrtc.phoneCallView.setUiState(s.PhoneCallView.UiState.sipPhoneError)}}else{if(this.isMobile()){this.BXIM.webrtc.callOverlayProgress("error");this.BXIM.webrtc.callOverlayStatus(s.message("IM_PHONE_DECLINE"));this.BXIM.webrtc.callOverlayState(s.MobileCallUI.form.state.FINISHED)}else if(this.BXIM.webrtc.phoneCallView){if(this.BXIM.webrtc.isCallListMode()){this.BXIM.webrtc.phoneCallView.setStatusText("");this.BXIM.webrtc.phoneCallView.setUiState(s.PhoneCallView.UiState.outgoing)}else{this.BXIM.webrtc.phoneCallView.setStatusText(s.message("IM_PHONE_END"));this.BXIM.webrtc.phoneCallView.setUiState(s.PhoneCallView.UiState.idle);this.BXIM.webrtc.phoneCallView.autoClose()}}}}else if(e=="outgoing"){if(this.isMobile()&&t["PULL_TIME_AGO"]&&t["PULL_TIME_AGO"]>30)return false;if(this.BXIM.webrtc.callInit&&(this.BXIM.webrtc.phoneNumber==t.phoneNumber||t.phoneNumber.indexOf(this.BXIM.webrtc.phoneNumber)>=0)){this.BXIM.webrtc.phoneCallDevice=t.callDevice=="PHONE"?"PHONE":"WEBRTC";this.BXIM.webrtc.phonePortalCall=t.portalCall?true:false;this.BXIM.webrtc.phoneNumber=t.phoneNumber;if(this.BXIM.webrtc.phoneCallExternal&&this.BXIM.webrtc.phoneCallDevice=="PHONE"){this.BXIM.webrtc.phoneCallView.setProgress("connect");this.BXIM.webrtc.phoneCallView.setStatusText(s.message("IM_PHONE_WAIT_ANSWER"))}this.BXIM.webrtc.phoneCallConfig=t.config?t.config:{};this.BXIM.webrtc.phoneCallId=t.callId;this.BXIM.webrtc.phoneCallTime=0;this.BXIM.webrtc.phoneCrm=t.CRM;if(this.isMobile()){this.BXIM.webrtc.callOverlayDrawCrm()}else if(this.BXIM.webrtc.phoneCallView){if(t.showCrmCard){this.BXIM.webrtc.phoneCallView.setCrmData(t.CRM);this.BXIM.webrtc.phoneCallView.setCrmEntity({type:t.crmEntityType,id:t.crmEntityId,activityId:t.crmActivityId,activityEditUrl:t.crmActivityEditUrl,bindings:t.crmBindings});this.BXIM.webrtc.phoneCallView.setConfig(t.config);this.BXIM.webrtc.phoneCallView.setCallId(t.callId);if(t.lineNumber)this.BXIM.webrtc.phoneCallView.setLineNumber(t.lineNumber);if(t.lineName)this.BXIM.webrtc.phoneCallView.setCompanyPhoneNumber(t.lineName);this.BXIM.webrtc.phoneCallView.reloadCrmCard()}}if(this.BXIM.webrtc.phonePortalCall&&this.BXIM.messenger.users[t.portalCallUserId]){if(this.isMobile()){this.BXIM.webrtc.phoneCrm.FOUND="Y";this.BXIM.webrtc.phoneCrm.CONTACT={NAME:t.portalCallData.users[t.portalCallUserId].name,PHOTO:t.portalCallData.users[t.portalCallUserId].avatar}}else if(this.BXIM.webrtc.phoneCallView){this.BXIM.webrtc.phoneCallView.setPortalCall(true);this.BXIM.webrtc.phoneCallView.setPortalCallData(t.portalCallData);this.BXIM.webrtc.phoneCallView.setPortalCallUserId(t.portalCallUserId)}}}else if(!this.BXIM.webrtc.callInit&&!this.BXIM.webrtc.callActive&&t.callDevice=="PHONE"){this.phoneCheckDesktop(true).then(function(){this.BXIM.webrtc.phoneCallDevice=t.callDevice=="PHONE"?"PHONE":"WEBRTC";this.BXIM.webrtc.phonePortalCall=t.portalCall?true:false;this.BXIM.webrtc.phoneCallId=t.callId;this.BXIM.webrtc.phoneCallTime=0;this.BXIM.webrtc.phoneCallConfig=t.config?t.config:{};this.BXIM.webrtc.phoneCrm=t.CRM;this.BXIM.webrtc.phoneDisplayExternal({callId:t.callId,config:t.config?t.config:{},phoneNumber:t.phoneNumber,portalCall:t.portalCall,portalCallUserId:t.portalCallUserId,portalCallData:t.portalCallData,showCrmCard:t.showCrmCard,crmEntityType:t.crmEntityType,crmEntityId:t.crmEntityId})}.bind(this))}}else if(e=="start"){if(this.BXIM.webrtc.phoneTransferCallId===t.callId){this.BXIM.webrtc.phoneCallView.setStatusText(s.message("IM_M_CALL_ST_TRANSFER_CONNECTED"));return}else if(this.BXIM.webrtc.phoneCallId!=t.callId){return}this.BXIM.webrtc.callOverlayTimer("start");this.BXIM.stopRepeatSound("ringtone");if(this.BXIM.webrtc.phoneCallId==t.callId&&this.BXIM.webrtc.phoneCallDevice=="PHONE"&&(this.BXIM.webrtc.phoneCallDevice==t.callDevice||this.BXIM.webrtc.phonePortalCall)){this.BXIM.webrtc.phoneOnCallConnected()}else if(this.BXIM.webrtc.phoneCallId==t.callId&&t.callDevice=="PHONE"&&this.BXIM.webrtc.phoneIncoming){this.BXIM.webrtc.phoneCallDevice="PHONE";if(this.BXIM.webrtc.phoneCallView){this.BXIM.webrtc.phoneCallView.setDeviceCall(true)}this.BXIM.webrtc.phoneOnCallConnected()}if(t.CRM){this.BXIM.webrtc.phoneCrm=t.CRM;this.BXIM.webrtc.callOverlayDrawCrm()}if(this.BXIM.webrtc.phoneNumber!=""){this.BXIM.webrtc.phoneNumberLast=this.BXIM.webrtc.phoneNumber;this.BXIM.setLocalConfig("phone_last",this.BXIM.webrtc.phoneNumber)}}else if(e=="hold"||e=="unhold"){if(this.BXIM.webrtc.phoneCallId==t.callId){this.BXIM.webrtc.phoneHolded=e=="hold"}}else if(e=="update_crm"){if(this.BXIM.webrtc.phoneCallId==t.callId&&t.CRM&&t.CRM.FOUND){this.BXIM.webrtc.phoneCrm=t.CRM;if(this.isMobile()){this.BXIM.webrtc.callOverlayDrawCrm();if(this.BXIM.webrtc.callNotify)this.BXIM.webrtc.callNotify.adjustPosition()}else if(this.BXIM.webrtc.phoneCallView){this.BXIM.webrtc.phoneCallView.setCrmData(t.CRM);if(t.showCrmCard){this.BXIM.webrtc.phoneCallView.setCrmEntity({type:t.crmEntityType,id:t.crmEntityId,activityId:t.crmActivityId,activityEditUrl:t.crmActivityEditUrl,bindings:t.crmBindings});this.BXIM.webrtc.phoneCallView.reloadCrmCard()}}}}else if(e=="completeTransfer"){if(this.BXIM.webrtc.phoneCallId!=t.callId){return false}this.BXIM.webrtc.phoneCallId=t.newCallId;this.phoneTransferTargetId=0;this.phoneTransferTargetType="";this.phoneTransferCallId="";this.phoneTransferEnabled=false;s.localStorage.set("vite",false,1);this.BXIM.webrtc.phoneCallDevice=t.callDevice=="PHONE"?"PHONE":"WEBRTC";if(this.BXIM.webrtc.phoneCallDevice=="PHONE"){this.BXIM.webrtc.phoneCallView.setDeviceCall(true)}this.BXIM.webrtc.phoneCallView.setTransfer(false);this.BXIM.webrtc.phoneOnCallConnected()}else if(e=="phoneDeviceActive"){this.BXIM.webrtc.phoneDeviceActive=t.active=="Y"}else if(e=="changeDefaultLineId"){this.BXIM.webrtc.phoneDefaultLineId=t.defaultLineId}else if(e=="replaceCallerId"){var a=s.message("IM_PHONE_CALL_TRANSFER").replace("#PHONE#",t.callerId);this.BXIM.webrtc.setCallOverlayTitle(a);this.BXIM.webrtc.phoneCallView.setPhoneNumber(t.callerId);if(t.CRM){this.BXIM.webrtc.phoneCrm=t.CRM;if(this.isMobile()){this.BXIM.webrtc.callOverlayDrawCrm()}else if(this.BXIM.webrtc.phoneCallView){this.BXIM.webrtc.phoneCallView.setCrmData(t.CRM);if(t.showCrmCard){this.BXIM.webrtc.phoneCallView.setCrmEntity({type:t.crmEntityType,id:t.crmEntityId,activityId:t.crmActivityId,activityEditUrl:t.crmActivityEditUrl,bindings:t.crmBindings});this.BXIM.webrtc.phoneCallView.reloadCrmCard()}}}}else if(e=="showExternalCall"){if(this.isMobile())return false;if(this.BXIM.callController.hasActiveCall())return false;if(s.localStorage.get("viInitedCall")||s.localStorage.get("viExternalCard")){return false}this.phoneCheckDesktop().then(function(){if(t.CRM&&t.CRM.FOUND){this.BXIM.webrtc.phoneCrm=t.CRM}else{this.BXIM.webrtc.phoneCrm={}}this.BXIM.webrtc.showExternalCall({callId:t.callId,fromUserId:t.fromUserId,toUserId:t.toUserId,isCallback:t.isCallback,phoneNumber:t.phoneNumber,lineNumber:t.lineNumber,companyPhoneNumber:t.companyPhoneNumber,showCrmCard:t.showCrmCard,crmEntityType:t.crmEntityType,crmEntityId:t.crmEntityId,crmActivityId:t.crmActivityId,crmActivityEditUrl:t.crmActivityEditUrl,config:t.config,portalCall:t.portalCall,portalCallData:t.portalCallData,portalCallUserId:t.portalCallUserId})}.bind(this))}else if(e=="hideExternalCall"){if(this.isMobile())return false;if(this.BXIM.webrtc.callActive&&this.BXIM.webrtc.phoneCallExternal&&this.BXIM.webrtc.phoneCallId==t.callId){this.BXIM.webrtc.hideExternalCall()}}},this);if(this.isMobile()){BXMobileApp.addCustomEvent("onPull-voximplant",e)}else{s.addCustomEvent("onPullEvent-voximplant",e)}};t.prototype.phoneCommand=function(e,t,r,i){var a=!s.type.isFunction(i);var n;if(a){n=new s.Promise}if(!this.BXIM.webrtc.phoneSupport()){if(a){n.reject();return n}else{return false}}r=r!=false;t=typeof t=="object"?t:{};s.ajax({url:this.BXIM.pathToCallAjax+"?PHONE_SHARED&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,async:r,data:{IM_PHONE:"Y",COMMAND:e,PARAMS:JSON.stringify(t),IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:function(e){if(a){n.resolve(e)}else{i(e)}}});return a?n:true};t.prototype.phoneCorrect=function(e){return e.toString().replace(/[^0-9+#*;,]/g,"")};t.prototype.phoneOnIncomingCall=function(e){if(this.BXIM.webrtc.phoneCurrentCall)return false;var t={};if(this.isMobile()){t=s.MobileVoximplantCall.events}else{t=VoxImplant.CallEvents}this.BXIM.webrtc.phoneCurrentCall=e.call;this.BXIM.webrtc.phoneCurrentCall.addEventListener(t.Connected,s.delegate(this.BXIM.webrtc.phoneOnCallConnected,this.BXIM.webrtc));this.BXIM.webrtc.phoneCurrentCall.addEventListener(t.Disconnected,s.delegate(this.BXIM.webrtc.phoneOnCallDisconnected,this.BXIM.webrtc));this.BXIM.webrtc.phoneCurrentCall.addEventListener(t.Failed,s.delegate(this.BXIM.webrtc.phoneOnCallFailed,this.BXIM.webrtc));this.BXIM.webrtc.phoneCurrentCall.answer()};t.prototype.phoneGetCallParams=function(){var e=s.type.isPlainObject(this.BXIM.webrtc.phoneParams)?s.clone(this.BXIM.webrtc.phoneParams):{};if(this.BXIM.webrtc.phoneFullNumber!=this.BXIM.webrtc.phoneNumber){e["FULL_NUMBER"]=this.BXIM.webrtc.phoneFullNumber}return JSON.stringify(e)};t.prototype.phoneCallStart=function(){this.BXIM.webrtc.phoneParams["CALLER_ID"]="";this.BXIM.webrtc.phoneParams["USER_ID"]=this.BXIM.userId;this.BXIM.webrtc.phoneLog("Call params: ",this.BXIM.webrtc.phoneNumber,this.BXIM.webrtc.phoneParams);if(!this.BXIM.webrtc.phoneAPI.connected()){this.BXIM.webrtc.phoneOnSDKReady();return false}if(!this.isMobile()&&false){this.BXIM.webrtc.phoneCurrentCall=true;this.BXIM.webrtc.callActive=true;this.BXIM.webrtc.phoneOnCallConnected();this.BXIM.webrtc.phoneCrm.FOUND="N";this.BXIM.webrtc.phoneCrm.CONTACT_URL="#";this.BXIM.webrtc.phoneCrm.LEAD_URL="#";this.BXIM.webrtc.callOverlayDrawCrm()}else{var e={};if(this.isMobile()){e=s.MobileVoximplantCall.events}else{e=VoxImplant.CallEvents;this.BXIM.webrtc.phoneAPI.setOperatorACDStatus("ONLINE")}this.BXIM.webrtc.phoneCurrentCall=this.BXIM.webrtc.phoneAPI.call(this.BXIM.webrtc.phoneNumber,false,this.phoneGetCallParams());this.BXIM.webrtc.phoneCurrentCall.addEventListener(e.Connected,s.delegate(this.BXIM.webrtc.phoneOnCallConnected,this.BXIM.webrtc));this.BXIM.webrtc.phoneCurrentCall.addEventListener(e.Disconnected,s.delegate(this.BXIM.webrtc.phoneOnCallDisconnected,this.BXIM.webrtc));this.BXIM.webrtc.phoneCurrentCall.addEventListener(e.Failed,s.delegate(this.BXIM.webrtc.phoneOnCallFailed,this.BXIM.webrtc));this.BXIM.webrtc.phoneCurrentCall.addEventListener(e.ProgressToneStart,s.delegate(this.BXIM.webrtc.phoneOnProgressToneStart,this.BXIM.webrtc));this.BXIM.webrtc.phoneCurrentCall.addEventListener(e.ProgressToneStop,s.delegate(this.BXIM.webrtc.phoneOnProgressToneStop,this.BXIM.webrtc));if(this.isMobile()){this.BXIM.webrtc.phoneCurrentCall.start()}}s.ajax({url:this.BXIM.pathToCallAjax+"?PHONE_INIT&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_PHONE:"Y",COMMAND:"init",NUMBER:this.BXIM.webrtc.phoneNumber,NUMBER_USER:s.util.htmlspecialcharsback(this.BXIM.webrtc.phoneNumberUser),IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(e){if(e.ERROR==""){if(!(e.HR_PHOTO.length==0)){for(var s in e.HR_PHOTO)this.BXIM.messenger.hrphoto[s]=e.HR_PHOTO[s];this.BXIM.webrtc.callOverlayUserId=e.DIALOG_ID}else{this.BXIM.webrtc.callOverlayChatId=e.DIALOG_ID.substr(4)}}},this)})};t.prototype.phoneCallFinish=function(){clearInterval(this.BXIM.webrtc.phoneConnectedInterval);s.localStorage.remove("viInitedCall");clearInterval(this.BXIM.webrtc.phoneCallTimeInterval);this.BXIM.webrtc.callOverlayTimer("pause");if(!this.isMobile()){this.BXIM.desktop.closeTopmostWindow()}if(this.BXIM.webrtc.phoneCurrentCall){try{this.BXIM.webrtc.phoneCurrentCall.hangup({"X-Disconnect-Code":200,"X-Disconnect-Reason":"Normal hangup"})}catch(e){}this.BXIM.webrtc.phoneCurrentCall=null;this.BXIM.webrtc.phoneLog("Call hangup call")}else if(this.BXIM.webrtc.phoneDisconnectAfterCallFlag&&this.BXIM.webrtc.phoneAPI&&this.BXIM.webrtc.phoneAPI.connected()){setTimeout(s.delegate(function(){if(this.BXIM.webrtc.phoneAPI&&this.BXIM.webrtc.phoneAPI.connected())this.BXIM.webrtc.phoneAPI.disconnect()},this),500)}if(this.isMobile()){}else{if(this.BXIM.webrtc.popupKeyPad)this.BXIM.webrtc.popupKeyPad.close();if(this.BXIM.webrtc.popupTransferDialog)this.BXIM.webrtc.popupTransferDialog.close();s.localStorage.set("vite",false,1)}this.BXIM.webrtc.phoneRinging=0;this.BXIM.webrtc.phoneIncoming=false;this.BXIM.webrtc.phoneCallId="";this.BXIM.webrtc.phoneCallExternal=false;this.BXIM.webrtc.phoneCallDevice="WEBRTC";this.BXIM.webrtc.phoneNumber="";this.BXIM.webrtc.phoneNumberUser="";this.BXIM.webrtc.phoneParams={};this.BXIM.webrtc.callOverlayOptions={};this.BXIM.webrtc.callSelfDisabled=false;this.BXIM.webrtc.phoneMicMuted=false;this.BXIM.webrtc.phoneHolded=false;this.BXIM.webrtc.phoneMicAccess=false;this.BXIM.webrtc.phoneTransferTargetType="";this.BXIM.webrtc.phoneTransferTargetId=0;this.BXIM.webrtc.phoneTransferCallId="";this.BXIM.webrtc.phoneTransferEnabled=false};t.prototype.phoneAuthorize=function(){s.ajax({url:this.BXIM.pathToCallAjax+"?PHONE_AUTHORIZE&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_PHONE:"Y",COMMAND:"authorize",UPDATE_INFO:this.BXIM.webrtc.phoneCheckBalance?"Y":"N",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(t){if(t&&t.BITRIX_SESSID){s.message({bitrix_sessid:t.BITRIX_SESSID})}if(t.ERROR==""){this.BXIM.messenger.sendAjaxTry=0;this.BXIM.webrtc.phoneCheckBalance=false;if(t.HR_PHOTO){for(var r in t.HR_PHOTO)this.BXIM.messenger.hrphoto[r]=t.HR_PHOTO[r]}if(this.isMobile()){this.BXIM.webrtc.phoneLogin=t.LOGIN;this.BXIM.webrtc.phoneServer=t.SERVER;this.BXIM.webrtc.phoneLog("auth with",this.BXIM.webrtc.phoneLogin+"@"+this.BXIM.webrtc.phoneServer);s.MobileVoximplant.loginWithOneTimeKey(t.LOGIN+"@"+t.SERVER,t.HASH)}else{this.BXIM.webrtc.phoneLogin=t.LOGIN;this.BXIM.webrtc.phoneServer=t.SERVER}this.BXIM.webrtc.phoneCallerID=t.CALLERID;this.BXIM.webrtc.phoneApiInit()}else if(t.ERROR=="AUTHORIZE_ERROR"&&(this.isDesktop()||this.isMobile())&&this.BXIM.messenger.sendAjaxTry<3){this.BXIM.messenger.sendAjaxTry++;setTimeout(s.delegate(function(){this.phoneAuthorize()},this),5e3);s.onCustomEvent(e,"onImError",[t.ERROR])}else if(t.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;setTimeout(s.delegate(function(){this.phoneAuthorize()},this),2e3);s.onCustomEvent(e,"onImError",[t.ERROR,t.BITRIX_SESSID])}else{this.BXIM.webrtc.callOverlayDeleteEvents();this.BXIM.webrtc.callOverlayProgress("offline");this.BXIM.webrtc.phoneLog("onetimekey",t.ERROR,t.CODE);if(t.ERROR=="AUTHORIZE_ERROR"||t.ERROR=="SESSION_ERROR"){s.onCustomEvent(e,"onImError",[t.ERROR]);this.BXIM.webrtc.callAbort(s.message("IM_PHONE_401"))}else{this.BXIM.webrtc.callAbort(t.ERROR+(this.BXIM.webrtc.debug?"<br />("+s.message("IM_ERROR_CODE")+": "+t.CODE+")":""))}if(!this.isMobile()){this.BXIM.webrtc.phoneCallView.setUiState(s.PhoneCallView.UiState.error);this.BXIM.webrtc.phoneCallView.setCallState(s.PhoneCallView.CallState.idle)}}},this),onfailure:s.delegate(function(){this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.callAbort(s.message("IM_M_CALL_ERR"))},this)})};t.prototype.phoneOnAuthResult=function(e){if(e.result){if(this.BXIM.webrtc.phoneCallDevice=="PHONE")return false;this.BXIM.webrtc.phoneLog("Authorize result","success");if(this.BXIM.webrtc.phoneIncoming){s.MessengerCommon.phoneCommand("ready",{CALL_ID:this.BXIM.webrtc.phoneCallId})}else if(this.BXIM.webrtc.callInitUserId==this.BXIM.userId){s.MessengerCommon.phoneCallStart()}}else if(!this.isMobile()&&e.code==302){s.ajax({url:this.BXIM.pathToCallAjax+"?PHONE_ONETIMEKEY&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_PHONE:"Y",COMMAND:"onetimekey",KEY:e.key,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(e){if(e.ERROR==""){this.BXIM.webrtc.phoneLog("auth with",this.BXIM.webrtc.phoneLogin+"@"+this.BXIM.webrtc.phoneServer);this.BXIM.webrtc.phoneAPI.loginWithOneTimeKey(this.BXIM.webrtc.phoneLogin+"@"+this.BXIM.webrtc.phoneServer,e.HASH)}else{this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.phoneLog("onetimekey",e.ERROR,e.CODE);if(e.CODE)this.BXIM.webrtc.callAbort(s.message("IM_PHONE_ERROR_CONNECT"));else this.BXIM.webrtc.callAbort(e.ERROR+(this.debug?"<br />("+s.message("IM_ERROR_CODE")+": "+e.CODE+")":""));if(!this.isMobile()){this.BXIM.webrtc.phoneCallView.setUiState(s.PhoneCallView.UiState.error);this.BXIM.webrtc.phoneCallView.setCallState(s.PhoneCallView.CallState.idle)}}},this),onfailure:s.delegate(function(){this.BXIM.webrtc.callAbort(s.message("IM_M_CALL_ERR"));this.BXIM.webrtc.phoneCallFinish()},this)})}else{if(e.code==401||e.code==400||e.code==403||e.code==404||e.code==302){this.BXIM.webrtc.callAbort(s.message("IM_PHONE_401"));this.BXIM.webrtc.phoneServer="";this.BXIM.webrtc.phoneLogin="";this.BXIM.webrtc.phoneCheckBalance=true;s.MessengerCommon.phoneCommand("authorize_error")}else{this.BXIM.webrtc.callAbort(s.message("IM_M_CALL_ERR"))}this.BXIM.webrtc.callOverlayProgress("offline");if(!this.isMobile()){this.BXIM.webrtc.phoneCallView.setUiState(s.PhoneCallView.UiState.error);this.BXIM.webrtc.phoneCallView.setCallState(s.PhoneCallView.CallState.idle)}this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.phoneLog("Authorize result","failed",e.code);this.BXIM.webrtc.phoneServer="";this.BXIM.webrtc.phoneLogin=""}};t.prototype.phoneOnCallFailed=function(e){var t=e.headers||{};this.BXIM.webrtc.phoneLog("Call failed",e.code,e.reason);var r=s.message("IM_PHONE_END");if(e.code==603){r=s.message("IM_PHONE_DECLINE")}else if(e.code==380){r=s.message("IM_PHONE_ERR_SIP_LICENSE")}else if(e.code==436){r=s.message("IM_PHONE_ERR_NEED_RENT")}else if(e.code==438){r=s.message("IM_PHONE_ERR_BLOCK_RENT")}else if(e.code==400){r=s.message("IM_PHONE_ERR_LICENSE")}else if(e.code==401){r=s.message("IM_PHONE_401")}else if(e.code==480||e.code==503){if(this.BXIM.webrtc.phoneNumber==911||this.BXIM.webrtc.phoneNumber==112){r=s.message("IM_PHONE_NO_EMERGENCY")}else{r=s.message("IM_PHONE_UNAVAILABLE")}}else if(e.code==484||e.code==404){if(this.BXIM.webrtc.phoneNumber==911||this.BXIM.webrtc.phoneNumber==112){r=s.message("IM_PHONE_NO_EMERGENCY")}else{r=s.message("IM_PHONE_INCOMPLETED")}}else if(e.code==402){if(t.hasOwnProperty("X-Reason")&&t["X-Reason"]==="SIP_PAYMENT_REQUIRED"){r=s.message("IM_PHONE_ERR_SIP_LICENSE")}else{r=s.message("IM_PHONE_NO_MONEY")+(this.BXIM.isAdmin?" "+s.message("IM_PHONE_PAY_URL_NEW"):"")}}else if(e.code==486&&this.BXIM.webrtc.phoneRinging>1){r=s.message("IM_M_CALL_ST_DECLINE")}else if(e.code==486){r=s.message("IM_PHONE_ERROR_BUSY")}else if(e.code==403){r=s.message("IM_PHONE_403");this.BXIM.webrtc.phoneServer="";this.BXIM.webrtc.phoneLogin="";this.BXIM.webrtc.phoneCheckBalance=true}this.BXIM.webrtc.phoneCallFinish();if(e.code==408||e.code==403){if(this.BXIM.webrtc.phoneAPI&&this.BXIM.webrtc.phoneAPI.connected()){setTimeout(s.delegate(function(){if(this.BXIM.webrtc.phoneAPI&&this.BXIM.webrtc.phoneAPI.connected())this.BXIM.webrtc.phoneAPI.disconnect()},this),500)}}this.BXIM.webrtc.callOverlayProgress("offline");this.BXIM.webrtc.callAbort(r);if(!this.isMobile()){this.BXIM.webrtc.phoneCallView.setUiState(s.PhoneCallView.UiState.error);this.BXIM.webrtc.phoneCallView.setCallState(s.PhoneCallView.CallState.idle)}};t.prototype.phoneOnCallDisconnected=function(e){this.BXIM.webrtc.phoneLog("Call disconnected",this.BXIM.webrtc.phoneCurrentCall?this.BXIM.webrtc.phoneCurrentCall.id():"-",this.BXIM.webrtc.phoneCurrentCall?this.BXIM.webrtc.phoneCurrentCall.state():"-");if(this.BXIM.webrtc.phoneCurrentCall){this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.callOverlayDeleteEvents();this.BXIM.webrtc.callOverlayStatus(s.message("IM_M_CALL_ST_END"));if(this.isMobile()){this.BXIM.webrtc.callOverlayProgress("offline");this.BXIM.webrtc.callOverlayState(s.MobileCallUI.form.state.FINISHED)}else{this.BXIM.playSound("stop");this.BXIM.webrtc.phoneCallView.setCallState(s.PhoneCallView.CallState.idle);if(this.BXIM.webrtc.isCallListMode()){this.BXIM.webrtc.phoneCallView.setUiState(s.PhoneCallView.UiState.outgoing)}else{this.BXIM.webrtc.phoneCallView.setStatusText(s.message("IM_PHONE_END"));this.BXIM.webrtc.phoneCallView.setUiState(s.PhoneCallView.UiState.idle);this.BXIM.webrtc.phoneCallView.autoClose()}}}if(this.BXIM.webrtc.phoneDisconnectAfterCallFlag&&this.BXIM.webrtc.phoneAPI&&this.BXIM.webrtc.phoneAPI.connected()){setTimeout(s.delegate(function(){if(this.BXIM.webrtc.phoneAPI&&this.BXIM.webrtc.phoneAPI.connected())this.BXIM.webrtc.phoneAPI.disconnect()},this),500)}};t.prototype.phoneOnProgressToneStart=function(e){if(!this.BXIM.webrtc.phoneCurrentCall)return false;this.BXIM.webrtc.phoneLog("Progress tone start",this.BXIM.webrtc.phoneCurrentCall.id());this.BXIM.webrtc.phoneRinging++;this.BXIM.webrtc.callOverlayStatus(s.message("IM_PHONE_WAIT_ANSWER"))};t.prototype.phoneOnProgressToneStop=function(e){if(!this.BXIM.webrtc.phoneCurrentCall)return false;this.BXIM.webrtc.phoneLog("Progress tone stop",this.BXIM.webrtc.phoneCurrentCall.id())};t.prototype.phoneOnConnectionEstablished=function(e){this.BXIM.webrtc.phoneLog("Connection established",this.BXIM.webrtc.phoneAPI.connected())};t.prototype.phoneOnConnectionFailed=function(e){this.BXIM.webrtc.phoneLog("Connection failed");this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.callAbort(s.message("IM_M_CALL_ERR"))};t.prototype.phoneOnConnectionClosed=function(e){this.BXIM.webrtc.phoneLog("Connection closed");this.BXIM.webrtc.phoneSDKinit=false};t.prototype.phoneOnMicResult=function(e){this.BXIM.webrtc.phoneMicAccess=e.result;this.BXIM.webrtc.phoneLog("Mic Access Allowed",e.result);if(!this.isMobile()){clearTimeout(this.BXIM.webrtc.callDialogAllowTimeout);if(this.BXIM.webrtc.callDialogAllow)this.BXIM.webrtc.callDialogAllow.close()}if(e.result){this.BXIM.webrtc.callOverlayProgress("connect");this.BXIM.webrtc.callOverlayStatus(s.message("IM_M_CALL_ST_CONNECT"))}else{this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.callOverlayProgress("offline");this.BXIM.webrtc.callAbort(s.message("IM_M_CALL_ST_NO_ACCESS"));if(!this.isMobile()){this.BXIM.webrtc.phoneCallView.setUiState(s.PhoneCallView.UiState.error);this.BXIM.webrtc.phoneCallView.setCallState(s.PhoneCallView.CallState.idle)}}};t.prototype.phoneOnNetStatsReceived=function(e){if(!this.BXIM.webrtc.phoneCurrentCall||this.BXIM.webrtc.phoneCurrentCall.state()!="CONNECTED")return false;var s=100-parseInt(e.stats.packetLoss);var t=this.BXIM.webrtc.callPhoneOverlayMeter(s);this.BXIM.webrtc.phoneCurrentCall.sendMessage(JSON.stringify({COMMAND:"meter",PACKETLOSS:e.stats.packetLoss,PERCENT:s,GRADE:t}))};t.prototype.phoneHold=function(){if(!this.BXIM.webrtc.phoneCurrentCall&&this.BXIM.webrtc.phoneCallDevice=="WEBRTC")return false;this.BXIM.webrtc.phoneHolded=true;if(this.BXIM.webrtc.phoneCallDevice=="WEBRTC"){this.BXIM.webrtc.phoneCurrentCall.sendMessage(JSON.stringify({COMMAND:"hold"}))}else{s.MessengerCommon.phoneCommand("hold",{CALL_ID:this.BXIM.webrtc.phoneCallId})}};t.prototype.phoneUnhold=function(){if(!this.BXIM.webrtc.phoneCurrentCall&&this.BXIM.webrtc.phoneCallDevice=="WEBRTC")return false;this.BXIM.webrtc.phoneHolded=false;if(this.BXIM.webrtc.phoneCallDevice=="WEBRTC"){this.BXIM.webrtc.phoneCurrentCall.sendMessage(JSON.stringify({COMMAND:"unhold"}))}else{s.MessengerCommon.phoneCommand("unhold",{CALL_ID:this.BXIM.webrtc.phoneCallId})}};t.prototype.phoneToggleHold=function(e){if(!this.BXIM.webrtc.phoneCurrentCall&&this.BXIM.webrtc.phoneCallDevice=="WEBRTC")return false;if(typeof e!="undefined"){this.BXIM.webrtc.phoneHolded=!e}if(this.BXIM.webrtc.phoneHolded){if(this.BXIM.webrtc.phoneCallDevice=="WEBRTC"){this.BXIM.webrtc.phoneCurrentCall.sendMessage(JSON.stringify({COMMAND:"unhold"}))}else{s.MessengerCommon.phoneCommand("unhold",{CALL_ID:this.BXIM.webrtc.phoneCallId})}}else{if(this.BXIM.webrtc.phoneCallDevice=="WEBRTC"){this.BXIM.webrtc.phoneCurrentCall.sendMessage(JSON.stringify({COMMAND:"hold"}))}else{s.MessengerCommon.phoneCommand("hold",{CALL_ID:this.BXIM.webrtc.phoneCallId})}}this.BXIM.webrtc.phoneHolded=!this.BXIM.webrtc.phoneHolded};t.prototype.phoneSendDTMF=function(e){if(!this.BXIM.webrtc.phoneCurrentCall)return false;this.BXIM.webrtc.phoneLog("Send DTMF code",this.BXIM.webrtc.phoneCurrentCall.id(),e);this.BXIM.webrtc.phoneCurrentCall.sendTone(e)};t.prototype.phoneStartCallViaRestApp=function(e,t,r){s.rest.callMethod("voximplant.call.startViaRest",{NUMBER:e,LINE_ID:t,PARAMS:r,SHOW:"Y"})};t.prototype.phoneGetCallFields=function(e){if(!this.BXIM.messenger.chat[e]||this.BXIM.messenger.chat[e].type!="call")return{crm:false};var s=this.BXIM.messenger.chat[e];var t=s.entity_data_1.toString().split("|");if(t.length<3||t[0]!=="Y"){return{crm:false}}else{return{crm:true,crmEntityType:t[1],crmEntityId:t[2],crmShowUrl:this.BXIM.path.crm[t[1]].replace("#ID#",t[2])}}};t.prototype.getUser=function(e){return this.BXIM.messenger.users[e]||false};t.prototype.getHrPhoto=function(e,s){var t="";if(s===undefined){s=this.BXIM.messenger.users[e].color||""}if(e=="phone"){t="/bitrix/js/im/images/hidef-phone-v3.png"}else if(this.BXIM.messenger.hrphoto[e]){t=this.BXIM.messenger.hrphoto[e];if(this.BXIM.messenger.hrphoto[e]!="/bitrix/js/im/images/hidef-avatar-v3.png"){s=""}}else if(!this.BXIM.messenger.users[e]||this.BXIM.messenger.users[e].avatar==this.BXIM.pathToBlankImage){t="/bitrix/js/im/images/hidef-avatar-v3.png"}else{t=this.BXIM.messenger.users[e].avatar;s=""}return{src:t,color:s}};t.prototype.linesBodyScroll=function(){if(this.isMobile()&&document.body.offsetHeight<=e.innerHeight){this.BXIM.messenger.popupMessengerBody.scrollTop=0;return false}if(this.BXIM.animationSupport){if(this.BXIM.messenger.popupMessengerBodyAnimation!=null)this.BXIM.messenger.popupMessengerBodyAnimation.stop();s.defer(function(){(this.BXIM.messenger.popupMessengerBodyAnimation=new s.easing({duration:600,start:{scroll:this.BXIM.messenger.popupMessengerBody.scrollTop},finish:{scroll:this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(s.MessengerCommon.isMobile()?0:1)},transition:s.easing.makeEaseInOut(s.easing.transitions.quart),step:s.delegate(function(e){this.BXIM.messenger.popupMessengerBody.scrollTop=e.scroll},this)})).animate()},this)()}else{s.defer(function(){this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(s.MessengerCommon.isMobile()?0:1)},this)()}};t.prototype.linesGetSessionHistory=function(r){s.ajax({url:this.BXIM.pathToAjax+"?SESSION_GET_HISTORY&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"sessionGetHistory",SESSION_ID:r,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(r){if(r&&r.BITRIX_SESSID){s.message({bitrix_sessid:r.BITRIX_SESSID})}if(r.ERROR==""){for(var i in r.FILES){if(!this.BXIM.messenger.disk.files[r.CHAT_ID])this.BXIM.messenger.disk.files[r.CHAT_ID]={};if(this.BXIM.messenger.disk.files[r.CHAT_ID][i])continue;r.FILES[i].date=new Date(r.FILES[i].date);this.BXIM.messenger.disk.files[r.CHAT_ID][i]=r.FILES[i]}this.BXIM.messenger.sendAjaxTry=0;for(var i in r.MESSAGE){r.MESSAGE[i].date=new Date(r.MESSAGE[i].date);this.BXIM.messenger.message[i]=r.MESSAGE[i]}for(var i in r.USERS){r.USERS[i].last_activity_date=new Date(r.USERS[i].last_activity_date);r.USERS[i].mobile_last_date=new Date(r.USERS[i].mobile_last_date);r.USERS[i].idle=r.USERS[i].idle?new Date(r.USERS[i].idle):false;r.USERS[i].absent=r.USERS[i].absent?new Date(r.USERS[i].absent):false;this.BXIM.messenger.users[i]=r.USERS[i]}for(var i in r.CHAT){if(!this.BXIM.messenger.chat[i]){r.CHAT[i].date_create=new Date(r.CHAT[i].date_create);this.BXIM.messenger.chat[i]=r.CHAT[i]}}if(r.OPENLINES.canVoteAsHead){if(!this.BXIM.messenger.openlines.canVoteAsHead){this.BXIM.messenger.openlines.canVoteAsHead={}}for(var i in r.OPENLINES.canVoteAsHead){this.BXIM.messenger.openlines.canVoteAsHead[i]=r.OPENLINES.canVoteAsHead[i]}}this.BXIM.messenger.linesShowHistory(r.CHAT_ID,{HISTORY:r.USERS_MESSAGE,FILES:r.FILES,CAN_JOIN:r.CAN_JOIN,CAN_VOTE_HEAD:r.CAN_VOTE_HEAD,SESSION_VOTE_HEAD:r.SESSION_VOTE_HEAD,SESSION_COMMENT_HEAD:r.SESSION_COMMENT_HEAD,SESSION_ID:r.SESSION_ID})}else{if(r.CODE=="ACCESS_DENIED"){this.BXIM.openConfirm(r.ERROR)}else if(r.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;setTimeout(function(){t.prototype.linesGetSessionHistory(sessionID)},1e3);s.onCustomEvent(e,"onImError",[r.ERROR,r.BITRIX_SESSID])}else if(r.ERROR=="AUTHORIZE_ERROR"){this.BXIM.messenger.sendAjaxTry++;s.onCustomEvent(e,"onImError",[r.ERROR])}}},this),onfailure:s.delegate(function(){this.BXIM.messenger.sendAjaxTry=0},this)})};t.prototype.linesJoinSession=function(e){s.ajax({url:this.BXIM.pathToAjax+"?JOIN_SESSION&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"joinSession",CHAT_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this),onfailure:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this)})};t.prototype.linesStartSession=function(e){if(this.BXIM.messenger.blockJoinChat[e])return false;s.ajax({url:this.BXIM.pathToAjax+"?START_SESSION_BY_CHAT&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"startSession",CHAT_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this),onfailure:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this)})};t.prototype.linesStartSessionByMessage=function(e){if(!this.BXIM.messenger.message[e]){return false}var t=this.BXIM.messenger.message[e].chatId;if(this.BXIM.messenger.blockJoinChat[t])return false;if(this.BXIM.messenger.chat[t]&&this.BXIM.messenger.chat[t].entity_type!="LINES")return false;if(!s.MessengerCommon.userInChat(t))return false;this.BXIM.messenger.blockJoinChat[t]=true;s.ajax({url:this.BXIM.pathToAjax+"?START_SESSION_BY_MESSAGE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"startSessionByMessage",CHAT_ID:t,MESSAGE_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(){this.BXIM.messenger.blockJoinChat[t]=false},this),onfailure:s.delegate(function(){this.BXIM.messenger.blockJoinChat[t]=false},this)})};t.prototype.linesOpenSession=function(e,t){t=t||{};s.ajax({url:this.BXIM.pathToAjax+"?OPEN_SESSION&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"openSession",USER_CODE:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(e){if(e.ERROR==""){this.BXIM.messenger.openMessenger("chat"+e.CHAT_ID,t).then(function(){if(s.MessengerWindow&&this.BXIM.settings.linesTabEnable){if(s.MessengerWindow.currentTab!="im-ol"){s.MessengerWindow.changeTab("im-ol")}}}.bind(this))}else{if(e.CODE=="ACCESS_DENIED"){this.BXIM.openConfirm(e.ERROR)}}},this)})};t.prototype.linesVoteDraw=function(e){if(!this.BXIM.messenger.message[e]||!this.BXIM.messenger.message[e].params||!this.BXIM.messenger.message[e].params.IMOL_VOTE){return null}var t=this.BXIM.messenger.message[e];var r=false;if(this.BXIM.messenger.currentTab.toString().substr(0,4)=="chat"){var i=this.linesGetSource(this.BXIM.messenger.chat[this.BXIM.messenger.message[e].chatId]);if(!i){return null}if(!this.BXIM.messenger.users[this.BXIM.userId].connector&&!(i=="livechat"||i=="network")){return null}r=!this.BXIM.messenger.users[this.BXIM.userId].connector}else if(!this.BXIM.messenger.bot[this.BXIM.messenger.currentTab]||this.BXIM.messenger.bot[this.BXIM.messenger.currentTab].type!="network"&&this.BXIM.messenger.bot[this.BXIM.messenger.currentTab].type!="support24"){return null}var a="";var n=false;if(t.params.IMOL_VOTE=="like"){n=true;a=t.params.IMOL_VOTE_LIKE}else if(t.params.IMOL_VOTE=="dislike"){n=true;a=t.params.IMOL_VOTE_DISLIKE}else{a=t.params.IMOL_VOTE_TEXT}return s.create("div",{attrs:{"data-messageId":e},props:{className:"bx-messenger-content-item-vote-block"+(n?" bx-messenger-content-item-vote-block-done":"")},children:[s.create("div",{props:{className:"bx-messenger-content-item-vote-block-text"},html:s.util.htmlspecialchars(a)}),s.create("div",{props:{className:"bx-messenger-content-item-vote-block-buttons"},children:[s.create("span",{attrs:{title:s.message("IM_OL_VOTE_LIKE")},props:{className:"bx-messenger-content-item-vote-block-like"+(r?" bx-messenger-content-item-vote-block-disabled":"")},events:{click:r?function(){}:s.delegate(function(){this.linesVoteSend(this.BXIM.messenger.currentTab,s.proxy_context.parentNode.parentNode.getAttribute("data-messageId"),"like")},this)}}),s.create("span",{attrs:{title:s.message("IM_OL_VOTE_DISLIKE")},props:{className:"bx-messenger-content-item-vote-block-dislike"+(r?" bx-messenger-content-item-vote-block-disabled":"")},events:{click:r?function(){}:s.delegate(function(){this.linesVoteSend(this.BXIM.messenger.currentTab,s.proxy_context.parentNode.parentNode.getAttribute("data-messageId"),"dislike")},this)}})]}),s.create("div",{props:{className:"bx-messenger-content-item-vote-block-final"},children:[s.create("span",{props:{className:t.params.IMOL_VOTE=="dislike"?"bx-messenger-content-item-vote-block-smile-dislike":"bx-messenger-content-item-vote-block-smile-like"}})]})]})};t.prototype.linesVoteResultDraw=function(e,t){if(!this.BXIM.messenger.message[e]||!this.BXIM.messenger.message[e].params||!this.BXIM.messenger.message[e].params.IMOL_VOTE_SID){return t}var r=this.BXIM.messenger.message[e];var i="";if(typeof r.params.IMOL_VOTE_USER=="undefined"||r.params.IMOL_VOTE_USER==0){i=s.message("IM_OL_VOTE_WO")}else if(r.params.IMOL_VOTE_USER==5){i='<span class="bx-smile bx-im-smile-like" title="'+s.message("IM_MESSAGE_LIKE")+'"></span>'}else{i='<span class="bx-smile bx-im-smile-dislike" title="'+s.message("IM_MESSAGE_DISLIKE")+'"></span>'}var a=this.linesGetSession(this.BXIM.messenger.chat[r.chatId]);if(!a){return t}var n=this.linesVoteHeadNodes(r.params.IMOL_VOTE_SID,r.params.IMOL_VOTE_HEAD,a.canVoteHead);if(typeof r.params.IMOL_COMMENT_HEAD=="object"&&r.params.IMOL_COMMENT_HEAD){var o=r.params.IMOL_COMMENT_HEAD["text"]}else{var o=r.params.IMOL_COMMENT_HEAD}var l=this.linesCommentHeadNodes(r.params.IMOL_VOTE_SID,o,a.canVoteHead);return s.create("div",{attrs:{"data-messageId":e},children:[s.create("div",{props:{className:"bx-messenger-content-item-vote-message-text"},html:t}),s.create("div",{props:{className:"bx-messenger-content-item-vote-result"},children:[s.create("div",{props:{className:"bx-messenger-content-item-vote-result-row"},children:[s.create("span",{props:{className:"bx-messenger-content-item-vote-result-name"},html:s.message("IM_OL_VOTE_USER")+":"}),s.create("span",{props:{className:"bx-messenger-content-item-vote-result-value"},html:i})]}),s.create("div",{props:{className:"bx-messenger-content-item-vote-result-row"},children:[s.create("span",{props:{className:"bx-messenger-content-item-vote-result-name"},html:s.message("IM_OL_VOTE_HEAD")+":"}),s.create("span",{props:{className:"bx-messenger-content-item-vote-result-value"},children:[n]})]}),l?s.create("div",{props:{className:"bx-messenger-content-item-vote-result-row"},children:[s.create("span",{props:{className:"bx-messenger-content-item-vote-result-name"},html:s.message("IM_OL_COMMENT_HEAD")+":"}),s.create("span",{props:{className:"bx-messenger-content-item-vote-result-value"},children:[l]})]}):null]})]})};t.prototype.linesVoteSend=function(e,t,r){if(!this.BXIM.messenger.message[t]||!this.BXIM.messenger.message[t].params||!this.BXIM.messenger.message[t].params.IMOL_VOTE){return false}if(this.BXIM.messenger.message[t].date.getTime()/1e3+86400<(new Date).getTime()/1e3){this.BXIM.openConfirm(s.message("IM_OL_VOTE_END"));return false}if(e.toString().substr(0,4)=="chat"){if(!this.BXIM.messenger.users[this.BXIM.userId].connector){return false}}else if(!this.BXIM.messenger.bot[e]||this.BXIM.messenger.bot[e].type!="network"&&this.BXIM.messenger.bot[e].type!="support24"){return null}this.BXIM.messenger.message[t].params.IMOL_VOTE=r;var i=s("im-message-"+t);if(i){i.innerHTML="";i.appendChild(this.linesVoteDraw(t))}s.ajax({url:this.BXIM.pathToAjax+"?LINES_VOTE_SEND&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{IM_LINES_VOTE_SEND:"Y",DIALOG_ID:e,MESSAGE_ID:t,RATING:r,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(){if(this.BXIM.messenger.popupMessengerLiveChatDelayedForm){clearTimeout(this.BXIM.messenger.popupMessengerLiveChatActionTimeout);this.BXIM.messenger.popupMessengerLiveChatActionTimeout=setTimeout(s.delegate(function(){this.BXIM.messenger.linesLivechatFormShow(this.BXIM.messenger.popupMessengerLiveChatDelayedForm);this.BXIM.messenger.popupMessengerLiveChatDelayedForm=null},this),1e3)}},this)})};t.prototype.linesSaveToQuickAnswers=function(e,t){if(!this.BXIM.messenger.message[e]){return false}var r=this.BXIM.messenger.message[e].chatId;if(this.BXIM.messenger.blockJoinChat[r])return false;if(this.BXIM.messenger.chat[r]&&this.BXIM.messenger.chat[r].entity_type!="LINES")return false;if(!s.MessengerCommon.userInChat(r))return false;this.BXIM.messenger.blockJoinChat[r]=true;s.ajax({url:this.BXIM.pathToAjax+"?LINES_SAVE_TO_QUICK_ANSWERS&V="+this.BXIM.revision+"&logTag="+s.MessengerCommon.getLogTrackingParams({name:"imopenlines.message.saveToQuickAnswers",dialog:s.MessengerCommon.getDialogDataForTracking("chat"+r)}),method:"POST",dataType:"json",timeout:60,data:{COMMAND:"saveToQuickAnswers",CHAT_ID:r,MESSAGE_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(i){this.BXIM.messenger.blockJoinChat[r]=false;if(t!==true){if(i.ERROR){this.BXIM.openConfirm(i.ERROR)}else{this.BXIM.openConfirm(s.message("IM_SAVE_TO_QUICK_ANSWERS_SUCCESS"));this.BXIM.messenger.message[e].quick_saved=true}}},this),onfailure:s.delegate(function(){this.BXIM.messenger.blockJoinChat[r]=false;if(t!==true){this.BXIM.openConfirm(s.message("IM_SAVE_TO_QUICK_ANSWERS_ERROR"))}},this)})};t.prototype.linesVoteHeadNodes=function(e,t,r,i){t=t||0;r=r||false;var a=s.delegate(function(){if(!this.BXIM.messenger.openlines.canUseVoteHead){s.UI.InfoHelper.show("limit_contact_center_ol_boss_rate");return false}var e=s.proxy_context.getAttribute("data-rating");var t=s.proxy_context.getAttribute("data-sessionId");s.proxy_context.parentNode.previousSibling.style.width=e*20+"%";if(i)i.setAttribute("data-rating",e);this.linesVoteHeadSend(t,e);if(this.BXIM.messenger.popupTooltip)this.BXIM.messenger.popupTooltip.close()},this);return s.create("div",{props:{className:"bx-lines-rating-box"},children:[s.create("div",{props:{className:"bx-lines-rating-box-current"},attrs:{style:"width:"+t*20+"%"}}),r?s.create("div",{props:{className:"bx-lines-rating-box-live"},children:[s.create("span",{attrs:{"data-rating":1,"data-sessionId":e},props:{className:"bx-lines-rating-box-item"},events:{click:a}}),s.create("span",{attrs:{"data-rating":2,"data-sessionId":e},props:{className:"bx-lines-rating-box-item"},events:{click:a}}),s.create("span",{attrs:{"data-rating":3,"data-sessionId":e},props:{className:"bx-lines-rating-box-item"},events:{click:a}}),s.create("span",{attrs:{"data-rating":4,"data-sessionId":e},props:{className:"bx-lines-rating-box-item"},events:{click:a}}),s.create("span",{attrs:{"data-rating":5,"data-sessionId":e},props:{className:"bx-lines-rating-box-item"},events:{click:a}})]}):null]})};t.prototype.linesCommentHeadNodes=function(e,t,r,i){var a=null;if(!i){i="im"}if(typeof t==="undefined"||t===null||t==="")t="";r=r||false;var n=s.delegate(function(){if(!this.BXIM.messenger.openlines.canUseVoteHead){s.UI.InfoHelper.show("limit_contact_center_ol_boss_rate");return false}if(this.BXIM.messenger.linesCommentHeadAdd){this.BXIM.messenger.linesCommentHeadAdd(null,t)}if(this.BXIM.messenger.popupTooltip)this.BXIM.messenger.popupTooltip.close()},this);if(t===""){if(r&&this.BXIM.messenger.linesCommentHeadAdd){a=s.create("span",{attrs:{"data-sessionId":e,"data-context":i},props:{className:"bx-messenger-content-item-vote-comment-add"},html:s.message("IM_OL_COMMENT_HEAD_ADD"),events:{click:n}})}}else{var o=t.replace(/\n/gi,"<br />");if(r&&this.BXIM.messenger.linesCommentHeadAdd){a=s.create("span",{attrs:{"data-sessionId":e,"data-context":i},props:{className:"bx-messenger-content-item-vote-comment-edit"},html:o,events:{click:n}})}else{a=s.create("span",{attrs:{"data-sessionId":e,"data-context":i},props:{className:"bx-messenger-content-item-vote-comment-not-edit"},html:o})}}return a};t.prototype.linesVoteHeadSend=function(e,t,r){var i=false;if(!t){t=null}if(!r){r=null}e=parseInt(e);t=parseInt(t);if(t<=0||t>5||isNaN(t)){t=null}if(e>0&&(t!=null||r!=null)){if(t!=null){if(!this.BXIM.messenger.openlines["voteRatingHead"]){this.BXIM.messenger.openlines["voteRatingHead"]={}}this.BXIM.messenger.openlines["voteRatingHead"][e]=t}if(r!=null){if(!this.BXIM.messenger.openlines["voteCommentHead"]){this.BXIM.messenger.openlines["voteCommentHead"]={}}this.BXIM.messenger.openlines["voteCommentHead"][e]=r}s.ajax({url:this.BXIM.pathToAjax+"?LINES_VOTE_SEND&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"voteHead",SESSION_ID:e,RATING:t,COMMENT:r,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()}});i=true}return i};t.prototype.linesCanVoteAsHead=function(e){if(!this.BXIM.messenger.openlines||!this.BXIM.messenger.openlines.canVoteAsHead||!this.BXIM.messenger.openlines.canVoteAsHead[e]){return false}return true};t.prototype.linesGetCrmPath=function(e,s){if(!this.BXIM.path.crm[e])return"";return this.BXIM.path.crm[e].replace("#ID#",s)};t.prototype.linesGetSession=function(e){var s=null;if(!e||e.type!="lines")return s;s={};s.source=this.linesGetSource(e);var t=e.entity_id.toString().split("|");s.connector=t[0];s.canVoteHead=this.linesCanVoteAsHead(t[1]);var r=e.entity_data_1.toString().split("|");var i=e.entity_data_2.toString().split("|");s.crm=typeof r[0]!="undefined"&&r[0]=="Y"?"Y":"N";s.crmEntityType=typeof r[1]!="undefined"?r[1]:"NONE";s.crmEntityId=typeof r[2]!="undefined"?r[2]:0;s.crmLink="";s.pin=typeof r[3]!="undefined"&&r[3]=="Y"?"Y":"N";s.wait=typeof r[4]!="undefined"&&r[4]=="Y"?"Y":"N";s.id=typeof r[5]!="undefined"?parseInt(r[5]):Math.round(new Date/1e3)+e.id;s.dateCreate=typeof r[6]!="undefined"||r[6]>0?parseInt(r[6]):s.id;s.lineId=typeof r[7]!="undefined"&&r[7]>0?parseInt(r[7]):t[1];s.blockDate=typeof r[8]!="undefined"||r[8]>0?parseInt(r[8]):0;s.blockReason=typeof r[9]!="undefined"?r[9].toUpperCase():"NONE";s.crmLinkLead="";s.crmLead=0;s.crmLinkCompany="";s.crmCompany=0;s.crmLinkContact="";s.crmContact=0;s.crmLinkDeal="";s.crmDeal=0;if(i){var a;for(a=0;a<i.length;a=a+2){if(i[a]=="LEAD"&&i[a+1]!=0&&i[a+1]!="undefined"){s.crmLinkLead=this.linesGetCrmPath("LEAD",i[a+1]);s.crmLead=i[a+1]}if(i[a]=="COMPANY"&&i[a+1]!=0&&i[a+1]!="undefined"){s.crmLinkCompany=this.linesGetCrmPath("COMPANY",i[a+1]);s.crmCompany=i[a+1]}if(i[a]=="CONTACT"&&i[a+1]!=0&&i[a+1]!="undefined"){s.crmLinkContact=this.linesGetCrmPath("CONTACT",i[a+1]);s.crmContact=i[a+1]}if(i[a]=="DEAL"&&i[a+1]!=0&&i[a+1]!="undefined"){s.crmLinkDeal=this.linesGetCrmPath("DEAL",i[a+1]);s.crmDeal=i[a+1]}else{s.crmDeal=0}}}if(s.crmEntityType!="NONE"){s.crmLink=this.linesGetCrmPath(s.crmEntityType,s.crmEntityId)}return s};t.prototype.linesSetSession=function(e,s){var t=null;if(!this.BXIM.messenger.chat[e]||this.BXIM.messenger.chat[e].type!="lines")return t;t=this.linesGetSession(this.BXIM.messenger.chat[e]);if(typeof s.crm!="undefined"){t.crm=s.crm}if(typeof s.crmEntityType!="undefined"){t.crmEntityType=s.crmEntityType}if(typeof s.crmEntityId!="undefined"){t.crmEntityId=s.crmEntityId}if(typeof s.pin!="undefined"){t.pin=s.pin}if(typeof s.wait!="undefined"){t.wait=s.wait}if(typeof s.id!="undefined"){t.id=s.id}if(typeof s.dateCreate!="undefined"){t.dateCreate=s.dateCreate}if(typeof s.crmLead!="undefined"){t.crmLead=s.crmLead}if(typeof s.crmCompany!="undefined"){t.crmCompany=s.crmCompany}if(typeof s.crmContact!="undefined"){t.crmContact=s.crmContact}if(typeof s.crmDeal!="undefined"){t.crmDeal=s.crmDeal}this.BXIM.messenger.chat[e].entity_data_1=[t.crm,t.crmEntityType,t.crmEntityId,t.pin,t.wait,t.id,t.dateCreate].join("|");this.BXIM.messenger.chat[e].entity_data_2="LEAD|"+t.crmLead+"|COMPANY|"+t.crmCompany+"|CONTACT|"+t.crmContact+"|DEAL|"+t.crmDeal;return t};t.prototype.livechatGetSession=function(e){var s=null;if(!this.BXIM.messenger.chat[e]||this.BXIM.messenger.chat[e].type!="livechat")return s;s={};var t=this.BXIM.messenger.chat[e].entity_data_1.toString().split("|");s.readed=typeof t[0]!="undefined"&&t[0]=="Y"?"Y":"N";s.readedId=typeof t[1]!="undefined"?t[1]:0;s.readedTime=typeof t[2]!="undefined"?t[2]:false;s.sessionId=typeof t[3]!="undefined"?t[3]:0;s.showForm=typeof t[4]!="undefined"?t[4]:"Y";return s};t.prototype.linesGetSource=function(e){var s="";if(!e||!(e.type=="livechat"||e.type=="lines")){return s}if(e.type=="livechat"){s="livechat"}else{s=e.entity_id.toString().split("|")[0]}if(s=="skypebot"){s="skype"}else{s=s.replace(".","_")}return s};t.prototype.linesAnswer=function(e){if(this.BXIM.messenger.blockJoinChat[e])return false;if(this.BXIM.messenger.chat[e]&&this.BXIM.messenger.chat[e].entity_type!="LINES")return false;this.BXIM.messenger.blockJoinChat[e]=true;s.ajax({url:this.BXIM.pathToAjax+"?LINES_ANSWER&V="+this.BXIM.revision+"&logTag="+s.MessengerCommon.getLogTrackingParams({name:"imopenlines.operator.answer",dialog:s.MessengerCommon.getDialogDataForTracking("chat"+e)}),method:"POST",dataType:"json",timeout:60,data:{COMMAND:"answer",CHAT_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this),onfailure:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this)})};t.prototype.linesSkip=function(e){if(this.BXIM.messenger.blockJoinChat[e])return false;if(this.BXIM.messenger.chat[e]&&this.BXIM.messenger.chat[e].entity_type!="LINES")return false;if(!s.MessengerCommon.userInChat(e))return false;this.BXIM.messenger.blockJoinChat[e]=true;s.ajax({url:this.BXIM.pathToAjax+"?LINES_SKIP&V="+this.BXIM.revision+"&logTag="+s.MessengerCommon.getLogTrackingParams({name:"imopenlines.operator.skip",dialog:s.MessengerCommon.getDialogDataForTracking("chat"+e)}),method:"POST",dataType:"json",timeout:60,data:{COMMAND:"skip",CHAT_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(){if(this.closeSlider()){return true}this.BXIM.messenger.blockJoinChat[e]=false},this),onfailure:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this)});delete this.BXIM.messenger.chat[e];delete this.BXIM.messenger.showMessage["chat"+e]};t.prototype.linesActivateSilentMode=function(e,t,r){if(!r)return false;if(this.BXIM.messenger.blockJoinChat[e])return false;if(this.BXIM.messenger.chat[e]&&this.BXIM.messenger.chat[e].entity_type!="LINES")return false;if(!s.MessengerCommon.userInChat(e))return false;t=t=="Y"?"Y":"";if(this.BXIM.messenger.chat[e].entity_data_3==t)return false;this.BXIM.messenger.blockJoinChat[e]=true;s.ajax({url:this.BXIM.pathToAjax+"?LINES_ACTIVATE_SILENT_MODE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"silentMode",ACTIVATE:t?"Y":"N",CHAT_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false;this.BXIM.messenger.chat[e].entity_data_3=t},this),onfailure:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this)})};t.prototype.linesActivatePinMode=function(e,t){if(this.BXIM.messenger.blockJoinChat[e])return false;if(this.BXIM.messenger.chat[e]&&this.BXIM.messenger.chat[e].entity_type!="LINES")return false;if(!s.MessengerCommon.userInChat(e))return false;t=t=="Y"?"Y":"N";this.BXIM.messenger.blockJoinChat[e]=true;s.ajax({url:this.BXIM.pathToAjax+"?LINES_ACTIVATE_PIN_MODE&V="+this.BXIM.revision+"&logTag="+s.MessengerCommon.getLogTrackingParams({name:"imopenlines.operator.pin",dialog:s.MessengerCommon.getDialogDataForTracking("chat"+e),data:{timLinesPinAction:t}}),method:"POST",dataType:"json",timeout:60,data:{COMMAND:"pinMode",ACTIVATE:t,CHAT_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false;s.MessengerCommon.linesSetSession(e,{pin:t})},this),onfailure:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this)})};t.prototype.linesCloseDialog=function(e){if(this.BXIM.messenger.blockJoinChat[e])return false;if(this.BXIM.messenger.chat[e]&&this.BXIM.messenger.chat[e].entity_type!="LINES")return false;if(!s.MessengerCommon.userInChat(e))return false;this.BXIM.messenger.blockJoinChat[e]=true;s.MessengerCommon.dialogCloseCurrent();s.ajax({url:this.BXIM.pathToAjax+"?LINES_CLOSE_DIALOG&V="+this.BXIM.revision+"&logTag="+s.MessengerCommon.getLogTrackingParams({name:"imopenlines.operator.finish",dialog:s.MessengerCommon.getDialogDataForTracking("chat"+e)}),method:"POST",dataType:"json",timeout:60,data:{COMMAND:"closeDialog",CHAT_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false;s.MessengerCommon.linesSetSession(e,{wait:"Y"});this.BXIM.messenger.redrawChatHeader({userRedraw:false})},this),onfailure:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this)});delete this.BXIM.messenger.chat[e];delete this.BXIM.messenger.showMessage["chat"+e]};t.prototype.linesMarkAsSpam=function(e){if(this.BXIM.messenger.blockJoinChat[e])return false;if(this.BXIM.messenger.chat[e]&&this.BXIM.messenger.chat[e].entity_type!="LINES")return false;this.BXIM.messenger.blockJoinChat[e]=true;s.ajax({url:this.BXIM.pathToAjax+"?LINES_MARK_SPAM&V="+this.BXIM.revision+"&logTag="+s.MessengerCommon.getLogTrackingParams({name:"imopenlines.operator.spam",dialog:s.MessengerCommon.getDialogDataForTracking("chat"+e)}),method:"POST",dataType:"json",timeout:60,data:{COMMAND:"markSpam",CHAT_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false;this.linesSetSession(e,{id:0,wait:"Y"});this.dialogCloseCurrent();this.BXIM.messenger.redrawChatHeader({userRedraw:false})},this),onfailure:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this)});delete this.BXIM.messenger.chat[e];delete this.BXIM.messenger.showMessage["chat"+e]};t.prototype.linesInterceptSession=function(e){if(this.BXIM.messenger.blockJoinChat[e])return false;if(this.BXIM.messenger.chat[e]&&this.BXIM.messenger.chat[e].entity_type!="LINES")return false;this.BXIM.messenger.blockJoinChat[e]=true;s.ajax({url:this.BXIM.pathToAjax+"?LINES_INTERCEPT_SESSION&V="+this.BXIM.revision+"&logTag="+s.MessengerCommon.getLogTrackingParams({name:"imopenlines.session.intercept",dialog:s.MessengerCommon.getDialogDataForTracking("chat"+e)}),method:"POST",dataType:"json",timeout:60,data:{COMMAND:"interceptSession",CHAT_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this),onfailure:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this)})};t.prototype.linesCreateLead=function(e){if(this.BXIM.messenger.blockJoinChat[e])return false;if(this.BXIM.messenger.chat[e]&&this.BXIM.messenger.chat[e].entity_type!="LINES")return false;if(!s.MessengerCommon.userInChat(e))return false;var t=this.linesGetSession(this.BXIM.messenger.chat[e]);if(t.crm=="Y")return false;this.BXIM.messenger.blockJoinChat[e]=true;s.ajax({url:this.BXIM.pathToAjax+"?LINES_CREATE_LEAD&V="+this.BXIM.revision+"&logTag="+s.MessengerCommon.getLogTrackingParams({name:"imopenlines.operator.crm.create",dialog:s.MessengerCommon.getDialogDataForTracking("chat"+e)}),method:"POST",dataType:"json",timeout:60,data:{COMMAND:"createLead",CHAT_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this),onfailure:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this)})};t.prototype.linesChangeCrmEntity=function(t){if(!this.BXIM.messenger.message[t])return false;var r=this.BXIM.messenger.message[t].chatId;if(this.BXIM.messenger.blockJoinChat[r])return false;if(this.BXIM.messenger.chat[r]&&this.BXIM.messenger.chat[r].entity_type!="LINES")return false;if(!s.MessengerCommon.userInChat(r))return false;var i=this.linesGetSession(this.BXIM.messenger.chat[r]);if(i.crm=="N")return false;this.linesChangeCrmEntityMessageId=t;if(e.obCrm&&e.obCrm.olCrmSelector){e.obCrm.olCrmSelector.Open()}else{s.ajax({url:BXIM.pathToAjax+"?CRM_SELECTOR&V="+BXIM.revision,method:"POST",timeout:30,data:{IM_CRM_SELECTOR:"Y",sessid:s.bitrix_sessid()}});s.addCustomEvent("onCrmSelectorInit",function(t,r,i){if(r!="olCrmSelector")return true;setTimeout(function(){e.obCrm[r].Open();e.obCrm[r].AddOnSaveListener(function(e){s.MessengerCommon.linesChangeCrmEntityAjax(e)})},200)})}};t.prototype.linesChangeCrmEntityAjax=function(e){var t=false;for(var r in e["company"]){t=e["company"][r]}if(!t){for(var r in e["contact"]){t=e["contact"][r]}}if(!t){for(var r in e["lead"]){t=e["lead"][r]}}if(!t){return false}var i=this.linesChangeCrmEntityMessageId;if(!this.BXIM.messenger.message[i])return false;var a=this.BXIM.messenger.message[i].chatId;if(this.BXIM.messenger.blockJoinChat[a])return false;if(this.BXIM.messenger.chat[a]&&this.BXIM.messenger.chat[a].entity_type!="LINES")return false;if(!s.MessengerCommon.userInChat(a))return false;var n=t.id.split("_")[1];var o=t.type;this.BXIM.messenger.blockJoinChat[a]=true;s.ajax({url:this.BXIM.pathToAjax+"?LINES_CHANGE_CRM_ENTITY&V="+this.BXIM.revision+"&logTag="+s.MessengerCommon.getLogTrackingParams({name:"imopenlines.operator.crm.change",dialog:s.MessengerCommon.getDialogDataForTracking("chat"+a)}),method:"POST",dataType:"json",timeout:60,data:{COMMAND:"changeCrmEntity",CHAT_ID:a,MESSAGE_ID:i,ENTITY_TYPE:o,ENTITY_ID:n,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(){this.BXIM.messenger.blockJoinChat[a]=false},this),onfailure:s.delegate(function(){this.BXIM.messenger.blockJoinChat[a]=false},this)})};t.prototype.linesCancelCrmExtend=function(e){if(!this.BXIM.messenger.message[e])return false;var t=this.BXIM.messenger.message[e].chatId;if(this.BXIM.messenger.blockJoinChat[t])return false;if(this.BXIM.messenger.chat[t]&&this.BXIM.messenger.chat[t].entity_type!="LINES")return false;if(!s.MessengerCommon.userInChat(t))return false;this.BXIM.messenger.blockJoinChat[t]=true;s.ajax({url:this.BXIM.pathToAjax+"?LINES_CANCEL_CRM_EXTEND&V="+this.BXIM.revision+"&logTag="+s.MessengerCommon.getLogTrackingParams({name:"imopenlines.operator.crm.cancel",dialog:s.MessengerCommon.getDialogDataForTracking("chat"+t)}),method:"POST",dataType:"json",timeout:60,data:{COMMAND:"cancelCrmExtend",CHAT_ID:t,MESSAGE_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(){this.BXIM.messenger.blockJoinChat[t]=false},this),onfailure:s.delegate(function(){this.BXIM.messenger.blockJoinChat[t]=false},this)});s.remove(s("im-message-keyboard-"+e))};t.prototype.getMessagePlural=function(e,t){var r,i;i=s.message("LANGUAGE_ID")||"en";t=parseInt(t);if(t<0){t=-1*t}if(i){switch(i){case"de":case"en":r=t!==1?1:0;break;case"ru":case"ua":r=t%10===1&&t%100!==11?0:t%10>=2&&t%10<=4&&(t%100<10||t%100>=20)?1:2;break;default:r=1;break}}else{r=1}return s.message(e+"_PLURAL_"+r)};t.prototype.openStore=function(){if(!s.MessengerCommon.isSliderSupport()){if(this.isDesktop()){s.desktop.browse("/online/?IM_DIALOG="+this.BXIM.messenger.currentTab)}else{this.BXIM.openConfirm(s.message("IM_FUNCTION_FOR_BROWSER"))}return false}else{var e=this.getDialogId();var t=this.linesGetSession(this.BXIM.messenger.chat[e.substr(4)]);var r=s.util.add_url_param("/saleshub/app/",{dialogId:e,sessionId:t.id});s.SidePanel.Instance.open(r,{allowChangeHistory:false,width:873})}};t.prototype.openRenamePortal=function(e){if(e&&s.hasClass(e,"bx-messenger-keyboard-button-block")){return false}if(this.isMobile()){app.alert({text:s.message("IM_FUNCTION_FOR_BROWSER")})}if(this.isDesktop()){s.desktop.browse(this.BXIM.path.profile+"?b24renameform=1","desktopApp")}else if(typeof s.Bitrix24!="undefined"){s.Bitrix24.renamePortal()}else{this.BXIM.openConfirm(s.message("IM_UNKNOWN_ERROR"))}return true};t.prototype.updateUserData=function(e){var t;if(s.type.isPlainObject(e.users)){for(t in e.users){e.users[t].last_activity_date=new Date(e.users[t].last_activity_date);e.users[t].mobile_last_date=new Date(e.users[t].mobile_last_date);e.users[t].idle=e.users[t].idle?new Date(e.users[t].idle):false;e.users[t].absent=e.users[t].absent?new Date(e.users[t].absent):false;this.BXIM.messenger.users[t]=e.users[t]}}if(s.type.isPlainObject(e.hrphoto)){for(t in e.hrphoto){this.BXIM.messenger.hrphoto[t]=e.hrphoto[t]}}if(s.type.isPlainObject(e.chat)){for(t in e.chat){e.chat[t].date_create=new Date(e.chat[t].date_create);this.BXIM.messenger.chat[t]=e.chat[t]}}if(s.type.isPlainObject(e.userInChat)){for(t in e.userInChat){this.BXIM.messenger.userInChat[t]=e.userInChat[t]}}};s.MessengerCommon=new t;var r=function(){this.list={};this.updateInterval=1e3;clearInterval(this.updateIntervalId);this.updateIntervalId=setInterval(this.worker.bind(this),this.updateInterval)};r.prototype.start=function(e,s,t,r,i){s=s===null?"default":s;t=parseInt(t);if(t<=0||s.toString().length<=0){return false}if(typeof this.list[e]=="undefined"){this.list[e]={}}this.list[e][s]={dateStop:(new Date).getTime()+t,callback:typeof r=="function"?r:function(){},callbackParams:typeof i=="undefined"?{}:i};return true};r.prototype.stop=function(e,s,t){s=s===null?"default":s;if(s.toString().length<=0||typeof this.list[e]=="undefined"){return false}if(!this.list[e][s]){return true}if(t!==true){this.list[e][s]["callback"](s,this.list[e][s]["callbackParams"])}delete this.list[e][s];return true};r.prototype.stopAll=function(e){for(var s in this.list){if(this.list.hasOwnProperty(s)){for(var t in this.list[s]){if(this.list[s].hasOwnProperty(t)){this.stop(s,t,e)}}}}return true};r.prototype.worker=function(){for(var e in this.list){if(!this.list.hasOwnProperty(e)){continue}for(var s in this.list[e]){if(!this.list[e].hasOwnProperty(s)||this.list[e][s]["dateStop"]>new Date){continue}this.stop(e,s)}}return true};r.prototype.destroy=function(){clearInterval(this.updateIntervalId);this.stopAll(true);return true};s.MessengerTimer=new r})(window);
/* End */
;
; /* Start:"a:4:{s:4:"full";s:43:"/bitrix/js/im/window.min.js?159956819317813";s:6:"source";s:23:"/bitrix/js/im/window.js";s:3:"min";s:27:"/bitrix/js/im/window.min.js";s:3:"map";s:27:"/bitrix/js/im/window.map.js";}"*/
(function(t){if(t.BX.MessengerWindow)return;var e=t.BX;var i=function(){this.popupConfirm=null;this.BXIM={};this.popup=null;this.backgroundSelector=null;this.content=null;this.contentFullWindow=true;this.contentBodyWindow=false;this.contentMenu=null;this.contentAvatar=null;this.contentTab=null;this.contentTabContent=null;this.currentTab="";this.currentTabTarget="";this.lastTab="";this.lastTabTarget="";this.tabItems={};this.tabRedrawTimeout=null;this.userInfo={id:0,name:"",gender:"M",avatar:"",profile:""};this.inited=false;this.width=914;this.height=454;this.initWidth=914;this.initHeight=454;this.minWidth=515;this.minHeight=384};i.prototype.init=function(i){i=i||{};if(this.inited){return true}this.inited=true;this.BXIM=i.bxim||{};this.context=i.context||"DESKTOP";this.design=i.design||"DESKTOP";if(this.context=="SLIDER"){this.content=e.create("div",{})}else if(this.context=="FULLSCREEN"||this.context=="POPUP-FULLSCREEN"||this.context=="PAGE"||this.context=="DIALOG"||this.context=="LINES"){if(this.context=="FULLSCREEN"||this.context=="PAGE"||this.context=="POPUP-FULLSCREEN"){this.contentBodyWindow=true}this.popup=e("im-workarea-popup");this.popupBackground=this.popup;this.content=e("im-workarea-content");this.apps=e("im-workarea-apps");this.backgroundSelector=e("im-workarea-backgound-selector");if(!this.content){this.popup=e("workarea-popup");this.content=e("workarea-content")}if(this.popup){e.addClass(this.popup,"bx-im-fullscreen-closed");e.bind(this.popup,"click",e.delegate(this.closePopup,this))}else{this.popupBackground=e("im-workarea-popup-bg")}if(this.context=="PAGE"){var s=t.innerWidth-document.documentElement.clientWidth;e.onCustomEvent(t,"onMessengerWindowBodyOverflow",[this,s]);e.addClass(document.body,"bx-im-fullscreen-block-scroll")}if(this.backgroundSelector){e.bind(this.backgroundSelector.parentNode,"click",e.delegate(e.PreventDefault,this));e.bind(this.backgroundSelector,"change",e.delegate(function(t){this.backgroundChange();e.localStorage.set("imFullscreenBackground",this.backgroundSelector.value,3e6);return e.PreventDefault(t)},this));var n=e.localStorage.get("imFullscreenBackground");if(n!==null){this.backgroundSelector.value=n}this.backgroundChange()}if(!this.content){this.content=e.create("div",{attrs:{className:"bx-desktop"}});document.body.insertBefore(this.content,document.body.firstChild)}if(this.apps){e.bind(this.apps,"click",e.delegate(e.MessengerCommon.preventDefault,this))}e.bind(this.content,"click",e.delegate(e.MessengerCommon.preventDefault,this));if(!e.hasClass(this.content,"bx-desktop")){e.addClass(this.content,"bx-desktop")}if(this.context=="LINES"||this.context=="DIALOG"){this.contentFullWindow=false}else if(this.context!="POPUP-FULLSCREEN"){if(this.content.offsetWidth<this.minWidth){e.style(this.content,"width",this.minWidth+"px")}}}else{this.content=e.create("div");document.body.insertBefore(this.content,document.body.firstChild)}this.withMenu=false;if(this.context==="DESKTOP"||this.context==="FULLSCREEN"){e.addClass(this.content,"bx-desktop-appearance-show-menu");this.withMenu=true}if(e.desktop&&e.desktop.apiReady&&(navigator.userAgent.toLowerCase().indexOf("linux")>0&&!e.desktop.enableInVersion(29)||navigator.userAgent.toLowerCase().indexOf("linux")<0&&!e.desktop.enableInVersion(37))){e.PULL.tryConnectSet(null,false);e.desktop.notSupported();e.desktop.apiReady=false;e.desktop.disableLogin=true;return false}if(e.browser.SupportLocalStorage()){e.addCustomEvent(t,"onLocalStorageSet",e.delegate(this.storageSet,this))}if(e.MessengerCommon.isDesktop()){e.MessengerWindow.addTab({id:"exit",title:e.message("BXD_LOGOUT"),order:1100,target:false,events:{open:e.delegate(function(){this.logout(false,"exit_tab")},this)}})}e.bind(t,"resize",e.delegate(function(){this.adjustSize()},this))};i.prototype.browse=function(i){if(e.MessengerCommon.isDesktop()){e.desktop.browse(i)}else if(this.context=="POPUP-FULLSCREEN"){location.href=i}else{t.open(i,"_blank")}};i.prototype.getCurrentUrl=function(){return document.location.protocol+"//"+document.location.hostname+(document.location.port==""?"":":"+document.location.port)};i.prototype.windowReload=function(){location.reload()};i.prototype.logout=function(t,i,s){if(typeof BXDesktopSystem=="undefined"||typeof BXDesktopWindow=="undefined"){location.href="/?logout=yes";return true}if(e.desktop&&e.desktop.apiReady){e.desktop.logout(t,i,s)}return true};i.prototype.adjustSize=function(i,s,n){if(this.context=="POPUP-FULLSCREEN"&&e.hasClass(this.popup,"bx-im-fullscreen-closed")){return false}var o=0;var a=0;if(this.context=="SLIDER"){a=this.content.parentNode?this.content.parentNode.offsetHeight:this.initHeight;o=this.content.offsetWidth;if(!n){clearTimeout(this.sliderResizeTimeout);this.sliderResizeTimeout=setTimeout(function(){e.MessengerWindow.adjustSize(undefined,undefined,true);BXIM.desktop.adjustSize()},300)}}else if(this.contentBodyWindow){if(!this.popupFullscreenSizeTop&&!this.popupFullscreenSizeBottom){var r=e.pos(this.content.parentNode);this.popupFullscreenSizeTop=r.top;this.popupFullscreenSizeBottom=t.innerHeight-r.top-r.height}a=Math.max(t.innerHeight-this.popupFullscreenSizeTop-this.popupFullscreenSizeBottom,this.initHeight);o=this.content.offsetWidth}else if(this.contentFullWindow){o=t.innerWidth;a=t.innerHeight}else{try{e.style(document.body,"height",t.innerHeight+"px")}catch(t){setTimeout(function(){this.adjustSize(i,s)},500)}o=Math.max(this.content.offsetWidth,this.minWidth);a=Math.max(this.content.offsetHeight,this.minHeight)}if(e.desktop&&e.desktop.apiReady&&(!i||!s)&&(a<this.minHeight||o<this.minWidth)){return false}if(this.context=="POPUP-FULLSCREEN"&&e.browser.IsMobile()){this.height=this.initHeight;this.width=this.initWidth}else{e.addClass(this.content,"bx-im-fullscreen-adaptive");this.width=i?i:o;this.height=s?s:a}e.style(this.contentMenu,"height",this.height+"px");e.style(this.contentTabContent,"height",this.height+"px");e.style(this.content,"max-width",t.innerWidth+"px");return true};i.prototype.openConfirm=function(t,i,s){if(this.popupConfirm!=null)this.popupConfirm.destroy();if(typeof t=="object")t='<div class="bx-desktop-confirm-title">'+t.title+"</div>"+t.message;s=s!==false;if(typeof i=="undefined"||typeof i=="object"&&i.length<=0){i=[new e.PopupWindowButton({text:e.message("BXD_CONFIRM_CLOSE"),className:"popup-window-button-decline",events:{click:function(t){this.popupWindow.close();e.PreventDefault(t)}}})]}this.popupConfirm=new e.PopupWindow("bx-desktop-confirm",null,{zIndex:200,autoHide:i===false,buttons:i,closeByEsc:i===false,overlay:s,events:{onPopupClose:function(){this.destroy()},onPopupDestroy:e.delegate(function(){this.popupConfirm=null},this)},content:e.create("div",{props:{className:i===false?" bx-desktop-confirm-without-buttons":"bx-desktop-confirm"},html:t})});this.popupConfirm.show();e.bind(this.popupConfirm.popupContainer,"click",e.PreventDefault);e.bind(this.popupConfirm.contentContainer,"click",e.PreventDefault);e.bind(this.popupConfirm.overlay.element,"click",e.PreventDefault);return true};i.prototype.addSeparator=function(t){t.type="separator";t.id="sep"+ +new Date;this.tabItems[t.id]=t;this.drawTabs()};i.prototype.addTab=function(t){if(!t||!t.id||!t.title)return false;if(!t.order)t.order=500;t.hide=t.hide?true:false;if(parseInt(t.badge)>0){t.badge=parseInt(t.badge)}else{t.badge=0}if(!t.initContent||!e.type.isDomNode(t.initContent))t.initContent=null;if(!t.events)t.events={};if(typeof t.target=="undefined")t.target=t.id;if(!t.events.open)t.events.open=function(){};if(!t.events.close)t.events.close=function(){};if(!t.events.init)t.events.init=function(){};t.type="item";this.tabItems[t.id]=t;this.drawTabs()};i.prototype.hideTab=function(t){if(!t||!this.tabItems[t])return false;this.tabItems[t].hide=true;this.drawTabs()};i.prototype.showTab=function(t){if(!t||!this.tabItems[t])return false;this.tabItems[t].hide=false;this.drawTabs()};i.prototype.existsTab=function(t){return this.tabItems[t]};i.prototype.drawTabs=function(t){if(!t){clearTimeout(this.tabRedrawTimeout);this.tabRedrawTimeout=setTimeout(e.delegate(function(){this.drawTabs(true)},this),100);return true}if(!this.contentTabContent){if(!this.drawAppearance())return false}this.contentTab.innerHTML="";var i=e.util.objectSort(this.tabItems,"order","asc");for(var s=0;s<i.length;s++){this.drawTab(i[s])}e.onCustomEvent(this,"OnDesktopTabsInit");if(this.currentTab==""){if(i[0].id=="exit"){if(typeof i[1]!="undefined"){this.changeTab(i[1].id)}}else{this.changeTab(i[0].id)}}if(e.desktop&&e.desktop.apiReady){e.desktop.updateTabBadge()}return true};i.prototype.drawTab=function(t){if(t.type=="separator"){this.contentTab.appendChild(e.create("div",{attrs:{"data-id":t.id,id:"bx-desktop-sep-"+t.id},props:{className:"bx-desktop-separator"}}))}else{this.contentTab.appendChild(e.create("div",{attrs:{"data-id":t.id,id:"bx-desktop-tab-"+t.id,title:t.title},props:{className:"bx-desktop-tab bx-desktop-tab-"+t.id+(this.currentTab==t.id?" bx-desktop-tab-active":"")+(t.hide?" bx-desktop-tab-hide":"")},children:[e.create("span",{props:{className:"bx-desktop-tab-counter"},html:t.badge>0?'<span class="bx-desktop-tab-counter-digit">'+(t.badge>50?"50+":t.badge)+"</span>":""}),e.create("div",{props:{className:"bx-desktop-tab-icon bx-desktop-tab-icon-"+t.id}})]}));if(!e("bx-desktop-tab-content-"+t.id)&&t.id==t.target){var i=false;if(this.currentTab==t.id||this.tabItems[this.currentTab]&&this.tabItems[this.currentTab].target==t.id){i=true}this.contentTabContent.appendChild(e.create("div",{attrs:{"data-id":t.id,id:"bx-desktop-tab-content-"+t.id},props:{className:"bx-desktop-tab-content bx-desktop-tab-content-"+t.id+(i?" bx-desktop-tab-content-active":"")},children:t.initContent?[t.initContent]:[]}));t.events.init()}}return true};i.prototype.drawAppearance=function(){if(!this.content)return false;this.content.innerHTML="";this.content.appendChild(this.contentBox=e.create("div",{props:{className:"bx-desktop-appearance "+(this.BXIM.settings.enableDarkTheme?"bx-messenger-dark":"")},style:{minHeight:this.minHeight+"px"},children:[this.contentMenu=e.create("div",{props:{className:"bx-desktop-appearance-menu"},children:[this.contentAvatar=e.create("div",{props:{className:"bx-desktop-appearance-avatar"}}),this.contentTab=e.create("div",{props:{className:"bx-desktop-appearance-tab"}})]}),this.contentTabContent=e.create("div",{props:{className:"bx-desktop-appearance-content"}})]}));e.bindDelegate(this.contentTab,"click",{className:"bx-desktop-tab"},e.delegate(function(t){this.changeTab(t,false);e.PreventDefault(t)},this));this.adjustSize();e.onCustomEvent(t,"onMessengerWindowInit",[this,this.BXIM]);return true};i.prototype.changeTab=function(t,i,s){i=typeof i=="undefined"?true:i;s=typeof s=="undefined"?false:s;if(typeof t=="object"){if(!e.proxy_context){return false}t=e.proxy_context.getAttribute("data-id")}if(!this.tabItems[t])return false;if(this.tabItems[t].target){var n=false;if(!i||this.currentTab!=t){this.lastTab=this.currentTab;this.lastTabTarget=this.currentTabTarget;this.currentTab=this.tabItems[t].id;this.currentTabTarget=this.tabItems[t].target;n=true}if(e("bx-desktop-tab-"+this.lastTab))e.removeClass(e("bx-desktop-tab-"+this.lastTab),"bx-desktop-tab-active");if(e("bx-desktop-tab-"+t))e.addClass(e("bx-desktop-tab-"+t),"bx-desktop-tab-active");if(e("bx-desktop-tab-content-"+this.lastTab)){e.removeClass(e("bx-desktop-tab-content-"+this.lastTab),"bx-desktop-tab-content-active")}else if(e("bx-desktop-tab-content-"+this.lastTabTarget)){e.removeClass(e("bx-desktop-tab-content-"+this.lastTabTarget),"bx-desktop-tab-content-active")}if(e("bx-desktop-tab-content-"+this.currentTab)){e.addClass(e("bx-desktop-tab-content-"+this.currentTab),"bx-desktop-tab-content-active")}else if(e("bx-desktop-tab-content-"+this.currentTabTarget)){e.addClass(e("bx-desktop-tab-content-"+this.currentTabTarget),"bx-desktop-tab-content-active")}if(n&&!s){if(this.tabItems[this.lastTab]){this.tabItems[this.lastTab].events.close()}if(this.tabItems[this.currentTab]){e.onCustomEvent(this,"OnDesktopTabChange",[this.currentTab,this.lastTab]);this.tabItems[this.currentTab].events.open()}}}else if(!s){this.tabItems[t].events.open()}return true};i.prototype.closeTab=function(t){t=t||this.getCurrentTab();if(!this.tabItems[t]||this.getCurrentTab()!=t)return false;if(this.tabItems[t].target!=this.currentTabTarget){this.changeTab(t,false)}else{if(e("bx-desktop-tab-"+this.currentTab))e.removeClass(e("bx-desktop-tab-"+this.currentTab),"bx-desktop-tab-active");if(e("bx-desktop-tab-"+this.lastTab))e.addClass(e("bx-desktop-tab-"+this.lastTab),"bx-desktop-tab-active");var i=this.lastTab;this.lastTab=this.currentTab;this.currentTab=i}};i.prototype.setTabBadge=function(t,i){if(!this.tabItems[t])return false;i=parseInt(i);this.tabItems[t].badge=i>0?i:0;if(i>50)i="50+";if(e("bx-desktop-tab-"+t)){var s=e.findChild(e("bx-desktop-tab-"+t),{className:"bx-desktop-tab-counter"},true);if(s)s.innerHTML=i?'<span class="bx-desktop-tab-counter-digit">'+i+"</span>":""}};i.prototype.setTabContent=function(t,i){if(!this.tabItems[t]){return false}if(e("bx-desktop-tab-content-"+t)){if(e.type.isDomNode(i)){e("bx-desktop-tab-content-"+t).innerHTML="";e("bx-desktop-tab-content-"+t).appendChild(i)}else{e("bx-desktop-tab-content-"+t).innerHTML=i}}else{this.tabItems[t].initContent=i}return true};i.prototype.getCurrentTab=function(){return this.currentTab};i.prototype.getCurrentTabTarget=function(){return this.currentTabTarget};i.prototype.setUserInfo=function(t){if(!this.userInfo){if(!t||!t.id||!t.name)return false}if(t){if(!t.gender)t.gender="M";if(!t.avatar||!t.profile)t.avatar="";this.userInfo=t}if(!this.contentAvatar){if(!this.drawAppearance())return false}var i={};i.click=function(t){BXIM.openMessenger(BXIM.userId);return e.PreventDefault(t)};this.contentAvatar.innerHTML="";this.contentAvatar.appendChild(e.create("a",{attrs:{href:this.userInfo.profile,title:e.util.htmlspecialcharsback(this.userInfo.name),target:"_blank","data-slider-ignore-autobinding":"true"},props:{className:"bx-desktop-avatar"},events:i,children:[e.create("img",{attrs:{src:this.userInfo.avatar,style:e.MessengerCommon.isBlankAvatar(this.userInfo.avatar)?"background-color: "+this.userInfo.color:""},props:{className:"bx-desktop-avatar-img bx-desktop-avatar-img-default"}})]}));return true};i.prototype.updateUserInfo=function(t){for(var e in t){this.userInfo[e]=t[e]}return this.setUserInfo(this.userInfo)};i.prototype.getUserInfo=function(){return this.userInfo};i.prototype.isPopupShow=function(){if(this.context=="DESKTOP")return true;else if(this.context=="PAGE")return true;else if(this.context=="POPUP-FULLSCREEN"&&!e.hasClass(this.popup,"bx-im-fullscreen-closed"))return true;else if(this.context=="SLIDER"&&e.MessengerSlider.isOpen())return true;return false};i.prototype.backgroundChange=function(){if(!this.backgroundSelector){return}var t=this.backgroundSelector.value;if(t=="transparent"){e.removeClass(this.popupBackground,"bx-im-fullscreen-popup-bitrix24");e.addClass(this.popupBackground,"bx-im-fullscreen-popup-transparent");e.style(this.popupBackground,"background","");e.style(this.popupBackground,"backgroundSize","")}else if(t>0){e.removeClass(this.popupBackground,"bx-im-fullscreen-popup-bitrix24");e.removeClass(this.popupBackground,"bx-im-fullscreen-popup-transparent");e.style(this.popupBackground,"background","url(/bitrix/js/im/images/bg-image-"+t+".jpg) #ccc");e.style(this.popupBackground,"backgroundSize","cover")}else{e.removeClass(this.popupBackground,"bx-im-fullscreen-popup-transparent");e.addClass(this.popupBackground,"bx-im-fullscreen-popup-bitrix24");e.style(this.popupBackground,"background","");e.style(this.popupBackground,"backgroundSize","")}};i.prototype.setZIndex=function(t){e.style(this.popup,"z-index",t)};i.prototype.showPopup=function(i){if(this.isPopupShow())return false;this.popupTimestart=+new Date;clearTimeout(this.popupTimeout);var s=t.innerWidth-document.documentElement.clientWidth;e.onCustomEvent(t,"onMessengerWindowBodyOverflow",[this,s]);e.addClass(document.body,"bx-im-fullscreen-block-scroll");e.addClass(this.popup,"bx-im-fullscreen-opening");e.removeClass(this.popup,"bx-im-fullscreen-closing");e.removeClass(this.popup,"bx-im-fullscreen-closed");this.adjustSize();this.BXIM.desktop.initHeight=this.content.offsetHeight;this.popupTimeout=setTimeout(e.delegate(function(){e.removeClass(this.popup,"bx-im-fullscreen-opening");e.addClass(this.popup,"bx-im-fullscreen-open")},this),400);if(e.SidePanel&&e.SidePanel.Instance.getTopSlider()){var n=e.SidePanel.Instance.getTopSlider().getZindex();this.setZIndex(n+1)}e.onCustomEvent(this,"OnMessengerWindowShowPopup",[i]);return true};i.prototype.closePopup=function(i){if(!e.type.isPlainObject(i)){i={}}if(!this.isPopupShow()||this.BXIM.callController.hasActiveCall()||this.redirectFlag)return false;if(this.popupTimestart+400>+new Date)return false;if(i.redirect){this.redirectFlag=true;document.location.href=i.redirect;return true}clearTimeout(this.popupTimeout);e.removeClass(document.body,"bx-im-fullscreen-block-scroll");e.onCustomEvent(this,"OnMessengerWindowClosePopup",[]);e.onCustomEvent(t,"onMessengerWindowBodyOverflow",[this,0]);e.addClass(this.popup,"bx-im-fullscreen-open");e.addClass(this.popup,"bx-im-fullscreen-closing");e.removeClass(this.popup,"bx-im-fullscreen-opening");this.popupTimeout=setTimeout(e.delegate(function(){e.removeClass(this.popup,"bx-im-fullscreen-closing");e.removeClass(this.popup,"bx-im-fullscreen-open");e.addClass(this.popup,"bx-im-fullscreen-closed");e.style(this.popup,"z-index","")},this),400);return true};i.prototype.storageSet=function(t){if(!this.backgroundSelector)return false;if(t.key!="imFullscreenBackground")return false;this.backgroundSelector.value=t.value;this.backgroundChange()};e.MessengerWindow=new i})(window);
/* End */
;
; /* Start:"a:4:{s:4:"full";s:40:"/bitrix/js/im/im.min.js?1599568296672551";s:6:"source";s:19:"/bitrix/js/im/im.js";s:3:"min";s:23:"/bitrix/js/im/im.min.js";s:3:"map";s:23:"/bitrix/js/im/im.map.js";}"*/
(function(){if(BX.IM)return;BX.IM=function(e,t){BX.onCustomEvent(window,"onImInitBefore",[this]);this.init=typeof t.init!="undefined"?t.init:true;if(typeof BX.message("USER_TZ_OFFSET")==="undefined"||BX.message("USER_TZ_AUTO")=="Y")BX.message({USER_TZ_OFFSET:-(new Date).getTimezoneOffset()*60-parseInt(BX.message("SERVER_TZ_OFFSET"))});if(typeof BX.MessengerCommon!="undefined")BX.MessengerCommon.setBxIm(this);if(typeof BX.MessengerSlider!="undefined")BX.MessengerSlider.setBxIm(this);if(typeof BX.MessengerCalls!="undefined")BX.MessengerCalls.setBxIm(this);if(typeof BX.MessengerPromo!="undefined")BX.MessengerPromo.init(t.promo,this);this.mobileVersion=false;this.mobileAction="none";this.revision=130;this.revisionError={active:false,notified:false,notifyArmed:false,notifyTime:0,reloadTime:0,text:""};this.ieVersion=BX.browser.DetectIeVersion();this.errorMessage="";this.animationSupport=true;this.context=t.context;this.design=t.design;this.isUtfMode=t.isUtfMode;this.isAdmin=t.isAdmin;this.bitrixNetwork=t.bitrixNetwork;this.bitrixNetwork2=t.bitrixNetwork2;this.bitrixOpenLines=t.bitrixOpenLines;this.bitrix24=t.bitrix24;this.bitrix24blocked=t.bitrix24blocked;this.bitrixIntranet=t.bitrixIntranet;this.bitrix24net=t.bitrix24net;this.bitrixXmpp=t.bitrixXmpp;this.bitrixMobile=t.bitrixMobile;this.colors=t.colors;this.colorsHex=t.colorsHex;this.ppStatus=t.ppStatus;this.ppServerStatus=this.ppStatus?t.ppServerStatus:false;this.updateStateInterval=t.updateStateInterval;this.desktopStatus=t.desktopStatus||false;this.desktopVersion=t.desktopVersion;this.desktopProtocolVersion=2;this.xmppStatus=t.xmppStatus;this.lastRecordId=0;this.debug=t.debug||false;this.userId=t.userId;this.userEmail=t.userEmail;this.userColor=t.userColor;this.userGender=t.userGender;this.userExtranet=t.userExtranet;this.options=t.options||{};this.path=t.path;this.language=t.language||"en";this.windowFocus=true;this.windowFocusTimeout=null;this.extraBind=null;this.extraOpen=false;this.dialogOpen=false;this.notifyOpen=false;this.adjustSizeTimeout=null;this.tryConnect=true;this.openSettingsFlag=typeof t.openSettings!="undefined"?t.openSettings:false;this.popupConfirm=null;this.zoomStatus=t.zoomStatus;this.settings=t.settings;this.settingsDisabled={};this.settingsView=t.settingsView||{common:{},notify:{},privacy:{}};this.settingsNotifyBlocked=t.settingsNotifyBlocked||{};this.settingsTableConfig={};this.settingsSaveCallback={};this.settingsCameraTestMediaStream=null;this.micTestMediaStream=null;this.settingsLevelMeter=null;this.saveSettingsTimeout={};this.popupSettings=null;if(t.users&&t.users[this.userId])t.users[this.userId].status=this.settings.status;this.pathToAjax=t.path.im?t.path.im:"/bitrix/components/bitrix/im.messenger/im.ajax.php";this.pathToCallAjax=t.path.call?t.path.call:"/bitrix/components/bitrix/im.messenger/call.ajax.php";this.pathToFileAjax=t.path.file?t.path.file:"/bitrix/components/bitrix/im.messenger/file.ajax.php";this.pathToBlankImage="/bitrix/js/im/images/blank.gif";this.audio={};this.audio.reminder=null;this.audio.newMessage1=null;this.audio.newMessage2=null;this.audio.send=null;this.audio.dialtone=null;this.audio.ringtone=null;this.audio.start=null;this.audio.stop=null;this.audio.current=null;this.audio.timeout={};this.mailCount=t.mailCount;this.notifyCount=t.notifyCount||0;this.messageCount=t.messageCount||0;this.linesCount=t.linesCount||0;this.quirksMode=BX.browser.IsIE()&&!BX.browser.IsDoctype()&&(/MSIE 8/.test(navigator.userAgent)||/MSIE 9/.test(navigator.userAgent));this.platformName=BX.browser.IsMac()?"OS X":/windows/.test(navigator.userAgent.toLowerCase())?"Windows":"";if(BX.browser.IsIE()&&!BX.browser.IsIE9()&&/MSIE 7/i.test(navigator.userAgent))this.errorMessage=BX.message("IM_M_OLD_BROWSER");if(this.context=="POPUP-FULLSCREEN"&&BX.browser.IsMobile()&&false){this.design="POPUP"}if(this.context=="DESKTOP"||this.context=="FULLSCREEN"||this.context=="PAGE"||this.context=="DIALOG"||this.context=="LINES"||this.context=="POPUP-FULLSCREEN"){if(BX.desktop){BX.desktop.init({context:this.context,design:this.design,bxim:this})}if(BX.MessengerCommon.isPage()){if(this.context=="POPUP-FULLSCREEN"&&BX.MessengerCommon.isIntranet()){BX.MessengerWindow.init({context:"SLIDER",design:this.design,bxim:this})}else{BX.MessengerWindow.init({context:this.context,design:this.design,bxim:this})}}}this.desktop=new BX.IM.Desktop(this,{desktop:t.desktop});this.webrtc=new BX.IM.WebRTC(this,{desktopClass:this.desktop,phoneEnabled:t.webrtc&&t.webrtc.phoneEnabled||false,phoneCanPerformCalls:t.webrtc&&t.webrtc.phoneCanPerformCalls=="Y"||false,phoneCanCallUserNumber:t.webrtc&&t.webrtc.phoneCanCallUserNumber||false,phoneDeviceActive:t.webrtc&&t.webrtc.phoneDeviceActive||"N",phoneDeviceCall:t.webrtc&&t.webrtc.phoneDeviceCall||"Y",phoneCrm:t.phoneCrm&&t.phoneCrm||{},phoneLines:t.webrtc&&t.webrtc.phoneLines||{},phoneDefaultLineId:t.webrtc&&t.webrtc.phoneDefaultLineId||"",phoneAvailableLines:t.webrtc&&t.webrtc.availableLines||[],turnServer:t.webrtc&&t.webrtc.turnServer||"",turnServerFirefox:t.webrtc&&t.webrtc.turnServerFirefox||"",turnServerLogin:t.webrtc&&t.webrtc.turnServerLogin||"",turnServerPassword:t.webrtc&&t.webrtc.turnServerPassword||"",panel:e!=null?e:BX.create("div")});this.callController=new BX.Call.Controller({});BX.PhoneCallView.setDefaults({restApps:t.webrtc&&t.webrtc.phoneCallCardRestApps||[],callInterceptAllowed:t.webrtc&&t.webrtc.phoneCanInterceptCall||false});this.desktop.webrtc=this.webrtc;if(BX.MessengerCommon.isDesktop()){if(this.init){if(!this.desktop.enableInVersion(45)){this.windowTitle=this.bitrixIntranet?!BX.browser.IsMac()?BX.message("IM_DESKTOP_B24_TITLE"):BX.message("IM_DESKTOP_B24_OSX_TITLE"):BX.message("IM_WM");BX.desktop.setWindowTitle(this.windowTitle)}else{this.windowTitle=document.title}if(BX.MessengerCommon.isSliderBindingsEnable()){if(this.desktop.sliderStatus()){BX.SidePanel.Instance.enableAnchorBinding()}else{BX.SidePanel.Instance.disableAnchorBinding()}}else{BX.SidePanel.Instance.anchorRules=[]}}else{BX.SidePanel.Instance.anchorRules=[]}}else{this.windowTitle=document.title}for(var s in t.notify){t.notify[s].date=new Date(t.notify[s].date);if(parseInt(s)>this.lastRecordId)this.lastRecordId=parseInt(s)}for(var s in t.message){t.message[s].date=new Date(t.message[s].date);if(parseInt(s)>this.lastRecordId)this.lastRecordId=parseInt(s)}for(var s in t.recent){t.recent[s].date=new Date(t.recent[s].date)}if(BX.browser.SupportLocalStorage()){BX.addCustomEvent(window,"onLocalStorageSet",BX.proxy(this.storageSet,this));var i=BX.localStorage.get("lri");if(parseInt(i)>this.lastRecordId)this.lastRecordId=parseInt(i);BX.garbage(function(){BX.localStorage.set("lri",this.lastRecordId,60)},this)}this.notifyManager=new BX.IM.NotifyManager(this,{});this.notify=new BX.MessengerNotify(this,{desktopClass:this.desktop,webrtcClass:this.webrtc,domNode:e,counters:t.counters||{},mailCount:t.mailCount||0,notify:t.notify||{},unreadNotify:t.unreadNotify||{},flashNotify:t.flashNotify||{},countNotify:t.countNotify||0,loadNotify:t.loadNotify});this.webrtc.notify=this.notify;this.desktop.notify=this.notify;this.disk=new BX.IM.DiskManager(this,{notifyClass:this.notify,desktopClass:this.desktop,files:t.files||{},enable:t.disk&&t.disk.enable,enableExternal:t.disk&&t.disk.external});this.notify.disk=this.disk;this.webrtc.disk=this.disk;this.desktop.disk=this.disk;this.messenger=new BX.MessengerChat(this,{openChatEnable:t.openChatEnable,updateStateInterval:t.updateStateInterval,notifyClass:this.notify,webrtcClass:this.webrtc,desktopClass:this.desktop,diskClass:this.disk,externalRecentList:t.externalRecentList,recent:t.recent,users:t.users||{},businessUsers:t.businessUsers||false,openlines:t.openlines||false,groups:t.groups||{},userChatBlockStatus:t.userChatBlockStatus||{},userChatOptions:t.userChatOptions||{},userInGroup:t.userInGroup||{},currentTab:t.currentTab||0,generalChatId:t.generalChatId||0,canSendMessageGeneralChat:t.canSendMessageGeneralChat||false,chat:t.chat||{},userInChat:t.userInChat||{},userChat:t.userChat||{},hrphoto:t.hrphoto||{},message:t.message||{},showMessage:t.showMessage||{},unreadMessage:t.unreadMessage||{},flashMessage:t.flashMessage||{},countMessage:t.countMessage||0,tooltipShowed:t.tooltipShowed||{},bot:t.bot||{},command:t.command||[],textareaIcon:t.textareaIcon||[],smile:t.smile||false,smileSet:t.smileSet||false,history:t.history||{},openMessenger:typeof t.openMessenger!="undefined"?t.openMessenger:false,openHistory:typeof t.openHistory!="undefined"?t.openHistory:false,openNotify:typeof t.openNotify!="undefined"?t.openNotify:false});this.webrtc.messenger=this.messenger;this.callController.messenger=this.messenger;this.notify.messenger=this.messenger;this.desktop.messenger=this.messenger;this.disk.messenger=this.messenger;if(this.init){BX.addCustomEvent(window,"onImUpdateCounterNotify",BX.proxy(this.updateCounter,this));BX.addCustomEvent(window,"onImUpdateCounterMessage",BX.proxy(this.updateCounter,this));BX.addCustomEvent(window,"onImUpdateCounterMail",BX.proxy(this.updateCounter,this));BX.addCustomEvent(window,"onImUpdateCounter",BX.proxy(this.updateCounter,this));BX.bind(window,"blur",BX.delegate(function(){this.changeFocus(false)},this));BX.bind(window,"focus",this.setFocusFunction=BX.delegate(function(){if(this.windowFocus)return false;if(BX.MessengerCommon.isDesktop()&&!BX.desktop.isActiveWindow())return false;this.changeFocus(true);if(this.isFocus()&&this.messenger.unreadMessage[this.messenger.currentTab]&&this.messenger.unreadMessage[this.messenger.currentTab].length>0)BX.MessengerCommon.readMessage(this.messenger.currentTab);if(this.isFocus("notify")){if(this.notify.unreadNotifyLoad)this.notify.loadNotify();else if(this.notify.notifyUpdateCount>0)this.notify.viewNotifyAll()}},this));if(BX.MessengerCommon.isDesktop())BX.bind(window,"click",this.setFocusFunction);BX.addCustomEvent("onPullEvent-xmpp",BX.delegate(function(e,t){if(e=="lastActivityDate"){this.xmppStatus=t.timestamp>0}},this));this.updateCounter();BX.onCustomEvent(window,"onImInit",[this])}if(this.openSettingsFlag!==false)this.openSettings(this.openSettingsFlag=="true"?{}:{onlyPanel:this.openSettingsFlag.toString().toLowerCase()})};BX.IM.prototype.isFocus=function(e){e=typeof e=="undefined"?"dialog":e;if(!BX.MessengerCommon.isPage()&&(this.messenger==null||this.messenger.popupMessenger==null)){return false}if(this.callController.hasActiveCall()&&this.callController.hasVisibleCall()){return false}if(e=="dialog"){if(BX.MessengerCommon.isPage()&&BX.MessengerWindow.getCurrentTab()!="im"&&BX.MessengerWindow.getCurrentTab()!="im-phone"&&BX.MessengerWindow.getCurrentTab()!="im-ol")return false;if(this.messenger&&!BX.MessengerCommon.isScrollMax(this.messenger.popupMessengerBody,200))return false;if(this.dialogOpen==false)return false}else if(e=="notify"){if(BX.MessengerCommon.isPage()&&BX.MessengerWindow.getCurrentTab()!="notify"&&BX.MessengerWindow.getCurrentTab()!="im-phone")return false;if(this.notifyOpen==false)return false}if(this.quirksMode||BX.browser.IsIE()&&!BX.browser.IsIE9())return true;return this.windowFocus};BX.IM.prototype.changeFocus=function(e){this.windowFocus=typeof e=="boolean"?e:false;return this.windowFocus};BX.IM.prototype.playSound=function(e,t){t=t?true:false;if(!t&&(!this.init||BX.MessengerCalls.hasActiveCall()))return false;var s={start:true,dialtone:true,ringtone:true};if(!this.settings.enableSound&&!s[e])return false;BX.localStorage.set("mps",true,1);try{this.stopSound();this.audio.current=this.audio[e];var i=this.audio[e].play();if(window.Promise&&i instanceof Promise){i.catch(function(e){BXIM.audio.current=null})}}catch(e){this.audio.current=null}};BX.IM.prototype.repeatSound=function(e,t,s){t=parseInt(t)||1e3;t=t>=1e3?t:1e3;s=s===true;if(this.audio.timeout[e])clearTimeout(this.audio.timeout[e]);if(BX.MessengerCommon.isDesktop()||!this.desktopStatus)this.playSound(e,s);this.audio.timeout[e]=setTimeout(BX.delegate(function(){this.repeatSound(e,t,s)},this),t)};BX.IM.prototype.stopRepeatSound=function(e,t){t=t!=false;if(t)BX.localStorage.set("mrss",{sound:e},1);if(this.audio.timeout[e])clearTimeout(this.audio.timeout[e]);if(!this.audio[e])return false;this.audio[e].pause();this.audio[e].currentTime=0};BX.IM.prototype.stopSound=function(){if(this.audio.current){this.audio.current.pause();this.audio.current.currentTime=0}};BX.IM.prototype.autoHide=function(e){if(this.autoHideDisable)return true;e=e||window.event;if(e.which==1){if(this.popupSettings!=null)this.popupSettings.destroy();else if(this.messenger.popupHistory!=null)this.messenger.popupHistory.destroy();else if(BX.DiskFileDialog&&BX.DiskFileDialog.popupWindow!=null)BX.DiskFileDialog.popupWindow.destroy();else if(!this.callController.hasActiveCall()&&this.messenger.popupMessenger!=null)this.messenger.popupMessenger.destroy()}};BX.IM.prototype.updateCounter=function(e,t){if(t=="MESSAGE")this.messageCount=e;else if(t=="NOTIFY")this.notifyCount=e;else if(t=="MAIL")this.mailCount=e;var s=0;if(this.notifyCount>0)s+=parseInt(this.notifyCount);if(this.messageCount>0)s+=parseInt(this.messageCount);if(this.linesCount>0)s+=parseInt(this.linesCount);if(BX.MessengerCommon.isPage()){var i="";if(s>0)i=s;var a=BX.message("IM_DESKTOP_UNREAD_EMPTY");if(this.notifyCount>0&&this.messageCount+this.linesCount>0)a=BX.message("IM_DESKTOP_UNREAD_MESSAGES_NOTIFY");else if(this.notifyCount>0)a=BX.message("IM_DESKTOP_UNREAD_NOTIFY");else if(this.messageCount+this.linesCount>0)a=BX.message("IM_DESKTOP_UNREAD_MESSAGES");else if(this.notify!=null&&this.notify.getCounter("**")>0)a=BX.message("IM_DESKTOP_UNREAD_LF");if(BX.MessengerCommon.isDesktop()){BX.desktop.setIconTooltip(a);BX.desktop.setIconBadge(i,this.messageCount+this.linesCount>0);BX.desktop.setTabBadge(i,this.messageCount+this.linesCount>0)}}if(BX.MessengerCommon.isPage()&&this.notify&&!this.userExtranet){var n=this.notify.getCounter("**");BX.MessengerWindow.setTabBadge("im-lf",n)}BX.onCustomEvent(window,"onImUpdateSumCounters",[s,"SUM"]);if(this.settings.status!="dnd"&&!this.desktopStatus&&s>0){if(!BX.MessengerCommon.isDesktop()&&document.title!="("+s+") "+this.windowTitle)document.title="("+s+") "+this.windowTitle;if(this.notify.panelButtonMessage){if(this.messageCount>0)BX.addClass(this.notify.panelButtonMessage,"bx-notifier-message-new");else BX.removeClass(this.notify.panelButtonMessage,"bx-notifier-message-new")}}else{if(!BX.MessengerCommon.isDesktop()&&document.title!=this.windowTitle)document.title=this.windowTitle;if(this.notify.panelButtonMessage){if(this.messageCount<=0||this.settings.status=="dnd"||this.desktopStatus){BX.removeClass(this.notify.panelButtonMessage,"bx-notifier-message-new")}}}};BX.IM.prototype.openNotify=function(e){force=e&&e.force==true;openThis=false;if(BX.MessengerCommon.isDesktop()){openThis=true}if(!this.settings.openDesktopFromPanel||openThis){if(BX.MessengerCommon.isPage()){this.messenger.openMessenger(false).then(function(){BX.MessengerWindow.changeTab("notify");this.notify.openNotify(false,true)}.bind(this))}else{this.notify.openNotify(false,true)}return false}BX.desktopUtils.runningCheck(function(){BX.desktopUtils.goToBx("bx://notify")},BX.defer(function(){if(BX.MessengerCommon.isPage()){this.messenger.openMessenger(false).then(function(){BX.MessengerWindow.changeTab("notify")}.bind(this))}else{this.notify.openNotify(false,true)}},this))};BX.IM.prototype.closeNotify=function(){BX.onCustomEvent(window,"onImNotifyWindowClose",[]);if(this.messenger.popupMessenger!=null&&!this.callController.hasActiveCall())this.messenger.popupMessenger.destroy()};BX.IM.prototype.toggleNotify=function(){if(this.isOpenNotify())this.closeNotify();else this.openNotify()};BX.IM.prototype.isOpenNotify=function(){return this.notifyOpen};BX.IM.prototype.sendMessage=function(e,t){if(!t&&!e)return false;if(!t){t=e;e=this.messenger.currentTab}var s=this.messenger.popupMessengerTextarea.value;this.messenger.popupMessengerTextarea.value=t;this.messenger.sendMessage(e);setTimeout(BX.delegate(function(){this.messenger.popupMessengerTextarea.value=s;this.messenger.textareaCheckText()},this),10);return true};BX.IM.prototype.putMessage=function(e){BX.addClass(this.messenger.popupMessengerTextarea.parentNode,"bx-messenger-textarea-focus");this.messenger.popupMessengerTextarea.focus();this.messenger.insertTextareaText(this.messenger.popupMessengerTextarea,e+" ",false);this.messenger.textareaHistory[this.messenger.currentTab]=e+" ";return true};BX.IM.prototype.phoneTo=function(e,t){t=t?t:{};var s=t["LINE_ID"]?t["LINE_ID"]:this.webrtc.phoneDefaultLineId;if(typeof t!="object"){try{t=JSON.parse(t)}catch(e){t={}}}if(this.webrtc.isRestLine(s)){BX.MessengerCommon.phoneStartCallViaRestApp(e,s,t);return true}if(!BX.MessengerCommon.isDesktop()&&this.desktopStatus&&this.desktopVersion>=18){var i="";if(t){for(var a in t){i=i+"!!"+a+"!!"+t[a]}i="/params/"+i.substr(2)}if(this.webrtc.popupKeyPad)this.webrtc.popupKeyPad.close();this.checkDesktop(function(){BX.desktopUtils.goToBx("bx://callto/phone/"+escape(e)+i)},BX.delegate(function(){this.webrtc.phoneCall(e,t)},this))}else{this.webrtc.phoneCall(e,t)}return true};BX.IM.prototype.startCallList=function(e,t){t=t?t:{};e=parseInt(e);if(e==0)return;if(!this.desktop.ready()&&this.desktopStatus&&this.desktopVersion>=18){this.checkDesktop(function(){BX.desktopUtils.goToBx("bx://calllist/id/"+e+/params/+BX.desktopUtils.encodeParams(t))},BX.delegate(function(){this.webrtc.startCallList(e,t)},this))}else{this.webrtc.startCallList(e,t)}return true};BX.IM.prototype.checkCallSupport=function(e){var t=true;if(typeof e!="undefined"){if(parseInt(e)>0){t=this.messenger.users[e]&&this.messenger.users[e].status!="guest"&&!this.messenger.users[e].bot&&!this.messenger.users[e].network}else{var s=e.toString().substr(4);t=this.messenger.userInChat[s];if(t){var i=0;this.messenger.userInChat[s].forEach(function(e){if(this.messenger.users[e]&&this.messenger.users[e].active){i++}}.bind(this));if(this.messenger.chat[s].type==="videoconf"){t=i<=BX.Call.Util.getUserLimit()}else{t=i>1&&i<=BX.Call.Util.getUserLimit()}}}}return this.ppServerStatus&&BX.Call.Util.isWebRTCSupported()&&t};BX.IM.prototype.addPopupMenuModifier=function(e){this.messenger.popupPopupMenuModifyFunction.push(e);return true};BX.IM.prototype.openMessengerSlider=function(e,t){t=t||{};t.SLIDER="Y";BX.defer(function(){if(e&&e.toString().substr(0,4)=="imol"){this.messenger.linesOpenMessenger(e.toString().substr(5),t)}else{this.messenger.openMessenger(e)}},this)()};BX.IM.prototype.callTo=function(e,t){t=!(typeof t!="undefined"&&!t);this.checkDesktop(function(){BX.desktopUtils.goToBx("bx://callto/"+(t?"video":"audio")+"/"+e)},function(){this.callController.startCall(e,t)}.bind(this))};BX.IM.prototype.openVideoconf=function(e){if(!e){return false}if(this.desktop.openVideoconf(e)){return true}this.checkDesktop(function(){BX.desktopUtils.goToBx("bx://videoconf/code/"+e)},function(){var t=BX.MessengerCommon.getVideoconfLinkByCode(e);BX.MessengerCommon.externalLink[t]=true;BX.MessengerCommon.openLink(t,"videoconf"+e)})};BX.IM.prototype.openVideoconfByUrl=function(e){if(BX.MessengerCommon.externalLink[e]){return false}var t=null;var s=e.match(/^(https|http):\/\/(.*)\/(video|online\/call)\/([.\-0-9a-zA-Z]+)/i);if(s){t=s[4];if(!s[2].includes(location.host)){BX.MessengerCommon.externalLink[e]=true;BX.MessengerCommon.openLink(e,"videoconf"+t);return true}}if(!t){return false}this.openVideoconf(t);return true};BX.IM.prototype.createZoom=function(e){if(!this.zoomStatus["enabled"]){BX.UI.InfoHelper.show("limit_video_conference_zoom")}else{var t="/company/personal/user/"+this.userId+"/social_services/";BX.ajax({url:this.pathToAjax+"?V="+this.revision,method:"POST",dataType:"json",timeout:30,data:{IM_CREATE_ZOOM_CONF:"Y",IM_AJAX_CALL:"Y",CHAT_ID:e,sessid:BX.bitrix_sessid()},onsuccess:BX.delegate(function(e){if(e["ERROR"]==="NOT_CONNECTED"){BX.SidePanel.Instance.open(t)}else if(e["ERROR"]==="COULD_NOT_CREATE"){BXIM.openConfirm(BX.message("IM_M_COULD_NOT_CREATE_ZOOM_CONF").replace("#HREF#",t))}else if(e["ERROR"]==="COULD_NOT_ADD_MESSAGE"){BXIM.openConfirm(BX.message("IM_M_COULD_NOT_ADD_CONF_MESSAGE"))}},this),onfailure:BX.delegate(function(e){BXIM.openConfirm(BX.message("IM_M_ZOOM_ERROR_UNKNOWN"))},this)})}};BX.IM.prototype.openMessenger=function(e,t,s){e=e===false?false:e;s=s?true:false;if(BX.MessengerCommon.isDesktop()){s=true}if(!this.settings.openDesktopFromPanel||s){BX.defer(function(){if(e&&e.toString().substr(0,4)=="imol"){this.messenger.linesOpenMessenger(e.toString().substr(5))}else{this.messenger.openMessenger(e);if(t){BX.MessengerWindow.changeTab(t,true)}}},this)();return false}BX.desktopUtils.runningCheck(function(){BX.desktopUtils.goToBx(e===false?"bx://messenger":"bx://messenger/dialog/"+encodeURIComponent(e)+"/tab/"+t)},BX.defer(function(){if(e&&e.toString().substr(0,4)=="imol"){this.messenger.linesOpenMessenger(e.toString().substr(5))}else{this.messenger.openMessenger(e);if(t){BX.MessengerWindow.changeTab(t,true)}}},this));return false};BX.IM.prototype.closeMessenger=function(){if(BX.MessengerCommon.isPopupPage()){BX.MessengerSlider.close()}else{this.messenger.popupMessenger.close()}};BX.IM.prototype.isOpenMessenger=function(){return this.dialogOpen};BX.IM.prototype.toggleMessenger=function(){if(this.isOpenMessenger())this.closeMessenger();else if(this.extraOpen&&!this.isOpenNotify())this.closeMessenger();else this.openMessenger(this.messenger.currentTab)};BX.IM.prototype.openHistory=function(e){if(e&&e.toString().substr(0,4)=="imol"){setTimeout(BX.delegate(function(){this.messenger.linesOpenHistory(e.toString().substr(5))},this),300)}else{setTimeout(BX.delegate(function(){this.messenger.openHistory(e)},this),10)}};BX.IM.prototype.openContactList=function(){this.messenger.openMessenger(false);setTimeout(BX.delegate(function(){this.messenger.popupContactListSearchInput.focus()},this),200);return false};BX.IM.prototype.closeContactList=function(){return false};BX.IM.prototype.isOpenContactList=function(){return false};BX.IM.prototype.checkRevision=function(e){if(!this.init){return true}if(e&&this.revision<e){if(!this.init){return false}this.revisionError.active=true;this.revisionError.notifyTime=Math.floor(Math.random()*12e4)+3e4;if(!this.revisionError.text){if(BX.MessengerCommon.isDesktop()){this.revisionError.text=BX.message("IM_B24_UPDATE_APP")}else{this.revisionError.text=BX.message("IM_B24_UPDATE")}}if(this.revisionError.text&&!this.revisionError.notifyArmed){console.warn("REVISION: Notify about reload will show in "+Math.floor(this.revisionError.notifyTime/1e3)+" min, REVISION UP ("+this.revision+" -> "+e+")");setTimeout(function(){BX.UI.Notification.Center.notify({content:this.revisionError.text,position:"top-right",autoHide:false,closeButton:false,actions:[{title:BX.message("IM_M_OLD_REVISION_DESKTOP_REFRESH"),events:{click:function(){location.reload()}}}]});this.revisionError.notified=true;console.warn("REVISION: Notify about reload - showed!")}.bind(this),this.revisionError.notifyTime*60);this.revisionError.notifyArmed=true}return false}return true};BX.IM.prototype.openSettings=function(e){if(this.messenger&&this.messenger.popupMessengerConnectionStatusState!="online")return false;e=typeof e=="object"?e:{};if(this.popupSettings!=null||!this.messenger)return false;if(!BX.MessengerCommon.isPage())this.messenger.setClosingByEsc(false);this.settingsSaveCallback={};this.settingsTableConfig={};var t=[];if(this.colors){for(var s in this.colors){t.push({title:this.colors[s],value:s})}}var i=BX.MessengerCommon.isPage()&&this.bitrixOpenLines?true:false;var a=false;if(BX.MessengerCommon.isDesktop()&&this.desktopVersion>=42&&/windows/.test(navigator.userAgent.toLowerCase())&&BXDesktopSystem.GetNotifyPosition){a=true;notifyPositionValue=BXDesktopSystem.GetNotifyPosition();notifyPositionValue=notifyPositionValue?notifyPositionValue:"RB";notifyPositionValues=[{title:BX.message("IM_M_NOTIFY_POSITION_LT"),value:"LT"},{title:BX.message("IM_M_NOTIFY_POSITION_RT"),value:"RT"},{title:BX.message("IM_M_NOTIFY_POSITION_LB"),value:"LB"},{title:BX.message("IM_M_NOTIFY_POSITION_RB"),value:"RB"}]}var n=BX.browser.IsChrome()||BX.browser.IsFirefox()||BX.browser.IsSafari();this.settingsView.common={title:BX.message("IM_SETTINGS_COMMON"),settings:[{title:BX.message("IM_M_VIEW_LAST_MESSAGE_OFF"),type:"checkbox",name:"viewLastMessage",checked:!this.settings.viewLastMessage,saveCallback:BX.delegate(function(e){BX.MessengerCommon.recentListRedraw();return!e.checked},this)},{title:BX.message("IM_M_VIEW_OFFLINE_OFF"),type:"checkbox",name:"viewOffline",checked:!this.settings.viewOffline,saveCallback:BX.delegate(function(e){return!e.checked},this)},{type:"space"},i?{title:BX.message("IM_M_VIEW_OL_LIST"),type:"checkbox",name:"linesTabEnable",checked:this.settings.linesTabEnable,saveCallback:BX.delegate(function(e){this.messenger.toggleLinesTab(e.checked);return e.checked},this)}:null,i?{title:BX.message("IM_M_VIEW_OL_NEW"),type:"checkbox",name:"linesNewGroupEnable",checked:this.settings.linesNewGroupEnable,saveCallback:BX.delegate(function(e){this.messenger.toggleLinesNewGroup(e.checked);return e.checked},this)}:null,i?{type:"space"}:null,{title:BX.message("IM_M_LLM"),type:"checkbox",name:"loadLastMessage",checked:this.settings.loadLastMessage},{title:BX.message("IM_M_LLN"),type:"checkbox",name:"loadLastNotify",checked:this.settings.loadLastNotify},{title:BX.message("IM_M_NAR"),type:"checkbox",name:"notifyAutoRead",checked:this.settings.notifyAutoRead},{type:"space"},{title:BX.message("IM_M_DESKTOP_BIG_SMILE_ON"),type:"checkbox",name:"enableBigSmile",checked:this.settings.enableBigSmile},{title:BX.message("IM_M_RICH_LINK_ON"),type:"checkbox",name:"enableRichLink",checked:this.settings.enableRichLink},{title:BX.message("IM_M_ENABLE_SOUND"),type:"checkbox",name:"enableSound",checked:this.settings.enableSound},BX.MessengerCommon.isDesktop()?{title:BX.message("IM_M_ENABLE_BIRTHDAY"),type:"checkbox",checked:this.desktop.birthdayStatus(),callback:BX.delegate(function(){this.desktop.birthdayStatus(!this.desktop.birthdayStatus())},this)}:null,BX.MessengerCommon.isDesktop()&&BX.MessengerCommon.isSliderBindingsEnable()?{title:BX.message("IM_M_ENABLE_SLIDER"),type:"checkbox",checked:this.desktop.sliderStatus(),callback:BX.delegate(function(){this.desktop.sliderStatus(!this.desktop.sliderStatus())},this)}:null,{title:BX.message("IM_M_KEY_SEND"),type:"select",name:"sendByEnter",value:this.settings.sendByEnter?"Y":"N",items:[{title:BX.browser.IsMac()?"&#8984;+Enter":"Ctrl+Enter",value:"N"},{title:"Enter",value:"Y"}],saveCallback:BX.delegate(function(e){return e[e.selectedIndex].value=="Y"},this)},{type:"space"},a?{title:BX.message("IM_M_NOTIFY_POSITION"),name:"notifyPosition",type:"select",value:notifyPositionValue,items:notifyPositionValues,skipSave:"Y",saveCallback:BX.delegate(function(e){BXDesktopSystem.SetNotifyPosition(e.options[e.selectedIndex].value)},this)}:null,this.colors?{title:BX.message("IM_M_USER_COLOR"),name:"userColor",type:"select",value:this.userColor,items:t,skipSave:"Y",saveCallback:BX.delegate(function(e){BX.MessengerCommon.setColor(e.options[e.selectedIndex].value)},this)}:null,this.desktopVersion?{title:BX.message("IM_M_OPEN_DESKTOP_FROM_PANEL"),type:"checkbox",name:"openDesktopFromPanel",checked:this.settings.openDesktopFromPanel}:null,BX.MessengerCommon.isDesktop()&&this.desktop.enableInVersion(49)?{title:BX.message("IM_M_BITRIX24_WINDOW_MODE"),type:"checkbox",name:"openBitrix24Window",checked:this.desktop.isTwoWindowMode(),callback:BX.delegate(function(){this.desktop.setTwoWindowMode(!this.desktop.isTwoWindowMode())},this)}:null,BX.MessengerCommon.isDesktop()?{title:BX.message("IM_M_DESKTOP_AUTORUN_ON"),type:"checkbox",checked:BX.desktop.autorunStatus(),callback:BX.delegate(function(){BX.desktop.autorunStatus(!BX.desktop.autorunStatus())},this)}:null,{type:"space"},{title:BX.message("IM_M_ENABLE_DARK_THEME")+" (beta)",type:"checkbox",name:"enableDarkTheme",checked:this.settings.enableDarkTheme,saveCallback:BX.delegate(function(e){this.messenger.toggleDarkTheme(e.checked);return e.checked},this)}]};this.settingsView.notify={title:BX.message("IM_SETTINGS_NOTIFY"),settings:[{type:"notifyControl"},{type:"table",name:"notify",show:this.settings.notifyScheme=="expert"},{type:"table",name:"simpleNotify",show:this.settings.notifyScheme=="simple"}]};this.settingsTableConfig["notify"]={condition:BX.delegate(function(){return this.settingsTableConfig["notify"].rows.length>0},this),headers:["",BX.message("IM_SETTINGS_NOTIFY_SITE"),this.bitrixXmpp?BX.message("IM_SETTINGS_NOTIFY_XMPP"):false,BX.message("IM_SETTINGS_NOTIFY_EMAIL"),this.bitrixMobile?BX.message("IM_SETTINGS_NOTIFY_PUSH"):false],rows:[],error_rows:BX.create("div",{children:[BX.create("div",{props:{className:"bx-messenger-content-item-progress"}}),BX.create("span",{props:{className:"bx-messenger-content-item-progress-with-text"},html:BX.message("IM_SETTINGS_LOAD")})]})};this.settingsTableConfig["simpleNotify"]={condition:BX.delegate(function(){return this.settingsTableConfig["simpleNotify"].rows.length>0},this),headers:[BX.message("IM_SETTINGS_SNOTIFY"),""],rows:[]};this.settingsView.privacy={title:BX.message("IM_SETTINGS_PRIVACY"),condition:BX.delegate(function(){return!this.bitrixIntranet},this),settings:[{title:BX.message("IM_SETTINGS_PRIVACY_MESS"),name:"privacyMessage",type:"select",items:[{title:BX.message("IM_SETTINGS_SELECT_1"),value:"all"},{title:BX.message("IM_SETTINGS_SELECT_2"),value:"contact"}],value:this.settings.privacyMessage},{title:BX.message("IM_SETTINGS_PRIVACY_CALL"),name:"privacyCall",type:"select",items:[{title:BX.message("IM_SETTINGS_SELECT_1"),value:"all"},{title:BX.message("IM_SETTINGS_SELECT_2"),value:"contact"}],value:this.settings.privacyCall},{title:BX.message("IM_SETTINGS_PRIVACY_CHAT"),name:"privacyChat",type:"select",items:[{title:BX.message("IM_SETTINGS_SELECT_1_2"),value:"all"},{title:BX.message("IM_SETTINGS_SELECT_2_2"),value:"contact"}],value:this.settings.privacyChat},{title:BX.message("IM_SETTINGS_PRIVACY_SEARCH"),name:"privacySearch",type:"select",items:[{title:BX.message("IM_SETTINGS_SELECT_1_3"),value:"all"},{title:BX.message("IM_SETTINGS_SELECT_2_3"),value:"contact"}],value:this.settings.privacySearch},this.bitrix24net?{title:BX.message("IM_SETTINGS_PRIVACY_PROFILE"),name:"privacyProfile",type:"select",items:[{title:BX.message("IM_SETTINGS_SELECT_1_3"),value:"all"},{title:BX.message("IM_SETTINGS_SELECT_2_3"),value:"contact"},{title:BX.message("IM_SETTINGS_SELECT_3_3"),value:"nobody"}],value:this.settings.privacyProfile}:null]};this.settingsView.hardware={title:BX.message("IM_SETTINGS_HARDWARE"),settings:[{title:"hardwareError",type:"html",value:'<div id="bx-messenger-settings-hardware-error"></div>'},{title:BX.message("IM_SETTINGS_HARDWARE_MICROPHONE"),type:"select",name:"defaultMicrophone",items:{},callback:this.changeHardwareSettings.bind(this),saveCallback:function(e){if(!localStorage)return e.value;localStorage.setItem("bx-im-settings-default-microphone",e.value)}},{type:"space"},{title:"microphoneLevel",type:"html",value:'<div id="bx-messenger-settings-hardware-microphone-level" class="bx-messenger-settings-level-meter-container"></div>'},{title:BX.message("IM_SETTINGS_HARDWARE_AUTO_PARAMETERS_MICROPHONE"),type:"checkbox",name:"enableMicAutoParameters",checked:this.webrtc.enableMicAutoParameters,saveCallback:function(e){if(!localStorage)return e.checked;localStorage.setItem("bx-im-settings-enable-mic-auto-parameters",e.checked?"Y":"N")}},{type:"space"},{title:BX.message("IM_SETTINGS_HARDWARE_SPEAKER"),type:"select",name:"defaultSpeaker",items:{},saveCallback:function(e){if(!localStorage)return e.value;localStorage.setItem("bx-im-settings-default-speaker",e.value)}},{type:"space"},{title:BX.message("IM_SETTINGS_HARDWARE_CAMERA"),type:"select",name:"defaultCamera",items:{},callback:this.changeHardwareSettings.bind(this),saveCallback:function(e){if(!localStorage)return e.value;localStorage.setItem("bx-im-settings-default-camera",e.value)}},{title:BX.message("IM_SETTINGS_HARDWARE_CAMERA_PREFER_HD_QUALITY"),type:"checkbox",name:"preferHdQuality",items:{},checked:BX.Call.Hardware.preferHdQuality,saveCallback:function(e){if(!localStorage)return e.value;localStorage.setItem("bx-im-settings-camera-prefer-hd",e.checked?"Y":"N")}},{type:"space"},{title:"cameraImage",type:"html",value:'<div id="bx-messenger-settings-hardware-camera-image"></div>'}],click:BX.delegate(this.showHardwareSettings,this)};this.settingsView.call={title:BX.message("IM_SETTINGS_CALLS"),settings:[{title:BX.message("IM_SETTINGS_CALLS_INCOMING_VIDEO"),type:"select",name:"callAcceptIncomingVideo",items:[{title:BX.message("IM_SETTINGS_CALLS_INCOMING_VIDEO_ACCEPT_ALL"),value:BX.Call.VideoStrategy.Type.AllowAll},{title:BX.message("IM_SETTINGS_CALLS_INCOMING_VIDEO_ACCEPT_SPEAKING"),value:BX.Call.VideoStrategy.Type.CurrentlyTalking},{title:BX.message("IM_SETTINGS_CALLS_INCOMING_VIDEO_DENY_ALL"),value:BX.Call.VideoStrategy.Type.AllowNone}],value:this.settings.callAcceptIncomingVideo,saveCallback:function(e){var t=e[e.selectedIndex].value;this.callController.setVideoStrategyType(t);return t}.bind(this)}]};BX.onCustomEvent(this,"prepareSettingsView",[]);if(e.onlyPanel&&!this.settingsView[e.onlyPanel])return false;this.popupSettingsButtonSave=new BX.PopupWindowButton({text:BX.message("IM_SETTINGS_SAVE"),className:"popup-window-button-accept",events:{click:BX.delegate(function(){this.popupSettingsButtonSave.setClassName("popup-window-button");this.popupSettingsButtonSave.setName(BX.message("IM_SETTINGS_WAIT"));BX.hide(this.popupSettingsButtonClose.buttonNode);this.saveFormSettings();this.closeHardwareSettings()},this)}});this.popupSettingsButtonClose=new BX.PopupWindowButton({text:BX.message("IM_SETTINGS_CLOSE"),className:"popup-window-button-close",events:{click:BX.delegate(function(){this.popupSettings.close();BX.hide(this.popupSettingsButtonSave.buttonNode);BX.hide(this.popupSettingsButtonClose.buttonNode);this.closeHardwareSettings()},this)}});this.popupSettingsBody=BX.create("div",{props:{className:"bx-messenger-settings"+(BX.browser.IsMac()?"":" bx-messenger-custom-scroll")},children:this.prepareSettings({onlyPanel:e.onlyPanel?e.onlyPanel:false,active:e.active?e.active:false})});if(BX.MessengerCommon.isDesktop()){if(this.init){this.desktop.openSettings(this.popupSettingsBody,"BXIM.openSettings("+JSON.stringify(e)+"); BX.desktop.resize(); ",e);return false}else{this.popupSettings=new BX.PopupWindowDesktop;this.desktop.drawOnPlaceholder(this.popupSettingsBody)}}else{this.popupSettings=new BX.PopupWindow("bx-messenger-popup-settings",null,{darkMode:this.settings.enableDarkTheme,autoHide:false,zIndex:BX.MessengerCommon.getDefaultZIndex()+200,overlay:{opacity:50,backgroundColor:"#000000"},buttons:[this.popupSettingsButtonSave,this.popupSettingsButtonClose],draggable:{restrict:true},closeByEsc:true,events:{onPopupClose:function(){this.destroy()},onPopupDestroy:BX.delegate(function(){this.popupSettings=null;if(!BX.MessengerCommon.isPage()&&this.messenger.popupMesseger==null)BX.bind(document,"click",BX.proxy(this.autoHide,this));this.closeHardwareSettings();this.messenger.setClosingByEsc(true)},this)},titleBar:e.onlyPanel?this.settingsView[e.onlyPanel].title:BX.message("IM_SETTINGS"),closeIcon:true,contentNoPaddings:true,contentColor:"white",content:this.popupSettingsBody});this.popupSettings.show();BX.addClass(this.popupSettings.popupContainer,"bx-messenger-mark");BX.bind(this.popupSettings.popupContainer,"click",BX.MessengerCommon.preventDefault)}BX.bindDelegate(this.popupSettingsBody,"click",{className:"bx-messenger-settings-tab"},BX.delegate(function(){BX.onCustomEvent(window,"onImSettingsTabShow",[BX.proxy_context.getAttribute("data-name")]);var e=BX.findChildrenByClassName(BX.proxy_context.parentNode,"bx-messenger-settings-tab",false);for(var t=0;t<e.length;t++)BX.removeClass(e[t],"bx-messenger-settings-tab-active");BX.addClass(BX.proxy_context,"bx-messenger-settings-tab-active");var e=BX.findChildrenByClassName(BX.proxy_context.parentNode.nextSibling,"bx-messenger-settings-content",false);for(var t=0;t<e.length;t++){if(parseInt(BX.proxy_context.getAttribute("data-id"))==t)BX.addClass(e[t],"bx-messenger-settings-content-active");else BX.removeClass(e[t],"bx-messenger-settings-content-active")}if(BX.MessengerCommon.isDesktop())this.desktop.autoResize()},this));if(this.settings.notifyScheme=="simple")this.GetSimpleNotifySettings();else this.GetNotifySettings();if(!BX.MessengerCommon.isDesktop())BX.bind(document,"click",BX.proxy(this.autoHide,this))};BX.IM.prototype.prepareSettings=function(e){e=typeof e=="object"?e:{};var t=[];var s=[];var i=true;var a=0;for(var n in this.settingsView){if(this.settingsView[n].condition&&!this.settingsView[n].condition())continue;var o={};if(this.settingsView[n].click)o={click:BX.delegate(this.settingsView[n].click,this)};if(e.active&&this.settingsView[e.active]){if(e.active==n)i=true;else i=false}if(i){BX.onCustomEvent(window,"onImSettingsTabShow",[n])}s.push(BX.create("div",{attrs:{"data-id":a+"","data-name":n},props:{className:"bx-messenger-settings-tab"+(i?" bx-messenger-settings-tab-active":"")},html:this.settingsView[n].title,events:o}));i=false;a++}t.push(BX.create("div",{style:{display:!e.onlyPanel?"block":"none"},props:{className:"bx-messenger-settings-tabs"},children:s}));var s=[];var i=true;for(var n in this.settingsView){if(this.settingsView[n].condition&&!this.settingsView[n].condition())continue;if(e.active&&this.settingsView[e.active]){if(e.active==n)i=true;else i=false}var r=[];if(this.settingsView[n].settings){var l=[];for(var p=0;p<this.settingsView[n].settings.length;p++){if(typeof this.settingsView[n].settings[p]!="object"||this.settingsView[n].settings[p]===null)continue;if(this.settingsView[n].settings[p].condition&&!this.settingsView[n].settings[p].condition())continue;if(this.settingsView[n].settings[p].type=="notifyControl"||this.settingsView[n].settings[p].type=="table"||this.settingsView[n].settings[p].type=="space"){l.push(BX.create("tr",{children:[BX.create("td",{attrs:{colspan:2},children:this.prepareSettingsItem(this.settingsView[n].settings[p])})]}))}else if(this.settingsView[n].settings[p].type==="html"){l.push(BX.create("tr",{children:[BX.create("td",{attrs:{colspan:2},children:this.prepareSettingsItem(this.settingsView[n].settings[p])})]}))}else{l.push(BX.create("tr",{children:[BX.create("td",{attrs:{width:"55%"},html:this.settingsView[n].settings[p].title}),BX.create("td",{attrs:{width:"45%"},children:this.prepareSettingsItem(this.settingsView[n].settings[p])})]}))}}if(l.length>0)r.push(BX.create("table",{attrs:{cellpadding:"0",cellspacing:"0",border:"0",width:"100%"},props:{className:"bx-messenger-settings-table bx-messenger-settings-table-style-"+n},children:l}))}s.push(BX.create("div",{style:{display:e.onlyPanel?e.onlyPanel==n?"block":"none":""},props:{id:"bx-messenger-settings-content-"+n,className:"bx-messenger-settings-content"+(i?" bx-messenger-settings-content-active":"")},children:r}));i=false}t.push(BX.create("div",{props:{className:"bx-messenger-settings-contents"},children:s}));if(BX.MessengerCommon.isDesktop()){t.push(BX.create("div",{props:{className:"popup-window-buttons"},children:[this.popupSettingsButtonSave.buttonNode,this.popupSettingsButtonClose.buttonNode]}))}return t};BX.IM.prototype.prepareSettingsTable=function(e){var t=this.settingsTableConfig[e];if(!t.error_rows&&t.condition&&!BX.delegate(t.condition,this)())return null;var s=[];var i=[];for(var a=0;a<t.headers.length;a++){if(typeof t.headers[a]=="boolean")continue;i.push(BX.create("th",{html:t.headers[a]}))}if(i.length>0)s.push(BX.create("tr",{children:i}));if(t.error_rows&&t.condition&&!t.condition()){s.push(BX.create("tr",{children:[BX.create("td",{attrs:{colspan:t.headers.length},style:{textAlign:"center"},children:[t.error_rows]})]}));t.rows=[]}for(var a=0;a<t.rows.length;a++){var n=[];for(var o=0;o<t.rows[a].length;o++){if(typeof t.rows[a][o]!="object"||t.rows[a][o]===null)continue;var r={};var l={};if(t.rows[a][o].type=="separator"){r={colspan:t.headers.length};l={className:"bx-messenger-settings-table-sep"}}else if(t.rows[a][o].type=="error"){r={colspan:t.headers.length};l={className:"bx-messenger-settings-table-error"}}if(typeof this.settingsDisabled[t.rows[a][o].name]!="undefined"){t.rows[a][o].disabled=this.settingsDisabled[t.rows[a][o].name]}n.push(BX.create("td",{attrs:r,props:l,children:this.prepareSettingsItem(t.rows[a][o])}))}if(n.length>0)s.push(BX.create("tr",{children:n}))}var p=null;if(s.length>0)p=BX.create("table",{attrs:{cellpadding:"0",cellspacing:"0",border:"0"},props:{className:"bx-messenger-settings-table-extra bx-messenger-settings-table-extra-"+e},children:s});return p};BX.IM.prototype.prepareSettingsItem=function(e){var t=[];var s=BX.clone(e);var i=null;if(s.tooltip){i=BX.create("span",{props:{className:"bx-messenger-settings-tooltip"},attrs:{"data-tooltip":s.tooltip},html:"i",events:{click:BX.delegate(function(e){this.messenger.tooltip(BX.proxy_context,BX.proxy_context.getAttribute("data-tooltip"),{angle:false,width:300});BX.PreventDefault(e)},this)}})}if(s.type=="space"){t.push(BX.create("span",{props:{className:"bx-messenger-settings-space"}}))}if(s.type=="text"||s.type=="separator"||s.type=="error"){t.push(BX.create("span",{html:s.title}))}if(s.type=="html"){t.push(BX.create("div",{html:s.value}))}if(s.type=="link"){if(s.callback)var a={click:s.callback};t.push(BX.create("span",{props:{className:"bx-messenger-settings-link"},attrs:s.attrs,html:s.title,events:a}))}if(s.type=="checkbox"){if(s.callback)var a={change:s.callback};if(typeof s.checked=="undefined")s.checked=this.settings[s.name]!=false;var n={type:"checkbox",name:s.name?s.name:false,id:s.id?s.id:"",checked:s.checked==true?"true":false,disabled:s.disabled==true?"true":false};if(!s.skipSave&&s.name)n["data-save"]=1;var o=BX.create("input",{attrs:n,events:a});t.push(BX.create("div",{style:{whiteSpace:"nowrap"},children:[o,i]}));if(s.saveCallback)this.settingsSaveCallback[s.name]=s.saveCallback}else if(s.type=="select"){if(s.callback)var a={change:s.callback};var r=[];for(var l=0;l<s.items.length;l++){r.push(BX.create("option",{attrs:{value:s.items[l].value,selected:s.value==s.items[l].value?"true":false},html:s.items[l].title}))}var n={name:s.name};if(s.name)n["data-save"]=1;var o=BX.create("select",{attrs:n,events:a,children:r});t.push(BX.create("div",{style:{whiteSpace:"nowrap"},children:[o,i]}));if(s.saveCallback)this.settingsSaveCallback[s.name]=s.saveCallback}else if(s.type=="table"){t.push(BX.create("div",{attrs:{id:"bx-messenger-settings-table-"+s.name,className:"bx-messenger-settings-table-"+s.name},style:{display:s.show?"block":"none"},children:[this.prepareSettingsTable(s.name)]}))}else if(s.type=="notifyControl"){var p=BX.delegate(function(){if(BX.proxy_context.value=="simple"){BX.hide(BX("bx-messenger-settings-table-notify"));BX.show(BX("bx-messenger-settings-table-simpleNotify"));BX.show(BX("bx-messenger-settings-notify-clients"));this.GetSimpleNotifySettings()}else{BX.show(BX("bx-messenger-settings-table-notify"));BX.hide(BX("bx-messenger-settings-table-simpleNotify"));BX.hide(BX("bx-messenger-settings-notify-clients"));this.GetNotifySettings()}},this);t.push(BX.create("div",{props:{className:"bx-messenger-settings-notify-type"},children:[BX.create("input",{attrs:{id:"notifySchemeSimpleValue","data-save":1,type:"radio",name:"notifyScheme",value:"simple",checked:this.settings.notifyScheme=="simple"},events:{change:p}}),BX.create("label",{attrs:{for:"notifySchemeSimpleValue"},html:" "+BX.message("IM_SETTINGS_NS_1")+" "}),BX.create("input",{attrs:{id:"notifySchemeExpertValue","data-save":1,type:"radio",name:"notifyScheme",value:"expert",checked:this.settings.notifyScheme=="expert"},events:{change:p}}),BX.create("label",{attrs:{for:"notifySchemeExpertValue"},html:" "+BX.message("IM_SETTINGS_NS_2")+" "})]}));t.push(BX.create("div",{attrs:{id:"bx-messenger-settings-notify-clients"},style:{display:this.settings.notifyScheme=="simple"?"block":"none"},props:{className:"bx-messenger-settings-notify-clients"},children:[BX.create("div",{props:{className:"bx-messenger-settings-notify-clients-title"},html:BX.message("IM_SETTINGS_NC_1_NEW")}),BX.create("div",{props:{className:"bx-messenger-settings-notify-clients-item"},children:[BX.create("input",{attrs:{"data-save":1,type:"checkbox",id:"notifySchemeSendSite",name:"notifySchemeSendSite",value:"Y",checked:this.settings.notifySchemeSendSite},events:{change:function(e){if(!this.checked){BX("notifySchemeSendEmail").checked=false}else{BX("notifySchemeSendEmail").checked=true}}}}),BX.create("label",{attrs:{for:"notifySchemeSendSite"},html:" "+BX.message("IM_SETTINGS_NC_2")+"<br />"})]}),this.bitrixXmpp?BX.create("div",{props:{className:"bx-messenger-settings-notify-clients-item"},children:[BX.create("input",{attrs:{"data-save":1,type:"checkbox",id:"notifySchemeSendXmpp",name:"notifySchemeSendXmpp",value:"Y",checked:this.settings.notifySchemeSendXmpp}}),BX.create("label",{attrs:{for:"notifySchemeSendXmpp"},html:" "+BX.message("IM_SETTINGS_NC_3")+"<br />"})]}):null,BX.create("div",{props:{className:"bx-messenger-settings-notify-clients-item"},children:[BX.create("input",{attrs:{"data-save":1,type:"checkbox",id:"notifySchemeSendEmail",name:"notifySchemeSendEmail",value:"Y",checked:this.settings.notifySchemeSendEmail},events:{change:function(e){if(this.checked){BX("notifySchemeSendSite").checked=true}}}}),BX.create("label",{attrs:{for:"notifySchemeSendEmail"},html:" "+BX.message("IM_SETTINGS_NC_4").replace("#MAIL#",this.userEmail)+""})]}),this.bitrixMobile?BX.create("div",{props:{className:"bx-messenger-settings-notify-clients-item"},children:[BX.create("input",{attrs:{"data-save":1,type:"checkbox",id:"notifySchemeSendPush",name:"notifySchemeSendPush",value:"Y",checked:this.settings.notifySchemeSendPush}}),BX.create("label",{attrs:{for:"notifySchemeSendPush"},html:" "+BX.message("IM_SETTINGS_NC_5")+"<br />"})]}):null]}))}return t};BX.IM.prototype.showHardwareSettings=function(){var e=this;var t={micSelect:document.querySelector("[name=defaultMicrophone]"),camSelect:document.querySelector("[name=defaultCamera]"),speakerSelect:document.querySelector("[name=defaultSpeaker]"),audioLevel:BX("bx-messenger-settings-hardware-microphone-level"),cameraImage:BX("bx-messenger-settings-hardware-camera-image"),video:BX("bx-messenger-settings-hardware-camera-image-video"),error:BX("bx-messenger-settings-hardware-error")};if(this.settingsCameraTestMediaStream){return}if(!t.micSelect||!t.camSelect){return}t.micSelect.style.minWidth="200px";t.camSelect.style.minWidth="200px";if(!t.video){t.video=BX.create("video",{attrs:{id:"bx-messenger-settings-hardware-camera-image-video"}});t.cameraImage.appendChild(t.video);t.video.addEventListener("loadedmetadata",function(){if(BX.MessengerCommon.isDesktop()){BX.desktop.resize()}})}if(!BX.Call.Util.isWebRTCSupported()){console.log("webrtc is not supported");return}var s={audio:false,video:false};var i={audioInput:false,videoInput:false,audioOutput:false};var a={audioInput:false,videoInput:false,audioOutput:false};var n=window.location.protocol==="https:";if(!navigator.mediaDevices){t.error.appendChild(BX.create("div",{props:{className:"ui-alert ui-alert-icon-danger"},children:[BX.create("span",{props:{className:"ui-alert-message"},text:BX.message("IM_SETTINGS_HARDWARE_ERROR")+(n?"":" "+BX.message("IM_SETTINGS_HARDWARE_USE_HTTPS"))})]}));return}navigator.mediaDevices.enumerateDevices().then(function(t){t.forEach(function(t){if(t.kind=="audioinput"){i.audioInput=true;if(e.webrtc.defaultMicrophone===t.deviceId){a.audioInput=true}}else if(t.kind=="videoinput"){i.videoInput=true;if(e.webrtc.defaultCamera===t.deviceId){a.videoInput=true}}else if(t.kind=="audiooutput"){i.audioOutput=true;if(e.webrtc.defaultSpeaker===t.deviceId){a.audioOutput=true}}});if(!a.audioInput){window.localStorage.removeItem("bx-im-settings-default-microphone");e.webrtc.defaultMicrophone=""}if(!a.videoInput){window.localStorage.removeItem("bx-im-settings-default-camera");e.webrtc.defaultCamera=""}if(!a.audioOutput){window.localStorage.removeItem("bx-im-settings-default-speaker");e.webrtc.defaultSpeaker=""}if(i.audioInput){if(e.webrtc.defaultMicrophone)s.audio={deviceId:{exact:e.webrtc.defaultMicrophone}};else s.audio=true}if(i.videoInput){if(e.webrtc.defaultCamera)s.video={deviceId:{exact:e.webrtc.defaultCamera}};else s.video=true}return navigator.mediaDevices.getUserMedia(s)}).then(function(s){e.settingsCameraTestMediaStream=s;e.settingsLevelMeter=new BX.IM.LevelMeter(t.audioLevel);if(e.settingsLevelMeter.supported)e.settingsLevelMeter.attachMediaStream(s);t.video.srcObject=s;t.video.play();t.video.muted=true;if(BX.MessengerCommon.isDesktop()){BX.desktop.resize()}return navigator.mediaDevices.enumerateDevices()}).then(function(s){var i=function(){var t=e.settingsCameraTestMediaStream.getVideoTracks();if(t.length>0&&t[0].label)return t[0].label;else return""}();var a=function(){var t=e.settingsCameraTestMediaStream.getAudioTracks();if(t.length>0&&t[0].label)return t[0].label;else return""}();return new Promise(function(n,o){if(s&&t.micSelect.options.length==0&&t.camSelect.options.length==0){s.forEach(function(s){var n;var o=false;var r=false;var l=false;var p=s.label==""?BX.message("IM_SETTINGS_HARDWARE_DEFAULT_MICROPHONE"):s.label;if(s.kind=="audioinput"){o=true;n=BX.create("option",{text:p,attrs:{value:s.deviceId}});if(s.label===a||s.deviceId===e.webrtc.defaultMicrophone){n.selected=true}t.micSelect.options.add(n)}else if(s.kind=="videoinput"){l=true;n=BX.create("option",{text:p,attrs:{value:s.deviceId}});if(s.label===i||s.deviceId===e.webrtc.defaultCamera){n.selected=true}t.camSelect.options.add(n)}else if(s.kind=="audiooutput"){r=true;n=BX.create("option",{text:p,attrs:{value:s.deviceId}});if(s.deviceId===e.webrtc.defaultSpeaker){n.selected=true}t.speakerSelect.options.add(n)}});n()}else{o()}})}).catch(function(e){console.log("could not access user hardware. constraints were: ",s);console.log(e);t.error.appendChild(BX.create("div",{props:{className:"ui-alert ui-alert-icon-danger"},children:[BX.create("span",{props:{className:"ui-alert-message"},text:BX.message("IM_SETTINGS_HARDWARE_ERROR")+(n?"":" "+BX.message("IM_SETTINGS_HARDWARE_USE_HTTPS"))})]}))})};BX.IM.prototype.changeHardwareSettings=function(){var e=this;var t={micSelect:document.querySelector("[name=defaultMicrophone]"),camSelect:document.querySelector("[name=defaultCamera]"),audioLevel:BX("bx-messenger-settings-hardware-microphone-level"),cameraImage:BX("bx-messenger-settings-hardware-camera-image"),video:BX("bx-messenger-settings-hardware-camera-image-video")};if(this.settingsCameraTestMediaStream){BX.webrtc.stopMediaStream(this.settingsCameraTestMediaStream);this.settingsCameraTestMediaStream=null}if(this.settingsLevelMeter){this.settingsLevelMeter.stop()}var s={audio:{deviceId:t.micSelect.value?{exact:t.micSelect.value}:undefined},video:{deviceId:t.camSelect.value?{exact:t.camSelect.value}:undefined}};navigator.mediaDevices.getUserMedia(s).then(function(s){e.settingsCameraTestMediaStream=s;if(e.settingsLevelMeter.supported)e.settingsLevelMeter.attachMediaStream(s);t.video.srcObject=s;t.video.play();if(BX.MessengerCommon.isDesktop()){BX.desktop.resize()}}).catch(function(e){console.log("could not access user hardware",e)})};BX.IM.prototype.closeHardwareSettings=function(){if(this.settingsCameraTestMediaStream)BX.webrtc.stopMediaStream(this.settingsCameraTestMediaStream);if(this.settingsLevelMeter)this.settingsLevelMeter.stop();this.settingsCameraTestMediaStream=null;this.webrtc.readDefaults()};BX.IM.prototype.saveSetting=function(e,t){this.settings[e]=t;var s={};s[e]=t;this.saveSettings(s);return true};BX.IM.prototype.saveSettings=function(e){var t="";for(var s in e){this.settings[s]=e[s];t=t+s}BX.localStorage.set("ims",JSON.stringify(this.settings),5);if(this.saveSettingsTimeout[t])clearTimeout(this.saveSettingsTimeout[t]);this.saveSettingsTimeout[t]=setTimeout(BX.delegate(function(){BX.ajax({url:this.pathToAjax+"?SETTINGS_SAVE&V="+this.revision,method:"POST",dataType:"json",timeout:30,data:{IM_SETTING_SAVE:"Y",IM_AJAX_CALL:"Y",SETTINGS:JSON.stringify(e),sessid:BX.bitrix_sessid()}});delete this.saveSettingsTimeout[t]},this),700)};BX.IM.prototype.saveFormSettings=function(){var e=BX.findChildren(this.popupSettingsBody,{attribute:"data-save"},true);for(var t=0;t<e.length;t++){if(e[t].tagName=="INPUT"&&e[t].type=="checkbox"){if(typeof this.settingsSaveCallback[e[t].name]=="function")this.settings[e[t].name]=this.settingsSaveCallback[e[t].name](e[t]);else this.settings[e[t].name]=e[t].checked}else if(e[t].tagName=="INPUT"&&e[t].type=="radio"&&e[t].checked){if(typeof this.settingsSaveCallback[e[t].name]=="function")this.settings[e[t].name]=this.settingsSaveCallback[e[t].name](e[t]);else this.settings[e[t].name]=e[t].value}else if(e[t].tagName=="SELECT"){if(typeof this.settingsSaveCallback[e[t].name]=="function")this.settings[e[t].name]=this.settingsSaveCallback[e[t].name](e[t]);else this.settings[e[t].name]=e[t][e[t].selectedIndex].value}}var s=this.settings["notifyScheme"]=="simple"?{}:{notify:{}};for(var i in this.settings){if(i.substr(0,7)=="notify|"){if(this.settingsDisabled[i])continue;if(s["notify"])s["notify"][i.substr(7)]=this.settings[i]}else{s[i]=this.settings[i]}}if(BX.MessengerCommon.isDesktop()){BX.desktop.onCustomEvent("bxSaveSettings",[this.settings])}else{BX.localStorage.set("ims",JSON.stringify(this.settings),5)}if(this.messenger!=null){BX.MessengerCommon.userListRedraw(true);if(this.messenger.popupMessengerTextareaSendType)this.messenger.popupMessengerTextareaSendType.innerHTML=this.settings.sendByEnter?"Enter":BX.browser.IsMac()?"&#8984;+Enter":"Ctrl+Enter"}BX.ajax({url:this.pathToAjax+"?SETTINGS_FORM_SAVE&V="+this.revision,method:"POST",dataType:"json",timeout:30,data:{IM_SETTINGS_SAVE:"Y",IM_AJAX_CALL:"Y",SETTINGS:JSON.stringify(s),sessid:BX.bitrix_sessid()},onsuccess:BX.delegate(function(){BX.MessengerCommon.drawTab(this.messenger.currentTab,true);this.popupSettings.close()},this),onfailure:BX.delegate(function(){this.popupSettingsButtonSave.setClassName("popup-window-button popup-window-button-accept");this.popupSettingsButtonSave.setName(BX.message("IM_SETTINGS_SAVE"));BX.show(this.popupSettingsButtonClose.buttonNode)},this)})};BX.IM.prototype.GetNotifySettings=function(){BX.ajax({url:this.pathToAjax+"?SETTINGS_NOTIFY_LOAD&V="+this.revision,method:"POST",dataType:"json",timeout:30,data:{IM_SETTINGS_NOTIFY_LOAD:"Y",IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()},onsuccess:BX.delegate(function(e){if(e.ERROR==""){if(this.settings.notifyScheme=="simple"){for(var t in e.VALUES){if(t.substr(0,10)=="important|"){continue}if(t.substr(0,9)=="disabled|"){this.settingsDisabled["notify|"+t.substr(9)]=e.VALUES[t];continue}if(!BX("notifySchemeSendSite").checked&&t.substr(0,5)=="site|")e.VALUES[t]=false;else if(this.bitrixXmpp&&!BX("notifySchemeSendXmpp").checked&&t.substr(0,5)=="xmpp|")e.VALUES[t]=false;else if(!BX("notifySchemeSendEmail").checked&&t.substr(0,6)=="email|")e.VALUES[t]=false;else if(this.bitrixMobile&&!BX("notifySchemeSendPush").checked&&t.substr(0,5)=="push|")e.VALUES[t]=false;this.settings["notify|"+t]=e.VALUES[t]}}else{for(var t in e.VALUES){if(t.substr(0,10)=="important|"){continue}if(t.substr(0,9)=="disabled|"){this.settingsDisabled["notify|"+t.substr(9)]=e.VALUES[t];continue}this.settings["notify|"+t]=e.VALUES[t]}}var s=[];if(e.NAMES["im"]){s.push([{type:"separator",title:e.NAMES["im"].NAME}]);for(var i in e.NAMES["im"]["NOTIFY"]){var a=e.NAMES["im"]["NOTIFY"][i];s.push([{type:"text",title:a},{type:"checkbox",id:"notifyId|site|im|"+i,name:"notify|site|im|"+i,callback:function(e){if(BX(this.id.replace("|site|","|email|")).disabled){return true}if(!this.checked){BX(this.id.replace("|site|","|email|")).checked=false}else{BX(this.id.replace("|site|","|email|")).checked=true}}},this.bitrixXmpp?{type:"checkbox",name:"notify|xmpp|im|"+i}:false,{type:"checkbox",id:"notifyId|email|im|"+i,name:"notify|email|im|"+i,callback:function(e){if(BX(this.id.replace("|email|","|site|")).disabled){return true}if(this.checked){BX(this.id.replace("|email|","|site|")).checked=true}}},this.bitrixMobile?{type:"checkbox",name:"notify|push|im|"+i}:false])}}for(var n in e.NAMES){if(n=="im")continue;s.push([{type:"separator",title:e.NAMES[n].NAME}]);for(var i in e.NAMES[n]["NOTIFY"]){var a=e.NAMES[n]["NOTIFY"][i];s.push([{type:"text",title:a},{type:"checkbox",id:"notifyId|site|"+n+"|"+i,name:"notify|site|"+n+"|"+i,callback:function(e){if(BX(this.id.replace("|site|","|email|")).disabled){return true}if(!this.checked){BX(this.id.replace("|site|","|email|")).checked=false}else{BX(this.id.replace("|site|","|email|")).checked=true}}},this.bitrixXmpp?{type:"checkbox",name:"notify|xmpp|"+n+"|"+i}:false,{type:"checkbox",id:"notifyId|email|"+n+"|"+i,name:"notify|email|"+n+"|"+i,callback:function(e){if(BX(this.id.replace("|email|","|site|")).disabled){return true}if(this.checked){BX(this.id.replace("|email|","|site|")).checked=true}}},this.bitrixMobile?{type:"checkbox",name:"notify|push|"+n+"|"+i}:false])}}this.settingsTableConfig["notify"].rows=s}else{this.settingsTableConfig["notify"].rows=[[{type:"error",title:BX.message("IM_M_ERROR")}]]}BX("bx-messenger-settings-table-notify").innerHTML="";BX.adjust(BX("bx-messenger-settings-table-notify"),{children:[this.prepareSettingsTable("notify")]});if(e.ERROR!="")this.settingsTableConfig["notify"].rows=[];if(BX.MessengerCommon.isDesktop())this.desktop.autoResize()},this),onfailure:BX.delegate(function(){this.settingsTableConfig["notify"].rows=[[{type:"error",title:BX.message("IM_M_ERROR")}]];BX("bx-messenger-settings-table-notify").innerHTML="";BX.adjust(BX("bx-messenger-settings-table-notify"),{children:[this.prepareSettingsTable("notify")]});this.settingsTableConfig["notify"].rows=[];if(BX.MessengerCommon.isDesktop())this.desktop.autoResize()},this)})};BX.IM.prototype.GetSimpleNotifySettings=function(){BX.ajax({url:this.pathToAjax+"?SETTINGS_SIMPLE_NOTIFY_LOAD&V="+this.revision,method:"POST",dataType:"json",timeout:30,data:{IM_SETTINGS_SIMPLE_NOTIFY_LOAD:"Y",IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()},onsuccess:BX.delegate(function(e){if(e.ERROR==""){var t=[];for(var s in e.VALUES){t.push([{type:"separator",title:e.NAMES[s]?e.NAMES[s].NAME:"-"}]);for(var i in e.VALUES[s]){var a=e.NAMES[s]?e.NAMES[s]["NOTIFY"][i]:"-";t.push([{type:"text",title:a},{type:"link",title:BX.message("IM_SETTINGS_SNOTIFY_ENABLE"),attrs:{"data-settingName":s+"|"+i},callback:BX.delegate(function(){this.removeSimpleNotify(BX.proxy_context)},this)}]);this.settingsNotifyBlocked[s+"|"+i]=true}}this.settingsTableConfig["simpleNotify"].rows=t}else{this.settingsTableConfig["simpleNotify"].rows=[[{type:"error",title:BX.message("IM_M_ERROR")}]]}BX("bx-messenger-settings-table-simpleNotify").innerHTML="";BX.adjust(BX("bx-messenger-settings-table-simpleNotify"),{children:[this.prepareSettingsTable("simpleNotify")]});if(e.ERROR!="")this.settingsTableConfig["simpleNotify"].rows=[];if(BX.MessengerCommon.isDesktop())this.desktop.autoResize()},this),onfailure:BX.delegate(function(){this.settingsTableConfig["simpleNotify"].rows=[[{type:"error",title:BX.message("IM_M_ERROR")}]];if(BX("bx-messenger-settings-table-simpleNotify")){BX("bx-messenger-settings-table-simpleNotify").innerHTML="";BX.adjust(BX("bx-messenger-settings-table-simpleNotify"),{children:[this.prepareSettingsTable("simpleNotify")]})}this.settingsTableConfig["simpleNotify"].rows=[];if(BX.MessengerCommon.isDesktop())this.desktop.autoResize()},this)})};BX.IM.prototype.removeSimpleNotify=function(e){var t=e.parentNode.parentNode.parentNode;if(!e.parentNode.parentNode.nextSibling&&e.parentNode.parentNode.previousSibling.childNodes[0].className!="bx-messenger-settings-table-sep"){BX.remove(e.parentNode.parentNode)}else if(e.parentNode.parentNode.previousSibling&&e.parentNode.parentNode.previousSibling.childNodes[0].className!="bx-messenger-settings-table-sep"){BX.remove(e.parentNode.parentNode)}else if(e.parentNode.parentNode.nextSibling&&e.parentNode.parentNode.nextSibling.childNodes[0].className!="bx-messenger-settings-table-sep"){BX.remove(e.parentNode.parentNode)}else if(e.parentNode.parentNode.previousSibling.childNodes[0].className=="bx-messenger-settings-table-sep"&&!e.parentNode.parentNode.nextSibling){BX.remove(e.parentNode.parentNode.previousSibling);BX.remove(e.parentNode.parentNode)}else if(e.parentNode.parentNode.previousSibling.childNodes[0].className=="bx-messenger-settings-table-sep"&&e.parentNode.parentNode.nextSibling.childNodes[0].className=="bx-messenger-settings-table-sep"){BX.remove(e.parentNode.parentNode.previousSibling);BX.remove(e.parentNode.parentNode)}if(t.childNodes.length<=1)BX.remove(t);this.notify.blockNotifyType(e.getAttribute("data-settingName"));if(BX.MessengerCommon.isDesktop())this.desktop.autoResize()};BX.IM.prototype.openConfirm=function(e,t,s){if(this.popupConfirm!=null)this.popupConfirm.destroy();if(typeof e=="object")e='<div class="bx-messenger-confirm-title">'+e.title+"</div>"+e.message;s=s!==false;var i=t===false;if(typeof t=="undefined"||typeof t=="object"&&t.length<=0||t===false){t=[new BX.PopupWindowButton({text:BX.message("IM_NOTIFY_CONFIRM_CLOSE"),className:"popup-window-button",events:{click:function(e){this.popupWindow.close();BX.PreventDefault(e)}}})]}this.popupConfirm=new BX.PopupWindow("bx-notifier-popup-confirm",null,{darkMode:this.settings.enableDarkTheme,zIndex:BX.MessengerCommon.getDefaultZIndex()+1e3,autoHide:t===false,buttons:t,closeByEsc:t===false,overlay:s,events:{onPopupClose:function(){this.destroy()},onPopupDestroy:BX.delegate(function(){this.popupConfirm=null},this)},content:BX.create("div",{props:{className:t===false?" bx-messenger-confirm-without-buttons":"bx-messenger-confirm"},html:e})});BX.addClass(this.popupConfirm.popupContainer,"bx-messenger-mark");this.popupConfirm.show();BX.bind(this.popupConfirm.popupContainer,"click",BX.MessengerCommon.preventDefault);BX.bind(this.popupConfirm.contentContainer,"click",BX.PreventDefault);BX.bind(this.popupConfirm.overlay.element,"click",BX.PreventDefault);if(i===true){setTimeout(BX.delegate(function(){this.close()},this.popupConfirm),2e3)}};BX.IM.prototype.setBackground=function(e){var t=null;var s=null;if(BX.MessengerCommon.isPage()){s=BX.MessengerWindow.contentBox}else{s=this.messenger.popupMessengerContent}var i=false;if(typeof e=="undefined"){e=this.settings.backgroundImage}else{if(e=="on"){e=true}else if(e=="off"){e=false}else if(this.colorsHex[e.toString().toUpperCase()]){e=this.colorsHex[e.toString().toUpperCase()]}else{var a={};for(var n in this.colors){a[this.colors[n].toUpperCase()]=n}if(a[e.toString().toUpperCase()]){var n=a[e.toString().toUpperCase()];if(this.colorsHex[n]){e=this.colorsHex[n]}}}i=this.settings.backgroundImage!=e}var o=e;if(this.settings.enableDarkTheme){o=false}if(o===false){BX.removeClass(s,"bx-messenger-image");BX.removeClass(s,"bx-messenger-image-link");BX.style(s,"background-image","");BX.style(s,"background-color","")}else if(o===true){BX.addClass(s,"bx-messenger-image");BX.removeClass(s,"bx-messenger-image-link");BX.style(s,"background-image","");BX.style(s,"background-color","")}else if(o.toString().length>0){BX.addClass(s,"bx-messenger-image");if(o.toString().substr(0,1)=="#"){BX.style(s,"background-color",o);BX.style(s,"background-image","")}else if(o.toString().substr(0,4)=="http"){BX.addClass(s,"bx-messenger-image-link");BX.style(s,"background-image","url("+o+")");BX.style(s,"background-color","")}else{return false}}else{return false}if(i){this.saveSettings({backgroundImage:e})}};BX.IM.getSelectionText=function(){var e="";if(window.getSelection){e=window.getSelection().toString()}else{e=document.selection.createRange().text}return e};BX.IM.prototype.getLocalConfig=function(e,t){if(BX.MessengerCommon.isDesktop()){return BX.desktop.getLocalConfig(e,t)}t=typeof t=="undefined"?null:t;if(!BX.browser.SupportLocalStorage()){return t}if(BX.MessengerCommon.isPage()&&!BX.MessengerCommon.isDesktop())e="full-"+e;var s=BX.localStorage.get(e);if(s==null){return t}if(typeof s=="string"&&s.length>0){try{s=JSON.parse(s)}catch(e){s=t}}return s};BX.IM.prototype.setLocalConfig=function(e,t,s){if(BX.MessengerCommon.isDesktop()){return BX.desktop.setLocalConfig(e,t)}s=s||86400;if(typeof t=="object")t=JSON.stringify(t);else if(typeof t=="boolean")t=t?"true":"false";else if(typeof t=="undefined")t="";else if(typeof t!="string")t=t+"";if(!BX.browser.SupportLocalStorage())return false;if(BX.MessengerCommon.isPage()&&!BX.MessengerCommon.isDesktop())e="full-"+e;BX.localStorage.set(e,t,s);return true};BX.IM.prototype.removeLocalConfig=function(e){if(BX.MessengerCommon.isDesktop()){return BX.desktop.removeLocalConfig(e)}if(!BX.browser.SupportLocalStorage())return false;if(BX.MessengerCommon.isPage()&&!BX.MessengerCommon.isDesktop())e="full-"+e;BX.localStorage.remove(e);return true};BX.IM.prototype.checkDesktop=function(e,t){if(!this.settings.openDesktopFromPanel){t();return}BX.desktopUtils.runningCheck(e,t)};BX.IM.prototype.storageSet=function(e){if(e.key=="mps"){this.stopSound()}else if(e.key=="mrss"){this.stopRepeatSound(e.value.sound,false)}}})();(function(){if(BX.MessengerNotify)return;BX.MessengerNotify=function(e,t){this.BXIM=e;this.settings={};this.params=t||{};this.windowInnerSize={};this.windowScrollPos={};this.sendAjaxTry=0;this.webrtc=t.webrtcClass;this.desktop=t.desktopClass;this.notifyCount=t.countNotify;this.notifyUpdateCount=t.countNotify;this.counters=t.counters;this.mailCount=t.mailCount;this.notifyAnswerBlock={};this.notifyAnswerText={};this.notifyHistoryPage=0;this.notifyHistoryLoad=false;this.notifyBody=null;this.notify=t.notify;for(var s in this.notify){this.notify[s].date=new Date(this.notify[s].date)}this.notifyLoad=false;this.unreadNotify=t.unreadNotify;this.unreadNotifyLoad=t.loadNotify;this.flashNotify=t.flashNotify;this.initNotifyCount=t.countNotify;this.confirmDisabledButtons=false;if(this.unreadNotifyLoad){for(var i in this.notify)this.initNotifyCount--}if(t.domNode){this.panel=t.domNode;this.panelEnabled=true;BX.bind(this.panel,"click",BX.PreventDefault)}else{this.panel=BX.create("span",{props:{className:"bx-messenger-hide"}});this.panelEnabled=false}if(this.panelEnabled){if(BX.browser.IsDoctype())BX.addClass(this.panel,"bx-notifier-panel-doc");else BX.addClass(document.body,"bx-no-doctype");this.panelButtonCall=BX.findChildByClassName(this.panel,"bx-notifier-call");if(!this.webrtc.phoneEnabled||!this.webrtc.phoneCanPerformCalls){BX.style(this.panelButtonCall,"display","none")}this.panelButtonNetwork=BX.findChildByClassName(this.panel,"bx-notifier-network");if(this.panelButtonNetwork){this.panelButtonNetworkCount=BX.findChildByClassName(this.panelButtonNetwork,"bx-notifier-indicator-count");if(this.BXIM.bitrixNetwork){this.panelButtonNetwork.href="https://www.bitrix24.net/";this.panelButtonNetwork.setAttribute("target","_blank");if(this.panelButtonNetworkCount!=null)this.panelButtonNetworkCount.innerHTML=""}else{BX.style(this.panelButtonNetwork,"display","none");this.panelButtonNetworkCount.innerHTML=""}}this.panelButtonNotify=BX.findChildByClassName(this.panel,"bx-notifier-notify");if(this.panelButtonNotify){this.panelButtonNotifyCount=BX.findChildByClassName(this.panelButtonNotify,"bx-notifier-indicator-count");if(this.panelButtonNotifyCount)this.panelButtonNotifyCount.innerHTML=""}this.panelButtonMessage=BX.findChildByClassName(this.panel,"bx-notifier-message");if(this.panelButtonMessage){this.panelButtonMessageCount=BX.findChildByClassName(this.panelButtonMessage,"bx-notifier-indicator-count");if(this.panelButtonMessageCount)this.panelButtonMessageCount.innerHTML=""}this.panelButtonMail=BX.findChildByClassName(this.panel,"bx-notifier-mail");if(this.panelButtonMail){this.panelButtonMailCount=BX.findChildByClassName(this.panelButtonMail,"bx-notifier-indicator-count");if(this.panelButtonMailCount){this.panelButtonMail.href=this.BXIM.path.mail;this.panelButtonMail.setAttribute("target","_blank");if(this.panelButtonMailCount!=null)this.panelButtonMailCount.innerHTML=""}}this.panelDragLabel=BX.findChildByClassName(this.panel,"bx-notifier-drag");if(this.panelDragLabel){BX.bind(this.panelDragLabel,"mousedown",BX.delegate(this._startDrag,this));BX.bind(this.panelDragLabel,"dobleclick",BX.delegate(this._stopDrag,this))}}if(BX.browser.IsAndroid()||BX.browser.IsIOS())BX.addClass(document.body,"bx-im-mobile");this.messenger=null;this.messengerNotifyButton=null;this.messengerNotifyButtonCount=null;this.popupNotifyItem=null;this.popupNotifySize=387;this.popupNotifySizeMin=317;this.popupNotifyButtonFilter=null;this.popupNotifyButtonFilterBox=null;this.popupHistoryFilterVisible=false;this.popupNotifyMore=null;this.dragged=false;this.dragPageX=0;this.dragPageY=0;if(this.BXIM.init){if(BX.MessengerCommon.isPage()){BX.MessengerWindow.addTab({id:"notify",title:BX.message("IM_SETTINGS_NOTIFY"),order:110,target:"im",events:{open:BX.delegate(function(){this.openNotify(false,true)},this)}})}this.panel.appendChild(this.BXIM.audio.reminder=BX.create("audio",{props:{className:"bx-notify-audio"},children:[BX.create("source",{attrs:{src:"/bitrix/js/im/audio/reminder.ogg",type:"audio/ogg; codecs=vorbis"}}),BX.create("source",{attrs:{src:"/bitrix/js/im/audio/reminder.mp3",type:"audio/mpeg"}})]}));if(typeof this.BXIM.audio.reminder.play=="undefined"){this.BXIM.settings.enableSound=false}if(BX.browser.SupportLocalStorage()){BX.addCustomEvent(window,"onLocalStorageSet",BX.proxy(this.storageSet,this));var a=BX.localStorage.get("npp");this.BXIM.settings.panelPositionHorizontal=!!a?a.h:this.BXIM.settings.panelPositionHorizontal;this.BXIM.settings.panelPositionVertical=!!a?a.v:this.BXIM.settings.panelPositionVertical;var n=BX.localStorage.get("mfn");if(n){for(var i in this.flashNotify)if(this.flashNotify[i]!=n[i]&&n[i]==false)this.flashNotify[i]=false}BX.garbage(function(){BX.localStorage.set("mfn",this.flashNotify,15)},this)}if(this.panelButtonNotify){BX.bind(this.panelButtonNotify,"click",BX.proxy(function(){this.toggleNotify()},this.BXIM))}if(this.webrtc.phoneEnabled&&this.webrtc.phoneCanPerformCalls){if(this.panelButtonCall){BX.bind(this.panelButtonCall,"click",BX.delegate(this.webrtc.openKeyPad,this.webrtc))}BX.bind(window,"scroll",BX.delegate(function(){if(this.webrtc.popupKeyPad)this.webrtc.popupKeyPad.close()},this))}if(this.panelDragLabel){BX.bind(this.panelDragLabel,"mousedown",BX.proxy(this._startDrag,this));BX.bind(this.panelDragLabel,"dobleclick",BX.proxy(this._stopDrag,this))}this.updateNotifyMailCount();if(!BX.MessengerCommon.isPage()){this.adjustPosition({resize:true});BX.bind(window,"resize",BX.proxy(function(){this.closePopup();this.adjustPosition({resize:true})},this));if(!BX.browser.IsDoctype())BX.bind(window,"scroll",BX.proxy(function(){this.adjustPosition({scroll:true})},this))}setTimeout(BX.delegate(function(){this.newNotify();this.updateNotifyCounters();this.updateNotifyCount()},this),500)}BX.addCustomEvent(window,"onSonetLogCounterClear",BX.proxy(function(e){var t={};t[e]=0;this.updateNotifyCounters(t)},this))};BX.MessengerNotify.prototype.getCounter=function(e){if(typeof e!="string")return false;e=e.toString();if(e=="im_notify")return this.notifyCount;if(e=="im_message")return this.BXIM.messageCount;return this.counters[e]?this.counters[e]:0};BX.MessengerNotify.prototype.updateNotifyCounters=function(e,t){t=t!=false;if(typeof e=="object"){for(var s in e)this.counters[s]=e[s]}BX.onCustomEvent(window,"onImUpdateCounter",[this.counters]);if(t)BX.localStorage.set("nuc",this.counters,5)};BX.MessengerNotify.prototype.updateNotifyMailCount=function(e,t){t=t!=false;if(typeof e!="undefined"||parseInt(e)>0)this.mailCount=parseInt(e);var s="";if(this.mailCount>99)s="99+";else if(this.mailCount>0)s=this.mailCount;if(this.panelButtonMail){if(this.mailCount>0)BX.removeClass(this.panelButtonMail,"bx-notifier-hide");else BX.addClass(this.panelButtonMail,"bx-notifier-hide");if(this.panelButtonMailCount!=null){this.panelButtonMailCount.innerHTML=s;this.adjustPosition({resize:true,timeout:500})}}BX.onCustomEvent(window,"onImUpdateCounterMail",[this.mailCount,"MAIL"]);if(t)BX.localStorage.set("numc",this.mailCount,5)};BX.MessengerNotify.prototype.updateNotifyCount=function(e){e=e!=false;var t=0;var s=0;if(this.unreadNotifyLoad)t=this.initNotifyCount;for(var i in this.unreadNotify){if(this.unreadNotify[i]==null)continue;var a=this.notify[this.unreadNotify[i]];if(!a)continue;if(a.type!=1)s++;t++}var n="";if(t>99)n="99+";else if(t>0)n=t;if(this.panelButtonNotifyCount){this.panelButtonNotifyCount.innerHTML=n;this.adjustPosition({resize:true,timeout:500})}if(this.messengerNotifyButtonCount)this.messengerNotifyButtonCount.innerHTML=parseInt(n)>0?'<span class="bx-messenger-cl-count-digit">'+n+"</span>":"";if(BX.MessengerCommon.isPage()){BX.MessengerWindow.setTabBadge("notify",t)}this.notifyCount=parseInt(t);this.notifyUpdateCount=parseInt(s);BX.onCustomEvent(window,"onImUpdateCounterNotify",[this.notifyCount,"NOTIFY"]);if(e)BX.localStorage.set("nunc",{unread:this.unreadNotify,flash:this.flashNotify},5)};BX.MessengerNotify.prototype.changeUnreadNotify=function(e,t){t=t!=false;var s=false;for(var i in e){if(!this.BXIM.xmppStatus&&this.BXIM.settings.status!="dnd")this.flashNotify[e[i]]=true;else this.flashNotify[e[i]]=false;this.unreadNotify[e[i]]=e[i];s=true}this.newNotify(t);for(var i in e){if(this.notify[e[i]].onlyFlash){delete this.notify[e[i]]}}if(s&&this.BXIM.notifyOpen)this.openNotify(true);this.updateNotifyCount(t)};BX.MessengerNotify.prototype.viewNotify=function(e,t,s){if(parseInt(e)<=0)return false;t=t===false?false:true;s=s===false?false:true;var i=this.notify[e];if(i&&i.type!=1){if(t){delete this.unreadNotify[e]}else{this.unreadNotify[e]=e}}delete this.flashNotify[e];BX.localStorage.set("mfn",this.flashNotify,80);if(s){BX.ajax({url:this.BXIM.pathToAjax+"?NOTIFY_VIEW&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{IM_NOTIFY_VIEW:"Y",ID:parseInt(e),READ:t?"Y":"N",IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()}})}if(this.BXIM.notifyOpen){var i=BX.findChildByClassName(document.body,"bx-notifier-item-"+e);if(t){BX.removeClass(i,"bx-notifier-item-new")}else{BX.addClass(i,"bx-notifier-item-new")}}this.updateNotifyCount(false);return true};BX.MessengerNotify.prototype.viewNotifyMarkupUpdate=function(){if(this.BXIM.notifyOpen){var e=BX.findChildrenByClassName(this.popupNotifyItem,"bx-notifier-item-new",false);if(e!=null){for(var t=0;t<e.length;t++){if(e[t].getAttribute("data-notifyType")==1){continue}if(!this.unreadNotify[e[t].getAttribute("data-notifyId")]){BX.removeClass(e[t],"bx-notifier-item-new")}}}for(var t in this.unreadNotify){var s=BX.findChildByClassName(this.popupNotifyItem,"bx-notifier-item-"+t,false);if(s!=null){BX.addClass(s,"bx-notifier-item-new")}}}};BX.MessengerNotify.prototype.viewNotifyAll=function(e){e=e!==false;if(this.BXIM.settings.notifyAutoRead){var t=null;for(var s in this.unreadNotify){if(this.notify[s]&&this.notify[s].type!=1){delete this.unreadNotify[s];if(t===null||t>s){t=s}}delete this.flashNotify[s]}if(!t){return false}if(e){BX.ajax({url:this.BXIM.pathToAjax+"?NOTIFY_READ&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{IM_NOTIFY_READ:"Y",ID:t,IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()}})}setTimeout(this.viewNotifyMarkupUpdate,500);this.updateNotifyCount(false)}else{for(var s in this.unreadNotify){delete this.flashNotify[s]}}BX.localStorage.set("mfn",this.flashNotify,80);return true};BX.MessengerNotify.prototype.newNotify=function(e){e=e!=false;var t=[];var s=[];var i=[];for(var a in this.flashNotify){if(this.flashNotify[a]===true){i.push(parseInt(a));this.flashNotify[a]=false}}var n={};i.sort(BX.delegate(function(e,t){if(!this.notify[e]||!this.notify[t]){return 0}var s=this.notify[e].date.getTime();var i=this.notify[t].date.getTime();var a=parseInt(this.notify[e].type);var n=parseInt(this.notify[t].type);if(a==1&&n!=1){return-1}else if(n==1&&a!=1){return 1}else if(i>s){return 1}else if(i<s){return-1}else{return 0}},this));for(var a=0;a<i.length;a++){var o=BX.clone(this.notify[i[a]]);if(o&&o.userId&&o.userName)n[o.userId]=o.userName;o.text=o.text.replace(/\[CHAT=(imol\|)?([0-9]{1,})\](.*?)\[\/CHAT\]/gi,function(e,t,s,i){return i});o=this.createNotify(o,true);if(o!==false){t.push(o);o=this.notify[i[a]];var r=BX.util.htmlspecialcharsback(o.text);r=r.split("<br />").join("\n");r=r.replace(/\[USER=([0-9]{1,})\](.*?)\[\/USER\]/gi,function(e,t,s){return s});r=r.replace(/\[CHAT=(imol\|)?([0-9]{1,})\](.*?)\[\/CHAT\]/gi,function(e,t,s,i){return i});r=r.replace(/\[PCH=([0-9]{1,})\](.*?)\[\/PCH\]/gi,function(e,t,s){return s});r=r.replace(/\[SEND(?:=(.+?))?\](.+?)?\[\/SEND\]/gi,function(e,t,s){return s?s:t});r=r.replace(/\[PUT(?:=(.+?))?\](.+?)?\[\/PUT\]/gi,function(e,t,s){return s?s:t});r=r.replace(/\[CALL(?:=(.+?))?\](.+?)?\[\/CALL\]/gi,function(e,t,s){return s?s:t});r=r.replace(/\[ATTACH=([0-9]{1,})\]/gi,function(e,t,s){return""});s.push({title:o.userName?BX.util.htmlspecialcharsback(o.userName):BX.message("IM_NOTIFY_WINDOW_NEW_TITLE"),text:r.split("<br />").join("\n").replace(/<\/?[^>]+>/gi,""),icon:o.userAvatar?o.userAvatar:"",link:o.link||"",tag:"im-notify-"+o.tag})}}if(t.length>5){var l="";for(var a in n)l+=", <i>"+n[a]+"</i>";var o={id:0,type:4,date:new Date,tag:"",originalTag:"",title:BX.message("IM_NM_NOTIFY_1").replace("#COUNT#",t.length),text:l.length>0?BX.message("IM_NM_NOTIFY_2").replace("#USERS#",l.substr(2)):BX.message("IM_NM_NOTIFY_3")};o=this.createNotify(o,true);BX.style(o,"cursor","pointer");t=[o];s=[{id:"",title:BX.message("IM_NM_NOTIFY_1").replace("#COUNT#",t.length),text:l.length>0?BX.message("IM_NM_NOTIFY_2").replace("#USERS#",BX.util.htmlspecialcharsback(l.substr(2))).replace(/<\/?[^>]+>/gi,""):BX.message("IM_NM_NOTIFY_3")}]}if(t.length==0)return false;if(BX.MessengerCommon.isDesktop())BX.desktop.flashIcon(false);this.closePopup();if(this.BXIM.context=="LINES"||this.BXIM.context=="DIALOG"){return false}if(this.BXIM.settings.status=="dnd"||BX.MessengerCommon.isSlider()||!BX.MessengerCommon.isDesktop()&&this.BXIM.desktopStatus){return false}if(e&&!this.BXIM.xmppStatus)this.BXIM.playSound("reminder");if(e&&BX.MessengerCommon.isDesktop()){if(!document.hasFocus()&&BX.desktop.getLocalConfig("nativeNotify",false)&&BX.browser.IsMac()){for(var a=0;a<s.length;a++){var p=s[a].title;var h=s[a].text;var c="";if(s[a].icon){c=s[a].icon.toString().startsWith("http")?s[a].icon:location.origin+"/"+s[a].icon}if(BX.MessengerCommon.isBlankAvatar(c)){c=""}BXDesktopSystem.Notify(p,"",h,encodeURI(c))}}else{for(var a=0;a<t.length;a++){var u=t[a].getAttribute("data-notifyId");var d='var notify = BX.findChildByClassName(document.body, "bx-notifier-item");'+'BX.bind(BX.findChildByClassName(notify, "bx-notifier-item-delete"), "click", function(event){ if (this.getAttribute("data-notifyType") != 1) { BX.desktop.onCustomEvent("main", "bxImClickCloseNotify", [this.getAttribute("data-notifyId")]); } BX.desktop.windowCommand("close"); BX.MessengerCommon.preventDefault(event); });'+(t[a].id>0?"":'BX.bind(notify, "click", function(event){ BX.desktop.onCustomEvent("main", "bxImClickNotify", [this.getAttribute("data-notifyId"), this.getAttribute("data-link")]); BX.desktop.windowCommand("close"); BX.MessengerCommon.preventDefault(event); });')+'BX.bindDelegate(notify, "click", {className: "bx-notifier-item-button"}, BX.delegate(function(){ '+'BX.desktop.windowCommand("freeze");'+'notifyId = BX.proxy_context.getAttribute("data-id");'+"BXIM.notify.confirmRequest({"+'"notifyId": notifyId,'+'"notifyValue": BX.proxy_context.getAttribute("data-value"),'+'"notifyURL": BX.proxy_context.getAttribute("data-url"),'+'"notifyTag": BXIM.notify.notify[notifyId] && BXIM.notify.notify[notifyId].tag? BXIM.notify.notify[notifyId].tag: null,'+'"groupDelete": BX.proxy_context.getAttribute("data-group") == null? false: true,'+"}, true);"+'BX.desktop.onCustomEvent("main", "bxImClickConfirmNotify", [notifyId]); '+"}, BXIM.notify));"+'BX.bind(notify, "contextmenu", function(){ BX.desktop.windowCommand("close")});';this.desktop.openNewNotify(u,t[a],d)}}}else if(e&&!this.BXIM.windowFocus&&this.BXIM.notifyManager.nativeNotifyGranted()){for(var a=0;a<s.length;a++){var o=s[a];o.onshow=function(){var e=this;setTimeout(function(){e.close()},5e3)};o.onclick=function(){window.focus();if(o.link){var e=BX.create("a",{attrs:{href:o.link,style:"display:none"}});document.body.appendChild(e);e.click()}else{top.BXIM.openNotify()}this.close()};this.BXIM.notifyManager.nativeNotify(o)}}else{if(this.BXIM.windowFocus&&this.BXIM.notifyManager.nativeNotifyGranted()){BX.localStorage.set("mnnb",true,1)}for(var a=0;a<t.length;a++){var m=this.notify[t[a].getAttribute("data-notifyId")]?this.notify[t[a].getAttribute("data-notifyId")]:null;this.BXIM.notifyManager.add({html:t[a],tag:m&&m.tag?"im-notify-"+m.tag:"",originalTag:m&&m.originalTag?m.originalTag:"",notifyId:t[a].getAttribute("data-notifyId"),notifyType:t[a].getAttribute("data-notifyType"),link:m&&m.link?m.link:"",click:t[a].id>0?null:BX.delegate(function(e){if(e.notifyParams.link){var t=BX.create("a",{attrs:{href:e.notifyParams.link,style:"display:none"}});document.body.appendChild(t);t.click()}else{this.BXIM.openNotify()}e.close()},this),close:BX.delegate(function(e){if(e.notifyParams.notifyType!=1&&e.notifyParams.notifyId)this.viewNotify(e.notifyParams.notifyId)},this)})}}return true};BX.MessengerNotify.prototype.confirmRequest=function(e,t){if(this.confirmDisabledButtons)return false;t=t==true;e.notifyOriginTag=this.notify[e.notifyId]?this.notify[e.notifyId].originalTag:"";if(BX.MessengerCommon.isMobile()){if(e.groupDelete&&e.notifyTag!=null){for(var s in this.notify){if(this.notify[s].tag==e.notifyTag)delete this.notify[s]}}else{delete this.notify[e.notifyId]}}this.updateNotifyCount();if(t&&BX.MessengerCommon.isDesktop())BX.desktop.windowCommand("freeze");else BX.hide(BX.proxy_context.parentNode.parentNode.parentNode);BX.ajax({url:this.BXIM.pathToAjax+"?NOTIFY_CONFIRM&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_NOTIFY_CONFIRM:"Y",NOTIFY_ID:e.notifyId,NOTIFY_VALUE:e.notifyValue,IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()},onsuccess:BX.delegate(function(s){if(e.notifyURL!=null){if(t&&BX.MessengerCommon.isDesktop())BX.desktop.browse(e.notifyURL);else location.href=e.notifyURL;this.confirmDisabledButtons=true}if(!BX.MessengerCommon.isMobile()&&this.notify[e.notifyId]&&s.MESSAGES){this.notify[e.notifyId].confirmMessages=s.MESSAGES}BX.onCustomEvent(window,"onImConfirmNotify",[{NOTIFY_ID:e.notifyId,NOTIFY_TAG:e.notifyOriginTag,NOTIFY_VALUE:e.notifyValue,NOTIFY_MESSAGES:s.MESSAGES}]);if(t&&BX.MessengerCommon.isDesktop())BX.desktop.windowCommand("close")},this),onfailure:BX.delegate(function(){if(t&&BX.MessengerCommon.isDesktop())BX.desktop.windowCommand("close")},this)});if(e.groupDelete)BX.localStorage.set("nrgn",e.notifyTag,5);else BX.localStorage.set("nrn",e.notifyId,5);return false};BX.MessengerNotify.prototype.drawNotify=function(e,t){t=t==true;var s=typeof e=="object"?e:BX.clone(this.notify);var i={};var a={};for(var n in s){if(!s.hasOwnProperty(n)){continue}if(s[n].tag!=""&&(!s[n].params||s[n].params.CAN_ANSWER!="Y")){if(!a[s[n].tag]||!a[s[n].tag][s[n].userId]){if(a[s[n].tag]){if(!a[s[n].tag][s[n].userId])a[s[n].tag][s[n].userId]=s[n].id;if(parseInt(i[s[n].tag].date)<=parseInt(s[n].date)){s[n].groupped=true;delete s[i[s[n].tag].id];i[s[n].tag]=s[n]}else{s[i[s[n].tag].id].groupped=true;delete s[n]}}else{a[s[n].tag]={};a[s[n].tag][s[n].userId]=s[n].id;i[s[n].tag]=s[n]}}else{if(parseInt(i[s[n].tag].date)<=parseInt(s[n].date)){s[n].groupped=true;delete s[i[s[n].tag].id];i[s[n].tag]=s[n]}else{s[i[s[n].tag].id].groupped=true;delete s[n]}}}}var o=[];var r=[];for(var n in s){if(!s.hasOwnProperty(n)){continue}r.push(parseInt(n))}r.sort(function(e,t){if(!s[e]||!s[t]){return 0}var i=s[e].date.getTime();var a=s[t].date.getTime();var n=typeof s[e].confirmMessages=="undefined"?parseInt(s[e].type):2;var o=typeof s[t].confirmMessages=="undefined"?parseInt(s[t].type):2;if(n==1&&o!=1){return-1}else if(o==1&&n!=1){return 1}else if(a>i){return 1}else if(a<i){return-1}else{return 0}});for(var n=0;n<r.length;n++){var l=s[r[n]];if(!l){continue}if(l.groupped){l.otherCount=0;if(this.notify[l.id]){this.notify[l.id].otherItems=[];for(var p in a[l.tag]){if(this.notify[l.id].userId!=p)this.notify[l.id].otherItems.push(a[l.tag][p])}l.otherCount=this.notify[l.id].otherItems.length}if(l.otherCount>0&&l.type==2)l.type=3}l=this.createNotify(l);if(l!==false)o.push(l)}if(o.length==0){if(this.messenger.popupMessengerConnectionStatusState!="online"){o.push(BX.create("div",{attrs:{style:"padding-top: 231px; margin-bottom: 45px;"},props:{className:"bx-messenger-box-empty bx-notifier-content-empty",id:"bx-notifier-content-empty"},html:BX.message("IM_NOTIFY_ERROR")}));o.push(BX.create("a",{attrs:{href:"#notifyHistory",id:"bx-notifier-content-link-history"},props:{className:"bx-notifier-content-link-history bx-notifier-content-link-history-empty"},children:[BX.create("span",{props:{className:"bx-notifier-item-button bx-notifier-item-button-white"},html:BX.message("IM_NOTIFY_HISTORY_2")})]}));this.notifyLoad=false}else if(this.BXIM.settings.loadLastNotify&&!this.notifyLoad||this.unreadNotifyLoad){o.push(BX.create("div",{attrs:{style:"padding-top: 162px;"},props:{className:"bx-notifier-content-load",id:"bx-notifier-content-load"},children:[BX.create("div",{props:{className:"bx-notifier-content-load-block bx-notifier-item"},children:[BX.create("span",{props:{className:"bx-notifier-content-load-block-img"}}),BX.create("span",{props:{className:"bx-notifier-content-load-block-text"},html:BX.message("IM_NOTIFY_LOAD_NOTIFY")+"..."})]})]}))}else if(!t&&!this.BXIM.settings.loadLastNotify){o.push(BX.create("div",{attrs:{style:"padding-top: 231px; margin-bottom: 45px;"},props:{className:"bx-messenger-box-empty bx-notifier-content-empty",id:"bx-notifier-content-empty"},html:BX.message("IM_NOTIFY_EMPTY_2")}));o.push(BX.create("a",{attrs:{href:"#notifyHistory",id:"bx-notifier-content-link-history"},props:{className:"bx-notifier-content-link-history bx-notifier-content-link-history-empty"},children:[BX.create("span",{props:{className:"bx-notifier-item-button bx-notifier-item-button-white"},html:BX.message("IM_NOTIFY_HISTORY")})]}))}else if(!t){o.push(BX.create("div",{attrs:{style:"padding-top: 231px; margin-bottom: 45px;"},props:{className:"bx-messenger-box-empty bx-notifier-content-empty",id:"bx-notifier-content-empty"},html:BX.message("IM_NOTIFY_EMPTY_3")}));o.push(BX.create("a",{attrs:{href:"#notifyHistory",id:"bx-notifier-content-link-history"},props:{className:"bx-notifier-content-link-history bx-notifier-content-link-history-empty"},children:[BX.create("span",{props:{className:"bx-notifier-item-button bx-notifier-item-button-white"},html:BX.message("IM_NOTIFY_HISTORY_LATE")})]}))}if(this.BXIM.settings.loadLastNotify)return o}else if(!t){o.push(BX.create("a",{attrs:{href:"#notifyHistory",id:"bx-notifier-content-link-history"},props:{className:"bx-notifier-content-link-history bx-notifier-content-link-history-empty"},children:[BX.create("span",{props:{className:"bx-notifier-item-button bx-notifier-item-button-white"},html:BX.message("IM_NOTIFY_HISTORY_LATE")})]}))}return o};BX.MessengerNotify.prototype.openNotify=function(e,t){e=e==true;t=t==true;if(this.messenger.popupMessenger==null){this.messenger.openMessenger(false)}if(BX.MessengerCommon.isPopupPage()&&!BX.MessengerSlider.isFocus()&&!this.BXIM.notifyOpen){BX.MessengerSlider.open().then(function(){this.openNotify(e,t);this.BXIM.desktop.adjustSize();setTimeout(function(){BX.MessengerSlider.getCurrent().closeLoader()},50)}.bind(this));return true}if(BX.MessengerCommon.isPage()){BX.MessengerWindow.changeTab("notify",true,true)}if(this.BXIM.notifyOpen&&!t){if(!e){this.messenger.extraClose(true);return false}}else{this.BXIM.dialogOpen=false;this.BXIM.notifyOpen=true;if(!BX.MessengerCommon.isPage()){this.messengerNotifyButton.className="bx-messenger-cl-notify-button bx-messenger-cl-notify-button-active"}}this.messenger.closeMenuPopup();var s=this.drawNotify();this.notifyBody=BX.create("div",{props:{className:"bx-notifier-wrap"},children:[BX.create("div",{props:{className:"bx-messenger-panel"},children:[BX.create("span",{props:{className:"bx-messenger-panel-avatar bx-messenger-avatar-notify"}}),BX.create("span",{props:{className:"bx-messenger-panel-title bx-messenger-panel-title-middle"},html:BX.message("IM_NOTIFY_WINDOW_TITLE")})]}),this.popupNotifyButtonFilterBox=BX.create("div",{props:{className:"bx-messenger-panel-filter-box"},style:{display:"none"},children:[BX.create("div",{props:{className:"bx-messenger-filter-name"},html:BX.message("IM_PANEL_FILTER_NAME")}),this.popupHistorySearchDateWrap=BX.create("div",{props:{className:"bx-messenger-filter-date bx-messenger-input-wrap bx-messenger-filter-date-notify"},html:'<span class="bx-messenger-input-date"></span><a class="bx-messenger-input-close" href="#close"></a><input type="text" class="bx-messenger-input" value="" tabindex="1002" placeholder="'+BX.message("IM_PANEL_FILTER_DATE")+'" />'})]}),this.popupNotifyItem=BX.create("div",{props:{className:"bx-notifier-item-wrap"},style:{height:this.popupNotifySize+"px"},children:s})]});this.messenger.extraOpen(this.notifyBody);if(this.unreadNotifyLoad)this.loadNotify();else if(!this.notifyLoad&&this.BXIM.settings.loadLastNotify)this.notifyHistory();if(!e&&this.BXIM.isFocus("notify")&&this.notifyUpdateCount>0)this.viewNotifyAll();BX.bind(this.popupNotifyItem,"scroll",BX.delegate(function(){if(this.messenger.popupPopupMenu!=null){if(BX.util.in_array(this.messenger.popupPopupMenu.uniquePopupId.replace("bx-messenger-popup-",""),["copypaste","copylink","notifyDelete","notify","external-data"])){this.messenger.popupPopupMenu.close()}}},this));BX.bind(BX("bx-notifier-content-link-history"),"click",BX.delegate(this.notifyHistory,this));BX.bind(this.popupNotifyItem,"click",BX.delegate(this.closePopup,this));BX.bind(this.notifyBody,"click",BX.delegate(function(e){BX.MessengerCommon.contactListSearchClear(e)},BX.MessengerCommon));BX.bindDelegate(this.popupNotifyItem,"click",{className:"bx-messenger-ajax"},BX.delegate(function(){if(BX.proxy_context.getAttribute("data-entity")=="user"){this.messenger.openPopupExternalData(BX.proxy_context,"user",true,{ID:BX.proxy_context.getAttribute("data-userId")})}else if(BX.proxy_context.getAttribute("data-entity")=="chat"){this.messenger.openPopupExternalData(BX.proxy_context,"chat",true,{ID:BX.proxy_context.getAttribute("data-chatId")})}else if(BX.proxy_context.getAttribute("data-entity")=="openlines"){this.messenger.linesOpenHistory(BX.proxy_context.getAttribute("data-sessionId"))}else if(BX.proxy_context.getAttribute("data-entity")=="network"){this.messenger.openMessenger("network"+BX.proxy_context.getAttribute("data-networkId"))}else if(BX.proxy_context.getAttribute("data-entity")=="date"){this.messenger.openPopupMenu(BX.proxy_context,"shareMenu")}},this));BX.bindDelegate(this.popupNotifyItem,"click",{className:"bx-notifier-item-help"},BX.proxy(function(e){if(this.popupNotifyMore!=null)this.popupNotifyMore.destroy();else{var t=this.notify[BX.proxy_context.getAttribute("data-help")];if(!t.otherItems)return false;var s='<span class="bx-notifier-item-help-popup">';for(var i=0;i<t.otherItems.length;i++){var a=BX.MessengerCommon.isBlankAvatar(this.notify[t.otherItems[i]].userAvatar)?'style="background-color: '+this.notify[t.otherItems[i]].userColor+'"':"";var n=BX.MessengerCommon.getUserParam(this.notify[t.otherItems[i]].userId);s+='<a class="bx-notifier-item-help-popup-img" href="'+this.notify[t.otherItems[i]].userLink+'"  onclick="BXIM.openMessenger('+this.notify[t.otherItems[i]].userId+'); return false;" target="_blank">'+'<span class="bx-notifier-popup-avatar bx-notifier-popup-avatar-status-'+n.status+'">'+'<img class="bx-notifier-popup-avatar-img'+(BX.MessengerCommon.isBlankAvatar(this.notify[t.otherItems[i]].userAvatar)?" bx-notifier-popup-avatar-img-default":"")+'" src="'+this.notify[t.otherItems[i]].userAvatar+'" '+a+">"+"</span>"+'<span class="bx-notifier-item-help-popup-name '+(n.extranet?" bx-notifier-popup-avatar-extranet":"")+'">'+BX.MessengerCommon.prepareText(this.notify[t.otherItems[i]].userName)+"</span>"+"</a>"}s+="</span>";this.popupNotifyMore=new BX.PopupWindow("bx-notifier-other-window",BX.proxy_context,{darkMode:this.BXIM.settings.enableDarkTheme,zIndex:BX.MessengerCommon.getDefaultZIndex()+200,lightShadow:true,offsetTop:-2,offsetLeft:3,autoHide:true,closeByEsc:true,bindOptions:{position:"top"},events:{onPopupClose:function(){this.destroy()},onPopupDestroy:BX.proxy(function(){this.popupNotifyMore=null},this)},content:BX.create("div",{props:{className:"bx-messenger-popup-menu"},html:s})});if(!this.BXIM.settings.enableDarkTheme)this.popupNotifyMore.setAngle({});BX.addClass(this.popupNotifyMore.popupContainer,"bx-messenger-mark");this.popupNotifyMore.show();BX.bind(this.popupNotifyMore.popupContainer,"click",BX.MessengerCommon.preventDefault)}return BX.PreventDefault(e)},this));BX.bindDelegate(this.popupNotifyItem,"click",{className:"bx-notifier-answer-reply"},BX.proxy(function(e){if(!BX.proxy_context)return;if(!this.toggleNotifyAnswer(BX.proxy_context.parentNode))return true;return BX.PreventDefault(e)},this));var i=BX.findChildByClassName(this.popupNotifyItem,"bx-notifier-answer-box-open");if(i){var a=i.firstChild.nextSibling.firstChild;a.focus();a.selectionStart=a.value.length+1;a.selectionEnd=a.value.length+1}BX.bindDelegate(this.popupNotifyItem,"click",{className:"bx-notifier-answer-button"},BX.proxy(function(e){if(!BX.proxy_context)return;this.sendNotifyAnswer(BX.proxy_context.parentNode);return BX.PreventDefault(e)},this));BX.bindDelegate(this.popupNotifyItem,"click",{className:"bx-notifier-item-delete"},BX.proxy(function(e){if(!BX.proxy_context)return;BX.proxy_context.setAttribute("id","bx-notifier-item-delete-"+BX.proxy_context.getAttribute("data-notifyId"));this.deleteNotify(BX.proxy_context.getAttribute("data-notifyId"));return BX.PreventDefault(e)},this));BX.bindDelegate(this.popupNotifyItem,"click",{className:"bx-notifier-item-button-confirm"},BX.proxy(function(e){if(this.messenger.popupMessengerConnectionStatusState!="online")return false;var t=BX.proxy_context.getAttribute("data-id");this.confirmRequest({notifyId:t,notifyValue:BX.proxy_context.getAttribute("data-value"),notifyURL:BX.proxy_context.getAttribute("data-url"),notifyTag:this.notify[t]&&this.notify[t].tag?this.notify[t].tag:null,groupDelete:BX.proxy_context.getAttribute("data-group")!=null});this.openNotify(true);if(BX.MessengerCommon.isMobile()){if(BX.proxy_context.parentNode.parentNode.parentNode.previousSibling==null&&BX.proxy_context.parentNode.parentNode.parentNode.nextSibling==null)this.openNotify(true);else if(BX.proxy_context.parentNode.parentNode.parentNode.previousSibling==null&&BX.proxy_context.parentNode.parentNode.parentNode.nextSibling.tagName.toUpperCase()=="A")this.openNotify(true);else BX.remove(BX.proxy_context.parentNode.parentNode.parentNode)}return BX.PreventDefault(e)},this));if(BX.MessengerCommon.isDesktop()){BX.bindDelegate(this.popupNotifyItem,"contextmenu",{className:"bx-notifier-item-content"},BX.delegate(function(e){if(!BX.proxy_context)return;BX.proxy_context.parentNode.setAttribute("id","bx-notifier-item-delete-"+BX.proxy_context.parentNode.getAttribute("data-notifyId"));this.messenger.openPopupMenu(e,"notify",false);return BX.PreventDefault(e)},this))}else{BX.bindDelegate(this.popupNotifyItem,"contextmenu",{className:"bx-notifier-item-delete"},BX.proxy(function(e){if(!BX.proxy_context)return;BX.proxy_context.setAttribute("id","bx-notifier-item-delete-"+BX.proxy_context.getAttribute("data-notifyId"));this.messenger.openPopupMenu(BX.proxy_context,"notifyDelete");return BX.PreventDefault(e)},this))}BX.bindDelegate(this.popupNotifyItem,"dblclick",{className:"bx-notifier-item"},BX.delegate(function(e){if(!BX.proxy_context)return;var t=BX.proxy_context.getAttribute("data-notifyId");if(this.unreadNotify[t]){this.viewNotify(t,true)}else{this.viewNotify(t,false)}return BX.PreventDefault(e)},this));if(false&&!this.BXIM.settings.notifyAutoRead){BX.bindDelegate(this.popupNotifyItem,"click",{className:"bx-notifier-item-text-link"},BX.delegate(function(e){var t=BX.proxy_context.parentNode.parentNode.parentNode.getAttribute("data-notifyId");if(this.unreadNotify[t]){this.viewNotify(t,true)}},this))}return false};BX.MessengerNotify.prototype.deleteNotify=function(e){var t=BX("bx-notifier-item-delete-"+e);var s=false;if(this.notify[e]){s=true;var i=null;if(this.notify[e].tag){i=this.notify[e].tag}if(this.notify[e].type==1){s=false}var a=!(!t||t.getAttribute("data-group")==null||i==null);if(a){for(var n in this.notify){if(this.notify[n].tag==i)delete this.notify[n]}}else{delete this.notify[e]}}this.updateNotifyCount();if(s){this.skipMassDelete=true;var o={};if(a)o={IM_NOTIFY_GROUP_REMOVE:"Y",NOTIFY_ID:e,IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()};else o={IM_NOTIFY_REMOVE:"Y",NOTIFY_ID:e,IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()};BX.ajax({url:this.BXIM.pathToAjax+"?NOTIFY_REMOVE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:o,onsuccess:BX.delegate(function(e){setTimeout(BX.delegate(function(){this.skipMassDelete=false},this),2e3)},this)});if(a)BX.localStorage.set("nrgn",i,5);else BX.localStorage.set("nrn",e,5)}if(t.parentNode.parentNode.previousSibling==null&&t.parentNode.parentNode.nextSibling==null){this.openNotify(true)}else if(t.parentNode.parentNode.previousSibling==null&&t.parentNode.parentNode.nextSibling.tagName.toUpperCase()=="A"){this.notifyLoad=false;this.notifyHistoryPage=0;this.openNotify(true)}else{BX.remove(t.parentNode.parentNode)}return true};BX.MessengerNotify.prototype.blockNotifyType=function(e){var t=typeof this.BXIM.settingsNotifyBlocked[e]=="undefined";BX.ajax({url:this.BXIM.pathToAjax+"?NOTIFY_BLOCK_TYPE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_NOTIFY_BLOCK_TYPE:"Y",BLOCK_TYPE:e,BLOCK_RESULT:t?"Y":"N",IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()}});if(t){this.BXIM.settingsNotifyBlocked[e]=true;this.BXIM.settings["site|".settingName]=false;this.BXIM.settings["xmpp|".settingName]=false;this.BXIM.settings["email|".settingName]=false}else{delete this.BXIM.settingsNotifyBlocked[e];this.BXIM.settings["site|".settingName]=true;this.BXIM.settings["xmpp|".settingName]=true;this.BXIM.settings["email|".settingName]=true}return true};BX.MessengerNotify.prototype.closeNotify=function(){if(!BX.MessengerCommon.isPage()){this.messengerNotifyButton.className="bx-messenger-cl-notify-button"}this.BXIM.notifyOpen=false;this.popupNotifyItem=null;BX.unbindAll(this.popupNotifyButtonFilter);BX.unbindAll(this.popupNotifyItem)};BX.MessengerNotify.prototype.loadNotify=function(e){if(this.loadNotityBlock)return false;e=e!=false;this.loadNotityBlock=true;BX.ajax({url:this.BXIM.pathToAjax+"?NOTIFY_LOAD&V="+this.BXIM.revision,method:"POST",dataType:"json",lsId:"IM_NOTIFY_LOAD",lsTimeout:5,timeout:30,data:{IM_NOTIFY_LOAD:"Y",IM_AUTO_READ:this.BXIM.settings.notifyAutoRead?"Y":"N",IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()},onsuccess:BX.delegate(function(t){this.loadNotityBlock=false;this.unreadNotifyLoad=false;this.notifyLoad=true;var s={};if(typeof t.NOTIFY=="object"){for(var i in t.NOTIFY){t.NOTIFY[i].date=new Date(t.NOTIFY[i].date);s[i]=this.notify[i]=t.NOTIFY[i];this.BXIM.lastRecordId=parseInt(i)>this.BXIM.lastRecordId?parseInt(i):this.BXIM.lastRecordId;if(this.BXIM.settings.notifyAutoRead){if(t.NOTIFY[i].type!="1"){delete this.unreadNotify[i]}else{this.unreadNotify[i]=i}}else{this.unreadNotify[i]=i}}}if(e){this.openNotify(true);if(this.BXIM.settings.loadLastNotify)this.notifyHistory();BX.localStorage.set("nln",true,5)}this.updateNotifyCount()},this),onfailure:BX.delegate(function(){this.loadNotityBlock=false},this)})};BX.MessengerNotify.prototype.notifyHistory=function(e){e=e||window.event;if(this.notifyHistoryLoad)return false;if(this.messenger&&this.messenger.popupMessengerConnectionStatusState!="online")return false;if(BX("bx-notifier-content-link-history")){BX("bx-notifier-content-link-history").innerHTML='<span class="bx-notifier-item-button bx-notifier-item-button-white">'+BX.message("IM_NOTIFY_LOAD_NOTIFY")+"..."+"</span>"}this.notifyHistoryLoad=true;BX.ajax({url:this.BXIM.pathToAjax+"?NOTIFY_HISTORY_LOAD_MORE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_NOTIFY_HISTORY_LOAD_MORE:"Y",PAGE:!this.BXIM.settings.loadLastNotify&&this.notifyHistoryPage==0?1:this.notifyHistoryPage,IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()},onsuccess:BX.delegate(function(e){if(e&&e.BITRIX_SESSID){BX.message({bitrix_sessid:e.BITRIX_SESSID})}if(e.ERROR==""){this.notifyLoad=true;BX.remove(BX("bx-notifier-content-load"));this.sendAjaxTry=0;var t={};var s=0;if(typeof e.NOTIFY=="object"){for(var i in e.NOTIFY){e.NOTIFY[i].date=new Date(e.NOTIFY[i].date);if(!this.notify[i])t[i]=e.NOTIFY[i];if(!this.notify[i]){this.notify[i]=BX.clone(e.NOTIFY[i])}s++}}if(this.popupNotifyItem){if(BX("bx-notifier-content-link-history"))BX.remove(BX("bx-notifier-content-link-history"));if(s>0){if(BX("bx-notifier-content-empty"))BX.remove(BX("bx-notifier-content-empty"));var t=this.drawNotify(t,true);for(var i=0;i<t.length;i++){this.popupNotifyItem.appendChild(t[i])}if(s<20&&this.notifyHistoryPage>0){BX.remove(BX("bx-notifier-content-link-history"))}else{this.popupNotifyItem.appendChild(BX.create("a",{attrs:{href:"#notifyHistory",id:"bx-notifier-content-link-history"},events:{click:BX.delegate(this.notifyHistory,this)},props:{className:"bx-notifier-content-link-history"},children:[BX.create("span",{props:{className:"bx-notifier-item-button bx-notifier-item-button-white"},html:BX.message("IM_NOTIFY_HISTORY_LATE")})]}));if(s>=20&&this.notifyHistoryPage==0)this.notifyHistoryPage=1}}else if(s<=0&&this.notifyHistoryPage==0){if(BX("bx-notifier-content-link-history"))BX.remove(BX("bx-notifier-content-link-history"));this.popupNotifyItem.innerHTML="";this.popupNotifyItem.appendChild(BX.create("div",{attrs:{style:"padding-top: 210px; margin-bottom: 20px;"},props:{className:"bx-messenger-box-empty bx-notifier-content-empty",id:"bx-notifier-content-empty"},html:BX.message("IM_NOTIFY_EMPTY_3")}));this.popupNotifyItem.appendChild(BX.create("a",{attrs:{href:"#notifyHistory",id:"bx-notifier-content-link-history"},events:{click:BX.delegate(this.notifyHistory,this)},props:{className:"bx-notifier-content-link-history bx-notifier-content-link-history-empty"},children:[BX.create("span",{props:{className:"bx-notifier-item-button bx-notifier-item-button-white"},html:BX.message("IM_NOTIFY_HISTORY_LATE")})]}))}else{if(this.popupNotifyItem.innerHTML==""){this.popupNotifyItem.appendChild(BX.create("div",{attrs:{style:"padding-top: 210px; margin-bottom: 20px;"},props:{className:"bx-messenger-box-empty bx-notifier-content-empty",id:"bx-notifier-content-empty"},html:BX.message("IM_NOTIFY_EMPTY_3")}))}}}this.notifyHistoryLoad=false;this.notifyHistoryPage++}else{if(e.ERROR=="SESSION_ERROR"&&this.sendAjaxTry<2){this.sendAjaxTry++;BX.message({bitrix_sessid:e.BITRIX_SESSID});setTimeout(BX.delegate(function(){this.notifyHistoryLoad=false;this.notifyHistory()},this),2e3);BX.onCustomEvent(window,"onImError",[e.ERROR,e.BITRIX_SESSID])}else if(e.ERROR=="AUTHORIZE_ERROR"){this.sendAjaxTry++;if(BX.MessengerCommon.isDesktop()){setTimeout(BX.delegate(function(){this.notifyHistoryLoad=false;this.notifyHistory()},this),1e4)}BX.onCustomEvent(window,"onImError",[e.ERROR])}}},this),onfailure:BX.delegate(function(){this.notifyHistoryLoad=false;this.sendAjaxTry=0},this)});if(e)return BX.PreventDefault(e);else return true};BX.MessengerNotify.prototype.adjustPosition=function(e){if(BX.MessengerCommon.isDesktop())return false;e=e||{};e.timeout=typeof e.timeout=="number"?parseInt(e.timeout):0;clearTimeout(this.adjustPositionTimeout);this.adjustPositionTimeout=setTimeout(BX.delegate(function(){e.scroll=e.scroll||!BX.browser.IsDoctype();e.resize=e.resize||false;if(!this.windowScrollPos.scrollLeft)this.windowScrollPos={scrollLeft:0,scrollTop:0};if(e.scroll)this.windowScrollPos=BX.GetWindowScrollPos();if(e.resize||!this.windowInnerSize.innerWidth){this.windowInnerSize=BX.GetWindowInnerSize();if(this.BXIM.settings.panelPositionVertical=="bottom"&&typeof window.scroll=="function"&&!(BX.browser.IsAndroid()||BX.browser.IsIOS())){if(typeof window.scrollX!="undefined"&&typeof window.scrollY!="undefined"){var t=window.scrollX;window.scroll(1,window.scrollY);this.windowInnerSize.innerHeight+=window.scrollX==1?-16:0;window.scroll(t,window.scrollY)}else{var s=document.documentElement.scrollLeft?document.documentElement.scrollLeft:document.body.scrollLeft;var i=document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop;var t=s;window.scroll(1,i);s=document.documentElement.scrollLeft?document.documentElement.scrollLeft:document.body.scrollLeft;this.windowInnerSize.innerHeight+=s==1?-16:0;window.scroll(t,i)}}}if(e.scroll||e.resize){if(this.BXIM.settings.panelPositionHorizontal=="left")this.panel.style.left=this.windowScrollPos.scrollLeft+25+"px";else if(this.BXIM.settings.panelPositionHorizontal=="center")this.panel.style.left=(this.windowScrollPos.scrollLeft+this.windowInnerSize.innerWidth-this.panel.offsetWidth)/2+"px";else if(this.BXIM.settings.panelPositionHorizontal=="right")this.panel.style.left=this.windowScrollPos.scrollLeft+this.windowInnerSize.innerWidth-this.panel.offsetWidth-35+"px";if(this.BXIM.settings.panelPositionVertical=="top"){this.panel.style.top=this.windowScrollPos.scrollTop+"px";if(BX.hasClass(this.panel,"bx-notifier-panel-doc"))this.panel.className="bx-notifier-panel bx-notifier-panel-top bx-notifier-panel-doc";else this.panel.className="bx-notifier-panel bx-notifier-panel-top"}else if(this.BXIM.settings.panelPositionVertical=="bottom"){if(BX.hasClass(this.panel,"bx-notifier-panel-doc"))this.panel.className="bx-notifier-panel bx-notifier-panel-bottom bx-notifier-panel-doc";else this.panel.className="bx-notifier-panel bx-notifier-panel-bottom";this.panel.style.top=this.windowScrollPos.scrollTop+this.windowInnerSize.innerHeight-this.panel.offsetHeight+"px"}}},this),e.timeout)};BX.MessengerNotify.prototype.move=function(e,t){var s=parseInt(this.panel.style.left)+e;var i=parseInt(this.panel.style.top)+t;if(s<0)s=0;var a=BX.GetWindowScrollSize();var n=this.panel.offsetWidth;var o=this.panel.offsetHeight;if(s>a.scrollWidth-n)s=a.scrollWidth-n;if(i>a.scrollHeight-o)i=a.scrollHeight-o;if(i<0)i=0;this.panel.style.left=s+"px";this.panel.style.top=i+"px"};BX.MessengerNotify.prototype._startDrag=function(e){e=e||window.event;BX.fixEventPageXY(e);this.dragPageX=e.pageX;this.dragPageY=e.pageY;this.dragged=false;this.closePopup();BX.bind(document,"mousemove",BX.proxy(this._moveDrag,this));BX.bind(document,"mouseup",BX.proxy(this._stopDrag,this));if(document.body.setCapture)document.body.setCapture();document.body.ondrag=BX.False;document.body.onselectstart=BX.False;document.body.style.cursor="move";document.body.style.MozUserSelect="none";this.panel.style.MozUserSelect="none";BX.addClass(this.panel,"bx-notifier-panel-drag-"+(this.BXIM.settings.panelPositionVertical=="top"?"top":"bottom"));return BX.PreventDefault(e)};BX.MessengerNotify.prototype._moveDrag=function(e){e=e||window.event;BX.fixEventPageXY(e);if(this.dragPageX==e.pageX&&this.dragPageY==e.pageY)return;this.move(e.pageX-this.dragPageX,e.pageY-this.dragPageY);this.dragPageX=e.pageX;this.dragPageY=e.pageY;if(!this.dragged){BX.onCustomEvent(this,"onPopupDragStart");this.dragged=true}BX.onCustomEvent(this,"onPopupDrag")};BX.MessengerNotify.prototype._stopDrag=function(e){if(document.body.releaseCapture)document.body.releaseCapture();BX.unbind(document,"mousemove",BX.proxy(this._moveDrag,this));BX.unbind(document,"mouseup",BX.proxy(this._stopDrag,this));document.body.ondrag=null;document.body.onselectstart=null;document.body.style.cursor="";document.body.style.MozUserSelect="";this.panel.style.MozUserSelect="";BX.removeClass(this.panel,"bx-notifier-panel-drag-"+(this.BXIM.settings.panelPositionVertical=="top"?"top":"bottom"));BX.onCustomEvent(this,"onPopupDragEnd");var t=BX.GetWindowScrollPos();this.BXIM.settings.panelPositionVertical=this.windowInnerSize.innerHeight/2>(e.pageY-t.scrollTop||e.y)?"top":"bottom";if(this.windowInnerSize.innerWidth/3>(e.pageX-t.scrollLeft||e.x))this.BXIM.settings.panelPositionHorizontal="left";else if(this.windowInnerSize.innerWidth/3*2<(e.pageX-t.scrollLeft||e.x))this.BXIM.settings.panelPositionHorizontal="right";else this.BXIM.settings.panelPositionHorizontal="center";this.BXIM.saveSettings({panelPositionVertical:this.BXIM.settings.panelPositionVertical,panelPositionHorizontal:this.BXIM.settings.panelPositionHorizontal});BX.localStorage.set("npp",{v:this.BXIM.settings.panelPositionVertical,h:this.BXIM.settings.panelPositionHorizontal});this.adjustPosition({resize:true});this.dragged=false;return BX.PreventDefault(e)};BX.MessengerNotify.prototype.closePopup=function(){if(this.popupNotifyMore!=null)this.popupNotifyMore.destroy();if(this.messenger!=null&&this.messenger.popupPopupMenu!=null)this.messenger.popupPopupMenu.destroy()};BX.MessengerNotify.prototype.createNotify=function(e,t){var s=false;if(!e)return false;t=t==true;e.text=e.text.replace(/\[like\]/gi,'<span class="bx-smile bx-im-smile-like" title="'+BX.message("IM_MESSAGE_LIKE")+'"></span>');e.text=e.text.replace(/\[dislike\]/gi,'<span class="bx-smile bx-im-smile-dislike" title="'+BX.message("IM_MESSAGE_DISLIKE")+'"></span>');e.text=e.text.replace(/\[USER=([0-9]{1,})\](.*?)\[\/USER\]/gi,function(e,t,s){var i="";t=parseInt(t);if(t>0&&typeof BXIM!="undefined")i='<span class="bx-messenger-ajax '+(t==BXIM.userId?"bx-messenger-ajax-self":"")+'" data-entity="user" data-userId="'+t+'">'+s+"</span>";else i=s;return i});e.text=e.text.replace(/\[CHAT=(imol\|)?([0-9]{1,})\](.*?)\[\/CHAT\]/gi,function(e,t,s,i){var a="";s=parseInt(s);if(s>0){if(t){a='<span class="bx-messenger-ajax" data-entity="openlines" data-sessionId="'+s+'">'+i+"</span>"}else{a='<span class="bx-messenger-ajax" data-entity="chat" data-chatId="'+s+'">'+i+"</span>"}}else{a=i}return a});e.text=e.text.replace(/\[RATING\=([1-5]{1})\]/gi,BX.delegate(function(e,t){return BX.MessengerCommon.linesVoteHeadNodes(0,t,false).outerHTML},this));if(BX.MessengerCommon.isDesktop()||this.BXIM.context=="FULLSCREEN"||this.BXIM.context=="PAGE"){e.text=e.text.replace(/<a(.*?)>(.*?)<\/a>/gi,BX.delegate(function(e,t,s){return"<a"+t.replace('target="_self"','target="_blank"')+' class="bx-notifier-item-text-link">'+s+"</a>"},this))}else if(t&&typeof BX.SidePanel!=="undefined"){e.text=e.text.replace(/<a(.*?)>(.*?)<\/a>/gi,BX.delegate(function(e,t,s){return"<a "+t+' class="bx-notifier-item-text-link" data-slider-ignore-autobinding="true">'+s+"</a>"},this))}var i=this.unreadNotify[e.id]&&!t?" bx-notifier-item-new":"";e.userAvatar=e.userAvatar?e.userAvatar:this.BXIM.pathToBlankImage;var a=e.params&&e.params.ATTACH?BX.MessengerCommon.drawAttach(0,0,e.params.ATTACH):[];if(a.length>0){a=BX.create("div",{props:{className:"bx-messenger-attach-box"},children:a})}else{a=null}if(e.type==1&&typeof e.buttons!="undefined"&&e.buttons.length>0){var n=[];var o=false;if(typeof e.confirmMessages!="undefined"){o=true;for(var r=0;r<e.confirmMessages.length;r++){n.push(BX.create("div",{props:{className:"bx-notifier-item-confirm-message"},html:e.confirmMessages[r]}))}}else{for(var r=0;r<e.buttons.length;r++){var l=e.buttons[r].TYPE=="accept"?"accept":e.buttons[r].TYPE=="cancel"?"cancel":"default";var p={"data-id":e.id,"data-value":e.buttons[r].VALUE};if(e.grouped)p["data-group"]="Y";if(e.buttons[r].URL)p["data-url"]=e.buttons[r].URL;n.push(BX.create("span",{props:{className:"bx-notifier-item-button bx-notifier-item-button-confirm bx-notifier-item-button-"+l},attrs:p,html:e.buttons[r].TITLE}))}}s=BX.create("div",{attrs:{"data-notifyId":e.id,"data-notifyType":e.type,"data-link":e.link},props:{className:"bx-notifier-item bx-notifier-item-"+e.id+" "+i},children:[BX.create("span",{props:{className:"bx-notifier-item-content"},children:[BX.create("span",{props:{className:"bx-notifier-item-avatar"},children:[BX.create("img",{props:{className:"bx-notifier-item-avatar-img"+(BX.MessengerCommon.isBlankAvatar(e.userAvatar)?" bx-notifier-item-avatar-img-default":"")},attrs:{src:e.userAvatar,style:BX.MessengerCommon.isBlankAvatar(e.userAvatar)?"background-color: "+e.userColor:""}})]}),!o?BX.create("span",{props:{className:"bx-notifier-item-delete bx-notifier-item-delete-fake"}}):BX.create("a",{attrs:{href:"#","data-notifyId":e.id,"data-notifyType":e.type,title:BX.message("IM_NOTIFY_DELETE_1")},props:{className:"bx-notifier-item-delete"}}),BX.create("span",{props:{className:"bx-notifier-item-date"},html:BX.MessengerCommon.formatDate(e.date)}),e.userName?BX.create("span",{props:{className:"bx-notifier-item-name"},html:'<a href="'+e.userLink+'"  data-slider-ignore-autobinding="true" onclick="if (BXIM.init) { BXIM.openMessenger('+e.userId+'); return false; } ">'+BX.MessengerCommon.prepareText(e.userName)+"</a>"}):null,BX.create("span",{props:{className:"bx-notifier-item-text"},html:e.text}),a,BX.create("span",{props:{className:"bx-notifier-item-button-wrap"},children:n})]})]})}else if(e.type==2||e.type==1&&typeof e.buttons!="undefined"&&e.buttons.length<=0){s=BX.create("div",{attrs:{"data-notifyId":e.id,"data-notifyType":e.type,"data-link":e.link},props:{className:"bx-notifier-item bx-notifier-item-"+e.id+" "+i},children:[BX.create("span",{props:{className:"bx-notifier-item-content"},children:[BX.create("span",{props:{className:"bx-notifier-item-avatar"},children:[BX.create("img",{props:{className:"bx-notifier-item-avatar-img"+(BX.MessengerCommon.isBlankAvatar(e.userAvatar)?" bx-notifier-item-avatar-img-default":"")},attrs:{src:e.userAvatar,style:BX.MessengerCommon.isBlankAvatar(e.userAvatar)?"background-color: "+e.userColor:""}})]}),BX.create("a",{attrs:{href:"#","data-notifyId":e.id,"data-notifyType":e.type,title:BX.message("IM_NOTIFY_DELETE_1")},props:{className:"bx-notifier-item-delete"}}),BX.create("span",{props:{className:"bx-notifier-item-date"},html:BX.MessengerCommon.formatDate(e.date)}),BX.create("span",{props:{className:"bx-notifier-item-name"},html:'<a href="'+e.userLink+'" data-slider-ignore-autobinding="true" onclick="if (BXIM.init) { BXIM.openMessenger('+e.userId+'); return false; } ">'+BX.MessengerCommon.prepareText(e.userName)+"</a>"}),BX.create("span",{props:{className:"bx-notifier-item-text"},html:e.text}),a,this.drawNotifyAnswer(e)]})]})}else if(e.type==3){s=BX.create("div",{attrs:{"data-notifyId":e.id,"data-notifyType":e.type,"data-link":e.link},props:{className:"bx-notifier-item bx-notifier-item-"+e.id+" "+i},children:[BX.create("span",{props:{className:"bx-notifier-item-content"},children:[BX.create("span",{props:{className:"bx-notifier-item-avatar-group"},children:[BX.create("span",{props:{className:"bx-notifier-item-avatar"},children:[BX.create("img",{props:{className:"bx-notifier-item-avatar-img"+(BX.MessengerCommon.isBlankAvatar(e.userAvatar)?" bx-notifier-item-avatar-img-default":"")},attrs:{src:e.userAvatar,style:BX.MessengerCommon.isBlankAvatar(e.userAvatar)?"background-color: "+e.userColor:""}})]})]}),BX.create("a",{attrs:{href:"#","data-notifyId":e.id,"data-group":"Y","data-notifyType":e.type,title:BX.message("IM_NOTIFY_DELETE_1")},props:{className:"bx-notifier-item-delete"}}),BX.create("span",{props:{className:"bx-notifier-item-date"},html:BX.MessengerCommon.formatDate(e.date)}),BX.create("span",{props:{className:"bx-notifier-item-name"},html:BX.message("IM_NOTIFY_GROUP_NOTIFY").replace("#USER_NAME#",'<a href="'+e.userLink+'"  data-slider-ignore-autobinding="true" onclick="if (BXIM.init) { BXIM.openMessenger('+e.userId+'); return false;} ">'+BX.MessengerCommon.prepareText(e.userName)+"</a>").replace("#U_START#",'<span class="bx-notifier-item-help" data-help="'+e.id+'">').replace("#U_END#","</span>").replace("#COUNT#",e.otherCount)}),BX.create("span",{props:{className:"bx-notifier-item-text"},html:e.text}),a,this.drawNotifyAnswer(e)]})]})}else{s=BX.create("div",{attrs:{"data-notifyId":e.id,"data-notifyType":e.type,"data-link":e.link},props:{className:"bx-notifier-item bx-notifier-item-"+e.id+" "+i},children:[BX.create("span",{props:{className:"bx-notifier-item-content"},children:[BX.create("span",{props:{className:"bx-notifier-item-avatar"},children:[BX.create("img",{props:{className:"bx-notifier-item-avatar-img bx-notifier-item-avatar-img-default-2"},attrs:{src:e.userAvatar}})]}),BX.create("a",{attrs:{href:"#","data-notifyId":e.id,"data-notifyType":e.type,title:BX.message("IM_NOTIFY_DELETE_1")},props:{className:"bx-notifier-item-delete"}}),BX.create("span",{props:{className:"bx-notifier-item-date"},html:BX.MessengerCommon.formatDate(e.date)}),e.title&&e.title.length>0?BX.create("span",{props:{className:"bx-notifier-item-name"},html:BX.MessengerCommon.prepareText(e.title)}):null,BX.create("span",{props:{className:"bx-notifier-item-text"},html:e.text}),a,this.drawNotifyAnswer(e)]})]})}return s};BX.MessengerNotify.prototype.drawNotifyAnswer=function(e){var t=null;if(typeof e.params=="object"&&e.params.CAN_ANSWER!="Y")return t;value=this.notifyAnswerText[e.id]?this.notifyAnswerText[e.id]:"";t=BX.create("div",{props:{className:"bx-notifier-item-text"},children:[BX.create("div",{props:{className:"bx-notifier-answer-link"},children:[BX.create("span",{props:{className:"bx-notifier-answer-reply bx-messenger-ajax"},html:BX.message("IM_N_REPLY")})]}),BX.create("div",{attrs:{"data-id":e.id},props:{className:"bx-notifier-answer-box"+(value?" bx-notifier-answer-box-open":"")},children:[BX.create("span",{props:{className:"bx-notifier-answer-progress"}}),BX.create("span",{props:{className:"bx-notifier-answer-input"},children:[BX.create("input",{attrs:{type:"text",value:value,"data-id":e.id},events:{keydown:BX.delegate(function(e){if(e.keyCode==13){this.sendNotifyAnswer(BX.proxy_context.parentNode.parentNode)}else if(e.keyCode==27){if(BX.proxy_context.value!=""){BX.proxy_context.value="";this.notifyAnswerText[BX.proxy_context.getAttribute("data-id")]=""}else{this.toggleNotifyAnswer(BX.proxy_context.parentNode.parentNode.previousSibling)}return BX.MessengerCommon.preventDefault(e)}},this),keyup:BX.delegate(function(e){this.notifyAnswerText[BX.proxy_context.getAttribute("data-id")]=BX.proxy_context.value},this)},props:{className:"bx-messenger-input"}})]}),BX.create("a",{attrs:{href:"javascript:void(0);"},props:{className:"bx-notifier-answer-button"}})]}),BX.create("div",{props:{className:"bx-notifier-answer-text"},html:BX.message("IM_N_REPLY_TEXT")})]});return t};BX.MessengerNotify.prototype.toggleNotifyAnswer=function(e){var t=e.nextSibling.getAttribute("data-id");if(this.notifyAnswerBlock[t])return false;BX.toggleClass(e.nextSibling,"bx-notifier-answer-box-open");BX.removeClass(e.nextSibling.nextSibling,"bx-notifier-answer-text-show");var s=BX.findChildByClassName(e.nextSibling,"bx-messenger-input");if(s){s.focus()}return true};BX.MessengerNotify.prototype.sendNotifyAnswer=function(e,t){var s=e.getAttribute("data-id");if(this.notifyAnswerBlock[s])return true;var i=BX.findChildByClassName(e,"bx-messenger-input");if(!i)return false;i.value=BX.util.trim(i.value);if(i.value==""){return true}if(!this.BXIM.init&&BX.MessengerCommon.isDesktop())BX.desktop.windowCommand("freeze");this.notifyAnswerBlock[s]=true;this.notifyAnswerText[s]=i.value;i.disabled=true;BX.addClass(e,"bx-notifier-answer-box-send");BX.ajax({url:this.BXIM.pathToAjax+"?NOTIFY_ANSWER&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_NOTIFY_ANSWER:"Y",NOTIFY_ID:s,NOTIFY_ANSWER:i.value,IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()},onsuccess:BX.delegate(function(t){BX.removeClass(e,"bx-notifier-answer-box-error");BX.removeClass(e,"bx-notifier-answer-box-send");this.notifyAnswerBlock[s]=false;this.notifyAnswerText[s]="";var i=BX.findChildByClassName(e,"bx-messenger-input");if(i){i.disabled=false}if(t.ERROR==""){BX.removeClass(e,"bx-notifier-answer-box-open");BX.addClass(e.nextSibling,"bx-notifier-answer-text-show");if(t.MESSAGES&&t.MESSAGES.length>0){e.nextSibling.innerHTML=t.MESSAGES.join("<br/>")}if(i){i.value=""}if(!this.BXIM.init&&BX.MessengerCommon.isDesktop())BX.desktop.windowCommand("close")}else{BX.addClass(e,"bx-notifier-answer-box-error")}},this),onfailure:BX.delegate(function(){BX.addClass(e,"bx-notifier-answer-box-error");BX.removeClass(e,"bx-notifier-answer-box-send");this.notifyAnswerBlock[s]=false;var t=BX.findChildByClassName(e,"bx-messenger-input");if(t){t.disabled=false}},this)});return true};BX.MessengerNotify.prototype.storageSet=function(e){if(e.key=="npp"){var t=BX.localStorage.get(e.key);this.BXIM.settings.panelPositionHorizontal=!!t?t.h:this.BXIM.settings.panelPositionHorizontal;this.BXIM.settings.panelPositionVertical=!!t?t.v:this.BXIM.settings.panelPositionVertical;this.adjustPosition({resize:true})}else if(e.key=="nun"){this.notify=e.value}else if(e.key=="nrn"){delete this.notify[e.value];this.updateNotifyCount(false)}else if(e.key=="nrgn"){for(var s in this.notify){if(this.notify[s].tag==e.value)delete this.notify[s]}this.updateNotifyCount()}else if(e.key=="numc"){this.updateNotifyMailCount(e.value,false)}else if(e.key=="nuc"){this.updateNotifyCounters(e.value,false)}else if(e.key=="nunc"){setTimeout(BX.delegate(function(){this.unreadNotify=e.value.unread;this.flashNotify=e.value.flash;this.updateNotifyCount(false)},this),500)}else if(e.key=="nln"){this.loadNotify(false)}}})();(function(){if(BX.MessengerChat)return;BX.MessengerChat=function(e,t){this.BXIM=e;this.BXIM.messenger=this;this.settings={};this.params=t||{};this.realSearchAvailable=!this.BXIM.userExtranet||!this.BXIM.bitrixIntranet&&!this.BXIM.bitrix24net;this.realSearch=!this.BXIM.options.contactListLoad;this.realSearchFound=true;this.updateStateCount=1;this.sendAjaxTry=0;this.updateStateVeryFastCount=0;this.updateStateFastCount=0;this.updateStateStepDefault=this.BXIM.ppServerStatus?parseInt(t.updateStateInterval):60;this.updateStateStep=this.updateStateStepDefault;this.updateStateTimeout=null;this.redrawContactListTimeout={};this.redrawRecentListTimeout=null;this.floatDateTimeout=null;this.readMessageTimeout={};this.readMessageTimeoutSend=null;this.sendFrameTokenCollection={};this.sendFrameTokenTimeout=500;this.webrtc=t.webrtcClass;this.notify=t.notifyClass;this.desktop=t.desktopClass;this.bot=t.bot;this.command=t.command;this.commandPopup=null;this.commandListen=false;this.commandList=[];this.commandSelect="";this.commandSelectIndex=1;this.textareaIcon=t.textareaIcon;this.smile=t.smile;this.smileSet=t.smileSet;this.smileCurrentSet=this.BXIM.getLocalConfig("smiles-current-set",0)||[];this.smileRecentId=1;this.getRecentSmiles();this.recentListIndex=[];if(t.recent){this.recent=t.recent;this.recentListLoad=true}else{this.recent=[];this.recentListLoad=false}this.recentListExternal=null;if(t.externalRecentList){this.recentListExternal=BX(t.externalRecentList)}this.popupTooltip=null;this.users=t.users;for(var s in this.users){this.users[s].absent=this.users[s].absent?new Date(this.users[s].absent):false;this.users[s].idle=this.users[s].idle?new Date(this.users[s].idle):false;this.users[s].last_activity_date=new Date(this.users[s].last_activity_date);this.users[s].mobile_last_date=new Date(this.users[s].mobile_last_date)}this.businessUsers=t.businessUsers;this.openlines=t.openlines;this.groups=t.groups;this.userInGroup=t.userInGroup;this.currentTab=0;this.generalChatId=t.generalChatId;this.canSendMessageGeneralChat=t.canSendMessageGeneralChat;this.redrawTab={};this.loadLastMessageTimeout={};this.loadLastMessageClassTimeout={};this.showMessage=t.showMessage;this.unreadMessage=t.unreadMessage;this.flashMessage=t.flashMessage;this.tooltipShowed=t.tooltipShowed||{};this.disk=t.diskClass;this.disk.messenger=this;this.popupMessengerFileForm=null;this.popupMessengerFileDropZone=null;this.popupMessengerFileButton=null;this.popupMessengerFileFormChatId=null;this.popupMessengerFileFormInput=null;this.openChatEnable=t.openChatEnable;this.chat=t.chat;for(var i in this.chat){this.chat[i].date_create=new Date(this.chat[i].date_create)}this.userChat=t.userChat;this.userInChat=t.userInChat;this.userChatBlockStatus=t.userChatBlockStatus;this.userChatOptions=t.userChatOptions;this.blockJoinChat={};this.hrphoto=t.hrphoto;this.chatPublicWatch=0;this.chatPublicWatchAdd=false;this.popupIframeBind=true;this.popupIframeMenu=null;this.popupMessengerLiveChatDelayedFormMid=0;this.popupMessengerLiveChatActionTimeout=null;this.popupMessengerLiveChatDelayedForm=null;this.popupMessengerLiveChatFormStage=null;this.phones={};this.errorMessage={};this.message=t.message;for(var a in this.message){this.message[a].date=new Date(this.message[a].date)}this.messageTmpIndex=0;this.history=t.history;this.textareaHistory={};this.textareaHistoryTimeout=null;this.messageCount=t.countMessage;this.sendMessageFlag=0;this.sendMessageTmp={};this.sendMessageTmpTimeout={};this.popupSettings=null;this.popupSettingsBody=null;this.popupChatDialog=null;this.popupChatDialogContactListElements=null;this.popupChatDialogContactListSearch=null;this.popupChatDialogContactListElementsType="";this.popupChatDialogContactListSearchLastText="";this.popupChatDialogDestElements=null;this.popupChatDialogUsers={};this.popupChatDialogSendBlock=false;this.renameChatDialogFlag=false;this.renameChatDialogInput=null;this.popupHistory=null;this.popupHistoryElements=null;this.popupHistoryItems=null;this.popupHistoryItemsSize=475;this.popupHistorySearchDateWrap=null;this.popupHistorySearchWrap=null;this.popupHistoryFilesSearchWrap=null;this.popupHistoryButtonDeleteAll=null;this.popupHistoryButtonFilter=null;this.popupHistoryButtonFilterBox=null;this.popupHistoryFilterVisible=true;this.popupHistoryBodyWrap=null;this.popupHistoryFilesItems=null;this.popupHistoryFilesBodyWrap=null;this.popupHistorySearchInput=null;this.historyUserId=0;this.historyChatId=0;this.historyDateSearch="";this.historySearch="";this.historyLastSearch={};this.historySearchBegin=false;this.historySearchTimeout=null;this.historyFilesSearch="";this.historyFilesLastSearch={};this.historyFilesSearchBegin=false;this.historyFilesSearchTimeout=null;this.historyWindowBlock=false;this.historyMessageSplit="------------------------------------------------------";this.historyOpenPage={};this.historyLoadFlag={};this.historyEndOfList={};this.historyFilesOpenPage={};this.historyFilesLoadFlag={};this.historyFilesEndOfList={};this.popupMessenger=null;this.popupMessengerWindow={};this.popupMessengerExtra=null;this.popupMessengerTopLine=null;this.popupMessengerDesktopTimeout=null;this.popupMessengerFullWidth=864;this.popupMessengerMinWidth=864;this.popupMessengerFullHeight=454;this.popupMessengerMinHeight=384;this.popupMessengerDialog=null;this.popupMessengerBody=null;this.popupMessengerBodyDialog=null;this.popupMessengerBodyAnimation=null;this.popupMessengerBodySize=316;this.popupMessengerBodySizeMin=246;this.popupMessengerBodyWrap=null;this.popupMessengerLikeBlock={};this.popupMessengerLikeBlockTimeout={};this.popupMessengerSendingTimeout={};this.popupMessengerConnectionStatusState="online";this.popupMessengerConnectionStatusStateText="";this.popupMessengerConnectionStatus=null;this.popupMessengerConnectionStatusText=null;this.popupMessengerConnectionStatusTimeout=null;this.popupMessengerEditForm=null;this.popupMessengerEditFormTimeout=null;this.popupMessengerEditTextarea=null;this.popupMessengerEditMessageId=0;this.popupMessengerPanel=null;this.popupMessengerPanelBotIcons=false;this.popupMessengerPanelAvatar=null;this.popupMessengerPanelButtonCall1=null;this.popupMessengerPanelButtonCall2=null;this.popupMessengerPanelButtonCall3=null;this.popupMessengerPanelTitle=null;this.popupMessengerPanelStatus=null;this.popupMessengerPanelChat=null;this.popupMessengerPanelCall=null;this.popupMessengerPanelChatTitle=null;this.popupMessengerPanelUsers=null;this.popupMessengerTextareaPlace=null;this.popupMessengerTextarea=null;this.popupMessengerTextareaSendType=null;this.popupMessengerTextareaResize={};this.popupMessengerTextareaSize=30;this.popupMessengerLastMessage=0;this.mentionList={};this.mentionListen=false;this.mentionDelimiter="";this.readedList={};this.linesWritingList={};this.linesWritingListTimeout={};this.writingList={};this.writingListTimeout={};this.writingSendList={};this.writingSendListTimeout={};this.contactListPanelStatus=null;this.contactListSearchText="";this.contactListSearchLastText="";this.popupPopupMenu=null;this.popupPopupMenuModifyFunction=[];this.popupPopupMenuDateCreate=0;this.popupSmileMenu=null;this.popupSmileMenuGallery=null;this.popupSmileMenuSet=null;this.chatList=false;this.recentList=true;this.contactList=false;this.contactListShowed={};this.openMessengerFlag=false;this.openChatFlag=false;this.openNetworkFlag=false;this.openBotFlag=false;this.openCallFlag=false;this.externalMenu=false;if(BX.MessengerCommon.isPage()){this.externalMenu=BX.MessengerWindow.withMenu;if(!this.externalMenu&&this.BXIM.settings.linesTabEnable&&BX.MessengerCommon.isLinesOperator()){this.externalMenu=true}}if(this.externalMenu){BX.addClass(BX.MessengerWindow.content,"bx-desktop-appearance-show-menu")}this.contactListLoad=!this.BXIM.options.contactListLoad;this.popupContactListSize=300;this.popupContactListSearchInput=null;this.popupContactListSearchClose=null;this.popupContactListWrap=null;this.popupContactListElements=null;this.popupContactListElementsSize=this.externalMenu?368:331;this.popupContactListElementsSizeMin=this.externalMenu?298:264;this.popupContactListElementsWrap=null;this.contactListPanelSettings=null;this.linesTransferUser=0;this.linesSilentMode={};this.linesLiveChatVote=false;this.enableGroupChat=this.BXIM.ppServerStatus?true:false;if(this.BXIM.init){if(BX.MessengerCommon.isPage()){BX.MessengerWindow.setUserInfo(BX.MessengerCommon.getUserParam());BX.MessengerWindow.addTab({id:"im",title:BX.message("IM_DESKTOP_OPEN_MESSENGER").replace("#COUNTER#",""),order:100,events:{open:BX.delegate(function(){if(BX.MessengerCommon.isPage()&&this.BXIM.context=="POPUP-FULLSCREEN"&&!this.popupMessenger){return false}if(!this.BXIM.dialogOpen){this.openMessenger(this.currentTab)}},this)}});if(this.webrtc.phoneSupport()&&this.webrtc.phoneCanPerformCalls){BX.MessengerWindow.addTab({id:"im-phone",title:BX.message("IM_PHONE_DESC"),order:120,target:"im",events:{open:BX.delegate(this.webrtc.openKeyPad,this.webrtc),close:BX.delegate(function(){if(this.webrtc.popupKeyPad)this.webrtc.popupKeyPad.close()},this)}})}if(this.BXIM.settings.linesTabEnable&&BX.MessengerCommon.isLinesOperator()){BX.MessengerWindow.addTab({id:"im-ol",title:BX.message("IM_CTL_CHAT_OL"),order:105,target:"im",events:{open:BX.delegate(function(){if(BX.MessengerCommon.isPage()&&this.BXIM.context=="POPUP-FULLSCREEN"&&!this.popupMessenger){return false}if(!this.BXIM.dialogOpen){this.openMessenger(this.currentTab)}BX.MessengerCommon.userListRedraw()},this),close:BX.delegate(function(){BX.MessengerCommon.userListRedraw()},this)}})}}BX.addCustomEvent("onPullError",BX.delegate(function(e,t){if(e=="AUTHORIZE_ERROR"){if(BX.MessengerCommon.isDesktop()){this.connectionStatus("connecting")}else{this.connectionStatus("offline")}}else if(e=="RECONNECT"&&(t==1008||t==1006)){this.connectionStatus("connecting")}},this));BX.addCustomEvent("OnDesktopTabChange",BX.delegate(function(){if(this.BXIM.messenger.chatList){BX.MessengerCommon.contactListSearchClear()}this.closeMenuPopup()},this));BX.addCustomEvent("OnMessengerWindowShowPopup",BX.delegate(function(e){this.openMessenger(e)},this));BX.addCustomEvent("OnMessengerWindowClosePopup",BX.delegate(function(){this.closeMessenger()},this));BX.addCustomEvent("onImError",BX.delegate(function(e,t){if(e=="AUTHORIZE_ERROR"||e=="SEND_ERROR"&&t=="AUTHORIZE_ERROR"){if(BX.MessengerCommon.isDesktop()){this.connectionStatus("connecting")}else{this.connectionStatus("offline")}}},this));BX.addCustomEvent("onPullStatus",BX.delegate(function(e){this.connectionStatus(e=="offline"?"offline":"online")},this));BX.bind(window,"online",BX.delegate(function(){this.connectionStatus("online")},this));BX.bind(window,"offline",BX.delegate(function(){this.connectionStatus("offline")},this));this.notify.panel.appendChild(this.BXIM.audio.newMessage1=BX.create("audio",{props:{className:"bx-messenger-audio"},children:[BX.create("source",{attrs:{src:"/bitrix/js/im/audio/new-message-1.ogg",type:"audio/ogg; codecs=vorbis"}}),BX.create("source",{attrs:{src:"/bitrix/js/im/audio/new-message-1.mp3",type:"audio/mpeg"}})]}));this.notify.panel.appendChild(this.BXIM.audio.newMessage2=BX.create("audio",{props:{className:"bx-messenger-audio"},children:[BX.create("source",{attrs:{src:"/bitrix/js/im/audio/new-message-2.ogg",type:"audio/ogg; codecs=vorbis"}}),BX.create("source",{attrs:{src:"/bitrix/js/im/audio/new-message-2.mp3",type:"audio/mpeg"}})]}));this.notify.panel.appendChild(this.BXIM.audio.send=BX.create("audio",{props:{className:"bx-messenger-audio"},children:[BX.create("source",{attrs:{src:"/bitrix/js/im/audio/send.ogg",type:"audio/ogg; codecs=vorbis"}}),BX.create("source",{attrs:{src:"/bitrix/js/im/audio/send.mp3",type:"audio/mpeg"}})]}));if(typeof this.BXIM.audio.send.play=="undefined"){this.BXIM.settings.enableSound=false}for(var n in this.unreadMessage){if(typeof this.flashMessage[n]=="undefined")this.flashMessage[n]={};for(var o=this.unreadMessage[n].length-1;o>=0;o--){BX.localStorage.set("mum",{userId:n,message:this.message[this.unreadMessage[n][o]]},5)}}BX.localStorage.set("muum",this.unreadMessage,5);if(this.notify.panelButtonMessage){BX.bind(this.notify.panelButtonMessage,"click",BX.delegate(function(e){this.BXIM.openMessenger(true)},this))}var r=this.BXIM.getLocalConfig("mcesh",null);if(r!==null){this.BXIM.options.chatExtendShowHistory=r}var l=this.BXIM.getLocalConfig("global_msz_v2",false);if(!l&&BX.MessengerCommon.isPage()){this.desktop.initHeight=BX.MessengerWindow.initHeight;if(BX.MessengerCommon.isDesktop()){if(!BX.browser.IsMac()&&!this.desktop.enableInVersion(37)){}this.tmpTextareaResize=BX.delegate(function(){var e=this.BXIM.getLocalConfig("global_tas",this.popupMessengerTextareaSize);this.setTextareaSize(e);BX.unbind(window,"resize",this.tmpTextareaResize)},this);BX.bind(window,"resize",this.tmpTextareaResize)}var p=this.BXIM.getLocalConfig("global_tas",this.BXIM.context=="POPUP-FULLSCREEN"?60:this.popupMessengerTextareaSize);this.setTextareaSize(p)}else if(l&&(!BX.MessengerCommon.isPage()||BX.MessengerCommon.isDesktop())){this.popupMessengerFullWidth=parseInt(l.wz);this.popupMessengerTextareaSize=parseInt(l.ta2);this.popupMessengerBodySize=parseInt(l.b)>0?parseInt(l.b):this.popupMessengerBodySize;this.popupHistoryItemsSize=parseInt(l.hi);this.popupMessengerFullHeight=parseInt(l.fz);this.popupContactListElementsSize=parseInt(l.ez);this.notify.popupNotifySize=parseInt(l.nz);this.popupHistoryFilterVisible=l.hf;if(BX.MessengerCommon.isDesktop()){BX.desktop.setWindowSize({Width:parseInt(l.dw),Height:parseInt(l.dh)});this.desktop.initHeight=parseInt(l.dh)}}else{if(BX.MessengerCommon.isDesktop()){BX.desktop.setWindowSize({Width:BX.MessengerWindow.initWidth,Height:BX.MessengerWindow.initHeight});this.desktop.initHeight=BX.MessengerWindow.initHeight}else if(BX.MessengerCommon.isPage()){this.desktop.initHeight=BX.MessengerWindow.initHeight}var p=this.BXIM.getLocalConfig("global_tas",this.BXIM.context=="POPUP-FULLSCREEN"?60:this.popupMessengerTextareaSize);this.setTextareaSize(p)}if(BX.MessengerCommon.isPage()){this.desktop.adjustSize();BX.MessengerCommon.redrawDateMarks();BX.bind(window,"resize",BX.delegate(function(){this.adjustSize();BX.MessengerCommon.redrawDateMarks()},this.desktop))}if(BX.browser.SupportLocalStorage()){BX.addCustomEvent(window,"onLocalStorageSet",BX.delegate(this.storageSet,this));this.textareaHistory=BX.localStorage.get("mtah")||{};this.mentionList=BX.localStorage.get("mtam")||{};this.currentTab=this.currentTab||BX.localStorage.get("mct");this.currentTab=this.currentTab?this.currentTab:0;this.messageTmpIndex=BX.localStorage.get("mti")||0;var h=BX.localStorage.get("mfm");if(h){for(var n in this.flashMessage)for(var c in this.flashMessage[n])if(h[n]&&this.flashMessage[n][c]!=h[n][c]&&h[n][c]==false)this.flashMessage[n][c]=false}BX.garbage(function(){BX.localStorage.set("mti",this.messageTmpIndex,15);BX.localStorage.set("mtah",this.textareaHistory,15);BX.localStorage.set("mtam",this.mentionList,15);BX.localStorage.set("mct",this.currentTab,15);BX.localStorage.set("mfm",this.flashMessage,15);BX.localStorage.set("mcls",this.contactListSearchText+"",15);if(BX.MessengerCommon.isDesktop()&&(window.innerWidth<BX.desktop.minWidth||window.innerHeight<BX.desktop.minHeight))return false;this.BXIM.setLocalConfig("global_msz_v2",{wz:this.popupMessengerFullWidth,ta2:this.popupMessengerTextareaSize,b:this.popupMessengerBodySize,cl:this.popupContactListSize,hi:this.popupHistoryItemsSize,fz:this.popupMessengerFullHeight,ez:this.popupContactListElementsSize,nz:this.notify.popupNotifySize,hf:this.popupHistoryFilterVisible,dw:window.innerWidth,dh:window.innerHeight,place:"garbage"})},this)}else{var u=this.BXIM.getLocalConfig("mtah",false);if(u){this.textareaHistory=u;this.BXIM.removeLocalConfig("mtah")}var d=this.BXIM.getLocalConfig("mtam",false);if(d){this.textareaHistory=d;this.BXIM.removeLocalConfig("mtam")}BX.garbage(function(){this.BXIM.setLocalConfig("mtah",this.textareaHistory);this.BXIM.setLocalConfig("mtam",this.mentionList);if(BX.MessengerCommon.isDesktop()&&(window.innerWidth<BX.desktop.minWidth||window.innerHeight<BX.desktop.minHeight))return false;this.BXIM.setLocalConfig("global_msz_v2",{wz:this.popupMessengerFullWidth,ta2:this.popupMessengerTextareaSize,b:this.popupMessengerBodySize,cl:this.popupContactListSize,hi:this.popupHistoryItemsSize,fz:this.popupMessengerFullHeight,ez:this.popupContactListElementsSize,nz:this.notify.popupNotifySize,hf:this.popupHistoryFilterVisible,dw:window.innerWidth,dh:window.innerHeight,place:"garbage"})},this)}BX.MessengerCommon.pullEvent();BX.addCustomEvent("onPullError",BX.delegate(function(e){if(e=="AUTHORIZE_ERROR")this.sendAjaxTry++},this));var n=0;var m=BX.Main.Date.format("d-m");for(var s in this.users){if(this.users[s].birthday==m&&s!=this.BXIM.userId){this.message[s+"birthday"]={id:s+"birthday",senderId:0,recipientId:s,date:BX.MessengerCommon.getNowDate(true),text:BX.message("IM_M_BIRTHDAY_MESSAGE").replace("#USER_NAME#",'<img src="/bitrix/js/im/images/blank.gif" class="bx-messenger-birthday-icon"><strong>'+this.users[s].name+"</strong>")};if(!this.showMessage[s])this.showMessage[s]=[];this.showMessage[s].push(s+"birthday");this.showMessage[s].sort(BX.delegate(function(e,t){if(!this.message[e]||!this.message[t]){return 0}var s=this.message[e].date.getTime();var i=this.message[t].date.getTime();if(s<i){return-1}else if(s>i){return 1}else{if(e<t){return-1}else if(e>t){return 1}else{return 0}}},this));var g=this.showMessage[s][this.showMessage[s].length-1];BX.MessengerCommon.recentListAdd({userId:s,userIsChat:false,id:this.message[g].id,date:this.message[g].date,recipientId:this.message[g].recipientId,senderId:this.message[g].senderId,text:g==s+"birthday"?BX.message("IM_M_BIRTHDAY_MESSAGE_SHORT").replace("#USER_NAME#",this.users[s].name):this.message[g].text,params:{}},true);this.recent.sort(BX.delegate(function(e,t){if(!this.message[e.id]||!this.message[t.id]){return 0}var s=this.message[e.id].date.getTime();var i=this.message[t.id].date.getTime();if(s>i){return-1}else if(s<i){return 1}else{if(e>t){return-1}else if(e<t){return 1}else{return 0}}},this));var f=this.BXIM.getLocalConfig("birthdayPopup"+(new Date).getFullYear(),{});if(this.desktop.birthdayStatus()&&!f[s]){this.message[s+"birthdayPopup"]={id:s+"birthdayPopup",senderId:0,recipientId:s,date:BX.MessengerCommon.getNowDate(true),text:BX.message("IM_M_BIRTHDAY_MESSAGE_SHORT").replace("#USER_NAME#",this.users[s].name)};if(BX.MessengerCommon.isDesktop()){if(!this.unreadMessage[s])this.unreadMessage[s]=[];this.unreadMessage[s].push(s+"birthdayPopup");if(!this.flashMessage[s])this.flashMessage[s]={};this.flashMessage[s][s+"birthdayPopup"]=true}f[s]=true;this.BXIM.removeLocalConfig("birthdayPopup"+((new Date).getFullYear()-1));this.BXIM.setLocalConfig("birthdayPopup"+(new Date).getFullYear(),f)}}n++}this.updateState();if(t.openMessenger!==false){this.openMessenger(t.openMessenger)}else if(this.openMessengerFlag){this.openMessenger(this.currentTab)}if(t.openHistory!==false){this.BXIM.openHistory(t.openHistory)}if(t.openNotify!==false)this.BXIM.openNotify();if(this.BXIM.settings.status!="dnd")this.newMessage();this.updateMessageCount();setInterval(BX.delegate(function(){BX.MessengerCommon.checkProgessMessage();this.expireFrameToken()},this),1e3);BX.bind(window,"message",BX.delegate(function(e){if(e&&e.origin==this.openFrameDialogFrameSourceDomain){this.openFrameDialogPostMessage(e.data)}},this))}else{if(t.openMessenger!==false)this.BXIM.openMessenger(t.openMessenger);if(t.openHistory!==false)this.BXIM.openHistory(t.openHistory)}};BX.MessengerChat.prototype.openMessengerSlider=function(e,t){t=t||{};requestParams={};requestParams.IFRAME="Y";requestParams.IM_DIALOG=e;requestParams.IM_RECENT=t.RECENT=="N"?"N":"Y";requestParams.IM_MENU=t.MENU=="N"?"N":"Y";var s={cacheable:false,allowChangeHistory:false,requestMethod:"post",requestParams:requestParams,loader:"/bitrix/js/im/images/im-loader-lines"+(this.BXIM.settings.enableDarkTheme?".dark":"")+".min.svg"};if(t.RECENT=="N"||t.MENU=="N"){s.width=800+(t.RECENT=="N"?0:50)+(t.MENU=="N"?0:20)}BX.SidePanel.Instance.open("/desktop_app/",s)};BX.MessengerChat.prototype.openMessenger=function(e,t){var s=new BX.Promise;if(this.BXIM.bitrix24blocked&&typeof BX.UI.InfoHelper!=="undefined"){BX.UI.InfoHelper.show(this.BXIM.bitrix24blocked);this.BXIM.closeMessenger();s.reject();return s}if(this.BXIM.errorMessage!=""){this.BXIM.closeMessenger();this.BXIM.openConfirm(this.BXIM.errorMessage,[new BX.PopupWindowButton({text:BX.message("IM_NOTIFY_CONFIRM_CLOSE"),className:"popup-window-button-decline",events:{click:BX.delegate(function(e){BX.proxy_context.popupWindow.close();if(BX.MessengerWindow){BX.MessengerWindow.closePopup()}BX.PreventDefault(e)},this)}})]);s.reject();return s}if(BX.MessengerCommon.isPopupPage()&&!BX.MessengerSlider.isFocus()){this.popupMessenger=null;BX.MessengerSlider.open().then(function(){this.openMessenger(e,t).then(function(){this.BXIM.desktop.adjustSize();setTimeout(function(){if(this.BXIM.messenger.currentTab){BX.MessengerCommon.openDialog(this.BXIM.messenger.currentTab)}BX.MessengerSlider.getCurrent().closeLoader()},50);s.resolve()}.bind(this))}.bind(this));return s}if(BX.SidePanel&&BX.SidePanel.Instance.isOpen()&&BX.SidePanel.Instance.isOnTop()&&this.popupMessenger!==null){if(!BX.MessengerCommon.isPopupPage()){BX.SidePanel.Instance.closeAll()}else if(BX.MessengerCommon.isPage()){BX.MessengerWindow.setZIndex(BX.SidePanel.Instance.getTopSlider().getZindex()+1)}else{this.popupMessenger.close()}}if(this.popupImageUploader){this.popupImageUploader.close()}if(this.BXIM.popupSettings!=null&&!BX.MessengerCommon.isDesktop())this.BXIM.popupSettings.close();if(this.popupMessenger!=null&&this.dialogOpen&&this.currentTab==e&&e!=0){s.reject();return s}if(e!==false&&BX.MessengerCommon.isPage()&&BX.MessengerWindow.currentTab!="im"&&BX.MessengerWindow.currentTab!="im-ol"){BX.MessengerWindow.changeTab("im",false,true)}if(this.popupMessengerEditForm)this.editMessageCancel();if(e&&e.toString().toLowerCase()=="general"){this.currentTab="chat"+this.generalChatId;e=this.currentTab}BX.localStorage.set("mcam",true,5);if(typeof e=="undefined"||e==null){e=0}if(this.currentTab==null)this.currentTab=0;this.openChatFlag=false;this.openNetworkFlag=false;this.openBotFlag=false;this.openLinesFlag=false;this.openCallFlag=false;if(typeof e=="boolean"){e=0;this.currentTab=0}else if(e==0){if(e==0&&this.currentTab!=null){if(this.users[this.currentTab]&&this.users[this.currentTab].id)e=this.currentTab;else if(this.chat[this.getChatId()]&&this.chat[this.getChatId()].id)e=this.currentTab}if(e.toString().substr(0,4)=="chat"){BX.MessengerCommon.getUserParam(e);this.openChatFlag=true;if(this.chat[e.toString().substr(4)].type=="call")this.openCallFlag=true;else if(this.chat[e.toString().substr(4)].type=="lines")this.openLinesFlag=true}else{e=parseInt(e)}}else if(e.toString().substr(0,4)=="chat"||e.toString().substr(0,2)=="sg"||e.toString().substr(0,3)=="crm"){BX.MessengerCommon.getUserParam(e);this.openChatFlag=true;if(e.toString().substr(0,4)=="chat"){if(this.chat[e.toString().substr(4)].type=="call")this.openCallFlag=true;else if(this.chat[e.toString().substr(4)].type=="lines")this.openLinesFlag=true}}else if(e.toString().substr(0,7)=="network"){BX.MessengerCommon.getUserParam(e);this.openNetworkFlag=true}else if(this.users[e]&&this.users[e].id){e=parseInt(e)}else{e=parseInt(e);if(isNaN(e)){e=0}else{BX.MessengerCommon.getUserParam(e)}}if(this.openNetworkFlag){}else if(!this.openChatFlag&&typeof e!="number"){e=0}if(this.openChatFlag||e>0){this.currentTab=e;this.BXIM.notifyManager.closeByTag("im-message-"+e);BX.localStorage.set("mct",this.currentTab,15);if(!this.openChatFlag&&this.users[e]&&this.users[e].bot){this.openBotFlag=true}}if(this.popupMessenger!=null){var i=this.BXIM.callController.hasActiveCall()&&this.BXIM.callController.hasVisibleCall()&&this.BXIM.callController.currentCall.associatedEntity.id!=e;BX.MessengerCommon.openDialog(e,this.BXIM.dialogOpen?false:true,i);if(!(BX.browser.IsAndroid()||BX.browser.IsIOS()||window!=window.top)){if(this.popupMessengerTextarea)this.popupMessengerTextarea.focus()}s.resolve();return s}var a={};if(BX.MessengerCommon.isPage()){if(!(this.BXIM.context=="POPUP-FULLSCREEN"&&BX.MessengerCommon.isIntranet())){var n=BX.MessengerWindow.content.offsetHeight-this.popupMessengerFullHeight;this.popupContactListElementsSize=this.popupContactListElementsSize+n;this.popupMessengerBodySize=this.popupMessengerBodySize+n;this.popupMessengerFullHeight=this.popupMessengerFullHeight+n;this.notify.popupNotifySize=this.notify.popupNotifySize+n}}else{a={width:this.popupMessengerFullWidth+"px"}}if(BX.MessengerWindow&&BX.MessengerWindow.contentMenu){if(this.BXIM.options.showMenu){BX.removeClass(BX.MessengerWindow.contentBox,"bx-desktop-appearance-hide-menu")}else{BX.addClass(BX.MessengerWindow.contentBox,"bx-desktop-appearance-hide-menu")}}var o=BX.MessengerCommon.getUserStatus(this.users[this.BXIM.userId]);var r="";if(this.users[this.currentTab]){if(this.users[this.currentTab].extranet){r=" bx-messenger-user-extranet"}else if(this.users[this.currentTab].bot){if(!this.bot[this.currentTab]){r=" bx-messenger-user-bot"}else if(this.bot[this.currentTab].type=="network"){r=" bx-messenger-user-network"}else if(this.bot[this.currentTab].type=="support24"){r=" bx-messenger-user-support24"}}}if(!BX.MessengerCommon.isDesktop()||this.desktop.enableInVersion(46)){BX.MessengerPromo.show("im:video:01042020:web")}this.popupMessengerContent=BX.create("div",{props:{className:"bx-messenger-box bx-messenger-mark bx-messenger-global-context-"+this.BXIM.context.toLowerCase()+" "+(this.BXIM.callController.hasActiveCall()?" bx-messenger-call"+(this.callOverlayMinimize?"":" bx-messenger-call-maxi"):"")+(BX.MessengerCommon.isPage()?" bx-messenger-box-desktop":"")+(BX.browser.IsMac()?"":" bx-messenger-custom-scroll")+(this.BXIM.options.showRecent?"":" bx-messenger-hide-recent")+(this.BXIM.settings.enableDarkTheme?" bx-messenger-dark":"")},style:a,children:[this.popupContactListWrap=BX.create("div",{props:{className:"bx-messenger-box-contact bx-messenger-box-contact-normal"},style:{width:this.popupContactListSize+"px"},children:[BX.create("div",{props:{className:"bx-messenger-cl-search"},children:[this.popupContactListCreateChat=BX.create("span",{props:{className:"bx-messenger-input-search-create"}}),BX.create("div",{props:{className:"bx-messenger-input-wrap bx-messenger-cl-search-wrap"},children:[this.popupContactListSearchClose=BX.create("a",{attrs:{href:"javascript:void(0);"},props:{className:"bx-messenger-input-close"}}),this.popupContactListSearchInput=BX.create("input",{attrs:{type:"text",placeholder:BX.message("IM_M_SEARCH"),value:this.contactListSearchText},props:{className:"bx-messenger-input"}})]})]}),this.popupContactListElements=BX.create("div",{props:{className:"bx-messenger-cl"},style:{height:this.popupContactListElementsSize+"px"},children:[this.popupContactListElementsWrap=BX.create("div",{props:{className:"bx-messenger-cl-wrap bx-messenger-recent-wrap"}})]}),this.externalMenu?null:BX.create("div",{props:{className:"bx-messenger-cl-notify-wrap"},children:[this.notify.messengerNotifyButton=BX.create("div",{props:{className:"bx-messenger-cl-notify-button"},events:{click:BX.delegate(this.notify.openNotify,this.notify)},children:[BX.create("span",{props:{className:"bx-messenger-cl-notify-text"},html:BX.message("IM_NOTIFY_BUTTON_TITLE")}),this.notify.messengerNotifyButtonCount=BX.create("span",{props:{className:"bx-messenger-cl-count"},html:parseInt(this.notify.notifyCount)>0?'<span class="bx-messenger-cl-count-digit">'+this.notify.notifyCount+"</span>":""})]}),this.BXIM.design=="DESKTOP"?null:this.popupContactListSearchCall=!this.webrtc.phoneSupport()||!this.webrtc.phoneCanPerformCalls?null:BX.create("div",{props:{className:"bx-messenger-cl-phone-button"},children:[BX.create("span",{props:{className:"bx-messenger-cl-phone-text"},html:BX.message("IM_PHONE_BUTTON_TITLE")})]})]}),BX.create("div",{props:{className:"bx-messenger-cl-panel"},children:[BX.create("div",{props:{className:"bx-messenger-cl-panel-wrap"},children:[this.contactListPanelStatus=BX.create("span",{props:{className:"bx-messenger-cl-panel-status-wrap bx-messenger-cl-panel-status-"+BX.MessengerCommon.getUserStatus(this.users[this.BXIM.userId])},html:'<span class="bx-messenger-cl-panel-status"></span><span class="bx-messenger-cl-panel-status-text">'+BX.message("IM_STATUS_"+(o=="birthday"?"online":o).toUpperCase())+'</span><span class="bx-messenger-cl-panel-status-arrow"></span>'}),BX.create("span",{props:{className:"bx-messenger-cl-panel-right-wrap"},children:[this.contactListPanelSettings=this.externalMenu?null:BX.create("span",{props:{title:BX.message("IM_SETTINGS"),className:"bx-messenger-cl-panel-settings-wrap"}})]})]})]})]}),this.popupMessengerDialog=BX.create("div",{props:{className:"bx-messenger-box-dialog"+(this.BXIM.isAdmin?" bx-messenger-user-admin":"")},style:{marginLeft:this.popupContactListSize+"px"},children:[this.popupMessengerPanel=BX.create("div",{props:{className:"bx-messenger-panel bx-messenger-context-user "+(this.openChatFlag?" bx-messenger-hide":"")},children:[BX.create("a",{attrs:{href:this.users[this.currentTab]?this.users[this.currentTab].profile:BX.MessengerCommon.getUserParam().profile,target:"_blank"},props:{className:"bx-messenger-panel-avatar bx-messenger-panel-avatar-status-"+BX.MessengerCommon.getUserStatus(this.users[this.currentTab])},children:[this.popupMessengerPanelAvatar=BX.create("img",{attrs:{src:this.BXIM.pathToBlankImage},props:{className:"bx-messenger-panel-avatar-img bx-messenger-panel-avatar-img-default"}}),BX.create("span",{props:{className:"bx-messenger-panel-avatar-status"}})],events:{mouseover:BX.delegate(function(e){if(this.users[this.currentTab]){BX.proxy_context.title=BX.MessengerCommon.getUserStatus(this.users[this.currentTab],true)}},this)}}),BX.create("a",{attrs:{href:"javascript:void(0);",title:BX.message("IM_M_OPEN_HISTORY_2")},props:{className:"bx-messenger-panel-button bx-messenger-panel-history"},events:{click:BX.delegate(function(e){this.openHistory(this.currentTab);BX.PreventDefault(e)},this)}}),this.popupMessengerPanelMute=BX.create("a",{attrs:{href:"javascript:void(0);",title:this.muteButtonStatus(this.currentTab)?BX.message("IM_M_USER_BLOCK_ON"):BX.message("IM_M_USER_BLOCK_OFF")},props:{className:"bx-messenger-panel-button bx-messenger-panel-mute"},events:{click:BX.delegate(function(e){BX.MessengerCommon.muteMessageChat(this.currentTab);BX.PreventDefault(e)},this)}}),this.enableGroupChat?BX.create("a",{attrs:{href:"javascript:void(0);",title:BX.message("IM_M_CHAT_TITLE")},props:{className:"bx-messenger-panel-button bx-messenger-panel-chat"},html:BX.message("IM_M_CHAT_BTN_JOIN"),events:{click:BX.delegate(function(e){this.openChatDialog({type:"CHAT_ADD",bind:BX.proxy_context});BX.PreventDefault(e)},this)}}):null,this.popupMessengerPanelButtonCall1=this.callButton(),BX.create("span",{props:{className:"bx-messenger-panel-title"},children:[this.popupMessengerPanelTitle=BX.create("a",{props:{className:"bx-messenger-panel-title-link"+r},attrs:{href:this.users[this.currentTab]?this.users[this.currentTab].profile:BX.MessengerCommon.getUserParam().profile,target:"_blank"},html:this.users[this.currentTab]?this.users[this.currentTab].name:""}),this.popupMessengerPanelLastDate=BX.create("span",{props:{className:"bx-messenger-panel-title-position"},html:""})]}),this.popupMessengerPanelStatus=BX.create("span",{props:{className:"bx-messenger-panel-desc"},html:BX.MessengerCommon.getUserPosition(this.users[this.currentTab],false,true)})]}),this.popupMessengerPanelChat=BX.create("div",{props:{className:"bx-messenger-panel bx-messenger-context-chat "+(this.openChatFlag&&!this.openCallFlag?"":" bx-messenger-hide")},children:[this.popupMessengerPanelAvatarForm2=BX.create("form",{attrs:{action:this.BXIM.pathToFileAjax},props:{className:"bx-messenger-panel-avatar bx-messenger-panel-avatar-chat"},children:[BX.create("div",{props:{className:"bx-messenger-panel-avatar-progress"},html:'<div class="bx-messenger-panel-avatar-progress-image"></div>'}),BX.create("input",{attrs:{type:"hidden",name:"IM_AVATAR_UPDATE",value:"Y"}}),this.popupMessengerPanelAvatarId2=BX.create("input",{attrs:{type:"hidden",name:"CHAT_ID",value:this.getChatId()}}),BX.create("input",{attrs:{type:"hidden",name:"IM_AJAX_CALL",value:"Y"}}),this.popupMessengerPanelAvatarUpload2=this.disk.lightVersion||!this.BXIM.ppServerStatus?null:BX.create("input",{attrs:{type:"file",title:BX.message("IM_M_AVATAR_UPLOAD")},props:{className:"bx-messenger-panel-avatar-upload"}}),this.popupMessengerPanelAvatar2=BX.create("img",{attrs:{src:this.BXIM.pathToBlankImage},props:{className:"bx-messenger-panel-avatar-img bx-messenger-panel-avatar-img-default"}}),this.popupMessengerPanelCrm=BX.create("span",{props:{className:"bx-messenger-panel-avatar-crm"}}),this.popupMessengerPanelStatus2=BX.create("span",{props:{className:"bx-messenger-panel-avatar-status"}})]}),BX.create("span",{attrs:{title:BX.message("IM_P_MENU")},props:{className:"bx-messenger-panel-button bx-messenger-panel-menu"},events:{click:BX.delegate(function(e){this.openPopupMenu(BX.proxy_context,this.chat[this.getChatId()].entity_type=="LINES"?"openLinesMenu":"pathMenu");BX.PreventDefault(e)},this)}}),BX.create("a",{attrs:{href:"javascript:void(0);",title:BX.message("IM_M_OPEN_HISTORY_2")},props:{className:"bx-messenger-panel-button bx-messenger-panel-history"},events:{click:BX.delegate(function(e){this.openHistory(this.currentTab);BX.PreventDefault(e)},this)}}),this.popupMessengerPanelMute2=BX.create("a",{attrs:{href:"javascript:void(0);",title:this.muteButtonStatus(this.currentTab)?BX.message("IM_M_CHAT_MUTE_ON_2"):BX.message("IM_M_CHAT_MUTE_OFF_2")},props:{className:"bx-messenger-panel-button bx-messenger-panel-mute "+(this.muteButtonStatus(this.currentTab)?" bx-messenger-panel-unmute":"")},events:{click:BX.delegate(function(e){BX.MessengerCommon.muteMessageChat(this.currentTab);BX.PreventDefault(e)},this)}}),this.popupOpenLinesSpam=BX.create("span",{attrs:{title:BX.message("IM_M_OL_FORCE_CLOSE")?BX.message("IM_M_OL_FORCE_CLOSE").replace("<br>",""):BX.message("IM_M_OL_SPAM")},props:{className:"bx-messenger-panel-button bx-messenger-panel-spam"},events:{click:BX.delegate(function(e){this.linesMarkAsSpam();BX.PreventDefault(e)},this)}}),this.popupOpenLinesClose=BX.create("span",{attrs:{title:BX.message("IM_M_OL_CLOSE")},props:{className:"bx-messenger-panel-button bx-messenger-panel-close"},events:{click:BX.delegate(function(e){this.linesCloseDialog();BX.PreventDefault(e)},this)}}),this.popupOpenLinesTransfer=BX.create("span",{attrs:{title:BX.message("IM_P_TRANSFER")},props:{className:"bx-messenger-panel-button bx-messenger-panel-transfer"},events:{click:BX.delegate(function(e){this.linesOpenTransferDialog({bind:BX.proxy_context});BX.PreventDefault(e)},this)}}),this.popupMessengerPanelButtonExtend=this.enableGroupChat?BX.create("a",{attrs:{href:"javascript:void(0);",title:BX.message("IM_M_CHAT_TITLE")},props:{className:"bx-messenger-panel-button bx-messenger-panel-chat"},html:BX.message("IM_M_CHAT_BTN_JOIN"),events:{click:BX.delegate(function(e){this.openChatDialog({chatId:this.getChatId(),type:"CHAT_EXTEND",bind:BX.proxy_context});BX.PreventDefault(e)},this)}}):null,this.popupMessengerPanelButtonCall2=this.callButton(),BX.create("span",{props:{className:"bx-messenger-panel-title bx-messenger-panel-title-chat"},children:[this.popupMessengerPanelChatTitle=BX.create("span",{props:{className:""},html:this.chat[this.getChatId()]?this.chat[this.getChatId()].name:BX.message("IM_CL_LOAD")})]}),BX.create("span",{props:{className:"bx-messenger-panel-desc"},children:[this.popupMessengerPanelUsers=BX.create("div",{props:{className:"bx-messenger-panel-chat-users"},html:BX.message("IM_CL_LOAD")})]})]}),this.popupMessengerPanelCall=BX.create("div",{props:{className:"bx-messenger-panel bx-messenger-context-call "+(this.openChatFlag&&this.openCallFlag?"":" bx-messenger-hide")},children:[this.popupMessengerPanelAvatarForm3=BX.create("form",{attrs:{action:this.BXIM.pathToFileAjax},props:{className:"bx-messenger-panel-avatar bx-messenger-panel-avatar-call"},children:[BX.create("div",{props:{className:"bx-messenger-panel-avatar-progress"},html:'<div class="bx-messenger-panel-avatar-progress-image"></div>'}),BX.create("input",{attrs:{type:"hidden",name:"IM_AVATAR_UPDATE",value:"Y"}}),this.popupMessengerPanelAvatarId3=BX.create("input",{attrs:{type:"hidden",name:"CHAT_ID",value:this.getChatId()}}),BX.create("input",{attrs:{type:"hidden",name:"IM_AJAX_CALL",value:"Y"}}),this.popupMessengerPanelAvatarUpload3=this.disk.lightVersion||!this.BXIM.ppServerStatus?null:BX.create("input",{attrs:{type:"file",title:BX.message("IM_M_AVATAR_UPLOAD_2")},props:{className:"bx-messenger-panel-avatar-upload"}}),this.popupMessengerPanelAvatar3=BX.create("img",{attrs:{src:this.BXIM.pathToBlankImage},props:{className:"bx-messenger-panel-avatar-img bx-messenger-panel-avatar-img-default"}}),this.popupMessengerPanelStatus3=BX.create("span",{props:{className:"bx-messenger-panel-avatar-status bx-messenger-panel-avatar-status-chat"}})]}),BX.create("span",{attrs:{title:BX.message("IM_P_MENU")},props:{className:"bx-messenger-panel-button bx-messenger-panel-menu"},events:{click:BX.delegate(function(e){this.openPopupMenu(BX.proxy_context,"callContextMenu");BX.PreventDefault(e)},this)}}),BX.create("a",{attrs:{href:"javascript:void(0);",title:BX.message("IM_M_OPEN_HISTORY_2")},props:{className:"bx-messenger-panel-button bx-messenger-panel-history"},events:{click:BX.delegate(function(e){this.openHistory(this.currentTab);BX.PreventDefault(e)},this)}}),this.popupMessengerPanelMute3=BX.create("a",{attrs:{href:"javascript:void(0);",title:this.muteButtonStatus(this.currentTab)?BX.message("IM_M_CHAT_MUTE_ON_2"):BX.message("IM_M_CHAT_MUTE_OFF_2")},props:{className:"bx-messenger-panel-button bx-messenger-panel-mute "+(this.muteButtonStatus(this.currentTab)?" bx-messenger-panel-unmute":"")},events:{click:BX.delegate(function(e){BX.MessengerCommon.muteMessageChat(this.currentTab);BX.PreventDefault(e)},this)}}),this.popupMessengerPanelButtonCall3=this.callButton("call"),this.popupMessengerPanelCallTitle=BX.create("span",{props:{className:"bx-messenger-panel-title"},html:this.chat[this.getChatId()]?this.chat[this.getChatId()].name:BX.message("IM_CL_LOAD")}),this.popupMessengerPanelCallDescription=BX.create("span",{props:{className:"bx-messenger-panel-desc"},text:this.chat[this.getChatId()]&&this.chat[this.getChatId()].entity_data_1&&this.chat[this.getChatId()].entity_data_1.toString().charAt(0)==="Y"?this.chat[this.getChatId()].call_number:BX.message("IM_PHONE_DESC")})]}),this.popupMessengerConnectionStatus=BX.create("div",{props:{className:"bx-messenger-connection-status "+(this.popupMessengerConnectionStatusState=="online"?"":"bx-messenger-connection-status-show bx-messenger-connection-status-"+this.popupMessengerConnectionStatusState)},children:[BX.create("div",{props:{className:"bx-messenger-connection-status-wrap"},children:[this.popupMessengerConnectionStatusText=BX.create("span",{props:{className:"bx-messenger-connection-status-text"},html:this.popupMessengerConnectionStatusStateText}),BX.create("span",{props:{className:"bx-messenger-connection-status-text-reload"},children:[BX.create("span",{props:{className:"bx-messenger-connection-status-text-reload-title"},html:BX.message("IM_CS_RELOAD")}),BX.create("span",{props:{className:"bx-messenger-connection-status-text-reload-hotkey"},html:BX.browser.IsMac()?"&#8984;+R":"Ctrl+R"})],events:{click:function(){location.reload()}}})]})]}),this.popupMessengerEditForm=BX.create("div",{props:{className:"bx-messenger-editform bx-messenger-editform-disable"},children:[BX.create("div",{props:{className:"bx-messenger-editform-wrap"},children:[BX.create("div",{props:{className:"bx-messenger-editform-textarea"},children:[this.popupMessengerEditTextarea=BX.create("textarea",{props:{value:"",className:"bx-messenger-editform-textarea-input"},style:{height:"70px"}})]}),BX.create("div",{props:{className:"bx-messenger-editform-buttons"},children:[BX.create("span",{props:{className:"popup-window-button popup-window-button-accept"},children:[BX.create("span",{props:{className:"popup-window-button-left"}}),BX.create("span",{props:{className:"popup-window-button-text"},html:BX.message("IM_M_CHAT_BTN_EDIT")}),BX.create("span",{props:{className:"popup-window-button-right"}})],events:{click:BX.delegate(function(e){var t=this.popupMessengerEditMessageId;BX.MessengerCommon.editMessageAjax(this.popupMessengerEditMessageId,this.popupMessengerEditTextarea.value);if(this.message[t].quick_saved){BX.MessengerCommon.linesSaveToQuickAnswers(t,true)}},this)}}),BX.create("span",{props:{className:"popup-window-button"},children:[BX.create("span",{props:{className:"popup-window-button-left"}}),BX.create("span",{props:{className:"popup-window-button-text"},html:BX.message("IM_M_CHAT_BTN_CANCEL")}),BX.create("span",{props:{className:"popup-window-button-right"}})],events:{click:BX.delegate(function(e){this.editMessageCancel()},this)}}),BX.create("span",{props:{className:"bx-messenger-editform-progress"},html:BX.message("IM_MESSAGE_EDIT_TEXT")})]})]})]}),this.popupMessengerBodyDialog=BX.create("div",{props:{className:"bx-messenger-body-dialog bxu-file-input-over"},children:[this.popupMessengerFileDropZone=!this.disk.enable?null:BX.create("div",{props:{className:"bx-messenger-file-dropzone"},children:[BX.create("div",{props:{className:"bx-messenger-file-dropzone-wrap"},children:[BX.create("div",{props:{className:"bx-messenger-file-dropzone-icon"}}),BX.create("div",{props:{className:"bx-messenger-file-dropzone-text"},html:BX.message("IM_F_DND_TEXT")})]})]}),this.popupMessengerBodyPanel=BX.create("div",{props:{className:"bx-messenger-body-panel"},style:{height:this.popupMessengerBodySize+"px"},children:[BX.create("div",{props:{className:"bx-messenger-body-panel-title"},children:[this.popupMessengerBodyPanelTitleName=BX.create("div",{props:{className:"bx-messenger-body-panel-title-name"}}),this.popupMessengerBodyPanelTitleDesc=BX.create("div",{props:{className:"bx-messenger-body-panel-title-desc"}}),BX.create("div",{props:{className:"bx-messenger-body-panel-title-close"},events:{click:BX.delegate(function(){this.closeMessengerPanel()},this)}})]}),this.popupMessengerBodyPanelWrap=BX.create("div",{props:{className:"bx-messenger-body-panel-wrap"}})]}),this.popupMessengerBody=BX.create("div",{props:{className:"bx-messenger-body"},style:{height:this.popupMessengerBodySize+"px"},children:[BX.create("div",{props:{className:"bx-messenger-body-bg"},children:[this.popupMessengerBodyWrap=BX.create("div",{props:{className:"bx-messenger-body-wrap"}})]})]}),this.popupMessengerBodyLiveChatForm=BX.create("div",{props:{className:"bx-messenger-livechat-form"}}),this.popupMessengerTextareaPlace=BX.create("div",{props:{className:"bx-messenger-textarea-place"},children:[BX.create("div",{props:{className:"bx-messenger-textarea-open-lines"},children:[BX.create("div",{props:{className:"bx-messenger-textarea-open-invite-text-box"},children:[BX.create("div",{props:{className:"bx-messenger-textarea-open-invite-text-box-element"},children:[this.popupMessengerTextareaOpenLinesText=BX.create("div",{props:{className:"bx-messenger-textarea-open-invite-text"},html:BX.message("IM_OL_INVITE_TEXT")})]})]}),BX.create("div",{props:{className:"bx-messenger-textarea-open-invite-join-box"},children:[this.popupMessengerTextareaOpenLinesAnswer=BX.create("div",{props:{className:"bx-messenger-textarea-open-invite-answer bx-notifier-item-button bx-notifier-item-button-confirm bx-notifier-item-button-accept"},html:BX.message("IM_OL_INVITE_ANSWER")}),this.popupMessengerTextareaOpenLinesSkip=BX.create("div",{props:{className:"bx-messenger-textarea-open-invite-skip bx-notifier-item-button bx-notifier-item-button-confirm bx-notifier-item-button-cancel"},html:BX.message("IM_OL_INVITE_SKIP")}),this.popupMessengerTextareaOpenLinesTransfer=BX.create("div",{props:{className:"bx-messenger-textarea-open-invite-transfer bx-notifier-item-button bx-notifier-item-button-confirm bx-notifier-item-button-transfer"},html:BX.message("IM_OL_INVITE_TRANSFER"),events:{click:BX.delegate(function(e){this.linesOpenTransferDialog({bind:BX.proxy_context});BX.PreventDefault(e)},this)}})]})]}),BX.create("div",{props:{className:"bx-messenger-textarea-open-invite"},children:[BX.create("div",{props:{className:"bx-messenger-textarea-open-invite-text-box"},children:[BX.create("div",{props:{className:"bx-messenger-textarea-open-invite-text-box-element"},children:[this.popupMessengerTextareaOpenText=BX.create("div",{props:{className:"bx-messenger-textarea-open-invite-text"},html:BX.message(this.BXIM.bitrixIntranet?"IM_O_INVITE_TEXT_NEW":"IM_O_INVITE_TEXT_SITE_NEW")})]})]}),this.popupMessengerTextareaOpenJoin=BX.create("div",{props:{className:"bx-messenger-textarea-open-invite-join bx-notifier-item-button bx-notifier-item-button-confirm bx-notifier-item-button-accept"},html:BX.message("IM_O_INVITE_JOIN")})]}),BX.create("div",{props:{className:"bx-messenger-textarea-general-invite"},children:[BX.create("div",{props:{className:"bx-messenger-textarea-open-invite-text-box"},children:[BX.create("div",{props:{className:"bx-messenger-textarea-open-invite-text-box-element"},children:[this.popupMessengerTextareaGeneralText=BX.create("div",{props:{className:"bx-messenger-textarea-open-invite-text"}})]})]}),this.popupMessengerTextareaGeneralJoin=BX.create("div",{props:{className:"bx-messenger-textarea-open-invite-join bx-notifier-item-button bx-notifier-item-button-confirm bx-notifier-item-button-accept"},html:BX.message("IM_G_JOIN_"+this.BXIM.userGender)})]}),BX.create("div",{props:{className:"bx-messenger-textarea-resize"},events:{mousedown:BX.delegate(this.resizeTextareaStart,this)}}),BX.create("div",{props:{className:"bx-messenger-textarea-send"},children:[BX.create("a",{attrs:{href:"javascript:void(0);"},props:{className:"bx-messenger-textarea-send-button"},events:{click:BX.delegate(this.sendMessage,this)}}),this.popupMessengerTextareaSendType=BX.browser.IsMobile()?BX.create("span"):BX.create("span",{attrs:{title:BX.message("IM_M_SEND_TYPE_TITLE")},props:{className:"bx-messenger-textarea-cntr-enter"},html:this.BXIM.settings.sendByEnter?"Enter":BX.browser.IsMac()?"&#8984;+Enter":"Ctrl+Enter",events:{click:BX.delegate(function(){if(this.popupMessengerTextareaPlace&&this.popupMessengerTextareaPlace.className.indexOf("bx-messenger-textarea-with-text")==-1){return false}this.BXIM.settings.sendByEnter=this.BXIM.settings.sendByEnter?false:true;this.BXIM.saveSettings({sendByEnter:this.BXIM.settings.sendByEnter});BX.proxy_context.innerHTML=this.BXIM.settings.sendByEnter?"Enter":BX.browser.IsMac()?"&#8984;+Enter":"Ctrl+Enter"},this)}})]}),this.popupMessengerTextareaIcons=BX.create("div",{props:{className:"bx-messenger-textarea-icons"},children:[this.popupMessengerFileButton=this.disk.getFileMenuIcon(),this.BXIM.context=="LINES"?null:BX.create("div",{attrs:{title:BX.message("IM_MENTION_MENU_NEW")},props:{className:"bx-messenger-textarea-mention"},events:{click:BX.delegate(function(e){this.openMentionDialog({delay:0});return BX.PreventDefault(e)},this)}}),this.BXIM.context=="LINES"?null:BX.create("div",{attrs:{title:BX.message("IM_COMMAND_MENU")},props:{className:"bx-messenger-textarea-command"},events:{click:BX.delegate(function(e){this.openCommandDialog();return BX.PreventDefault(e)},this)}}),this.popupMessengerSmileButton=BX.create("div",{attrs:{title:BX.message("IM_SMILE_MENU")},props:{className:"bx-messenger-textarea-smile"},events:{click:BX.delegate(function(e){this.openSmileMenu();return BX.PreventDefault(e)},this)}}),this.BXIM.context=="LINES"?null:BX.create("div",{attrs:{title:BX.message("IM_FORMS_MENU")},props:{className:"bx-messenger-textarea-forms"},events:{click:BX.delegate(function(e){this.openFormsMenu();return BX.PreventDefault(e)},this)}}),this.BXIM.context=="LINES"?null:BX.create("div",{attrs:{title:BX.message("IM_ANSWERS_MENU")},props:{className:"bx-messenger-textarea-answers"},events:{click:BX.delegate(function(e){this.openAnswersMenu();return BX.PreventDefault(e)},this)}}),this.popupMessengerHiddenModeButton=BX.create("div",{attrs:{title:BX.message("IM_HIDDEN_MODE_MENU")},props:{className:"bx-messenger-textarea-hidden"},events:{click:BX.delegate(function(e){this.linesToggleSilentMode();return BX.PreventDefault(e)},this)}}),this.popupMessengerTextareaIconBox=BX.create("div",{props:{className:"bx-messenger-textarea-icon-box"}})]}),BX.create("div",{props:{className:"bx-messenger-textarea"},children:[this.popupMessengerTextarea=BX.create("textarea",{props:{value:this.textareaHistory[e]?this.textareaHistory[e]:"",className:"bx-messenger-textarea-input"},style:{height:this.popupMessengerTextareaSize+"px"}}),this.popupMessengerTextareaPlaceholder=BX.create("div",{props:{className:"bx-messenger-textarea-placeholder"},html:BX.message("IM_M_TA_TEXT")})]}),BX.create("div",{props:{className:"bx-messenger-textarea-clear"}}),BX.MessengerCommon.isPage()&&!BX.MessengerCommon.isDesktop()?null:BX.create("span",{props:{className:"bx-messenger-resize"},events:BX.MessengerCommon.isPage()?{}:{mousedown:BX.delegate(this.resizeWindowStart,this)}})]})]})]}),this.popupMessengerExtra=BX.create("div",{props:{className:"bx-messenger-box-extra"},style:{marginLeft:this.popupContactListSize+"px",height:this.popupMessengerFullHeight+"px"}})]});this.textareaCheckText();this.BXIM.dialogOpen=true;if(BX.MessengerCommon.isPage()){if(BX.MessengerCommon.isPopupPage()){this.popupMessenger=new BX.PopupWindowSlider(this.BXIM)}else{this.popupMessenger=new BX.PopupWindowDesktop(this.BXIM)}BX.MessengerWindow.setTabContent("im",this.popupMessengerContent);BX.bind(this.popupMessengerContent,"click",BX.delegate(this.closePopupFileMenu,this));this.disk.chatDialogInit();this.disk.chatAvatarInit()}else{this.popupMessenger=new BX.PopupWindow("bx-messenger-popup-messenger",null,{lightShadow:true,autoHide:false,closeByEsc:true,overlay:{opacity:50,backgroundColor:"#000000"},draggable:{restrict:true},events:{onPopupShow:BX.delegate(function(){this.disk.chatDialogInit();this.disk.chatAvatarInit()},this),onPopupClose:function(){this.destroy()},onPopupDestroy:BX.delegate(function(){this.closeMessenger()},this)},titleBar:{content:BX.create("div")},closeIcon:{top:"10px",right:"13px"},content:this.popupMessengerContent,noAllPaddings:true,contentColor:"white"});this.popupMessenger.show();BX.bind(this.popupMessenger.popupContainer,"click",BX.MessengerCommon.preventDefault);if(this.webrtc.ready()){BX.addCustomEvent(this.popupMessenger,"onPopupDragStart",BX.delegate(function(){if(this.webrtc.callDialogAllow!=null)this.webrtc.callDialogAllow.destroy()},this))}BX.bind(document,"click",BX.proxy(this.BXIM.autoHide,this.BXIM));BX.bind(window,"keydown",BX.proxy(this.closePopupFileMenuKeydown,this));BX.addCustomEvent(this.popupMessenger,"onPopupFullscreenEnter",BX.delegate(function(){BX.addClass(this.popupMessengerContent,"bx-messenger-fullscreen");this.messengerFullscreenStatus=true;this.resizeMainWindow();if(BX.browser.IsChrome()){setTimeout(BX.delegate(function(){this.resizeMainWindow()},this),100)}this.popupMessengerBody.scrollTop=this.popupMessengerBody.scrollHeight-this.popupMessengerBody.offsetHeight},this));BX.addCustomEvent(this.popupMessenger,"onPopupFullscreenLeave",BX.delegate(function(){BX.removeClass(this.popupMessengerContent,"bx-messenger-fullscreen");if(BX.browser.IsChrome()){BX.addClass(this.popupMessengerContent,"bx-messenger-fullscreen-chrome-hack");setTimeout(BX.delegate(function(){BX.removeClass(this.popupMessengerContent,"bx-messenger-fullscreen-chrome-hack")},this),100)}this.resizeMainWindow();this.popupMessengerBody.scrollTop=this.popupMessengerBody.scrollHeight-this.popupMessengerBody.offsetHeight},this))}this.BXIM.setBackground();this.popupMessengerTopLine=BX.create("div",{props:{className:"bx-messenger-box-topline"}});this.popupMessengerContent.insertBefore(this.popupMessengerTopLine,this.popupMessengerContent.firstChild);if(!BX.MessengerCommon.isDesktop()&&this.BXIM.bitrixIntranet&&this.BXIM.platformName!=""&&this.BXIM.settings.bxdNotify){clearTimeout(this.popupMessengerDesktopTimeout);this.popupMessengerDesktopTimeout=setTimeout(BX.delegate(function(){var e=BX.delegate(function(){window.open(BX.browser.IsMac()?"http://dl.bitrix24.com/b24/bitrix24_desktop.dmg":"http://dl.bitrix24.com/b24/bitrix24_desktop.exe","desktopApp");this.BXIM.settings.bxdNotify=false;this.BXIM.saveSettings({bxdNotify:this.BXIM.settings.bxdNotify});this.hideTopLine()},this);var t=BX.delegate(function(){this.BXIM.settings.bxdNotify=false;this.BXIM.saveSettings({bxdNotify:this.BXIM.settings.bxdNotify});this.hideTopLine()},this);this.showTopLine(BX.message("IM_DESKTOP_INSTALL").replace("#WM_NAME#",BX.message("IM_WM")).replace("#OS#",this.BXIM.platformName),[{title:BX.message("IM_DESKTOP_INSTALL_Y"),callback:e},{title:BX.message("IM_DESKTOP_INSTALL_N"),callback:t}],false)},this),15e3)}this.textareaIconPrepare();BX.MessengerCommon.userListRedraw();if(this.BXIM.quirksMode){this.popupContactListWrap.style.position="absolute";this.popupContactListWrap.style.display="block"}this.setUpdateStateStep();if(!(BX.browser.IsAndroid()||BX.browser.IsIOS()||window!=window.top)&&this.popupMessenger!=null){setTimeout(BX.delegate(function(){this.popupMessengerTextarea.focus()},this),50)}if(this.webrtc.phoneEnabled&&this.BXIM.design!="DESKTOP"){BX.bind(this.popupContactListSearchCall,"click",BX.delegate(this.webrtc.openKeyPad,this.webrtc))}BX.bind(this.popupContactListWrap,"mouseover",BX.delegate(function(e){if(this.popupContactListHovered||this.popupContactListActive)return false;clearTimeout(this.popupContactListWrapAnimation);this.popupContactListWrapAnimation=setTimeout(BX.delegate(function(){BX.addClass(this.popupContactListWrap,"bx-messenger-box-contact-hover");clearTimeout(this.popupContactListWrapAnimation);this.popupContactListWrapAnimation=setTimeout(BX.delegate(function(){BX.removeClass(this.popupContactListWrap,"bx-messenger-box-contact-normal")},this),100)},this),2e3);this.popupContactListHovered=true},this));BX.bind(this.popupContactListWrap,"mouseout",BX.delegate(function(e){if(!this.popupContactListHovered||this.popupContactListActive)return false;clearTimeout(this.popupContactListWrapAnimation);this.popupContactListWrapAnimation=setTimeout(BX.delegate(function(){BX.addClass(this.popupContactListWrap,"bx-messenger-box-contact-normal");clearTimeout(this.popupContactListWrapAnimation);this.popupContactListWrapAnimation=setTimeout(BX.delegate(function(){BX.removeClass(this.popupContactListWrap,"bx-messenger-box-contact-hover")},this),50)},this),400);this.popupContactListHovered=false},this));BX.bind(this.popupContactListCreateChat,"click",BX.delegate(function(e){if(!this.recentList){this.recentList=true;BX.MessengerCommon.recentListRedraw()}this.openPopupMenu(e.currentTarget,"createChat");return BX.PreventDefault(e)},this));BX.bind(this.popupContactListSearchClose.parentNode,"click",BX.delegate(function(){this.popupContactListSearchInput.focus()},this));BX.bind(this.popupMessengerDialog,"click",BX.delegate(function(e){if(this.recentList&&!this.chatList&&!this.contactList){return false}BX.MessengerCommon.contactListSearchClear(e)},this));BX.bind(this.popupContactListSearchClose,"click",BX.delegate(function(e){BX.MessengerCommon.contactListSearchClear(e);return BX.PreventDefault(e)},BX.MessengerCommon));BX.bind(this.popupContactListSearchInput,"focus",BX.delegate(function(e){clearTimeout(this.BXIM.messenger.redrawChatListTimeout);this.BXIM.messenger.redrawChatListTimeout=setTimeout(BX.delegate(function(){if(this.contactListSearchText.length==0&&!this.chatList&&!this.contactList){BX.MessengerCommon.chatListRedraw()}},this),100);this.setClosingByEsc(false)},this));BX.bind(this.popupContactListSearchInput,"blur",BX.delegate(function(){if(this.contactListSearchText.length==0&&!this.popupContactListHovered&&!this.recentList){this.setClosingByEsc(true)}},this));if(BX.MessengerCommon.isDesktop()){BX.bind(this.popupContactListSearchInput,"contextmenu",BX.delegate(function(e){this.openPopupMenu(e,"copypaste",false,{spell:true});return BX.PreventDefault(e)},this))}BX.bind(this.popupContactListSearchInput,"keyup",BX.delegate(BX.MessengerCommon.contactListSearch,BX.MessengerCommon));BX.bind(this.popupMessengerPanelChatTitle,"click",BX.delegate(this.renameChatDialog,this));BX.bindDelegate(this.popupMessengerPanelUsers,"click",{className:"bx-messenger-panel-chat-user"},BX.delegate(function(e){this.openPopupMenu(BX.proxy_context,"chatUser");return BX.PreventDefault(e)},this));BX.bindDelegate(this.popupMessengerPanelUsers,"click",{className:"bx-notifier-popup-user-more"},BX.delegate(function(e){if(this.popupChatUsers!=null){this.popupChatUsers.destroy();return false}var t=this.getChatId();var s=[];for(var i=0;i<this.userInChat[t].length;i++){var a=this.users[this.userInChat[t][i]];if(!a||!a.active){continue}if(this.chat[t].entity_type=="LINES"&&this.chat[t].owner==0&&a.id!=this.BXIM.userId&&!(a.bot||a.connector)){continue}s.push(this.userInChat[t][i])}var n='<span class="bx-notifier-item-help-popup">';for(var i=parseInt(BX.proxy_context.getAttribute("data-last-item"));i<s.length;i++){var a=this.users[s[i]];var o=BX.MessengerCommon.isBlankAvatar(a.avatar)?'style="background-color: '+a.color+'"':"";n+='<span class="bx-notifier-item-help-popup-img bx-messenger-panel-chat-user" data-userId="'+a.id+'">'+'<span class="bx-notifier-popup-avatar  bx-notifier-popup-avatar-status-'+BX.MessengerCommon.getUserStatus(a)+'">'+'<img class="bx-notifier-popup-avatar-img'+(BX.MessengerCommon.isBlankAvatar(a.avatar)?" bx-notifier-popup-avatar-img-default":"")+'" src="'+a.avatar+'" '+o+">"+"</span>"+'<span class="bx-notifier-item-help-popup-name  '+(a.extranet?" bx-notifier-popup-avatar-extranet":"")+'">'+a.name+"</span>"+"</span>"}n+="</span>";this.popupChatUsers=new BX.PopupWindow("bx-messenger-popup-chat-users",BX.proxy_context,{darkMode:this.BXIM.settings.enableDarkTheme,zIndex:BX.MessengerCommon.getDefaultZIndex()+200,lightShadow:true,offsetTop:-2,offsetLeft:3,autoHide:true,closeByEsc:true,events:{onPopupClose:function(){this.destroy()},onPopupDestroy:BX.proxy(function(){this.popupChatUsers=null},this)},content:BX.create("div",{props:{className:"bx-messenger-popup-menu"+(BX.browser.IsMac()?"":" bx-messenger-custom-scroll")},html:n})});if(!this.BXIM.settings.enableDarkTheme)this.popupChatUsers.setAngle({offset:BX.proxy_context.offsetWidth});BX.addClass(this.popupChatUsers.popupContainer,"bx-messenger-mark");this.popupChatUsers.show();BX.bindDelegate(this.popupChatUsers.popupContainer,"click",{className:"bx-messenger-panel-chat-user"},BX.delegate(function(e){this.openPopupMenu(BX.proxy_context,"chatUser");return BX.PreventDefault(e)},this));return BX.PreventDefault(e)},this));BX.bindDelegate(this.popupContactListElements,"contextmenu",{className:"bx-messenger-cl-item"},BX.delegate(function(e){this.openPopupMenu(BX.proxy_context,"contactList");return BX.PreventDefault(e)},this));BX.bindDelegate(this.popupContactListElements,"click",{className:"bx-messenger-cl-item"},BX.delegate(BX.MessengerCommon.contactListClickItem,BX.MessengerCommon));BX.bindDelegate(this.popupContactListElements,"click",{className:"bx-messenger-chatlist-group-add"},BX.delegate(function(e){if(!this.recentList){this.recentList=true;BX.MessengerCommon.recentListRedraw()}this.openChatCreateForm(BX.proxy_context.getAttribute("data-type"))},this));BX.bindDelegate(this.popupContactListElements,"click",{className:"bx-messenger-chatlist-more"},BX.delegate(this.toggleChatListGroup,this));BX.bindDelegate(this.popupContactListElements,"click",{className:"bx-messenger-chatlist-search-button"},BX.delegate(function(){this.BXIM.messenger.chatListSearchAction(BX.proxy_context.parentNode)},this));BX.bind(this.popupContactListElements,"scroll",BX.delegate(function(){if(this.popupPopupMenu!=null&&this.popupPopupMenuDateCreate+500<+new Date&&this.popupPopupMenu.uniquePopupId.replace("bx-messenger-popup-","")=="contactList"){this.popupPopupMenu.close()}},this));BX.bind(this.contactListPanelStatus,"click",BX.delegate(function(e){this.openPopupMenu(this.contactListPanelStatus,"status");return BX.PreventDefault(e)},this));if(this.contactListPanelSettings){BX.bind(this.contactListPanelSettings,"click",BX.delegate(function(e){this.BXIM.openSettings();BX.PreventDefault(e)},this))}if(this.contactListPanelFull){BX.bind(this.contactListPanelFull,"click",BX.delegate(function(e){this.popupMessenger.enterFullScreen();BX.PreventDefault(e)},this))}BX.bind(this.popupMessengerEditTextarea,"focus",BX.delegate(function(){this.setClosingByEsc(false)},this));BX.bind(this.popupMessengerEditTextarea,"blur",BX.delegate(function(){this.setClosingByEsc(true)},this));BX.bind(this.popupMessengerEditTextarea,"keydown",BX.delegate(function(e){this.textareaPrepareText(BX.proxy_context,e,BX.delegate(function(){BX.MessengerCommon.editMessageAjax(this.popupMessengerEditMessageId,this.popupMessengerEditTextarea.value)},this),BX.delegate(function(){setTimeout(function(){this.editMessageCancel()}.bind(this),50)},this))},this));if(BX.MessengerCommon.isDesktop()){BX.bind(this.popupMessengerEditTextarea,"contextmenu",BX.delegate(function(e){this.openPopupMenu(e,"copypaste",false,{spell:true});return BX.PreventDefault(e)},this));BX.bind(this.popupMessengerTextarea,"contextmenu",BX.delegate(function(e){this.openPopupMenu(e,"copypaste",false,{spell:true});return BX.PreventDefault(e)},this));BX.bind(this.popupMessengerEditTextarea,"click",BX.delegate(function(e){if(!(e.metaKey||e.ctrlKey)||!this.desktop.enableInVersion(34))return false;var t=BX.desktop.clipboardSelected(this.popupMessengerEditTextarea,true);if(!t.text)return false;BXDesktopSystem.SpellCheckWord(t.text,BX.delegate(function(e,t){if(e||t.length<=0)return false;var s=BX.desktop.clipboardSelected(this.popupMessengerEditTextarea,true);BX.desktop.clipboardReplaceText(this.popupMessengerEditTextarea,s.selectionStart,s.selectionEnd,t[0])},this))},this));BX.bind(this.popupMessengerTextarea,"click",BX.delegate(function(e){if(!(e.metaKey||e.ctrlKey)||!this.desktop.enableInVersion(34))return false;var t=BX.desktop.clipboardSelected(this.popupMessengerTextarea,true);if(!t.text)return false;BXDesktopSystem.SpellCheckWord(t.text,BX.delegate(function(e,t){if(e||t.length<=0)return false;var s=BX.desktop.clipboardSelected(this.popupMessengerTextarea,true);BX.desktop.clipboardReplaceText(this.popupMessengerTextarea,s.selectionStart,s.selectionEnd,t[0])},this))},this))}BX.bind(this.popupMessengerTextarea,"paste",BX.delegate(this.onPaste,this));BX.bind(this.popupMessengerTextarea,"focus",BX.delegate(function(){this.textareaCheckText();this.setClosingByEsc(false);BX.addClass(this.popupMessengerTextarea.parentNode,"bx-messenger-textarea-focus");BX.onCustomEvent(window,"onImTextareaFocus",[true])},this));BX.bind(this.popupMessengerTextarea,"blur",BX.delegate(function(){this.textareaCheckText();this.setClosingByEsc(true);BX.removeClass(this.popupMessengerTextarea.parentNode,"bx-messenger-textarea-focus");BX.onCustomEvent(window,"onImTextareaFocus",[false])},this));BX.bind(this.popupMessengerTextarea,"keydown",BX.delegate(function(e){this.textareaPrepareText(BX.proxy_context,e,BX.delegate(this.sendMessage,this),function(){})},this));BX.bind(this.popupMessengerTextarea,"keyup",BX.delegate(this.textareaCheckText,this));if(BX.MessengerCommon.isDesktop()){BX.bindDelegate(this.popupMessengerBodyWrap,"contextmenu",{className:"bx-messenger-content-item-content"},BX.delegate(function(e){this.openPopupMenu(e,"dialogContext",false);return BX.PreventDefault(e)},this))}BX.bindDelegate(this.popupMessengerBodyWrap,"click",{className:"bx-messenger-content-item-avatar-button"},BX.delegate(function(e){var t=BX.proxy_context.parentNode.parentNode.getAttribute("data-senderId");if(!this.users[t]||this.users[t].fake){return false}if(!(e.metaKey||e.ctrlKey)&&!e.target.className.includes("bx-messenger-content-item-avatar-name")){this.openPopupMenu(e.target,"chatUser",true,{userId:t});return BX.PreventDefault(e)}var s=BX.util.htmlspecialcharsback(this.users[t].name);if(e.altKey){s="[USER="+t+"]"+s+"[/USER]"}else{BX.MessengerCommon.addMentionList(this.currentTab,s,t)}this.insertTextareaText(this.popupMessengerTextarea," "+s+" ",false);this.popupMessengerTextarea.focus();return BX.PreventDefault(e)},this));BX.bindDelegate(this.popupMessengerBodyWrap,"click",{className:"bx-messenger-attach-block-spoiler"},BX.delegate(function(e){var t=BX.findChildByClassName(BX.proxy_context,"bx-messenger-attach-block-value");if(BX.hasClass(BX.proxy_context,"bx-messenger-attach-block-spoiler-show")){height=t.getAttribute("data-min-height");BX.removeClass(BX.proxy_context,"bx-messenger-attach-block-spoiler-show")}else{BX.addClass(BX.proxy_context,"bx-messenger-attach-block-spoiler-show");height=t.getAttribute("data-max-height")}t.style.maxHeight=height+"px"},this));BX.bindDelegate(this.popupMessengerBodyWrap,"click",{className:"bx-messenger-content-item-menu"},BX.delegate(function(e){if(e.metaKey||e.ctrlKey){var t=BX.proxy_context.parentNode.parentNode.getAttribute("data-blockmessageid");if(this.message[t]&&this.users[this.message[t].senderId].name){var s=[];if(this.message[t].text){s.push(BX.MessengerCommon.prepareTextBack(this.message[t].text))}if(this.message[t].params&&this.message[t].params.FILE_ID){for(var i=0;i<this.message[t].params.FILE_ID.length;i++){var a=this.message[t].params.FILE_ID[i];var n=this.message[t].chatId;if(this.disk.files[n][a]){s.push("["+BX.message("IM_F_FILE")+": "+this.disk.files[n][a].name+"]")}}}if(s.length>0){this.insertQuoteText(this.users[this.message[t].senderId].name,this.message[t].date,s.join("\n"))}}}else{this.openPopupMenu(BX.proxy_context,"dialogMenu")}return BX.PreventDefault(e)},this));BX.bindDelegate(this.popupMessengerBodyWrap,"click",{className:"bx-messenger-content-like-digit"},BX.delegate(function(e){BX.localStorage.set("implc",true,1);var t=BX.proxy_context.parentNode.parentNode.parentNode.parentNode.parentNode.getAttribute("data-blockmessageid");if(t.substr(0,4)=="temp"||!this.message[t].params||!this.message[t].params["LIKE"]||this.message[t].params["LIKE"].length<=0)return false;if(this.popupChatUsers!=null){this.popupChatUsers.destroy();return false}var s='<span class="bx-notifier-item-help-popup">';for(var i=0;i<this.message[t].params["LIKE"].length;i++){if(this.users[this.message[t].params["LIKE"][i]]){var a=BX.MessengerCommon.isBlankAvatar(this.users[this.message[t].params["LIKE"][i]].avatar)?'style="background-color: '+this.users[this.message[t].params["LIKE"][i]].color+'"':"";s+='<span class="bx-notifier-item-help-popup-img bx-messenger-panel-chat-user" data-userId="'+this.message[t].params["LIKE"][i]+'">'+'<span class="bx-notifier-popup-avatar  bx-notifier-popup-avatar-status-'+BX.MessengerCommon.getUserStatus(this.users[this.message[t].params["LIKE"][i]])+'">'+'<img class="bx-notifier-popup-avatar-img'+(BX.MessengerCommon.isBlankAvatar(this.users[this.message[t].params["LIKE"][i]].avatar)?" bx-notifier-popup-avatar-img-default":"")+'" src="'+this.users[this.message[t].params["LIKE"][i]].avatar+'" '+a+">"+"</span>"+'<span class="bx-notifier-item-help-popup-name  '+(this.users[this.message[t].params["LIKE"][i]].extranet?" bx-notifier-popup-avatar-extranet":"")+'">'+this.users[this.message[t].params["LIKE"][i]].name+"</span>"+"</span>"}}s+="</span>";this.popupChatUsers=new BX.PopupWindow("bx-messenger-popup-like-users",BX.proxy_context,{darkMode:this.BXIM.settings.enableDarkTheme,zIndex:BX.MessengerCommon.getDefaultZIndex()+200,lightShadow:true,offsetTop:5,offsetLeft:12,autoHide:true,closeByEsc:true,bindOptions:{position:"top"},events:{onPopupClose:function(){this.destroy()},onPopupDestroy:BX.proxy(function(){this.popupChatUsers=null},this)},content:BX.create("div",{props:{className:"bx-messenger-popup-menu"+(BX.browser.IsMac()?"":" bx-messenger-custom-scroll")},html:s})});if(!this.BXIM.settings.enableDarkTheme)this.popupChatUsers.setAngle({offset:BX.proxy_context.offsetWidth});BX.addClass(this.popupChatUsers.popupContainer,"bx-messenger-mark");this.popupChatUsers.show();BX.bindDelegate(this.popupChatUsers.popupContainer,"click",{className:"bx-messenger-panel-chat-user"},BX.delegate(function(e){this.openPopupMenu(BX.proxy_context,"chatUser");return BX.PreventDefault(e)},this));return BX.PreventDefault(e)},this));BX.bindDelegate(this.popupMessengerBodyWrap,"click",{className:"bx-messenger-keyboard-button-text"},BX.delegate(BX.MessengerCommon.clickButtonKeyboard,BX.MessengerCommon));BX.bindDelegate(this.popupMessengerBodyWrap,"click",{className:"bx-messenger-content-like-button"},BX.delegate(function(e){var t=this.getChatId();if(this.openChatFlag&&!BX.MessengerCommon.userInChat(t)){return false}if(BX.localStorage.get("implc",true,1)){return false}var s=BX.proxy_context.parentNode.parentNode.parentNode.parentNode.parentNode.getAttribute("data-blockmessageid");BX.MessengerCommon.messageLike(s);return BX.PreventDefault(e)},this));BX.bindDelegate(this.popupMessengerBodyWrap,"click",{className:"bx-messenger-attach-delete"},BX.delegate(function(e){var t=BX.proxy_context.getAttribute("data-messageId");var s=BX.proxy_context.getAttribute("data-attachId");var i=BX.proxy_context.getAttribute("data-action");if(i=="url"){BX.MessengerCommon.messageUrlAttachDelete(t,s)}return BX.PreventDefault(e)},this));BX.bind(this.popupMessengerTextareaOpenJoin,"click",BX.delegate(function(){if(this.currentTab.substr(0,4)!="chat"){return false}if(this.BXIM.messenger.popupMessengerDialog&&BX.hasClass(this.BXIM.messenger.popupMessengerDialog,"bx-messenger-chat-load-last-message")){return false}var e=this.currentTab.substr(4);BX.MessengerCommon.joinToChat(e);return true},this));BX.bind(this.popupMessengerTextareaGeneralJoin,"click",BX.delegate(function(){if(this.BXIM.messenger.popupMessengerDialog&&BX.hasClass(this.BXIM.messenger.popupMessengerDialog,"bx-messenger-chat-load-last-message")){return false}this.BXIM.settings.generalNotify=false;this.BXIM.saveSettings({generalNotify:this.BXIM.settings.generalNotify});this.redrawChatHeader({userRedraw:false});this.popupMessengerTextarea.focus();return true},this));BX.bind(this.popupMessengerTextareaOpenLinesAnswer,"click",BX.delegate(function(){if(this.currentTab.substr(0,4)!="chat")return false;if(this.BXIM.messenger.popupMessengerDialog&&BX.hasClass(this.BXIM.messenger.popupMessengerDialog,"bx-messenger-chat-load-last-message")){return false}var e=this.currentTab.substr(4);if(!BX.MessengerCommon.userInChat(e)){var t=BX.MessengerCommon.linesGetSession(this.chat[e]);if(parseInt(t.id)<=0){BX.MessengerCommon.linesStartSession(e)}else if(parseInt(this.chat[e].owner)==0){BX.MessengerCommon.linesAnswer(e)}else{BX.MessengerCommon.linesJoinSession(e)}}else{BX.MessengerCommon.linesAnswer(e)}return true},this));BX.bind(this.popupMessengerTextareaOpenLinesSkip,"click",BX.delegate(function(){if(this.currentTab.substr(0,4)!="chat")return false;if(this.BXIM.messenger.popupMessengerDialog&&BX.hasClass(this.BXIM.messenger.popupMessengerDialog,"bx-messenger-chat-load-last-message")){return false}var e=this.currentTab.substr(4);if(!BX.MessengerCommon.userInChat(e)){BX.MessengerCommon.dialogCloseCurrent(true)}else if(BX.MessengerCommon.isSessionBlocked(e)){BX.MessengerCommon.linesMarkAsSpam(e)}else{BX.MessengerCommon.linesSkip(e)}return true},this));BX.bindDelegate(this.popupMessengerBodyWrap,"click",{className:"bx-messenger-ajax"},BX.delegate(function(){if(BX.proxy_context.getAttribute("data-entity")=="readedList"){this.openPopupExternalData(BX.proxy_context,"readedList",true,{TAB:this.BXIM.messenger.currentTab})}else if(BX.proxy_context.getAttribute("data-entity")=="user"){this.openPopupExternalData(BX.proxy_context,"user",true,{ID:BX.proxy_context.getAttribute("data-userId")})}else if(BX.proxy_context.getAttribute("data-entity")=="openlines"){this.linesOpenHistory(BX.proxy_context.getAttribute("data-sessionId"))}else if(BX.proxy_context.getAttribute("data-entity")=="chat"){this.openPopupExternalData(BX.proxy_context,"chat",true,{ID:BX.proxy_context.getAttribute("data-chatId")})}else if(BX.proxy_context.getAttribute("data-entity")=="network"){this.openMessenger("network"+BX.proxy_context.getAttribute("data-networkId"))}else if(BX.proxy_context.getAttribute("data-entity")=="date"){this.openPopupMenu(BX.proxy_context,"shareMenu")}else if(this.webrtc.phoneSupport()&&BX.proxy_context.getAttribute("data-entity")=="phoneCallHistory"){this.openPopupExternalData(BX.proxy_context,"phoneCallHistory",true,{ID:BX.proxy_context.getAttribute("data-historyID")})}},this));BX.bindDelegate(this.popupMessengerBodyWrap,"click",{className:"bx-messenger-command"},BX.delegate(function(){if(BX.proxy_context.getAttribute("data-entity")=="send"){this.BXIM.sendMessage(this.currentTab,BX.proxy_context.nextSibling.innerHTML)}else if(BX.proxy_context.getAttribute("data-entity")=="put"){this.BXIM.putMessage(BX.proxy_context.nextSibling.innerHTML)}else if(BX.proxy_context.getAttribute("data-entity")=="call"){this.BXIM.phoneTo(BX.proxy_context.getAttribute("data-command"))}},this));BX.bindDelegate(this.popupMessengerBodyWrap,"click",{className:"bx-messenger-content-item-date"},BX.delegate(function(e){if(this.openLinesFlag&&BX.hasClass(BX.proxy_context.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-system")){this.tooltip(BX.proxy_context,BX.message("IM_TIP_OL_SYSTEM"),{offsetLeft:48})}BX.PreventDefault(e)},this));BX.bind(this.popupMessengerBody,"scroll",BX.delegate(function(e){if(this.unreadMessage[this.currentTab]&&this.unreadMessage[this.currentTab].length>0&&BX.MessengerCommon.isScrollMax(this.popupMessengerBody,200)&&this.BXIM.isFocus()){clearTimeout(this.readMessageTimeout);this.readMessageTimeout=setTimeout(BX.delegate(function(){BX.MessengerCommon.readMessage(this.currentTab)},this),100)}BX.MessengerCommon.redrawDateMarks();BX.MessengerCommon.loadHistory(this.currentTab,false);if(this.popupPopupMenu!=null){if(this.popupPopupMenuDateCreate+500<+new Date&&BX.util.in_array(this.popupPopupMenu.uniquePopupId.replace("bx-messenger-popup-",""),["copypaste","copylink","dialogContext","dialogMenu","external-data"])){this.popupPopupMenu.close()}else if(false&&BX.util.in_array(this.popupPopupMenu.uniquePopupId.replace("bx-messenger-popup-",""),["dialogMenu","external-data"])){this.popupPopupMenu.adjustPosition()}}if(this.popupChatUsers!=null&&this.popupChatUsers.uniquePopupId.replace("bx-messenger-popup-","")=="like-users"){this.popupChatUsers.close()}if(this.popupTooltip!=null){this.popupTooltip.close()}},this));BX.bindDelegate(this.popupMessengerBodyWrap,"click",{className:"bx-messenger-content-item-error"},BX.delegate(BX.MessengerCommon.sendMessageRetry,BX.MessengerCommon));if(e==0){this.extraOpen(BX.create("div",{props:{className:"bx-messenger-box-hello-wrap"},children:[BX.create("div",{props:{className:"bx-messenger-box-hello"},html:BX.message("IM_M_EMPTY")})]}))}else if(!BX.MessengerCommon.isPopupPage()){BX.MessengerCommon.openDialog(e)}s.resolve();return s};BX.MessengerChat.prototype.closeMessenger=function(){if(!this.popupMessenger||this.BXIM.callController.hasActiveCall()||BX.MessengerCommon.isPopupPage()&&BX.MessengerSlider.count()>1){return false}if(this.BXIM.popupSettings!=null)this.BXIM.popupSettings.close();this.closeMenuPopup();this.popupMessenger=null;BX.remove(this.popupMessengerContent);this.popupMessengerContent=null;this.mentionListen=false;this.mentionDelimiter="";this.BXIM.extraOpen=false;this.BXIM.dialogOpen=false;this.BXIM.notifyOpen=false;clearTimeout(this.popupMessengerDesktopTimeout);this.setUpdateStateStep();BX.unbind(document,"click",BX.proxy(this.BXIM.autoHide,this.BXIM));BX.unbind(window,"keydown",BX.proxy(this.closePopupFileMenuKeydown,this));if(BX.MessengerCommon.isPage()){BX.MessengerWindow.currentTab=""}return true};BX.MessengerChat.prototype.openMessengerPanel=function(){if(!this.popupMessengerBodyPanel)return false;this.popupMessengerPanelOpen=true;this.popupMessengerBody.style.width="calc(100% - 400px)";this.popupMessengerTextareaPlace.style.width="calc(100% - 400px)";this.popupMessengerBodyPanel.style.height=this.popupMessengerBodyDialog.offsetHeight+"px";this.popupMessengerBodyPanel.style.right="0";return true};BX.MessengerChat.prototype.closeMessengerPanel=function(){if(!this.popupMessengerBodyPanel)return false;this.popupMessengerPanelOpen=false;this.popupMessengerBody.style.removeProperty("width");this.popupMessengerTextareaPlace.style.removeProperty("width");this.popupMessengerBodyPanel.style.removeProperty("right");return true};BX.MessengerChat.prototype.enterFullScreen=function(){if(this.messengerFullscreenStatus){if(document.cancelFullScreen)document.cancelFullScreen();else if(document.mozCancelFullScreen)document.mozCancelFullScreen();else if(document.webkitCancelFullScreen)document.webkitCancelFullScreen()}else{if(BX.browser.IsChrome()||BX.browser.IsSafari()){this.popupMessengerContent.webkitRequestFullScreen(this.popupMessengerContent.ALLOW_KEYBOARD_INPUT);BX.bind(window,"webkitfullscreenchange",this.messengerFullscreenBind=BX.proxy(this.eventFullScreen,this))}else if(BX.browser.IsFirefox()){this.popupMessengerContent.mozRequestFullScreen(this.popupMessengerContent.ALLOW_KEYBOARD_INPUT);BX.bind(window,"mozfullscreenchange",this.messengerFullscreenBind=BX.proxy(this.eventFullScreen,this))}}};BX.MessengerChat.prototype.eventFullScreen=function(e){if(this.messengerFullscreenStatus){if(BX.browser.IsChrome()||BX.browser.IsSafari())BX.unbind(window,"webkitfullscreenchange",this.messengerFullscreenBind);else if(BX.browser.IsFirefox())BX.unbind(window,"mozfullscreenchange",this.messengerFullscreenBind);BX.removeClass(this.popupMessengerContent,"bx-messenger-fullscreen");if(BX.browser.IsChrome()){BX.addClass(this.popupMessengerContent,"bx-messenger-fullscreen-chrome-hack");setTimeout(BX.delegate(function(){BX.removeClass(this.popupMessengerContent,"bx-messenger-fullscreen-chrome-hack")},this),100)}this.messengerFullscreenStatus=false;this.resizeMainWindow();this.popupMessenger.adjustPosition()}else{BX.addClass(this.popupMessengerContent,"bx-messenger-fullscreen");this.messengerFullscreenStatus=true;this.resizeMainWindow();if(BX.browser.IsChrome()){setTimeout(BX.delegate(function(){this.resizeMainWindow()},this),100)}}this.popupMessengerBody.scrollTop=this.popupMessengerBody.scrollHeight-this.popupMessengerBody.offsetHeight};BX.MessengerChat.prototype.tooltip=function(e,t,s){if(this.tooltipIsOpen())this.popupTooltip.close();s=s||{};s.offsetLeft=s.offsetLeft||0;s.offsetTop=s.offsetTop||BX.MessengerCommon.isDesktop()?0:-10;s.width=s.width||0;s.angle=typeof s.angle=="undefined"?true:s.angle;s.showOnce=typeof s.showOnce=="undefined"?false:s.showOnce;s.bindOptions=typeof s.bindOptions=="undefined"?{position:"top"}:s.bindOptions;if(s.showOnce){if(this.tooltipShowed[s.showOnce]){return true}else{BX.userOptions.save("im","tooltipShowed",s.showOnce,1);this.tooltipShowed[s.showOnce]=1}}var i=null;if(typeof t=="object"){i=BX.create("div",{props:{className:"bx-messenger-tooltip",style:"padding-right: 5px;"+(s.width>0?"width: "+s.width+"px;":"")},children:[t]})}else{i=BX.create("div",{props:{className:"bx-messenger-tooltip",style:"padding-right: 5px;"+(s.width>0?"width: "+s.width+"px;":"")},html:t})}this.popupTooltip=new BX.PopupWindow("bx-messenger-tooltip",e,{lightShadow:true,autoHide:true,darkMode:true,offsetLeft:s.offsetLeft,offsetTop:s.offsetTop,closeIcon:{},bindOptions:s.bindOptions,events:{onPopupClose:function(){this.destroy()},onPopupDestroy:BX.delegate(function(){this.popupTooltip=null},this)},zIndex:BX.MessengerCommon.getDefaultZIndex()+200,content:i});if(s.angle&&!this.BXIM.settings.enableDarkTheme){this.popupTooltip.setAngle({offset:23,position:s.bindOptions.position=="top"?"bottom":"top"})}this.popupTooltip.show();return true};BX.MessengerChat.prototype.tooltipIsOpen=function(){return this.popupTooltip!=null};BX.MessengerChat.prototype.tooltipClose=function(){if(this.tooltipIsOpen())this.popupTooltip.close()};BX.MessengerChat.prototype.dialogStatusRedraw=function(e){if(this.popupMessenger==null)return false;e=e||{};this.popupMessengerPanelButtonCall1.className=this.callButtonStatus(this.currentTab).class;this.popupMessengerPanelButtonCall1.firstElementChild.innerText=this.callButtonStatus(this.currentTab).name;this.popupMessengerPanelButtonCall2.className=this.callButtonStatus(this.currentTab).class;this.popupMessengerPanelButtonCall2.firstElementChild.innerText=this.callButtonStatus(this.currentTab).name;this.popupMessengerPanelButtonCall3.className=this.phoneButtonStatus();if(this.popupMessengerFileButton)BX.show(this.popupMessengerFileButton);this.popupMessengerPanel.className=this.openChatFlag?"bx-messenger-panel bx-messenger-context-user bx-messenger-hide":"bx-messenger-panel bx-messenger-context-user";clearInterval(this.popupMessengerPanelLastDateInterval);if(this.openChatFlag){this.textareaIconToggle();this.redrawChatHeader(e)}else if(this.users[this.currentTab]){BX.style(this.popupOpenLinesSpam,"display","");if(this.popupMessengerFileFormChatId){this.popupMessengerFileFormChatId.value=this.userChat[this.currentTab]?this.userChat[this.currentTab]:0;if(parseInt(this.popupMessengerFileFormChatId.value)>0){this.popupMessengerFileFormInput.removeAttribute("disabled")}else{this.popupMessengerFileFormInput.setAttribute("disabled",true)}}if(this.openChatFlag){this.popupMessengerPanelMute.title=this.muteButtonStatus(this.currentTab)?BX.message("IM_M_CHAT_MUTE_ON_2"):BX.message("IM_M_CHAT_MUTE_OFF_2")}else{this.popupMessengerPanelMute.title=this.muteButtonStatus(this.currentTab)?BX.message("IM_M_USER_BLOCK_OFF"):BX.message("IM_M_USER_BLOCK_ON")}this.popupMessengerPanelMute.className="bx-messenger-panel-button bx-messenger-panel-mute "+(this.muteButtonStatus(this.currentTab)?" bx-messenger-panel-unmute":"");this.popupMessengerPanelAvatar.parentNode.href=this.users[this.currentTab].profile;this.popupMessengerPanelAvatar.parentNode.className="bx-messenger-panel-avatar bx-messenger-panel-avatar-status-"+BX.MessengerCommon.getUserStatus(this.users[this.currentTab]);this.popupMessengerPanelAvatar.parentNode.title=BX.MessengerCommon.getUserStatus(this.users[this.currentTab],false).title;this.popupMessengerPanelAvatar.src=this.users[this.currentTab].avatar?this.users[this.currentTab].avatar:this.BXIM.pathToBlankImage;this.popupMessengerPanelAvatar.className="bx-messenger-panel-avatar-img"+(BX.MessengerCommon.isBlankAvatar(this.popupMessengerPanelAvatar.src)?" bx-messenger-panel-avatar-img-default":"");BX.style(this.popupMessengerPanelAvatar,"background-color",BX.MessengerCommon.isBlankAvatar(this.popupMessengerPanelAvatar.src)&&this.users[this.currentTab].color?this.users[this.currentTab].color:"");this.popupMessengerPanelTitle.href=this.users[this.currentTab].profile;this.popupMessengerPanelTitle.innerHTML=this.users[this.currentTab].name;if(this.BXIM.userId==this.currentTab){this.popupMessengerPanelTitle.innerHTML=this.popupMessengerPanelTitle.innerHTML+" (<b><i>"+BX.message("IM_YOU")+"</i></b>)"}var t=BX.delegate(function(){if(!this.popupMessengerPanelLastDate||this.currentTab&&this.currentTab.toString().substr(0,4)=="chat")return false;var e=BX.MessengerCommon.getUserLastDate(this.users[this.currentTab]);this.popupMessengerPanelLastDate.innerHTML=e?". "+e:"";return true},this);t();this.popupMessengerPanelLastDateInterval=setInterval(t,6e4);this.popupMessengerPanelStatus.innerHTML=BX.MessengerCommon.getUserPosition(this.users[this.currentTab],false);var s=[];if(this.users[this.currentTab].extranet){if(this.users[this.currentTab].network){BX.addClass(this.popupMessengerDialog,"bx-messenger-dialog-network");BX.addClass(this.popupMessengerPanelTitle,"bx-messenger-user-network");BX.removeClass(this.popupMessengerPanelTitle,"bx-messenger-user-extranet");s.push("bx-messenger-dialog-extranet")}else{BX.addClass(this.popupMessengerDialog,"bx-messenger-dialog-extranet");BX.addClass(this.popupMessengerPanelTitle,"bx-messenger-user-extranet");BX.removeClass(this.popupMessengerPanelTitle,"bx-messenger-user-network");s.push("bx-messenger-dialog-network")}BX.removeClass(this.popupMessengerPanelTitle,"bx-messenger-user-support24");BX.removeClass(this.popupMessengerPanelTitle,"bx-messenger-user-bot");s.push("bx-messenger-chat-livechat");s.push("bx-messenger-chat-lines");s.push("bx-messenger-chat-lines-imessage");s.push("bx-messenger-dialog-bot");s.push("bx-messenger-dialog-self");s.push("bx-messenger-dialog-support24")}else if(this.users[this.currentTab].bot){if(this.bot[this.currentTab]&&this.bot[this.currentTab].type=="support24"){BX.addClass(this.popupMessengerPanelTitle,"bx-messenger-user-support24");BX.addClass(this.popupMessengerDialog,"bx-messenger-dialog-support24");BX.removeClass(this.popupMessengerPanelTitle,"bx-messenger-user-bot");BX.removeClass(this.popupMessengerDialog,"bx-messenger-dialog-bot");s.push("bx-messenger-dialog-bot");s.push("bx-messenger-dialog-network")}else if(this.bot[this.currentTab]&&this.bot[this.currentTab].type=="network"){BX.addClass(this.popupMessengerPanelTitle,"bx-messenger-user-network");BX.addClass(this.popupMessengerDialog,"bx-messenger-dialog-network");BX.removeClass(this.popupMessengerPanelTitle,"bx-messenger-user-bot");BX.removeClass(this.popupMessengerPanelTitle,"bx-messenger-user-support24");s.push("bx-messenger-dialog-bot");s.push("bx-messenger-dialog-support24")}else{BX.addClass(this.popupMessengerPanelTitle,"bx-messenger-user-bot");BX.addClass(this.popupMessengerDialog,"bx-messenger-dialog-bot");BX.removeClass(this.popupMessengerPanelTitle,"bx-messenger-user-network");BX.removeClass(this.popupMessengerPanelTitle,"bx-messenger-user-support24");s.push("bx-messenger-dialog-network");s.push("bx-messenger-dialog-support24")}BX.removeClass(this.popupMessengerPanelTitle,"bx-messenger-user-extranet");s.push("bx-messenger-chat-livechat");s.push("bx-messenger-chat-lines");s.push("bx-messenger-chat-lines-imessage");s.push("bx-messenger-dialog-extranet");s.push("bx-messenger-dialog-self");this.popupMessengerPanelBotIcons=true}else{BX.removeClass(this.popupMessengerPanelTitle,"bx-messenger-user-extranet");BX.removeClass(this.popupMessengerPanelTitle,"bx-messenger-user-bot");BX.removeClass(this.popupMessengerPanelTitle,"bx-messenger-user-network");BX.removeClass(this.popupMessengerPanelTitle,"bx-messenger-user-support24");s.push("bx-messenger-dialog-bot");s.push("bx-messenger-dialog-network");s.push("bx-messenger-dialog-support24");s.push("bx-messenger-chat-livechat");s.push("bx-messenger-chat-lines");s.push("bx-messenger-chat-lines-imessage");s.push("bx-messenger-dialog-extranet");if(this.BXIM.userId==this.currentTab){BX.addClass(this.popupMessengerDialog,"bx-messenger-dialog-self")}else{s.push("bx-messenger-dialog-self")}}this.popupMessengerTextarea.disabled=false;this.textareaIconToggle();s.push("bx-messenger-chat-guest");s.push("bx-messenger-chat-open");s.push("bx-messenger-chat-chat");s.push("bx-messenger-chat-call");s.push("bx-messenger-chat-general");s.push("bx-messenger-chat-general-first-open");s.push("bx-messenger-chat-general-access");s.push("bx-messenger-chat-announcement");s.push("bx-messenger-chat-announcement-access");BX.removeClass(this.popupMessengerDialog,s.join(" "))}return true};BX.MessengerChat.prototype.muteButtonStatus=function(e){var t=0;if(e.toString().substr(0,4)=="chat"){t=e.toString().substr(4)}else{t=this.userChat[e]}return this.userChatBlockStatus[t]&&this.userChatBlockStatus[t][this.BXIM.userId]};BX.MessengerChat.prototype.callButton=function(e){var t=null;if(e=="call"){t=BX.create("span",{props:{className:this.phoneButtonStatus()},children:[BX.create("a",{attrs:{href:"javascript:void(0);",title:BX.message("IM_PHONE_CALL")},props:{className:"bx-messenger-panel-button bx-messenger-panel-call-audio"},events:{click:BX.delegate(function(e){if(BX.MessengerCalls.hasActiveCall())return false;var t=this.chat[this.getChatId()];if(t.call_number){this.BXIM.phoneTo(t.call_number)}else{this.webrtc.openKeyPad()}BX.PreventDefault(e)},this)},html:BX.message("IM_PHONE_CALL")})]})}else{var s=this.callButtonStatus(this.currentTab);t=BX.create("span",{props:{className:s.class},children:[BX.create("a",{attrs:{href:"javascript:void(0);",title:BX.message("IM_M_CALL_VIDEO_HD")},props:{className:"bx-messenger-panel-button bx-messenger-panel-call-video"},events:{click:BX.delegate(function(e){if(this.openChatFlag&&this.chat[this.currentTab.substr(4)].type==="videoconf"){BXIM.openVideoconfByUrl(BX.MessengerCommon.getVideoconfLink(this.currentTab))}else if(!BX.MessengerCalls.hasActiveCall()){if(this.BXIM.checkCallSupport(this.currentTab)){this.BXIM.callTo(this.currentTab,true)}else{this.openPopupMenu(BX.proxy_context,"callMenu")}}BX.PreventDefault(e)},this)},html:s.name}),BX.create("a",{attrs:{href:"javascript:void(0);"},props:{className:"bx-messenger-panel-call-menu"},events:{click:BX.delegate(function(e){if(this.openChatFlag&&this.chat[this.currentTab.substr(4)].type==="videoconf"){this.openPopupMenu(BX.proxy_context,"videoConfMenu",true,{chatId:this.currentTab.substr(4)})}else if(!BX.MessengerCalls.hasActiveCall()){this.openPopupMenu(BX.proxy_context,"callMenu")}BX.PreventDefault(e)},this)}})]})}return t};BX.MessengerChat.prototype.changeVideoconfCode=function(e){e=e.toString();BX.rest.callMethod("im.videoconf.share.change",{DIALOG_ID:e}).then(function(e){console.warn("rest-method result",e)})};BX.MessengerChat.prototype.callButtonStatus=function(e){e=e.toString();var t="bx-messenger-panel-button-box bx-messenger-panel-call-hide";var s=BX.message("IM_M_CALL_VIDEO_HD");var i="private";if(e.startsWith("chat")&&this.chat[e.substr(4)]){i=this.chat[e.substr(4)].type}if(i!=="private"&&(this.chat[e.substr(4)].type=="lines"||this.chat[e.substr(4)].type=="livechat"||this.chat[e.substr(4)].type=="announcement")){}else if(this.BXIM.ppServerStatus&&(!this.users[e]||!this.users[e].network)){if(!this.BXIM.checkCallSupport(e)){if(this.BXIM.zoomStatus["active"]){t="bx-messenger-panel-button-box bx-messenger-panel-call-enabled bx-messenger-panel-call-services"}else{t="bx-messenger-panel-button-box bx-messenger-panel-call-blocked"}}else if(i!=="videoconf"&&BX.MessengerCalls.hasActiveCall()){t="bx-messenger-panel-button-box bx-messenger-panel-call-disabled"}else{t="bx-messenger-panel-button-box bx-messenger-panel-call-enabled"}}if(i==="videoconf"){s=BX.message("IM_M_CALL_VIDEOCONF")}return{class:t,name:s}};BX.MessengerChat.prototype.phoneButtonStatus=function(){var e="bx-messenger-panel-call-hide";if(this.BXIM.ppServerStatus)e=this.webrtc.phoneSupport()&&this.webrtc.phoneCanPerformCalls?"bx-messenger-panel-call-enabled":"bx-messenger-panel-call-disabled";return"bx-messenger-panel-call-phone "+e};BX.MessengerChat.prototype.chatListSearchAction=function(e){this.realSearch=true;this.popupContactListElementsWrap.appendChild(BX.create("div",{props:{className:"bx-messenger-cl-item-search"},html:BX.message("IM_M_CL_SEARCH")}));BX.remove(e);BX.MessengerCommon.contactListRealSearch(this.contactListSearchText)};BX.MessengerChat.prototype.toggleChatListGroup=function(){if(BX.hasClass(BX.proxy_context.parentNode.parentNode,"bx-messenger-chatlist-show-all")){this.contactListShowed[BX.proxy_context.getAttribute("data-id")]=false;BX.proxy_context.innerHTML=BX.proxy_context.getAttribute("data-text");BX.removeClass(BX.proxy_context.parentNode.parentNode,"bx-messenger-chatlist-show-all");if(this.popupContactListElements){var e=BX.pos(BX.proxy_context,true);this.popupContactListElements.scrollTop=e.top-100}}else{this.contactListShowed[BX.proxy_context.getAttribute("data-id")]=true;BX.proxy_context.innerHTML=BX.message("IM_CL_HIDE");BX.addClass(BX.proxy_context.parentNode.parentNode,"bx-messenger-chatlist-show-all")}};BX.MessengerChat.prototype.openVideoConfCreateForm=function(){this.videoconfCreateForm=BX.create("div",{props:{className:"bx-messenger-videoconf-create-box"},children:[BX.create("div",{props:{className:"bx-messenger-videoconf-create"}})]});this.extraOpen(this.videoconfCreateForm);var e=this;BX.Vue.create({el:".bx-messenger-videoconf-create",template:"<div v-if='show' class='bx-messenger-videoconf-create-wrap'>"+"<div class='bx-messenger-videoconf-create-icon'></div>"+"<div class='bx-messenger-videoconf-create-title'>{{ this.localize['IM_CL_VIDEOCONF_CREATE_TITLE'] }}</div>"+"<div class='bx-messenger-videoconf-create-desc-first'>{{ this.localize['IM_CL_VIDEOCONF_CREATE_DESC_1'] }}</div>"+"<div class='bx-messenger-videoconf-create-desc-second'>{{ this.localize['IM_CL_VIDEOCONF_CREATE_DESC_2'] }}</div>"+"<div class='bx-messenger-videoconf-create-actions'>"+"<button @click='getLink' id='bx-messenger-videoconf-create-link-button' :class='buttonGetLinkClass'>{{ this.localize['IM_CL_VIDEOCONF_CREATE_BUTTON_GET_LINK'] }}</button>"+"<button @click='startMessaging' :class='buttonStartMessagingClass'>{{ this.localize['IM_CL_VIDEOCONF_CREATE_BUTTON_START_MESSAGING'] }}</button>"+"</div>"+"<div v-if='!callsAreAvailable' class='bx-messenger-videoconf-create-error'>"+"<div class='bx-messenger-videoconf-create-error-title'>{{ this.localize['IM_CL_VIDEOCONF_CREATE_ERROR_TITLE'] }}</div>"+"<a v-if='bxHelperAvailable' @click='openHelpArticle(\"cant_create\")' class='bx-messenger-videoconf-create-error-link'>{{ this.localize['IM_CL_VIDEOCONF_CREATE_ERROR_LINK'] }}</a>"+"</div>"+"<div v-else-if='!serverCallsAreAvailable' class='bx-messenger-videoconf-create-warning'>"+"<div class='bx-messenger-videoconf-create-error-title'>{{ this.localize['IM_CL_VIDEOCONF_CREATE_SERVER_CALL_WARNING'] }}</div>"+"<a v-if='bxHelperAvailable' @click='openHelpArticle(\"no_server_calls\")' class='bx-messenger-videoconf-create-error-link'>{{ this.localize['IM_CL_VIDEOCONF_CREATE_ERROR_LINK'] }}</a>"+"</div>"+"</div>",data:function(){return{show:true,isLoadingLink:false,isStartingChat:false,publicLink:"",chatId:0,callsAreAvailable:true,serverCallsAreAvailable:true,bxHelperAvailable:true,helpArticleCodeCantCreate:11380674,helpArticleCodeNoServer:11392174}},beforeCreate:function(){this.context=e},created:function(){if(!this.context.BXIM.ppServerStatus||!BX.Call.Util.isWebRTCSupported()||!BX.PULL.isPublishingEnabled()){this.callsAreAvailable=false}if(!BX.Call.Util.isCallServerAllowed()){this.serverCallsAreAvailable=false}if(!BX.Helper){this.bxHelperAvailable=false}},mounted:function(){},destroyed:function(){},computed:{buttonGetLinkClass:function(){return["bx-messenger-videoconf-create-button","ui-btn","ui-btn-sm","ui-btn-default","ui-btn-no-caps",{"ui-btn-wait":this.isLoadingLink},{"ui-btn-disabled":!this.callsAreAvailable||this.isLoadingLink}]},buttonStartMessagingClass:function(){return["bx-messenger-videoconf-create-button","ui-btn","ui-btn-sm","ui-btn-success-dark","ui-btn-no-caps","ui-btn-icon-chat",{"ui-btn-wait":this.isStartingChat},{"ui-btn-disabled":!this.callsAreAvailable||this.isStartingChat}]},localize:function(){return{IM_CL_VIDEOCONF_CREATE_TITLE:BX.message("IM_CL_VIDEOCONF_CREATE_TITLE"),IM_CL_VIDEOCONF_CREATE_DESC_1:BX.message("IM_CL_VIDEOCONF_CREATE_DESC_1"),IM_CL_VIDEOCONF_CREATE_DESC_2:BX.message("IM_CL_VIDEOCONF_CREATE_DESC_2"),IM_CL_VIDEOCONF_CREATE_BUTTON_GET_LINK:BX.message("IM_CL_VIDEOCONF_CREATE_BUTTON_GET_LINK"),IM_CL_VIDEOCONF_CREATE_BUTTON_START_MESSAGING:BX.message("IM_CL_VIDEOCONF_CREATE_BUTTON_START_MESSAGING"),IM_CL_VIDEOCONF_CREATE_LINK_POPUP_DESC:BX.message("IM_CL_VIDEOCONF_CREATE_LINK_POPUP_DESC"),IM_CL_VIDEOCONF_CREATE_ERROR_TITLE:BX.message("IM_CL_VIDEOCONF_CREATE_ERROR_TITLE"),IM_CL_VIDEOCONF_CREATE_ERROR_LINK:BX.message("IM_CL_VIDEOCONF_CREATE_ERROR_LINK"),IM_CL_VIDEOCONF_CREATE_SERVER_CALL_WARNING:BX.message("IM_CL_VIDEOCONF_CREATE_SERVER_CALL_WARNING")}}},methods:{startMessaging:function(){if(!this.publicLink&&!this.chatId){this.isStartingChat=true;var e={};e[this.context.BXIM.userId]={id:this.context.BXIM.userId};this.context.createChat("videoconf",e).then(function(e){console.warn("result from startMessaging",e);this.publicLink=e.PUBLIC_LINK;this.chatId=e.CHAT_ID;this.isStartingChat=false;this.show=false;this.context.videoConfCreateLinkPopup.close();this.context.openMessenger("chat"+this.chatId)}.bind(this))}else{this.show=false;this.context.videoConfCreateLinkPopup.close();this.context.openMessenger("chat"+this.chatId)}},getLink:function(){if(!this.publicLink&&!this.chatId){this.isLoadingLink=true;var e={};e[this.context.BXIM.userId]={id:this.context.BXIM.userId};this.context.createChat("videoconf",e).then(function(e){console.warn("result from getLink",e.CHAT_ID);this.publicLink=e.PUBLIC_LINK;this.chatId=e.CHAT_ID;BX.MessengerCommon.clipboardCopy(this.publicLink);if(!this.context.videoConfCreateLinkPopup){console.warn("Error: no popup");return false}var t=document.querySelector(".bx-messenger-videoconf-link-popup-input");if(t){t.value=this.publicLink;BX.removeClass(this.context.videoConfCreateLinkPopuCopy,"ui-btn-icon-done");this.context.videoConfCreateLinkPopup.show();this.isLoadingLink=false}}.bind(this))}else{document.querySelector(".bx-messenger-videoconf-link-popup-input").value=this.publicLink;BX.removeClass(this.context.videoConfCreateLinkPopuCopy,"ui-btn-icon-done");this.context.videoConfCreateLinkPopup.show()}},openHelpArticle:function(e){if(BX.Helper){var t=0;if(e==="cant_create"){t=this.helpArticleCodeCantCreate}else if(e==="no_server_calls"){t=this.helpArticleCodeNoServer}BX.Helper.show("redirect=detail&code="+t)}}}});if(this.videoConfCreateLinkPopup){this.videoConfCreateLinkPopup.destroy()}var t=document.getElementById("bx-messenger-videoconf-create-link-button");this.videoConfCreateLinkPopup=new BX.PopupWindow("bx-messenger-videoconf-link-popup",t,{content:BX.create("div",{props:{className:"bx-messenger-videoconf-link-popup-wrap"},children:[BX.create("div",{props:{className:"bx-messenger-videoconf-link-popup-desc"},html:BX.message("IM_CL_VIDEOCONF_CREATE_LINK_POPUP_DESC")}),BX.create("input",{props:{className:"bx-messenger-videoconf-link-popup-input"}}),this.videoConfCreateLinkPopuCopy=BX.create("button",{props:{className:"ui-btn ui-btn-sm ui-btn-success-dark ui-btn-no-caps"},html:BX.message("IM_CL_VIDEOCONF_CREATE_LINK_POPUP_COPY")})]}),offsetTop:10,offsetLeft:t.offsetWidth/2-160,autoHide:true,closeByEsc:true,darkMode:this.BXIM.settings.enableDarkTheme});BX.bind(this.videoConfCreateLinkPopuCopy,"click",BX.delegate(function(){var e=document.querySelector(".bx-messenger-videoconf-link-popup-input");e.focus();e.select();document.execCommand("copy");BX.addClass(this.videoConfCreateLinkPopuCopy,"ui-btn-icon-done")},this))};BX.MessengerChat.prototype.openChatCreateForm=function(e){this.currentTab="create";var t=[];var s="";var i="";if(e=="chat"){s="#49afdf";t=[BX.create("div",{props:{className:"bx-messenger-box-create-icon bx-messenger-box-create-icon-"+e},children:[BX.create("div",{props:{className:"bx-messenger-box-create-icon-image"}})]}),BX.create("div",{props:{className:"bx-messenger-box-create-title"},html:BX.message("IM_CL_CHAT_NEW")}),BX.create("div",{props:{className:"bx-messenger-box-create-text"},html:BX.message(this.BXIM.bitrixIntranet?"IM_C_ABOUT_CHAT":"IM_C_ABOUT_CHAT_CHAT").split("#BR#").join("<br />").replace("#PROFILE_END#","</a>").replace("#PROFILE_START#",'<a href="'+BXIM.path.profile+'edit/">')})]}else if(e=="open"&&(!this.BXIM.userExtranet||this.openChatEnable)){s="#a7c131";t=[BX.create("div",{props:{className:"bx-messenger-box-create-icon bx-messenger-box-create-icon-"+e},children:[BX.create("div",{props:{className:"bx-messenger-box-create-icon-image"}})]}),BX.create("div",{props:{className:"bx-messenger-box-create-title"},html:BX.message("IM_CL_OPEN_CHAT_NEW")}),BX.create("div",{props:{className:"bx-messenger-box-create-text"},html:BX.message(this.BXIM.bitrixIntranet?"IM_C_ABOUT_OPEN_NEW":"IM_C_ABOUT_OPEN_SITE_NEW").split("#BR#").join("<br />").replace("#PROFILE_END#","</a>").replace("#PROFILE_START#",'<a href="'+BXIM.path.profile+'edit/">').replace("#CHAT_END#","</b>").replace("#CHAT_START#","<b>")})]}else{e="private";s=this.users[this.BXIM.userId].color;t=[BX.create("div",{props:{className:"bx-messenger-box-create-icon bx-messenger-box-create-icon-"+e},children:[BX.create("div",{props:{className:"bx-messenger-box-create-icon-image"}})]}),BX.create("div",{props:{className:"bx-messenger-box-create-title"},html:BX.message("IM_CL_PRIVATE_CHAT_NEW")}),BX.create("div",{props:{className:"bx-messenger-box-create-text"},html:BX.message(this.BXIM.bitrixIntranet?"IM_C_ABOUT_PRIVATE":"IM_C_ABOUT_PRIVATE_SITE").split("#BR#").join("<br />").replace("#PROFILE_END#","</a>").replace("#PROFILE_START#",'<a href="'+BXIM.path.profile+'edit/">')})]}if(this.chatCreateForm&&!BX.browser.IsIE11()){this.extraOpen(this.chatCreateForm);if(this.chatCreateFormAvatar.parentNode){this.chatCreateFormAvatar.parentNode.className="bx-messenger-panel-avatar bx-messenger-panel-avatar-"+e}BX.style(this.chatCreateFormAvatar,"background-color",s);this.chatCreateType=e;this.chatCreateUsers={};this.chatCreateFormDescription.innerHTML="";BX.adjust(this.chatCreateFormDescription,{children:t});BX.MessengerCommon.clearMentionList("create");this.chatCreateFormChatTitle.value="";this.chatCreateFormUsersInput.value="";this.chatCreateFormUsersDest.innerHTML="";this.popupCreateChatTextarea.value="";this.textareaCheckText({textarea:"createChat"});BX.style(this.chatCreateFormBody,"height",this.popupMessengerBodySize+"px");BX.style(this.popupCreateChatTextarea,"height",this.popupMessengerTextareaSize+"px");if(e=="open"){BX.addClass(this.chatCreateFormUsersInput.parentNode.parentNode,"bx-messenger-hide");BX.removeClass(this.chatCreateFormChatTitle.parentNode.parentNode,"bx-messenger-hide")}else{BX.addClass(this.chatCreateFormChatTitle.parentNode.parentNode,"bx-messenger-hide");BX.removeClass(this.chatCreateFormUsersInput.parentNode.parentNode,"bx-messenger-hide");BX.removeClass(this.chatCreateFormUsersInput,"bx-messenger-hide");BX.addClass(this.chatCreateFormUsersInput,"bx-messenger-input-dest-empty")}if(this.chatCreateUsers.length>0&&this.popupCreateChatTextarea.value.length>0){this.popupCreateChatTextarea.focus()}else{if(e=="open"){this.chatCreateFormChatTitle.focus()}else{this.chatCreateFormUsersInput.focus()}}}else{this.chatCreateType=e;this.chatCreateUsers={};BX.MessengerCommon.clearMentionList("create");this.chatCreateForm=BX.create("div",{props:{className:"bx-messenger-box-create"},children:[BX.create("div",{props:{className:"bx-messenger-panel"},children:[BX.create("div",{props:{className:"bx-messenger-panel-wrap"},children:[BX.create("div",{props:{className:"bx-messenger-panel-avatar bx-messenger-panel-avatar-"+e},children:[this.chatCreateFormAvatar=BX.create("img",{attrs:{src:this.BXIM.pathToBlankImage,style:"background-color: "+s},props:{className:"bx-messenger-panel-avatar-img bx-messenger-panel-avatar-img-default"}})]}),BX.create("span",{props:{className:"bx-messenger-panel-title bx-messenger-panel-create-chat "+(e=="open"?"bx-messenger-hide":"")},children:[BX.create("div",{props:{className:"bx-messenger-input-wrap bx-messenger-panel-create-input"},children:[this.chatCreateFormUsersDest=BX.create("span",{props:{className:"bx-messenger-dest-items"}}),this.chatCreateFormUsersInput=BX.create("input",{props:{className:"bx-messenger-input bx-messenger-input-dest-empty"},attrs:{type:"text",value:"",placeholder:BX.message("IM_C_PRIVATE_TITLE")}})]})]}),BX.create("span",{props:{className:"bx-messenger-panel-title bx-messenger-panel-create-chat "+(e!="open"?"bx-messenger-hide":"")},children:[BX.create("div",{props:{className:"bx-messenger-input-wrap bx-messenger-panel-create-input"},children:[this.chatCreateFormChatTitle=BX.create("input",{props:{className:"bx-messenger-input bx-messenger-input-dest-empty"},attrs:{type:"text",value:"",placeholder:BX.message("IM_C_CHAT_TITLE_NEW")}})]})]})]})]}),BX.create("div",{props:{className:"bx-messenger-body-dialog"},children:[this.chatCreateFormBody=BX.create("div",{props:{className:"bx-messenger-body"},style:{height:this.popupMessengerBodySize+"px"},children:[BX.create("div",{props:{className:"bx-messenger-box-create-desc"},children:[this.chatCreateFormDescription=BX.create("div",{props:{className:"bx-messenger-box-create-desc-wrap"},children:t})]})]}),BX.create("div",{props:{className:"bx-messenger-textarea-place"},children:[BX.create("div",{props:{className:"bx-messenger-textarea-resize"}}),BX.create("div",{props:{className:"bx-messenger-textarea-send"},children:[BX.create("a",{attrs:{href:"javascript:void(0);"},props:{className:"bx-messenger-textarea-send-button"},events:{click:BX.delegate(function(){this.createChat(this.chatCreateType,this.chatCreateUsers,this.popupCreateChatTextarea.value)},this)}}),BX.create("span",{attrs:{title:BX.message("IM_M_SEND_TYPE_TITLE")},props:{className:"bx-messenger-textarea-cntr-enter"},html:this.BXIM.settings.sendByEnter?"Enter":BX.browser.IsMac()?"&#8984;+Enter":"Ctrl+Enter",events:{click:BX.delegate(function(){this.BXIM.settings.sendByEnter=this.BXIM.settings.sendByEnter?false:true;this.BXIM.saveSettings({sendByEnter:this.BXIM.settings.sendByEnter});BX.proxy_context.innerHTML=this.BXIM.settings.sendByEnter?"Enter":BX.browser.IsMac()?"&#8984;+Enter":"Ctrl+Enter";this.popupMessengerTextareaSendType.innerHTML=BX.proxy_context.innerHTML},this)}})]}),BX.create("div",{props:{className:"bx-messenger-textarea-icons"},children:[BX.create("div",{attrs:{title:BX.message("IM_SMILE_MENU")},props:{className:"bx-messenger-textarea-smile"},events:{click:BX.delegate(function(e){this.openSmileMenu({textarea:"createChat",bind:e.currentTarget});return BX.PreventDefault(e)},this)}}),BX.create("div",{attrs:{title:BX.message("IM_MENTION_MENU_NEW")},props:{className:"bx-messenger-textarea-mention"},events:{click:BX.delegate(function(e){this.openMentionDialog({delay:0,textarea:"createChat"});return BX.PreventDefault(e)},this)}}),!this.disk.enable?null:BX.create("div",{attrs:{title:BX.message("IM_F_UPLOAD_MENU")},props:{className:"bx-messenger-textarea-file"},events:{click:BX.delegate(function(e){this.BXIM.openConfirm(BX.message("IM_F_ERR_NC"))},this)}})]}),BX.create("div",{props:{className:"bx-messenger-textarea"},children:[this.popupCreateChatTextarea=BX.create("textarea",{props:{value:"",className:"bx-messenger-textarea-input"},style:{height:this.popupMessengerTextareaSize+"px"}}),BX.create("div",{props:{className:"bx-messenger-textarea-placeholder"},html:BX.message("IM_M_TA_TEXT")})]}),BX.create("div",{props:{className:"bx-messenger-textarea-clear"}})]})]})]});if(BX.MessengerCommon.isDesktop()){BX.bind(this.popupCreateChatTextarea,"contextmenu",BX.delegate(function(e){this.openPopupMenu(e,"copypaste",false,{spell:true});return BX.PreventDefault(e)},this))}BX.bind(this.popupCreateChatTextarea,"focus",BX.delegate(function(){this.textareaCheckText({textarea:"createChat"});this.setClosingByEsc(false);BX.addClass(this.popupCreateChatTextarea.parentNode,"bx-messenger-textarea-focus")},this));BX.bind(this.popupCreateChatTextarea,"blur",BX.delegate(function(){this.textareaCheckText({textarea:"createChat"});this.setClosingByEsc(true);BX.removeClass(this.popupCreateChatTextarea.parentNode,"bx-messenger-textarea-focus")},this));BX.bind(this.chatCreateFormChatTitle,"keydown",BX.delegate(function(e){this.textareaPrepareText(BX.proxy_context,e,BX.delegate(function(){this.createChat(this.chatCreateType,this.chatCreateUsers,this.popupCreateChatTextarea.value)},this),function(){})},this));BX.bind(this.chatCreateFormChatTitle,"keydown",BX.delegate(function(e){if(e.keyCode==9||e.keyCode==13){this.popupCreateChatTextarea.focus();return BX.PreventDefault(e)}},this));BX.bind(this.popupCreateChatTextarea,"keydown",BX.delegate(function(e){this.textareaPrepareText(BX.proxy_context,e,BX.delegate(function(){this.createChat(this.chatCreateType,this.chatCreateUsers,this.popupCreateChatTextarea.value)},this),function(){})},this));BX.bind(this.popupCreateChatTextarea,"keyup",BX.delegate(function(){this.textareaCheckText({textarea:"createChat"})},this));if(BX.MessengerCommon.isDesktop()){BX.bindDelegate(this.popupMessengerBodyWrap,"contextmenu",{className:"bx-messenger-content-item-content"},BX.delegate(function(e){this.openPopupMenu(e,"dialogContext",false);return BX.PreventDefault(e)},this))}this.extraOpen(this.chatCreateForm);if(e=="open"){this.chatCreateFormChatTitle.focus()}else{this.chatCreateFormUsersInput.focus();BX.bind(this.chatCreateFormUsersInput,"keyup",BX.delegate(function(e){if(!this.popupChatDialog&&this.chatCreateFormUsersInput.value.length>0){this.openChatDialog({type:"CHAT_CREATE",bind:this.chatCreateFormUsersInput,bindResult:this.chatCreateFormUsersDest,bindSearch:this.chatCreateFormUsersInput,bindUsersList:this.chatCreateUsers,skipBind:this.chatCreateFormSkipDialogBind});this.chatCreateFormSkipDialogBind=true}},this))}}};BX.MessengerChat.prototype.getChatId=function(){if(this.currentTab.toString().substr(0,4)==="chat"){return this.currentTab.toString().substr(4)}else{return this.userChat[this.currentTab]}};BX.MessengerChat.prototype.createChat=function(e,t,s){var i=new BX.Promise;if(this.BXIM.popupConfirm!=null){this.BXIM.popupConfirm.destroy();return false}if(e=="private"){var a=0;for(var n in t){a=t[n].id}if(a){this.openMessenger(a);this.popupMessengerTextarea.value=BX.MessengerCommon.prepareMention("create",s);this.sendMessage(a)}else{this.chatCreateFormUsersInput.focus();return false}}else{if(e=="open"){if(BX.util.trim(this.chatCreateFormChatTitle.value)==""){this.chatCreateFormChatTitle.focus();return false}this.sendRequestChatDialog({action:"CHAT_CREATE",type:"open",title:this.chatCreateFormChatTitle.value,message:BX.MessengerCommon.prepareMention("create",s)})}else if(e=="videoconf"){if(BX.MessengerCommon.countObject(t)<=0){this.chatCreateFormUsersInput.focus();return false}var o=[];for(var n in t){o.push(n)}var r={};var l=this.sendRequestChatDialog({action:"CHAT_CREATE",type:"videoconf",users:o,message:BX.MessengerCommon.prepareMention("create",s)});l.then(function(e){i.resolve(e)})}else{if(BX.MessengerCommon.countObject(t)<=0){this.chatCreateFormUsersInput.focus();return false}var o=[];for(var n in t)o.push(n);this.sendRequestChatDialog({action:"CHAT_CREATE",type:"chat",users:o,message:BX.MessengerCommon.prepareMention("create",s)})}}return i};BX.MessengerChat.prototype.kickFromChat=function(e,t){if(!this.chat[e]&&this.chat[e].owner!=this.BXIM.userId&&!this.userId[t])return false;BX.ajax({url:this.BXIM.pathToAjax+"?CHAT_LEAVE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{IM_CHAT_LEAVE:"Y",CHAT_ID:e,USER_ID:t,IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()},onsuccess:BX.delegate(function(e){if(e.ERROR==""){for(var s=0;s<this.userInChat[e.CHAT_ID].length;s++)if(this.userInChat[e.CHAT_ID][s]==t)delete this.userInChat[e.CHAT_ID][s];if(this.popupMessenger!=null)BX.MessengerCommon.userListRedraw();BX.localStorage.set("mclk",{chatId:e.CHAT_ID,userId:e.USER_ID},5)}},this)})};BX.MessengerChat.prototype.redrawChatHeader=function(e){if(!this.openChatFlag)return false;var t=this.getChatId();if(!this.chat[t])return false;e=e||{};e.userRedraw=e.userRedraw||true;if(this.popupMessengerFileFormChatId){this.popupMessengerFileFormChatId.value=t;if(parseInt(this.popupMessengerFileFormChatId.value)>0){this.popupMessengerFileFormInput.removeAttribute("disabled")}else{this.popupMessengerFileFormInput.setAttribute("disabled",true)}}if(this.popupMessengerFileFormChatId){this.popupMessengerFileFormChatId.value=t;if(parseInt(this.popupMessengerFileFormChatId.value)>0){this.popupMessengerFileFormInput.removeAttribute("disabled")}else{this.popupMessengerFileFormInput.setAttribute("disabled",true)}}this.renameChatDialogFlag=false;BX.style(this.popupOpenLinesSpam,"display","");BX.style(this.popupOpenLinesClose,"display","none");var s=[];var i=[];if(this.chat[t].type=="call"){this.popupMessengerPanelAvatar3.src=this.chat[t].avatar?this.chat[t].avatar:this.BXIM.pathToBlankImage;this.popupMessengerPanelAvatar3.className="bx-messenger-panel-avatar-img"+(BX.MessengerCommon.isBlankAvatar(this.popupMessengerPanelAvatar3.src)?" bx-messenger-panel-avatar-img-default":"");BX.style(this.popupMessengerPanelAvatar3,"background-color",BX.MessengerCommon.isBlankAvatar(this.popupMessengerPanelAvatar3.src)&&this.chat[t].color?this.chat[t].color:"");if(this.popupMessengerPanelCallTitle)this.popupMessengerPanelCallTitle.innerHTML=this.chat[t].name;if(this.popupMessengerPanelCallDescription)this.popupMessengerPanelCallDescription.innerText=this.chat[t]&&this.chat[t].entity_data_1&&this.chat[t].entity_data_1.toString().charAt(0)==="Y"?this.chat[t].call_number:BX.message("IM_PHONE_DESC");this.popupMessengerPanelAvatarId3.value=t;this.disk.avatarFormIsBlocked(t,"popupMessengerPanelAvatarUpload3",this.popupMessengerPanelAvatarForm3);this.popupMessengerPanelMute3.title=this.muteButtonStatus(this.currentTab)?BX.message("IM_M_CHAT_MUTE_ON_2"):BX.message("IM_M_CHAT_MUTE_OFF_2");this.popupMessengerPanelMute3.className="bx-messenger-panel-button bx-messenger-panel-mute "+(this.muteButtonStatus(this.currentTab)?" bx-messenger-panel-unmute":"");s.push("bx-messenger-chat-guest");s.push("bx-messenger-chat-open");s.push("bx-messenger-chat-lines");s.push("bx-messenger-chat-lines-imessage");s.push("bx-messenger-chat-crm");s.push("bx-messenger-chat-general");s.push("bx-messenger-chat-general-first-open");s.push("bx-messenger-chat-general-access");s.push("bx-messenger-chat-announcement");s.push("bx-messenger-chat-announcement-access");BX.style(this.popupOpenLinesTransfer,"display","none");BX.addClass(this.popupMessengerDialog,"bx-messenger-chat-call");BX.removeClass(this.popupMessengerDialog,s.join(" "));this.popupMessengerPanelChat.className="bx-messenger-panel bx-messenger-context-chat bx-messenger-hide";this.popupMessengerPanelCall.className="bx-messenger-panel bx-messenger-context-call"}else{this.popupMessengerPanelMute2.title=this.muteButtonStatus(this.currentTab)?BX.message("IM_M_CHAT_MUTE_ON_2"):BX.message("IM_M_CHAT_MUTE_OFF_2");this.popupMessengerPanelMute2.className="bx-messenger-panel-button bx-messenger-panel-mute "+(this.muteButtonStatus(this.currentTab)?" bx-messenger-panel-unmute":"");var a=BX.MessengerCommon.isBlankAvatar(this.popupMessengerPanelAvatar2.src);this.popupMessengerPanelAvatar2.src=this.chat[t].avatar?this.chat[t].avatar:this.BXIM.pathToBlankImage;this.popupMessengerPanelAvatar2.className="bx-messenger-panel-avatar-img"+(a?" bx-messenger-panel-avatar-img-default":"");BX.style(this.popupMessengerPanelAvatar2,"background-color",BX.MessengerCommon.isBlankAvatar(this.popupMessengerPanelAvatar2.src)&&this.chat[t].color?this.chat[t].color:"");if(this.popupMessengerPanelChatTitle.className.indexOf("bx-messenger-chat-edit")==-1){this.popupMessengerPanelChatTitle.innerHTML=this.chat[t].name}this.popupMessengerPanelAvatarId2.value=t;this.disk.avatarFormIsBlocked(t,"popupMessengerPanelAvatarUpload2",this.popupMessengerPanelAvatarForm2);this.popupMessengerPanelAvatarForm2.className="bx-messenger-panel-avatar";if(this.chat[t].type=="lines"||this.chat[t].type=="livechat"||this.chat[t].type=="chat"||this.chat[t].type=="announcement"||this.chat[t].type=="sonetGroup"||this.chat[t].entity_type=="CRM"||this.chat[t].type==="videoconf"){var n=false;var o=false;if(this.chat[t].type=="livechat"){var r=BX.MessengerCommon.livechatGetSession(t);BX.addClass(this.popupMessengerPanelAvatarForm2,"bx-messenger-panel-avatar-lines");BX.addClass(this.popupMessengerPanelAvatarForm2,"bx-messenger-panel-avatar-livechat");i.push("bx-messenger-chat-livechat");s.push("bx-messenger-chat-chat");s.push("bx-messenger-chat-announcement");s.push("bx-messenger-chat-announcement-access");s.push("bx-messenger-chat-lines-imessage");s.push("bx-messenger-chat-crm");BX.style(this.popupOpenLinesTransfer,"display","none")}else if(this.chat[t].type=="lines"){this.openLinesFlag=true;var r=BX.MessengerCommon.linesGetSession(this.chat[t]);BX.addClass(this.popupMessengerPanelAvatarForm2,"bx-messenger-panel-avatar-lines");BX.addClass(this.popupMessengerPanelAvatarForm2,"bx-messenger-panel-avatar-"+BX.MessengerCommon.linesGetSource(this.chat[t]));i.push("bx-messenger-chat-lines");if(BX.MessengerCommon.linesGetSession(this.chat[t]).connector==="imessage"){i.push("bx-messenger-chat-lines-imessage")}else{s.push("bx-messenger-chat-lines-imessage")}s.push("bx-messenger-chat-chat");s.push("bx-messenger-chat-announcement");s.push("bx-messenger-chat-announcement-access");s.push("bx-messenger-chat-livechat");s.push("bx-messenger-chat-crm");if(BX.MessengerCommon.isSessionBlocked(t)){n=true;o=true;BX.style(this.popupMessengerTextareaOpenLinesTransfer,"display","none");BX.style(this.popupMessengerTextareaOpenLinesAnswer,"display","none");BX.style(this.popupMessengerTextareaOpenLinesSkip,"display","inline-block");BX.MessengerCommon.hideLinesKeyboard();this.popupMessengerTextareaOpenLinesSkip.innerHTML=BX.message("IM_M_OL_CLOSE");this.popupMessengerTextareaOpenLinesText.innerHTML=BX.message("IM_OL_CHAT_BLOCK_"+r.blockReason)}if(!BX.MessengerCommon.userInChat(t)){n=true;o=true;BX.style(this.popupOpenLinesTransfer,"display","none");BX.style(this.popupMessengerTextareaOpenLinesTransfer,"display",r.id?"inline-block":"none");this.popupMessengerTextareaOpenLinesAnswer.innerHTML=r.id?BX.message("IM_OL_INVITE_JOIN_2"):BX.message("IM_OL_INVITE_JOIN");this.popupMessengerTextareaOpenLinesSkip.innerHTML=BX.message("IM_OL_INVITE_CLOSE");this.popupMessengerTextareaOpenLinesText.innerHTML=r.id?BX.message("IM_OL_INVITE_TEXT_JOIN"):BX.message("IM_OL_INVITE_TEXT_OPEN");if(BX.MessengerCommon.isSessionBlocked(t)){this.popupMessengerTextareaOpenLinesText.innerHTML=BX.message("IM_OL_CHAT_BLOCK_"+r.blockReason)}}else if(this.chat[t].owner==0){n=true;o=true;BX.style(this.popupOpenLinesTransfer,"display","none");BX.style(this.popupOpenLinesClose,"display","none");BX.style(this.popupMessengerTextareaOpenLinesTransfer,"display",r.id?"inline-block":"none");BX.style(this.popupMessengerTextareaOpenLinesAnswer,"display",r.id?"inline-block":"none");this.popupMessengerTextareaOpenLinesAnswer.innerHTML=r.id?BX.message("IM_OL_INVITE_ANSWER"):BX.message("IM_OL_INVITE_JOIN");this.popupMessengerTextareaOpenLinesSkip.innerHTML=r.id?BX.message("IM_OL_INVITE_SKIP"):BX.message("IM_OL_INVITE_CLOSE");this.popupMessengerTextareaOpenLinesText.innerHTML=r.id?BX.message("IM_OL_INVITE_TEXT"):BX.message("IM_OL_INVITE_TEXT_OPEN")}else{if(this.chat[t].owner==this.BXIM.userId){BX.style(this.popupOpenLinesTransfer,"display","block");BX.style(this.popupOpenLinesClose,"display","block")}else{BX.style(this.popupOpenLinesTransfer,"display","none");BX.style(this.popupOpenLinesClose,"display","none")}}if(!r.id||r.id&&parseInt(this.chat[t].owner)>0){BX.style(this.popupOpenLinesSpam,"display","")}else{BX.style(this.popupOpenLinesSpam,"display","block")}if(this.linesSilentMode[t]){BX.addClass(this.popupMessengerHiddenModeButton,"bx-messenger-textarea-hidden-active")}else{BX.removeClass(this.popupMessengerHiddenModeButton,"bx-messenger-textarea-hidden-active")}}else if(this.chat[t].type=="announcement"){this.openLinesFlag=false;BX.style(this.popupOpenLinesTransfer,"display","none");BX.addClass(this.popupMessengerPanelAvatarForm2,"bx-messenger-panel-avatar-announcement");i.push("bx-messenger-chat-announcement");s.push("bx-messenger-chat-chat");s.push("bx-messenger-chat-crm");s.push("bx-messenger-chat-livechat");s.push("bx-messenger-chat-lines");s.push("bx-messenger-chat-lines-imessage");if(BX.MessengerCommon.userInChat(t)){o=false;n=false;if(this.chat[t].manager_list&&!this.chat[t].manager_list.map(function(e){return parseInt(e)}).includes(parseInt(this.BXIM.userId))){i.push("bx-messenger-chat-announcement-access");this.popupMessengerTextareaGeneralText.innerHTML=BX.message("IM_G_ACCESS");n=true}else{s.push("bx-messenger-chat-announcement-access")}}else{o=true;n=true}}else if(this.chat[t].type==="videoconf"){this.openLinesFlag=false;BX.style(this.popupOpenLinesTransfer,"display","none");BX.addClass(this.popupMessengerPanelAvatarForm2,"bx-messenger-panel-avatar-videoconf");i.push("bx-messenger-chat-videoconf");s.push("bx-messenger-chat-chat");s.push("bx-messenger-chat-crm");s.push("bx-messenger-chat-livechat");s.push("bx-messenger-chat-lines");s.push("bx-messenger-chat-lines-imessage")}else{this.openLinesFlag=false;BX.style(this.popupOpenLinesTransfer,"display","none");BX.addClass(this.popupMessengerPanelAvatarForm2,"bx-messenger-panel-avatar-chat");i.push("bx-messenger-chat-chat");if(this.chat[t].entity_type=="CRM"){i.push("bx-messenger-chat-crm");BX.addClass(this.popupMessengerPanelAvatarForm2,"bx-messenger-panel-avatar-type-crm")}else{s.push("bx-messenger-chat-crm")}s.push("bx-messenger-chat-announcement");s.push("bx-messenger-chat-announcement-access");s.push("bx-messenger-chat-livechat");s.push("bx-messenger-chat-lines");s.push("bx-messenger-chat-lines-imessage")}if(o){i.push("bx-messenger-chat-guest")}else{s.push("bx-messenger-chat-guest")}this.popupMessengerTextarea.disabled=n;s.push("bx-messenger-chat-open");s.push("bx-messenger-chat-general");s.push("bx-messenger-chat-general-first-open");s.push("bx-messenger-chat-general-access")}else{BX.addClass(this.popupMessengerPanelAvatarForm2,"bx-messenger-panel-avatar-open");BX.style(this.popupOpenLinesTransfer,"display","none");i.push("bx-messenger-chat-open");s.push("bx-messenger-chat-chat");s.push("bx-messenger-chat-livechat");s.push("bx-messenger-chat-lines");s.push("bx-messenger-chat-lines-imessage");s.push("bx-messenger-chat-announcement");s.push("bx-messenger-chat-announcement-access");var n=false;if(t==this.generalChatId){i.push("bx-messenger-chat-general");if(!this.canSendMessageGeneralChat){i.push("bx-messenger-chat-general-access");this.popupMessengerTextareaGeneralText.innerHTML=BX.message("IM_G_ACCESS");n=true}else if(this.BXIM.settings.generalNotify){i.push("bx-messenger-chat-general-first-open");this.popupMessengerTextareaGeneralText.innerHTML=BX.message("IM_G_JOIN").replace("#LINK_START#",'<a href="'+BX.message("IM_G_JOIN_LINK")+'"" style="margin-left: 10px; text-decoration: underline;">').replace("#LINK_END#","</a>").replace("#ICON#",'<span class="bx-messenger-icon-notify-mute" onclick="BX.MessengerCommon.muteMessageChat(\'chat'+this.generalChatId+"');\"></span>");n=true}else{s.push("bx-messenger-chat-general-first-open");s.push("bx-messenger-chat-general-access")}}else{s.push("bx-messenger-chat-general");s.push("bx-messenger-chat-general-first-open");s.push("bx-messenger-chat-general-access")}if(n){this.popupMessengerTextarea.disabled=true}else if(BX.MessengerCommon.userInChat(t)){this.popupMessengerTextarea.disabled=false;s.push("bx-messenger-chat-guest")}else{this.popupMessengerTextarea.disabled=true;i.push("bx-messenger-chat-guest")}}s.push("bx-messenger-chat-call");BX.addClass(this.popupMessengerDialog,i.join(" "));BX.removeClass(this.popupMessengerDialog,s.join(" "));if(a)BX.addClass(this.popupMessengerPanelStatus2,"bx-messenger-panel-avatar-status-hide");else BX.removeClass(this.popupMessengerPanelStatus2,"bx-messenger-panel-avatar-status-hide");if(this.chat[t].entity_type!=""&&BX.MessengerCommon.getEntityTypePath(t)){this.popupMessengerPanelChat.className="bx-messenger-panel bx-messenger-context-chat bx-messenger-panel-with-menu"}else{this.popupMessengerPanelChat.className="bx-messenger-panel bx-messenger-context-chat"}if(this.chat[t].entity_type!=""&&BX.MessengerCommon.checkRestriction(t,"EXTEND")){BX.style(this.popupMessengerPanelButtonExtend,"display","none")}else{BX.style(this.popupMessengerPanelButtonExtend,"display","block")}this.popupMessengerPanelCall.className="bx-messenger-panel bx-messenger-context-call bx-messenger-hide"}this.popupMessengerPanel.className="bx-messenger-panel bx-messenger-context-user bx-messenger-hide";if(!this.userInChat[t]){this.popupMessengerPanelUsers.innerHTML=this.chat[t].fake?BX.message("IM_CL_LOAD"):BX.message("IM_C_EMPTY");return false}if(e.userRedraw){var l=false;this.popupMessengerPanelUsers.innerHTML="";if(this.userInChat[t]){this.userInChat[t].sort(BX.delegate(function(e,s){if(!this.users[e]||!this.users[s])return 0;h=0;if(this.users[e].status!="offline"){h+=20}if(this.chat[t].owner==e){h+=10}if(this.users[e].status=="online"){h+=5}if(this.users[e].status=="mobile"){h+=3}if(this.users[e].avatar!="/bitrix/js/im/images/blank.gif"){h+=5}if(e<s){h+=1}ii=0;if(this.users[s].status!="offline"){ii+=20}if(this.chat[t].owner==s){ii+=10}if(this.users[s].status=="online"){ii+=5}if(this.users[s].status=="mobile"){ii+=3}if(this.users[s].avatar!="/bitrix/js/im/images/blank.gif"){ii+=5}if(s<e){ii+=1}if(h<ii){return 1}else if(h>ii){return-1}else{return 0}},this))}var p=this.chat[t].extranet;if(this.chat[t].extranet==""){p=false;for(var h=0;h<this.userInChat[t].length;h++){p=this.users[this.userInChat[t][h]]&&this.users[this.userInChat[t][h]].extranet}}if(this.chat[t].type=="livechat"){BX.removeClass(this.popupMessengerDialog,"bx-messenger-dialog-extranet");BX.removeClass(this.popupMessengerPanelChatTitle,"bx-messenger-chat-extranet");BX.addClass(this.popupMessengerPanelChatTitle,"bx-messenger-chat-title-lines")}else if(this.chat[t].type=="lines"){BX.removeClass(this.popupMessengerDialog,"bx-messenger-dialog-extranet");BX.removeClass(this.popupMessengerPanelChatTitle,"bx-messenger-chat-extranet");BX.addClass(this.popupMessengerPanelChatTitle,"bx-messenger-chat-title-lines");if(r.crm=="Y"){BX.style(this.popupMessengerPanelCrm,"display","inline-block")}else{BX.style(this.popupMessengerPanelCrm,"display","none")}}else if(this.chat[t].entity_type=="CRM"){BX.addClass(this.popupMessengerPanelChatTitle,"bx-messenger-chat-title-lines");BX.style(this.popupMessengerPanelCrm,"display","inline-block")}else if(this.chat[t].extranet){BX.addClass(this.popupMessengerPanelChatTitle,"bx-messenger-chat-extranet");BX.addClass(this.popupMessengerDialog,"bx-messenger-dialog-extranet");BX.style(this.popupMessengerPanelCrm,"display","none")}else{BX.removeClass(this.popupMessengerPanelChatTitle,"bx-messenger-chat-extranet");BX.removeClass(this.popupMessengerDialog,"bx-messenger-dialog-extranet");BX.removeClass(this.popupMessengerPanelChatTitle,"bx-messenger-chat-title-lines");BX.style(this.popupMessengerPanelCrm,"display","none")}BX.removeClass(this.popupMessengerDialog,"bx-messenger-dialog-bot");BX.removeClass(this.popupMessengerDialog,"bx-messenger-dialog-network");BX.removeClass(this.popupMessengerDialog,"bx-messenger-dialog-support24");var c=[];for(var h=0;h<this.userInChat[t].length;h++){var u=this.users[this.userInChat[t][h]];if(!u||!u.active){continue}if(this.chat[t].entity_type=="LINES"&&this.chat[t].owner==0&&u.id!=this.BXIM.userId&&!(u.bot||u.connector)){continue}c.push(this.userInChat[t][h])}var d=Math.floor(this.popupMessengerPanelUsers.offsetWidth/135);if(d>=c.length){for(var h=0;h<c.length&&h<d;h++){var u=this.users[c[h]];var m=BX.MessengerCommon.isBlankAvatar(u.avatar)?'style="background-color: '+u.color+'"':"";this.popupMessengerPanelUsers.innerHTML+='<span class="bx-messenger-panel-chat-user" data-userId="'+u.id+'">'+'<span class="bx-notifier-popup-avatar bx-notifier-popup-avatar-status-'+BX.MessengerCommon.getUserStatus(u)+(this.chat[t].owner==u.id?" bx-notifier-popup-avatar-owner":"")+(u.extranet&&!u.connector?" bx-notifier-popup-avatar-extranet":"")+'">'+'<img class="bx-notifier-popup-avatar-img'+(BX.MessengerCommon.isBlankAvatar(u.avatar)?" bx-notifier-popup-avatar-img-default":"")+'" src="'+u.avatar+'" title="'+u.name+'" '+m+">"+'<span class="bx-notifier-popup-avatar-status-icon" title="'+u.name+'"></span>'+"</span>"+'<span class="bx-notifier-popup-user-name'+(u.extranet&&!u.connector?" bx-messenger-panel-chat-user-name-extranet":"")+(u.connector?" bx-messenger-panel-chat-user-name-lines":"")+(u.bot?" bx-messenger-panel-chat-user-name-bot":"")+'">'+u.name+"</span>"+"</span>";l=true}}else{d=Math.floor((this.popupMessengerPanelUsers.offsetWidth-10)/32);for(var h=0;h<c.length&&h<d;h++){var u=this.users[c[h]];var m=BX.MessengerCommon.isBlankAvatar(u.avatar)?'style="background-color: '+u.color+'"':"";this.popupMessengerPanelUsers.innerHTML+='<span class="bx-messenger-panel-chat-user" data-userId="'+u.id+'">'+'<span class="bx-notifier-popup-avatar bx-notifier-popup-avatar-status-'+BX.MessengerCommon.getUserStatus(u)+(this.chat[t].owner==u.id?" bx-notifier-popup-avatar-owner":"")+(u.extranet?" bx-notifier-popup-avatar-extranet":"")+'">'+'<img class="bx-notifier-popup-avatar-img'+(BX.MessengerCommon.isBlankAvatar(u.avatar)?" bx-notifier-popup-avatar-img-default":"")+'" src="'+u.avatar+'" title="'+u.name+'" '+m+">"+'<span class="bx-notifier-popup-avatar-status-icon" title="'+u.name+'"></span>'+"</span>"+"</span>";l=true}if(l&&c.length>d){this.popupMessengerPanelUsers.innerHTML+='<span class="bx-notifier-popup-user-more" data-last-item="'+h+'">'+BX.message("IM_M_CHAT_MORE_USER").replace("#USER_COUNT#",c.length-d)+"</span>"}}if(!l){this.popupMessengerPanelUsers.innerHTML=BX.message("IM_CL_LOAD")}}};BX.MessengerChat.prototype.updateChatAvatar=function(e,t){if(this.chat[e]&&t&&t.length>0){this.chat[e].avatar=t;this.dialogStatusRedraw();BX.MessengerCommon.userListRedraw()}return true};BX.MessengerChat.prototype.renameChatDialog=function(){var e=this.getChatId();if(this.renameChatDialogFlag||!BX.MessengerCommon.userInChat(e)||BX.MessengerCommon.checkRestriction(e,"RENAME")){return false}if(this.chat[e]&&this.chat[e].type==="announcement"&&this.chat[e].manager_list&&!this.chat[e].manager_list.map(function(e){return parseInt(e)}).includes(parseInt(this.BXIM.userId))){return false}this.renameChatDialogFlag=true;BX.addClass(this.popupMessengerPanelChatTitle,"bx-messenger-chat-edit");this.popupMessengerPanelChatTitle.innerHTML="";BX.adjust(this.popupMessengerPanelChatTitle,{children:[BX.create("div",{props:{className:"bx-messenger-input-wrap bx-messenger-panel-title-chat-input"},children:[this.renameChatDialogInput=BX.create("input",{props:{className:"bx-messenger-input"},attrs:{type:"text",value:BX.util.htmlspecialcharsback(this.chat[e].name)}})]})]});this.renameChatDialogInput.focus();BX.bind(this.renameChatDialogInput,"blur",BX.delegate(function(){BX.removeClass(this.popupMessengerPanelChatTitle,"bx-messenger-chat-edit");BX.MessengerCommon.renameChat(e,this.renameChatDialogInput.value);BX.remove(this.renameChatDialogInput);this.renameChatDialogInput=null;this.popupMessengerPanelChatTitle.innerHTML=this.chat[e].name;this.renameChatDialogFlag=false},this));BX.bind(this.renameChatDialogInput,"keydown",BX.delegate(function(t){if(t.keyCode==27&&!BX.MessengerCommon.isDesktop()){this.renameChatDialogInput.value=BX.util.htmlspecialcharsback(this.chat[e].name);this.popupMessengerTextarea.focus();return BX.PreventDefault(t)}else if(t.keyCode==9||t.keyCode==13){this.popupMessengerTextarea.focus();return BX.PreventDefault(t)}},this))};BX.MessengerChat.prototype.openMentionDialog=function(e){if(this.popupSmileMenu!=null){this.popupSmileMenu.destroy()}if(this.popupChatDialog!=null){this.popupChatDialog.close();return false}e=e||{};e.delay=e.delay||300;e.textarea=e.textarea||"default";var t=e.textarea=="createChat"?this.popupCreateChatTextarea:this.popupMessengerTextarea;t.focus();if(t.value.substr(-1)!="@"){this.insertTextareaText(t,"@")}this.mentionListen=true;this.mentionDelimiter="@";this.openChatDialog({type:"MENTION",bind:t,focus:false,delimiter:this.mentionDelimiter,delay:e.delay});this.setClosingByEsc(false)};BX.MessengerChat.prototype.openChatDialog=function(e){if(!this.enableGroupChat)return false;if(this.popupChatDialog!=null){this.popupChatDialog.close();return false}if(this.popupTransferDialog!=null){this.popupTransferDialog.close();return false}BX.MessengerCommon.contactListSearchClear();this.closePopupFileMenu();if(this.popupPopupMenu!=null)this.popupPopupMenu.destroy();if(this.popupSmileMenu!=null){this.popupSmileMenu.destroy()}if(this.commandPopup!=null){this.commandPopup.destroy()}if(this.popupIframeMenu!=null&&this.popupIframeBind){this.popupIframeMenu.destroy()}if(e.type=="CHAT_EXTEND"){if(this.chat[e.chatId].type==="lines"&&!this.BXIM.messenger.openlines.canJoinChatUser){BX.UI.InfoHelper.show("limit_contact_center_ol_add_manager_to_chat");return false}else if(this.popupMessengerTextarea.disabled&&this.chat[e.chatId].type!=="announcement"){return false}}var t=null;if(e.type=="CHAT_ADD"||e.type=="CHAT_EXTEND"||e.type=="CALL_INVITE_USER"||e.type=="MENTION"||e.type=="CHAT_CREATE")this.popupChatDialogDestType=e.type;else return false;var s=5;var i={offset:BX.MessengerCommon.isPage()?39:210};var a=BX.MessengerCommon.isPage()?this.webrtc.callActive?5:0:this.webrtc.callActive?-162:-170;this.popupChatDialogEmptyCallback=function(){};this.popupChatDialogExceptUsers=[];if(typeof e.chatId!="undefined"&&this.userInChat[e.chatId]){this.popupChatDialogExceptUsers=this.userInChat[e.chatId]}if(e.type=="MENTION"){e.maxUsers=1;s=BX.MessengerCommon.isPage()?15:10;a=-10;i={offset:39}}else if(e.type=="CHAT_CREATE"){if(this.chatCreateType=="private"){e.maxUsers=1}this.popupChatDialogDestElements=e.bindResult;this.popupChatDialogContactListSearch=e.bindSearch;this.popupChatDialogUsers=e.bindUsersList;for(var n in this.popupChatDialogUsers){this.popupChatDialogExceptUsers.push(this.popupChatDialogUsers[n].id)}this.popupChatDialogEmptyCallback=BX.delegate(function(){if(this.popupChatDialog)this.popupChatDialog.close()},this)}this.popupChatDialogMaxChatUsers=typeof e.maxUsers=="undefined"?1e6:parseInt(e.maxUsers);if(typeof e.chatId!="undefined"&&this.userInChat[e.chatId]){this.popupChatDialogMaxChatUsers=this.popupChatDialogMaxChatUsers-this.userInChat[e.chatId].length}e.skipBind=typeof e.skipBind=="undefined"?false:e.skipBind;var o=e.bind?e.bind:null;var r=e.type!="CHAT_EXTEND"||this.chat[e.chatId].entity_type=="LINES";this.popupChatDialog=new BX.PopupWindow("bx-messenger-popup-newchat",o,{darkMode:this.BXIM.settings.enableDarkTheme,lightShadow:true,closeIcon:true,offsetTop:s,offsetLeft:a,autoHide:true,bindOptions:e.type=="MENTION"?{position:"top"}:{},buttons:e.type=="MENTION"||e.type=="CHAT_CREATE"?[]:[new BX.PopupWindowButton({text:BX.message("IM_M_CHAT_BTN_JOIN"),className:"popup-window-button-accept",events:{click:BX.delegate(function(){if(this.popupChatDialogDestType=="CHAT_ADD"){var e=[this.currentTab];for(var t in this.popupChatDialogUsers)e.push(t);this.sendRequestChatDialog({action:this.popupChatDialogDestType,users:e})}else if(this.popupChatDialogDestType=="CHAT_EXTEND"){var e=[];for(var t in this.popupChatDialogUsers)e.push(t);this.sendRequestChatDialog({action:this.popupChatDialogDestType,chatId:this.getChatId(),users:e})}else if(this.popupChatDialogDestType=="CALL_INVITE_USER"){var e=[];for(var t in this.popupChatDialogUsers)e.push(t);this.webrtc.callInviteUserToChat(e)}},this)}}),new BX.PopupWindowButton({text:BX.message("IM_M_CHAT_BTN_CANCEL"),events:{click:BX.delegate(function(){this.popupChatDialog.close()},this)}})],closeByEsc:true,zIndex:BX.MessengerCommon.getDefaultZIndex()+200,events:{onPopupClose:function(){this.destroy()},onPopupDestroy:BX.delegate(function(){this.popupChatDialog=null;this.mentionListen=false;this.mentionDelimiter="";this.popupChatDialogDestType="";if(e.type!="CHAT_CREATE"){this.popupChatDialogUsers={}}if(e.type=="MENTION"||e.type=="CHAT_CREATE"){BX.proxy_context.bindElement.focus()}else{this.popupChatDialogContactListElementsType="";this.popupChatDialogContactListElements=null}},this)},content:BX.create("div",{props:{className:"bx-messenger-popup-newchat-wrap bx-messenger-popup-newchat-wrap-style-"+e.type+(BX.browser.IsMac()?"":" bx-messenger-custom-scroll")},children:[BX.create("div",{props:{className:"bx-messenger-popup-newchat-caption"},html:e.type=="MENTION"?BX.message("IM_MENTION_MENU_NEW"):BX.message("IM_M_CHAT_TITLE")}),e.type=="CHAT_CREATE"?null:BX.create("div",{props:{className:"bx-messenger-popup-newchat-box bx-messenger-popup-newchat-dest bx-messenger-popup-newchat-dest-even"+(e.type=="MENTION"?" bx-messenger-hide":"")},children:[this.popupChatDialogDestElements=BX.create("span",{props:{className:"bx-messenger-dest-items"}}),this.popupChatDialogContactListSearch=BX.create("input",{props:{className:"bx-messenger-input"},attrs:{type:"text",placeholder:BX.message(this.BXIM.bitrixIntranet?"IM_M_SEARCH_PLACEHOLDER_CP":"IM_M_SEARCH_PLACEHOLDER"),value:""}})]}),this.popupChatDialogContactListElements=BX.create("div",{props:{className:"bx-messenger-popup-newchat-box bx-messenger-popup-newchat-cl bx-messenger-recent-wrap"},children:BX.create("div",{props:{className:"bx-messenger-cl-item-load"},html:BX.message("IM_CL_LOAD")})}),r?null:BX.create("div",{props:{className:"bx-messenger-popup-newchat-checkbox"},children:[this.popupChatDialogShowHistory=BX.create("input",{props:{className:"bx-messenger-checkbox"},attrs:{id:"popupChatDialogShowHistory",type:"checkbox",checked:this.BXIM.options.chatExtendShowHistory?"true":"",name:"popupChatDialogShowHistory"}}),BX.create("label",{attrs:{for:"popupChatDialogShowHistory"},props:{className:"bx-messenger-checkbox-label"},html:BX.message("IM_M_CHAT_SHOW_HISTORY")})]})]})});if(!this.BXIM.settings.enableDarkTheme){this.popupChatDialog.setAngle(i)}this.popupChatDialog.show();BX.addClass(this.popupChatDialog.popupContainer,"bx-messenger-mark");this.popupChatDialogContactListElementsType=e.type;BX.MessengerCommon.contactListPrepareSearch("popupChatDialogContactListElements",this.popupChatDialogContactListElements,this.popupChatDialogContactListSearch.value,{viewOffline:true,viewChat:false,viewOpenChat:this.popupChatDialogDestType=="MENTION",exceptUsers:this.popupChatDialogExceptUsers,timeout:0,callback:{empty:this.popupChatDialogEmptyCallback}});BX.bindDelegate(this.popupChatDialogContactListElements,"click",{className:"bx-messenger-chatlist-more"},BX.delegate(this.toggleChatListGroup,this));if(!e.skipBind&&e.type!="MENTION"){this.popupChatDialogContactListSearch.focus();BX.bind(this.popupChatDialogContactListSearch,"keyup",BX.delegate(function(e){if(e.keyCode==16||e.keyCode==18||e.keyCode==20||e.keyCode==244||e.keyCode==91)return false;if(e.keyCode==37||e.keyCode==39)return true;if(this.popupChatDialogContactListSearch.value!=this.popupChatDialogContactListSearchLastText||this.popupChatDialogContactListSearch.value==""){if(this.popupChatDialogContactListSearch.value==""&&this.popupChatDialog&&this.popupChatDialogDestType=="CHAT_CREATE"){this.popupChatDialog.close();return false}}else if(e.keyCode==224||e.keyCode==18||e.keyCode==17){return true}if(e.keyCode==8&&this.popupChatDialogContactListSearch.value==""){var t=null;var s=BX.util.objectSort(this.popupChatDialogUsers,"date","asc");for(var i=0;i<s.length;i++){t=s[i].id}if(t){delete this.popupChatDialogUsers[t];this.redrawChatDialogDest()}}if(e.keyCode==27&&this.popupChatDialogContactListSearch.value!="")BX.MessengerCommon.preventDefault(e);if(e.keyCode==27){if(this.BXIM.messenger.realSearch){this.BXIM.messenger.realSearchFound=true}this.popupChatDialogContactListSearch.value=""}if(e.keyCode==38||e.keyCode==40){return true}if(e.keyCode==13&&this.popupChatDialogContactListSearch.value!=""){var a=BX.findChildByClassName(this.popupChatDialogContactListElements,"bx-messenger-cl-item");if(a){if(this.popupChatDialogContactListSearch.value!=""){this.popupChatDialogContactListSearch.value=""}if(this.popupChatDialogUsers[a.getAttribute("data-userId")])delete this.popupChatDialogUsers[a.getAttribute("data-userId")];else this.popupChatDialogUsers[a.getAttribute("data-userId")]={id:a.getAttribute("data-userId"),date:new Date};this.redrawChatDialogDest();if(this.popupChatDialogDestType=="CHAT_CREATE"){if(this.popupChatDialog)this.popupChatDialog.close()}}else{var a=BX.findChildByClassName(this.popupChatDialogContactListElements,"bx-messenger-chatlist-search-button");if(a){this.popupChatDialogContactListElements.appendChild(BX.create("div",{props:{className:"bx-messenger-cl-item-search"},html:BX.message("IM_M_CL_SEARCH")}));BX.remove(a);this.BXIM.messenger.realSearch=true;BX.MessengerCommon.contactListRealSearch(this.popupChatDialogContactListSearch.value,BX.delegate(function(){BX.MessengerCommon.contactListPrepareSearch("popupChatDialogContactListElements",this.popupChatDialogContactListElements,this.popupChatDialogContactListSearch.value,{viewOffline:true,viewChat:false,viewOpenChat:this.popupChatDialogDestType=="MENTION",exceptUsers:this.popupChatDialogExceptUsers,timeout:100,callback:{empty:this.popupChatDialogEmptyCallback}})},this));return true}}if(this.BXIM.messenger.realSearch){this.BXIM.messenger.realSearchFound=true}}this.popupChatDialogContactListSearchLastText=this.popupChatDialogContactListSearch.value;if(this.BXIM.messenger.realSearch){this.BXIM.messenger.realSearchFound=this.popupChatDialogContactListSearch.value.length<3}BX.MessengerCommon.contactListPrepareSearch("popupChatDialogContactListElements",this.popupChatDialogContactListElements,this.popupChatDialogContactListSearch.value,{viewOffline:true,viewChat:false,viewOpenChat:this.popupChatDialogDestType=="MENTION",exceptUsers:this.popupChatDialogExceptUsers,timeout:100,callback:{empty:this.popupChatDialogEmptyCallback}});BX.MessengerCommon.contactListRealSearch(this.popupChatDialogContactListSearch.value,BX.delegate(function(){BX.MessengerCommon.contactListPrepareSearch("popupChatDialogContactListElements",this.popupChatDialogContactListElements,this.popupChatDialogContactListSearch.value,{viewOffline:true,viewChat:false,viewOpenChat:this.popupChatDialogDestType=="MENTION",exceptUsers:this.popupChatDialogExceptUsers,timeout:100,callback:{empty:this.popupChatDialogEmptyCallback}})},this));if(this.popupChatDialog)this.popupChatDialog.adjustPosition()},this));BX.bindDelegate(this.popupChatDialogDestElements,"click",{className:"bx-messenger-dest-del"},BX.delegate(function(){delete this.popupChatDialogUsers[BX.proxy_context.getAttribute("data-userId")];if(BX.MessengerCommon.countObject(this.popupChatDialogUsers)<this.popupChatDialogMaxChatUsers)BX.show(this.popupChatDialogContactListSearch);this.redrawChatDialogDest()},this));BX.bindDelegate(this.popupChatDialogContactListElements,"click",{className:"bx-messenger-chatlist-search-button"},BX.delegate(function(){this.popupChatDialogContactListElements.appendChild(BX.create("div",{props:{className:"bx-messenger-cl-item-search"},html:BX.message("IM_M_CL_SEARCH")}));BX.remove(BX.proxy_context.parentNode);this.BXIM.messenger.realSearch=true;BX.MessengerCommon.contactListRealSearch(this.popupChatDialogContactListSearch.value,BX.delegate(function(){BX.MessengerCommon.contactListPrepareSearch("popupChatDialogContactListElements",this.popupChatDialogContactListElements,this.popupChatDialogContactListSearch.value,{viewOffline:true,viewChat:false,viewOpenChat:this.popupChatDialogDestType=="MENTION",exceptUsers:this.popupChatDialogExceptUsers,timeout:100,callback:{empty:this.popupChatDialogEmptyCallback}})},this))},this))}BX.bindDelegate(this.popupChatDialogContactListElements,"click",{className:"bx-messenger-cl-item"},BX.delegate(function(t){if(this.popupChatDialogContactListSearch.value!=""){this.popupChatDialogContactListSearch.value="";if(this.popupChatDialogDestType!="MENTION"&&this.popupChatDialogDestType!="CHAT_CREATE"){BX.MessengerCommon.contactListPrepareSearch("popupChatDialogContactListElements",this.popupChatDialogContactListElements,this.popupChatDialogContactListSearch.value,{viewOffline:true,viewChat:false,viewOpenChat:false,exceptUsers:this.popupChatDialogExceptUsers})}}if(this.popupChatDialogUsers[BX.proxy_context.getAttribute("data-userId")]){delete this.popupChatDialogUsers[BX.proxy_context.getAttribute("data-userId")]}else{if(BX.MessengerCommon.countObject(this.popupChatDialogUsers)==this.popupChatDialogMaxChatUsers)return false;this.popupChatDialogUsers[BX.proxy_context.getAttribute("data-userId")]={id:BX.proxy_context.getAttribute("data-userId"),date:new Date}}if(this.popupChatDialogDestType=="MENTION"){var s=o.value.substr(0,o.selectionEnd);s=s.substr(s.lastIndexOf(e.delimiter),o.selectionEnd-s.lastIndexOf(e.delimiter));o.value=o.value.replace(s,BX.proxy_context.getAttribute("data-name")+" ");BX.MessengerCommon.addMentionList(this.currentTab,BX.proxy_context.getAttribute("data-name"),BX.proxy_context.getAttribute("data-userId"));if(this.popupChatDialog)this.popupChatDialog.close()}else{this.redrawChatDialogDest()}if(this.popupChatDialogDestType=="CHAT_CREATE"){if(this.popupChatDialog)this.popupChatDialog.close()}return BX.PreventDefault(t)},this))};BX.MessengerChat.prototype.redrawChatDialogDest=function(){var e="";var t=0;var s=0;var i=BX.util.objectSort(this.popupChatDialogUsers,"date","asc");for(var a=0;a<i.length;a++){s=i[a].id.toString();var n=s.substr(0,9)=="structure";var o=false;var r="";if(n){var l=s.substr(9);r=this.groups[l].name.split(" / ")[0]}else{r=this.users[s].name;o=this.users[s].extranet}t++;e+='<span class="bx-messenger-dest-block'+(o?" bx-messenger-dest-block-extranet":"")+(n?" bx-messenger-dest-block-structure":"")+'">'+'<span class="bx-messenger-dest-text">'+r+"</span>"+'<span class="bx-messenger-dest-del" data-userId="'+s+'"></span></span>'}this.popupChatDialogDestElements.innerHTML=e;this.popupChatDialogDestElements.parentNode.scrollTop=this.popupChatDialogDestElements.parentNode.offsetHeight;if(this.popupChatDialogDestType!="CHAT_CREATE"){if(BX.util.even(t))BX.addClass(this.popupChatDialogDestElements.parentNode,"bx-messenger-popup-newchat-dest-even");else BX.removeClass(this.popupChatDialogDestElements.parentNode,"bx-messenger-popup-newchat-dest-even")}var p=BX.MessengerCommon.countObject(this.popupChatDialogUsers);if(p>=this.popupChatDialogMaxChatUsers){BX.addClass(this.popupChatDialogContactListSearch,"bx-messenger-hide");if(this.popupChatDialogDestType=="CHAT_CREATE"){if(this.popupChatDialog)this.popupChatDialog.close();this.popupCreateChatTextarea.focus()}}else{BX.removeClass(this.popupChatDialogContactListSearch,"bx-messenger-hide");if(this.popupChatDialog)this.popupChatDialog.adjustPosition();this.popupChatDialogContactListSearch.focus()}if(p){BX.removeClass(this.popupChatDialogContactListSearch,"bx-messenger-input-dest-empty")}else{BX.addClass(this.popupChatDialogContactListSearch,"bx-messenger-input-dest-empty")}};BX.MessengerChat.prototype.sendRequestChatDialog=function(e){var t=new BX.Promise;if(this.popupChatDialogSendBlock){t.reject();return t}if(typeof e!="object"){t.reject();return t}e.type=e.type=="open"?"open":e.type=="videoconf"?"videoconf":"chat";e.users=e.users||[];e.message=e.message||"";e.title=e.title||"";var s=[];for(var i=0;i<e.users.length;i++){if(e.users[i].toString().substr(0,9)=="structure"){e.users[i]=parseInt(e.users[i].toString().substr(9));if(e.users[i]<0)continue;e.users[i]="structure"+e.users[i]}else if(e.users[i].toString().substr(0,7)=="network"){}else{e.users[i]=parseInt(e.users[i]);if(e.users[i]<0)continue}if(s.indexOf&&s.indexOf(e.users[i])>=0)continue;if(e.users[i]==this.BXIM.userId)continue;if(e.chatId&&this.userInChat[e.chatId].indexOf&&this.userInChat[e.chatId].indexOf(e.users[i].toString())>=0)continue;s.push(e.users[i])}e.users=s;var a="";if(e.action=="CHAT_CREATE"&&e.type=="chat"&&e.users.length<1){a=BX.message("IM_M_CHAT_ERROR_1")}if(e.action=="CHAT_ADD"&&e.type=="chat"&&e.users.length<=1){if(e.users[0]&&this.users[e.users[0]]){this.openMessenger(e.users[0]);if(this.popupChatDialog!=null)this.popupChatDialog.close();t.reject();return t}else{a=BX.message("IM_M_CHAT_ERROR_1")}}else if(e.action=="CHAT_EXTEND"&&e.users.length==0){if(this.popupChatDialog!=null)this.popupChatDialog.close();t.reject();return t}var n=e.action;if(e.action=="CHAT_CREATE"){e.action="CHAT_ADD"}if(a!=""){this.BXIM.openConfirm(a);t.reject();return t}this.popupChatDialogSendBlock=true;if(this.popupChatDialog!=null)this.popupChatDialog.buttons[0].setClassName("popup-window-button-disable");var o=false;var r="";if(e.action=="CHAT_ADD"){o={IM_CHAT_ADD:"Y",TYPE:e.type,TITLE:e.title,MESSAGE:e.message,USERS:JSON.stringify(e.users),IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()};r="&logTag="+BX.MessengerCommon.getLogTrackingParams({name:"im.chat.add",data:{timType:e.type=="open"?"open":"chat",timCreateFrom:n=="CHAT_CREATE"?"form":"dialog"}})}else if(e.action=="CHAT_EXTEND"){o={IM_CHAT_EXTEND:"Y",CHAT_ID:e.chatId,HISTORY:this.popupChatDialogShowHistory&&this.popupChatDialogShowHistory.checked?"Y":"N",USERS:JSON.stringify(e.users),IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()};this.BXIM.options.chatExtendShowHistory=this.popupChatDialogShowHistory&&this.popupChatDialogShowHistory.checked;BXIM.setLocalConfig("mcesh",this.BXIM.options.chatExtendShowHistory)}if(!o){t.reject();return t}BX.ajax({url:this.BXIM.pathToAjax+"?"+e.action+"&V="+this.BXIM.revision+r,method:"POST",dataType:"json",timeout:60,data:o,onsuccess:BX.delegate(function(s){this.popupChatDialogSendBlock=false;if(this.popupChatDialog!=null)this.popupChatDialog.buttons[0].setClassName("popup-window-button-accept");if(s.ERROR==""){if(s.CHAT_ID&&e.type!=="videoconf"){if(this.BXIM.ppServerStatus&&this.currentTab!="chat"+s.CHAT_ID){this.openMessenger("chat"+s.CHAT_ID)}else if(!this.BXIM.ppServerStatus&&this.currentTab!="chat"+s.CHAT_ID){setTimeout(BX.delegate(function(){this.openMessenger("chat"+s.CHAT_ID)},this),500)}}this.popupChatDialogSendBlock=false;if(this.popupChatDialog!=null)this.popupChatDialog.close()}else{this.BXIM.openConfirm(s.ERROR)}t.resolve(s)},this)});return t};BX.MessengerChat.prototype.openContactList=function(){return this.openMessenger()};BX.MessengerChat.prototype.openPopupMenu=function(e,t,s,i){i=i?i:{};var a=i.closeSmiles===false?false:true;if(a&&this.popupSmileMenu!=null)this.popupSmileMenu.destroy();this.closePopupFileMenu();if(this.popupPopupMenu!=null){this.popupPopupMenu.destroy();return false}var n=0;var o=13;var r=[];var l={};var p={offset:4};this.popupPopupMenuStyle="";if(i.offsetTop)n=i.offsetTop;if(i.offsetLeft)o=i.offsetLeft;if(i.anglePosition)p.position=i.anglePosition;if(t=="createChat"){l={position:"bottom"};if(i.openDesktop){r=[{icon:"bx-messenger-cc-private",text:BX.message("IM_CL_PRIVATE_CHAT_NEW"),onclick:BX.delegate(function(){BX.desktopUtils.goToBx("bx://chat/create/private");this.closeMenuPopup()},this)},{icon:"bx-messenger-cc-chat",text:BX.message("IM_CL_CHAT_NEW"),onclick:BX.delegate(function(){BX.desktopUtils.goToBx("bx://chat/create/chat");this.closeMenuPopup()},this)},this.BXIM.userExtranet||!this.openChatEnable?null:{icon:"bx-messenger-cc-open",text:BX.message("IM_CL_OPEN_CHAT_NEW"),onclick:BX.delegate(function(){BX.desktopUtils.goToBx("bx://chat/create/open");this.closeMenuPopup()},this)},this.BXIM.userExtranet||!this.openChatEnable||!this.BXIM.debug?null:{icon:"bx-messenger-cc-videoconf",text:BX.message("IM_CL_VIDEOCONF"),onclick:BX.delegate(function(){BX.desktopUtils.goToBx("bx://chat/create/videoconf");this.closeMenuPopup()},this)}]}else if(i.openMessenger){r=[{icon:"bx-messenger-cc-private",text:BX.message("IM_CL_PRIVATE_CHAT_NEW"),onclick:BX.delegate(function(){this.openMessenger();this.openChatCreateForm("private");this.closeMenuPopup()},this)},{icon:"bx-messenger-cc-chat",text:BX.message("IM_CL_CHAT_NEW"),onclick:BX.delegate(function(){this.openMessenger();this.openChatCreateForm("chat");this.closeMenuPopup()},this)},this.BXIM.userExtranet||!this.openChatEnable?null:{icon:"bx-messenger-cc-open",text:BX.message("IM_CL_OPEN_CHAT_NEW"),onclick:BX.delegate(function(){this.openMessenger();this.openChatCreateForm("open");this.closeMenuPopup()},this)},this.BXIM.userExtranet||!this.BXIM.bitrixIntranet||!this.BXIM.debug?null:{icon:"bx-messenger-cc-videoconf",text:BX.message("IM_CL_VIDEOCONF"),onclick:BX.delegate(function(){this.openVideoConfCreateForm("videoconf");this.closeMenuPopup()},this)}]}else{r=[{icon:"bx-messenger-cc-private",text:BX.message("IM_CL_PRIVATE_CHAT_NEW"),onclick:BX.delegate(function(){this.openChatCreateForm("private");this.closeMenuPopup()},this)},{icon:"bx-messenger-cc-chat",text:BX.message("IM_CL_CHAT_NEW"),onclick:BX.delegate(function(){this.openChatCreateForm("chat");this.closeMenuPopup()},this)},this.BXIM.userExtranet||!this.openChatEnable?null:{icon:"bx-messenger-cc-open",text:BX.message("IM_CL_OPEN_CHAT_NEW"),onclick:BX.delegate(function(){this.openChatCreateForm("open");this.closeMenuPopup()},this)},this.BXIM.userExtranet||!this.BXIM.bitrixIntranet||!this.BXIM.debug?null:{icon:"bx-messenger-cc-videoconf",text:BX.message("IM_CL_VIDEOCONF"),onclick:BX.delegate(function(){this.openVideoConfCreateForm("videoconf");this.closeMenuPopup()},this)}]}}else if(t=="pathMenu"){var h=this.getChatId();var c=BX.MessengerCommon.getEntityTypePath(h);n=5;o=14;r=[];if(this.BXIM.checkCallSupport(this.currentTab)){r.push({icon:"bx-messenger-menu-call-video",text:BX.message("IM_M_CALL_VIDEO_HD"),onclick:BX.delegate(function(){this.BXIM.callTo(this.currentTab,true);this.closeMenuPopup()},this)});r.push({icon:"bx-messenger-menu-call-voice",text:BX.message("IM_M_CALL_VOICE"),onclick:BX.delegate(function(){this.BXIM.callTo(this.currentTab,false);this.closeMenuPopup()},this)});r.push({separator:true})}if(c){r.push({icon:"bx-messenger-menu-crm",text:c["TITLE"],href:c["PATH"],target:"_blank",onclick:BX.delegate(function(){this.closeMenuPopup()},this)})}r.push({icon:"bx-messenger-menu-history-2",text:BX.message("IM_M_HISTORY"),onclick:BX.delegate(function(){this.openHistory(this.currentTab);this.closeMenuPopup()},this)})}else if(t=="openLinesMenu"){var h=this.getChatId();var u=this.chat[h].owner==this.BXIM.userId;var d=BX.MessengerCommon.linesGetSession(this.chat[h]);n=5;o=14;r=[u?{icon:"bx-messenger-menu-pause",text:BX.message(d.pin=="Y"?"IM_M_OL_ASSIGN_OFF":"IM_M_OL_ASSIGN_ON"),onclick:BX.delegate(function(){this.linesTogglePinMode();this.closeMenuPopup()},this)}:null,u&&d.crm!="Y"?{icon:"bx-messenger-menu-crm",text:BX.message("IM_M_OL_ADD_LEAD"),onclick:BX.delegate(function(){this.linesCreateLead();this.closeMenuPopup()},this)}:null,d.crmLink&&d.crmLinkLead=="undefined"&&d.crmLinkCompany=="undefined"&&d.crmLinkContact=="undefined"&&d.crmLinkDeal=="undefined"?{icon:"bx-messenger-menu-crm",text:BX.message("IM_M_OL_GOTO_CRM"),href:d.crmLink,target:"_blank",onclick:BX.delegate(function(){this.closeMenuPopup()},this)}:null,d.crmLinkLead?{icon:"bx-messenger-menu-crm",text:BX.message("IM_M_OL_GOTO_CRM_LEAD"),href:d.crmLinkLead,target:"_blank",onclick:BX.delegate(function(){this.closeMenuPopup()},this)}:null,d.crmLinkCompany?{icon:"bx-messenger-menu-crm",text:BX.message("IM_M_OL_GOTO_CRM_COMPANY"),href:d.crmLinkCompany,target:"_blank",onclick:BX.delegate(function(){this.closeMenuPopup()},this)}:null,d.crmLinkContact?{icon:"bx-messenger-menu-crm",text:BX.message("IM_M_OL_GOTO_CRM_CONTACT"),href:d.crmLinkContact,target:"_blank",onclick:BX.delegate(function(){this.closeMenuPopup()},this)}:null,d.crmLinkDeal?{icon:"bx-messenger-menu-crm",text:BX.message("IM_M_OL_GOTO_CRM_DEAL"),href:d.crmLinkDeal,target:"_blank",onclick:BX.delegate(function(){this.closeMenuPopup()},this)}:null,{icon:"bx-messenger-menu-history-2",text:BX.message("IM_M_HISTORY"),onclick:BX.delegate(function(){this.openHistory(this.currentTab);this.closeMenuPopup()},this)},d.id?{separator:true}:null,!u&&d.id?{icon:"bx-messenger-menu-intercept",text:BX.message("IM_M_OL_INTERCEPT"),onclick:BX.delegate(function(){this.linesInterceptSession();this.closeMenuPopup()},this)}:null,u&&d.id?{icon:"bx-messenger-menu-spam",text:BX.message("IM_M_OL_FORCE_CLOSE"),onclick:BX.delegate(function(){this.linesMarkAsSpam();this.closeMenuPopup()},this)}:null]}else if(t=="textareaAppsMenu"){r=[];for(var m=0;m<this.textareaIcon.length;m++){if(!this.textareaIcon[m]||this.BXIM.userExtranet&&!this.textareaIcon[m]["extranet"]||this.textareaIcon[m].hidden){continue}if(this.desktop.ready()&&!this.desktop.enableInVersion(39)&&this.textareaIcon[m]["iframe"]){if(BXDesktopSystem.GetProperty("versionParts").join(".")!="5.0.32.38"){continue}}if(!this.textareaIcon[m]["title"]&&!this.textareaIcon[m]["url"]){continue}if(this.textareaIcon[m]["url"]){continue}var g=this.textareaIcon[m]["description"]?this.textareaIcon[m]["description"]:this.textareaIcon[m]["title"];r.push({text:BX.util.htmlspecialchars(this.textareaIcon[m]["title"]),onclick:BX.delegate(function(e){this.textareaIconClick();return BX.PreventDefault(e)},this),attrs:{title:g,"data-context":this.textareaIcon[m]["context"],"data-code":this.textareaIcon[m]["code"],"data-id":this.textareaIcon[m]["id"]}})}n=5;o=14}else if(t=="status"){o=9;l={position:"top"};r=[{icon:"bx-messenger-status-online",text:BX.message("IM_STATUS_ONLINE"),onclick:BX.delegate(function(){this.setStatus("online");this.closeMenuPopup()},this)},{icon:"bx-messenger-status-away",text:BX.message("IM_STATUS_AWAY"),onclick:BX.delegate(function(){this.setStatus("away");this.closeMenuPopup()},this)},{icon:"bx-messenger-status-dnd",text:BX.message("IM_STATUS_DND"),onclick:BX.delegate(function(){this.setStatus("dnd");this.closeMenuPopup()},this)}]}else if(t=="iconMenu"){var f=e.getAttribute("data-id");r=[{text:BX.message("IM_MENU_DELETE"),onclick:BX.delegate(function(t){this.removeRecentSmile(f);BX.remove(e);this.popupPopupMenu.close();return BX.PreventDefault(t)},this)}]}else if(t=="notifyDelete"){var B=e.getAttribute("data-notifyId");var X=this.notify.notify[B].settingName;var M=typeof this.BXIM.settingsNotifyBlocked[X]=="undefined"?BX.message("IM_NOTIFY_DELETE_2"):BX.message("IM_NOTIFY_DELETE_3");if(typeof i.applyToDom!="undefined"){e=i.applyToDom}r=[this.notify.unreadNotify[B]?{text:BX.message("IM_MENU_READ"),onclick:BX.delegate(function(){this.notify.viewNotify(B,true);this.closeMenuPopup()},this)}:null,!this.notify.unreadNotify[B]?{text:BX.message("IM_MENU_UNREAD"),onclick:BX.delegate(function(){this.notify.viewNotify(B,false);this.closeMenuPopup()},this)}:null,{text:BX.message("IM_NOTIFY_DELETE_1"),onclick:BX.delegate(function(){this.notify.deleteNotify(B);this.closeMenuPopup()},this)},{text:M,onclick:BX.delegate(function(){this.notify.blockNotifyType(X);this.closeMenuPopup()},this)}]}else if(t=="callJoin"){n=2;o=20;r=[{icon:"bx-messenger-menu-call-video",text:BX.message("IM_M_CALL_BTN_JOIN_MENU_VIDEO"),onclick:BX.delegate(function(){this.BXIM.callController.joinCall(i.currentCall.call.id,true);this.closeMenuPopup()},this)},{icon:"bx-messenger-menu-call-voice",text:BX.message("IM_M_CALL_BTN_JOIN_MENU_AUDIO"),onclick:BX.delegate(function(){this.BXIM.callController.joinCall(i.currentCall.call.id,false);this.closeMenuPopup()},this)}]}else if(t=="callMenu"){n=2;o=20;if(this.BXIM.checkCallSupport(this.currentTab)){r=[{icon:"bx-messenger-menu-call-video",text:BX.message("IM_M_CALL_VIDEO_HD"),onclick:BX.delegate(function(){this.BXIM.callTo(this.currentTab,true);this.closeMenuPopup()},this)},{icon:"bx-messenger-menu-call-voice",text:BX.message("IM_M_CALL_VOICE"),onclick:BX.delegate(function(){this.BXIM.callTo(this.currentTab,false);this.closeMenuPopup()},this)}]}if(this.BXIM.zoomStatus["active"]){r.push({icon:"bx-messenger-menu-call-video",text:BX.message("IM_M_CREATE_ZOOM"),onclick:BX.delegate(function(){this.BXIM.createZoom(this.currentTab);this.closeMenuPopup()},this),restricted:!this.BXIM.zoomStatus["enabled"]})}if(!this.openChatFlag&&this.users[this.currentTab].services){r.push({separator:true});if(this.users[this.currentTab].services.zoom){r.push({text:"Zoom",href:this.users[this.currentTab].services.zoom})}if(this.users[this.currentTab].services.skype){r.push({text:"Skype",href:this.users[this.currentTab].services.skype})}}if(this.BXIM.webrtc.phoneCanCallUserNumber&&!this.openChatFlag&&this.phones[this.currentTab]){r.push({separator:true});if(this.phones[this.currentTab].PERSONAL_MOBILE){r.push({type:"call",text:BX.message("IM_PHONE_PERSONAL_MOBILE"),phone:BX.util.htmlspecialchars(this.phones[this.currentTab].PERSONAL_MOBILE),onclick:BX.delegate(function(){this.BXIM.phoneTo(this.phones[this.currentTab].PERSONAL_MOBILE);this.closeMenuPopup()},this)})}if(this.phones[this.currentTab].PERSONAL_PHONE){r.push({type:"call",text:BX.message("IM_PHONE_PERSONAL_PHONE"),phone:BX.util.htmlspecialchars(this.phones[this.currentTab].PERSONAL_PHONE),onclick:BX.delegate(function(){this.BXIM.phoneTo(this.phones[this.currentTab].PERSONAL_PHONE);this.closeMenuPopup()},this)})}if(this.phones[this.currentTab].WORK_PHONE){r.push({type:"call",text:BX.message("IM_PHONE_WORK_PHONE"),phone:BX.util.htmlspecialchars(this.phones[this.currentTab].WORK_PHONE),onclick:BX.delegate(function(){this.BXIM.phoneTo(this.phones[this.currentTab].WORK_PHONE);this.closeMenuPopup()},this)})}if(this.phones[this.currentTab].INNER_PHONE){r.push({type:"call",text:BX.message("IM_PHONE_INNER_PHONE"),phone:BX.util.htmlspecialchars(this.phones[this.currentTab].INNER_PHONE),onclick:BX.delegate(function(){this.BXIM.phoneTo(this.phones[this.currentTab].INNER_PHONE);this.closeMenuPopup()},this)})}}}else if(t=="videoConfMenu"){n=2;o=20;if(this.chat[i.chatId].public){r=[{text:BX.message("IM_VIDEOCONF_MENU_COPY"),onclick:BX.delegate(function(){BX.UI.Notification.Center.notify({content:BX.message("IM_VIDEOCONF_MENU_COPY_DONE"),autoHideDelay:2e3});BX.MessengerCommon.clipboardCopy(this.chat[i.chatId].public.link);this.closeMenuPopup()},this)}];if(this.chat[i.chatId].owner==this.BXIM.userId){r.push({text:BX.message("IM_VIDEOCONF_MENU_CHANGE_LINK"),onclick:BX.delegate(function(){this.BXIM.openConfirm(BX.message("IM_VIDEOCONF_MENU_CONFIRM_CHANGE_TEXT"),[new BX.PopupWindowButton({text:BX.message("IM_VIDEOCONF_MENU_CONFIRM_CHANGE"),className:"popup-window-button-accept",events:{click:BX.delegate(function(){this.changeVideoconfCode(this.currentTab);BX.proxy_context.popupWindow.close()},this)}}),new BX.PopupWindowButton({text:BX.message("IM_VIDEOCONF_MENU_CONFIRM_CHANGE_CANCEL"),className:"popup-window-button",events:{click:function(){this.popupWindow.close()}}})],true);this.closeMenuPopup()},this)})}}}else if(t=="callPhoneMenu"){n=2;o=25;r=[{icon:"bx-messenger-menu-call-"+(i.video?"video":"voice"),text:"<b>"+BX.message("IM_M_CALL_BTN_RECALL_3")+"</b>",onclick:BX.delegate(function(){this.webrtc.callInvite(i.userId,i.video)},this)}];r.push({separator:true});if(this.phones[i.userId]&&this.BXIM.webrtc.phoneCanCallUserNumber){r.push({separator:true});if(this.phones[i.userId].PERSONAL_MOBILE){r.push({type:"call",text:BX.message("IM_PHONE_PERSONAL_MOBILE"),phone:BX.util.htmlspecialchars(this.phones[i.userId].PERSONAL_MOBILE),onclick:BX.delegate(function(){this.BXIM.phoneTo(this.phones[i.userId].PERSONAL_MOBILE);this.closeMenuPopup()},this)})}if(this.phones[i.userId].PERSONAL_PHONE){r.push({type:"call",text:BX.message("IM_PHONE_PERSONAL_PHONE"),phone:BX.util.htmlspecialchars(this.phones[i.userId].PERSONAL_PHONE),onclick:BX.delegate(function(){this.BXIM.phoneTo(this.phones[i.userId].PERSONAL_PHONE);this.closeMenuPopup()},this)})}if(this.phones[i.userId].WORK_PHONE){r.push({type:"call",text:BX.message("IM_PHONE_WORK_PHONE"),phone:BX.util.htmlspecialchars(this.phones[i.userId].WORK_PHONE),onclick:BX.delegate(function(){this.BXIM.phoneTo(this.phones[i.userId].WORK_PHONE);this.closeMenuPopup()},this)})}}}else if(t=="callTransferMenu"){n=2;o=25;i.onSelect=BX.type.isFunction(i.onSelect)?i.onSelect:BX.DoNothing;r=[{icon:"bx-messenger-menu-call-voice",text:BX.message("IM_PHONE_INNER_CALL"),onclick:BX.delegate(function(){this.closeMenuPopup();i.onSelect({type:"user",userId:i.userId})},this)}];if(this.phones[i.userId]){r.push({separator:true});if(this.phones[i.userId].PERSONAL_MOBILE){r.push({type:"call",text:BX.message("IM_PHONE_PERSONAL_MOBILE"),phone:BX.util.htmlspecialchars(this.phones[i.userId].PERSONAL_MOBILE),onclick:BX.delegate(function(){this.closeMenuPopup();i.onSelect({type:"phone",userId:i.userId,phone:this.phones[i.userId].PERSONAL_MOBILE})},this)})}if(this.phones[i.userId].PERSONAL_PHONE){r.push({type:"call",text:BX.message("IM_PHONE_PERSONAL_PHONE"),phone:BX.util.htmlspecialchars(this.phones[i.userId].PERSONAL_PHONE),onclick:BX.delegate(function(){this.closeMenuPopup();i.onSelect({type:"phone",userId:i.userId,phone:this.phones[i.userId].PERSONAL_PHONE})},this)})}if(this.phones[i.userId].WORK_PHONE){r.push({type:"call",text:BX.message("IM_PHONE_WORK_PHONE"),phone:BX.util.htmlspecialchars(this.phones[i.userId].WORK_PHONE),onclick:BX.delegate(function(){this.closeMenuPopup();i.onSelect({type:"phone",userId:i.userId,phone:this.phones[i.userId].WORK_PHONE})},this)})}}}else if(t=="callContextMenu"){var C=BX.MessengerCommon.phoneGetCallFields(this.getChatId());r=[{icon:"bx-messenger-menu-history-2",text:BX.message("IM_M_HISTORY"),onclick:BX.delegate(function(){this.openHistory(this.currentTab);this.closeMenuPopup()},this)},C.crm?{icon:"bx-messenger-menu-crm",text:BX.message("IM_M_OL_GOTO_CRM"),href:C.crmShowUrl,target:"_blank",onclick:BX.delegate(function(){this.closeMenuPopup()},this)}:null]}else if(t=="chatUser"){var I=i.userId||e.getAttribute("data-userId");var h=this.getChatId();var u=this.chat[h].owner==this.BXIM.userId;if(this.users[this.BXIM.userId].connector){return false}if(I==this.BXIM.userId){var b=false;if(BX.MessengerCommon.checkRestriction(h,u?"LEAVE_OWNER":"LEAVE")){b=true}else{b=this.chat[h].type=="lines"&&(this.chat[h].owner==0||this.chat[h].owner==this.BXIM.userId)}r=[{icon:"bx-messenger-menu-profile",text:BX.message("IM_M_OPEN_PROFILE"),href:this.BXIM.path.profile,onclick:BX.delegate(function(){this.closeMenuPopup()},this)},b?null:{icon:"bx-messenger-menu-chat-exit",text:BX.message("IM_M_CHAT_EXIT"),onclick:BX.delegate(function(){BX.MessengerCommon.leaveFromChat(h);this.closeMenuPopup()},this)}]}else if(this.chat[h].type=="lines"&&this.users[I].connector){r=[{icon:"bx-messenger-menu-chat-put",text:BX.message("IM_M_CHAT_PUT"),onclick:BX.delegate(function(){this.insertTextareaText(this.popupMessengerTextarea," "+BX.util.htmlspecialcharsback(this.users[I].name)+" ",false);BX.MessengerCommon.addMentionList(this.currentTab,BX.util.htmlspecialcharsback(this.users[I].name),I);this.popupMessengerTextarea.focus();this.closeMenuPopup()},this)}]}else if(this.chat[h].type=="videoconf"&&this.users[I].external_auth_id=="call"){var y=!BX.MessengerCommon.checkRestriction(h,"LEAVE")&&!this.BXIM.userExtranet;r=[{icon:"bx-messenger-menu-chat-put",text:BX.message("IM_M_CHAT_PUT"),onclick:BX.delegate(function(){this.insertTextareaText(this.popupMessengerTextarea," "+BX.util.htmlspecialcharsback(this.users[I].name)+" ",false);BX.MessengerCommon.addMentionList(this.currentTab,BX.util.htmlspecialcharsback(this.users[I].name),I);this.popupMessengerTextarea.focus();this.closeMenuPopup()},this)},y?{icon:"bx-messenger-menu-chat-exit",text:BX.message("IM_M_CHAT_KICK"),onclick:BX.delegate(function(){this.kickFromChat(h,I);this.closeMenuPopup()},this)}:{}]}else{var y=!BX.MessengerCommon.checkRestriction(h,"LEAVE")&&this.chat[h].owner==this.BXIM.userId;var x=this.chat[h].type==="announcement";var v=true;if(h!=this.generalChatId){v=BX.MessengerCommon.userInChat(h)}else if(!this.canSendMessageGeneralChat||this.BXIM.settings.generalNotify){v=false}r=[!v||x?null:{icon:"bx-messenger-menu-chat-put",text:BX.message("IM_M_CHAT_PUT"),onclick:BX.delegate(function(){this.insertTextareaText(this.popupMessengerTextarea," "+BX.util.htmlspecialcharsback(this.users[I].name)+" ",false);BX.MessengerCommon.addMentionList(this.currentTab,BX.util.htmlspecialcharsback(this.users[I].name),I);this.popupMessengerTextarea.focus();this.closeMenuPopup()},this)},{icon:"bx-messenger-menu-write",text:BX.message("IM_M_WRITE_MESSAGE"),onclick:BX.delegate(function(){this.openMessenger(I);this.closeMenuPopup()},this)},!this.BXIM.checkCallSupport(I)||BX.MessengerCalls.hasActiveCall()?null:{icon:"bx-messenger-menu-video",text:BX.message("IM_M_CALL_VIDEO_HD"),onclick:BX.delegate(function(){this.BXIM.callTo(I,true);this.closeMenuPopup()},this)},{icon:"bx-messenger-menu-history",text:BX.message("IM_M_OPEN_HISTORY"),onclick:BX.delegate(function(){this.openHistory(I);this.closeMenuPopup()},this)},{icon:"bx-messenger-menu-profile",text:BX.message("IM_M_OPEN_PROFILE"),href:this.users[I].profile,onclick:BX.delegate(function(){this.closeMenuPopup()},this)},y?{icon:"bx-messenger-menu-chat-exit",text:BX.message("IM_M_CHAT_KICK"),onclick:BX.delegate(function(){this.kickFromChat(h,I);this.closeMenuPopup()},this)}:{}]}}else if(t=="contactList"){n=2;o=25;var I=i.userId?i.userId:e.getAttribute("data-userId");var T=i.userIsChat?i.userIsChat:e.getAttribute("data-userIsChat")===true||e.getAttribute("data-userIsChat")=="true";var S=i.dialogIsPinned?i.dialogIsPinned:e.getAttribute("data-isPinned")===true||e.getAttribute("data-isPinned")=="true";var u=T&&this.chat[I.toString().substr(4)].owner==this.BXIM.userId;if(this.recentList||T){var _=T&&this.chat[I.toString().substr(4)]&&this.chat[I.toString().substr(4)].type=="lines";var x=T&&this.chat[I.toString().substr(4)].type==="announcement";var E=BX.message("IM_M_CHAT_MUTE_OFF");var N=false;if(T){N=true}else if(this.users[I].extranet){N=true}else if(x){N=false}if(N&&this.muteButtonStatus(I)){E=BX.message("IM_M_CHAT_MUTE_ON")}var w=true;if(!this.recentList){w=false}else{for(var A=0;A<this.recent.length;A++){if(typeof this.recent[A]==="undefined"){continue}if(this.recent[A].userId==I&&this.recent[A].id.toString().substr(0,8)==="tempSort"){w=false;break}}}var k=BX.message(!S?"IM_M_OL_PIN_ON":"IM_M_OL_PIN_OFF");hideItem=!BX.MessengerCommon.userInChat(I.toString().substr(4));r=[_?null:{icon:"bx-messenger-menu-write",text:BX.message("IM_M_WRITE_MESSAGE"),onclick:BX.delegate(function(){this.openMessenger(I);this.closeMenuPopup()},this)},_||!w?null:{icon:"bx-messenger-menu-pin",text:k,onclick:BX.delegate(function(){BX.MessengerCommon.pinDialog(I,!S);this.closeMenuPopup()},this)},!x&&!_&&!hideItem&&N?{icon:"bx-messenger-menu-chat-mute",text:E,onclick:BX.delegate(function(){BX.MessengerCommon.muteMessageChat(I);this.closeMenuPopup()},this)}:{},x||_||(!this.BXIM.checkCallSupport(I)||BX.MessengerCalls.hasActiveCall())||T&&(this.chat[I.toString().substr(4)].type=="call"||this.chat[I.toString().substr(4)].type=="lines")?null:{icon:"bx-messenger-menu-video",text:BX.message("IM_M_CALL_VIDEO_HD"),onclick:BX.delegate(function(){this.BXIM.callTo(I,true);this.closeMenuPopup()},this)},hideItem&&!T?null:{icon:"bx-messenger-menu-history",text:BX.message("IM_M_OPEN_HISTORY"),onclick:BX.delegate(function(){this.openHistory(I);this.closeMenuPopup()},this)},!T?{icon:"bx-messenger-menu-profile",text:BX.message("IM_M_OPEN_PROFILE"),href:this.users[I].profile,onclick:BX.delegate(function(){this.closeMenuPopup()},this)}:{},!hideItem&&!x&&T&&this.chat[I.toString().substr(4)].type!="call"&&!BX.MessengerCommon.checkRestriction(I.toString().substr(4),"RENAME")?{icon:"bx-messenger-menu-chat-rename",text:BX.message("IM_M_CHAT_RENAME"),onclick:BX.delegate(function(){if(this.currentTab!=I){this.openMessenger(I)}else{this.renameChatDialog()}this.closeMenuPopup()},this)}:{},_||T&&!this.recentList?null:{icon:"bx-messenger-menu-hide-"+(T?"chat":"dialog"),text:BX.message("IM_M_HIDE_"+(T?this.chat[I.toString().substr(4)].type=="call"?"CALL":"CHAT":"DIALOG")),onclick:BX.delegate(function(){BX.MessengerCommon.recentListHide(I);this.closeMenuPopup()},this)},!hideItem&&T&&this.chat[I.toString().substr(4)].type!="call"&&this.chat[I.toString().substr(4)].type!="lines"&&!BX.MessengerCommon.checkRestriction(I.toString().substr(4),u?"LEAVE_OWNER":"LEAVE")?{icon:"bx-messenger-menu-chat-exit",text:BX.message("IM_M_CHAT_EXIT"),onclick:BX.delegate(function(){BX.MessengerCommon.leaveFromChat(I.toString().substr(4));this.closeMenuPopup()},this)}:{}]}else{r=[{icon:"bx-messenger-menu-write",text:BX.message("IM_M_WRITE_MESSAGE"),onclick:BX.delegate(function(){this.openMessenger(I);this.closeMenuPopup()},this)},!T&&(!this.BXIM.checkCallSupport(I)||BX.MessengerCalls.hasActiveCall())?null:{icon:"bx-messenger-menu-video",text:BX.message("IM_M_CALL_VIDEO_HD"),onclick:BX.delegate(function(){this.BXIM.callTo(I,true);this.closeMenuPopup()},this)},{icon:"bx-messenger-menu-history",text:BX.message("IM_M_OPEN_HISTORY"),onclick:BX.delegate(function(){this.openHistory(I);this.closeMenuPopup()},this)},{icon:"bx-messenger-menu-profile",text:BX.message("IM_M_OPEN_PROFILE"),href:this.users[I].profile,onclick:BX.delegate(function(){this.closeMenuPopup()},this)}]}}else if(t=="dialogContext"||t=="dialogMenu"){var D=[];if(t=="dialogMenu"){this.popupPopupMenuStyle="bx-messenger-content-item-menu-hover";p={offset:12};if(e.parentNode.parentNode){D=[BX("im-message-"+e.parentNode.parentNode.getAttribute("data-blockmessageid"))]}}else{var L=false;if(e.target.className.indexOf("bx-messenger-file")>=0||e.target.className.indexOf("bx-bxu-proper-canvas")>=0){var P=BX.findParent(e.target,{className:"bx-messenger-file-box"});if(P&&P.previousSibling){L=true;D=[P.previousSibling]}}if(!L){if(BX.hasClass(e.target,"bx-messenger-message")){D=[e.target]}else if(e.target.className.indexOf("bx-messenger-content-quote")>=0){D=BX.findParent(e.target,{className:"bx-messenger-message"});D=[D]}else{D=BX.findChildrenByClassName(e.target,"bx-messenger-message")}if(D.length<=0){D=BX.findParent(e.target,{className:"bx-messenger-message"});if(!D){if(e.target.className.substr(0,19)=="bx-messenger-attach"||e.target.tagName=="A"){var O=BX.findParent(e.target,{className:"bx-messenger-attach-box"});D=O.previousSibling}}D=[D]}}}if(D.length<=0||!D[D.length-1])return false;var R=BX.message("IM_M_SYSTEM_USER");var H=D[D.length-1].id.replace("im-message-","");if(this.message[H].senderId&&this.users[this.message[H].senderId])R=this.users[this.message[H].senderId].name;if(H.substr(0,4)=="temp")return false;var F=this.message[H].date;var U=t=="dialogContext"?BX.desktop.clipboardSelected():{text:"",selectionStart:0,selectionEnd:0};var V=false;var W="";var I=this.message[H].senderId;var x=this.chat[this.message[H].chatId]&&this.chat[this.message[H].chatId].type==="announcement";var G=this.message[H].params&&this.message[H].params.DATE_TS&&this.message[H].params.DATE_TS.length>0;if(this.openChatFlag&&this.message[H].senderId!=this.BXIM.userId&&this.users[this.message[H].senderId]){W=this.users[this.message[H].senderId].name}var Y=null;var j="";if(t=="dialogContext"&&(e.target.tagName=="SPAN"&&e.target.parentNode.parentNode.tagName=="A"||e.target.tagName=="CANVAS"&&e.target.parentNode.tagName=="A"||e.target.tagName=="IMG"&&e.target.parentNode.tagName=="A"||e.target.tagName=="A")){if(e.target.tagName=="A")j=e.target.href;else if(e.target.parentNode.tagName=="A")j=e.target.parentNode.href;else if(e.target.parentNode.parentNode.tagName=="A")j=e.target.parentNode.parentNode.href;if(j.indexOf("/desktop_app/")<0)V=true}else if(t=="dialogContext"&&e.target.tagName=="IMG"&&e.target.classList.contains("bx-icon")){Y=e.target.src}var z=this.message[H].params&&this.message[H].params.IS_DELETED!="Y"&&this.message[H].params.FILE_ID&&this.message[H].params.FILE_ID.length>0&&BX.clipboard.isCopySupported();var K=false;if(t=="dialogContext"&&BX.desktop){K=true}var J=false;var q=false;if(BX.MessengerCommon.checkEditMessage(H,"edit")){J=true}if(BX.MessengerCommon.checkEditMessage(H,"delete")){q=true}if(this.openChatFlag&&this.message[H].chatId&&!BX.MessengerCommon.userInChat(this.message[H].chatId)){return false}var Z=false;if(this.openChatFlag&&this.message[H].chatId&&this.generalChatId==this.message[H].chatId){if(this.BXIM.isAdmin&&!this.message[H].isNowDeleted){q=true}if(!this.canSendMessageGeneralChat){Z=true}}var Q=x||U.text.length>0||this.users[this.BXIM.userId].extranet;var $=Q||!this.chat[this.message[H].chatId]||this.chat[this.message[H].chatId].entity_type!="LINES";var ee=$||(!this.message[H].text||this.message[H].text.length<=0);var te={text:BX.message("IM_MENU_TO_OL_QA"),onclick:BX.delegate(function(){BX.MessengerCommon.linesSaveToQuickAnswers(H);this.closeMenuPopup()},this)};if(this.message[H].quick_saved){te.text=BX.message("IM_MENU_TO_OL_QA_ADDED");te.onclick=null}r=[W.length<=0||Z||x?null:{text:BX.message("IM_MENU_ANSWER"),onclick:BX.delegate(function(e){this.insertTextareaText(this.popupMessengerTextarea," "+BX.util.htmlspecialcharsback(W)+" ",false);BX.MessengerCommon.addMentionList(this.currentTab,BX.util.htmlspecialcharsback(W),I);setTimeout(BX.delegate(function(){this.popupMessengerTextarea.focus()},this),200);this.closeMenuPopup()},this)},W.length<=0||Z||x?null:{separator:true},V?{text:BX.message("IM_MENU_COPY3"),onclick:BX.delegate(function(){BX.clipboard.copy(j);this.closeMenuPopup()},this)}:null,z?{text:BX.message("IM_MENU_COPY_FILE"),onclick:BX.delegate(function(){var e="";for(var t=0;t<this.message[H].params.FILE_ID.length;t++){e=e+"[DISK="+this.message[H].params.FILE_ID[t]+"]"}BX.clipboard.copy(e);this.closeMenuPopup()},this)}:null,Y?{text:BX.message("IM_SETTINGS_SAVE"),onclick:BX.delegate(function(){this.addRecentSmile(this.message[H].text,Y);this.closeMenuPopup()},this)}:null,Y||z||V&&this.message[H].text?{separator:true}:null,I==this.BXIM.userId||U.text.length>0?null:{text:BX.message("IM_MENU_UNREAD"),onclick:BX.delegate(function(){BX.MessengerCommon.unreadMessage(H);this.closeMenuPopup()},this)},I==this.BXIM.userId?null:{separator:true},U.text.length<=0||Z||x?null:{text:BX.message("IM_MENU_QUOTE"),onclick:BX.delegate(function(){var e=BX.IM.getSelectionText();this.insertQuoteText(R,F,e);this.closeMenuPopup()},this)},Z||x||U.text.length>0||!this.message[H].text&&(!this.message[H].params||!this.message[H].params.FILE_ID||this.message[H].params.FILE_ID.length<=0)?null:{text:BX.message("IM_MENU_QUOTE2"),onclick:BX.delegate(function(){var e=[];for(var t=0;t<D.length;t++){var s=D[t].id.replace("im-message-","");if(this.message[s]){if(this.message[s].text){e.push(BX.MessengerCommon.prepareTextBack(this.message[s].text))}if(this.message[s].params&&this.message[s].params.FILE_ID){for(var i=0;i<this.message[s].params.FILE_ID.length;i++){var a=this.message[s].params.FILE_ID[i];var n=this.message[s].chatId;if(this.disk.files[n][a]){e.push("["+BX.message("IM_F_FILE")+": "+this.disk.files[n][a].name+"]")}}}}}if(e.length>0){this.insertQuoteText(R,F,e.join("\n"))}this.closeMenuPopup()},this)},!K||U.text.length<=0?null:{text:BX.message("IM_MENU_COPY"),onclick:BX.delegate(function(){BX.desktop.clipboardCopy();this.closeMenuPopup()},this)},!K||!this.message[H].text||U.text.length>0?null:{text:BX.message("IM_MENU_COPY2"),onclick:BX.delegate(function(){var e=[];for(var t=0;t<D.length;t++){var s=D[t].id.replace("im-message-","");if(this.message[s]){if(this.message[s].text){e.push(BX.MessengerCommon.prepareTextBack(this.message[s].text))}if(this.message[s].params&&this.message[s].params.FILE_ID){for(var i=0;i<this.message[s].params.FILE_ID.length;i++){var a=this.message[s].params.FILE_ID[i];var n=this.message[s].chatId;if(this.disk.files[n][a]){e.push("["+BX.message("IM_F_FILE")+": "+this.disk.files[n][a].name+"]")}}}}}if(e.length>0){BX.desktop.clipboardCopy(BX.delegate(function(t){return this.insertQuoteText(R,F,e.join("\n"),false)},this))}this.closeMenuPopup()},this)},Q?null:{separator:true},Q?null:{text:BX.message("IM_MENU_TO_TASK"),onclick:BX.delegate(function(){this.shareMessage(H,"TASK");this.closeMenuPopup()},this)},Q||!G?null:{text:BX.message("IM_MENU_TO_CALEND"),onclick:BX.delegate(function(){this.shareMessage(H,"CALEND");this.closeMenuPopup()},this)},Q?null:{text:BX.message("IM_MENU_TO_CHAT"),onclick:BX.delegate(function(){this.shareMessage(H,"CHAT");this.closeMenuPopup()},this)},Q?null:{text:BX.message("IM_MENU_TO_POST"),onclick:BX.delegate(function(){this.shareMessage(H,"POST");this.closeMenuPopup()},this)},$?null:{separator:true},$?null:{text:BX.message("IM_MENU_TO_OL_START"),onclick:BX.delegate(function(){BX.MessengerCommon.linesStartSessionByMessage(H);this.closeMenuPopup()},this)},ee?null:te,!(!J||this.message[H].senderId!=this.BXIM.userId)||q?{separator:true}:null,!J||this.message[H].senderId!=this.BXIM.userId?null:{text:BX.message("IM_MENU_EDIT"),onclick:BX.delegate(function(){this.editMessage(H);this.closeMenuPopup()},this)},!q?null:{text:BX.message("IM_M_HISTORY_DELETE"),onclick:BX.delegate(function(){this.deleteMessage(H,false);this.closeMenuPopup()},this)}];if(this.message[H].params&&this.message[H].params.MENU){var se=true;for(var m=0;m<this.message[H].params.MENU.length;m++){var ie=this.message[H].params.MENU[m];if(ie.CONTEXT&&(BX.MessengerCommon.isMobile()&&ie.CONTEXT=="DESKTOP"||!BX.MessengerCommon.isMobile()&&ie.CONTEXT=="MOBILE")){continue}if(se){r.push({separator:true});se=false}var ae=ie.DISABLED=="Y";r.push({text:ie.TEXT,disabled:ae,icon:"bx-messenger-menu-important",dataParams:ie,href:ie.LINK?ie.LINK:"",onclick:ae?null:BX.delegate(function(){var e=JSON.parse(BX.proxy_context.getAttribute("data-params"));if(e.FUNCTION){var t=e.FUNCTION.toString().replace("#MESSAGE_ID#",H).replace("#DIALOG_ID#",this.currentTab).replace("#USER_ID#",this.BXIM.userId);t()}else if(e.APP_ID){e.APP_PARAMS=e.APP_PARAMS?e.APP_PARAMS:"";this.textareaIconDialogClick(parseInt(e.APP_ID),H,BX.util.htmlspecialchars(e.APP_PARAMS))}else if(e.COMMAND&&e.COMMAND_PARAMS){BX.ajax({url:this.BXIM.pathToCallAjax+"?BOT_COMMAND&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_BOT_COMMAND:"Y",BOT_ID:e.BOT_ID,COMMAND:e.COMMAND,COMMAND_PARAMS:e.COMMAND_PARAMS,COMMAND_CONTEXT:"MENU",DIALOG_ID:this.currentTab,MESSAGE_ID:H,IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()}})}this.closeMenuPopup()},this)})}}}else if(t=="shareMenu"){var H=e.getAttribute("data-messageId");var ne=e.getAttribute("data-ts");var Q=this.users[this.BXIM.userId].extranet;r=[Q?null:{text:BX.message("IM_MENU_TO_TASK"),onclick:BX.delegate(function(){this.shareMessage(H,"TASK",ne);this.closeMenuPopup()},this)},Q?null:{text:BX.message("IM_MENU_TO_CALEND"),onclick:BX.delegate(function(){this.shareMessage(H,"CALEND",ne);this.closeMenuPopup()},this)},Q?null:{text:BX.message("IM_MENU_TO_CHAT"),onclick:BX.delegate(function(){this.shareMessage(H,"CHAT",ne);this.closeMenuPopup()},this)}]}else if(t=="history"){var D=[];if(e.target.className=="bx-messenger-history-item"){D=[e.target]}else if(e.target.className.indexOf("bx-messenger-content-quote")>=0){D=BX.findParent(e.target,{className:"bx-messenger-history-item"});D=[D]}else{D=BX.findChildrenByClassName(e.target,"bx-messenger-history-item")}if(D.length<=0){D=BX.findParent(e.target,{className:"bx-messenger-history-item"});D=[D]}if(D.length<=0||!D[D.length-1])return false;var R=BX.message("IM_M_SYSTEM_USER");var H=D[D.length-1].getAttribute("data-messageId");if(this.message[H].senderId&&this.users[this.message[H].senderId])R=this.users[this.message[H].senderId].name;var F=this.message[H].date;if(BX.desktop){var U=BX.desktop.clipboardSelected();var V=false;var j="";if(e.target.tagName=="IMG"&&e.target.parentNode.tagName=="A"||e.target.tagName=="A"){if(e.target.tagName=="A")j=e.target.href;else j=e.target.parentNode.href;if(j.indexOf("/desktop_app/")<0||j.indexOf("/desktop_app/show.file.php")>=0)V=true}var oe=this.BXIM.messenger.historySearch?true:false;r=[oe?{text:BX.message("IM_HISTORY_RELATED"),onclick:BX.delegate(function(){this.showContext(H);this.closeMenuPopup()},this)}:null,oe?{separator:true}:null,V?{text:BX.message("IM_MENU_COPY3"),onclick:BX.delegate(function(){BX.desktop.clipboardCopy(BX.delegate(function(){return j},this));this.closeMenuPopup()},this)}:null,V?{separator:true}:null,U.text.length<=0?null:{text:BX.message("IM_MENU_QUOTE"),onclick:BX.delegate(function(){var e=BX.IM.getSelectionText();this.insertQuoteText(R,F,e);this.closeMenuPopup()},this)},{text:BX.message("IM_MENU_QUOTE2"),onclick:BX.delegate(function(){var e=[];for(var t=0;t<D.length;t++){var s=D[t].getAttribute("data-messageId");if(this.message[s]){if(this.message[s].text){e.push(BX.MessengerCommon.prepareTextBack(this.message[s].text))}if(this.message[s].params&&this.message[s].params.FILE_ID){for(var i=0;i<this.message[s].params.FILE_ID.length;i++){var a=this.message[s].params.FILE_ID[t];var n=this.message[s].chatId;if(this.disk.files[n][a]){e.push("["+BX.message("IM_F_FILE")+": "+this.disk.files[n][a].name+"]")}}}}}if(e.length>0){this.insertQuoteText(R,F,e.join("\n"))}this.closeMenuPopup()},this)},{separator:true},U.text.length<=0?null:{text:BX.message("IM_MENU_COPY"),onclick:BX.delegate(function(){BX.desktop.clipboardCopy();this.closeMenuPopup()},this)},{text:BX.message("IM_MENU_COPY2"),onclick:BX.delegate(function(){var e=[];for(var t=0;t<D.length;t++){var s=D[t].getAttribute("data-messageId");if(this.message[s]){if(this.message[s].text){e.push(BX.MessengerCommon.prepareTextBack(this.message[s].text))}if(this.message[s].params&&this.message[s].params.FILE_ID){for(var i=0;i<this.message[s].params.FILE_ID.length;i++){var a=this.message[s].params.FILE_ID[i];var n=this.message[s].chatId;if(this.disk.files[n][a]){e.push("["+BX.message("IM_F_FILE")+": "+this.disk.files[n][a].name+"]")}}}}}if(e.length>0){BX.desktop.clipboardCopy(BX.delegate(function(t){return this.insertQuoteText(R,F,e.join("\n"),false)},this))}this.closeMenuPopup()},this)}]}else{var re=this.popupMessengerTextarea||opener;var oe=this.BXIM.messenger.historySearch?true:false;r=[oe?{text:BX.message("IM_HISTORY_RELATED"),onclick:BX.delegate(function(){this.showContext(H);this.closeMenuPopup()},this)}:null,re?{separator:true}:null,re?{text:BX.message("IM_MENU_QUOTE2"),onclick:BX.delegate(function(){var e=[];for(var t=0;t<D.length;t++){var s=D[t].getAttribute("data-messageId");if(this.message[s]){if(this.message[s].text){e.push(BX.MessengerCommon.prepareTextBack(this.message[s].text))}if(this.message[s].params&&this.message[s].params.FILE_ID){for(var i=0;i<this.message[s].params.FILE_ID.length;i++){var a=this.message[s].params.FILE_ID[t];var n=this.message[s].chatId;if(this.disk.files[n][a]){e.push("["+BX.message("IM_F_FILE")+": "+this.disk.files[n][a].name+"]")}}}}}if(e.length>0){this.insertQuoteText(R,F,e.join("\n"))}this.closeMenuPopup()},this)}:null,!oe&&!re?{text:BX.message("IM_P_CLOSE"),onclick:BX.delegate(function(){this.closeMenuPopup()},this)}:null]}}else if(t=="historyFileMenu"){n=4;o=8;this.popupPopupMenuStyle="bx-messenger-file-active";var le=i.fileId;var h=i.chatId;var pe=true;if(!this.disk.files[h][le])return false;var he=this.disk.files[h][le].authorId!=this.BXIM.userId;r=[pe?{text:BX.message("IM_F_DOWNLOAD"),href:this.disk.files[h][le].urlDownload,target:"_blank",onclick:BX.delegate(function(){this.closeMenuPopup()},this)}:null,{text:BX.message("IM_F_DOWNLOAD_DISK"),onclick:BX.delegate(function(){this.disk.saveToDisk(h,le,{boxId:"im-file-history-panel"});this.closeMenuPopup()},this)},this.chat[h]&&this.chat[h].type=="open"&&he?null:{text:BX.message("IM_F_DELETE"),onclick:BX.delegate(function(){this.BXIM.openConfirm(he?BX.message("IM_F_DELETE_SELF_CONFIRM"):BX.message("IM_F_DELETE_CONFIRM"),[new BX.PopupWindowButton({text:BX.message("IM_F_DELETE_CONFIRM_YES"),className:"popup-window-button-accept",events:{click:BX.delegate(function(){this.disk.deleteFile(h,le,{boxId:"im-file-history-panel"});BX.proxy_context.popupWindow.close()},this)}}),new BX.PopupWindowButton({text:BX.message("IM_NOTIFY_CONFIRM_CLOSE"),className:"popup-window-button",events:{click:function(){this.popupWindow.close()}}})],true);this.closeMenuPopup()},this)}]}else if(t=="notify"){if(e.target.className=="bx-notifier-item-delete"){e.target.setAttribute("id","bx-notifier-item-delete-"+e.target.getAttribute("data-notifyId"));this.openPopupMenu(e.target,"notifyDelete");return false}var U=BX.desktop.clipboardSelected();var V=false;if(e.target.tagName=="A"&&(e.target.href.indexOf("/desktop_app/")<0||j.indexOf("/desktop_app/show.file.php")>=0)){V=true;var j=e.target.href}else if(e.target.parentNode.tagName=="A"&&(e.target.parentNode.href.indexOf("/desktop_app/")<0||j.indexOf("/desktop_app/show.file.php")>=0)){V=true;var j=e.target.parentNode.href}if(!V&&U.text.length<=0){var B=e.target.getAttribute("data-notifyId");if(!B){B=e.target.parentNode.parentNode.getAttribute("data-notifyId");if(!B){B=e.target.parentNode.getAttribute("data-notifyId")}}if(B){e.target.setAttribute("data-notifyId",B);this.openPopupMenu(e.target,"notifyDelete",false,{applyToDom:e})}return false}r=[V?{text:BX.message("IM_MENU_COPY3"),onclick:BX.delegate(function(){BX.desktop.clipboardCopy(BX.delegate(function(){return j},this));this.closeMenuPopup()},this)}:null,V?{separator:true}:null,U.text.length<=0?null:{text:BX.message("IM_MENU_COPY"),onclick:BX.delegate(function(){BX.desktop.clipboardCopy();this.closeMenuPopup()},this)}]}else if(t=="copylink"){if(e.target.tagName!="A"||e.target.href.indexOf("/desktop_app/")>=0&&e.target.href.indexOf("/desktop_app/show.file.php")<0)return false;r=[{text:BX.message("IM_MENU_COPY3"),onclick:BX.delegate(function(){BX.desktop.clipboardCopy(BX.delegate(function(t){return e.target.href},this));this.closeMenuPopup()},this)}]}else if(t=="copypaste"){if(i.spell&&!this.desktop.enableInVersion(34)){i.spell=false}r=[];var U=BX.desktop.clipboardSelected(e.target,i.spell);if(!U.text){i.spell=false}if(i.spell){if(i.spellReady){for(var m=0;m<i.suggest.length;m++){dataParams={suggest:i.suggest[m],selectionStart:U.selectionStart,selectionEnd:U.selectionEnd};r.push({text:i.suggest[m],slim:true,bold:true,dataParams:dataParams,onclick:BX.delegate(function(){var t=JSON.parse(BX.proxy_context.getAttribute("data-params"));setTimeout(function(){BX.desktop.clipboardReplaceText(e.target,t.selectionStart,t.selectionEnd,t.suggest)},50);this.closeMenuPopup()},this)});if(m==5)break}if(r.length<=0){r.push({text:BX.message("IM_MENU_SUGGEST_EMPTY"),bold:true,slim:true})}r.push({separator:true})}else{BXDesktopSystem.SpellCheckWord(U.text,BX.delegate(function(t,s){this.openPopupMenu(e,"copypaste",false,{spell:!t,spellReady:true,suggest:s})},this))}}if(!i.spell||i.spellReady){if(U.text.length){r.push({text:BX.message("IM_MENU_CUT"),onclick:BX.delegate(function(){BX.desktop.clipboardCut();this.closeMenuPopup()},this)}),r.push({text:BX.message("IM_MENU_COPY"),onclick:BX.delegate(function(){BX.desktop.clipboardCopy();this.closeMenuPopup()},this)}),r.push({text:BX.message("IM_MENU_DELETE"),onclick:BX.delegate(function(){BX.desktop.clipboardDelete();this.closeMenuPopup()},this)})}else{r.push({text:BX.message("IM_MENU_PASTE"),onclick:BX.delegate(function(){BX.desktop.clipboardPaste();this.closeMenuPopup()},this)})}l={position:"top"}}}else{r=[]}if(r.length<=0){return false}var ce=true;for(var m=0;m<r.length;m++){if(r[m]){ce=false}}if(ce){r=[{text:BX.message("IM_NOTIFY_CONFIRM_CLOSE"),onclick:BX.delegate(function(){this.closeMenuPopup()},this)}]}else{var ue=false;for(var m=0;m<r.length;m++){if(r[m]){if(r[m].separator){r[m]=null}else{break}}}}r=this.modifierPopupMenu(t,r);this.popupPopupMenuDateCreate=+new Date;this.popupPopupMenu=new BX.PopupWindow("bx-messenger-popup-"+t,e,{darkMode:this.BXIM.settings.enableDarkTheme,lightShadow:true,offsetTop:n,offsetLeft:o,autoHide:true,closeByEsc:true,zIndex:i.zIndex?i.zIndex:BX.MessengerCommon.getDefaultZIndex()+200,bindOptions:l,events:{onPopupClose:BX.delegate(function(){if(this.popupPopupMenuStyle&&this.popupPopupMenu){if(this.popupPopupMenuStyle=="bx-messenger-file-active")BX.removeClass(this.popupPopupMenu.bindElement.parentNode,this.popupPopupMenuStyle);else if(this.popupPopupMenuStyle=="bx-messenger-content-item-menu-hover")BX.removeClass(this.popupPopupMenu.bindElement.parentNode,this.popupPopupMenuStyle);else BX.removeClass(this.popupPopupMenu.bindElement,this.popupPopupMenuStyle)}if(this.popupPopupMenuDateCreate+500<+new Date)BX.proxy_context.destroy()},this),onPopupDestroy:BX.delegate(function(){if(this.popupPopupMenuStyle&&this.popupPopupMenu){if(this.popupPopupMenuStyle=="bx-messenger-file-active")BX.removeClass(this.popupPopupMenu.bindElement.parentNode,this.popupPopupMenuStyle);else if(this.popupPopupMenuStyle=="bx-messenger-content-item-menu-hover")BX.removeClass(this.popupPopupMenu.bindElement.parentNode,this.popupPopupMenuStyle);else BX.removeClass(this.popupPopupMenu.bindElement,this.popupPopupMenuStyle)}this.popupPopupMenu=null},this)},content:BX.create("div",{props:{className:"bx-messenger-popup-menu"},children:[BX.create("div",{props:{className:"bx-messenger-popup-menu-items"},children:BX.MessengerChat.MenuPrepareList(r)})]})});if(s!==false&&!this.BXIM.settings.enableDarkTheme)this.popupPopupMenu.setAngle(p);BX.addClass(this.popupPopupMenu.popupContainer,"bx-messenger-mark");this.popupPopupMenu.show();if(this.popupPopupMenuStyle){if(this.popupPopupMenuStyle=="bx-messenger-file-active")BX.addClass(e.parentNode,this.popupPopupMenuStyle);else if(this.popupPopupMenuStyle=="bx-messenger-content-item-menu-hover")BX.addClass(e.parentNode,this.popupPopupMenuStyle);else BX.addClass(e,this.popupPopupMenuStyle)}BX.bind(this.popupPopupMenu.popupContainer,"click",BX.MessengerCommon.preventDefault);if(t=="dialogContext"||t=="notify"||t=="history"||t=="copypaste"){BX.bind(this.popupPopupMenu.popupContainer,"mousedown",function(e){e.target.click()})}return false};BX.MessengerChat.prototype.modifierPopupMenu=function(e,t){var s=null;for(var i=0;i<this.popupPopupMenuModifyFunction.length;i++){s=this.popupPopupMenuModifyFunction[i](e,t);if(s){t=s}}return t};BX.MessengerChat.prototype.closePopupFileMenu=function(){if(this.popupMessengerFileButton==null)return false;if(this.popupPopupMenuDateCreate+100>+new Date)return false;if(BX.hasClass(this.popupMessengerFileButton,"bx-messenger-textarea-file-active")){BX.removeClass(this.popupMessengerFileButton,"bx-messenger-textarea-file-active");this.setClosingByEsc(true)}};BX.MessengerChat.prototype.closePopupFileMenuKeydown=function(e){if(e.keyCode==27){setTimeout(BX.delegate(function(){this.closePopupFileMenu()},this),100)}};BX.MessengerChat.prototype.openPopupExternalData=function(e,t,s,i){if(this.popupSmileMenu!=null)this.popupSmileMenu.destroy();if(this.popupPopupMenu!=null){this.popupPopupMenu.destroy();return false}this.popupPopupMenuDateCreate=+new Date;var a=0;var n=10;var o={position:"top"};var r={width:"272px",height:"100px"};var l={IM_GET_EXTERNAL_DATA:"Y",TYPE:t,TS:this.popupPopupMenuDateCreate,IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()};var p=BX.create("div",{attrs:{id:"bx-messenger-external-data"},props:{className:"bx-messenger-external-data"},style:r,children:[BX.create("div",{props:{className:"bx-messenger-external-data-load"},html:BX.message("IM_CL_LOAD")})]});if(t=="user"){r={width:"272px",height:"100px"};l["USER_ID"]=parseInt(i["ID"]);if(this.users[l["USER_ID"]]&&!this.users[l["USER_ID"]].fake){l=false}}else if(t=="chat"){r={width:"272px",height:"100px"};l["CHAT_ID"]=parseInt(i["ID"]);if(this.chat[l["CHAT_ID"]]&&!this.chat[l["CHAT_ID"]].fake){l=false}}else if(t=="phoneCallHistory"){r={width:"239px",height:"122px"};l["HISTORY_ID"]=parseInt(i["ID"])}else if(t=="readedList"){l=false;var h=[];var c=0;var u=0;for(var d in this.BXIM.messenger.readedList[this.BXIM.messenger.currentTab]){if(d==this.BXIM.userId)continue;if(!u||u>this.BXIM.messenger.readedList[this.BXIM.messenger.currentTab][d].date){c=d;u=this.BXIM.messenger.readedList[this.BXIM.messenger.currentTab][d].date}h.push({userId:d,date:this.BXIM.messenger.readedList[this.BXIM.messenger.currentTab][d].date})}var m='<span class="bx-notifier-item-help-popup">';for(var g=0;g<h.length;g++){if(h[g].userId==c)continue;var f=BX.MessengerCommon.isBlankAvatar(this.BXIM.messenger.users[h[g].userId].avatar)?'style="background-color: '+this.BXIM.messenger.users[h[g].userId].color+'"':"";m+='<span class="bx-notifier-item-help-popup-img bx-messenger-panel-chat-user" data-userId="'+h[g].userId+'" title="'+BX.MessengerCommon.formatDate(h[g].date)+'">'+'<span class="bx-notifier-popup-avatar  bx-notifier-popup-avatar-status-'+BX.MessengerCommon.getUserStatus(this.users[h[g].userId])+'">'+'<img class="bx-notifier-popup-avatar-img'+(BX.MessengerCommon.isBlankAvatar(this.BXIM.messenger.users[h[g].userId].avatar)?" bx-notifier-popup-avatar-img-default":"")+'" src="'+this.BXIM.messenger.users[h[g].userId].avatar+'" '+f+">"+"</span>"+'<span class="bx-notifier-item-help-popup-name  '+(this.BXIM.messenger.users[h[g].userId].extranet?" bx-notifier-popup-avatar-extranet":"")+'">'+this.BXIM.messenger.users[h[g].userId].name+"</span>"+"</span>"}m+="</span>";p=BX.create("div",{props:{className:"bx-messenger-popup-menu"},html:m})}else{return false}this.popupPopupMenu=new BX.PopupWindow("bx-messenger-popup-external-data",e,{darkMode:this.BXIM.settings.enableDarkTheme,lightShadow:true,offsetTop:a,offsetLeft:n,autoHide:true,closeByEsc:true,zIndex:BX.MessengerCommon.getDefaultZIndex()+200,bindOptions:o,events:{onPopupClose:function(){this.destroy()},onPopupDestroy:BX.delegate(function(){this.popupPopupMenu=null},this)},content:p});BX.addClass(this.popupPopupMenu.popupContainer,"bx-messenger-mark");if(s!==false&&!this.BXIM.settings.enableDarkTheme)this.popupPopupMenu.setAngle({offset:4});this.popupPopupMenu.show();if(l){BX.ajax({url:this.BXIM.pathToAjax+"?GET_EXTERNAL_DATA&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:l,onsuccess:BX.delegate(function(e){if(e.ERROR){e.TYPE="noAccess"}else if(e.TYPE=="chat"){for(var t in e.CHAT){e.CHAT[t].date_create=new Date(e.CHAT[t].date_create);this.chat[t]=e.CHAT[t]}for(var t in e.USER_IN_CHAT){this.userInChat[t]=e.USER_IN_CHAT[t]}for(var t in e.USER_BLOCK_CHAT){this.userChatBlockStatus[t]=e.USER_BLOCK_CHAT[t]}}else if(e.TYPE=="user"){for(var t in e.USERS){e.USERS[t].last_activity_date=new Date(e.USERS[t].last_activity_date);e.USERS[t].mobile_last_date=new Date(e.USERS[t].mobile_last_date);e.USERS[t].idle=e.USERS[t].idle?new Date(e.USERS[t].idle):false;e.USERS[t].absent=e.USERS[t].absent?new Date(e.USERS[t].absent):false;this.users[t]=e.USERS[t]}for(var t in e.PHONES){this.phones[t]={};for(var s in e.PHONES[t]){this.phones[t][s]=BX.util.htmlspecialcharsback(e.PHONES[t][s])}}for(var t in e.USER_IN_GROUP){if(typeof this.userInGroup[t]=="undefined"){this.userInGroup[t]=e.USER_IN_GROUP[t]}else{for(var s=0;s<e.USER_IN_GROUP[t].users.length;s++)this.userInGroup[t].users.push(e.USER_IN_GROUP[t].users[s]);this.userInGroup[t].users=BX.util.array_unique(this.userInGroup[t].users)}}}e.TS=parseInt(e.TS);if(e.TS>0&&e.TS!=this.popupPopupMenuDateCreate||!this.popupPopupMenu)return false;this.drawExternalData(e.TYPE,e)},this),onfailure:BX.delegate(function(){if(this.popupPopupMenu)this.popupPopupMenu.destroy()},this)})}else{if(t=="user")this.drawExternalData("user",{USER_ID:i["ID"]});else if(t=="chat")this.drawExternalData("chat",{CHAT_ID:i["ID"]})}if(this.popupPopupMenu)BX.bind(this.popupPopupMenu.popupContainer,"click",BX.PreventDefault);return false};BX.MessengerChat.prototype.drawExternalData=function(e,t){if(!BX("bx-messenger-external-data"))return false;if(e=="noAccess"){BX("bx-messenger-external-data").innerHTML=BX.message("IM_M_USER_NO_ACCESS")}else if(e=="user"){if(!this.users[t["USER_ID"]]){if(this.popupPopupMenu)this.popupPopupMenu.destroy();return false}var s=false;BX("bx-messenger-external-data").innerHTML="";var i="";if(this.users[t["USER_ID"]].bot){if(this.bot[t["USER_ID"]]&&this.bot[t["USER_ID"]].type=="network"){i="bx-messenger-user-network"}else if(this.bot[t["USER_ID"]]&&this.bot[t["USER_ID"]].type=="support24"){i="bx-messenger-user-support24"}else{i="bx-messenger-user-bot"}}BX.adjust(BX("bx-messenger-external-data"),{children:[BX.create("div",{props:{className:"bx-messenger-external-avatar"},children:[BX.create("div",{props:{className:"bx-messenger-panel-avatar bx-messenger-panel-avatar-status-"+BX.MessengerCommon.getUserStatus(this.users[t["USER_ID"]])},children:[BX.create("img",{attrs:{src:this.users[t["USER_ID"]].avatar,style:BX.MessengerCommon.isBlankAvatar(this.users[t["USER_ID"]].avatar)?"background-color: "+this.users[t["USER_ID"]].color:""},props:{className:"bx-messenger-panel-avatar-img"+(BX.MessengerCommon.isBlankAvatar(this.users[t["USER_ID"]].avatar)?" bx-messenger-panel-avatar-img-default":"")}}),BX.create("span",{attrs:{title:BX.MessengerCommon.getUserStatus(this.users[t["USER_ID"]],false).statusText},props:{className:"bx-messenger-panel-avatar-status"}})]}),BX.create("span",{props:{className:"bx-messenger-panel-title"},html:this.users[t["USER_ID"]].extranet?'<div class="bx-messenger-user-extranet">'+this.users[t["USER_ID"]].name+"</div>":this.users[t["USER_ID"]].bot?'<div class="'+i+'">'+this.users[t["USER_ID"]].name+"</div>":this.users[t["USER_ID"]].name}),BX.create("span",{props:{className:"bx-messenger-panel-desc"},html:BX.MessengerCommon.getUserPosition(this.users[t["USER_ID"]])})]}),s?[]:BX.create("div",{props:{className:"bx-messenger-external-data-buttons"},children:[BX.create("span",{props:{className:"bx-notifier-item-button bx-notifier-item-button-white"},html:BX.message("IM_M_WRITE_MESSAGE"),events:{click:BX.delegate(function(e){this.popupPopupMenu.destroy();this.openMessenger(t["USER_ID"])},this)}}),BX.create("span",{props:{className:"bx-notifier-item-button bx-notifier-item-button-white"},html:BX.message("IM_M_CALL_BTN_HISTORY"),events:{click:BX.delegate(function(){this.popupPopupMenu.destroy();this.openHistory(t["USER_ID"])},this)}})]})]})}else if(e=="chat"){if(!this.chat[t["CHAT_ID"]]){if(this.popupPopupMenu)this.popupPopupMenu.destroy();return false}var a=BX.message("IM_CL_CHAT_NEW");if(this.chat[t["CHAT_ID"]].type=="call"){a=BX.message("IM_CL_PHONE")}else if(this.chat[t["CHAT_ID"]].type=="lines"){a=BX.message("IM_CL_LINES")}else if(this.chat[t["CHAT_ID"]].type=="livechat"){a=BX.message("IM_CL_LINES")}else if(this.chat[t["CHAT_ID"]].type=="open"){a=BX.message("IM_CL_OPEN_CHAT_NEW")}BX("bx-messenger-external-data").innerHTML="";BX.adjust(BX("bx-messenger-external-data"),{children:[BX.create("div",{props:{className:"bx-messenger-external-avatar"},children:[BX.create("div",{props:{className:"bx-messenger-panel-avatar bx-messenger-panel-avatar-"+this.chat[t["CHAT_ID"]].type},children:[BX.create("img",{attrs:{src:this.chat[t["CHAT_ID"]].avatar,style:BX.MessengerCommon.isBlankAvatar(this.chat[t["CHAT_ID"]].avatar)?"background-color: "+this.chat[t["CHAT_ID"]].color:""},props:{className:"bx-messenger-panel-avatar-img"+(BX.MessengerCommon.isBlankAvatar(this.chat[t["CHAT_ID"]].avatar)?" bx-messenger-panel-avatar-img-default":"")}})]}),BX.create("span",{props:{className:"bx-messenger-panel-title"},html:this.chat[t["CHAT_ID"]].extranet?'<div class="bx-messenger-user-extranet">'+this.chat[t["CHAT_ID"]].name+"</div>":this.chat[t["CHAT_ID"]].name}),BX.create("span",{props:{className:"bx-messenger-panel-desc"},html:a})]}),BX.create("div",{props:{className:"bx-messenger-external-data-buttons"},children:[BX.create("span",{props:{className:"bx-notifier-item-button bx-notifier-item-button-white"},html:BX.message("IM_M_OPEN_CHAT"),events:{click:BX.delegate(function(e){this.popupPopupMenu.destroy();this.openMessenger("chat"+t["CHAT_ID"])},this)}}),BX.create("span",{props:{className:"bx-notifier-item-button bx-notifier-item-button-white"},html:BX.message("IM_M_CALL_BTN_HISTORY"),events:{click:BX.delegate(function(){this.popupPopupMenu.destroy();this.openHistory("chat"+t["CHAT_ID"])},this)}})]})]})}else if(e=="phoneCallHistory"){var n=false;if(t["CALL_RECORD_HTML"]){var n={HTML:BX.message("CALL_RECORD_ERROR"),SCRIPT:[]};if(!BX.MessengerCommon.isDesktop()||this.BXIM.desktop.enableInVersion(43))n=BX.processHTML(t["CALL_RECORD_HTML"],false)}BX("bx-messenger-external-data").innerHTML="";BX.adjust(BX("bx-messenger-external-data"),{children:[BX.create("div",{props:{className:"bx-messenger-record"},children:[BX.create("div",{props:{className:"bx-messenger-record-phone-box"},children:[BX.create("span",{props:{className:"bx-messenger-record-icon bx-messenger-record-icon-"+t["CALL_ICON"]},attrs:{title:t["INCOMING_TEXT"]}}),BX.create("span",{props:{className:"bx-messenger-record-phone"},html:t["PHONE_NUMBER_FORMATTED"]?t["PHONE_NUMBER_FORMATTED"]:(t["PHONE_NUMBER"]&&t["PHONE_NUMBER"].toString().length>=10?"+":"")+t["PHONE_NUMBER"]})]}),BX.create("div",{props:{className:"bx-messenger-record-reason"},html:t["CALL_FAILED_REASON"]}),BX.create("div",{props:{className:"bx-messenger-record-stats"},children:[BX.create("span",{props:{className:"bx-messenger-record-time"},html:t["CALL_DURATION_TEXT"]}),BX.create("span",{props:{className:"bx-messenger-record-cost"},html:t["COST_TEXT"]})]}),n?BX.create("div",{props:{className:"bx-messenger-record-box"},children:[BX.create("span",{props:{className:"bx-messenger-record-player"},html:n.HTML})]}):null]})]});if(n){for(var o=0;o<n.SCRIPT.length;o++){BX.evalGlobal(n.SCRIPT[o].JS)}}}};BX.MessengerChat.prototype.openHistory=function(e){if(this.popupMessengerConnectionStatusState!="online")return false;if(this.historyWindowBlock)return false;this.historyLastSearch[e]="";if(!this.historyEndOfList[e])this.historyEndOfList[e]={};if(!this.historyLoadFlag[e])this.historyLoadFlag[e]={};if(this.popupHistory!=null)this.popupHistory.destroy();var t=0;var s=0;var i=this.BXIM.disk.enable;var a=false;if(e.toString().substr(0,4)=="chat"){a=true;t=parseInt(e.toString().substr(4));if(t<=0)return false}else{e=parseInt(e);if(e<=0)return false;t=this.userChat[e]?this.userChat[e]:0}this.historyFilesEndOfList[t]=false;this.historyFilesLoadFlag[t]=false;this.historyUserId=e;this.historyChatId=t;if(!BX.MessengerCommon.isPage())this.setClosingByEsc(false);this.popupHistoryPanel=null;var n=this.redrawHistoryPanel(e,t);this.popupHistoryElements=BX.create("div",{props:{className:"bx-messenger-history"+(i?" bx-messenger-history-with-disk":"")+(BX.browser.IsMac()?"":" bx-messenger-custom-scroll")},children:[this.popupHistoryPanel=BX.create("div",{props:{className:"bx-messenger-panel-wrap"},children:n}),BX.create("div",{props:{className:"bx-messenger-history-types"},children:[BX.create("span",{props:{className:"bx-messenger-history-type bx-messenger-history-type-message"},children:[this.popupHistoryButtonFilterBox=BX.create("div",{props:{className:"bx-messenger-panel-filter-box"},style:{display:"block"},children:[this.popupHistorySearchDateWrap=BX.create("div",{props:{className:"bx-messenger-filter-date bx-messenger-input-wrap"},html:'<span class="bx-messenger-input-date"></span><a class="bx-messenger-input-close" href="javascript:void(0);"></a><input type="text" class="bx-messenger-input" value="" tabindex="1003" placeholder="'+BX.message("IM_PANEL_FILTER_DATE")+'" />'}),this.popupHistorySearchWrap=BX.create("div",{props:{className:"bx-messenger-filter-text bx-messenger-history-filter-text bx-messenger-input-wrap"},html:'<a class="bx-messenger-input-close" href="javascript:void(0);"></a><input type="text" class="bx-messenger-input" tabindex="1000" placeholder="'+BX.message("IM_PANEL_FILTER_TEXT")+'" value="" />'})]}),this.popupHistoryItems=BX.create("div",{props:{className:"bx-messenger-history-items"},style:{height:this.popupHistoryItemsSize+"px"},children:[this.popupHistoryBodyWrap=BX.create("div",{props:{className:"bx-messenger-history-items-wrap"}})]})]}),BX.create("span",{props:{className:"bx-messenger-history-type bx-messenger-history-type-disk"},children:[this.popupHistoryFilesButtonFilterBox=BX.create("div",{props:{className:"bx-messenger-panel-filter-box"},style:{display:"block"},children:[this.popupHistoryFilesSearchWrap=BX.create("div",{props:{className:"bx-messenger-filter-text bx-messenger-input-wrap"},html:'<a class="bx-messenger-input-close" href="javascript:void(0);"></a><input type="text"  tabindex="1002" class="bx-messenger-input" placeholder="'+BX.message("IM_F_FILE_SEARCH")+'" value="" />'})]}),this.popupHistoryFilesItems=BX.create("div",{props:{className:"bx-messenger-history-items"},style:{height:this.popupHistoryItemsSize+"px"},children:[this.popupHistoryFilesBodyWrap=BX.create("div",{props:{className:"bx-messenger-history-items-wrap"}})]})]})]})]});if(this.BXIM.init&&BX.MessengerCommon.isDesktop()){this.desktop.openHistory(e,this.popupHistoryElements,"BXIM.openHistory('"+e+"');");return false}else if(BX.MessengerCommon.isDesktop()){this.popupHistory=new BX.PopupWindowDesktop;this.desktop.drawOnPlaceholder(this.popupHistoryElements);BX.bind(window,"keydown",BX.proxy(function(e){if(e.keyCode==27){if(this.popupHistorySearchInput.value==""){this.popupHistory.destroy()}else{this.popupHistorySearchInput.value="";this.popupHistorySearchInput.focus()}}},this))}else{this.popupHistory=new BX.PopupWindow("bx-messenger-popup-history",null,{darkMode:this.BXIM.settings.enableDarkTheme,autoHide:false,zIndex:BX.MessengerCommon.getDefaultZIndex()+200,draggable:{restrict:true},closeByEsc:true,events:{onPopupClose:function(){this.destroy()},onPopupDestroy:BX.delegate(function(){this.popupHistory=null;this.historySearch="";this.setClosingByEsc(true);this.closeMenuPopup();var e=BX.calendar.get();if(e){e.Close()}},this)},titleBar:{content:BX.create("span",{props:{className:"bx-messenger-title"},html:BX.message("IM_M_HISTORY")})},closeIcon:{right:"13px"},content:this.popupHistoryElements,contentColor:"white",noAllPaddings:true});BX.addClass(this.popupHistory.popupContainer,"bx-messenger-mark");this.popupHistory.show();BX.bind(this.popupHistory.popupContainer,"click",BX.MessengerCommon.preventDefault)}this.drawHistory(this.historyUserId);if(i){this.drawHistoryFiles(this.historyChatId)}if(BX.MessengerCommon.isDesktop()){BX.bind(this.popupHistorySearchInput,"contextmenu",BX.delegate(function(e){this.openPopupMenu(e,"copypaste",false);return BX.PreventDefault(e)},this));BX.bindDelegate(this.popupHistoryElements,"contextmenu",{className:"bx-messenger-history-item"},BX.delegate(function(e){this.openPopupMenu(e,"history",false);return BX.PreventDefault(e)},this))}BX.bindDelegate(this.popupHistoryElements,"click",{className:"bx-messenger-ajax"},BX.delegate(function(){if(BX.proxy_context.getAttribute("data-entity")=="user"){this.openPopupExternalData(BX.proxy_context,"user",true,{ID:BX.proxy_context.getAttribute("data-userId")})}else if(BX.proxy_context.getAttribute("data-entity")=="chat"){this.openPopupExternalData(BX.proxy_context,"chat",true,{ID:BX.proxy_context.getAttribute("data-chatId")})}else if(BX.proxy_context.getAttribute("data-entity")=="openlines"){this.linesOpenHistory(BX.proxy_context.getAttribute("data-sessionId"))}else if(BX.proxy_context.getAttribute("data-entity")=="network"){this.openMessenger("network"+BX.proxy_context.getAttribute("data-networkId"))}else if(BX.proxy_context.getAttribute("data-entity")=="date"){this.openPopupMenu(BX.proxy_context,"shareMenu")}else if(BX.proxy_context.getAttribute("data-entity")=="phoneCallHistory"){this.openPopupExternalData(BX.proxy_context,"phoneCallHistory",true,{ID:BX.proxy_context.getAttribute("data-historyID")})}},this));BX.bindDelegate(this.popupHistoryElements,"click",{className:"bx-messenger-history-item-menu"},BX.delegate(function(e){this.openPopupMenu(e,"history",false);return BX.PreventDefault(e)},this));BX.bindDelegate(this.popupHistoryPanel,"click",{className:"bx-messenger-panel-basket"},BX.delegate(function(){this.BXIM.openConfirm(BX.message("IM_M_HISTORY_DELETE_ALL_CONFIRM"),[new BX.PopupWindowButton({text:BX.message("IM_M_HISTORY_DELETE_ALL"),className:"popup-window-button-accept",events:{click:BX.delegate(function(){this.deleteAllHistory(e);BX.proxy_context.popupWindow.close()},this)}}),new BX.PopupWindowButton({text:BX.message("IM_NOTIFY_CONFIRM_CLOSE"),className:"popup-window-button",events:{click:function(){this.popupWindow.close()}}})],true)},this));this.popupHistorySearchInput=BX.findChildByClassName(this.popupHistorySearchWrap,"bx-messenger-input");this.popupHistorySearchInputClose=BX.findChildByClassName(this.popupHistorySearchInput.parentNode,"bx-messenger-input-close");this.popupHistorySearchDateInput=BX.findChildByClassName(this.popupHistorySearchDateWrap,"bx-messenger-input");this.popupHistorySearchDateInputClose=BX.findChildByClassName(this.popupHistorySearchDateInput.parentNode,"bx-messenger-input-close");BX.bind(this.popupHistorySearchDateInput,"focus",BX.delegate(function(e){BX.calendar({node:BX.proxy_context,field:BX.proxy_context,bTime:false,callback_after:BX.delegate(this.newHistoryDateSearch,this)});return BX.PreventDefault(e)},this));BX.bind(this.popupHistorySearchDateInput,"click",BX.delegate(function(e){BX.calendar({node:BX.proxy_context,field:BX.proxy_context,bTime:false,callback_after:BX.delegate(this.newHistoryDateSearch,this)});return BX.PreventDefault(e)},this));BX.bind(this.popupHistorySearchDateInputClose,"click",BX.delegate(function(e){this.popupHistorySearchDateInput.value="";this.historyDateSearch="";this.historyLastSearch[this.historyUserId]="";this.drawHistory(this.historyUserId,false,false)},this));if(this.popupHistoryFilterVisible&&!BX.browser.IsAndroid()&&!BX.browser.IsIOS())BX.focus(this.popupHistorySearchInput);BX.bind(this.popupHistorySearchInputClose,"click",BX.delegate(function(e){this.popupHistorySearchInput.value="";this.historySearch="";this.historyLastSearch[this.historyUserId]="";this.drawHistory(this.historyUserId,false,false);return BX.PreventDefault(e)},this));BX.bind(this.popupHistorySearchInput,"keyup",BX.delegate(this.newHistorySearch,this));BX.bind(this.popupHistoryItems,"scroll",BX.delegate(function(){BX.MessengerCommon.loadHistory(e)},this));if(this.disk.enable){BX.bindDelegate(this.popupHistoryFilesBodyWrap,"click",{className:"bx-messenger-file-menu"},BX.delegate(function(e){var t=BX.proxy_context.parentNode.parentNode.getAttribute("data-fileId");var s=BX.proxy_context.parentNode.parentNode.getAttribute("data-chatId");this.openPopupMenu(BX.proxy_context,"historyFileMenu",true,{fileId:t,chatId:s});return BX.PreventDefault(e)},this));this.popupHistoryFilesSearchInput=BX.findChildByClassName(this.popupHistoryFilesSearchWrap,"bx-messenger-input");this.popupHistoryFilesSearchInputClose=BX.findChildByClassName(this.popupHistoryFilesSearchInput.parentNode,"bx-messenger-input-close");BX.bind(this.popupHistoryFilesSearchInputClose,"click",BX.delegate(function(e){this.popupHistoryFilesSearchInput.value="";this.historyFilesSearch="";this.historyFilesLastSearch[this.historyChatId]="";this.drawHistoryFiles(this.historyChatId,false,false);return BX.PreventDefault(e)},this));BX.bind(this.popupHistoryFilesSearchInput,"keyup",BX.delegate(this.newHistoryFilesSearch,this));BX.bind(this.popupHistoryFilesItems,"scroll",BX.delegate(function(){this.loadHistoryFiles(this.historyChatId)},this))}};BX.MessengerChat.prototype.loadHistoryFiles=function(e,t){if(this.historyFilesLoadFlag[e])return;if(this.historyFilesSearch!="")return;if(t&&this.popupHistoryFilesItems.offsetHeight>this.popupHistoryFilesBodyWrap.offsetHeight-100){}else if(!(this.popupHistoryFilesItems.scrollTop>this.popupHistoryFilesItems.scrollHeight-this.popupHistoryFilesItems.offsetHeight-100)){return}if(!this.historyFilesEndOfList[e]){this.historyFilesLoadFlag[e]=true;if(this.popupHistoryFilesBodyWrap.childNodes.length>0)this.historyFilesOpenPage[e]=Math.floor(this.popupHistoryFilesBodyWrap.childNodes.length/15)+1;else this.historyFilesOpenPage[e]=1;var s=null;this.popupHistoryFilesBodyWrap.appendChild(s=BX.create("div",{props:{className:"bx-messenger-content-load-more-history"},children:[BX.create("span",{props:{className:"bx-messenger-content-load-img"}}),BX.create("span",{props:{className:"bx-messenger-content-load-text"},html:BX.message("IM_F_LOAD_FILES")})]}));BX.ajax({url:this.BXIM.pathToAjax+"?HISTORY_FILES_LOAD_MORE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_HISTORY_FILES_LOAD:"Y",CHAT_ID:e,PAGE_ID:this.historyFilesOpenPage[e],IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()},onsuccess:BX.delegate(function(e){if(s)BX.remove(s);this.historyFilesLoadFlag[e.CHAT_ID]=false;if(e.FILES.length==0){this.historyFilesEndOfList[e.CHAT_ID]=true;return}var t=0;for(var i in e.FILES){if(!this.disk.files[e.CHAT_ID])this.disk.files[e.CHAT_ID]={};if(!this.disk.files[e.CHAT_ID][i]){e.FILES[i].date=new Date(e.FILES[i].date);this.disk.files[e.CHAT_ID][i]=e.FILES[i]}t++}if(t<15){this.historyFilesEndOfList[e.CHAT_ID]=true}for(var i in e.FILES){var a=this.disk.files[e.CHAT_ID][i];if(a&&!BX("im-file-history-panel-"+a.id)){var n=this.disk.drawHistoryFiles(e.CHAT_ID,a.id,{getElement:"Y"});if(n)this.popupHistoryFilesBodyWrap.appendChild(n)}}},this),onfailure:function(){if(s)BX.remove(s)}})}};BX.MessengerChat.prototype.showContext=function(e){BX.ajax({url:this.BXIM.pathToAjax+"?LOAD_CONTEXT_MESSAGE&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_LOAD_CONTEXT_MESSAGE:"Y",MESSAGE_ID:e,IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()},onsuccess:BX.delegate(function(t){if(t&&t.BITRIX_SESSID){BX.message({bitrix_sessid:t.BITRIX_SESSID})}if(t.ERROR==""){var s=t.DIALOG_ID;this.showMessage[s]=[];this.sendAjaxTry=0;for(var i in t.MESSAGE){t.MESSAGE[i].date=new Date(t.MESSAGE[i].date);this.message[i]=t.MESSAGE[i]}for(var i in t.FILES){if(!this.disk.files[t.CHAT_ID])this.disk.files[t.CHAT_ID]={};if(this.disk.files[t.CHAT_ID][i])continue;t.FILES[i].date=new Date(t.FILES[i].date);this.disk.files[t.CHAT_ID][i]=t.FILES[i]}for(var i in t.USERS){t.USERS[i].last_activity_date=new Date(t.USERS[i].last_activity_date);t.USERS[i].mobile_last_date=new Date(t.USERS[i].mobile_last_date);t.USERS[i].idle=t.USERS[i].idle?new Date(t.USERS[i].idle):false;t.USERS[i].absent=t.USERS[i].absent?new Date(t.USERS[i].absent):false;this.users[i]=t.USERS[i]}for(var i in t.USER_IN_GROUP){if(typeof this.userInGroup[i]=="undefined"){this.userInGroup[i]=t.USER_IN_GROUP[i]}else{for(var a=0;a<t.USER_IN_GROUP[i].users.length;a++)this.userInGroup[i].users.push(t.USER_IN_GROUP[i].users[a]);this.userInGroup[i].users=BX.util.array_unique(this.userInGroup[i].users)}}for(var i in t.PHONES){this.phones[i]={};for(var a in t.PHONES[i]){this.phones[i][a]=BX.util.htmlspecialcharsback(t.PHONES[i][a])}}var n=this.historySearch;this.historySearch="";this.drawHistory(t.DIALOG_ID,t.USERS_MESSAGE,false);this.historySearch=n;if(BX("im-message-history-"+e)){var o=BX("im-message-history-"+e).parentNode.offsetTop;this.popupHistoryItems.scrollTop=o-this.popupHistoryItems.offsetHeight/2+BX("im-message-history-"+e).parentNode.offsetHeight/2;BX.addClass(BX("im-message-history-"+e).parentNode,"bx-messenger-history-item-context");BX.addClass(this.popupHistoryBodyWrap,"bx-messenger-history-items-wrap-show-context")}}else{if(t.ERROR=="SESSION_ERROR"&&this.sendAjaxTry<2){this.sendAjaxTry++;setTimeout(BX.delegate(function(){this.showContext(e)},this),1e3);BX.onCustomEvent(window,"onImError",[t.ERROR,t.BITRIX_SESSID])}else if(t.ERROR=="AUTHORIZE_ERROR"){this.sendAjaxTry++;if(BX.MessengerCommon.isDesktop()){setTimeout(BX.delegate(function(){this.showContext(e)},this),1e4)}BX.onCustomEvent(window,"onImError",[t.ERROR])}}},this),onfailure:BX.delegate(function(){this.sendAjaxTry=0},this)})};BX.MessengerChat.prototype.jumpToMessage=function(e){};BX.MessengerChat.prototype.deleteAllHistory=function(e){BX.ajax({url:this.BXIM.pathToAjax+"?HISTORY_REMOVE_ALL&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_HISTORY_REMOVE_ALL:"Y",USER_ID:e,IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()}});BX.localStorage.set("mhra",e,5);this.history[e]=[];this.showMessage[e]=[];this.popupHistoryBodyWrap.innerHTML="";this.popupHistoryBodyWrap.appendChild(BX.create("div",{props:{className:"bx-messenger-content-history-empty"},children:[BX.create("span",{props:{className:"bx-messenger-content-load-text"},html:BX.message("IM_M_NO_MESSAGE")})]}));if(BX.MessengerCommon.isDesktop())BX.desktop.onCustomEvent("main","bxImClearHistory",[e]);else if(this.BXIM.init)BX.MessengerCommon.drawTab(e)};BX.MessengerChat.prototype.drawMessageHistory=function(e){if(typeof e!="object")return null;if(typeof e.params!="object"){e.params={}}var t=e.senderId==0;if(e.system&&e.system=="Y"){t=true;e.senderId=0}var s=e.params&&e.params.IS_EDITED=="Y";var i=e.params&&e.params.IS_DELETED=="Y";var a=e.text;var n=BX.MessengerCommon.diskDrawFiles(e.chatId,e.params.FILE_ID,{status:["done","error"],boxId:"im-file-history"});if(n.length>0){n=BX.create("div",{props:{className:"bx-messenger-file-box"+(e.text!=""?" bx-messenger-file-box-with-message":"")},children:n})}else{n=null}var o=null;var r=[];if(e.params.ATTACH){for(var l=0;l<e.params.ATTACH.length;l++){r[l]=e.params.ATTACH[l]}var p=/\[ATTACH=([0-9]{1,})\]/gm;var h=[];while((h=p.exec(a))!==null){for(var l=0;l<r.length;l++){if(e.params.ATTACH[l].ID==h[1]){o=BX.create("div",{props:{className:"bx-messenger-attach-box"},children:BX.MessengerCommon.drawAttach(e.id,e.chatId,[r[l]])});a=a.replace("[ATTACH="+h[1]+"]",o.innerHTML);delete r[l]}}}}if(e.params.LINK_ACTIVE&&e.params.LINK_ACTIVE.length>0&&e.params.LINK_ACTIVE.indexOf(this.BXIM.userId.toString())<0){a=a.replace(/<a.*?href="([^"]*)".*?>(.*?)<\/a>/gi,"$2")}var c="";if(e.params.CLASS){c=e.params.CLASS}o=BX.MessengerCommon.drawAttach(e.id,e.chatId,r);if(o.length>0){o=BX.create("div",{props:{className:"bx-messenger-attach-box"},children:o})}else{o=null}var u=this.BXIM.messenger.users[e.senderId];if(e.params&&u&&u.id>0&&(e.params.AVATAR||e.params.NAME||e.params.USER_ID)){u=BX.clone(u);if(e.params.AVATAR){u.avatar=e.params.AVATAR}if(e.params.NAME){u.name=e.params.NAME;u.first_name=e.params.NAME.split(" ")[0]}e=BX.clone(e);if(parseInt(e.params.USER_ID)){e.senderId="network"+e.params.USER_ID}}var d=BX.MessengerCommon.linesVoteDraw(e.id);if(d){a=d;e.system="Y"}else{c=c.replace("bx-messenger-content-item-vote","");var m=BX.MessengerCommon.linesVoteResultDraw(e.id,a);if(m){a=m}}var g=null;if(typeof a=="string"){g=BX.create("span",{props:{className:"bx-messenger-history-item-text"+(i?" bx-messenger-message-deleted":" ")+(i||s?" bx-messenger-message-edited":"")},attrs:{id:"im-message-history-"+e.id},html:BX.MessengerCommon.prepareText(a,false,true,true,!this.BXIM.messenger.openChatFlag||e.senderId==this.BXIM.userId?false:this.BXIM.messenger.users[this.BXIM.userId].name)})}else{g=BX.create("span",{props:{className:"bx-messenger-history-item-text"+(i?" bx-messenger-message-deleted":" ")+(i||s?" bx-messenger-message-edited":"")},attrs:{id:"im-message-history-"+e.id},children:[a]})}if(n==null&&e.text.length<=0&&!e.params["ATTACH"]){resultNode=BX.create("div",{attrs:{"data-messageId":e.id},props:{className:"bx-messenger-history-item-text bx-messenger-item-skipped"}})}else{var f="";var B="";if(e.senderId>0&&u){f=u.avatar;B=u.color}resultNode=BX.create("div",{attrs:{"data-messageId":e.id},props:{className:"bx-messenger-history-item"+(e.senderId==0?" bx-messenger-history-item-3":e.senderId==this.BXIM.userId?"":" bx-messenger-history-item-2")+" "+c},children:[BX.create("div",{props:{className:"bx-messenger-history-hide"},html:this.historyMessageSplit}),BX.create("span",{props:{className:"bx-messenger-history-item-avatar"},children:[BX.create("img",{props:{className:"bx-messenger-content-item-avatar-img"+(BX.MessengerCommon.isBlankAvatar(f)?" bx-messenger-content-item-avatar-img-default":"")},attrs:{src:e.senderId>0?f:this.BXIM.pathToBlankImage,style:e.senderId>0&&BX.MessengerCommon.isBlankAvatar(f)&&B?"background-color: "+B:""}})]}),BX.create("div",{props:{className:"bx-messenger-history-item-name"},html:(this.users[e.senderId]?this.users[e.senderId].name:BX.message("IM_M_SYSTEM_USER"))+' <span class="bx-messenger-history-hide">[</span><span class="bx-messenger-history-item-date">'+BX.MessengerCommon.formatDate(e.date,BX.MessengerCommon.getDateFormatType("MESSAGE"))+'</span><span class="bx-messenger-history-hide">]</span>'}),BX.create("div",{props:{className:"bx-messenger-history-item-menu"}}),e.text.length>0?g:"",n,o,BX.create("div",{props:{className:"bx-messenger-history-hide"},html:"<br />"}),BX.create("div",{props:{className:"bx-messenger-history-hide"},html:this.historyMessageSplit})]})}return resultNode};BX.MessengerChat.prototype.drawHistory=function(e,t,s,i){if(this.popupHistory==null)return false;i=typeof i=="undefined"?true:i;s=typeof s=="undefined"?true:s;var a=false;var n=0;if(e.toString().substr(0,4)=="chat"){a=true;n=e.toString().substr(4)}var o=[];var r=false;BX.removeClass(this.popupHistoryBodyWrap,"bx-messenger-history-items-wrap-show-context");this.popupHistoryBodyWrap.innerHTML="";var l=this.historySearch.length>0;var t=!t?this.history:t;if(t[e]&&(!a&&this.users[e]||a&&this.chat[n])){var p=BX.util.array_unique(t[e]);var h={};if(i){p.sort(BX.delegate(function(e,t){e=parseInt(e);t=parseInt(t);if(!this.message[e]||!this.message[t]){return 0}var s=this.message[e].date.getTime();var i=this.message[t].date.getTime();if(s>i){return-1}else if(s<i){return 1}else{if(e>t){return-1}else if(e<t){return 1}else{return 0}}},this))}for(var c=0;c<p.length;c++){var u="";if(this.history.fullTextEnabled){var d=function(e,t){if(Array.isArray(e)){e.forEach(function(e){d(e,t)})}else if(BX.type.isObject(e)){for(var s in e){d(e[s],t)}}else if(e){u+=" "+e.toString().toLowerCase()}};if(this.message[t[e][c]]){var m=this.message[t[e][c]].params.ATTACH;if(m&&m[0]["BLOCKS"]){d(m[0]["BLOCKS"],this.historySearch)}}if(this.message[t[e][c]].senderId>0){if(this.users[this.message[t[e][c]].senderId]){u+=" "+this.users[this.message[t[e][c]].senderId].name}}if(this.message[t[e][c]].params&&this.message[t[e][c]].params.FILE_ID){var g=this.message[t[e][c]].chatId;this.message[t[e][c]].params.FILE_ID.forEach(function(e){if(this.disk.files[g]&&this.disk.files[g][e]){u+=" "+this.disk.files[g][e].name}},this)}}var f=function(e,t){for(var s=0;s<e.length;s++){if(t.toLowerCase().indexOf(e[s].toLowerCase())<0){return false}}return true};u+=" "+this.message[t[e][c]].text;var B=this.historySearch.trim().split(" ");var X=f(B,u);if(l&&!X){continue}var M=BX.MessengerCommon.formatDate(this.message[t[e][c]].date,BX.MessengerCommon.getDateFormatType("MESSAGE_TITLE"));if(!BX("bx-im-history-"+M)&&!h[M]){h[M]=true;o.push(BX.create("div",{props:{className:"bx-messenger-content-group bx-messenger-content-group-history"},children:[BX.create("div",{attrs:{id:"bx-im-history-"+M},props:{className:"bx-messenger-content-group-title"+(this.BXIM.language=="ru"?" bx-messenger-lowercase":"")},html:M})]}))}var C=this.drawMessageHistory(this.message[t[e][c]]);if(C)o.push(C)}if(o.length<=0){if(!this.historySearchBegin){r=true;o=[BX.create("div",{props:{className:"bx-messenger-content-history-empty"},children:[BX.create("span",{props:{className:"bx-messenger-content-load-text"},html:BX.message("IM_M_NO_MESSAGE")})]})]}}}else if(this.showMessage[e]&&this.showMessage[e].length<=0){r=true;o=[BX.create("div",{props:{className:"bx-messenger-content-history-empty"},children:[BX.create("span",{props:{className:"bx-messenger-content-load-text"},html:BX.message("IM_M_NO_MESSAGE")})]})]}if(o.length>0){BX.adjust(this.popupHistoryBodyWrap,{children:o});this.popupHistoryItems.scrollTop=0}if(s&&(!this.showMessage[e]||this.showMessage[e]&&this.showMessage[e].length<20)){if(r)this.popupHistoryFilesBodyWrap.innerHTML="";this.popupHistoryBodyWrap.appendChild(BX.create("div",{props:{className:BX.findChildrenByClassName(this.popupHistoryBodyWrap,"bx-messenger-history-item-text").length>0?"bx-messenger-content-load-more-history":"bx-messenger-content-load-history"},children:[BX.create("span",{props:{className:"bx-messenger-content-load-img"}}),BX.create("span",{props:{className:"bx-messenger-content-load-text"},html:BX.message("IM_M_LOAD_MESSAGE")})]}));BX.ajax({url:this.BXIM.pathToAjax+"?HISTORY_LOAD&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_HISTORY_LOAD:"Y",USER_ID:e,USER_LOAD:a?this.chat[e.toString().substr(4)]&&this.chat[e.toString().substr(4)].fake?"Y":"N":this.users[e]&&this.users[e].fake?"Y":"N",IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()},onsuccess:BX.delegate(function(i){if(i&&i.BITRIX_SESSID){BX.message({bitrix_sessid:i.BITRIX_SESSID})}if(i.ERROR==""){if(!a){if(!this.userChat[e]){this.userChat[e]=i.CHAT_ID}}for(var n in i.FILES){if(!this.disk.files[i.CHAT_ID])this.disk.files[i.CHAT_ID]={};if(this.disk.files[i.CHAT_ID][n])continue;i.FILES[n].date=new Date(i.FILES[n].date);this.disk.files[i.CHAT_ID][n]=i.FILES[n]}this.showMessage[e]=[];this.sendAjaxTry=0;for(var n in i.MESSAGE){i.MESSAGE[n].date=new Date(i.MESSAGE[n].date);this.message[n]=i.MESSAGE[n];if(this.BXIM.settings.loadLastMessage)this.showMessage[e].push(n)}for(var n in i.USERS_MESSAGE){if(this.history[n])this.history[n]=BX.util.array_merge(this.history[n],i.USERS_MESSAGE[n]);else this.history[n]=i.USERS_MESSAGE[n]}if(!a&&this.users[e]&&!this.users[e].fake||a&&this.chat[i.CHAT_ID]&&!this.chat[i.CHAT_ID].fake){BX.cleanNode(this.popupHistoryBodyWrap);if(!i.USERS_MESSAGE[e]||i.USERS_MESSAGE[e].length<=0){this.popupHistoryBodyWrap.appendChild(BX.create("div",{props:{className:"bx-messenger-content-history-empty"},children:[BX.create("span",{props:{className:"bx-messenger-content-load-text"},html:BX.message("IM_M_NO_MESSAGE")})]}))}else{for(var n=0;n<i.USERS_MESSAGE[e].length;n++){var o=BX.MessengerCommon.formatDate(this.message[i.USERS_MESSAGE[e][n]].date,BX.MessengerCommon.getDateFormatType("MESSAGE_TITLE"));var r=typeof BX.translit!="undefined"?BX.translit(o):o;if(!BX("bx-im-history-"+r)){this.popupHistoryBodyWrap.appendChild(BX.create("div",{props:{className:"bx-messenger-content-group bx-messenger-content-group-history"},children:[BX.create("div",{attrs:{id:"bx-im-history-"+r},props:{className:"bx-messenger-content-group-title"+(this.BXIM.language=="ru"?" bx-messenger-lowercase":"")},html:o})]}))}var l=this.drawMessageHistory(this.message[i.USERS_MESSAGE[e][n]]);if(l)this.popupHistoryBodyWrap.appendChild(l)}}if(this.BXIM.settings.loadLastMessage&&this.currentTab==e)BX.MessengerCommon.drawTab(this.currentTab,true)}else{if(a&&this.chat[i.USER_ID.substr(4)].fake)this.chat[i.USER_ID.toString().substr(4)].name=BX.message("IM_M_USER_NO_ACCESS");if(!a){BX.MessengerCommon.getUserParam(e,true);this.users[e].name=BX.message("IM_M_USER_NO_ACCESS")}for(var n in i.USERS){i.USERS[n].last_activity_date=new Date(i.USERS[n].last_activity_date);i.USERS[n].mobile_last_date=new Date(i.USERS[n].mobile_last_date);i.USERS[n].idle=i.USERS[n].idle?new Date(i.USERS[n].idle):false;i.USERS[n].absent=i.USERS[n].absent?new Date(i.USERS[n].absent):false;this.users[n]=i.USERS[n]}for(var n in i.USER_IN_GROUP){if(typeof this.userInGroup[n]=="undefined"){this.userInGroup[n]=i.USER_IN_GROUP[n]}else{for(var p=0;p<i.USER_IN_GROUP[n].users.length;p++)this.userInGroup[n].users.push(i.USER_IN_GROUP[n].users[p]);this.userInGroup[n].users=BX.util.array_unique(this.userInGroup[n].users)}}for(var n in i.CHAT){i.CHAT[n].date_create=new Date(i.CHAT[n].date_create);this.chat[n]=i.CHAT[n]}for(var n in i.USER_IN_CHAT){this.userInChat[n]=i.USER_IN_CHAT[n]}for(var n in i.USER_BLOCK_CHAT){this.userChatBlockStatus[n]=i.USER_BLOCK_CHAT[n]}if(!a)BX.MessengerCommon.userListRedraw();this.dialogStatusRedraw();this.drawHistory(e,false,false)}if(this.historyChatId==0){this.historyChatId=i.CHAT_ID;this.drawHistoryFiles(this.historyChatId)}this.redrawHistoryPanel(e,a?i.USER_ID.substr(4):0)}else{if(i.ERROR=="SESSION_ERROR"&&this.sendAjaxTry<2){this.sendAjaxTry++;setTimeout(BX.delegate(function(){this.drawHistory(e,t,s)},this),1e3);BX.onCustomEvent(window,"onImError",[i.ERROR,i.BITRIX_SESSID])}else if(i.ERROR=="AUTHORIZE_ERROR"){this.sendAjaxTry++;if(BX.MessengerCommon.isDesktop()){setTimeout(BX.delegate(function(){this.drawHistory(e,t,s)},this),1e4)}BX.onCustomEvent(window,"onImError",[i.ERROR])}}},this),onfailure:BX.delegate(function(){this.sendAjaxTry=0},this)})}};BX.MessengerChat.prototype.redrawHistoryPanel=function(e,t,s){var i=e.toString().substr(0,4)=="chat"?true:false;var a=null;s=s||{};BX.MessengerCommon.getUserParam(e);if(i){a=BX.create("div",{props:{className:"bx-messenger-panel bx-messenger-panel-bg2"},children:[BX.create("span",{props:{className:"bx-messenger-panel-avatar bx-messenger-panel-avatar-"+this.chat[t].type},children:[BX.create("img",{attrs:{src:this.chat[t].avatar,style:BX.MessengerCommon.isBlankAvatar(this.chat[t].avatar)?"background-color: "+this.chat[t].color:""},props:{className:"bx-messenger-panel-avatar-img"+(BX.MessengerCommon.isBlankAvatar(this.chat[t].avatar)?" bx-messenger-panel-avatar-img-default":"")}})]}),s.drawLinesVote=="Y"?BX.create("a",{attrs:{"data-sessionId":s.sessionId,"data-rating":s.sessionVoteHead,"data-context":"history",title:BX.message("IM_M_HISTORY_LINES_VOTE_AND_COMMENT")},props:{className:"bx-messenger-panel-history-vote"},events:{click:BX.delegate(function(){this.linesVoteAndCommentHeadDialog(BX.proxy_context,s.sessionId,s.sessionVoteHead,s.sessionCommentHead);return BX.PreventDefault()},this)}}):null,s.drawLinesJoin=="Y"?BX.create("a",{attrs:{title:BX.message("IM_M_HISTORY_LINES_JOIN")},props:{className:"bx-messenger-panel-history-join"},events:{click:BX.delegate(function(){this.popupHistory.close();this.linesOpenMessenger(this.chat[t].entity_id)},this)}}):null,this.popupHistoryButtonDeleteAll=this.chat[t].type=="open"||this.chat[t].type=="lines"?null:BX.create("a",{attrs:{title:BX.message("IM_M_HISTORY_DELETE_ALL")},props:{className:"bx-messenger-panel-basket"}}),BX.create("span",{props:{className:"bx-messenger-panel-title bx-messenger-panel-title-middle"},html:this.chat[t].name})]})}else{var n="";if(this.users[e].bot){if(this.bot[e]&&this.bot[e].type=="network"){n="bx-messenger-user-network"}else if(this.bot[e]&&this.bot[e].type=="support24"){n="bx-messenger-user-support24"}else{n="bx-messenger-user-bot"}}a=BX.create("div",{props:{className:"bx-messenger-panel bx-messenger-panel-bg2"},children:[BX.create("a",{attrs:{href:this.users[e].profile,target:"_blank"},props:{className:"bx-messenger-panel-avatar bx-messenger-panel-avatar-status-"+BX.MessengerCommon.getUserStatus(this.users[e])},children:[BX.create("img",{attrs:{src:this.users[e].avatar,style:BX.MessengerCommon.isBlankAvatar(this.users[e].avatar)?"background-color: "+this.users[e].color:""},props:{className:"bx-messenger-panel-avatar-img"+(BX.MessengerCommon.isBlankAvatar(this.users[e].avatar)?" bx-messenger-panel-avatar-img-default":"")}}),BX.create("span",{attrs:{title:BX.MessengerCommon.getUserStatus(this.users[e],false).title},props:{className:"bx-messenger-panel-avatar-status"}})]}),this.popupHistoryButtonDeleteAll=e==this.BXIM.userId?null:BX.create("a",{props:{className:"bx-messenger-panel-basket"}}),BX.create("span",{props:{className:"bx-messenger-panel-title"},html:this.users[e].extranet?'<div class="bx-messenger-user-extranet">'+this.users[e].name+"</div>":this.users[e].bot&&this.bot[e]?'<div class="'+n+'">'+this.users[e].name+"</div>":this.users[e].name}),BX.create("span",{props:{className:"bx-messenger-panel-desc"},html:BX.MessengerCommon.getUserPosition(this.users[e])})]})}if(this.popupHistoryPanel){this.popupHistoryPanel.innerHTML="";BX.adjust(this.popupHistoryPanel,{children:[a]})}else{return[a]}};BX.MessengerChat.prototype.drawHistoryFiles=function(e,t,s){if(this.popupHistory==null)return false;s=typeof s=="undefined"?true:s;var i=this.historyFilesSearch.length>0;var t=!t?this.disk.files[e]:t;var a=[];var n=false;if(t){var o=BX.util.objectSort(t,"date","desc");for(var r=0;r<o.length;r++){if(i&&o[r].name.toLowerCase().indexOf((this.historyFilesSearch+"").toLowerCase())<0)continue;var l=this.disk.drawHistoryFiles(e,o[r].id,{getElement:"Y"});if(l)a.push(l)}if(a.length<=0){if(!this.historyFilesSearchBegin){n=true;a=[BX.create("div",{props:{className:"bx-messenger-content-history-empty"},children:[BX.create("span",{props:{className:"bx-messenger-content-load-text"},html:BX.message("IM_F_NO_FILES_2")})]})]}}if(a.length>=15){s=false}}else if(e==0){n=true;a=[BX.create("div",{props:{className:this.popupHistoryFilesBodyWrap.childNodes.length>0?"bx-messenger-content-load-more-history":"bx-messenger-content-load-history"},children:[BX.create("span",{props:{className:"bx-messenger-content-load-img"}}),BX.create("span",{props:{className:"bx-messenger-content-load-text"},html:BX.message("IM_F_LOAD_FILES")})]})]}else{n=true;a=[BX.create("div",{props:{className:"bx-messenger-content-history-empty"},children:[BX.create("span",{props:{className:"bx-messenger-content-load-text"},html:BX.message("IM_F_NO_FILES_2")})]})]}this.popupHistoryFilesBodyWrap.innerHTML="";if(a.length>0){BX.adjust(this.popupHistoryFilesBodyWrap,{children:a});this.popupHistoryFilesItems.scrollTop=0}if(s&&e>0){if(n)this.popupHistoryFilesBodyWrap.innerHTML="";this.popupHistoryFilesBodyWrap.appendChild(BX.create("div",{props:{className:this.popupHistoryFilesBodyWrap.childNodes.length>0?"bx-messenger-content-load-more-history":"bx-messenger-content-load-history"},children:[BX.create("span",{props:{className:"bx-messenger-content-load-img"}}),BX.create("span",{props:{className:"bx-messenger-content-load-text"},html:BX.message("IM_F_LOAD_FILES")})]}));BX.ajax({url:this.BXIM.pathToAjax+"?HISTORY_FILES_LOAD&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_HISTORY_FILES_LOAD:"Y",CHAT_ID:e,IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()},onsuccess:BX.delegate(function(i){if(i&&i.BITRIX_SESSID){BX.message({bitrix_sessid:i.BITRIX_SESSID})}if(i.ERROR==""){for(var a in i.FILES){if(!this.disk.files[i.CHAT_ID])this.disk.files[i.CHAT_ID]={};i.FILES[a].date=new Date(i.FILES[a].date);this.disk.files[i.CHAT_ID][a]=i.FILES[a]}this.drawHistoryFiles(i.CHAT_ID,false,false)}else{if(i.ERROR=="SESSION_ERROR"&&this.sendAjaxTry<2){this.sendAjaxTry++;BX.message({bitrix_sessid:i.BITRIX_SESSID});setTimeout(BX.delegate(function(){this.drawHistoryFiles(e,t,s)},this),1e3);BX.onCustomEvent(window,"onImError",[i.ERROR,i.BITRIX_SESSID])}else if(i.ERROR=="AUTHORIZE_ERROR"){this.sendAjaxTry++;if(BX.MessengerCommon.isDesktop()){setTimeout(BX.delegate(function(){this.drawHistoryFiles(e,t,s)},this),1e4)}BX.onCustomEvent(window,"onImError",[i.ERROR])}}},this),onfailure:BX.delegate(function(){this.sendAjaxTry=0},this)})}};BX.MessengerChat.prototype.newHistorySearch=function(e){e=e||window.event;if(e.keyCode==27&&this.historySearch!="")BX.MessengerCommon.preventDefault(e);if(e.keyCode==27)this.popupHistorySearchInput.value="";this.historySearch=this.popupHistorySearchInput.value;if(this.historyLastSearch[this.historyUserId]==this.historySearch){return false}this.historyLastSearch[this.historyUserId]=this.historySearch;var t=3;if(this.history.fullTextEnabled){t=this.history.ftMinSizeToken}if(this.popupHistorySearchInput.value.length<t){this.historySearch="";this.drawHistory(this.historyUserId,false,false);return false}this.popupHistorySearchDateInput.value="";this.historyDateSearch="";this.historySearchBegin=true;this.drawHistory(this.historyUserId,false,false);var s=BX.findChildByClassName(this.popupHistoryBodyWrap,"bx-messenger-content-load-history");if(s)BX.remove(s);var s=BX.findChildByClassName(this.popupHistoryBodyWrap,"bx-messenger-content-history-empty");if(s)BX.remove(s);var i=null;this.popupHistoryBodyWrap.appendChild(i=BX.create("div",{props:{className:this.popupHistoryBodyWrap.childNodes.length>0?"bx-messenger-content-load-more-history":"bx-messenger-content-load-history"},children:[BX.create("span",{props:{className:"bx-messenger-content-load-img"}}),BX.create("span",{props:{className:"bx-messenger-content-load-text"},html:BX.message("IM_M_LOAD_MESSAGE")})]}));clearTimeout(this.historySearchTimeout);if(this.popupHistorySearchInput.value!=""){this.historySearchTimeout=setTimeout(BX.delegate(function(){BX.ajax({url:this.BXIM.pathToAjax+"?HISTORY_SEARCH&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_HISTORY_SEARCH:"Y",USER_ID:this.historyUserId,SEARCH:this.popupHistorySearchInput.value,IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()},onsuccess:BX.delegate(function(e){if(i)BX.remove(i);this.historySearchBegin=false;if(e.ERROR!="")return false;if(e.MESSAGE.length==0){var t={};t[e.USER_ID]=[];this.drawHistory(e.USER_ID,t,false);return}for(var s in e.MESSAGE){e.MESSAGE[s].date=new Date(e.MESSAGE[s].date);this.message[s]=e.MESSAGE[s]}for(var s in e.FILES){if(!this.disk.files[e.CHAT_ID])this.disk.files[e.CHAT_ID]={};e.FILES[s].date=new Date(e.FILES[s].date);this.disk.files[e.CHAT_ID][s]=e.FILES[s]}this.drawHistory(e.USER_ID,e.USERS_MESSAGE,false)},this),onfailure:BX.delegate(function(){if(i)BX.remove(i);this.historySearchBegin=false},this)})},this),1500)}return BX.PreventDefault(e)};BX.MessengerChat.prototype.newHistoryDateSearch=function(e){this.historyDateSearch=this.popupHistorySearchDateInput.value;if(this.historyLastSearch[this.historyUserId]==this.historyDateSearch){return false}this.historyLastSearch[this.historyUserId]=this.historyDateSearch;if(this.historyDateSearch.length<=3){this.historyDateSearch="";this.drawHistory(this.historyUserId,false,false);return false}this.popupHistorySearchInput.value="";this.historySearch="";this.historySearchBegin=true;var t=null;this.popupHistoryBodyWrap.innerHTML="";this.popupHistoryBodyWrap.appendChild(t=BX.create("div",{props:{className:this.popupHistoryBodyWrap.childNodes.length>0?"bx-messenger-content-load-more-history":"bx-messenger-content-load-history"},children:[BX.create("span",{props:{className:"bx-messenger-content-load-img"}}),BX.create("span",{props:{className:"bx-messenger-content-load-text"},html:BX.message("IM_M_LOAD_MESSAGE")})]}));clearTimeout(this.historySearchTimeout);if(this.historyDateSearch!=""){this.historySearchTimeout=setTimeout(BX.delegate(function(){BX.ajax({url:this.BXIM.pathToAjax+"?HISTORY_DATE_SEARCH&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_HISTORY_DATE_SEARCH:"Y",USER_ID:this.historyUserId,DATE:this.historyDateSearch,IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()},onsuccess:BX.delegate(function(e){if(t)BX.remove(t);this.historySearchBegin=false;if(e.ERROR!="")return false;if(e.MESSAGE.length==0){var s={};s[e.USER_ID]=[];this.drawHistory(e.USER_ID,s,false);return}for(var i in e.MESSAGE){e.MESSAGE[i].date=new Date(e.MESSAGE[i].date);this.message[i]=e.MESSAGE[i]}for(var i in e.FILES){if(!this.disk.files[e.CHAT_ID])this.disk.files[e.CHAT_ID]={};e.FILES[i].date=new Date(e.FILES[i].date);this.disk.files[e.CHAT_ID][i]=e.FILES[i]}this.drawHistory(e.USER_ID,e.USERS_MESSAGE,false)},this),onfailure:BX.delegate(function(){if(t)BX.remove(t);this.historySearchBegin=false},this)})},this),1500)}};BX.MessengerChat.prototype.newHistoryFilesSearch=function(e){e=e||window.event;if(e.keyCode==27&&this.historyFilesSearch!="")BX.MessengerCommon.preventDefault(e);if(e.keyCode==27)this.popupHistoryFilesSearchInput.value="";this.historyFilesSearch=this.popupHistoryFilesSearchInput.value;if(this.historyFilesLastSearch[this.historyChatId]==this.historyFilesSearch){return false}this.historyFilesLastSearch[this.historyChatId]=this.historyFilesSearch;if(this.popupHistoryFilesSearchInput.value.length<=3){this.historyFilesSearch="";this.drawHistoryFiles(this.historyChatId,false,false);return false}this.historyFilesSearchBegin=true;this.historySearch=this.popupHistorySearchInput.value;this.drawHistoryFiles(this.historyChatId,false,false);var t=BX.findChildByClassName(this.popupHistoryFilesBodyWrap,"bx-messenger-content-load-history");if(t)BX.remove(t);var t=BX.findChildByClassName(this.popupHistoryFilesBodyWrap,"bx-messenger-content-history-empty");if(t)BX.remove(t);var s=null;this.popupHistoryFilesBodyWrap.appendChild(s=BX.create("div",{props:{className:this.popupHistoryFilesBodyWrap.childNodes.length>0?"bx-messenger-content-load-more-history":"bx-messenger-content-load-history"},children:[BX.create("span",{props:{className:"bx-messenger-content-load-img"}}),BX.create("span",{props:{className:"bx-messenger-content-load-text"},html:BX.message("IM_F_LOAD_FILES")})]}));clearTimeout(this.historyFilesSearchTimeout);if(this.popupHistoryFilesSearchInput.value!=""){this.historyFilesSearchTimeout=setTimeout(BX.delegate(function(){BX.ajax({url:this.BXIM.pathToAjax+"?HISTORY_FILES_SEARCH&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_HISTORY_FILES_SEARCH:"Y",CHAT_ID:this.historyChatId,SEARCH:this.popupHistoryFilesSearchInput.value,IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()},onsuccess:BX.delegate(function(e){if(s)BX.remove(s);this.historyFilesSearchBegin=false;if(e.ERROR!="")return false;if(e.FILES.length==0){this.drawHistoryFiles(e.CHAT_ID,false,false);return}var t=false;for(var i in e.FILES){if(!this.disk.files[e.CHAT_ID])this.disk.files[e.CHAT_ID]={};if(!this.disk.files[e.CHAT_ID][i])e.FILES[i].fromSearch=true;e.FILES[i].date=new Date(e.FILES[i].date);this.disk.files[e.CHAT_ID][i]=e.FILES[i];t=true}this.drawHistoryFiles(e.CHAT_ID,t?e.FILES:false,false)},this),onfailure:BX.delegate(function(){if(s)BX.remove(s);this.historyFilesSearchBegin=false},this)})},this),1500)}return BX.PreventDefault(e)};BX.MessengerChat.prototype.setUpdateStateStep=function(e){e=e!=false;var t=this.updateStateStepDefault;if(!this.BXIM.ppServerStatus){if(this.popupMessenger!=null){t=20;if(this.updateStateVeryFastCount>0){t=5;this.updateStateVeryFastCount--}else if(this.updateStateFastCount>0){t=10;this.updateStateFastCount--}}}this.updateStateStep=parseInt(t);if(e)BX.localStorage.set("uss",this.updateStateStep,5);this.updateState()};BX.MessengerChat.prototype.updateState=function(e,t,s){var i=new BX.Promise;if(!this.BXIM.init||!this.BXIM.tryConnect||this.popupMessengerConnectionStatusState=="offline"){i.reject("disabled");return i}e=e==true;t=t!=false;s=s||"UPDATE_STATE";var a=Math.ceil(this.updateStateStep/2);if(a>60){a=60}else if(a<5){a=5}clearTimeout(this.updateStateTimeout);this.updateStateTimeout=setTimeout(BX.delegate(function(){if(BX.MessengerCommon.isDesktop()){var e="IM UPDATE STATE: sending ajax"+(s=="UPDATE_STATE"?"":" ("+s+")")+" ["+this.updateStateCount+"]";BX.desktop.log("phone."+this.BXIM.userEmail+".log",e);console.log(e)}BX.localStorage.set("im-us-check",true,a);var n=BX.ajax({url:this.BXIM.pathToAjax+"?"+s+"&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,lsId:"IM_UPDATE_STATE",lsTimeout:a-2,timeout:60,data:{IM_UPDATE_STATE:"Y",OPEN_MESSENGER:this.popupMessenger!=null?1:0,TAB:this.currentTab,FM:JSON.stringify(this.flashMessage),FN:JSON.stringify(this.notify.flashNotify),SITE_ID:BX.message("SITE_ID"),IM_AJAX_CALL:"Y",DESKTOP:BX.MessengerCommon.isDesktop()?"Y":"N",sessid:BX.bitrix_sessid()},onsuccess:BX.delegate(function(e){if(t&&BX.localStorage.get("im-us-check"))BX.localStorage.set("mus",true,5);if(BX.MessengerCommon.isDesktop()){var a="";if(e.ERROR==""){a="IM UPDATE STATE: success request ["+this.updateStateCount+"]"}else{a="IM UPDATE STATE: bad request ("+e.ERROR+") ["+this.updateStateCount+"]"}BX.desktop.log("phone."+this.BXIM.userEmail+".log",a);console.log(a)}this.updateStateCount++;if(e&&e.BITRIX_SESSID){BX.message({bitrix_sessid:e.BITRIX_SESSID})}if(e&&e.ERROR==""){this.BXIM.checkRevision(e.REVISION);if(this.BXIM.desktopDisk){this.BXIM.desktopDisk.checkRevision(e.DISK_REVISION)}BX.message({SERVER_TIME:e.SERVER_TIME});this.notify.updateNotifyCounters(e.COUNTERS,t);this.notify.updateNotifyMailCount(e.MAIL_COUNTER,t);if(!this.BXIM.xmppStatus&&e.XMPP_STATUS&&e.XMPP_STATUS=="Y")this.BXIM.xmppStatus=true;if(!this.BXIM.desktopStatus&&e.DESKTOP_STATUS&&e.DESKTOP_STATUS=="Y")this.BXIM.desktopStatus=true;var n=false;if(!(e.ONLINE.length<=0))for(var o in e.ONLINE){if(this.users[o]){this.users[o].status=e.ONLINE[o].status;this.users[o].color=e.ONLINE[o].color;this.users[o].idle=e.ONLINE[o].idle?new Date(e.ONLINE[o].idle):false;this.users[o].last_activity_date=new Date(e.ONLINE[o].last_activity_date);this.users[o].mobile_last_date=new Date(e.ONLINE[o].mobile_last_date)}}this.BXIM.messenger.command=e.COMMAND?e.COMMAND:[];this.BXIM.messenger.textareaIcon=e.TEXTAREA_ICON?e.TEXTAREA_ICON:[];this.BXIM.messenger.textareaIconPrepare();if(typeof e.FILES!="undefined"){for(var r in e.FILES){if(!this.disk.files[r])this.disk.files[r]={};for(var o in e.FILES[r]){e.FILES[r][o].date=new Date(e.FILES[r][o].date);this.disk.files[r][o]=e.FILES[r][o]}}}if(typeof e.MESSAGE!="undefined")for(var o in e.MESSAGE)e.MESSAGE[o].date=new Date(e.MESSAGE[o].date);BX.MessengerCommon.updateStateVar(e,t);if(typeof e.USERS_MESSAGE!="undefined")n=true;this.dialogStatusRedraw();BX.MessengerCommon.userListRedraw();if(typeof e.NOTIFY!="undefined"){for(var o in e.NOTIFY){e.NOTIFY[o].date=new Date(e.NOTIFY[o].date);this.notify.notify[o]=e.NOTIFY[o];this.BXIM.lastRecordId=parseInt(o)>this.BXIM.lastRecordId?parseInt(o):this.BXIM.lastRecordId}for(var o in e.FLASH_NOTIFY)if(typeof this.notify.flashNotify[o]=="undefined")this.notify.flashNotify[o]=e.FLASH_NOTIFY[o];this.notify.changeUnreadNotify(e.UNREAD_NOTIFY,t)}this.setUpdateStateStep(false);i.resolve()}else if(e.ERROR=="SESSION_ERROR"&&this.sendAjaxTry<=2){i.reject(e.ERROR,this.sendAjaxTry);this.sendAjaxTry++;setTimeout(BX.delegate(function(){this.updateState(true,t,s)},this),2e3);BX.onCustomEvent(window,"onImError",[e.ERROR,e.BITRIX_SESSID])}else if(s!="UPDATE_STATE_RECONNECT"){i.reject(e.ERROR,this.sendAjaxTry);if(e.ERROR=="AUTHORIZE_ERROR"){this.sendAjaxTry++;if(BX.MessengerCommon.isDesktop()){setTimeout(BX.delegate(function(){this.updateState(true,t,s)},this),1e4)}BX.onCustomEvent(window,"onImError",[e.ERROR])}else if(this.sendAjaxTry<5){this.sendAjaxTry++;if(this.sendAjaxTry>=2&&!BX.MessengerCommon.isDesktop()){BX.onCustomEvent(window,"onImError",[e.ERROR]);return false}setTimeout(BX.delegate(function(){this.updateState(true,t,s)},this),6e4);BX.onCustomEvent(window,"onImError",[e.ERROR])}}},this),onfailure:BX.delegate(function(){i.reject("failure",this.sendAjaxTry);if(BX.MessengerCommon.isDesktop()){var e="IM UPDATE STATE: failure request (code: "+n.status+") ["+this.updateStateCount+"]";BX.desktop.log("phone."+this.BXIM.userEmail+".log",e);console.log(e)}this.updateStateCount++;this.sendAjaxTry=0;this.setUpdateStateStep(false);try{if(typeof n=="object"&&n.status==0&&s!="UPDATE_STATE_RECONNECT")BX.onCustomEvent(window,"onImError",["CONNECT_ERROR"])}catch(e){}},this)})},this),e?150:this.updateStateStep*1e3);return i};BX.MessengerChat.prototype.updateStateLight=function(e,t){if(!this.BXIM.tryConnect||this.popupMessengerConnectionStatusState=="offline")return false;e=e==true;t=t!=false;clearTimeout(this.updateStateTimeout);this.updateStateTimeout=setTimeout(BX.delegate(function(){BX.ajax({url:this.BXIM.pathToAjax+"?UPDATE_STATE_LIGHT&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,lsId:"IM_UPDATE_STATE_LIGHT",lsTimeout:1,timeout:this.updateStateStepDefault>10?this.updateStateStepDefault-2:10,data:{IM_UPDATE_STATE_LIGHT:"Y",SITE_ID:BX.message("SITE_ID"),IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()},onsuccess:BX.delegate(function(s){if(t)BX.localStorage.set("musl",true,5);if(s&&s.BITRIX_SESSID){BX.message({bitrix_sessid:s.BITRIX_SESSID})}if(s&&s.ERROR==""){this.BXIM.checkRevision(s.REVISION);BX.message({SERVER_TIME:s.SERVER_TIME});this.notify.updateNotifyCounters(s.COUNTERS,t);this.updateStateLight(e,t)}else{if(s.ERROR=="SESSION_ERROR"&&this.sendAjaxTry<=2){this.sendAjaxTry++;setTimeout(BX.delegate(function(){this.updateStateLight(true,t)},this),2e3);BX.onCustomEvent(window,"onImError",[s.ERROR,s.BITRIX_SESSID])}else if(s.ERROR=="AUTHORIZE_ERROR"){this.sendAjaxTry++;if(BX.MessengerCommon.isDesktop()){setTimeout(BX.delegate(function(){this.updateStateLight(true,t)},this),1e4)}BX.onCustomEvent(window,"onImError",[s.ERROR])}else if(this.sendAjaxTry<5){this.sendAjaxTry++;if(this.sendAjaxTry>=2&&!BX.MessengerCommon.isDesktop()){BX.onCustomEvent(window,"onImError",[s.ERROR]);return false}setTimeout(BX.delegate(function(){this.updateStateLight(true,t)},this),6e4);BX.onCustomEvent(window,"onImError",[s.ERROR])}}},this),onfailure:BX.delegate(function(){this.sendAjaxTry=0;this.setUpdateStateStep(false);try{if(typeof _ajax=="object"&&_ajax.status==0)BX.onCustomEvent(window,"onImError",["CONNECT_ERROR"])}catch(e){}},this)})},this),e?150:this.updateStateStepDefault*1e3)};BX.MessengerChat.prototype.setClosingByEsc=function(e){if(this.popupMessenger==null)return false;if(e){if(!this.BXIM.callController.hasActiveCall()){this.popupMessenger.setClosingByEsc(true)}}else{this.popupMessenger.setClosingByEsc(false)}};BX.MessengerChat.prototype.extraOpen=function(e){if(!this.popupMessengerExtra)return false;this.setClosingByEsc(false);if(!this.BXIM.extraBind){BX.bind(window,"keydown",this.BXIM.extraBind=BX.proxy(function(e){if(e.keyCode==27&&this.popupMessenger){if(BX.SidePanel&&BX.SidePanel.Instance.isOpen()&&BX.SidePanel.Instance.isOnTop()){BX.SidePanel.Instance.close()}else{this.popupMessenger.destroy()}}},this))}this.BXIM.extraOpen=true;this.BXIM.dialogOpen=false;BX.style(this.popupMessengerDialog,"display","none");BX.style(this.popupMessengerExtra,"display","block");this.popupMessengerExtra.innerHTML="";BX.adjust(this.popupMessengerExtra,{children:[e]});this.resizeMainWindow()};BX.MessengerChat.prototype.extraClose=function(e,t){if(!this.popupMessengerExtra)return true;setTimeout(BX.delegate(function(){this.setClosingByEsc(true)},this),200);if(this.BXIM.extraBind){BX.unbind(window,"keydown",this.BXIM.extraBind);this.BXIM.extraBind=null}this.BXIM.extraOpen=false;this.BXIM.dialogOpen=true;e=e==true;t=t!=false;if(this.BXIM.notifyOpen)this.notify.closeNotify();this.closeMenuPopup();if(this.currentTab==0){this.extraOpen(BX.create("div",{props:{className:"bx-messenger-box-hello-wrap"},children:[BX.create("div",{props:{className:"bx-messenger-box-hello"},html:BX.message("IM_M_EMPTY")})]}))}else{BX.style(this.popupMessengerDialog,"display","block");BX.style(this.popupMessengerExtra,"display","none");this.popupMessengerExtra.innerHTML="";if(e){this.openChatFlag=this.currentTab.toString().substr(0,4)=="chat";BX.MessengerCommon.openDialog(this.currentTab,false,t)}}this.resizeMainWindow()};BX.MessengerChat.prototype.sendMessage=function(e){if(this.popupMessengerConnectionStatusState!="online")return false;e=typeof e=="string"||typeof e=="number"?e:this.currentTab;BX.MessengerCommon.endSendWriting(e);this.popupMessengerTextarea.value=this.popupMessengerTextarea.value.replace("    ","\t");this.popupMessengerTextarea.value=BX.util.trim(this.popupMessengerTextarea.value);if(this.popupMessengerTextarea.value.length==0)return false;if(this.popupMessengerTextarea.value.length>20006){this.popupMessengerTextarea.value=this.popupMessengerTextarea.value.substr(0,2e4)+" (...)"}if(this.BXIM.language=="ru"&&BX.correctText&&this.BXIM.settings.correctText){this.popupMessengerTextarea.value=BX.correctText(this.popupMessengerTextarea.value)}this.addRecentSmile(this.popupMessengerTextarea.value);this.popupMessengerTextarea.value=this.popupMessengerTextarea.value.replace(/\[icon\=(\d+)([^\]]*)\]/gi,BX.delegate(function(e,t){t="icon"+t;var s="";if(this.smile[t].WIDTH==this.smile[t].HEIGHT){s=s+" size="+this.smile[t].WIDTH}else{if(this.smile[t].WIDTH){s=s+" width="+this.smile[t].WIDTH}if(this.smile[t].HEIGHT){s=s+" height="+this.smile[t].NAME}}if(this.smile[t].NAME){s=s+" title="+this.smile[t].NAME}return"[icon="+this.smile[t].IMAGE+s+"]"},this));if(this.popupMessengerTextarea.value=="/clear"){this.popupMessengerTextarea.value="";this.textareaCheckText();this.textareaHistory[this.currentTab]="";this.showMessage[this.currentTab]=[];BX.MessengerCommon.drawTab(this.currentTab,true);if(BX.MessengerCommon.isDesktop())console.log("NOTICE: User use /clear");return false}else if(this.popupMessengerTextarea.value=="/webrtcDebug"||this.popupMessengerTextarea.value=="/webrtcDebug on"||this.popupMessengerTextarea.value=="/webrtcDebug off"){if(this.popupMessengerTextarea.value=="/webrtcDebug")this.webrtc.debug=this.webrtc.debug?false:true;else if(this.popupMessengerTextarea.value=="/webrtcDebug on")this.webrtc.debug=true;else if(this.popupMessengerTextarea.value=="/webrtcDebug off")this.webrtc.debug=false;if(this.webrtc.debug){this.tooltip(this.popupMessengerTextareaSendType.previousSibling,BX.message("IM_TIP_WEBRTC_ON"))}else{this.tooltip(this.popupMessengerTextareaSendType.previousSibling,BX.message("IM_TIP_WEBRTC_OFF"))}BX.PULL.capturePullEvent(this.webrtc.debug);this.textareaHistory[this.currentTab]="";this.popupMessengerTextarea.value="";this.textareaCheckText();if(console&&console.log)console.log("NOTICE: User use /webrtcDebug and TURN "+(this.webrtc.debug?"ON":"OFF")+" debug");if(BX.MessengerCommon.isDesktop()&&!this.webrtc.debug){BX.MessengerWindow.windowReload()}return false}else if(this.popupMessengerTextarea.value=="/windowReload"){this.textareaHistory[this.currentTab]="";this.popupMessengerTextarea.value="";this.textareaCheckText();location.reload();if(BX.MessengerCommon.isDesktop())console.log("NOTICE: User use /windowReload");return false}else if(this.popupMessengerTextarea.value=="/correctText on"||this.popupMessengerTextarea.value=="/correctText off"){if(this.popupMessengerTextarea.value=="/correctText on"){this.BXIM.settings.correctText=true;this.tooltip(this.popupMessengerTextareaSendType.previousSibling,BX.message("IM_TIP_AC_ON"))}else{this.BXIM.settings.correctText=false;this.tooltip(this.popupMessengerTextareaSendType.previousSibling,BX.message("IM_TIP_AC_OFF"))}this.BXIM.saveSettings({correctText:this.BXIM.settings.correctText});console.log("NOTICE: User use /correctText");return false}else if(this.popupMessengerTextarea.value=="/getChatId"){var t=this.getChatId();if(!this.openChatFlag){t+=" / UID: "+this.currentTab}this.tooltip(this.popupMessengerTextareaSendType.previousSibling,BX.message("IM_CHAT_ID_IS").replace("#CHAT_ID#","<b>"+t+"</b>"));console.log("NOTICE: User use /getChatId");this.popupMessengerTextarea.value="";this.textareaCheckText();return false}else if(this.popupMessengerTextarea.value.indexOf("/background")==0){var s=BX.util.trim(this.popupMessengerTextarea.value).split(" ")[1];if(!s){s=this.BXIM.settings.backgroundImage?false:true}this.BXIM.setBackground(s);this.popupMessengerTextarea.value="";this.textareaCheckText();return false}else if(this.popupMessengerTextarea.value.indexOf("/color")==0){var s=this.popupMessengerTextarea.value.split(" ")[1];if(s&&this.openChatFlag){BX.MessengerCommon.setColor(s,this.getChatId())}this.popupMessengerTextarea.value="";this.textareaCheckText();return false}else if(this.popupMessengerTextarea.value.indexOf("/rename")==0){var i=this.popupMessengerTextarea.value.substr(8);if(i&&this.openChatFlag){BX.MessengerCommon.renameChat(this.getChatId(),i)}this.popupMessengerTextarea.value="";this.textareaCheckText();return false}if(BX.MessengerCommon.isDesktop()){if(this.popupMessengerTextarea.value=="/openDeveloperTools"){this.textareaHistory[this.currentTab]="";this.popupMessengerTextarea.value="";this.textareaCheckText();BX.desktop.openDeveloperTools();console.log("NOTICE: User use /openDeveloperTools");return false}else if(this.popupMessengerTextarea.value=="/clearWindowSize"){BX.desktop.setWindowSize({Width:BX.MessengerWindow.initWidth,Height:BX.MessengerWindow.initHeight});this.BXIM.setLocalConfig("global_msz_v2",false);BX.desktop.apiReady=false;location.reload();if(BX.MessengerCommon.isDesktop())console.log("NOTICE: User use /clearWindowSize");return false}}if(this.popupMessengerTextarea.value=="/showOnlyChat"){BX.MessengerCommon.recentListRedraw({showOnlyChat:true});this.textareaHistory[this.currentTab]="";this.popupMessengerTextarea.value="";this.textareaCheckText();return false}var t=e.toString().substr(0,4)=="chat"?e.toString().substr(4):this.userChat[e]?this.userChat[e]:0;if(this.errorMessage[e]){BX.MessengerCommon.sendMessageRetry();this.errorMessage[e]=false}this.popupMessengerTextarea.value=BX.MessengerCommon.prepareMention(e,this.popupMessengerTextarea.value);var a=this.messageTmpIndex;this.message["temp"+a]={id:"temp"+a,chatId:t,senderId:this.BXIM.userId,recipientId:e,date:new Date,text:BX.MessengerCommon.prepareText(this.popupMessengerTextarea.value,true)};if(!this.showMessage[e])this.showMessage[e]=[];this.showMessage[e].push("temp"+a);this.messageTmpIndex++;BX.localStorage.set("mti",this.messageTmpIndex,5);if(this.popupMessengerTextarea==null||e!=this.currentTab)return false;clearTimeout(this.textareaHistoryTimeout);if(!BX.browser.IsAndroid()&&!BX.browser.IsIOS())BX.focus(this.popupMessengerTextarea);var n=BX.findChildByClassName(this.popupMessengerBodyWrap,"bx-messenger-content-load");if(n)BX.remove(n);var o=BX.findChildByClassName(this.popupMessengerBodyWrap,"bx-messenger-content-empty");if(o)BX.remove(o);if(e.toString().substr(0,4)=="chat"&&this.linesSilentMode&&this.linesSilentMode[e.toString().substr(4)]){if(!this.message["temp"+a].params){this.message["temp"+a].params={}}this.message["temp"+a].params.CLASS="bx-messenger-content-item-system"}BX.MessengerCommon.drawMessage(e,this.message["temp"+a]);BX.MessengerCommon.sendMessageAjax(a,e,this.popupMessengerTextarea.value,e.toString().substr(0,4)=="chat");if(this.BXIM.settings.status!="dnd"){this.BXIM.playSound("send")}this.textareaHistory[this.currentTab]="";this.popupMessengerTextarea.value="";this.textareaCheckText();setTimeout(BX.delegate(function(){this.popupMessengerTextarea.value="";this.textareaCheckText()},this),0);return true};BX.MessengerChat.prototype.textareaCheckText=function(e){e=e||{};e.textarea=e.textarea||"default";var t=e.textarea=="createChat"?this.popupCreateChatTextarea:this.popupMessengerTextarea;if(t.value.length>0){if(t.parentNode&&t.parentNode.parentNode&&t.parentNode.parentNode.className.indexOf("bx-messenger-textarea-with-text")==-1){BX.addClass(t.parentNode.parentNode,"bx-messenger-textarea-with-text")}}else{if(t.parentNode&&t.parentNode.parentNode&&t.parentNode.parentNode.className.indexOf("bx-messenger-textarea-with-text")>=0){BX.removeClass(t.parentNode.parentNode,"bx-messenger-textarea-with-text")}}};BX.MessengerChat.prototype.openCommandDialog=function(){this.closeMenuPopup();var e=this.popupMessengerTextarea;if(e.selectionStart==0||e.value.charCodeAt(e.selectionStart-1)==10||e.value.charCodeAt(e.selectionStart-1)==13){if(e.value.substr(-1)!="/"){this.insertTextareaText(e,"/")}}else{if(e.value.substr(-1)!="/"){this.insertTextareaText(e,"\n");this.insertTextareaText(e,"/")}}e.focus();this.textareaCommandListUpdate("")};BX.MessengerChat.prototype.textareaCommandListUpdate=function(e){if(this.currentTab==this.BXIM.userId){return false}if(e===false){this.commandListen=false;this.commandSelect="";this.commandSelectIndex=1;if(this.commandPopup)this.commandPopup.close()}else{this.commandListen=true;this.commandList=BX.MessengerCommon.prepareCommandList(e);if(this.commandList.length>0){this.commandSelectIndex=1;var e=this.commandList[this.commandSelectIndex].command||"";this.commandSelect=e==">>"?e:e.substr(1);var t=false;if(!this.commandPopup){this.commandPopup=new BX.PopupWindow("bx-messenger-command",this.popupMessengerTextareaPlace,{darkMode:this.BXIM.settings.enableDarkTheme,lightShadow:true,autoHide:true,offsetLeft:5,bindOptions:{position:"top"},zIndex:BX.MessengerCommon.getDefaultZIndex()+200,events:{onPopupClose:function(){this.destroy()},onPopupDestroy:BX.delegate(function(){if(this.commandPopup){this.commandPopup=null;this.textareaCommandListUpdate(false)}},this)},content:BX.create("div",{props:{className:"bx-messenger-command-popup "+(BX.browser.IsMac()?"":" bx-messenger-custom-scroll")},children:[BX.create("div",{props:{className:"bx-messenger-command-popup-header"},children:[BX.create("span",{props:{className:"bx-messenger-command-popup-title"},html:BX.message("IM_COMMAND_TITLE")}),BX.create("span",{props:{className:"bx-messenger-command-popup-help"},children:[BX.create("span",{props:{className:"bx-messenger-command-popup-help-item"},html:BX.message("IM_COMMAND_H_1")}),BX.create("span",{props:{className:"bx-messenger-command-popup-help-item"},html:BX.message("IM_COMMAND_H_2")}),BX.create("span",{props:{className:"bx-messenger-command-popup-help-item"},html:BX.message("IM_COMMAND_H_3")})]})]}),this.commandPopupList=BX.create("div",{props:{className:"bx-messenger-command-popup-list"},html:this.textareaCommandListItems()})]})});BX.addClass(this.commandPopup.popupContainer,"bx-messenger-mark");if(!this.BXIM.settings.enableDarkTheme)this.commandPopup.setAngle({offset:5});t=true}if(t){this.commandPopup.show();BX.bindDelegate(this.commandPopupList,"click",{className:"bx-messenger-command-popup-item"},BX.delegate(function(){var e=BX.proxy_context.getAttribute("data-id");var t="";for(var s=0;s<this.command.length;s++){if(this.command[s].id==e){t=this.command[s].command.substr(1)}}this.commandSelect=t;this.textareaCommandClick()},this));BX.bindDelegate(this.commandPopupList,"mouseover",{className:"bx-messenger-command-popup-item"},BX.delegate(function(){var e=BX.proxy_context.getAttribute("data-id");if(!e){return true}var t="";for(var s=0;s<this.command.length;s++){if(this.command[s].id==e){t=this.command[s].command.substr(1)}}this.commandSelectIndex=parseInt(BX.proxy_context.getAttribute("data-index"));this.commandSelect=t;var i=BX.findChildByClassName(this.commandPopupList,"bx-messenger-command-popup-item-selected");if(i){BX.removeClass(i,"bx-messenger-command-popup-item-selected")}BX.addClass(BX.proxy_context,"bx-messenger-command-popup-item-selected");t="/"+this.commandSelect;var a=this.popupMessengerTextarea;var n=a.value.substr(0,a.selectionStart).lastIndexOf("/");var o=a.value.substr(a.selectionStart);var r=a.value.substr(0,n);a.value=r+t+""+o;a.selectionStart=n+t.length;a.selectionEnd=a.selectionStart},this))}else if(this.commandList.length>0){this.commandPopupList.innerHTML=this.textareaCommandListItems();this.commandPopup.adjustPosition({forceBindPosition:true,position:"top"})}}else{this.commandSelectIndex=0;this.commandSelect=e;if(this.commandPopup){var s=this.commandPopup;this.commandPopup=null;s.close()}}}};BX.MessengerChat.prototype.textareaCommandListItems=function(){var e="";var t=false;for(var s=0;s<this.commandList.length;s++){if(this.commandList[s].type=="category"){e+='<div class="bx-messenger-command-popup-item-category">'+this.commandList[s].title+"</div>"}else{e+='<div class="bx-messenger-command-popup-item bx-messenger-command-popup-item-'+s+" "+(this.commandSelectIndex==s?"bx-messenger-command-popup-item-selected":"")+'" data-id="'+this.commandList[s].id+'" data-index="'+s+'">'+'<span class="bx-messenger-command-popup-item-text">'+'<span class="bx-messenger-command-popup-item-command">'+this.commandList[s].command+"</span>"+'<span class="bx-messenger-command-popup-item-params">'+this.commandList[s].params+"</span>"+"</span>"+'<span class="bx-messenger-command-popup-item-title">'+this.commandList[s].title+"</span>"+"</div>"}}return e};BX.MessengerChat.prototype.textareaCommandClick=function(){var e="";if(this.commandSelect){e=this.commandSelect==">>"?">> ":"/"+this.commandSelect+" "}var t=this.popupMessengerTextarea;var s=t.value.substr(0,t.selectionStart).lastIndexOf("/");var i=t.value.substr(t.selectionStart);var a=t.value.substr(0,s);t.value=a+e+i;t.selectionStart=s+e.length;t.selectionEnd=t.selectionStart;this.textareaCommandListUpdate(false);t.focus()};BX.MessengerChat.prototype.textareaCommandSelect=function(e){if(this.commandList.length<=0||this.commandList.length==2){return this.commandSelect}if(e=="up"){if(this.commandSelectIndex==1){this.commandSelectIndex=this.commandList.length-1}else{this.commandSelectIndex-=1;if(this.commandList[this.commandSelectIndex].type=="category"){this.commandSelectIndex-=1}}}else{if(this.commandSelectIndex==this.commandList.length-1){this.commandSelectIndex=1}else{this.commandSelectIndex+=1;if(this.commandList[this.commandSelectIndex].type=="category"){this.commandSelectIndex+=1}}}this.commandSelect=this.commandList[this.commandSelectIndex].command==">>"?this.commandList[this.commandSelectIndex].command:this.commandList[this.commandSelectIndex].command.substr(1);var t=BX.findChildByClassName(this.commandPopupList,"bx-messenger-command-popup-item-selected");if(t){BX.removeClass(t,"bx-messenger-command-popup-item-selected")}t=BX.findChildByClassName(this.commandPopupList,"bx-messenger-command-popup-item-"+this.commandSelectIndex);if(t){BX.addClass(t,"bx-messenger-command-popup-item-selected");var s=BX.MessengerCommon.isElementVisibleOnScreen(t,this.commandPopupList,true);if(!s.top||!s.bottom){var i=0;if(this.commandSelectIndex==this.commandList.length-1){i=this.commandPopupList.scrollHeight}else if(this.commandSelectIndex>1){if(e=="up"){i=this.commandPopupList.scrollTop-s.coords.top*-1}else{i=this.commandPopupList.scrollTop+s.coords.top-this.commandPopupList.offsetHeight+t.offsetHeight}}if(this.commandPopupListAnimation!=null){this.commandPopupListAnimation.stop()}(this.commandPopupListAnimation=new BX.easing({duration:400,start:{scroll:this.commandPopupList.scrollTop},finish:{scroll:i},transition:BX.easing.makeEaseInOut(BX.easing.transitions.quart),step:BX.delegate(function(e){this.commandPopupList.scrollTop=e.scroll},this)})).animate()}}return this.commandSelect};BX.MessengerChat.prototype.textareaPrepareText=function(e,t,s,i){var a=true;if(this.commandListen){if(t.altKey==true||t.ctrlKey==true||t.metaKey==true){return BX.PreventDefault(t)}else if(t.keyCode==8){var n=e.value.substr(e.selectionStart-1,1);if(n=="/"){this.textareaCommandListUpdate(false)}else{setTimeout(BX.delegate(function(){var t=e.value.substr(0,e.selectionStart).lastIndexOf("/")+1;var s=e.value.substr(t,e.selectionStart-t);this.textareaCommandListUpdate(s)},this),10)}}else if(t.keyCode==27){this.commandListen=false;var o=e.value.substr(0,e.selectionStart).lastIndexOf("/");var r=e.value.substr(e.selectionStart);var l=e.value.substr(0,o+1);e.value=l+r;e.selectionStart=o+1;e.selectionEnd=e.selectionStart;this.textareaCommandListUpdate(false);return BX.PreventDefault(t)}else if(t.keyCode==9){this.textareaCommandSelect("down");command="/"+this.commandSelect;var o=e.value.substr(0,e.selectionStart).lastIndexOf("/");var r=e.value.substr(e.selectionStart);var l=e.value.substr(0,o);e.value=l+command+""+r;e.selectionStart=o+command.length;e.selectionEnd=e.selectionStart;return BX.PreventDefault(t)}else if(t.keyCode==39||t.keyCode==37){return BX.PreventDefault(t)}else if(t.keyCode==38||t.keyCode==40){if(t.keyCode==38){this.textareaCommandSelect("up")}else if(t.keyCode==40){this.textareaCommandSelect("down")}command="/"+this.commandSelect;var o=e.value.substr(0,e.selectionStart).lastIndexOf("/");var r=e.value.substr(e.selectionStart);var l=e.value.substr(0,o);e.value=l+command+r;e.selectionStart=o+command.length;e.selectionEnd=e.selectionStart;return BX.PreventDefault(t)}else if(t.keyCode==13||t.keyCode==32){this.textareaCommandClick();return BX.PreventDefault(t)}else{setTimeout(BX.delegate(function(){var t=e.value.substr(0,e.selectionStart).lastIndexOf("/")+1;var s=e.value.substr(e.value.substr(0,e.selectionStart).lastIndexOf("/")+1,e.selectionStart-t);this.textareaCommandListUpdate(s)},this),10)}}else if(this.mentionListen){if(t.keyCode==27){this.mentionListen=false;this.mentionDelimiter="";return BX.PreventDefault(t)}else if(t.keyCode==13){this.popupContactListSearchInput.value="";var p=BX.findChildByClassName(this.popupChatDialogContactListElements,"bx-messenger-cl-item");if(p){p.getAttribute("data-userId");var h=e.value.substr(0,e.selectionEnd);h=h.substr(h.lastIndexOf(this.mentionDelimiter),e.selectionEnd-h.lastIndexOf(this.mentionDelimiter));e.value=e.value.replace(h,p.getAttribute("data-name")+" ");BX.MessengerCommon.addMentionList(this.currentTab,p.getAttribute("data-name"),p.getAttribute("data-userId"));this.popupChatDialog.close()}return BX.PreventDefault(t)}else{setTimeout(BX.delegate(function(){var t=e.value.substr(0,e.selectionEnd);var s=t.lastIndexOf(this.mentionDelimiter);var i=e.selectionEnd-t.lastIndexOf(this.mentionDelimiter);t=t.substr(s,i);if(t.length<=0||s<0){if(this.popupChatDialog)this.popupChatDialog.close();return false}t=t.substr(1);if(t.substr(0,1)==" "){if(this.popupChatDialog)this.popupChatDialog.close();return false}else if(t.length<=3&&t.substr(0,1).substr(0,1).match(/\d$/)){if(this.popupChatDialog)this.popupChatDialog.close();return false}this.popupChatDialogContactListSearch.value=t;BX.MessengerCommon.contactListPrepareSearch("popupChatDialogContactListElements",this.popupChatDialogContactListElements,this.popupChatDialogContactListSearch.value,{viewOffline:true,viewChat:false,viewOpenChat:true,exceptUsers:[],timeout:100,callback:{empty:BX.delegate(function(){this.popupChatDialog.close();return false},this)}})},this),10)}}else if(t.altKey==true&&t.ctrlKey==true){}else if(t.shiftKey==true&&(t.keyCode==61||t.keyCode==50||t.keyCode==187||t.keyCode==187)||t.keyCode==107){var c=this.BXIM.messenger.openChatFlag&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)]&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)].type=="livechat";if(!this.mentionListen&&!c){setTimeout(BX.delegate(function(){var t=e.value.substr(e.selectionEnd-1,1);if(!(t=="@"||t=="+"))return false;this.mentionListen=true;this.mentionDelimiter=t;this.openChatDialog({type:"MENTION",bind:e,focus:false,delimiter:t});this.setClosingByEsc(false)},this),300)}}else if(t.metaKey==true||t.ctrlKey==true){var u={66:"b",83:"s",73:"i",85:"u"};if(u[t.keyCode]||t.keyCode==84||!BX.MessengerCommon.isDesktop()&&BX.browser.IsChrome()&&t.keyCode==69){var o=e.selectionStart;var d=e.selectionEnd;resultText=e.value.substring(o,d);if(t.keyCode==84||!BX.MessengerCommon.isDesktop()&&BX.browser.IsChrome()&&t.keyCode==69){if(o==d){o=0;d=e.value.length;resultText=e.value}e.value=e.value.substring(0,o)+BX.correctText(resultText,{replace_way:"AUTO",mixed:true})+e.value.substring(d,e.value.length);e.selectionStart=o;e.selectionEnd=d}else{if(o==d){return BX.PreventDefault(t)}resultTagStart=e.value.substring(o,o+3);resultTagEnd=e.value.substring(d-4,d);if(resultTagStart.toLowerCase()=="["+u[t.keyCode]+"]"&&resultTagEnd.toLowerCase()=="[/"+u[t.keyCode]+"]"){e.value=e.value.substring(0,o)+e.value.substring(o+3,d-4)+e.value.substring(d,e.value.length);e.selectionStart=o;e.selectionEnd=d-7}else{e.value=e.value.substring(0,o)+"["+u[t.keyCode]+"]"+resultText+"[/"+u[t.keyCode]+"]"+e.value.substring(d,e.value.length);e.selectionStart=o;e.selectionEnd=d+7}}return BX.PreventDefault(t)}}else if((t.keyCode==191||t.keyCode==111||t.keyCode==220)&&e==this.popupMessengerTextarea){if(e.selectionStart==0||e.value.charCodeAt(e.selectionStart-1)==10||e.value.charCodeAt(e.selectionStart-1)==13){setTimeout(BX.delegate(function(){var t=e.value.substr(e.selectionEnd-1,1);if(t=="/"){this.textareaCommandListUpdate("")}},this),300)}}if(t.keyCode==9){this.insertTextareaText(e,"\t");return BX.PreventDefault(t)}if(t.keyCode==27&&!BX.MessengerCommon.isDesktop()){if(t.shiftKey){i()}else if(e==this.popupCreateChatTextarea){if(this.popupCreateChatTextarea.value==""){i()}else{return BX.PreventDefault(t)}}else if(e!=this.popupMessengerTextarea||this.popupMessengerTextarea.value==""){i()}}else if(t.keyCode==38&&this.popupMessengerLastMessage>0&&BX.util.trim(e.value).length<=0){this.editMessage(this.popupMessengerLastMessage)}else if(this.BXIM.settings.sendByEnter==true&&(t.ctrlKey==true||t.altKey==true)&&t.keyCode==13)this.insertTextareaText(e,"\n");else if(this.BXIM.settings.sendByEnter==true&&t.shiftKey==false&&t.keyCode==13)a=s();else if(this.BXIM.settings.sendByEnter==false&&t.ctrlKey==true&&t.keyCode==13)a=s();else if(this.BXIM.settings.sendByEnter==false&&(t.metaKey==true||t.altKey==true)&&t.keyCode==13&&BX.browser.IsMac())a=s();clearTimeout(this.textareaHistoryTimeout);this.textareaHistoryTimeout=setTimeout(BX.delegate(function(){this.textareaHistory[this.currentTab]=this.popupMessengerTextarea.value},this),200);if(BX.util.trim(e.value).length>2)BX.MessengerCommon.sendWriting(this.currentTab);if(!a)return BX.PreventDefault(t)};BX.MessengerChat.prototype.openAnswersMenu=function(e){this.BXIM.openConfirm(BX.message("IM_OL_ANSWERS_SOON"),[new BX.PopupWindowButton({text:BX.message("IM_NOTIFY_CONFIRM_CLOSE"),className:"popup-window-button",events:{click:function(){this.popupWindow.close()}}})],true)};BX.MessengerChat.prototype.openFormsMenu=function(e){this.BXIM.openConfirm(BX.message("IM_OL_FORMS_SOON"),[new BX.PopupWindowButton({text:BX.message("IM_NOTIFY_CONFIRM_CLOSE"),className:"popup-window-button",events:{click:function(){this.popupWindow.close()}}})],true)};BX.MessengerChat.prototype.addRecentSmile=function(e,t){t=t||"";if(BX.MessengerCommon.isDesktop()&&BX.browser.IsMac()&&!this.desktop.enableInVersion(36))return false;var s=e.match(/\[icon\=([^\]]*)\]/gi);var i=false;if(s&&s.length){var a=[];var n=this.BXIM.getLocalConfig("smiles-recent",[])||[];for(var o=0;o<n.length;o++){a.push(n[o].IMAGE)}for(var o=0;o<s.length;o++){var r=s[o];var l=r.match(/icon\=(\S+[^\s.,> )\];\'\"!?])/i);if(l&&l[1]){l=l[1];if(a&&a.indexOf(l)>-1||l.match(/^(\d+)$/)){continue}}else{continue}if(t&&t.indexOf(l)<0){continue}i=true;var p={IMAGE:l,HEIGHT:20,WIDTH:20,NAME:""};var h=r.match(/size\=(\d+)/i);if(h&&h[1]){p["WIDTH"]=h[1];p["HEIGHT"]=h[1]}else{var c=r.match(/width\=(\d+)/i);if(c&&c[1]){p["WIDTH"]=c[1]}var u=r.match(/height\=(\d+)/i);if(u&&u[1]){p["HEIGHT"]=u[1]}if(p["WIDTH"]&&!p["HEIGHT"]){p["HEIGHT"]=p["WIDTH"]}else if(p["HEIGHT"]&&!p["WIDTH"]){p["WIDTH"]=p["HEIGHT"]}else{p["WIDTH"]=20;p["HEIGHT"]=20}}var d=r.match(/title\=(.*[^\s\]])/i);if(d&&d[1]){d=d[1];if(d.indexOf("width=")>-1){d=d.substr(0,d.indexOf("width="))}if(d.indexOf("height=")>-1){d=d.substr(0,d.indexOf("height="))}if(d.indexOf("size=")>-1){d=d.substr(0,d.indexOf("size="))}if(d){d=BX.util.trim(d);p["NAME"]=d}}n.push(p);this.injectRecentSmile(p)}if(i){this.BXIM.setLocalConfig("smiles-recent",n,26e5)}}return s?s.length:0};BX.MessengerChat.prototype.removeRecentSmile=function(e){if(BX.MessengerCommon.isDesktop()&&BX.browser.IsMac()&&!this.desktop.enableInVersion(36))return false;var t="";if(this.smile[e]){t=this.smile[e].IMAGE}if(t){var s=[];var i=this.BXIM.getLocalConfig("smiles-recent",[])||[];for(var a=0;a<i.length;a++){if(t!=i[a].IMAGE){s.push(i[a])}}this.BXIM.setLocalConfig("smiles-recent",s,26e5);delete this.smile[e]}return true};BX.MessengerChat.prototype.getRecentSmiles=function(){if(BX.MessengerCommon.isDesktop()&&BX.browser.IsMac()&&!this.desktop.enableInVersion(36))return false;if(!this.smileSet)return false;this.smileSet.push({ID:"icons",NAME:BX.message("IM_ICON_SET"),PARENT_ID:0,TYPE:"G"});var e=this.BXIM.getLocalConfig("smiles-recent",[])||[];if(e.length<=0){return true}this.smileRecentId=e.length+1;for(var t=0;t<e.length;t++){this.injectRecentSmile(e[t])}};BX.MessengerChat.prototype.injectRecentSmile=function(e){var t=BX.clone(e);if(typeof t!="object")return false;t.TITLE=t.NAME;if(!t.TITLE){t.TITLE=t.IMAGE.substring(t.IMAGE.lastIndexOf("/")+1);t.TITLE=t.TITLE.substring(0,t.TITLE.lastIndexOf("."))}this.smile["icon"+this.smileRecentId]={NAME:t.NAME,HEIGHT:t.HEIGHT>100?100:t.HEIGHT,WIDTH:t.WIDTH>100?100:t.WIDTH,IMAGE:t.IMAGE,TYPING:"[icon="+this.smileRecentId+" title="+t.TITLE+"]",SET_ID:"icons"};this.smileRecentId++};BX.MessengerChat.prototype.openSmileMenu=function(e){e=e||{};e.textarea=e.textarea||"default";e.bind=e.bind||this.popupMessengerSmileButton;this.closePopupFileMenu();if(this.popupPopupMenu!=null)this.popupPopupMenu.destroy();if(this.popupChatDialog!=null){this.popupChatDialog.destroy()}if(this.popupSmileMenu!=null){this.popupSmileMenu.destroy()}if(this.commandPopup!=null){this.commandPopup.destroy()}if(this.popupIframeMenu!=null&&this.popupIframeBind){this.popupIframeMenu.destroy()}if(this.smile==false){this.tooltip(this.popupMessengerSmileButton,BX.message("IM_SMILE_NA"),{offsetLeft:-20});return false}var t={};for(var s in this.smile){if(!t[this.smile[s].SET_ID])t[this.smile[s].SET_ID]=[];var i=BX.util.htmlspecialcharsback(this.smile[s].TYPING);t[this.smile[s].SET_ID].push(BX.create("img",{props:{className:"bx-messenger-smile-gallery-image"},attrs:{"data-id":s,"data-code":i,"data-textarea":e.textarea,style:"width: "+this.smile[s].WIDTH+"px; height: "+this.smile[s].HEIGHT+"px",src:this.smile[s].IMAGE,alt:this.smile[s].TYPING,title:BX.util.htmlspecialcharsback(this.smile[s].NAME)}}))}var a=0;var n=[];var o=[BX.create("span",{props:{className:"bx-messenger-smile-nav-name"},html:BX.message("IM_SMILE_SET")})];if(!this.smileSet[this.smileCurrentSet]||typeof t[this.smileSet[this.smileCurrentSet]["ID"]]=="undefined"){this.smileCurrentSet=0}var s=0;var r="";for(var l=0;l<this.smileSet.length;l++){if(typeof t[this.smileSet[l]["ID"]]=="undefined")continue;s=this.smileSet[l]["ID"];r=this.smileSet[l]["NAME"];n.push(BX.create("span",{attrs:{"data-set-id":s},props:{className:"bx-messenger-smile-gallery-set"+(a!=this.smileCurrentSet?" bx-messenger-smile-gallery-set-hide":"")},children:t[s]}));o.push(BX.create("span",{attrs:{"data-set-id":s,title:BX.util.htmlspecialcharsback(r)},props:{className:"bx-messenger-smile-nav-item"+(a==this.smileCurrentSet?" bx-messenger-smile-nav-item-active":"")}}));a++}this.popupSmileMenu=new BX.PopupWindow("bx-messenger-popup-smile",e.bind,{darkMode:this.BXIM.settings.enableDarkTheme,lightShadow:false,offsetTop:0,offsetLeft:-38,autoHide:true,closeByEsc:true,bindOptions:{position:"top"},zIndex:BX.MessengerCommon.getDefaultZIndex()+200,events:{onPopupClose:function(){this.destroy()},onPopupDestroy:BX.delegate(function(){this.popupSmileMenu=null},this)},content:BX.create("div",{props:{className:"bx-messenger-smile"+(BX.browser.IsMac()?"":" bx-messenger-custom-scroll")},children:[this.popupSmileMenuGallery=BX.create("div",{props:{className:"bx-messenger-smile-gallery"},children:n}),this.popupSmileMenuSet=BX.create("div",{props:{className:"bx-messenger-smile-nav"+(a<=1?" bx-messenger-smile-nav-disabled":"")},children:o})]})});BX.addClass(this.popupSmileMenu.popupContainer,"bx-messenger-mark");if(!this.BXIM.settings.enableDarkTheme)this.popupSmileMenu.setAngle({offset:74});this.popupSmileMenu.show();BX.bindDelegate(this.popupSmileMenuGallery,"click",{className:"bx-messenger-smile-gallery-image"},BX.delegate(function(){var e=BX.proxy_context.getAttribute("data-textarea")=="createChat"?this.popupCreateChatTextarea:this.popupMessengerTextarea;this.insertTextareaText(e," "+BX.proxy_context.getAttribute("data-code")+" ",false);this.popupSmileMenu.close();e.focus()},this));BX.bindDelegate(this.popupSmileMenuGallery,"contextmenu",{className:"bx-messenger-smile-gallery-image"},BX.delegate(function(e){var t=BX.proxy_context.getAttribute("data-code").match(/\[icon\=([^\]]*)\]/gi);if(t){this.openPopupMenu(BX.proxy_context,"iconMenu",true,{closeSmiles:false});return BX.PreventDefault(e)}},this));BX.bindDelegate(this.popupSmileMenuSet,"click",{className:"bx-messenger-smile-nav-item"},BX.delegate(function(){if(BX.hasClass(BX.proxy_context,"bx-messenger-smile-nav-item-active"))return false;var e=BX.findChildrenByClassName(this.popupSmileMenuGallery,"bx-messenger-smile-gallery-set",false);var t=BX.findChildrenByClassName(this.popupSmileMenuSet,"bx-messenger-smile-nav-item",false);for(var s=0;s<t.length;s++){if(BX.proxy_context==t[s]){BX.removeClass(e[s],"bx-messenger-smile-gallery-set-hide");BX.addClass(t[s],"bx-messenger-smile-nav-item-active");this.smileCurrentSet=s;this.BXIM.setLocalConfig("smiles-current-set",s)}else{BX.addClass(e[s],"bx-messenger-smile-gallery-set-hide");BX.removeClass(t[s],"bx-messenger-smile-nav-item-active")}}},this));BX.onCustomEvent("onImOpenSmileMenu",[]);return false};BX.MessengerChat.prototype.textareaIconToggle=function(){if(!this.popupMessengerPanelBotIcons){return true}var e=BX.findChildrenByClassName(this.popupMessengerTextareaIconBox,"bx-messenger-textarea-icon-bot",true);if(!e){this.popupMessengerPanelBotIcons=false;return false}for(var t=0;t<e.length;t++){BX.removeClass(e[t],"bx-messenger-textarea-icon-bot-show")}this.popupMessengerPanelBotIcons=false;if(this.openBotFlag){var e=BX.findChildrenByClassName(this.popupMessengerTextareaIconBox,"bx-messenger-textarea-icon-bot-"+this.currentTab,true);if(e){for(var t=0;t<e.length;t++){BX.addClass(e[t],"bx-messenger-textarea-icon-bot-show")}this.popupMessengerPanelBotIcons=true}}return true};BX.MessengerChat.prototype.textareaIconCheckContext=function(e){var t=e.substr(-6)=="-admin";if(t&&!this.BXIM.isAdmin){return false}if(t){e=e.substr(0,e.length-6)}if(e=="chat"){if(!this.openChatFlag){return false}}else if(e=="bot"){if(!this.openBotFlag){return false}}else if(e=="call"){if(!this.openCallFlag){return false}}else if(e=="user"){if(this.openCallFlag||this.openChatFlag||this.openLinesFlag){return false}}else if(e.startsWith("lines")){if(!this.openLinesFlag){return false}if(e!=="lines"){var s=e.substr(6);var i=BX.MessengerCommon.linesGetSession(this.chat[this.currentTab.substr(4)]).connector;if(i!==s){return false}}}return true};BX.MessengerChat.prototype.textareaIconPrepare=function(){if(!this.popupMessengerTextareaIconBox)return false;this.popupMessengerTextareaIconBox.innerHTML="";if(!this.textareaIcon.length){return false}var e=null;var t=[];var s=[];for(var i=0;i<this.textareaIcon.length;i++){if(!this.textareaIcon[i]||this.textareaIcon[i].hidden){continue}if(this.desktop.ready()&&!this.desktop.enableInVersion(39)&&this.textareaIcon[i]["iframe"]){if(BXDesktopSystem.GetProperty("versionParts").join(".")!="5.0.32.38"){continue}}var a=this.textareaIcon[i]["description"]?this.textareaIcon[i]["description"]:this.textareaIcon[i]["title"];if(!this.textareaIcon[i]["title"]&&!this.textareaIcon[i]["url"]){continue}var n="bx-messenger-textarea-icon-marketplace-"+this.textareaIcon[i]["id"]+" bx-messenger-textarea-icon-context-"+this.textareaIcon[i]["context"]+(this.textareaIcon[i]["context"]=="bot"||this.textareaIcon[i]["context"]=="bot-admin"?" bx-messenger-textarea-icon-bot bx-messenger-textarea-icon-bot-"+this.textareaIcon[i]["botId"]:"");if(!this.textareaIcon[i]["url"]){t.push(this.textareaIcon[i]);s.push(n);continue}if(this.textareaIcon[i]["code"]==="salescenter"){e=BX.create("div",{props:{className:"bx-messenger-textarea-icon-marketplace "+n+" bx-messenger-textarea-icon-salescenter"},attrs:{title:a,"data-context":this.textareaIcon[i]["context"],"data-code":this.textareaIcon[i]["code"],"data-id":this.textareaIcon[i]["id"]},events:{click:BX.delegate(this.textareaIconClick,this)},html:BX.message("IM_APPS_SALESCENTER_BUTTON")})}else{e=BX.create("div",{props:{className:"bx-messenger-textarea-icon-marketplace "+n},attrs:{title:a,style:"background-image: url('"+this.textareaIcon[i]["url"]+"')","data-context":this.textareaIcon[i]["context"],"data-code":this.textareaIcon[i]["code"],"data-id":this.textareaIcon[i]["id"]},events:{click:BX.delegate(this.textareaIconClick,this)}})}this.popupMessengerTextareaIconBox.appendChild(e)}if(t.length){this.popupMessengerTextareaIconApps=BX.create("div",{props:{className:"bx-messenger-textarea-icon-marketplace bx-messenger-textarea-icon-marketplace-default "+s.join(" ")},attrs:{title:BX.message("IM_APPS_LIST")},events:{click:BX.delegate(function(e){this.openPopupMenu(BX.proxy_context,"textareaAppsMenu")},this)}});this.popupMessengerTextareaIconBox.appendChild(this.popupMessengerTextareaIconApps)}return true};BX.MessengerChat.prototype.textareaIconDialogClick=function(id,messageId,params){params=params||{};var icon=null;for(var i=0;i<this.textareaIcon.length;i++){if(!this.textareaIcon[i]||this.textareaIcon[i].id!=id){continue}icon=this.textareaIcon[i];break}if(!icon&&!params.___ajaxSkip){BX.ajax({url:this.BXIM.pathToAjax+"?GET_TEXTAREA_ICONS&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{IM_GET_TEXTAREA_ICONS:"Y",IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()},onsuccess:BX.delegate(function(e){this.textareaIcon=e.TEXTAREA_ICON?e.TEXTAREA_ICON:[];this.textareaIconPrepare();params.___ajaxSkip=true;this.textareaIconDialogClick(id,messageId,params)},this)});return false}delete params.___ajaxSkip;if(this.textareaIconCheckContext(icon.context)){if(icon.iframe){var dialogContext="user";var dialogEntityId="";var dialogEntityData1="";if(this.currentTab.toString().substr(0,4)=="chat"){dialogContext=this.chat[this.currentTab.substr(4)].entity_type.toLowerCase();dialogEntityId=this.chat[this.currentTab.substr(4)].entity_id;dialogEntityData1=this.chat[this.currentTab.substr(4)].entity_data_1}this.openFrameDialog({bind:null,title:icon.title,copyright:icon.copyright,iframe:{src:icon.iframe,width:icon.iframeWidth,height:icon.iframeHeight,popup:true},params:{BOT_ID:icon.botId,BOT_CODE:icon.botCode,APP_ID:icon.id,APP_CODE:icon.code,DOMAIN:location.origin,DOMAIN_HASH:icon.domainHash,USER_ID:this.BXIM.userId,USER_HASH:icon.userHash,DIALOG_ID:this.currentTab,DIALOG_CONTEXT:dialogContext,DIALOG_ENTITY_ID:dialogEntityId,DIALOG_ENTITY_DATA_1:dialogEntityData1,LANG:BX.message.LANGUAGE_ID,IS_CHROME:BX.browser.IsChrome()?"Y":"N",CONTEXT:"button",DARK_MODE:this.BXIM.settings.enableDarkTheme?"Y":"N",MESSAGE_ID:messageId,BUTTON_PARAMS:params}})}else if(icon.js){var button=BX.proxy_context;eval(icon.js)}}};BX.MessengerChat.prototype.textareaIconClick=function(event){if(this.popupPopupMenu!=null){this.popupPopupMenu.destroy()}var icon=null;for(var i=0;i<this.textareaIcon.length;i++){if(!this.textareaIcon[i]||this.textareaIcon[i].id!=BX.proxy_context.getAttribute("data-id")||this.textareaIcon[i].hidden){continue}icon=this.textareaIcon[i];break}if(!icon){return false}if(this.textareaIconCheckContext(icon.context)){if(icon.iframe){var dialogContext="user";var dialogEntityId="";var dialogEntityData1="";if(this.currentTab.toString().substr(0,4)=="chat"){dialogContext=this.chat[this.currentTab.substr(4)].entity_type.toLowerCase();dialogEntityId=this.chat[this.currentTab.substr(4)].entity_id;dialogEntityData1=this.chat[this.currentTab.substr(4)].entity_data_1}this.openFrameDialog({bind:event?BX.proxy_context:this.popupMessengerTextareaIconApps,title:icon.title,copyright:icon.copyright,iframe:{src:icon.iframe,width:icon.iframeWidth,height:icon.iframeHeight,popup:icon.iframePopup},params:{BOT_ID:icon.botId,BOT_CODE:icon.botCode,APP_ID:icon.id,APP_CODE:icon.code,DOMAIN:location.origin,DOMAIN_HASH:icon.domainHash,USER_ID:this.BXIM.userId,USER_HASH:icon.userHash,DIALOG_ID:this.currentTab,DIALOG_CONTEXT:dialogContext,DIALOG_ENTITY_ID:dialogEntityId,DIALOG_ENTITY_DATA_1:dialogEntityData1,LANG:BX.message.LANGUAGE_ID,IS_CHROME:BX.browser.IsChrome()?"Y":"N",CONTEXT:"textarea",DARK_MODE:this.BXIM.settings.enableDarkTheme?"Y":"N",CONTEXT:"textarea"}})}else if(icon.js){var button=BX.proxy_context;eval(icon.js)}}return event?BX.PreventDefault(event):true};BX.MessengerChat.prototype.openFrameDialog=function(e){e=e||{};if(e.iframe&&e.iframe.popup){e.bind=null}else{e.bind=e.bind||null}this.closePopupFileMenu();if(this.popupPopupMenu!=null){this.popupPopupMenu.destroy()}if(this.popupChatDialog!=null){this.popupChatDialog.destroy()}if(this.popupSmileMenu!=null){this.popupSmileMenu.destroy()}if(this.commandPopup!=null){this.commandPopup.destroy()}if(this.popupIframeMenu!=null){this.popupIframeMenu.destroy()}this.openFrameDialogBid=e.params.BOT_ID;this.openFrameDialogDid=this.currentTab;if(this.sendFrameTokenCollection[this.openFrameDialogBid]){if(this.sendFrameTokenCollection[this.openFrameDialogBid]+this.sendFrameTokenTimeout*1e3<+new Date){this.sendFrameToken(this.openFrameDialogBid,this.openFrameDialogDid)}}else{this.sendFrameToken(this.openFrameDialogBid,this.openFrameDialogDid)}var t="";for(var s in e.params){t=t+s+"="+encodeURIComponent(e.params[s])+"&"}t=e.iframe.src+t;e.iframe.height=parseInt(e.iframe.height);if(e.iframe.height>this.popupMessengerBody.offsetHeight){e.iframe.height=this.popupMessengerBody.offsetHeight}this.popupIframeBind=!!e.bind;this.popupIframeMenu=new BX.PopupWindow("bx-messenger-iframe",e.bind,{darkMode:this.BXIM.settings.enableDarkTheme,lightShadow:false,offsetTop:0,offsetLeft:-38,autoHide:this.popupIframeBind,closeByEsc:true,bindOptions:{position:"top"},closeIcon:e.bind?null:{right:"13px"},draggable:e.bind?null:{restrict:true},zIndex:BX.MessengerCommon.getDefaultZIndex()+200,events:{onPopupClose:function(){this.destroy()},onPopupDestroy:BX.delegate(function(){this.openFrameDialogBid=null;this.openFrameDialogDid=null;this.popupIframeMenu=null;this.popupIframeBind=true;this.openFrameDialogFrame=null;this.openFrameDialogFrameSourceDomain=null},this)},content:BX.create("div",{props:{className:"bx-messenger-iframe-title-box"},children:[this.openFrameDialogTitle=BX.create("div",{props:{className:"bx-messenger-command-popup-header"},children:[BX.create("span",{props:{className:"bx-messenger-command-popup-title"},text:e.title}),BX.create("span",{props:{className:"bx-messenger-command-popup-help"},children:[BX.create("span",{props:{className:"bx-messenger-command-popup-help-item"},text:e.copyright})]})]}),this.openFrameDialogFrame=BX.create("iframe",{attrs:{frameborder:0,src:t,style:"min-width: "+parseInt(e.iframe.width)+"px; min-height: "+parseInt(e.iframe.height)+"px; max-height: 100%; max-width: 100%;",sandbox:"allow-same-origin allow-forms allow-scripts allow-popups",allow:"geolocation *; microphone *; camera *"},props:{className:"bx-messenger-iframe-element"+(BX.browser.IsMac()?"":" bx-messenger-custom-scroll")}})]})});BX.addClass(this.popupIframeMenu.popupContainer,"bx-messenger-mark");if(e.bind&&!this.BXIM.settings.enableDarkTheme){this.popupIframeMenu.setAngle({offset:74})}else{this.openFrameDialogTitle.style.cursor="move";BX.bind(this.openFrameDialogTitle,"mousedown",BX.proxy(this.popupIframeMenu.onTitleMouseDown,this.popupIframeMenu))}this.popupIframeMenu.show();BX.bind(this.openFrameDialogFrame,"load",BX.delegate(this.openFrameDialogLoad,this));if(t.indexOf("http")===0){var i=document.createElement("a");i.href=t;this.openFrameDialogFrameSourceDomain=i.protocol+"//"+i.hostname+(i.port&&i.port!="80"&&i.port!="443"?":"+i.port:"")}else{this.openFrameDialogFrameSourceDomain=location.protocol+"//"+location.hostname+(location.port&&location.port!="80"&&location.port!="443"?":"+location.port:"")}BX.onCustomEvent("onImOpenFrameDialog",[]);return false};BX.MessengerChat.prototype.openFrameDialogLoad=function(e){var t=0;if(typeof window.postMessage==="function"&&!t){this.openFrameDialogFrameUid=Math.random().toString().substr(2);this.openFrameDialogFrame.contentWindow.postMessage(JSON.stringify({action:"init",domain:location.origin,uniqueLoadId:this.openFrameDialogFrameUid}),this.openFrameDialogFrameSourceDomain)}};BX.MessengerChat.prototype.openFrameDialogPostMessage=function(e){var t={};try{t=JSON.parse(e)}catch(e){}if(!t.action)return;if(this.openFrameDialogFrameUid!=t.uniqueLoadId)return;if(t.action=="send"){this.BXIM.sendMessage(t.message)}else if(t.action=="put"){this.BXIM.putMessage(t.message);this.BXIM.messenger.textareaCheckText()}else if(t.action=="call"){this.BXIM.phoneTo(t.number)}else if(t.action=="support"){this.BXIM.openMessenger("networkLines"+t.code,null,true)}else if(t.action=="openDialog"){this.BXIM.openMessenger(t.dialogId,null,true)}else if(t.action=="close"){if(this.popupIframeMenu!=null){this.popupIframeMenu.destroy()}}return true};BX.MessengerChat.prototype.expireFrameToken=function(){if(!this.openFrameDialogBid){return false}for(var e in this.sendFrameTokenCollection){if(this.sendFrameTokenCollection[e]+this.sendFrameTokenTimeout*1e3<+new Date){delete this.sendFrameTokenCollection[e];if(this.openFrameDialogBid){this.sendFrameToken(this.openFrameDialogBid,this.openFrameDialogDid)}}}return true};BX.MessengerChat.prototype.sendFrameToken=function(e,t){this.sendFrameTokenCollection[e]=+new Date;BX.ajax({url:this.BXIM.pathToAjax+"?SEND_FRAME_TOKEN&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{IM_OPEN_REST_TOKEN:"Y",BOT_ID:e,DIALOG_ID:t,IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()}})};BX.MessengerChat.prototype.connectionStatus=function(e,t){t=typeof t=="undefined"?true:t;if(!(e=="online"||e=="connecting"||e=="offline"))return false;if(this.popupMessengerConnectionStatusState==e)return false;this.popupMessengerConnectionStatusState=e;var s="";if(e=="offline"){this.popupMessengerConnectionStatusStateText=BX.message("IM_CS_OFFLINE");s="bx-messenger-connection-status-offline"}else if(e=="connecting"){this.popupMessengerConnectionStatusStateText=BX.message("IM_CS_CONNECTING");s="bx-messenger-connection-status-connecting"}else if(e=="online"){this.popupMessengerConnectionStatusStateText=BX.message("IM_CS_ONLINE");s="bx-messenger-connection-status-online"}clearTimeout(this.popupMessengerConnectionStatusTimeout);if(!this.popupMessengerConnectionStatus)return false;if(e=="online"){if(t){if(this.redrawTab[this.currentTab]){BX.MessengerCommon.openDialog(this.currentTab)}else{this.updateState(true,false,"UPDATE_STATE_RECONNECT")}}clearTimeout(this.popupMessengerConnectionStatusTimeout);this.popupMessengerConnectionStatusTimeout=setTimeout(BX.delegate(function(){BX.removeClass(this.popupMessengerConnectionStatus,"bx-messenger-connection-status-show");BX.addClass(this.popupMessengerConnectionStatus,"bx-messenger-connection-status-hide")},this),4e3)}this.popupMessengerConnectionStatus.className="bx-messenger-connection-status bx-messenger-connection-status-show "+s;this.popupMessengerConnectionStatusText.innerHTML=this.popupMessengerConnectionStatusStateText;return true};BX.MessengerChat.prototype.editMessage=function(e){if(!BX.MessengerCommon.checkEditMessage(e,"edit"))return false;BX.removeClass(this.popupMessengerEditForm,"bx-messenger-editform-disable");BX.removeClass(this.popupMessengerEditForm,"bx-messenger-editform-hide");BX.addClass(this.popupMessengerEditForm,"bx-messenger-editform-show");this.popupMessengerEditMessageId=e;if(this.popupMessengerEditTextarea.value.length>20006){this.popupMessengerEditTextarea.value=this.popupMessengerEditTextarea.value.substr(0,2e4)+" (...)"}this.popupMessengerEditTextarea.value=BX.MessengerCommon.prepareTextBack(this.message[e].text,true);this.popupMessengerEditTextarea.value=this.popupMessengerEditTextarea.value.replace(/\[USER=([0-9]{1,})\](.*?)\[\/USER\]/gi,BX.delegate(function(e,t,s){BX.MessengerCommon.addMentionList(this.currentTab,s,parseInt(t));return s},this));this.popupMessengerEditTextarea.value=this.popupMessengerEditTextarea.value.replace(/\[CHAT=(imol\|)?([0-9]{1,})\](.*?)\[\/CHAT\]/gi,BX.delegate(function(e,t,s,i){BX.MessengerCommon.addMentionList(this.currentTab,i,"chat"+parseInt(s));return i},this));clearTimeout(this.popupMessengerEditFormTimeout);this.popupMessengerEditFormTimeout=setTimeout(BX.delegate(function(){if(!this.popupMessengerEditTextarea)return false;this.popupMessengerEditTextarea.focus();this.popupMessengerEditTextarea.selectionStart=this.popupMessengerEditTextarea.value.length;this.popupMessengerEditTextarea.selectionEnd=this.popupMessengerEditTextarea.value.length},this),200)};BX.MessengerChat.prototype.editMessageCancel=function(){this.popupMessengerEditTextarea.value="";if(BX.hasClass(this.popupMessengerEditForm,"bx-messenger-editform-disable"))return false;this.popupMessengerEditMessageId=0;BX.removeClass(this.popupMessengerEditForm,"bx-messenger-editform-show");BX.addClass(this.popupMessengerEditForm,"bx-messenger-editform-hide");clearTimeout(this.popupMessengerEditFormTimeout);this.popupMessengerEditFormTimeout=setTimeout(BX.delegate(function(){BX.removeClass(this.popupMessengerEditForm,"bx-messenger-editform-hide");BX.addClass(this.popupMessengerEditForm,"bx-messenger-editform-disable")},this),500);this.popupMessengerTextarea.focus();this.popupMessengerTextarea.selectionStart=this.popupMessengerTextarea.value.length;this.popupMessengerTextarea.selectionEnd=this.popupMessengerTextarea.value.length};BX.MessengerChat.prototype.deleteMessage=function(e,t){if(t!==false&&!BX.MessengerCommon.checkEditMessage(e,"delete"))return false;if(t!==false){this.BXIM.openConfirm(BX.message("IM_M_HISTORY_DELETE_CONFIRM"),[new BX.PopupWindowButton({text:BX.message("IM_M_HISTORY_DELETE"),className:"popup-window-button-decline",events:{click:BX.delegate(function(){this.deleteMessage(e,false);BX.proxy_context.popupWindow.close()},this)}}),new BX.PopupWindowButton({text:BX.message("IM_NOTIFY_CONFIRM_CLOSE"),className:"popup-window-button",events:{click:function(){this.popupWindow.close()}}})],true)}else{BX.MessengerCommon.deleteMessageAjax(e)}};BX.MessengerChat.prototype.shareMessage=function(e,t,s){BX.MessengerCommon.shareMessageAjax(e,t,s)};BX.MessengerChat.prototype.toggleLinesTab=function(e){if(typeof e=="undefined"){e=this.BXIM.settings.linesTabEnable}else{this.BXIM.settings.linesTabEnable=e}if(e){if(BX.MessengerWindow.existsTab("im-ol")){BX.MessengerWindow.showTab("im-ol")}else if(BX.MessengerCommon.isLinesOperator()){BX.addClass(BX.MessengerWindow.content,"bx-desktop-appearance-show-menu");BX.MessengerWindow.addTab({id:"im-ol",title:BX.message("IM_CTL_CHAT_OL"),order:105,target:"im",events:{open:BX.delegate(function(){if(BX.MessengerCommon.isPage()&&this.BXIM.context=="POPUP-FULLSCREEN"&&!this.popupMessenger){return false}if(!this.BXIM.dialogOpen){this.openMessenger(this.currentTab)}BX.MessengerCommon.userListRedraw()},this),close:BX.delegate(function(){BX.MessengerCommon.userListRedraw()},this)}})}}else{BX.MessengerWindow.hideTab("im-ol")}if(BX.MessengerWindow.currentTab=="im-ol"){BX.MessengerWindow.changeTab("im",true)}BX.MessengerCommon.userListRedraw();this.updateMessageCount();return true};BX.MessengerChat.prototype.toggleLinesNewGroup=function(e){if(typeof e=="undefined"){e=this.BXIM.settings.linesNewGroupEnable}else{this.BXIM.settings.linesNewGroupEnable=e}BX.MessengerCommon.userListRedraw();return e};BX.MessengerChat.prototype.toggleDarkTheme=function(e){var t="bx-messenger-dark";if(typeof e=="undefined"){e=this.BXIM.settings.enableDarkTheme}else{this.BXIM.settings.enableDarkTheme=e}if(!this.popupMessengerContent)return true;if(e){this.popupMessengerContent.classList.add(t)}else{this.popupMessengerContent.classList.remove(t)}if(BX.MessengerCommon.isPage()){if(e){BX.MessengerWindow.contentBox.classList.add(t)}else{BX.MessengerWindow.contentBox.classList.remove(t)}}if(BX.MessengerSlider.isFocus()){if(e){BX.MessengerSlider.getCurrent().getContentContainer().classList.add("bx-messenger-dark")}else{BX.MessengerSlider.getCurrent().getContentContainer().classList.remove("bx-messenger-dark")}}this.BXIM.setBackground();return true};BX.MessengerChat.prototype.onPaste=function(e){if(!e.clipboardData||!e.clipboardData.files||!this.BXIM.disk.enable){return true}var t=e.clipboardData.getData("Text");if(t&&!t.match(/\.(jpg|jpeg|png|gif)$/i)){return true}this.imageUploaderFiles=[];var s=false;var i=e.clipboardData.files.length;for(var a=0;a<e.clipboardData.files.length;++a){var n=e.clipboardData.files[a];if(!n||!n.type.match(/(jpg|jpeg|png|gif)/i)){continue}s=true;if(BX.browser.IsSafari()){r=n.name}else{var o=n.name.replace(/^(.*)\.(jpg|jpeg|png|gif)$/im,function(e,t,s){return s});var r=t?t.replace(/^(.*)\.(jpg|jpeg|png|gif)$/im,function(e,t){return t+"."+o}):"image_"+BX.Main.Date.format("Y-m-d_H:i:s")+"."+o}if(n.size>1*1024*1024){this.imageUploader()}var l=new FileReader;l.onerror=function(e){console.error("BX.Messenger.onPaste -> fileReader.onerror:",e);if(this.popupImageUploader){this.popupImageUploader.close()}}.bind(this);l.onabort=function(e){console.error("BX.Messenger.onPaste -> fileReader.onabort:",e);if(this.popupImageUploader){this.popupImageUploader.close()}}.bind(this);l.onloadend=function(e){this.imageUploaderFiles.push({name:r,source:e.target.result});if(i==1){if(this.popupImageUploader){this.imageUploaderUpdateImage()}else{this.imageUploader()}}else{i--}}.bind(this);l.readAsDataURL(n)}if(s){e.preventDefault();e.stopPropagation()}return true};BX.MessengerChat.prototype.imageUploader=function(){if(this.popupImageUploader)this.popupImageUploader.close();var e=BX.message("IM_UPLOAD_IMAGE_TITLE");if(this.imageUploaderFiles.length>1&&BX.message("IM_UPLOAD_IMAGE_TITLE_2")){e=BX.message("IM_UPLOAD_IMAGE_TITLE_2").replace("#NUMBER#",this.imageUploaderFiles.length)}this.popupImageUploader=new BX.PopupWindow("bx-messenger-image-uploader",null,{darkMode:this.BXIM.settings.enableDarkTheme,lightShadow:true,closeByEsc:true,closeIcon:{},contentNoPaddings:true,contentColor:"white",events:{onPopupClose:function(){this.destroy()},onPopupDestroy:function(){this.popupImageUploader=null;this.imageUploaderTextarea=null;this.imageUploaderFiles=[]}.bind(this)},buttons:[new BX.PopupWindowButton({text:BX.message("IM_UPLOAD_IMAGE_BUTTON_UPLOAD"),className:"popup-window-button-accept",events:{click:BX.delegate(function(){this.disk.uploadFromClipboard(this.imageUploaderFiles,this.imageUploaderTextarea.value);BX.proxy_context.popupWindow.close()},this)}}),new BX.PopupWindowButton({text:BX.message("IM_UPLOAD_IMAGE_BUTTON_CLOSE"),className:"popup-window-button",events:{click:function(){this.popupWindow.close()}}})],zIndex:BX.MessengerCommon.getDefaultZIndex()+200,titleBar:e,content:'<div class="im-messenger-image-uploader">'+'<div class="im-messenger-image-uploader-preview bx-messenger-custom-scroll">'+this.imageUploaderPreperaImageNode()+"</div>"+'<div class="im-messenger-image-uploader-textarea">'+'<textarea class="im-messenger-image-uploader-textarea-input" placeholder="'+BX.message("IM_UPLOAD_IMAGE_COMMENT")+'"></textarea>'+"</div>"+"</div>"});this.popupImageUploader.show();BX.addClass(this.popupImageUploader.popupContainer,"bx-messenger-mark");this.imageUploaderButtonUpload=BX.findChildByClassName(this.popupImageUploader.buttonsContainer,"popup-window-button-accept");if(this.imageUploaderButtonUpload&&this.imageUploaderButtonUpload.innerHTML==BX.message("IM_UPLOAD_IMAGE_BUTTON_UPLOAD")){this.imageUploaderButtonUpload.innerHTML=BX.message("IM_UPLOAD_IMAGE_BUTTON_UPLOAD")+" ("+(BX.browser.IsMac()?"&#8984;+Enter":"Ctrl+Enter")+")"}this.imageUploaderTextarea=BX.findChildByClassName(this.popupImageUploader.contentContainer,"im-messenger-image-uploader-textarea-input");this.imageUploaderTextarea.focus();BX.bind(this.imageUploaderTextarea,"keydown",function(e){if((e.metaKey==true||e.ctrlKey==true)&&(e.keyCode==13||e.keyCode==32)){this.disk.uploadFromClipboard(this.imageUploaderFiles,this.imageUploaderTextarea.value);this.popupImageUploader.close()}}.bind(this));if(this.imageUploaderFiles.length<=0){var t=BX.findChildByClassName(this.popupImageUploader.contentContainer,"im-messenger-image-uploader-preview");this.imageUploaderLoader=new BX.Loader({size:42});this.imageUploaderLoader.show(t)}return true};BX.MessengerChat.prototype.imageUploaderPreperaImageNode=function(){if(this.imageUploaderFiles.length<=0){return""}var e="";if(this.imageUploaderFiles.length==1){return'<div class="im-messenger-image-uploader-preview-box">'+'<img src="'+this.imageUploaderFiles[0].source+'" class="im-messenger-image-uploader-preview-image">'+"</div>"}else if(this.imageUploaderFiles.length==2){e="im-messenger-image-uploader-preview-group-box-twin"}else if(this.imageUploaderFiles.length==3){e="im-messenger-image-uploader-preview-group-box-one-line"}else if(this.imageUploaderFiles.length<=6){e="im-messenger-image-uploader-preview-group-box-two-line"}else{e="im-messenger-image-uploader-preview-group-box"}var t="";this.imageUploaderFiles.forEach(function(e){t+='<div class="im-messenger-image-uploader-preview-group-image">'+'<img src="'+e.source+'" class="im-messenger-image-uploader-preview-group-image-source">'+"</div>"});return'<div class="im-messenger-image-uploader-preview-box '+e+'">'+t+"</div>"};BX.MessengerChat.prototype.imageUploaderUpdateImage=function(){if(!this.popupImageUploader||this.imageUploaderFiles.length<=0){return false}var e=BX.findChildByClassName(this.popupImageUploader.contentContainer,"im-messenger-image-uploader-preview");if(!e){return false}if(this.imageUploaderLoader){this.imageUploaderLoader.destroy();this.imageUploaderLoader=null}e.innerHTML=this.imageUploaderPreperaImageNode();return true};BX.MessengerChat.prototype.insertQuoteMessage=function(e){var t=[];var s=true;var i="";var a="";var n=BX.findChildren(e.parentNode.nextSibling.firstChild,{tagName:"span"},false);for(var o=0;o<n.length;o++){var r=n[o].id.replace("im-message-","");if(this.message[r]){if(s){if(this.users[this.message[r].senderId]){i=this.users[this.message[r].senderId].name;a=this.message[r].date}s=false}var l=this.message[r].text.replace(/\[USER=([0-9]{1,})\](.*?)\[\/USER\]/gi,BX.delegate(function(e,t,s){return s},this));l=l.replace(/\[CHAT=(imol\|)?([0-9]{1,})\](.*?)\[\/CHAT\]/gi,BX.delegate(function(e,t,s,i){return i},this));l=l.replace(/\[RATING\=([1-5]{1})\]/gi,BX.delegate(function(e,t){return"["+BX.message("IM_F_RATING")+"] "},this));l=l.replace(/\[SEND(?:=(.+?))?\](.+?)?\[\/SEND\]/gi,BX.delegate(function(e,t,s){return s?s:t},this));l=l.replace(/\[PUT(?:=(.+?))?\](.+?)?\[\/PUT\]/gi,BX.delegate(function(e,t,s){return s?s:t},this));l=l.replace(/\[CALL(?:=(.+?))?\](.+?)?\[\/CALL\]/gi,BX.delegate(function(e,t,s){return s?s:t},this));l=l.replace(/\[ATTACH=([0-9]{1,})\]/gi,BX.delegate(function(e,t,s){return t==1e4?"":"["+BX.message("IM_F_ATTACH")+"] "},this));t.push(BX.MessengerCommon.prepareTextBack(l))}}this.insertQuoteText(i,a,t.join("\n"))};BX.MessengerChat.prototype.insertQuoteText=function(e,t,s,i){s=s.replace(/\[USER=([0-9]{1,})\](.*?)\[\/USER\]/gi,BX.delegate(function(e,t,s){return s},this));s=s.replace(/\[CHAT=(imol\|)?([0-9]{1,})\](.*?)\[\/CHAT\]/gi,BX.delegate(function(e,t,s,i){return i},this));s=s.replace(/\[SEND(?:=(.+?))?\](.+?)?\[\/SEND\]/gi,BX.delegate(function(e,t,s){return s?s:t},this));s=s.replace(/\[PUT(?:=(.+?))?\](.+?)?\[\/PUT\]/gi,BX.delegate(function(e,t,s){return s?s:t},this));s=s.replace(/\[CALL(?:=(.+?))?\](.+?)?\[\/CALL\]/gi,BX.delegate(function(e,t,s){return s?s:t},this));s=s.replace(/\[ATTACH=([0-9]{1,})\]/gi,BX.delegate(function(e,t,s){return t==1e4?"":"["+BX.message("IM_F_ATTACH")+"] "},this));s=s.replace(/\[RATING\=([1-5]{1})\]/gi,BX.delegate(function(e,t){return"["+BX.message("IM_F_RATING")+"] "},this));s=s.replace(/&nbsp;/gi," ");var a=[];a.push((this.popupMessengerTextarea&&this.popupMessengerTextarea.value.length>0?"\n":"")+this.historyMessageSplit);a.push(BX.util.htmlspecialcharsback(e)+" ["+BX.MessengerCommon.formatDate(t)+"]");a.push(s);a.push(this.historyMessageSplit+"\n");if(i!==false){this.insertTextareaText(this.popupMessengerTextarea,a.join("\n"),false);setTimeout(BX.delegate(function(){this.popupMessengerTextarea.scrollTop=this.popupMessengerTextarea.scrollHeight;this.popupMessengerTextarea.focus()},this),100)}else{return a.join("\n")}};BX.MessengerChat.prototype.insertTextareaText=function(e,t,s){if(!e&&opener.BXIM.messenger.popupMessengerTextarea)e=opener.BXIM.messenger.popupMessengerTextarea;if(e.selectionStart||e.selectionStart=="0"){var i=e.selectionStart;var a=e.selectionEnd;e.value=e.value.substring(0,i)+t+e.value.substring(a,e.value.length);s=s!=false;if(s){e.selectionStart=i+1;e.selectionEnd=i+1}else if(BX.browser.IsChrome()||BX.browser.IsSafari()||BX.MessengerCommon.isDesktop()){e.selectionStart=e.value.length+1;e.selectionEnd=e.value.length+1}}if(document.selection&&document.documentMode&&document.documentMode<=8){e.focus();var n=document.selection.createRange();n.text=t}};BX.MessengerChat.prototype.resizeTextareaStart=function(e){if(this.webrtc.callOverlayFullScreen)return false;if(!e)e=window.event;this.popupMessengerTextareaResize.wndSize=BX.GetWindowScrollPos();this.popupMessengerTextareaResize.pos=BX.pos(this.popupMessengerTextarea);this.popupMessengerTextareaResize.y=e.clientY+this.popupMessengerTextareaResize.wndSize.scrollTop;this.popupMessengerTextareaResize.textOffset=this.popupMessengerTextarea.offsetHeight;this.popupMessengerTextareaResize.bodyOffset=this.popupMessengerBody.offsetHeight;BX.bind(document,"mousemove",BX.proxy(this.resizeTextareaMove,this));BX.bind(document,"mouseup",BX.proxy(this.resizeTextareaStop,this));if(document.body.setCapture)document.body.setCapture();document.onmousedown=BX.False;var t=document.body;t.ondrag=t.onselectstart=BX.False;t.style.MozUserSelect="none";t.style.cursor="move";BX.onCustomEvent("onImResizeTextarea",[]);this.closeMenuPopup()};BX.MessengerChat.prototype.resizeTextareaMove=function(e){if(!e)e=window.event;var t=BX.GetWindowScrollPos();var s=e.clientX+t.scrollLeft;var i=e.clientY+t.scrollTop;if(this.popupMessengerTextareaResize.y==i)return;var a=Math.max(Math.min(-(i-this.popupMessengerTextareaResize.pos.top)+this.popupMessengerTextareaResize.textOffset,143),30);this.popupMessengerTextareaSize=a;this.popupMessengerTextarea.style.height=a+"px";this.popupMessengerBodySize=this.popupMessengerTextareaResize.textOffset-a+this.popupMessengerTextareaResize.bodyOffset;this.popupMessengerBody.style.height=this.popupMessengerBodySize+"px";this.popupMessengerBodyPanel.style.height=this.popupMessengerBodyDialog.offsetHeight+"px";this.resizeMainWindow();this.popupMessengerTextareaResize.x=s;this.popupMessengerTextareaResize.y=i};BX.MessengerChat.prototype.resizeTextareaStop=function(){if(document.body.releaseCapture)document.body.releaseCapture();BX.unbind(document,"mousemove",BX.proxy(this.resizeTextareaMove,this));BX.unbind(document,"mouseup",BX.proxy(this.resizeTextareaStop,this));document.onmousedown=null;this.popupMessengerBody.scrollTop=this.popupMessengerBody.scrollHeight-this.popupMessengerBody.offsetHeight;var e=document.body;e.ondrag=e.onselectstart=null;e.style.MozUserSelect="";e.style.cursor="";clearTimeout(this.BXIM.adjustSizeTimeout);this.BXIM.adjustSizeTimeout=setTimeout(BX.delegate(function(){this.BXIM.setLocalConfig("global_tas",this.popupMessengerTextareaSize);this.BXIM.setLocalConfig("global_msz_v2",{wz:this.popupMessengerFullWidth,ta2:this.popupMessengerTextareaSize,b:this.popupMessengerBodySize,cl:this.popupContactListSize,hi:this.popupHistoryItemsSize,fz:this.popupMessengerFullHeight,ez:this.popupContactListElementsSize,nz:this.notify.popupNotifySize,hf:this.popupHistoryFilterVisible,dw:window.innerWidth,dh:window.innerHeight,place:"taMove"})},this),500)};BX.MessengerChat.prototype.setTextareaSize=function(e){e=Math.max(Math.min(e,143),30);if(this.popupMessengerTextareaSize==e)return true;var t=e-this.popupMessengerTextareaSize;this.popupMessengerBodySize=this.popupMessengerBodySize+t*-1;if(this.popupMessengerBody){this.popupMessengerBody.style.height=this.popupMessengerBodySize+"px";this.popupMessengerBodyPanel.style.height=this.popupMessengerBodyDialog.offsetHeight+"px"}this.popupMessengerTextareaSize=e;if(this.popupMessengerTextarea){this.popupMessengerTextarea.style.height=e+"px"}return true};BX.MessengerChat.prototype.resizeWindowStart=function(){if(this.webrtc.callOverlayFullScreen)return false;if(this.popupMessengerTopLine)BX.remove(this.popupMessengerTopLine);this.popupMessengerWindow.pos=BX.pos(this.popupMessengerContent);this.popupMessengerWindow.mb=this.popupMessengerBodySize;this.popupMessengerWindow.nb=this.notify.popupNotifySize;BX.bind(document,"mousemove",BX.proxy(this.resizeWindowMove,this));BX.bind(document,"mouseup",BX.proxy(this.resizeWindowStop,this));if(document.body.setCapture)document.body.setCapture();document.onmousedown=BX.False;var e=document.body;e.ondrag=e.onselectstart=BX.False;e.style.MozUserSelect="none";e.style.cursor="move";this.closeMenuPopup();this.BXIM.autoHideDisable=true};BX.MessengerChat.prototype.resizeWindowMove=function(e){if(!e)e=window.event;var t=BX.GetWindowScrollPos();var s=e.clientX+t.scrollLeft;var i=e.clientY+t.scrollTop;this.popupMessengerFullHeight=Math.max(Math.min(i-this.popupMessengerWindow.pos.top,1e3),this.popupMessengerMinHeight);this.popupMessengerFullWidth=Math.max(Math.min(s-this.popupMessengerWindow.pos.left,1200),this.popupMessengerMinWidth);this.popupMessengerContent.style.height=this.popupMessengerFullHeight+"px";this.popupMessengerContent.style.width=this.popupMessengerFullWidth+"px";var a=this.popupMessengerFullHeight-Math.max(Math.min(this.popupMessengerWindow.pos.height,1e3),this.popupMessengerMinHeight);this.popupMessengerBodySize=this.popupMessengerWindow.mb+a;if(this.popupMessengerBody!=null)this.popupMessengerBody.style.height=this.popupMessengerBodySize+"px";if(this.popupMessengerBodyPanel!=null)this.popupMessengerBody.style.height=this.popupMessengerBodyDialog.offsetHeight+"px";if(this.popupMessengerExtra!=null)this.popupMessengerExtra.style.height=this.popupMessengerFullHeight+"px";this.notify.popupNotifySize=Math.max(this.popupMessengerWindow.nb+(this.popupMessengerBodySize-this.popupMessengerWindow.mb),this.notify.popupNotifySizeMin);if(this.notify.popupNotifyItem!=null)this.notify.popupNotifyItem.style.height=this.notify.popupNotifySize+"px";this.BXIM.messenger.redrawChatHeader();this.resizeMainWindow()};BX.MessengerChat.prototype.resizeWindowStop=function(){if(document.body.releaseCapture)document.body.releaseCapture();BX.unbind(document,"mousemove",BX.proxy(this.resizeWindowMove,this));BX.unbind(document,"mouseup",BX.proxy(this.resizeWindowStop,this));document.onmousedown=null;this.popupMessengerBody.scrollTop=this.popupMessengerBody.scrollHeight-this.popupMessengerBody.offsetHeight;var e=document.body;e.ondrag=e.onselectstart=null;e.style.MozUserSelect="";e.style.cursor="";clearTimeout(this.BXIM.adjustSizeTimeout);this.BXIM.adjustSizeTimeout=setTimeout(BX.delegate(function(){this.BXIM.setLocalConfig("global_msz_v2",{wz:this.popupMessengerFullWidth,ta2:this.popupMessengerTextareaSize,b:this.popupMessengerBodySize,cl:this.popupContactListSize,hi:this.popupHistoryItemsSize,fz:this.popupMessengerFullHeight,ez:this.popupContactListElementsSize,nz:this.notify.popupNotifySize,hf:this.popupHistoryFilterVisible,dw:window.innerWidth,dh:window.innerHeight,place:"winMove"});this.BXIM.autoHideDisable=false},this),500)};BX.MessengerChat.prototype.newMessage=function(e){e=e!=false;var t=[];var s=[];var i=0;var a={};var n=0;for(var o in this.flashMessage){var r=false;var l=false;if(this.BXIM.isFocus()&&this.popupMessenger!=null&&o==this.currentTab){r=true;n++}else if(o.toString().substr(0,4)=="chat"||this.users[o]&&this.users[o].extranet){if(this.muteButtonStatus(o)){l=true}}if(r||l){for(var p in this.flashMessage[o]){if(this.flashMessage[o][p]!==false){this.flashMessage[o][p]=false;i++}}continue}var h={};for(var p in this.flashMessage[o]){if(this.flashMessage[o][p]===false||h[o]){this.flashMessage[o][p]=false;continue}h[o]=true;var c=this.message[p].recipientId.toString().substr(0,4)=="chat";var u=this.message[p].recipientId;var d=!c&&this.message[p].senderId==0?o:this.message[p].senderId;if(c&&!this.chat[u.substr(4)]||!c&&!this.users[d]){continue}var m=c&&this.chat[u.substr(4)].type=="call";var g=c&&this.chat[u.substr(4)].type=="lines";var f=this.message[p].system=="Y";var B=BX.MessengerCommon.purifyText(this.message[p].text,this.message[p].params);if(o!=this.BXIM.userId){a[o]=c?this.chat[u.substr(4)].name:this.users[d].name}if(B.length>150){B=B.substr(0,150);var X=B.lastIndexOf(" ");if(X<140)B=B.substr(0,X)+"...";else B=B.substr(0,140)+"..."}if(B==""){if(this.message[p].params["FILE_ID"]&&this.message[p].params["FILE_ID"].length>0)B="["+BX.message("IM_F_FILE")+"]";else if(this.message[p].params["ATTACH"]&&this.message[p].params["ATTACH"].length>0)B="["+BX.message("IM_F_ATTACH")+"]"}if(c){var M=u.substr(4);var C=BX.MessengerCommon.isBlankAvatar(this.chat[M].avatar)?"background-color: "+this.chat[M].color:"";var I=3;if(m){I=4}else if(g){I=7}else if(this.generalChatId==M){I=6}else if(this.chat[u.substr(4)].type=="open"){I=5}}else{var C=BX.MessengerCommon.isBlankAvatar(this.users[d].avatar)?"background-color: "+this.users[d].color:""}var b=BX.create("div",{attrs:{"data-userId":c?u:d,"data-messageId":p},props:{className:"bx-notifier-item bx-notifier-item-"+p+" "},children:[BX.create("span",{props:{className:"bx-notifier-item-content"},children:[BX.create("span",{props:{className:"bx-notifier-item-avatar"},children:[BX.create("img",{props:{className:"bx-notifier-item-avatar-img"+(BX.MessengerCommon.isBlankAvatar(c?this.chat[u.substr(4)].avatar:this.users[d].avatar)?c?" bx-notifier-item-avatar-img-default-"+I:" bx-notifier-item-avatar-img-default":"")},attrs:{src:c?this.chat[u.substr(4)].avatar:this.users[d].avatar,style:C}})]}),BX.create("a",{attrs:{href:"#","data-messageId":p},props:{className:"bx-notifier-item-delete"}}),BX.create("span",{props:{className:"bx-notifier-item-date"},html:BX.MessengerCommon.formatDate(this.message[p].date)}),BX.create("span",{props:{className:"bx-notifier-item-name"},html:c?this.chat[u.substr(4)].name:this.users[d].name}),BX.create("span",{props:{className:"bx-notifier-item-text"},html:(c&&d>0?"<i>"+this.users[d].name+"</i>: ":"")+BX.MessengerCommon.prepareText(B,false,true)})]})]});if(!this.BXIM.xmppStatus||this.BXIM.xmppStatus&&c){t.push(b);B=BX.util.htmlspecialcharsback(B);B=B.split("<br />").join("\n");B=B.replace(/\[USER=([0-9]{1,})\](.*?)\[\/USER\]/gi,function(e,t,s){return s});B=B.replace(/\[CHAT=(imol\|)?([0-9]{1,})\](.*?)\[\/CHAT\]/gi,function(e,t,s,i){return i});B=B.replace(/\[PCH=([0-9]{1,})\](.*?)\[\/PCH\]/gi,function(e,t,s){return s});B=B.replace(/\[SEND(?:=(.+?))?\](.+?)?\[\/SEND\]/gi,function(e,t,s){return s?s:t});B=B.replace(/\[PUT(?:=(.+?))?\](.+?)?\[\/PUT\]/gi,function(e,t,s){return s?s:t});B=B.replace(/\[CALL(?:=(.+?))?\](.+?)?\[\/CALL\]/gi,function(e,t,s){return s?s:t});B=B.replace(/\[ATTACH=([0-9]{1,})\]/gi,function(e,t,s){return""});s.push({id:c?u:d,title:BX.util.htmlspecialcharsback(c?this.chat[u.substr(4)].name:this.users[d].name),text:(c&&d>0?this.users[d].name+": ":"")+B,icon:c?this.chat[u.substr(4)].avatar:this.users[d].avatar,tag:"im-messenger-"+(c?u:d)})}this.flashMessage[o][p]=false}}if(this.BXIM.context=="LINES"||this.BXIM.context=="DIALOG"){return false}if(BX.MessengerCommon.isSlider())return false;if(!BX.MessengerCommon.isDesktop()&&this.BXIM.desktopStatus)return false;if(t.length>5){var y="";for(var o in a)y+=", <i>"+a[o]+"</i>";var x={id:0,type:4,date:new Date,title:BX.message("IM_NM_MESSAGE_1").replace("#COUNT#",t.length),text:BX.message("IM_NM_MESSAGE_2").replace("#USERS#",y.substr(2))};t=[];t.push(this.notify.createNotify(x,true));s=[];s.push({id:"",title:BX.message("IM_NM_MESSAGE_1").replace("#COUNT#",t.length),text:BX.message("IM_NM_MESSAGE_2").replace("#USERS#",BX.util.htmlspecialcharsback(y.substr(2))).replace(/<\/?[^>]+>/gi,"")})}else if(t.length==0){if(n>0&&BX.MessengerCommon.isDesktop())BX.desktop.flashIcon();if(e&&n>0&&this.BXIM.settings.status!="dnd"){this.BXIM.playSound("newMessage2")}return false}if(BX.MessengerCommon.isDesktop())BX.desktop.flashIcon();if(BX.MessengerCommon.isDesktop()){if(!document.hasFocus()&&BX.desktop.getLocalConfig("nativeNotify",false)&&BX.browser.IsMac()){for(var o=0;o<s.length;o++){var v=s[o].title;var T=s[o].text;var S="";if(s[o].icon){S=s[o].icon.toString().startsWith("http")?s[o].icon:location.origin+"/"+s[o].icon}if(BX.MessengerCommon.isBlankAvatar(S)){S=""}BXDesktopSystem.Notify(v,"",T,encodeURI(S))}}else{for(var o=0;o<t.length;o++){var _=t[o].getAttribute("data-messageId");var E='var notify = BX.findChildByClassName(document.body, "bx-notifier-item");'+'notify.style.cursor = "pointer";'+'BX.bind(notify, "click", function(){BX.desktop.onCustomEvent("main", "bxImClickNewMessage", [notify.getAttribute("data-userId")]); BX.desktop.windowCommand("close")});'+'BX.bind(BX.findChildByClassName(notify, "bx-notifier-item-delete"), "click", function(event){ /*BX.desktop.onCustomEvent("main", "bxImClickCloseMessage", [notify.getAttribute("data-userId")]);*/ BX.desktop.windowCommand("close"); BX.MessengerCommon.preventDefault(event); });'+'BX.bind(notify, "contextmenu", function(){ BX.desktop.windowCommand("close")});';this.desktop.openNewMessage(_,t[o],E)}}}else if(e&&!this.BXIM.windowFocus&&this.BXIM.notifyManager.nativeNotifyGranted()){for(var o=0;o<s.length;o++){var x=s[o];x.onshow=function(){var e=this;setTimeout(function(){e.close()},5e3)};x.onclick=function(){window.focus();top.BXIM.openMessenger(x.id);this.close()};this.BXIM.notifyManager.nativeNotify(x)}}else{if(this.BXIM.windowFocus&&this.BXIM.notifyManager.nativeNotifyGranted()){BX.localStorage.set("mnnb",true,1)}for(var o=0;o<t.length;o++){this.BXIM.notifyManager.add({html:t[o],tag:"im-message-"+t[o].getAttribute("data-userId"),userId:t[o].getAttribute("data-userId"),click:BX.delegate(function(e){this.openMessenger(e.notifyParams.userId);e.close()},this),close:BX.delegate(function(e){e.close()},this)})}}if(BX.MessengerCommon.isDesktop())BX.desktop.flashIcon();if(e){this.BXIM.playSound("newMessage1")}};BX.MessengerChat.prototype.showNotifyBlock=function(e){var t=e.recipientId.toString().substr(0,4)=="chat";var s=e.recipientId;var a=t&&this.chat[s.substr(4)]&&this.chat[s.substr(4)].type=="call";var n=t&&this.chat[s.substr(4)]&&this.chat[s.substr(4)].type=="lines";var o=!t&&e.senderId==0?i:e.senderId;var r=e.text_mobile?e.text_mobile:e.text;if(!e.id)e.id="custom-"+ +new Date;if(e.date)e.date=new Date;r=r.replace(/------------------------------------------------------(.*?)------------------------------------------------------/gim,"["+BX.message("IM_M_QUOTE_BLOCK")+"]");if(r.length>150){r=r.substr(0,150);var l=r.lastIndexOf(" ");if(l<140)r=r.substr(0,l)+"...";else r=r.substr(0,140)+"..."}if(r==""&&e.params["FILE_ID"].length>0){r="["+BX.message("IM_F_FILE")+"]"}if(t){var p=s.substr(4);var h=BX.MessengerCommon.isBlankAvatar(this.chat[p].avatar)?"background-color: "+this.chat[p].color:"";var c=3;if(a){c=4}else if(n){c=7}else if(this.generalChatId==p){c=6}else if(this.chat[s.substr(4)].type=="open"){c=5}}else{var h=BX.MessengerCommon.isBlankAvatar(this.users[o].avatar)?"background-color: "+this.users[o].color:""}var u=BX.create("div",{attrs:{"data-userId":t?s:o,"data-messageId":e.id},props:{className:"bx-notifier-item bx-notifier-item-"+e.id+" "},children:[BX.create("span",{props:{className:"bx-notifier-item-content"},children:[BX.create("span",{props:{className:"bx-notifier-item-avatar"},children:[BX.create("img",{props:{className:"bx-notifier-item-avatar-img"+(BX.MessengerCommon.isBlankAvatar(t?this.chat[s.substr(4)].avatar:this.users[o].avatar)?t?" bx-notifier-item-avatar-img-default-"+c:" bx-notifier-item-avatar-img-default":"")},attrs:{src:t?this.chat[s.substr(4)].avatar:this.users[o].avatar,style:h}})]}),BX.create("a",{attrs:{href:"#","data-messageId":e.id},props:{className:"bx-notifier-item-delete"}}),e.date?BX.create("span",{props:{className:"bx-notifier-item-date"},html:BX.MessengerCommon.formatDate(e.date)}):BX.create("span"),BX.create("span",{props:{className:"bx-notifier-item-name"},html:t?this.chat[s.substr(4)].name:this.users[o].name}),BX.create("span",{props:{className:"bx-notifier-item-text"},html:(t&&o>0?"<i>"+this.users[o].name+"</i>: ":"")+BX.MessengerCommon.prepareText(r,false,true)})]})]});if(!this.BXIM.xmppStatus||this.BXIM.xmppStatus&&t){r=BX.util.htmlspecialcharsback(r);r=r.split("<br />").join("\n");r=r.replace(/\[USER=([0-9]{1,})\](.*?)\[\/USER\]/gi,function(e,t,s){return s});r=r.replace(/\[CHAT=(imol\|)?([0-9]{1,})\](.*?)\[\/CHAT\]/gi,function(e,t,s,i){return i});r=r.replace(/\[PCH=([0-9]{1,})\](.*?)\[\/PCH\]/gi,function(e,t,s){return s});r=r.replace(/\[SEND(?:=(.+?))?\](.+?)?\[\/SEND\]/gi,function(e,t,s){return s?s:t});r=r.replace(/\[PUT(?:=(.+?))?\](.+?)?\[\/PUT\]/gi,function(e,t,s){return s?s:t});r=r.replace(/\[CALL(?:=(.+?))?\](.+?)?\[\/CALL\]/gi,function(e,t,s){return s?s:t});r=r.replace(/\[ATTACH=([0-9]{1,})\]/gi,function(e,t,s){return""});notifyTextObject={id:t?s:o,title:BX.util.htmlspecialcharsback(t?this.chat[s.substr(4)].name:this.users[o].name),text:(t&&o>0?this.users[o].name+": ":"")+r,icon:t?this.chat[s.substr(4)].avatar:this.users[o].avatar,tag:"im-messenger-"+(t?s:o)}}else{return false}if(!(!BX.MessengerCommon.isDesktop()&&BX.MessengerCommon.isPage())&&!BX.MessengerCommon.isDesktop()&&this.BXIM.desktopStatus)return false;if(BX.MessengerCommon.isDesktop()){var d='var notify = BX.findChildByClassName(document.body, "bx-notifier-item");'+'notify.style.cursor = "pointer";'+'BX.bind(notify, "click", function(){BX.desktop.onCustomEvent("main", "bxImClickNewMessage", [notify.getAttribute("data-userId")]); BX.desktop.windowCommand("close")});'+'BX.bind(BX.findChildByClassName(notify, "bx-notifier-item-delete"), "click", function(event){ /*BX.desktop.onCustomEvent("main", "bxImClickCloseMessage", [notify.getAttribute("data-userId")]);*/ BX.desktop.windowCommand("close"); BX.MessengerCommon.preventDefault(event); });'+'BX.bind(notify, "contextmenu", function(){ BX.desktop.windowCommand("close")});';this.desktop.openNewMessage(u.getAttribute("data-messageId"),u,d)}else if(!this.BXIM.windowFocus&&this.BXIM.notifyManager.nativeNotifyGranted()){var m=notifyTextObject;m.onshow=function(){var e=this;setTimeout(function(){e.close()},5e3)};m.onclick=function(){window.focus();top.BXIM.openMessenger(m.id);this.close()};this.BXIM.notifyManager.nativeNotify(m)}else{this.BXIM.notifyManager.add({html:u,tag:"im-message-"+u.getAttribute("data-userId"),userId:u.getAttribute("data-userId"),click:BX.delegate(function(e){this.openMessenger(e.notifyParams.userId);e.close()},this),close:BX.delegate(function(e){BX.MessengerCommon.readMessage(e.notifyParams.userId)},this)})}return true};BX.MessengerChat.prototype.updateMessageCount=function(e){e=e!=false;var t=0;var s=0;var i=0;for(var a in this.unreadMessage){if(!this.unreadMessage[a])continue;if(a.toString().substr(0,4)=="chat"){s=a.toString().substr(4);if(this.chat[s]&&this.chat[s].entity_type=="LINES"&&this.BXIM.settings.linesTabEnable&&BX.MessengerCommon.isLinesOperator()){i=i+this.unreadMessage[a].length}else if(!this.userChatBlockStatus[s]||!this.userChatBlockStatus[s][this.BXIM.userId]){t=t+this.unreadMessage[a].length}}else{t=t+this.unreadMessage[a].length}}if(e)BX.localStorage.set("mumc",{unread:this.unreadMessage,flash:this.flashMessage},5);if(this.messageCount!=t)BX.onCustomEvent(window,"onImUpdateCounterMessage",[t,"MESSAGE"]);this.messageCount=t;if(this.BXIM.linesCount!=i)BX.onCustomEvent(window,"onImUpdateCounterMessage",[i,"LINES"]);this.BXIM.linesCount=i;var n="";if(this.messageCount>99)n="99+";else if(this.messageCount>0)n=this.messageCount;if(this.notify.panelButtonMessageCount){this.notify.panelButtonMessageCount.innerHTML=n;this.notify.adjustPosition({resize:true,timeout:500})}if(BX.MessengerCommon.isPage()){BX.MessengerWindow.setTabBadge("im",t);BX.MessengerWindow.setTabBadge("im-ol",i)}this.BXIM.messageCount=this.messageCount;return this.messageCount};BX.MessengerChat.prototype.setStatus=function(e,t){t=t!=false;if(!e)return false;e=e.toLowerCase();this.users[this.BXIM.userId].status=e;this.BXIM.updateCounter();if(this.contactListPanelStatus!=null&&!BX.hasClass(this.contactListPanelStatus,"bx-messenger-cl-panel-status-"+e)){this.contactListPanelStatus.className="bx-messenger-cl-panel-status-wrap bx-messenger-cl-panel-status-"+e;var s=BX.findChildByClassName(this.contactListPanelStatus,"bx-messenger-cl-panel-status-text");e=e=="birthday"?"online":e;s.innerHTML=BX.message("IM_STATUS_"+e.toUpperCase());if(t){this.BXIM.saveSettings({status:e});BX.onCustomEvent(this,"onStatusChange",[e]);BX.localStorage.set("mms",e,5)}}if(BX.MessengerCommon.isDesktop())BX.desktop.setIconStatus(e)};BX.MessengerChat.prototype.resizeMainWindow=function(){if(BX.MessengerCommon.isPage())return false;if(this.popupMessengerExtra.style.display=="block")this.popupContactListElementsSize=this.popupMessengerExtra.offsetHeight-120;else this.popupContactListElementsSize=this.popupMessengerDialog.offsetHeight-120;this.popupContactListElements.style.height=this.popupContactListElementsSize+"px"};BX.MessengerChat.prototype.showTopLine=function(e,t,s){if(typeof e!="string")return false;if(typeof s!="function"){s=BX.delegate(function(){this.hideTopLine()},this)}var i=[];i.push(BX.create("span",{props:{className:"bx-messenger-box-topline-close"},events:{click:s}}));if(typeof t=="object"){var a=[];for(var n=0;n<t.length;n++){a.push(BX.create("span",{props:{className:"bx-messenger-box-topline-button"},html:t[n].title,events:{click:t[n].callback}}))}i.push(BX.create("span",{props:{className:"bx-messenger-box-topline-buttons"},children:a}))}i.push(BX.create("span",{props:{className:"bx-messenger-box-topline-text"},children:[BX.create("span",{props:{className:"bx-messenger-box-topline-text-inner"},html:e})]}));this.popupMessengerTopLine.innerHTML="";BX.adjust(this.popupMessengerTopLine,{children:i});BX.addClass(this.popupMessengerTopLine,"bx-messenger-box-topline-show");return true};BX.MessengerChat.prototype.hideTopLine=function(e){BX.removeClass(this.popupMessengerTopLine,"bx-messenger-box-topline-show");if(e!==false);{BX.localStorage.set("mhtl",true,1)}};BX.MessengerChat.prototype.closeMenuPopup=function(){if(this.popupPopupMenu!=null&&this.popupPopupMenuDateCreate+100<+new Date)this.popupPopupMenu.close();if(this.popupSmileMenu!=null)this.popupSmileMenu.close();if(this.notify.popupNotifyMore!=null)this.notify.popupNotifyMore.destroy();if(this.popupChatUsers!=null)this.popupChatUsers.close();if(this.webrtc.popupKeyPad!=null)this.webrtc.popupKeyPad.destroy();if(this.popupChatDialog!=null)this.popupChatDialog.destroy();if(this.popupTransferDialog!=null)this.popupTransferDialog.destroy();if(this.popupTooltip!=null)this.popupTooltip.destroy();if(this.commandPopup!=null)this.commandPopup.close();if(this.popupIframeMenu!=null&&this.popupIframeBind)this.popupIframeMenu.destroy();if(this.videoConfCreateLinkPopup!=null){this.videoConfCreateLinkPopup.close()}if(window.obCrm&&window.obCrm.olCrmSelector&&window.obCrm.olCrmSelector.popup)window.obCrm.olCrmSelector.popup.close();this.closePopupFileMenu()};BX.MessengerChat.MenuPrepareList=function(e){var t=[];for(var s=0;s<e.length;s++){var i=e[s];if(i==null)continue;if(!i.separator&&(!i.text||!BX.type.isNotEmptyString(i.text)))continue;if(i.separator){t.push(BX.create("div",{props:{className:"bx-messenger-menu-hr"}}))}else if(i.type=="call"){var a=BX.create("a",{props:{className:"bx-messenger-popup-menu-item"},attrs:{title:i.title?i.title:"",href:i.href?i.href:"",target:i.target?i.target:"_blank","data-params":i.dataParams?JSON.stringify(i.dataParams):""},events:i.onclick&&BX.type.isFunction(i.onclick)?{click:i.onclick}:null,html:'<div class="bx-messenger-popup-menu-item-call"><span class="bx-messenger-popup-menu-item-left"></span><span class="bx-messenger-popup-menu-item-title">'+i.text+'</span><span class="bx-messenger-popup-menu-right"></span></div>'+'<div><span class="bx-messenger-popup-menu-item-left"></span><span class="bx-messenger-popup-menu-item-text">'+i.phone+'</span><span class="bx-messenger-popup-menu-right"></span></div>'});if(i.href)a.href=i.href;t.push(a)}else{var n=i.attrs?i.attrs:{};n.title=i.title?i.title:"";n.href=i.href?i.href:"";n.target=i.target?i.target:n.href.startsWith("http")?"_blank":"";n["data-params"]=i.dataParams?JSON.stringify(i.dataParams):"";var a=BX.create("a",{props:{className:"bx-messenger-popup-menu-item"+(i.bold?" bx-messenger-popup-menu-item-bold":"")+(i.slim?" bx-messenger-popup-menu-item-slim":"")+(i.disabled?" bx-messenger-popup-menu-item-disabled":"")+(i.restricted?" bx-messenger-popup-menu-item-restricted":"")+(BX.type.isNotEmptyString(i.className)?" "+i.className:"")},attrs:n,events:i.onclick&&BX.type.isFunction(i.onclick)?{click:i.onclick}:null,html:'<span class="bx-messenger-popup-menu-item-left"></span>'+(i.icon?'<span class="bx-messenger-popup-menu-item-icon '+i.icon+'"></span>':"")+(i.restricted?'<span class="tariff-lock"></span>':"")+'<span class="bx-messenger-popup-menu-item-text">'+i.text+'</span><span class="bx-messenger-popup-menu-right"></span>'});if(i.href)a.href=i.href;t.push(a)}}return t};BX.MessengerChat.prototype.storageSet=function(e){if(e.key=="ims"){if(this.BXIM.settings.viewOffline!=e.value.viewOffline||this.BXIM.settings.viewGroup!=e.value.viewGroup)BX.MessengerCommon.userListRedraw(true);if(this.BXIM.settings.sendByEnter!=e.value.sendByEnter&&this.popupMessengerTextareaSendType)this.popupMessengerTextareaSendType.innerHTML=this.BXIM.settings.sendByEnter?"Enter":BX.browser.IsMac()?"&#8984;+Enter":"Ctrl+Enter";if(this.BXIM.settings.sendByEnter!=e.value.sendByEnter&&this.popupMessengerTextareaSendType)this.popupMessengerTextareaSendType.innerHTML=this.BXIM.settings.sendByEnter?"Enter":BX.browser.IsMac()?"&#8984;+Enter":"Ctrl+Enter";BX.MessengerCommon.drawTab(this.currentTab,true);this.BXIM.settings=e.value}else if(e.key=="mus"){this.updateState(true,false)}else if(e.key=="musl"){this.updateStateLight(true,false)}else if(e.key=="mms"){this.setStatus(e.value,false)}else if(e.key=="mhtl"){this.hideTopLine(false)}else if(e.key=="mct"){}else if(e.key=="mrlr"){BX.MessengerCommon.recentListHide(e.value.userId,false)}else if(e.key=="mrd"){this.BXIM.settings.viewGroup=e.value.viewGroup;this.BXIM.settings.viewOffline=e.value.viewOffline;BX.MessengerCommon.userListRedraw()}else if(e.key=="mrm"){BX.MessengerCommon.readMessage(e.value,false,false)}else if(e.key=="mcl"){BX.MessengerCommon.leaveFromChat(e.value,false)}else if(e.key=="mclk"){this.kickFromChat(e.value.chatId,e.value.userId)}else if(e.key=="mes"){this.BXIM.settings.enableSound=e.value}else if(e.key=="mti"){if(e.value>this.messageTmpIndex)this.messageTmpIndex=e.value}else if(e.key=="mns"){if(this.popupContactListSearchInput!=null)this.popupContactListSearchInput.value=e.value!=null?e.value+"":"";this.contactListSearchText=e.value!=null?e.value+"":""}else if(e.key=="msm"){if(this.message[e.value.id])return;e.value.date=new Date(e.value.date);this.message[e.value.id]=e.value;if(this.history[e.value.recipientId])this.history[e.value.recipientId].push(e.value.id);else this.history[e.value.recipientId]=[e.value.id];if(this.showMessage[e.value.recipientId])this.showMessage[e.value.recipientId].push(e.value.id);else this.showMessage[e.value.recipientId]=[e.value.id];BX.MessengerCommon.updateStateVar(e.value,false,false);BX.MessengerCommon.drawTab(e.value.recipientId,true)}else if(e.key=="uss"){this.updateStateStep=parseInt(e.value)}else if(e.key=="mumc"){setTimeout(BX.delegate(function(){var t=false;if(this.popupMessenger!=null&&this.BXIM.isFocus()){delete e.value.unread[this.currentTab];t=true}this.unreadMessage=e.value.unread;this.flashMessage=e.value.flash;this.updateMessageCount(t)},this),500)}else if(e.key=="mum"){e.value.message.date=new Date(e.value.message.date);this.message[e.value.message.id]=e.value.message;if(this.showMessage[e.value.userId]){this.showMessage[e.value.userId].push(e.value.message.id);this.showMessage[e.value.userId]=BX.util.array_unique(this.showMessage[e.value.userId])}else this.showMessage[e.value.userId]=[e.value.message.id];BX.MessengerCommon.drawMessage(e.value.userId,e.value.message,this.currentTab==e.value.userId)}else if(e.key=="muum"){BX.MessengerCommon.changeUnreadMessage(e.value,false)}else if(e.key=="mcam"&&!this.BXIM.ppServerStatus){if(this.popupMessenger!=null&&!this.BXIM.callController.hasActiveCall())this.popupMessenger.close()}};BX.MessengerChat.prototype.linesVoteHeadDialog=function(e,t,s){s=s||false;var i=e.getAttribute("data-rating")||0;var a=BX.MessengerCommon.linesVoteHeadNodes(t,i,true,s?null:e);if(s)return a;this.tooltip(e,a,{offsetTop:10,offsetLeft:12,bindOptions:{position:"bottom"}});return true};BX.MessengerChat.prototype.linesVoteAndCommentHeadDialog=function(e,t,s,i){if(!s){s=null}if(!i){i=null}if(this.linesCommentHeadAdd)this.linesCommentHeadAdd(s,i,e);return true};BX.MessengerChat.prototype.linesOpenHistory=function(e){BX.MessengerCommon.linesGetSessionHistory(e)};BX.MessengerChat.prototype.linesShowHistory=function(e,t){if(this.popupMessengerConnectionStatusState!="online")return false;if(this.historyWindowBlock)return false;if(this.popupHistory!=null)this.popupHistory.destroy();if(!e)return false;var s=this.BXIM.disk.enable;s=false;this.popupHistoryPanel=null;var i=this.redrawHistoryPanel("chat"+e,e,{drawLinesJoin:t.CAN_JOIN,drawLinesVote:t.CAN_VOTE_HEAD,sessionVoteHead:t.SESSION_VOTE_HEAD,sessionCommentHead:t.SESSION_COMMENT_HEAD,sessionId:t.SESSION_ID});this.popupHistoryElements=BX.create("div",{props:{className:"bx-messenger-history"+(s?" bx-messenger-history-with-disk":"")+(BX.browser.IsMac()?"":" bx-messenger-custom-scroll")},children:[this.popupHistoryPanel=BX.create("div",{props:{className:"bx-messenger-panel-wrap"},children:i}),BX.create("div",{props:{className:"bx-messenger-history-types"},children:[BX.create("span",{props:{className:"bx-messenger-history-type bx-messenger-history-type-message"},children:[this.popupHistoryItems=BX.create("div",{props:{className:"bx-messenger-history-items"},style:{height:this.popupHistoryItemsSize+"px"},children:[this.popupHistoryBodyWrap=BX.create("div",{props:{className:"bx-messenger-history-items-wrap"}})]})]}),BX.create("span",{props:{className:"bx-messenger-history-type bx-messenger-history-type-disk"},children:[this.popupHistoryFilesItems=BX.create("div",{props:{className:"bx-messenger-history-items"},style:{height:this.popupHistoryItemsSize+"px"},children:[this.popupHistoryFilesBodyWrap=BX.create("div",{props:{className:"bx-messenger-history-items-wrap"}})]})]})]})]});this.popupHistory=new BX.PopupWindow("bx-messenger-popup-history",null,{darkMode:this.BXIM.settings.enableDarkTheme,autoHide:false,zIndex:BX.MessengerCommon.getDefaultZIndex()+200,draggable:{restrict:true},closeByEsc:true,events:{onPopupClose:function(){this.destroy()},onPopupDestroy:BX.delegate(function(){this.popupHistory=null;this.historySearch="";this.setClosingByEsc(true);this.closeMenuPopup();var e=BX.calendar.get();if(e){e.Close()}},this)},titleBar:{content:BX.create("span",{props:{className:"bx-messenger-title"},html:BX.message("IM_M_HISTORY")})},closeIcon:{right:"13px"},content:this.popupHistoryElements,contentColor:"white",noAllPaddings:true});BX.addClass(this.popupHistory.popupContainer,"bx-messenger-mark");this.popupHistory.show();BX.bind(this.popupHistory.popupContainer,"click",BX.MessengerCommon.preventDefault);if(t.HISTORY["chat"+e]){t.HISTORY["chat"+e].sort(BX.delegate(function(e,t){e=parseInt(e);t=parseInt(t);if(e>t){return 1}else if(e<t){return-1}else{return 0}},this))}this.drawHistory("chat"+e,t.HISTORY,false,false);if(s){this.drawHistoryFiles(e,t.FILES,false)}BX.bindDelegate(this.popupHistoryElements,"click",{className:"bx-messenger-ajax"},BX.delegate(function(){if(BX.proxy_context.getAttribute("data-entity")=="user"){this.openPopupExternalData(BX.proxy_context,"user",true,{ID:BX.proxy_context.getAttribute("data-userId")})}else if(BX.proxy_context.getAttribute("data-entity")=="chat"){this.openPopupExternalData(BX.proxy_context,"chat",true,{ID:BX.proxy_context.getAttribute("data-chatId")})}else if(BX.proxy_context.getAttribute("data-entity")=="openlines"){this.linesOpenHistory(BX.proxy_context.getAttribute("data-sessionId"))}else if(BX.proxy_context.getAttribute("data-entity")=="network"){this.openMessenger("network"+BX.proxy_context.getAttribute("data-networkId"))}else if(BX.proxy_context.getAttribute("data-entity")=="date"){this.openPopupMenu(BX.proxy_context,"shareMenu")}else if(BX.proxy_context.getAttribute("data-entity")=="phoneCallHistory"){this.openPopupExternalData(BX.proxy_context,"phoneCallHistory",true,{ID:BX.proxy_context.getAttribute("data-historyID")})}},this));if(this.disk.enable){BX.bindDelegate(this.popupHistoryFilesBodyWrap,"click",{className:"bx-messenger-file-menu"},BX.delegate(function(e){var t=BX.proxy_context.parentNode.parentNode.getAttribute("data-fileId");var s=BX.proxy_context.parentNode.parentNode.getAttribute("data-chatId");this.openPopupMenu(BX.proxy_context,"historyFileMenu",true,{fileId:t,chatId:s});return BX.PreventDefault(e)},this))}};BX.MessengerChat.prototype.linesLivechatFormShow=function(e,t,s){return false};BX.MessengerChat.prototype.linesLivechatFormHide=function(){return this.linesLivechatFormShow()};BX.MessengerChat.prototype.linesOpenMessenger=function(e,t){t=t||{};BX.MessengerCommon.linesOpenSession(e,t)};BX.MessengerChat.prototype.linesCreateLead=function(){var e=this.getChatId();var t=BX.MessengerCommon.linesGetSession(this.chat[e]);if(t.crm=="N"){BX.MessengerCommon.linesCreateLead(e)}};BX.MessengerChat.prototype.linesCloseDialog=function(){var e=this.getChatId();BX.MessengerCommon.linesCloseDialog(e)};BX.MessengerChat.prototype.linesMarkAsSpam=function(){var e=this.getChatId();BX.MessengerCommon.linesMarkAsSpam(e)};BX.MessengerChat.prototype.linesInterceptSession=function(){var e=this.getChatId();BX.MessengerCommon.linesInterceptSession(e)};BX.MessengerChat.prototype.linesTogglePinMode=function(){var e=this.getChatId();var t;var s=BX.MessengerCommon.linesGetSession(this.chat[e]);if(s.pin=="Y"){t="N"}else{t="Y"}BX.MessengerCommon.linesActivatePinMode(e,t)};BX.MessengerChat.prototype.linesToggleSilentMode=function(){var e=this.getChatId();var t;if(this.linesSilentMode[e]){BX.removeClass(this.popupMessengerHiddenModeButton,"bx-messenger-textarea-hidden-active");t="N"}else{BX.addClass(this.popupMessengerHiddenModeButton,"bx-messenger-textarea-hidden-active");t="Y"}this.linesSilentMode[e]=t=="Y";this.tooltip(this.popupMessengerHiddenModeButton,BX.message(t=="Y"?"IM_OL_CHAT_STEALTH_ON":"IM_OL_CHAT_STEALTH_OFF"),{offsetLeft:15,showOnce:t=="Y"?"OL_STEALTH_ON":"OL_STEALTH_OFF"})};BX.MessengerChat.prototype.linesOpenTransferDialog=function(e){if(this.BXIM.messenger.popupMessengerDialog&&BX.hasClass(this.BXIM.messenger.popupMessengerDialog,"bx-messenger-chat-load-last-message")){return false}if(this.popupTransferDialog!=null){this.popupTransferDialog.close();return false}if(this.popupChatDialog!=null){this.popupChatDialog.close();return false}BX.MessengerCommon.contactListSearchClear();this.linesTransferUser=0;var t=e.bind?e.bind:null;e.maxUsers=1;this.popupTransferDialog=new BX.PopupWindow("bx-messenger-popup-transfer",t,{darkMode:this.BXIM.settings.enableDarkTheme,lightShadow:true,offsetTop:5,offsetLeft:BX.MessengerCommon.isPage()?5:-162,autoHide:true,buttons:[new BX.PopupWindowButton({text:BX.message("IM_OL_INVITE_TRANSFER"),className:"popup-window-button-accept",events:{click:BX.delegate(function(){var e=this.getChatId();this.linesSendTransfer(e)},this)}}),new BX.PopupWindowButton({text:BX.message("IM_M_CHAT_BTN_CANCEL"),events:{click:BX.delegate(function(){this.popupTransferDialog.close()},this)}})],closeByEsc:true,zIndex:BX.MessengerCommon.getDefaultZIndex()+200,events:{onPopupClose:function(){this.destroy()},onPopupDestroy:BX.delegate(function(){this.popupTransferDialog=null;this.popupTransferDialogContactListElements=null},this)},content:BX.create("div",{props:{className:"bx-messenger-popup-newchat-wrap"},children:[BX.create("div",{props:{className:"bx-messenger-popup-newchat-caption"},html:BX.message("IM_OL_TRANSFER_TEXT")}),BX.create("div",{props:{className:"bx-messenger-popup-newchat-box bx-messenger-popup-newchat-dest bx-messenger-popup-newchat-dest-even"},children:[this.popupTransferDialogDestElements=BX.create("span",{props:{className:"bx-messenger-dest-items"}}),this.popupTransferDialogContactListSearch=BX.create("input",{props:{className:"bx-messenger-input"},attrs:{type:"text",placeholder:BX.message(this.BXIM.bitrixIntranet?"IM_M_SEARCH_PLACEHOLDER_CP":"IM_M_SEARCH_PLACEHOLDER"),value:""}})]}),this.popupTransferDialogContactListElements=BX.create("div",{props:{className:"bx-messenger-popup-newchat-box bx-messenger-popup-newchat-cl bx-messenger-recent-wrap"},children:[]})]})});BX.MessengerCommon.contactListPrepareSearch("popupTransferDialogContactListElements",this.popupTransferDialogContactListElements,this.popupTransferDialogContactListSearch.value,{viewChat:false,viewOpenChat:false,viewOffline:false,viewBot:false,viewTransferOlQueue:true,viewOnlyIntranet:true,viewOfflineWithPhones:false});BX.bindDelegate(this.popupTransferDialogContactListElements,"click",{className:"bx-messenger-chatlist-more"},BX.delegate(this.toggleChatListGroup,this));if(!this.BXIM.settings.enableDarkTheme)this.popupTransferDialog.setAngle({offset:BX.MessengerCommon.isPage()?32:198});this.popupTransferDialog.show();this.popupTransferDialogContactListSearch.focus();BX.addClass(this.popupTransferDialog.popupContainer,"bx-messenger-mark");BX.bind(this.popupTransferDialog.popupContainer,"click",BX.PreventDefault);BX.bind(this.popupTransferDialogContactListSearch,"keyup",BX.delegate(function(t){if(t.keyCode==16||t.keyCode==17||t.keyCode==18||t.keyCode==20||t.keyCode==244||t.keyCode==224||t.keyCode==91)return false;if(t.keyCode==27&&this.popupTransferDialogContactListSearch.value!="")BX.MessengerCommon.preventDefault(t);if(t.keyCode==27){this.popupTransferDialogContactListSearch.value=""}if(t.keyCode==8){var s=null;var i=BX.util.objectSort(this.popupChatDialogUsers,"date","asc");for(var a=0;a<i.length;a++){s=i[a].id}if(s){delete this.popupChatDialogUsers[s];this.linesRedrawTransferDialogDest()}}if(t.keyCode==13){this.popupTransferDialogContactListSearch.value="";var n=BX.findChildByClassName(this.popupTransferDialogContactListElements,"bx-messenger-cl-item");if(n){if(this.popupTransferDialogContactListSearch.value!=""){this.popupTransferDialogContactListSearch.value=""}if(this.linesTransferUser>0){e.maxUsers=e.maxUsers+1;if(e.maxUsers>0)BX.show(this.popupTransferDialogContactListSearch);this.linesTransferUser=0}else{if(e.maxUsers>0){var o=n.getAttribute("data-userId").toString();if(o.startsWith("queue")&&!this.BXIM.messenger.openlines.canTransferToLine){BX.UI.InfoHelper.show("limit_contact_center_ol_chat_transfer");return false}e.maxUsers=e.maxUsers-1;if(e.maxUsers<=0)BX.hide(this.popupTransferDialogContactListSearch);this.linesTransferUser=o}}this.linesRedrawTransferDialogDest()}}BX.MessengerCommon.contactListPrepareSearch("popupTransferDialogContactListElements",this.popupTransferDialogContactListElements,this.popupTransferDialogContactListSearch.value,{viewChat:false,viewOpenChat:false,viewOffline:false,viewBot:false,viewTransferOlQueue:true,viewOnlyIntranet:true,viewOfflineWithPhones:false,timeout:100})},this));BX.bindDelegate(this.popupTransferDialogDestElements,"click",{className:"bx-messenger-dest-del"},BX.delegate(function(){this.linesTransferUser=0;e.maxUsers=e.maxUsers+1;if(e.maxUsers>0)BX.show(this.popupTransferDialogContactListSearch);this.linesRedrawTransferDialogDest()},this));BX.bindDelegate(this.popupTransferDialogContactListElements,"click",{className:"bx-messenger-cl-item"},BX.delegate(function(t){if(this.popupTransferDialogContactListSearch.value!=""){this.popupTransferDialogContactListSearch.value="";BX.MessengerCommon.contactListPrepareSearch("popupTransferDialogContactListElements",this.popupTransferDialogContactListElements,"",{viewChat:false,viewOpenChat:false,viewOffline:false,viewBot:false,viewTransferOlQueue:true,viewOnlyIntranet:true,viewOfflineWithPhones:false})}if(this.linesTransferUser){e.maxUsers=e.maxUsers+1;this.linesTransferUser=0}else{if(e.maxUsers<=0)return false;var s=BX.proxy_context.getAttribute("data-userId").toString();if(s.startsWith("queue")&&!this.BXIM.messenger.openlines.canTransferToLine){BX.UI.InfoHelper.show("limit_contact_center_ol_chat_transfer");return false}e.maxUsers=e.maxUsers-1;this.linesTransferUser=s}if(e.maxUsers<=0)BX.hide(this.popupTransferDialogContactListSearch);else BX.show(this.popupTransferDialogContactListSearch);this.linesRedrawTransferDialogDest();return BX.PreventDefault(t)},this))};BX.MessengerChat.prototype.linesRedrawTransferDialogDest=function(){var e="";var t=0;var s=this.linesTransferUser.toString().substr(0,5)=="queue";var i=s?this.linesTransferUser.toString().substr(5):0;if(s){var a=this.linesTransferUser;for(var n=0;n<this.openlines.queue.length;n++){if(this.openlines.queue[n].id==i){a=this.openlines.queue[n].name;break}}t++;e+='<span class="bx-messenger-dest-block bx-messenger-dest-block-queue">'+'<span class="bx-messenger-dest-text">'+a+"</span>"+'<span class="bx-messenger-dest-del" data-userId="'+this.linesTransferUser+'"></span></span>'}else if(this.linesTransferUser>0){t++;e+='<span class="bx-messenger-dest-block'+(this.users[this.linesTransferUser].extranet?" bx-messenger-dest-block-extranet":"")+'">'+'<span class="bx-messenger-dest-text">'+this.users[this.linesTransferUser].name+"</span>"+'<span class="bx-messenger-dest-del" data-userId="'+this.linesTransferUser+'"></span></span>'}this.popupTransferDialogDestElements.innerHTML=e;this.popupTransferDialogDestElements.parentNode.scrollTop=this.popupTransferDialogDestElements.parentNode.offsetHeight;if(BX.util.even(t))BX.addClass(this.popupTransferDialogDestElements.parentNode,"bx-messenger-popup-newchat-dest-even");else BX.removeClass(this.popupTransferDialogDestElements.parentNode,"bx-messenger-popup-newchat-dest-even");this.popupTransferDialogContactListSearch.focus()};BX.MessengerChat.prototype.linesSendTransfer=function(e){if(this.BXIM.messenger.blockJoinChat[e])return false;if(this.chat[e]&&this.chat[e].entity_type!="LINES")return false;if(this.linesTransferUser<=0)return false;if(this.popupTransferDialog)this.popupTransferDialog.close();this.BXIM.messenger.blockJoinChat[e]=true;if(!BX.MessengerCommon.userInChat(e))BX.MessengerCommon.dialogCloseCurrent(true);else BX.MessengerCommon.dialogCloseCurrent(false);if(this.linesTransferUser.toString().substr(0,5)=="queue"){var t=this.linesTransferUser.substr(5);for(var s=0;s<this.BXIM.messenger.openlines.queue.length;s++){if(this.BXIM.messenger.openlines.queue[s].id==t){this.BXIM.messenger.openlines.queue[s].transfer_count=parseInt(this.BXIM.messenger.openlines.queue[s].transfer_count)+1}}}BX.ajax({url:this.BXIM.pathToAjax+"?LINES_TRANSFER&V="+this.BXIM.revision+"&logTag="+BX.MessengerCommon.getLogTrackingParams({name:"imopenlines.operator.transfer",dialog:BX.MessengerCommon.getDialogDataForTracking("chat"+e),data:{timTransferType:this.linesTransferUser.toString().substr(0,5)=="queue"?"queue":"user"}}),method:"POST",dataType:"json",timeout:60,data:{COMMAND:"transfer",CHAT_ID:e,TRANSFER_ID:this.linesTransferUser,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()},onsuccess:BX.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this),onfailure:BX.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this)})};BX.MessengerChat.prototype.linesCommentHeadAdd=function(e,t,s){if(!e){e=null}if(!t){t=null}var i=BX.proxy_context.getAttribute("data-sessionId");var a=BX.proxy_context.getAttribute("data-context");var n=BX.proxy_context;if(this.openlines){if(this.openlines.voteRatingHead){var o=this.openlines.voteRatingHead[i];if(o&&o!=null){e=o}}if(this.openlines.voteCommentHead){var r=this.openlines.voteCommentHead[i];if(r&&r!=null){t=r}}}if(this.popupRatingCommentHead){this.popupRatingCommentHead.destroy()}var l=BX.delegate(function(){var e=BX.proxy_context.getAttribute("data-rating");var t=BX.findChildren(BX("bx-messenger-popup-head-rating"),{class:"bx-lines-rating-popup-star"},true);if(t){t.forEach(function(t,s,i){if(t.getAttribute("data-rating")==e){BX.addClass(t,"bx-lines-rating-popup-star-active")}else{BX.removeClass(t,"bx-lines-rating-popup-star-active")}})}},this);this.popupRatingCommentHead=new BX.PopupWindow("bx-messenger-popup-head-rating",BX.proxy_context,{darkMode:this.BXIM.settings.enableDarkTheme,zIndex:BX.MessengerCommon.getDefaultZIndex()+200,lightShadow:true,bindOptions:{position:"top"},overlay:{opacity:0,backgroundColor:"#000000"},className:"bx-lines-rating-popup-window",autoHide:true,closeByEsc:true,bindOnResize:false,closeIcon:true,buttons:[new BX.PopupWindowButton({text:a==="history"?BX.message("IM_OL_COMMENT_HEAD_BUTTON_VOTE"):BX.message("IM_OL_COMMENT_HEAD_BUTTON_SAVE"),className:"popup-window-button-accept",events:{click:BX.delegate(function(){var e=BX.findChild(BX("bx-messenger-popup-head-rating"),{class:"bx-lines-comment-head-textarea"},true);if(e){var t=e.value}if(t&&t.length>1e4){t=t.substr(0,1e4)+"..."}if(a!=="history"){var o=null;if(t!==null){n.innerText=t}}else{var r=BX.findChild(BX("bx-messenger-popup-head-rating"),{class:"bx-lines-rating-popup-star-active"},true);if(r){var o=r.getAttribute("data-rating")}if(s&&o)s.setAttribute("data-rating",o)}if(BX("bx-messenger-popup-history")&&t!==null){var l=BX.findChildren(BX("bx-messenger-popup-history"),{class:"bx-messenger-content-item-vote-comment-edit","data-sessionId":i},true);if(l){l.forEach(function(e,s,i){e.innerText=t})}}if(BX("bx-messenger-popup-history")&&o!==null){var p=BX.findChildren(BX("bx-messenger-popup-history"),{class:"bx-lines-rating-box-current","data-sessionId":i},true);if(p){p.forEach(function(e,t,s){e.style.width=o*20+"%"})}}BX.MessengerCommon.linesVoteHeadSend(i,o,t);this.popupRatingCommentHead.close()},this)}})],events:{onPopupClose:BX.delegate(function(){BX.proxy_context.destroy()},this),onPopupDestroy:BX.delegate(function(){this.popupRatingCommentHead=null},this)},content:BX.create("div",{props:{className:"bx-lines-rating-popup"},children:[a!=="history"?BX.create("span",{props:{className:"bx-lines-rating-popup-im-title"},html:BX.message("IM_OL_COMMENT_HEAD")}):null,a==="history"?BX.create("div",{props:{className:"bx-lines-rating-popup-title"},children:[BX.create("div",{props:{className:"bx-lines-rating-popup-stars-title"},html:BX.message("IM_OL_VOTE")+": "}),BX.create("div",{props:{className:"bx-lines-rating-popup-stars-wrapper"},children:[BX.create("div",{attrs:{"data-rating":5,"data-sessionId":i},props:{className:"bx-lines-rating-popup-star"+(e==5?" bx-lines-rating-popup-star-active":"")},events:{click:l}}),BX.create("div",{attrs:{"data-rating":4,"data-sessionId":i},props:{className:"bx-lines-rating-popup-star"+(e==4?" bx-lines-rating-popup-star-active":"")},events:{click:l}}),BX.create("div",{attrs:{"data-rating":3,"data-sessionId":i},props:{className:"bx-lines-rating-popup-star"+(e==3?" bx-lines-rating-popup-star-active":"")},events:{click:l}}),BX.create("div",{attrs:{"data-rating":2,"data-sessionId":i},props:{className:"bx-lines-rating-popup-star"+(e==2?" bx-lines-rating-popup-star-active":"")},events:{click:l}}),BX.create("div",{attrs:{"data-rating":1,"data-sessionId":i},props:{className:"bx-lines-rating-popup-star"+(e==1?" bx-lines-rating-popup-star-active":"")},events:{click:l}})]})]}):null,BX.create("textarea",{props:{className:"bx-lines-comment-head-textarea"},html:t,attrs:{placeholder:BX.message("IM_OL_COMMENT_HEAD_TEXT"),"data-sessionId":i}})]})});BX.addClass(this.popupRatingCommentHead.popupContainer,"bx-messenger-mark");this.popupRatingCommentHead.show()};BX.IM.Desktop=function(e,t){this.BXIM=e;this.initDate=new Date;this.clientVersion=false;this.markup=BX("placeholder-messanger");this.htmlWrapperHead=null;this.showNotifyId={};this.showMessageId={};this.lastSetIcon=null;this.videoConfList=[];this.topmostWindow=null;this.topmostWindowTimeout=null;this.topmostWindowCloseTimeout=null;this.minCallVideoWidth=320;this.minCallVideoHeight=180;this.minCallWidth=320;this.minCallHeight=35;this.minHistoryWidth=608;this.minHistoryDiskWidth=780;this.minHistoryHeight=593;this.minSettingsWidth=620;this.startSettingsHeight=BX.browser.IsMac()?448:357;this.minSettingsHeight=137;if(this.BXIM.init&&BX.MessengerCommon.isPage()){BX.MessengerWindow.addTab({id:"config",title:BX.message("IM_SETTINGS"),order:150,target:false,events:{open:BX.delegate(function(e){this.BXIM.openSettings({active:BX.MessengerWindow.getCurrentTab()})},this)}});BX.MessengerWindow.addSeparator({order:500});if(!this.BXIM.bitrix24net){BX.MessengerWindow.addTab({id:"im-lf",title:BX.message("IM_DESKTOP_GO_SITE").replace("#COUNTER#",""),order:550,target:false,events:{open:BX.delegate(function(){BX.MessengerWindow.browse(BX.MessengerWindow.getCurrentUrl()+this.BXIM.path.lf)},this)}})}if(this.BXIM.animationSupport&&/Microsoft Windows NT 5/i.test(navigator.userAgent))this.BXIM.animationSupport=false;if(BX.MessengerCommon.isDesktop())this.BXIM.changeFocus(BX.desktop.windowIsFocused());if(this.BXIM.context=="POPUP-FULLSCREEN"){}else if(this.BXIM.context=="DESKTOP"){BX.bind(window,"keydown",BX.delegate(function(e){if(!BX.MessengerWindow.isPopupShow())return false;if(!(BX.MessengerWindow.getCurrentTab()=="im"||BX.MessengerWindow.getCurrentTab()=="notify"||BX.MessengerWindow.getCurrentTab()=="im-phone"||BX.MessengerWindow.getCurrentTab()=="im-ol"))return false;if(e.keyCode==27){if(this.messenger.popupSmileMenu){this.messenger.popupSmileMenu.destroy()}else if(this.messenger.popupMessengerFileButton!=null&&BX.hasClass(this.messenger.popupMessengerFileButton,"bx-messenger-textarea-file-active")){this.messenger.closePopupFileMenu()}else if(this.messenger.popupPopupMenu){this.messenger.popupPopupMenu.destroy()}else if(this.messenger.popupChatDialog&&this.messenger.popupChatDialogContactListSearch.value.length>=0){this.messenger.popupChatDialogContactListSearch.value=""}else if(this.BXIM.extraOpen){}else if(this.messenger.renameChatDialogInput&&this.messenger.renameChatDialogInput.value.length>0){this.messenger.renameChatDialogInput.value=BX.util.htmlspecialcharsback(this.messenger.chat[this.messenger.currentTab.toString().substr(4)].name);this.messenger.popupMessengerTextarea.focus()}else if(this.messenger.popupContactListSearchInput&&(this.messenger.popupContactListSearchInput.value.length>0||this.messenger.chatList)){BX.MessengerCommon.contactListSearch({keyCode:27});this.messenger.popupMessengerTextarea.focus()}else{if(BX.util.trim(this.messenger.popupMessengerEditTextarea.value).length>0){this.messenger.editMessageCancel()}else if(BX.util.trim(this.messenger.popupMessengerTextarea.value).length<=0&&!this.BXIM.callController.hasActiveCall()){this.messenger.textareaHistory[this.messenger.currentTab]="";this.messenger.popupMessengerTextarea.value="";if(BX.MessengerCommon.isDesktop()){BX.desktop.windowCommand("hide")}else if(this.messenger.popupMessenger){this.messenger.popupMessenger.destroy()}}else if(e.shiftKey){this.messenger.textareaHistory[this.messenger.currentTab]="";this.messenger.popupMessengerTextarea.value=""}}}else if(e.altKey==true){if(e.keyCode==49||e.keyCode==50||e.keyCode==51||e.keyCode==52||e.keyCode==53||e.keyCode==54||e.keyCode==55||e.keyCode==56||e.keyCode==57){this.messenger.openMessenger(this.messenger.recentListIndex[parseInt(e.keyCode)-49]);BX.PreventDefault(e)}else if(e.keyCode==48){this.messenger.popupContactListSearchInput.focus();BX.PreventDefault(e)}}},this))}if(BX.MessengerCommon.isDesktop()){BX.desktop.syncPause(false);BX.desktop.addCustomEvent("bxImClickNewMessage",BX.delegate(function(e){BX.desktop.windowCommand("show");BX.desktop.changeTab("im");this.BXIM.openMessenger(e)},this));BX.desktop.addCustomEvent("bxImClickCloseMessage",BX.delegate(function(e){},this));BX.desktop.addCustomEvent("bxImClickCloseNotify",BX.delegate(function(e){this.BXIM.notify.viewNotify(e)},this));BX.desktop.addCustomEvent("bxImClickNotify",BX.delegate(function(e,t){BX.desktop.windowCommand("show");if(t){BX.MessengerCommon.openLink(t)}else{BX.desktop.changeTab("notify");this.BXIM.openNotify()}},this));BX.desktop.addCustomEvent("bxCallDecline",BX.delegate(function(){var e=this.webrtc.callVideo;this.webrtc.callSelfDisabled=true;this.webrtc.callCommand(this.webrtc.callChatId,"decline",{ACTIVE:this.webrtc.callActive?"Y":"N",INITIATOR:this.webrtc.initiator?"Y":"N"});this.BXIM.playSound("stop");this.webrtc.callOverlayClose()},this));BX.desktop.addCustomEvent("bxPhoneAnswer",BX.delegate(function(){BX.desktop.windowCommand("show");BX.desktop.changeTab("im");this.BXIM.stopRepeatSound("ringtone");this.webrtc.phoneIncomingAnswer();this.closeTopmostWindow()},this));BX.desktop.addCustomEvent("bxPhoneSkip",BX.delegate(function(){this.webrtc.phoneCallFinish();this.webrtc.callAbort();this.webrtc.callOverlayClose()},this));BX.desktop.addCustomEvent("bxCallOpenDialog",BX.delegate(function(){BX.desktop.windowCommand("show");BX.desktop.changeTab("im");if(this.BXIM.dialogOpen){if(this.webrtc.callOverlayUserId>0){this.messenger.openChatFlag=false;BX.MessengerCommon.openDialog(this.webrtc.callOverlayUserId,false,false)}else{this.messenger.openChatFlag=true;BX.MessengerCommon.openDialog("chat"+this.webrtc.callOverlayChatId,false,false)}}else{if(this.webrtc.callOverlayUserId>0){this.messenger.openChatFlag=false;this.messenger.currentTab=this.webrtc.callOverlayUserId}else{this.messenger.openChatFlag=true;this.messenger.currentTab="chat"+this.webrtc.callOverlayChatId}this.messenger.extraClose(true,false)}this.webrtc.callOverlayToggleSize(false)},this));BX.desktop.addCustomEvent("bxCallMuteMic",BX.delegate(function(){if(this.webrtc.phoneCurrentCall)this.webrtc.phoneToggleAudio();else this.webrtc.toggleAudio();var e=BX.findChildByClassName(BX("bx-messenger-call-overlay-button-mic"),"bx-messenger-call-overlay-button-mic");if(e)BX.toggleClass(e,"bx-messenger-call-overlay-button-mic-off")},this));BX.desktop.addCustomEvent("bxCallAnswer",BX.delegate(function(e,t,s,i){BX.desktop.windowCommand("show");BX.desktop.changeTab("im");this.webrtc.callActive=true;BX.ajax({url:this.BXIM.pathToCallAjax+"?CALL_ANSWER&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_CALL:"Y",COMMAND:"answer",CHAT_ID:e,CALL_TO_GROUP:i?"Y":"N",RECIPIENT_ID:this.callUserId,IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()},onsuccess:BX.delegate(function(){this.webrtc.callDialog()},this)})},this));BX.desktop.addCustomEvent("bxCallJoin",BX.delegate(function(e,t,s,i){BX.desktop.windowCommand("show");BX.desktop.changeTab("im");this.webrtc.callAbort();this.webrtc.callOverlayClose(false);this.webrtc.callInvite(i?"chat"+e:t,s)},this));BX.desktop.addCustomEvent("bxImClearHistory",BX.delegate(function(e){this.messenger.history[e]=[];this.messenger.showMessage[e]=[];if(this.BXIM.init)BX.MessengerCommon.drawTab(e)},this));BX.desktop.addCustomEvent("bxSaveSettings",BX.delegate(function(e){this.BXIM.settings=e;if(this.BXIM.messenger!=null){var t=BX.MessengerWindow.currentTab=="im-ol"||BX.MessengerWindow.currentTab=="im";BX.MessengerCommon.drawTab(this.messenger.currentTab,true,0,t);BX.MessengerCommon.userListRedraw(true);if(this.BXIM.messenger.popupMessengerTextareaSendType)this.BXIM.messenger.popupMessengerTextareaSendType.innerHTML=this.BXIM.settings.sendByEnter?"Enter":BX.browser.IsMac()?"&#8984;+Enter":"Ctrl+Enter";if(BX.MessengerCommon.isPage()&&this.BXIM.bitrixOpenLines){this.messenger.toggleLinesTab();this.messenger.toggleLinesNewGroup()}this.messenger.toggleDarkTheme(this.BXIM.settings.enableDarkTheme)}if(this.BXIM.webrtc!=null){this.BXIM.webrtc.readDefaults()}},this));BX.desktop.addCustomEvent("bxSaveColor",BX.delegate(function(e){BX.MessengerCommon.setColor(e.color,e.chatId)},this));BX.desktop.addCustomEvent("bxImClickConfirmNotify",BX.delegate(function(e){delete this.BXIM.notify.notify[e];delete this.BXIM.notify.unreadNotify[e];delete this.BXIM.notify.flashNotify[e];this.BXIM.notify.updateNotifyCount(false);if(this.BXIM.openNotify)this.BXIM.notify.openNotify(true,true)},this));BX.desktop.addCustomEvent("BXUserAway",BX.delegate(this.onAwayAction,this));BX.desktop.addCustomEvent("BXApplicationClick",BX.delegate(this.onApplicationClick,this));BX.desktop.addCustomEvent("BXWakeAction",BX.delegate(this.onWakeAction,this));BX.desktop.addCustomEvent("BXForegroundChanged",BX.delegate(function(e){clearTimeout(this.BXIM.windowFocusTimeout);this.BXIM.windowFocusTimeout=setTimeout(BX.delegate(function(){this.BXIM.changeFocus(e);if(this.BXIM.isFocus()&&this.messenger&&this.messenger.unreadMessage[this.messenger.currentTab]&&this.messenger.unreadMessage[this.messenger.currentTab].length>0)BX.MessengerCommon.readMessage(this.messenger.currentTab);if(this.BXIM.isFocus("notify")&&this.notify){if(this.notify.unreadNotifyLoad)this.notify.loadNotify();else if(this.notify.notifyUpdateCount>0)this.notify.viewNotifyAll()}},this),e?500:0)},this));BX.desktop.addCustomEvent("BXTopmostMoved",BX.delegate(function(e,t){e=parseInt(e);t=parseInt(t);if(e>=0&&t>=0){BXDesktopSystem.StoreSettings("global_topmost_x",""+e);BXDesktopSystem.StoreSettings("global_topmost_y",""+t)}},this));BX.desktop.addCustomEvent("BXTrayMenu",BX.delegate(function(){var t=e.notify.getCounter("**");var s=e.notify.getCounter("im_notify");var i=e.notify.getCounter("im_message");BX.desktop.addTrayMenuItem({Id:"messenger",Order:100,Title:(BX.message("IM_DESKTOP_OPEN_MESSENGER")||"").replace("#COUNTER#",i>0?"("+i+")":""),Callback:function(){BX.desktop.windowCommand("show");BX.desktop.changeTab("im");e.messenger.openMessenger(e.messenger.currentTab)},Default:true});BX.desktop.addTrayMenuItem({Id:"notify",Order:120,Title:(BX.message("IM_DESKTOP_OPEN_NOTIFY")||"").replace("#COUNTER#",s>0?"("+s+")":""),Callback:function(){BX.desktop.windowCommand("show");BX.desktop.changeTab("notify");e.notify.openNotify(false,true)}});BX.desktop.addTrayMenuItem({Id:"bdisk",Order:130,Title:BX.message("IM_DESKTOP_BDISK"),Callback:function(){if(BX.desktop.diskAttachStatus()){BX.desktop.diskOpenFolder()}else{BX.desktop.windowCommand("show");BX.desktop.changeTab("disk")}}});BX.desktop.addTrayMenuItem({Id:"site",Order:140,Title:(BX.message("IM_DESKTOP_GO_SITE")||"").replace("#COUNTER#",t>0?"("+t+")":""),Callback:function(){BX.desktop.browse(BX.desktop.getCurrentUrl())}});BX.desktop.addTrayMenuItem({Id:"separator1",IsSeparator:true,Order:150});BX.desktop.addTrayMenuItem({Id:"settings",Order:160,Title:BX.message("IM_DESKTOP_SETTINGS"),Callback:function(){e.openSettings()}});BX.desktop.addTrayMenuItem({Id:"separator2",IsSeparator:true,Order:1e3});BX.desktop.addTrayMenuItem({Id:"logout",Order:1010,Title:BX.message("IM_DESKTOP_LOGOUT"),Callback:function(){BX.desktop.logout(false,"tray_menu")}})},this));BX.desktop.addCustomEvent("BXProtocolUrl",BX.delegate(function(e,t){console.log("BXProtocolUrl",e,t?JSON.stringify(t):"");t=t?t:{};if(t.bitrix24net&&t.bitrix24net=="Y"&&!this.BXIM.bitrix24net)return false;for(var s in t){t[s]=decodeURIComponent(t[s])}if(e=="messenger"){if(t.dialog){this.BXIM.openMessenger(t.dialog)}else if(t.chat){this.BXIM.openMessenger("chat"+t.chat)}else{this.BXIM.openMessenger()}if(t.tab){BX.MessengerWindow.changeTab(t.tab,true)}BX.desktop.setActiveWindow();BX.desktop.windowCommand("show")}else if(e=="chat"&&t.id){this.BXIM.openMessenger("chat"+t.id);BX.desktop.setActiveWindow();BX.desktop.windowCommand("show")}else if(e=="chat"&&t.create){this.BXIM.openMessenger();this.BXIM.messenger.openChatCreateForm(t.create);BX.desktop.setActiveWindow();BX.desktop.windowCommand("show")}else if(e=="videoconf"){this.openVideoconf(t.code)}else if(e=="notify"){this.BXIM.openNotify({force:true});BX.desktop.setActiveWindow();BX.desktop.windowCommand("show")}else if(e=="history"&&t.user){if(t.dialog){this.BXIM.openHistory(t.dialog)}else if(t.chat){this.BXIM.openHistory("chat"+t.chat)}BX.desktop.setActiveWindow();BX.desktop.windowCommand("show")}else if(e=="callto"){if(t.video){this.BXIM.callTo(t.video,true);BX.desktop.setActiveWindow();BX.desktop.windowCommand("show")}else if(t.audio){this.BXIM.callTo(t.audio,false);BX.desktop.setActiveWindow();BX.desktop.windowCommand("show")}else if(t.phone){if(t.params){this.webrtc.phoneCall(unescape(t.phone),BX.desktopUtils.decodeParams(t.params))}else{this.BXIM.phoneTo(unescape(t.phone))}}}else if(e=="calllist"){if(!t.id)return;this.BXIM.startCallList(t.id,BX.desktopUtils.decodeParams(t.params))}},this));BX.addCustomEvent("onPullEvent-webdav",function(e,t){BX.desktop.diskReportStorageNotification(e,t)})}BX.addCustomEvent("onPullEvent-main",BX.delegate(function(e,t){if(e=="user_counter"&&t[BX.message("SITE_ID")]){var s=["**","tasks_total"];var i={};s.forEach(function(e){if(t[BX.message("SITE_ID")].hasOwnProperty(e)){i[e]=parseInt(t[BX.message("SITE_ID")][e])}});if(Object.keys(i).length>0){this.notify.updateNotifyCounters(i)}}},this))}};BX.IM.Desktop.prototype.run=function(){return BX.MessengerCommon.isPage()};BX.IM.Desktop.prototype.ready=function(){return BX.MessengerCommon.isDesktop()};BX.IM.Desktop.prototype.getCurrentUrl=function(){if(!BX.MessengerCommon.isDesktop())return false;return BX.desktop.getCurrentUrl()};BX.IM.Desktop.prototype.isPopupPageLoaded=function(){if(!this.enableInVersion(45))return false;if(!this.BXIM.isUtfMode)return false;if(!BXInternals)return false;if(!BXInternals.PopupTemplate)return false;if(BXInternals.PopupTemplate==="#PLACEHOLDER#")return false;return true};BX.IM.Desktop.prototype.enableInVersion=function(e){if(!BX.MessengerCommon.isDesktop())return false;return BX.desktop.enableInVersion(e)};BX.IM.Desktop.prototype.addCustomEvent=function(e,t){if(!BX.MessengerCommon.isDesktop())return false;BX.desktop.addCustomEvent(e,t)};BX.IM.Desktop.prototype.onCustomEvent=function(e,t,s){if(!BX.MessengerCommon.isDesktop())return false;BX.desktop.onCustomEvent(e,t,s)};BX.IM.Desktop.prototype.windowCommand=function(e,t){if(!BX.MessengerCommon.isDesktop())return false;if(typeof t=="undefined")BX.desktop.windowCommand(e);else BX.desktop.windowCommand(t,e)};BX.IM.Desktop.prototype.browse=function(e){if(!BX.MessengerCommon.isDesktop())return false;BX.desktop.browse(e)};BX.IM.Desktop.prototype.drawOnPlaceholder=function(e){if(this.markup==null||!BX.type.isDomNode(e))return false;this.markup.innerHTML="";this.markup.appendChild(e)};BX.IM.Desktop.prototype.openNewNotify=function(e,t,s){if(!BX.MessengerCommon.isDesktop())return;if(t=="")return false;if(this.showNotifyId[e])return false;this.showNotifyId[e]=true;var i={};i[e]=this.BXIM.notify.notify[e];BXDesktopSystem.ExecuteCommand("notification.show.html",this.getHtmlPage(t,s,{notify:i},"im-notify-popup"))};BX.IM.Desktop.prototype.openNewMessage=function(e,t,s){if(!BX.MessengerCommon.isDesktop())return;if(t=="")return false;if(this.showMessageId[e])return false;this.showMessageId[e]=true;BXDesktopSystem.ExecuteCommand("notification.show.html",this.getHtmlPage(t,s,true,"im-notify-popup"))};BX.IM.Desktop.prototype.adjustSize=function(){documentOffsetHeight=document.body.offsetHeight;if(BX.MessengerCommon.isPage()&&this.BXIM.context=="POPUP-FULLSCREEN"&&BX.MessengerCommon.isIntranet()){if(!BX.MessengerWindow.content.parentNode||!this.BXIM.messenger.popupMessengerContent){return false}documentOffsetHeight=BX.MessengerWindow.content.offsetHeight;if(this.initHeight<=0){this.initHeight=this.BXIM.messenger.popupMessengerContent.offsetHeight}var e=documentOffsetHeight-this.initHeight;this.initHeight=documentOffsetHeight}else if(BX.MessengerCommon.isPage()){if(this.BXIM.context=="POPUP-FULLSCREEN"&&BX.hasClass(BX.MessengerWindow.popup,"bx-im-fullscreen-closed")){return false}if(this.BXIM.context=="LINES"){if(window.innerHeight<BX.MessengerWindow.minHeight){return false}}else if(BX.MessengerWindow.content){documentOffsetHeight=BX.MessengerWindow.content.offsetHeight}var e=documentOffsetHeight-this.initHeight;this.initHeight=documentOffsetHeight}else if(!BX.MessengerCommon.isDesktop()||!this.BXIM.init||!this.BXIM.messenger||!this.BXIM.notify){return false}else{if(window.innerHeight<BX.MessengerWindow.minHeight)return false;var e=documentOffsetHeight-this.initHeight;this.initHeight=documentOffsetHeight}this.BXIM.messenger.popupMessengerBodySize=Math.max(this.BXIM.messenger.popupMessengerBodySize+e,this.BXIM.messenger.popupMessengerBodySizeMin-(this.BXIM.messenger.popupMessengerTextareaSize-30));if(this.BXIM.messenger.popupMessengerBody!=null){this.BXIM.messenger.popupMessengerBody.style.height=this.BXIM.messenger.popupMessengerBodySize+"px";this.BXIM.messenger.popupMessengerBodyPanel.style.height=this.BXIM.messenger.popupMessengerBodyDialog.offsetHeight+"px";this.BXIM.messenger.redrawChatHeader()}this.BXIM.messenger.popupContactListElementsSize=Math.max(this.BXIM.messenger.popupContactListElementsSize+e,this.BXIM.messenger.popupContactListElementsSizeMin);if(this.BXIM.messenger.popupContactListElements!=null)this.BXIM.messenger.popupContactListElements.style.height=this.BXIM.messenger.popupContactListElementsSize+"px";this.BXIM.messenger.popupMessengerFullHeight=documentOffsetHeight;if(this.BXIM.messenger.popupMessengerExtra!=null)this.BXIM.messenger.popupMessengerExtra.style.height=this.BXIM.messenger.popupMessengerFullHeight+"px";this.BXIM.notify.popupNotifySize=Math.max(this.BXIM.notify.popupNotifySize+e,this.BXIM.notify.popupNotifySizeMin);if(this.BXIM.notify.popupNotifyItem!=null)this.BXIM.notify.popupNotifyItem.style.height=this.BXIM.notify.popupNotifySize+"px";if(this.BXIM.webrtc.callOverlay){this.BXIM.webrtc.callOverlay.style.transition="none";this.BXIM.webrtc.callOverlay.style.width=(this.BXIM.messenger.popupMessengerExtra.style.display=="block"?this.BXIM.messenger.popupMessengerExtra.offsetWidth-1:this.BXIM.messenger.popupMessengerDialog.offsetWidth-1)+"px";this.BXIM.webrtc.callOverlay.style.height=this.BXIM.messenger.popupMessengerFullHeight-1+"px"}if(this.BXIM.messenger.chatCreateFormBody){BX.style(this.BXIM.messenger.chatCreateFormBody,"height",this.BXIM.messenger.popupMessengerBodySize+"px")}if(this.BXIM.messenger.popupCreateChatTextarea){BX.style(this.BXIM.messenger.popupCreateChatTextarea,"height",this.BXIM.messenger.popupMessengerTextareaSize+"px")}this.BXIM.messenger.closeMenuPopup();if(BX.MessengerCommon.isDesktop()){clearTimeout(this.BXIM.adjustSizeTimeout);this.BXIM.adjustSizeTimeout=setTimeout(BX.delegate(function(){this.BXIM.setLocalConfig("global_msz_v2",{wz:this.BXIM.messenger.popupMessengerFullWidth,ta2:this.BXIM.messenger.popupMessengerTextareaSize,b:this.BXIM.messenger.popupMessengerBodySize,cl:this.BXIM.messenger.popupContactListSize,hi:this.BXIM.messenger.popupHistoryItemsSize,fz:this.BXIM.messenger.popupMessengerFullHeight,ez:this.BXIM.messenger.popupContactListElementsSize,nz:this.BXIM.notify.popupNotifySize,hf:this.BXIM.messenger.popupHistoryFilterVisible,dw:window.innerWidth,dh:window.innerHeight,place:"desktop"});if(this.BXIM.webrtc.callOverlay)this.BXIM.webrtc.callOverlay.style.transition=""},this),500)}return true};BX.IM.Desktop.prototype.autoResize=function(e){if(!BX.MessengerCommon.isDesktop())return;BX.desktop.resize()};BX.IM.Desktop.prototype.openSettings=function(e,t,s){if(!BX.MessengerCommon.isDesktop())return false;s=s||{};if(s.minSettingsWidth)this.minSettingsWidth=s.minSettingsWidth;if(s.minSettingsHeight)this.minSettingsHeight=s.minSettingsHeight;BX.desktop.createWindow("settings",BX.delegate(function(s){s.SetProperty("clientSize",{Width:this.minSettingsWidth,Height:this.startSettingsHeight});s.SetProperty("minClientSize",{Width:this.minSettingsWidth,Height:this.minSettingsHeight});s.SetProperty("resizable",false);s.SetProperty("title",BX.message("IM_SETTINGS"));s.ExecuteCommand("html.load",this.getHtmlPage(e,t,{}))},this))};BX.IM.Desktop.prototype.openVideoconf=function(e){if(!BX.MessengerCommon.isDesktop()){return false}var t=null;var s=[{width:2560,height:1440},{width:2048,height:1152},{width:1920,height:1080},{width:1600,height:900},{width:1366,height:768},{width:1024,height:576}];for(var i=0;i<s.length;i++){t=s[i];if(screen.width>s[i].width&&screen.height>s[i].height){break}}this.videoConfList=this.videoConfList.filter(function(e){return!!BX.desktop.findWindow(e)});this.videoConfList.push("videoconf"+e);BX.desktop.createWindow("videoconf"+e,BX.delegate(function(s){s.SetProperty("title",BX.message("IM_M_CALL_VIDEOCONF"));s.SetProperty("clientSize",{Width:t.width,Height:t.height});s.SetProperty("minClientSize",{Width:710,Height:400});s.SetProperty("backgroundColor","#2B3038");s.ExecuteCommand("html.load",'<script>location.href="/desktop_app/router.php?alias='+e+'&videoconf";<\/script>')},this));return true};BX.IM.Desktop.prototype.showActiveVideocall=function(){if(this.BXIM.callController.hasActiveCall()&&this.BXIM.callController.callView&&this.BXIM.callController.callView.visible){this.BXIM.callController.unfold()}this.videoConfList=this.videoConfList.filter(function(e){var t=BX.desktop.findWindow(e);BX.desktop.windowCommand(t,"show");return!!t})};BX.IM.Desktop.prototype.openHistory=function(e,t,s){if(!BX.MessengerCommon.isDesktop())return false;BX.desktop.createWindow("history",BX.delegate(function(i){var a={chat:{},users:{},files:{}};var n=this.messenger.disk.enable;if(e.toString().substr(0,4)=="chat"){var o=e.substr(4);a["chat"][o]=this.messenger.chat[o];a["files"][o]=this.disk.files[o];for(var r=0;r<this.messenger.userInChat[o].length;r++)a["users"][this.messenger.userInChat[o][r]]=this.messenger.users[this.messenger.userInChat[o][r]]}else{o=this.messenger.userChat[e]?this.messenger.userChat[e]:0;a["userChat"]={};a["userChat"][e]=o;a["users"][e]=this.messenger.users[e];a["users"][this.BXIM.userId]=this.messenger.users[this.BXIM.userId];a["files"][o]=this.disk.files[o]}i.SetProperty("clientSize",{Width:n?this.minHistoryDiskWidth:this.minHistoryWidth,Height:this.minHistoryHeight});i.SetProperty("minClientSize",{Width:n?this.minHistoryDiskWidth:this.minHistoryWidth,Height:this.minHistoryHeight});i.SetProperty("resizable",false);i.ExecuteCommand("html.load",this.getHtmlPage(t,s,a));i.SetProperty("title",BX.message("IM_M_HISTORY"))},this))};BX.IM.Desktop.prototype.openCallFloatDialog=function(){if(!this.BXIM.init||!BX.MessengerCommon.isDesktop()||!this.webrtc||!this.webrtc.callActive||this.topmostWindow||this.phoneTransferEnabled)return false;if(this.webrtc.callVideo&&!this.webrtc.callStreamMain)return false;if(!this.webrtc.callOverlayTitleBlock)return false;this.openTopmostWindow("callFloatDialog",'BXIM.webrtc.callFloatDialog("'+BX.util.jsencode(this.webrtc.callOverlayTitleBlock.innerHTML.replace(/<\/?[^>]+>/gi," "))+'", "'+(this.webrtc.callVideo?this.webrtc.callOverlayVideoMain.src:"")+'", '+(this.webrtc.audioMuted?1:0)+")",{},"im-desktop-call")};BX.IM.Desktop.prototype.closeCallFloatDialog=function(){if(!BX.MessengerCommon.isDesktop()||!this.topmostWindow)return false;if(this.webrtc.callActive){if(this.webrtc.callOverlayUserId>0&&this.webrtc.callOverlayUserId==this.messenger.currentTab){this.closeTopmostWindow()}else if(this.webrtc.callOverlayChatId>0&&this.webrtc.callOverlayChatId==this.messenger.currentTab.toString().substr(4)){this.closeTopmostWindow()}}else{this.closeTopmostWindow()}};BX.IM.Desktop.prototype.openTopmostWindow=function(e,t,s,i){if(!BX.MessengerCommon.isDesktop())return false;this.closeTopmostWindow();console.log("openTopmostWindow init",e,t);clearTimeout(this.topmostWindowTimeout);this.topmostWindowTimeout=setTimeout(BX.delegate(function(){if(this.topmostWindow)return false;console.log("openTopmostWindow show",e);this.topmostWindow=BXDesktopSystem.ExecuteCommand("topmost.show.html",this.getHtmlPage("",t,s,i))},this),500)};BX.IM.Desktop.prototype.closeTopmostWindow=function(){clearTimeout(this.topmostWindowTimeout);clearTimeout(this.topmostWindowCloseTimeout);if(!this.topmostWindow)return false;console.log("closeTopmostWindow init");if(this.topmostWindow&&this.topmostWindow.document)BX.desktop.windowCommand(this.topmostWindow,"hide");this.topmostWindowCloseTimeout=setTimeout(BX.delegate(function(){if(this.topmostWindow&&this.topmostWindow.document){console.log("closeTopmostWindow close");BX.desktop.windowCommand(this.topmostWindow,"close");this.topmostWindow=null}},this),300)};BX.IM.Desktop.prototype.getHtmlPage=function(e,t,s,i){if(!BX.MessengerCommon.isDesktop())return;e=e||"";t=t||"";i=i||"";var a=typeof s=="undefined"||typeof s!="object"?{}:s;s=typeof s!="undefined";if(e!=""&&BX.type.isDomNode(e)){e=e.outerHTML}if(t!=""&&BX.type.isDomNode(t)){t=t.outerHTML}if(t!=""){t='<script type="text/javascript">BX.ready(function(){'+t+"});<\/script>"}var n="";if(s==true){n='<script type="text/javascript">'+"BX.ready(function() {"+"BXIM = new BX.IM(null, {"+"'init': false,"+"'colors' : "+(this.BXIM.colors?JSON.stringify(this.BXIM.colors):"false")+","+"'settings' : "+JSON.stringify(this.BXIM.settings)+","+"'settingsView' : "+JSON.stringify(this.BXIM.settingsView)+","+"'updateStateInterval': '"+this.BXIM.updateStateInterval+"',"+"'desktop': "+BX.MessengerCommon.isPage()+","+"'desktopVersion': "+this.BXIM.desktopVersion+","+"'ppStatus': false,"+"'ppServerStatus': false,"+"'xmppStatus': "+this.BXIM.xmppStatus+","+"'bitrixNetwork': "+this.BXIM.bitrixNetwork+","+"'bitrixNetwork2': "+this.BXIM.bitrixNetwork2+","+"'bitrixOpenLines': "+this.BXIM.bitrixOpenLines+","+"'bitrix24': "+this.BXIM.bitrix24+","+"'bitrixIntranet': "+this.BXIM.bitrixIntranet+","+"'bitrixXmpp': "+this.BXIM.bitrixXmpp+","+"'bitrixMobile': "+this.BXIM.bitrixMobile+","+"'files' : "+(a.files?JSON.stringify(a.files):"{}")+","+"'notify' : "+(a.notify?JSON.stringify(a.notify):"{}")+","+"'users' : "+(a.users?JSON.stringify(a.users):"{}")+","+"'chat' : "+(a.chat?JSON.stringify(a.chat):"{}")+","+"'userChat' : "+(a.userChat?JSON.stringify(a.userChat):"{}")+","+"'userInChat' : "+(a.userInChat?JSON.stringify(a.userInChat):"{}")+","+"'hrphoto' : "+(a.hrphoto?JSON.stringify(a.hrphoto):"{}")+","+"'phoneCrm' : "+(a.phoneCrm?JSON.stringify(a.phoneCrm):"{}")+","+"'generalChatId': "+this.BXIM.messenger.generalChatId+","+"'canSendMessageGeneralChat': "+this.BXIM.messenger.canSendMessageGeneralChat+","+"'userId': "+this.BXIM.userId+","+"'userEmail': '"+this.BXIM.userEmail+"',"+"'userColor': '"+this.BXIM.userColor+"',"+"'userGender': '"+this.BXIM.userGender+"',"+"'userExtranet': "+this.BXIM.userExtranet+","+"'disk': {'enable': "+(this.disk?this.disk.enable:false)+", 'external': "+(this.disk?this.disk.external:false)+"},"+"'path' : "+JSON.stringify(this.BXIM.path)+"});"+"if (BX.SidePanel) { BX.SidePanel.Instance.anchorBinding = false; }"+"});"+"<\/script>"}if(this.BXIM.settings.enableDarkTheme){i=i+" bx-messenger-dark"}if(this.isPopupPageLoaded()){return'<div class="im-desktop im-desktop-popup bx-messenger-mark '+i+'"><div id="placeholder-messanger">'+e+"</div>"+n+t+"</div>"}else{if(this.htmlWrapperHead==null){this.htmlWrapperHead=document.head.outerHTML.replace(/BX\.PULL\.start\([^)]*\);/g,"")}return"<!DOCTYPE html><html>"+this.htmlWrapperHead+'<body class="im-desktop im-desktop-popup bx-messenger-mark '+i+'"><div id="placeholder-messanger">'+e+"</div>"+n+t+"</body></html>"}};BX.IM.Desktop.prototype.onAwayAction=function(e,t){BX.ajax({url:this.BXIM.pathToAjax+"?IDLE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_IDLE:"Y",IM_AJAX_CALL:"Y",IDLE:e?"Y":"N",MANUAL:t?"Y":"N",sessid:BX.bitrix_sessid()},onsuccess:BX.delegate(function(e){if(e&&e.BITRIX_SESSID){BX.message({bitrix_sessid:e.BITRIX_SESSID})}if(e.ERROR=="AUTHORIZE_ERROR"&&BX.MessengerCommon.isDesktop()&&this.messenger.sendAjaxTry<3){this.messenger.sendAjaxTry++;BX.onCustomEvent(window,"onImError",[e.ERROR])}else if(e.ERROR=="SESSION_ERROR"&&this.messenger.sendAjaxTry<2){this.messenger.sendAjaxTry++;BX.onCustomEvent(window,"onImError",[e.ERROR,e.BITRIX_SESSID])}else{if(e.ERROR=="AUTHORIZE_ERROR"||e.ERROR=="SESSION_ERROR"){BX.onCustomEvent(window,"onImError",[e.ERROR])}}},this)})};BX.IM.Desktop.prototype.onWakeAction=function(){BX.desktop.setIconStatus("offline");BX.MessengerCommon.checkInternetConnection(function(){var e=BXIM.desktop.initDate;var t=new Date;if(e.getDate()+""+e.getMonth()+""+e.getFullYear()==t.getDate()+""+t.getMonth()+""+t.getFullYear()){BX.PULL.restart()}else{BX.desktop.windowReload()}},BX.delegate(function(){BX.desktop.login()},this),10)};BX.IM.Desktop.prototype.onApplicationClick=function(){this.showActiveVideocall();return true};BX.IM.Desktop.prototype.birthdayStatus=function(e){if(!BX.MessengerCommon.isDesktop())return false;if(typeof e!="boolean"){return this.BXIM.getLocalConfig("birthdayStatus",true)}else{this.BXIM.setLocalConfig("birthdayStatus",e);return e}};BX.IM.Desktop.prototype.isTwoWindowMode=function(){return!!BXDesktopSystem.IsTwoWindowsMode()};BX.IM.Desktop.prototype.setTwoWindowMode=function(e){if(!BX.MessengerCommon.isDesktop()){return false}if(e){if(this.isTwoWindowMode()){return true}BXDesktopSystem.V10()}else{if(!this.isTwoWindowMode()){return true}BXDesktopSystem.V8()}this.BXIM.openConfirm(BX.message("IM_M_BITRIX24_WINDOW_MODE_NOTICE"),[new BX.PopupWindowButton({text:BX.message("IM_NOTIFY_CONFIRM_CLOSE"),className:"popup-window-button",events:{click:function(){this.popupWindow.close()}}})]);return true};BX.IM.Desktop.prototype.sliderStatus=function(e){if(!(BX.MessengerCommon.isDesktop()&&BX.MessengerCommon.isSliderBindingsEnable())){return false}if(typeof e!="boolean"){return this.BXIM.getLocalConfig("sliderStatus",true)}else{this.BXIM.setLocalConfig("sliderStatus",e);if(e){(opener?opener:top).BX.SidePanel.Instance.enableAnchorBinding()}else{(opener?opener:top).BX.SidePanel.Instance.disableAnchorBinding()}return e}};BX.IM.Desktop.prototype.changeTab=function(e){return false};BX.PopupWindowDesktop=function(){this.closeByEsc=true;this.setClosingByEsc=function(e){this.closeByEsc=e};this.close=function(){if(BX.MessengerCommon.isDesktop()){BX.desktop.windowCommand("close")}else if(BX.MessengerCommon.isPage()){BX.MessengerWindow.closePopup()}};this.destroy=function(){if(BX.MessengerCommon.isDesktop()){BX.desktop.windowCommand("close")}else if(BX.MessengerCommon.isPage()){BX.MessengerWindow.closePopup()}}};BX.IM.WebRTC=function(e,t){if(this.parent){this.parent.constructor.apply(this,arguments)}this.BXIM=e;this.screenSharing=new BX.IM.ScreenSharing(this,t);this.panel=t.panel;this.desktop=t.desktopClass;this.callToPhone=false;this.callOverlayFullScreen=false;this.callToMobile=false;this.callAspectCheckInterval=null;this.callAspectHorizontal=true;this.callInviteTimeout=null;this.callNotify=null;this.callAllowTimeout=null;this.callDialogAllow=null;this.callOverlay=null;this.callOverlayMinimize=null;this.callOverlayChatId=0;this.callOverlayUserId=0;this.callSelfDisabled=false;this.callOverlayPhotoSelf=null;this.callOverlayPhotoUsers={};this.callOverlayVideoUsers={};this.callOverlayVideoPhotoUsers={};this.callOverlayPhotoCompanion=null;this.callOverlayPhotoMini=null;this.callOverlayVideoMain=null;this.callOverlayVideoReserve=null;this.callOverlayVideoSelf=null;this.callOverlayProgressBlock=null;this.callOverlayStatusBlock=null;this.callOverlayButtonsBlock=null;this.callView=null;this.phoneEnabled=t.phoneEnabled;this.phoneCanPerformCalls=t.phoneCanPerformCalls;this.phoneDeviceActive=t.phoneDeviceActive=="Y";this.phoneCanCallUserNumber=t.phoneCanCallUserNumber=="Y";this.phoneCallerID="";this.phoneLogin="";this.phoneServer="";this.phoneCheckBalance=false;this.phoneCallHistory={};this.phoneHistory=this.BXIM.getLocalConfig("phone-history")||[];this.phoneSDKinit=false;this.phoneMicAccess=false;this.phoneIncoming=false;this.phoneCallId="";this.phoneCallTime=0;this.phoneCallConfig={};this.phoneCallExternal=false;this.phoneCallDevice="WEBRTC";this.phonePortalCall=false;this.phoneNumber="";this.phoneFullNumber="";this.phoneNumberUser="";this.phoneParams={};this.phoneAPI=null;this.phoneDisconnectAfterCallFlag=true;this.phoneCurrentCall=null;this.phoneCrm=t.phoneCrm?t.phoneCrm:{};this.phoneMicMuted=false;this.phoneHolded=false;this.phoneRinging=0;this.phoneTransferEnabled=false;this.phoneTransferTargetType="user";this.phoneTransferTargetId="";this.phoneTransferCallId="";this.phoneConnectedInterval=null;this.phoneDeviceDelayTimeout=null;this.phoneLines=t.phoneLines||{};this.phoneDefaultLineId=t.phoneDefaultLineId||false;this.phoneAvailableLines=t.phoneAvailableLines||[];this.phoneCallView=false;this.foldedPhoneCallView=BX.FoldedCallView.getInstance();this.callListId=0;this.lastCallListCallParams=null;this.debug=false;this.phoneKeypad=null;this.popupTransferDialog=null;this.popupTransferDialogDestElements=null;this.popupTransferDialogContactListSearch=null;this.popupTransferDialogContactListElements=null;if(this.setTurnServer){this.setTurnServer({turnServer:t.turnServer||"",turnServerFirefox:t.turnServerFirefox||"",turnServerLogin:t.turnServerLogin||"",turnServerPassword:t.turnServerPassword||""})}this.readDefaults();this.restoreFoldedCallView();var s=false;if(this.enabled){s=true}else{if(!this.BXIM.desktopStatus){this.initAudio(true)}}if(this.phoneEnabled&&(this.phoneDeviceActive||this.enabled)){s=true}BX.MessengerCommon.pullPhoneEvent();if(s){this.initAudio();if(BX.browser.SupportLocalStorage()){BX.addCustomEvent(window,"onLocalStorageSet",this.storageSet.bind(this))}BX.garbage(function(){if(this.callInit&&!this.callActive){if(this.initiator){this.callCommand(this.callChatId,"decline",{ACTIVE:this.callActive?"Y":"N",INITIATOR:this.initiator?"Y":"N"},false);this.callAbort()}}if(this.callActive){if(this.phoneCallView&&(this.phoneCallExternal||this.phoneCallDevice==="PHONE")){if(this.phoneCallView.canBeUnloaded()){BX.localStorage.set("bxim-folded-call-card",{phoneCallId:this.phoneCallId,phoneCrm:this.phoneCrm,phoneCallDevice:this.phoneCallDevice,phoneCallExternal:this.phoneCallExternal,callView:this.phoneCallView.getState()},15)}}else{this.callCommand(this.callChatId,"errorAccess",{},false)}}this.callOverlayClose()},this)}this.initialize()};if(BX.inheritWebrtc)BX.inheritWebrtc(BX.IM.WebRTC);BX.IM.WebRTC.prototype.ready=function(){return this.enabled};BX.IM.WebRTC.prototype.initialize=function(){BX.addCustomEvent("onImDialogOpen",this.onImDialogOpen.bind(this));BX.addCustomEvent("onPullEvent-im",this.onPullEvent.bind(this))};BX.IM.WebRTC.prototype.onImDialogOpen=function(e){if(this.callView)this.callOverlayToggleSize()};BX.IM.WebRTC.prototype.onPullEvent=function(e,t){if(e!="call")return;this.log("Incoming",t.command,t.senderId,JSON.stringify(t));var s={join:this.onPullEventJoin.bind(this),invite:this.onPullEventInvite.bind(this),invite_join:this.onPullEventInvite.bind(this),invite_user:this.onPullEventInviteUser.bind(this),wait:this.onPullEventWait.bind(this),answer:this.onPullEventAnswer.bind(this),ready:this.onPullEventReady.bind(this),errorAccess:this.onPullEventErrorAccess.bind(this),reconnect:this.onPullEventReconnect.bind(this),signaling:this.onPullEventSignaling.bind(this),waitTimeout:this.onPullEventWaitTimeout.bind(this),busy_self:this.onPullEventBusySelf.bind(this),callToPhone:this.onPullEventCallToPhone.bind(this),busy:this.onPullEventBusy.bind(this),decline:this.onPullEventDecline.bind(this),answer_self:this.onPullEventAnswerSelf.bind(this),decline_self:this.onPullEventDeclineSelf.bind(this)};if(s[t.command]){s[t.command].call(this,t)}else{console.log("Unknown call command "+t.command)}};BX.IM.WebRTC.prototype.onPullEventJoin=function(e){for(var t in e.users){e.users[t].last_activity_date=new Date(e.users[t].last_activity_date);e.users[t].mobile_last_date=new Date(e.users[t].mobile_last_date);e.users[t].idle=e.users[t].idle?new Date(e.users[t].idle):false;e.users[t].absent=e.users[t].absent?new Date(e.users[t].absent):false;this.messenger.users[t]=e.users[t]}for(var t in e.hrphoto)this.messenger.hrphoto[t]=e.hrphoto[t];if(this.callInit||this.callActive){setTimeout(BX.delegate(function(){BX.ajax({url:this.BXIM.pathToCallAjax+"?CALL_BUSY&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_CALL:"Y",COMMAND:"busy",CHAT_ID:e.chatId,RECIPIENT_ID:e.senderId,VIDEO:e.video?"Y":"N",IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()}})},this),e.callToGroup?1e3:0)}else{if(BX.MessengerCommon.isDesktop()||!this.BXIM.desktopStatus){this.messenger.openMessenger("chat"+e.chatId);this.BXIM.repeatSound("ringtone",5e3);this.callNotifyWait(e.chatId,e.senderId,e.video,e.callToGroup,true)}if(BX.MessengerCommon.isDesktop()&&!this.BXIM.windowFocus){var s={users:{},chat:{},userInChat:{},hrphoto:{}};if(e.callToGroup){s["chat"][e.chatId]=this.messenger.chat[e.chatId];s["userInChat"][e.chatId]=this.messenger.userInChat[e.chatId]}for(var t=0;t<this.messenger.userInChat[e.chatId].length;t++){s["users"][this.messenger.userInChat[e.chatId][t]]=this.messenger.users[this.messenger.userInChat[e.chatId][t]];s["hrphoto"][this.messenger.userInChat[e.chatId][t]]=this.messenger.hrphoto[this.messenger.userInChat[e.chatId][t]]}this.desktop.openTopmostWindow("callNotifyWaitDesktop","BXIM.webrtc.callNotifyWaitDesktop("+e.chatId+",'"+e.senderId+"', "+(e.video?1:0)+", "+(e.callToGroup?1:0)+", true);",s,"im-desktop-call")}}};BX.IM.WebRTC.prototype.onPullEventInvite=function(e){console.trace("Trying to call deprecated function onPullEventInvite");return;for(var t in e.users){e.users[t].last_activity_date=new Date(e.users[t].last_activity_date);e.users[t].mobile_last_date=new Date(e.users[t].mobile_last_date);e.users[t].idle=e.users[t].idle?new Date(e.users[t].idle):false;e.users[t].absent=e.users[t].absent?new Date(e.users[t].absent):false;this.messenger.users[t]=e.users[t]}for(var t in e.hrphoto)this.messenger.hrphoto[t]=e.hrphoto[t];for(var t in e.chat){e.chat[t].date_create=new Date(e.chat[t].date_create);this.messenger.chat[t]=e.chat[t]}for(var t in e.userInChat)this.messenger.userInChat[t]=e.userInChat[t];if(!this.enabled&&!this.BXIM.desktopStatus){this.callView=new BX.IM.Call.View({toUserId:this.BXIM.userId,fromUserId:e.senderId,groupCall:this.callToGroup,users:this.callToGroup?this.messenger.userInChat(e.senderId):[e.senderId],video:e.video,progress:"offline",status:BX.MessengerCommon.isDesktop()?BX.message("IM_M_CALL_ST_NO_WEBRTC_3"):BX.message("IM_M_CALL_ST_NO_WEBRTC_2"),uiState:this.BXIM.platformName==""?BX.IM.Call.UiState.Finished:BX.IM.Call.UiState.Unsupported});this.bindCallViewCallbacks();this.callView.show();this.callOverlayDeleteEvents({closeNotify:false});return}if(this.callInit||this.callActive){if(e.command=="invite"){if(this.callChatId==e.chatId){this.callCommand(e.chatId,"busy_self");this.callOverlayClose(false)}else{setTimeout(BX.delegate(function(){BX.ajax({url:this.BXIM.pathToCallAjax+"?CALL_BUSY&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_CALL:"Y",COMMAND:"busy",CHAT_ID:e.chatId,RECIPIENT_ID:e.senderId,VIDEO:e.video?"Y":"N",IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()}})},this),e.callToGroup?1e3:0)}}else if(this.initiator&&this.callChatId==e.chatId){this.initiator=false;this.callDialog();BX.ajax({url:this.BXIM.pathToCallAjax+"?CALL_ANSWER&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_CALL:"Y",COMMAND:"answer",CHAT_ID:this.callChatId,CALL_TO_GROUP:this.callToGroup?"Y":"N",RECIPIENT_ID:this.callUserId,IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()}})}}else{if(BX.MessengerCommon.isDesktop()||!this.BXIM.desktopStatus){this.BXIM.repeatSound("ringtone",5e3);this.callCommand(e.chatId,"wait");if(BX.MessengerCommon.isPage()){BX.MessengerWindow.changeTab("im")}if(e.isMobile){this.callToMobile=true}this.callNotifyWait(e.chatId,e.senderId,e.video,e.callToGroup)}if(BX.MessengerCommon.isDesktop()&&!this.BXIM.isFocus("all")){var s={users:{},chat:{},userInChat:{},hrphoto:{}};if(e.callToGroup){s["chat"][e.chatId]=this.messenger.chat[e.chatId];s["userInChat"][e.chatId]=this.messenger.userInChat[e.chatId]}for(var t=0;t<this.messenger.userInChat[e.chatId].length;t++){s["users"][this.messenger.userInChat[e.chatId][t]]=this.messenger.users[this.messenger.userInChat[e.chatId][t]];s["hrphoto"][this.messenger.userInChat[e.chatId][t]]=this.messenger.hrphoto[this.messenger.userInChat[e.chatId][t]]}this.desktop.openTopmostWindow("callNotifyWaitDesktop","BXIM.webrtc.callNotifyWaitDesktop("+e.chatId+",'"+e.senderId+"', "+(e.video?1:0)+", "+(e.callToGroup?1:0)+");",s,"im-desktop-call")}}};BX.IM.WebRTC.prototype.onPullEventInviteUser=function(e){if(!this.callInit||this.callChatId!=e.lastChatId)return;for(var t in e.users){e.users[t].last_activity_date=new Date(e.users[t].last_activity_date);e.users[t].mobile_last_date=new Date(e.users[t].mobile_last_date);e.users[t].idle=e.users[t].idle?new Date(e.users[t].idle):false;e.users[t].absent=e.users[t].absent?new Date(e.users[t].absent):false;this.messenger.users[t]=e.users[t]}for(var t in e.hrphoto)this.messenger.hrphoto[t]=e.hrphoto[t];this.callChatId=e.chatId;this.callView.redraw()};BX.IM.WebRTC.prototype.onPullEventWait=function(e){if(this.callActive||!this.callInit||this.callChatId!=e.chatId)return;if(!this.callToGroup){clearTimeout(this.callDialtoneTimeout);this.callDialtoneTimeout=setTimeout(BX.delegate(function(){this.BXIM.repeatSound("dialtone",5e3)},this),2e3)}this.callWait(e.senderId)};BX.IM.WebRTC.prototype.onPullEventAnswer=function(e){if(!this.initiator||this.callChatId!=e.chatId)return;this.callDialog();if(e.isMobile){this.callToMobile=true}};BX.IM.WebRTC.prototype.onPullEventReady=function(e){if(this.callActive&&this.callStreamSelf==null){clearTimeout(this.callAllowTimeout);this.callAllowTimeout=setTimeout(BX.delegate(function(){this.BXIM.playSound("error");this.callView.setProgress("offline");this.callCommand(this.callChatId,"errorAccess");this.callView.setUiState(BX.IM.Call.UiState.Finished);this.callAbort(BX.message("IM_M_CALL_ST_NO_ACCESS_3"))},this),6e4)}this.log("Opponent "+e.senderId+" ready!");this.connected[e.senderId]=true};BX.IM.WebRTC.prototype.onPullEventErrorAccess=function(e){if(this.callChatId!=e.chatId)return false;if(this.callInit&&e.callToGroup)return this.onGroupCallUserError(e.senderId);if(!this.callActive||e.callToGroup&&!e.closeConnect)return false;this.BXIM.playSound("error");this.callOverlayProgress("offline");this.callView.setUiState(BX.IM.Call.UiState.Finished);this.callAbort(BX.message("IM_M_CALL_ST_NO_ACCESS_2"))};BX.IM.WebRTC.prototype.onPullEventReconnect=function(e){if(!this.callActive||this.callChatId!=e.chatId)return false;clearTimeout(this.pcConnectTimeout[e.senderId]);clearTimeout(this.initPeerConnectionTimeout[e.senderId]);if(this.pc[e.senderId])this.pc[e.senderId].close();delete this.pc[e.senderId];delete this.pcStart[e.senderId];if(this.callStreamMain==this.callStreamUsers[e.senderId])this.callStreamMain=null;this.callStreamUsers[e.senderId]=null;this.initPeerConnection(e.senderId)};BX.IM.WebRTC.prototype.onPullEventSignaling=function(e){if(!this.callActive||this.callChatId!=e.chatId)return false;this.signalingPeerData(e.senderId,e.peer)};BX.IM.WebRTC.prototype.onPullEventWaitTimeout=function(e){if(this.callChatId!=e.chatId)return false;if(this.callInit&&e.callToGroup)return this.onGroupCallUserError(e.senderId);if(!this.callInit||e.callToGroup&&!e.closeConnect)return false;this.callAbort();this.callOverlayClose()};BX.IM.WebRTC.prototype.onPullEventBusySelf=function(e){if(!this.callInit||this.callChatId!=e.chatId)return false;this.callAbort();this.callOverlayClose()};BX.IM.WebRTC.prototype.onPullEventCallToPhone=function(e){if(!this.callInit||this.callChatId!=e.chatId)return false;this.callAbort();this.callOverlayClose()};BX.IM.WebRTC.prototype.onPullEventBusy=function(e){if(this.callChatId!=e.chatId)return false;if(this.callInit&&e.callToGroup)return this.onGroupCallUserError(e.senderId);if(!this.callInit||e.callToGroup&&!e.closeConnect)return false;this.BXIM.playSound("error");this.callView.setProgress("offline");this.callView.setUiState(BX.Im.Call.UiState.Finished);this.callAbort(BX.message("IM_M_CALL_ST_BUSY"))};BX.IM.WebRTC.prototype.onPullEventDecline=function(e){if(this.callChatId!=e.chatId)return false;if(this.callInit&&e.callToGroup)return this.onGroupCallUserError(e.senderId);if(!this.callInit||e.callToGroup&&!e.closeConnect)return false;if(this.callInitUserId!=this.BXIM.userId||this.callActive){var t=this.callVideo;this.callOverlayStatus(BX.message("IM_M_CALL_ST_DECLINE"));this.BXIM.playSound("stop");this.callOverlayClose()}else if(this.callInitUserId==this.BXIM.userId){this.BXIM.playSound("error");this.callOverlayProgress("offline");this.callView.setUiState(BX.IM.Call.UiState.Finished);this.callAbort(BX.message("IM_M_CALL_ST_DECLINE"))}else{this.callAbort()}};BX.IM.WebRTC.prototype.onPullEventAnswerSelf=function(e){if(this.callSelfDisabled||this.callActive)return false;this.BXIM.stopRepeatSound("ringtone");this.BXIM.stopRepeatSound("dialtone");this.callOverlayClose(true)};BX.IM.WebRTC.prototype.onPullEventDeclineSelf=function(e){if(this.callSelfDisabled||this.callChatId!=e.chatId)return false;this.BXIM.stopRepeatSound("ringtone");this.BXIM.stopRepeatSound("dialtone");this.callOverlayClose(true)};BX.IM.WebRTC.prototype.onGroupCallUserError=function(e){this.connected[e]=false;delete this.pc[e];delete this.pcStart[e];if(this.callStreamUsers[e]){this.callView.removeRemoteStream(e)}this.callView.setProgress(BX.IM.Call.UiProgress.Wait);this.callView.setStatus(BX.message(this.callToGroup?"IM_M_CALL_ST_WAIT_ACCESS_3":"IM_M_CALL_ST_WAIT_ACCESS_2"))};BX.IM.WebRTC.prototype.restoreFoldedCallView=function(){var e=this;var t=BX.localStorage.get("bxim-folded-call-card");if(!BX.type.isPlainObject(t))return;this.callActive=true;this.phoneCallId=t.phoneCallId;this.phoneCrm=t.phoneCrm;this.phoneCallDevice=t.phoneCallDevice;this.phoneCallExternal=t.phoneCallExternal;var s=t.callView;s.BXIM=this.BXIM;this.phoneCallView=new BX.PhoneCallView(t.callView);if(this.phoneCallExternal){this.phoneCallView.setUiState(BX.PhoneCallView.UiState.externalCard);this.phoneCallView.setCallState(BX.PhoneCallView.CallState.connected);this.bindPhoneViewCallbacksExternalCall(this.phoneCallView)}else{this.bindPhoneViewCallbacks(this.phoneCallView)}if(this.phoneCallExternal){BX.localStorage.set("viExternalCard",true,5);this.phoneConnectedInterval=setInterval(function(){if(e.phoneCallExternal){BX.localStorage.set("viExternalCard",true,5)}},5e3)}setTimeout(function(){BX.MessengerCommon.phoneCommand("getCall",{CALL_ID:e.phoneCallId},true,function(t){if(!t.FOUND||t.FOUND!=="Y"){e.phoneCallId="";e.callActive=false;e.phoneCallExternal=false;e.callSelfDisabled=false;clearInterval(e.BXIM.webrtc.phoneConnectedInterval);BX.localStorage.set("viExternalCard",false);if(e.phoneCallView){e.phoneCallView.dispose();e.phoneCallView=null}}})}.bind(this),0)};BX.IM.WebRTC.prototype.readDefaults=function(){if(!localStorage)return;this.defaultMicrophone=localStorage.getItem("bx-im-settings-default-microphone");this.defaultCamera=localStorage.getItem("bx-im-settings-default-camera");this.defaultSpeaker=localStorage.getItem("bx-im-settings-default-speaker");this.enableMicAutoParameters=localStorage.getItem("bx-im-settings-enable-mic-auto-parameters")!=="N"};BX.IM.WebRTC.prototype.initAudio=function(e){if(e===true){this.panel.appendChild(this.BXIM.audio.error=BX.create("audio",{props:{className:"bx-messenger-audio"},children:[BX.create("source",{attrs:{src:"/bitrix/js/im/audio/video-error.ogg",type:"audio/ogg; codecs=vorbis"}}),BX.create("source",{attrs:{src:"/bitrix/js/im/audio/video-error.mp3",type:"audio/mpeg"}})]}));return false}this.panel.appendChild(this.BXIM.audio.dialtone=BX.create("audio",{props:{className:"bx-messenger-audio"},children:[BX.create("source",{attrs:{src:"/bitrix/js/im/audio/video-dialtone.ogg",type:"audio/ogg; codecs=vorbis"}}),BX.create("source",{attrs:{src:"/bitrix/js/im/audio/video-dialtone.mp3",type:"audio/mpeg"}})]}));this.panel.appendChild(this.BXIM.audio.ringtone=BX.create("audio",{props:{className:"bx-messenger-audio"},children:[BX.create("source",{attrs:{src:"/bitrix/js/im/audio/video-ringtone.ogg",type:"audio/ogg; codecs=vorbis"}}),BX.create("source",{attrs:{src:"/bitrix/js/im/audio/video-ringtone.mp3",type:"audio/mpeg"}})]}));this.panel.appendChild(this.BXIM.audio.start=BX.create("audio",{props:{className:"bx-messenger-audio"},children:[BX.create("source",{attrs:{src:"/bitrix/js/im/audio/video-start.ogg",type:"audio/ogg; codecs=vorbis"}}),BX.create("source",{attrs:{src:"/bitrix/js/im/audio/video-start.mp3",type:"audio/mpeg"}})]}));this.panel.appendChild(this.BXIM.audio.stop=BX.create("audio",{props:{className:"bx-messenger-audio"},children:[BX.create("source",{attrs:{src:"/bitrix/js/im/audio/video-stop.ogg",type:"audio/ogg; codecs=vorbis"}}),BX.create("source",{attrs:{src:"/bitrix/js/im/audio/video-stop.mp3",type:"audio/mpeg"}})]}));this.panel.appendChild(this.BXIM.audio.error=BX.create("audio",{props:{className:"bx-messenger-audio"},children:[BX.create("source",{attrs:{src:"/bitrix/js/im/audio/video-error.ogg",type:"audio/ogg; codecs=vorbis"}}),BX.create("source",{attrs:{src:"/bitrix/js/im/audio/video-error.mp3",type:"audio/mpeg"}})]}));if(typeof this.BXIM.audio.stop.play=="undefined"){this.BXIM.settings.enableSound=false}};BX.IM.WebRTC.prototype.startGetUserMedia=function(e,t){clearTimeout(this.callDialtoneTimeout);this.BXIM.stopRepeatSound("ringtone");this.BXIM.stopRepeatSound("dialtone");var s=true;clearTimeout(this.callInviteTimeout);clearTimeout(this.callDialogAllowTimeout);if(s){this.callDialogAllowTimeout=setTimeout(BX.delegate(function(){this.callDialogAllowShow()},this),1500)}this.parent.startGetUserMedia.apply(this,arguments)};BX.IM.WebRTC.prototype.onUserMediaSuccess=function(e){clearTimeout(this.callAllowTimeout);var t=this.parent.onUserMediaSuccess.apply(this,arguments);if(!t)return false;if(this.callDialogAllow)this.callDialogAllow.close();if(this.callView){this.callView.setProgress("online");this.callView.setStatus(BX.message(this.callToGroup?"IM_M_CALL_ST_WAIT_ACCESS_3":"IM_M_CALL_ST_WAIT_ACCESS_2"));this.callView.setLocalStream(this.callStreamSelf)}this.callCommand(this.callChatId,"ready");if(BX.MessengerCommon.isDesktop()&&this.BXIM.init){BX.desktop.syncPause(true)}};BX.IM.WebRTC.prototype.onUserMediaError=function(e){clearTimeout(this.callAllowTimeout);var t=this.parent.onUserMediaError.apply(this,arguments);if(!t)return false;if(this.callDialogAllow)this.callDialogAllow.close();if(this.useFallbackConstraints===false){this.useFallbackConstraints=true;this.startGetUserMedia(this.lastUserMediaParams["video"],this.lastUserMediaParams["audio"])}else{this.BXIM.playSound("error");this.callOverlayProgress("offline");this.callCommand(this.callChatId,"errorAccess");if(location.protocol.indexOf("https")===-1){this.callAbort(BX.message("IM_M_CALL_ST_NO_ACCESS_HTTPS"))}else{this.callAbort(BX.message("IM_M_CALL_ST_NO_ACCESS"))}this.callView.setUiState(BX.IM.Call.UiState.Finished)}};BX.IM.WebRTC.prototype.setLocalAndSend=function(e,t){var s=this.parent.setLocalAndSend.apply(this,arguments);if(!s)return false;BX.ajax({url:this.BXIM.pathToCallAjax+"?CALL_SIGNALING&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_CALL:"Y",COMMAND:"signaling",CHAT_ID:this.callChatId,RECIPIENT_ID:e,PEER:JSON.stringify(t),IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()}});return true};BX.IM.WebRTC.prototype.onRemoteStreamAdded=function(e,t,s){if(!this.callView)return;this.callView.setUiState(BX.IM.Call.UiState.Connected);this.callView.setRemoteStream(e,this.callStreamUsers[e]);if(s){this.callView.setStatus(BX.message("IM_M_CALL_ST_ONLINE"));if(BX.MessengerCommon.isDesktop())BX.desktop.onCustomEvent("bxCallChangeMainVideo",[URL.createObjectURL(this.callStreamUsers[e])]);if(!this.BXIM.windowFocus)this.desktop.openCallFloatDialog()}if(this.initiator)this.callCommand(this.callChatId,"start",{CALL_TO_GROUP:this.callToGroup?"Y":"N",RECIPIENT_ID:e})};BX.IM.WebRTC.prototype.onRemoteStreamRemoved=function(e,t){this.callView.removeRemoteStream(e)};BX.IM.WebRTC.prototype.onIceCandidate=function(e,t){BX.ajax({url:this.BXIM.pathToCallAjax+"?CALL_SIGNALING&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_CALL:"Y",COMMAND:"signaling",CHAT_ID:this.callChatId,RECIPIENT_ID:e,PEER:JSON.stringify(t),IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()}})};BX.IM.WebRTC.prototype.peerConnectionError=function(e,t){if(this.callDialogAllow)this.callDialogAllow.close();if(!this.callView)return;this.callCommand(this.callChatId,"errorAccess");this.callOverlayDeleteEvents();this.callView.setProgress("offline");this.callView.setUiState(BX.IM.Call.UiState.Finished);this.callView.setStatus(BX.message("IM_M_CALL_ST_CON_ERROR"))};BX.IM.WebRTC.prototype.peerConnectionGetStats=function(){if(this.detectedBrowser!="chrome")return false;if(this.callUserId<=0||!this.pc[this.callUserId]||!this.pc[this.callUserId].getStats||this.callToGroup||this.callToPhone)return false;this.pc[this.callUserId].getStats(function(e){console.log(e)})};BX.IM.WebRTC.prototype.peerConnectionReconnect=function(e){var t=this.parent.peerConnectionReconnect.apply(this,arguments);if(!t)return false;BX.ajax({url:this.BXIM.pathToCallAjax+"?CALL_RECONNECT&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_CALL:"Y",COMMAND:"reconnect",CHAT_ID:this.callChatId,RECIPIENT_ID:e,IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()},onsuccess:BX.delegate(function(){this.initPeerConnection(e,true)},this)});return true};BX.IM.WebRTC.prototype.callSupport=function(e,t){t=t?t:this.messenger;var s=true;if(typeof e!="undefined"){if(parseInt(e)>0){s=t.users[e]&&t.users[e].status!="guest"&&!t.users[e].bot&&!t.users[e].network}else{if(t.chat[e.toString().substr(4)]&&t.chat[e.toString().substr(4)].type=="open"){s=false}else{s=t.userInChat[e.toString().substr(4)]&&t.userInChat[e.toString().substr(4)].length<=4}}}return this.BXIM.ppServerStatus&&this.enabled&&s};BX.IM.WebRTC.prototype.callInvite=function(e,t,s){console.trace("Trying to call deprecated function callInvite");return;if(BX.localStorage.get("viInitedCall"))return false;if(BX.MessengerCommon.isPage()&&BX.MessengerWindow.currentTab!="im"){BX.MessengerWindow.changeTab("im")}if(!this.callSupport()){if(!BX.MessengerCommon.isDesktop()){this.BXIM.openConfirm(BX.message("IM_CALL_NO_WEBRT"),[this.BXIM.platformName==""?null:new BX.PopupWindowButton({text:BX.message("IM_M_CALL_BTN_DOWNLOAD"),className:"popup-window-button-accept",events:{click:BX.delegate(function(){window.open(BX.browser.IsMac()?"http://dl.bitrix24.com/b24/bitrix24_desktop.dmg":"http://dl.bitrix24.com/b24/bitrix24_desktop.exe","desktopApp");BX.proxy_context.popupWindow.close()},this)}}),new BX.PopupWindowButton({text:BX.message("IM_NOTIFY_CONFIRM_CLOSE"),className:"popup-window-button",events:{click:function(){this.popupWindow.close()}}})])}return false}var i=false;if(parseInt(e)>0){if(this.messenger.users[e]&&this.messenger.users[e].status=="guest"){this.BXIM.openConfirm(BX.message("IM_CALL_USER_OFFLINE"));return false}else if(!this.messenger.users[e]){BX.MessengerCommon.getUserParam(e)}e=parseInt(e)}else{e=e.toString().substr(4);if(!this.messenger.userInChat[e]||this.messenger.userInChat[e].length<=1){return false}else if(!this.messenger.userInChat[e]||this.messenger.userInChat[e].length>4){this.BXIM.openConfirm(BX.message("IM_CALL_CHAT_LARGE"));return false}i=true}t=t==true;s=t===true&&s===true;if(!this.callActive&&!this.callInit&&e>0){this.initiator=true;this.callInitUserId=this.BXIM.userId;this.callInit=true;this.callActive=false;this.callUserId=i?0:e;this.callChatId=i?e:0;this.callToGroup=i;this.callGroupUsers=i?this.messenger.userInChat[e]:[];this.callVideo=t;this.callView=new BX.IM.Call.View({messenger:this.messenger,toUserId:e,fromUserId:this.BXIM.userId,groupCall:this.callToGroup,users:this.callToGroup?this.messenger.userInChat[e]:[e],videoCall:t,status:BX.message("IM_M_CALL_ST_CONNECT"),uiState:BX.IM.Call.UiState.Outgoing});this.bindCallViewCallbacks();this.callView.show();this.BXIM.playSound("start");BX.ajax({url:this.BXIM.pathToCallAjax+"?CALL_INVITE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_CALL:"Y",COMMAND:"invite",CHAT_ID:e,CHAT:i?"Y":"N",VIDEO:t?"Y":"N",IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()},onsuccess:BX.delegate(function(e){if(e.ERROR==""){this.callChatId=e.CHAT_ID;for(var t in e.USERS){e.USERS[t].last_activity_date=new Date(e.USERS[t].last_activity_date);e.USERS[t].mobile_last_date=new Date(e.USERS[t].mobile_last_date);e.USERS[t].idle=e.USERS[t].idle?new Date(e.USERS[t].idle):false;e.USERS[t].absent=e.USERS[t].absent?new Date(e.USERS[t].absent):false;this.messenger.users[t]=e.USERS[t]}for(var t in e.HR_PHOTO)this.messenger.hrphoto[t]=e.HR_PHOTO[t];if(e.CALL_ENABLED&&this.callToGroup){for(var t in e.USERS_CONNECT){this.connected[t]=true}this.initiator=false;this.callInitUserId=0;this.callInit=true;this.callActive=false;this.callUserId=0;this.callChatId=e.CHAT_ID;this.callToGroup=e.CALL_TO_GROUP;this.callGroupUsers=this.messenger.userInChat[e.CHAT_ID];this.callVideo=e.CALL_VIDEO;this.callDialog();return false}this.callView.setTitle(this.callOverlayTitle());this.callView.updatePhoto();var s=this.callToGroup?"chat"+this.callChatId:this.callUserId;var i=this.callToGroup;var a=this.callVideo;this.callInviteTimeout=setTimeout(BX.delegate(function(){this.callView.setProgress(BX.IM.Call.UiProgress.Offline);this.callView.setUiState(BX.IM.Call.UiState.Finished);this.callAbort(BX.message(i?"IM_M_CALL_ST_NO_WEBRTC_1":"IM_M_CALL_ST_NO_WEBRTC"));this.callCommand(this.callChatId,"errorOffline")},this),3e4)}else{this.callView.setProgress(BX.IM.Call.UiProgress.Offline);this.callView.setUiState(BX.IM.Call.UiState.Finished);this.callAbort(e.ERROR);this.callCommand(this.callChatId,"errorOffline")}},this),onfailure:BX.delegate(function(){this.callAbort(BX.message("IM_M_CALL_ERR"));this.callOverlayClose()},this)})}};BX.IM.WebRTC.prototype.callWait=function(){if(!this.callSupport())return false;this.callOverlayStatus(BX.message(this.callToGroup?"IM_M_CALL_ST_WAIT_2":"IM_M_CALL_ST_WAIT"));clearTimeout(this.callInviteTimeout);this.callInviteTimeout=setTimeout(BX.delegate(function(){if(!this.initiator){this.callAbort();this.callOverlayClose();return false}this.BXIM.playSound("error");this.callView.setProgress(BX.IM.Call.UiProgress.Offline);this.callView.setUiState(BX.IM.Call.UiState.Finished);this.callCommand(this.callChatId,"waitTimeout");this.callAbort(BX.message(this.callToGroup?"IM_M_CALL_ST_NO_ANSWER_2":"IM_M_CALL_ST_NO_ANSWER"))},this),2e4)};BX.IM.WebRTC.prototype.callChangeMainVideo=function(e){var t=this.callOverlayVideoMain.getAttribute("data-userId");if(t==e||!this.callStreamUsers[e])return false;BX.addClass(this.callOverlayVideoMain,"bx-messenger-call-video-main-block-animation");clearTimeout(this.callChangeMainVideoTimeout);this.callChangeMainVideoTimeout=setTimeout(BX.delegate(function(){this.callOverlayVideoMain.setAttribute("data-userId",e);this.attachMediaStream(this.callOverlayVideoMain,this.callStreamUsers[e]);if(BX.MessengerCommon.isDesktop())BX.desktop.onCustomEvent("bxCallChangeMainVideo",[this.callOverlayVideoMain.src]);BX.addClass(this.callOverlayVideoUsers[e].parentNode,"bx-messenger-call-video-block-hide");BX.addClass(this.callOverlayVideoUsers[e].parentNode,"bx-messenger-call-video-hide");this.callOverlayVideoUsers[e].parentNode.setAttribute("title","");if(this.callStreamUsers[t]){this.attachMediaStream(this.callOverlayVideoUsers[t],this.callStreamUsers[t]);BX.removeClass(this.callOverlayVideoUsers[t].parentNode,"bx-messenger-call-video-hide")}this.callOverlayVideoUsers[t].parentNode.setAttribute("title",BX.message("IM_CALL_MAGNIFY"));BX.removeClass(this.callOverlayVideoUsers[t].parentNode,"bx-messenger-call-video-block-hide");BX.removeClass(this.callOverlayVideoMain,"bx-messenger-call-video-main-block-animation")},this),400)};BX.IM.WebRTC.prototype.callInviteUserToChat=function(e){if(this.callChatId<=0||this.messenger.popupChatDialogSendBlock)return false;var t="";if(e.length==0){if(this.messenger.popupChatDialog!=null)this.messenger.popupChatDialog.close();return false}if(t!=""){this.BXIM.openConfirm(t);return false}if(this.screenSharing.callInit){this.screenSharing.callDecline()}this.messenger.popupChatDialogSendBlock=true;if(this.messenger.popupChatDialog!=null)this.messenger.popupChatDialog.buttons[0].setClassName("popup-window-button-disable");BX.ajax({url:this.BXIM.pathToCallAjax+"?CALL_INVITE_USER&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{IM_CALL:"Y",COMMAND:"invite_user",USERS:JSON.stringify(e),CHAT_ID:this.callChatId,RECIPIENT_ID:this.callUserId,IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()},onsuccess:BX.delegate(function(e){this.messenger.popupChatDialogSendBlock=false;if(this.messenger.popupChatDialog!=null)this.messenger.popupChatDialog.buttons[0].setClassName("popup-window-button-accept");if(e.ERROR==""){this.messenger.popupChatDialogSendBlock=false;if(this.messenger.popupChatDialog!=null)this.messenger.popupChatDialog.close()}else{this.BXIM.openConfirm(e.ERROR)}},this)})};BX.IM.WebRTC.prototype.callCommand=function(e,t,s,i){if(!this.callSupport())return false;e=parseInt(e);i=i!=false;s=typeof s=="object"?s:{};if(e>0){BX.ajax({url:this.BXIM.pathToCallAjax+"?CALL_SHARED&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,async:i,data:{IM_CALL:"Y",COMMAND:t,CHAT_ID:e,RECIPIENT_ID:this.callUserId,PARAMS:JSON.stringify(s),IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()},onsuccess:BX.delegate(function(){if(this.callDialogAllow)this.callDialogAllow.close()},this)})}};BX.IM.WebRTC.prototype.callDialog=function(){if(!this.callSupport())return false;clearTimeout(this.callInviteTimeout);clearTimeout(this.callDialogAllowTimeout);if(this.callDialogAllow)this.callDialogAllow.close();this.callActive=true;if(!this.callView)return;if(this.messenger.popupMessenger==null){this.messenger.openMessenger(this.callUserId)}this.callView.setProgress("wait");this.callView.setStatus(BX.message("IM_M_CALL_ST_WAIT_ACCESS"));if(this.callToMobile)this.callView.setCallWithMobile(true);this.callView.setFloating(false);this.callView.setUiSize(BX.IM.Call.UiSize.Full);this.callView.setUiState(BX.IM.Call.UiState.Connecting);this.startGetUserMedia(this.callVideo)};BX.IM.WebRTC.prototype.toggleScreenSharing=function(){if(this.screenSharing.callInit&&this.screenSharing.initiator){this.screenSharing.callDecline()}else{this.screenSharing.callInvite()}return true};BX.IM.WebRTC.prototype.callOverlayShow=function(e){if(!e||!(e.toUserId||e.phoneNumber)||!(e.fromUserId||e.phoneNumber)||!e.buttons)return false;if(this.callOverlay!=null){this.callOverlayClose(false,true)}this.messenger.closeMenuPopup();e.video=e.video!=false;e.callToGroup=e.callToGroup==true;e.callToPhone=e.callToPhone==true;e.minimize=typeof e.minimize=="undefined"?this.messenger.popupMessenger==null:e.minimize==true;e.status=e.status?e.status:"";e.progress=e.progress?e.progress:"connect";this.callOverlayMinimize=e.prepare?true:e.minimize;var t=null;if(this.BXIM.dialogOpen)t=this.messenger.popupMessengerBody;else if(this.BXIM.notifyOpen)t=this.messenger.popupNotifyItem;if(t){if(BX.MessengerCommon.isScrollMin(t)){setTimeout(BX.delegate(function(){BX.addClass(this.messenger.popupMessengerContent,"bx-messenger-call")},this),e.minimize?0:400)}else{BX.addClass(this.messenger.popupMessengerContent,"bx-messenger-call");t.scrollTop=t.scrollTop+50}}else{BX.addClass(this.messenger.popupMessengerContent,"bx-messenger-call")}if(!this.callOverlayMinimize)BX.addClass(this.messenger.popupMessengerContent,"bx-messenger-call-maxi");var s={width:!this.messenger.popupMessenger?"610px":(this.messenger.popupMessengerExtra.style.display=="block"?this.messenger.popupMessengerExtra.offsetWidth+1:this.messenger.popupMessengerDialog.offsetWidth+1)+"px",height:this.messenger.popupMessengerFullHeight+2+"px",marginLeft:this.messenger.popupContactListSize+"px"};if(this.messenger.popupMessenger==null){s["marginTop"]="-1px"}var i=e.callToGroup?this.callGroupOverlayShow(e):this.callUserOverlayShow(e);this.callOverlay=BX.create("div",{props:{className:"bx-messenger-call-overlay "+(e.callToGroup?" bx-messenger-call-overlay-group ":"")+(this.callOverlayMinimize?"bx-messenger-call-overlay-mini":"bx-messenger-call-overlay-maxi")},style:s,children:[BX.create("div",{props:{className:"bx-messenger-call-overlay-lvl-1"},children:[BX.create("div",{props:{className:"bx-messenger-call-overlay-lvl-2"},children:[BX.create("div",{props:{className:"bx-messenger-call-video-main"},children:[BX.create("div",{props:{className:"bx-messenger-call-video-main-wrap"},children:[BX.create("div",{props:{className:"bx-messenger-call-video-main-watermark"},children:[BX.create("img",{props:{className:"bx-messenger-call-video-main-watermark-img"},attrs:{src:"/bitrix/js/im/images/watermark_"+(this.BXIM.language=="ru"?"ru":"en")+".png"}})]}),BX.create("div",{props:{className:"bx-messenger-call-video-main-cell"},children:[BX.create("div",{props:{className:"bx-messenger-call-video-main-bg"},children:[this.callOverlayVideoMain=BX.create("video",{attrs:{autoplay:true},props:{className:"bx-messenger-call-video-main-block"}}),this.callOverlayVideoReserve=BX.create("video",{attrs:{autoplay:true},props:{className:"bx-messenger-hide"}})]})]})]})]})]})]}),this.callOverlayBody=BX.create("div",{props:{className:"bx-messenger-call-overlay-body"},children:i})]});if(e.prepare){BX.addClass(this.callOverlay,"bx-messenger-call-overlay-float");BX.addClass(this.callOverlay,"bx-messenger-call-overlay-show")}else if(this.messenger.popupMessenger!=null){this.messenger.setClosingByEsc(false);this.messenger.popupMessengerContent.insertBefore(this.callOverlay,this.messenger.popupMessengerContent.firstChild)}else if(this.callNotify!=null){BX.addClass(this.callOverlay,"bx-messenger-call-overlay-float");this.callNotify.setContent(this.callOverlay)}else{this.callNotify=new BX.PopupWindow("bx-messenger-call-notify",null,{darkMode:this.BXIM.settings.enableDarkTheme,lightShadow:true,zIndex:BX.MessengerCommon.getDefaultZIndex()+200,events:{onPopupClose:function(){this.destroy()},onPopupDestroy:BX.delegate(function(){BX.unbind(window,"scroll",this.popupCallNotifyEvent);this.callNotify=null},this)},content:this.callOverlay});this.callNotify.show();BX.addClass(this.callOverlay,"bx-messenger-call-overlay-float");BX.addClass(this.callOverlay,"bx-messenger-call-overlay-show");BX.addClass(this.callNotify.popupContainer.children[0],"bx-messenger-popup-window-transparent");setTimeout(BX.delegate(function(){if(this.callNotify){this.callNotify.adjustPosition()}},this),500);BX.bind(window,"scroll",this.popupCallNotifyEvent=BX.proxy(function(){this.callNotify.adjustPosition()},this))}setTimeout(BX.delegate(function(){BX.addClass(this.callOverlay,"bx-messenger-call-overlay-show")},this),100);this.callOverlayStatus(e.status);this.callView.setUiState(BX.IM.Call.UiState.Finished);this.callOverlayProgress(e.progress);return true};BX.IM.WebRTC.prototype.callGroupOverlayShow=function(e){var t=e.fromUserId!=this.BXIM.userId;var s=e.fromUserId!=this.BXIM.userId?e.fromUserId:e.toUserId;var i=this.callOverlayTitle();this.callOverlayChatId=s;var a=[];var n=[];for(var o=0;o<this.messenger.userInChat[s].length;o++){var r=this.messenger.userInChat[s][o];var l=BX.MessengerCommon.getHrPhoto(r,this.messenger.users[r].color);a.push(BX.create("div",{props:{className:"bx-messenger-call-overlay-photo-left"},children:[BX.create("div",{props:{className:"bx-messenger-call-overlay-photo-block"},children:[this.callOverlayPhotoUsers[r]=BX.create("img",{props:{className:"bx-messenger-call-overlay-photo-img"},attrs:{"data-userId":r,src:l.src,style:l.color?"background-color: "+l.color:""}})]})]}));if(r==this.BXIM.userId)continue;var l=BX.MessengerCommon.getHrPhoto(r,this.messenger.users[r].color);n.push(BX.create("div",{props:{className:"bx-messenger-call-video-mini bx-messenger-call-video-hide"},attrs:{"data-userId":r},events:{click:BX.delegate(function(){this.callChangeMainVideo(BX.proxy_context.getAttribute("data-userId"))},this)},children:[this.callOverlayVideoUsers[r]=BX.create("video",{attrs:{autoplay:true},props:{className:"bx-messenger-call-video-mini-block"}}),BX.create("div",{props:{className:"bx-messenger-call-video-mini-photo"},children:[this.callOverlayVideoPhotoUsers[r]=BX.create("img",{props:{className:"bx-messenger-call-video-mini-photo-img"},attrs:{src:l.src,style:l.color?"background-color: "+l.color:""}})]})]}))}var l=BX.MessengerCommon.getHrPhoto(this.BXIM.userId,this.messenger.users[this.BXIM.userId].color);return[BX.create("div",{props:{className:"bx-messenger-call-overlay-line-maxi"},attrs:{title:BX.message("IM_M_CALL_BTN_RETURN")},children:[BX.create("div",{props:{className:"bx-messenger-call-overlay-line-maxi-block"}})]}),BX.create("div",{props:{className:"bx-messenger-call-video-users"},children:n}),BX.create("div",{props:{className:"bx-messenger-call-overlay-title"},children:[this.callOverlayTitleBlock=BX.create("div",{props:{className:"bx-messenger-call-overlay-title-block"},html:i})]}),BX.create("div",{props:{className:"bx-messenger-call-overlay-photo"},children:a}),BX.create("div",{props:{className:"bx-messenger-call-overlay-photo-progress-group"},children:[this.callOverlayProgressBlock=BX.create("div",{props:{className:"bx-messenger-call-overlay-photo-progress"}})]}),BX.create("div",{props:{className:"bx-messenger-call-overlay-status"},children:[this.callOverlayStatusBlock=BX.create("div",{props:{className:"bx-messenger-call-overlay-status-block"}})]}),BX.create("div",{props:{className:"bx-messenger-call-video-mini"},children:[this.callOverlayVideoSelf=BX.create("video",{attrs:{autoplay:true},props:{className:"bx-messenger-call-video-mini-block"}}),BX.create("div",{props:{className:"bx-messenger-call-video-mini-photo"},children:[this.callOverlayPhotoMini=BX.create("img",{props:{className:"bx-messenger-call-video-mini-photo-img"},attrs:{src:l.src,style:l.color?"background-color: "+l.color:""}})]})]}),BX.create("div",{props:{className:"bx-messenger-call-overlay-buttons"},children:[this.callOverlayButtonsBlock=BX.create("div",{props:{className:"bx-messenger-call-overlay-buttons-block"}})]})]};BX.IM.WebRTC.prototype.callUserOverlayShow=function(e){var t=e.toUserId==this.BXIM.userId;var s=t?e.fromUserId:e.toUserId;var i=this.callOverlayTitle();this.callOverlayUserId=s;var a=BX.MessengerCommon.getHrPhoto(s,this.messenger.users[s].color);var n=BX.MessengerCommon.getHrPhoto(this.BXIM.userId,this.messenger.users[this.BXIM.userId].color);return[BX.create("div",{props:{className:"bx-messenger-call-overlay-line-maxi"},attrs:{title:BX.message("IM_M_CALL_BTN_RETURN")},children:[BX.create("div",{props:{className:"bx-messenger-call-overlay-line-maxi-block"}})]}),BX.create("div",{props:{className:"bx-messenger-call-overlay-title"},children:[this.callOverlayTitleBlock=BX.create("div",{props:{className:"bx-messenger-call-overlay-title-block"},html:i})]}),BX.create("div",{props:{className:"bx-messenger-call-overlay-photo"},children:[BX.create("div",{props:{className:"bx-messenger-call-overlay-photo-left"},children:[BX.create("div",{props:{className:"bx-messenger-call-overlay-photo-block"},children:[this.callOverlayPhotoCompanion=BX.create("img",{props:{className:"bx-messenger-call-overlay-photo-img"},attrs:{"data-userId":s,src:a.src,style:a.color?"background-color: "+a.color:""}})]})]}),this.callOverlayProgressBlock=BX.create("div",{props:{className:"bx-messenger-call-overlay-photo-progress"+(t?"":" bx-messenger-call-overlay-photo-progress-incoming")}}),BX.create("div",{props:{className:"bx-messenger-call-overlay-photo-right"},children:[BX.create("div",{props:{className:"bx-messenger-call-overlay-photo-block"},children:[this.callOverlayPhotoSelf=BX.create("img",{props:{className:"bx-messenger-call-overlay-photo-img"},attrs:{"data-userId":this.BXIM.userId,src:n.src,style:n.color?"background-color: "+n.color:""}})]})]})]}),BX.create("div",{props:{className:"bx-messenger-call-overlay-status"},children:[this.callOverlayStatusBlock=BX.create("div",{props:{className:"bx-messenger-call-overlay-status-block"}})]}),BX.create("div",{props:{className:"bx-messenger-call-video-mini"},children:[this.callOverlayVideoSelf=BX.create("video",{attrs:{autoplay:true},props:{className:"bx-messenger-call-video-mini-block"}}),BX.create("div",{props:{className:"bx-messenger-call-video-mini-photo"},children:[this.callOverlayPhotoMini=BX.create("img",{props:{className:"bx-messenger-call-video-mini-photo-img"},attrs:{src:n.src,style:n.color?"background-color: "+n.color:""}})]})]}),BX.create("div",{props:{className:"bx-messenger-call-overlay-buttons"},children:[this.callOverlayButtonsBlock=BX.create("div",{props:{className:"bx-messenger-call-overlay-buttons-block"}})]})]};BX.IM.WebRTC.prototype.bindCallViewCallbacks=function(){if(!this.callView)return;this.callView.setCallback("onClose",this.onCallViewClose.bind(this));this.callView.setCallback("onDestroy",this.onCallViewDestroy.bind(this));this.callView.setCallback("onButtonClick",this.onCallViewButtonClick.bind(this));this.callView.setCallback("onMaximizeClick",this.onCallViewMaximizeClick.bind(this))};BX.IM.WebRTC.prototype.onCallViewButtonClick=function(e){var t=e.buttonName;var s={answer:this.onCallViewAnswerButtonClick.bind(this),decline:this.onCallViewDeclineButtonClick.bind(this),hangup:this.onCallViewHangupButtonClick.bind(this),showChat:this.onCallViewShowChatButtonClick.bind(this),hideChat:this.onCallViewHideChatButtonClick.bind(this),inviteUsers:this.onCallViewInviteUsersButtonClick.bind(this),toggleMute:this.onCallViewToggleMuteButtonClick.bind(this),toggleScreenSharing:this.onCallViewToggleScreenSharingButtonClick.bind(this),showHistory:this.onCallViewShowHistoryButtonClick.bind(this),redial:this.onCallViewRedialButtonClick.bind(this),close:this.onCallViewCloseButtonClick.bind(this),download:this.onCallViewDownloadButtonClick.bind(this)};if(BX.type.isFunction(s[t])){s[t].call(this,e)}};BX.IM.WebRTC.prototype.onCallViewAnswerButtonClick=function(e){this.BXIM.stopRepeatSound("ringtone");if(e.join){var t=this.callToGroup;var s=this.callChatId;var i=this.callUserId;var a=this.callVideo;this.callAbort();this.callOverlayClose(false);this.callInvite(t?"chat"+s:i,a)}else{this.callDialog();BX.ajax({url:this.BXIM.pathToCallAjax+"?CALL_ANSWER&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_CALL:"Y",COMMAND:"answer",CHAT_ID:this.callChatId,CALL_TO_GROUP:this.callToGroup?"Y":"N",RECIPIENT_ID:this.callUserId,IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()}});this.desktop.closeTopmostWindow()}};BX.IM.WebRTC.prototype.onCallViewDeclineButtonClick=function(e){this.BXIM.stopRepeatSound("ringtone");this.callSelfDisabled=true;this.callCommand(this.callChatId,"decline",{ACTIVE:this.callActive?"Y":"N",INITIATOR:this.initiator?"Y":"N"});this.callAbort();this.callOverlayClose()};BX.IM.WebRTC.prototype.onCallViewHangupButtonClick=function(e){var t=this.callVideo;this.callSelfDisabled=true;this.callCommand(this.callChatId,"decline",{ACTIVE:this.callActive?"Y":"N",INITIATOR:this.initiator?"Y":"N"});this.BXIM.playSound("stop");this.callAbort();this.callOverlayClose()};BX.IM.WebRTC.prototype.onCallViewShowChatButtonClick=function(e){this.callOverlayToggleSize()};BX.IM.WebRTC.prototype.onCallViewHideChatButtonClick=function(e){this.callOverlayToggleSize()};BX.IM.WebRTC.prototype.onCallViewInviteUsersButtonClick=function(e){if(this.messenger.userInChat[this.callChatId]&&this.messenger.userInChat[this.callChatId].length==4){this.BXIM.openConfirm(BX.message("IM_CALL_GROUP_MAX_USERS"));return false}this.messenger.openChatDialog({chatId:this.callChatId,type:"CALL_INVITE_USER",bind:e.node,maxUsers:4})};BX.IM.WebRTC.prototype.onCallViewToggleMuteButtonClick=function(e){this.audioMuted=e.audioMuted;this.toggleAudio(false)};BX.IM.WebRTC.prototype.onCallViewToggleScreenSharingButtonClick=function(e){if(!this.desktop.enableInVersion(30)){this.BXIM.openConfirm({title:BX.message("IM_M_CALL_SCREEN"),message:BX.message("IM_M_CALL_SCREEN_ERROR")});return false}this.toggleScreenSharing()};BX.IM.WebRTC.prototype.onCallViewShowHistoryButtonClick=function(e){this.messenger.openHistory(this.messenger.currentTab)};BX.IM.WebRTC.prototype.onCallViewRedialButtonClick=function(e){var t=this.callToGroup?"chat"+this.callChatId:this.callUserId;var s=this.callVideo;if(this.phoneCount(this.messenger.phones[t])>0){this.messenger.openPopupMenu(e.node,"callPhoneMenu",true,{userId:t,video:s})}else{this.callInvite(t,s)}};BX.IM.WebRTC.prototype.onCallViewCloseButtonClick=function(e){this.callOverlayClose()};BX.IM.WebRTC.prototype.onCallViewDownloadButtonClick=function(e){window.open(BX.browser.IsMac()?"http://dl.bitrix24.com/b24/bitrix24_desktop.dmg":"http://dl.bitrix24.com/b24/bitrix24_desktop.exe","desktopApp");this.callOverlayClose()};BX.IM.WebRTC.prototype.onCallViewClose=function(e){this.callView.destroy()};BX.IM.WebRTC.prototype.onCallViewDestroy=function(e){this.callView=null};BX.IM.WebRTC.prototype.onCallViewMaximizeClick=function(e){if(this.BXIM.dialogOpen){if(this.callOverlayUserId>0){this.messenger.openChatFlag=false;BX.MessengerCommon.openDialog(this.callOverlayUserId,false)}else{this.messenger.openChatFlag=true;BX.MessengerCommon.openDialog("chat"+this.callOverlayChatId,false)}}else{if(this.callOverlayUserId>0){this.messenger.openChatFlag=false;this.messenger.currentTab=this.callOverlayUserId}else{this.messenger.openChatFlag=true;this.messenger.currentTab="chat"+this.callOverlayChatId}this.messenger.extraClose(true,false)}this.callView.setUiSize(BX.IM.Call.UiSize.Full)};BX.IM.WebRTC.prototype.callPhoneOverlayMeter=function(e){if(!this.phoneCurrentCall||this.phoneCurrentCall.state()!="CONNECTED")return false;var t=5;if(100==e)t=5;else if(e>=99)t=4;else if(e>=97)t=3;else if(e>=95)t=2;else t=1;this.phoneCallView.setQuality(t);return t};BX.IM.WebRTC.prototype.overlayEnterFullScreen=function(){if(this.callOverlayFullScreen){BX.removeClass(this.messenger.popupMessengerContent,"bx-messenger-fullscreen");if(document.cancelFullScreen)document.cancelFullScreen();else if(document.mozCancelFullScreen)document.mozCancelFullScreen();else if(document.webkitCancelFullScreen)document.webkitCancelFullScreen()}else{BX.addClass(this.messenger.popupMessengerContent,"bx-messenger-fullscreen");if(this.detectedBrowser=="chrome"){BX.bind(window,"webkitfullscreenchange",this.callOverlayFullScreenBind=BX.proxy(this.overlayEventFullScreen,this));this.messenger.popupMessengerContent.webkitRequestFullScreen(this.messenger.popupMessengerContent.ALLOW_KEYBOARD_INPUT)}else if(this.detectedBrowser=="firefox"){BX.bind(window,"mozfullscreenchange",this.callOverlayFullScreenBind=BX.proxy(this.overlayEventFullScreen,this));this.messenger.popupMessengerContent.mozRequestFullScreen(this.messenger.popupMessengerContent.ALLOW_KEYBOARD_INPUT)}}};BX.IM.WebRTC.prototype.overlayEventFullScreen=function(){if(this.callOverlayFullScreen){if(this.detectedBrowser=="chrome")BX.unbind(window,"webkitfullscreenchange",this.callOverlayFullScreenBind);else if(this.detectedBrowser=="firefox")BX.unbind(window,"mozfullscreenchange",this.callOverlayFullScreenBind);BX.removeClass(this.messenger.popupMessengerContent,"bx-messenger-fullscreen");if(BX.browser.IsChrome()){BX.addClass(this.messenger.popupMessengerContent,"bx-messenger-fullscreen-chrome-hack");setTimeout(BX.delegate(function(){BX.removeClass(this.messenger.popupMessengerContent,"bx-messenger-fullscreen-chrome-hack")},this),100)}this.callOverlayFullScreen=false;this.messenger.resizeMainWindow()}else{BX.addClass(this.messenger.popupMessengerContent,"bx-messenger-fullscreen");this.callOverlayFullScreen=true;this.messenger.resizeMainWindow()}this.messenger.popupMessengerBody.scrollTop=this.messenger.popupMessengerBody.scrollHeight-this.messenger.popupMessengerBody.offsetHeight};BX.IM.WebRTC.prototype.callOverlayToggleSize=function(e){if(this.callView==null)return false;if(!this.ready()){this.callOverlayClose(true);return false}var t=typeof e=="boolean"?!e:this.callOverlayMinimize;var s=false;if(this.messenger.popupMessenger!=null&&!this.BXIM.dialogOpen)s=true;else if(this.messenger.popupMessenger!=null&&this.callOverlayUserId>0&&this.callOverlayUserId!=this.messenger.currentTab)s=true;else if(this.messenger.popupMessenger!=null&&this.callOverlayChatId>0&&this.callOverlayChatId!=this.messenger.currentTab.toString().substr(4))s=true;else if(this.messenger.popupMessenger!=null&&this.callOverlayUserId==0&&this.callOverlayChatId==0&&this.phoneNumber)s=true;if(t){this.callOverlayMinimize=false;this.callView.setUiSize(BX.IM.Call.UiSize.Full)}else{this.callOverlayMinimize=true;if(s){this.callView.setUiSize(BX.IM.Call.UiSize.Line)}else{this.callView.setUiSize(BX.IM.Call.UiSize.Minimized)}if(this.BXIM.isFocus())BX.MessengerCommon.readMessage(this.messenger.currentTab);if(this.BXIM.isFocus()&&this.notify.notifyUpdateCount>0)this.notify.viewNotifyAll()}if(this.callOverlayUserId>0&&this.callOverlayUserId==this.messenger.currentTab){this.desktop.closeTopmostWindow()}else if(this.callOverlayChatId>0&&this.callOverlayChatId==this.messenger.currentTab.toString().substr(4)){this.desktop.closeTopmostWindow()}else{this.desktop.openCallFloatDialog()}};BX.IM.WebRTC.prototype.callOverlayClose=function(e,t){if(this.callOverlay==null&&this.callView==null)return false;this.audioMuted=true;this.toggleAudio(false);t=t==true;if(!t&&this.callOverlayFullScreen){if(this.detectedBrowser=="firefox"){BX.removeClass(this.messenger.popupMessengerContent,"bx-messenger-fullscreen");BX.remove(this.messenger.popupMessengerContent);BX.hide(this.messenger.popupMessenger.popupContainer);setTimeout(BX.delegate(function(){this.messenger.popupMessenger.destroy();this.messenger.openMessenger(this.messenger.currentTab)},this),200)}else{this.overlayEnterFullScreen()}}if(this.messenger.popupMessenger!=null){var s=null;if(this.BXIM.dialogOpen)s=this.messenger.popupMessengerBody;else if(this.BXIM.notifyOpen)s=this.messenger.popupNotifyItem;if(s){if(BX.MessengerCommon.isScrollMax(s)){BX.removeClass(this.messenger.popupMessengerContent,"bx-messenger-call")}else{BX.removeClass(this.messenger.popupMessengerContent,"bx-messenger-call");s.scrollTop=s.scrollTop-50}}else{BX.removeClass(this.messenger.popupMessengerContent,"bx-messenger-call")}BX.removeClass(this.messenger.popupMessengerContent,"bx-messenger-call-maxi")}this.messenger.closeMenuPopup();e=e!=false;if(e)this.callView.closeAnimated();else this.callView.close();if(e){setTimeout(BX.delegate(function(){BX.remove(this.callOverlay);this.callOverlay=null;this.callOverlayButtonsBlock=null;this.callOverlayTitleBlock=null;this.callOverlayMeter=null;this.callOverlayStatusBlock=null;this.callOverlayProgressBlock=null;this.callOverlayMinimize=null;this.callOverlayChatId=0;this.callOverlayUserId=0;this.callOverlayPhotoSelf=null;this.callOverlayPhotoUsers={};this.callOverlayVideoUsers={};this.callOverlayVideoPhotoUsers={};this.callOverlayPhotoCompanion=null;this.callSelfDisabled=false;if(this.BXIM.isFocus())BX.MessengerCommon.readMessage(this.messenger.currentTab)},this),300)}else{BX.remove(this.callOverlay);this.callOverlay=null;this.callOverlayButtonsBlock=null;this.callOverlayStatusBlock=null;this.callOverlayProgressBlock=null;this.callOverlayMinimize=null;this.callOverlayChatId=0;this.callOverlayUserId=0;this.callOverlayPhotoSelf=null;this.callOverlayPhotoUsers={};this.callOverlayVideoUsers={};this.callOverlayVideoPhotoUsers={};this.callOverlayPhotoCompanion=null;this.callSelfDisabled=false;if(this.BXIM.isFocus())BX.MessengerCommon.readMessage(this.messenger.currentTab)}if(t){this.BXIM.stopRepeatSound("ringtone");this.BXIM.stopRepeatSound("dialtone")}else{this.callOverlayDeleteEvents()}this.desktop.closeTopmostWindow()};BX.IM.WebRTC.prototype.callAbort=function(e){this.callOverlayDeleteEvents();if(e&&this.phoneCallView){if(this.phoneCallView)this.phoneCallView.setStatusText(e);else if(this.callView)this.callView.setStatus(e)}};BX.IM.WebRTC.prototype.callOverlayDeleteEvents=function(e){e=e||{};this.desktop.closeTopmostWindow();var t=e.closeNotify!==false;if(t&&this.callNotify)this.callNotify.destroy();var s=null;if(this.phoneCallId){s=this.phoneCallId}else if(this.callToGroup){s="chat"+this.callChatId}else{s="user"+this.callUserId}BX.onCustomEvent(window,"onImCallEnd",{CALL_ID:s});clearInterval(this.callAspectCheckInterval);if(BX.MessengerCommon.isDesktop()&&this.BXIM.init){BX.desktop.syncPause(false)}this.deleteEvents();this.callToMobile=false;this.callToPhone=false;if(this.messenger.popupMessenger){this.messenger.popupMessenger.setClosingByEsc(true);this.messenger.dialogStatusRedraw()}this.phoneCallFinish();clearTimeout(this.callDialtoneTimeout);this.BXIM.stopRepeatSound("ringtone");this.BXIM.stopRepeatSound("dialtone");clearTimeout(this.callInviteTimeout);clearTimeout(this.callDialogAllowTimeout);if(this.callDialogAllow)this.callDialogAllow.close()};BX.IM.WebRTC.prototype.callOverlayProgress=function(e){if(this.phoneCallView)this.phoneCallView.setProgress(e);else if(this.callView)this.callView.setProgress(e)};BX.IM.WebRTC.prototype.callOverlayStatus=function(e){if(!BX.type.isNotEmptyString(e))return false;if(this.phoneCallView)this.phoneCallView.setStatusText(e);else if(this.callView)this.callView.setStatus(e)};BX.IM.WebRTC.prototype.callOverlayTitle=function(){var e="";var t=this.callInitUserId!=this.BXIM.userId;if(this.callToGroup){e=this.messenger.chat[this.callChatId].name;if(e.length>85)e=e.substr(0,85)+"...";e=BX.message("IM_CALL_GROUP_"+(this.callVideo?"VIDEO":"VOICE")+(t?"_FROM":"_TO")).replace("#CHAT#",e)}else{e=BX.message("IM_M_CALL_"+(this.callVideo?"VIDEO":"VOICE")+(t?"_FROM":"_TO")).replace("#USER#",this.messenger.users[this.callUserId].name)}return e};BX.IM.WebRTC.prototype.setCallOverlayTitle=function(e){if(this.phoneCallView){this.phoneCallView.setTitle(e)}};BX.IM.WebRTC.prototype.callOverlayTimer=function(e){tate=typeof e=="undefined"?"start":e;if(e=="start"){this.phoneCallTimeInterval=setInterval(BX.delegate(function(){this.phoneCallTime++},this),1e3)}else if(e=="pause"){clearInterval(this.phoneCallTimeInterval)}else{clearInterval(this.phoneCallTimeInterval)}};BX.IM.WebRTC.prototype.callOverlayDrawCrm=function(){if(!this.callOverlayCrmBlock||!this.phoneCrm.FOUND)return false;this.callOverlayCrmBlock.innerHTML="";if(this.phoneCrm.FOUND=="Y"){BX.removeClass(this.callOverlay,"bx-messenger-call-overlay-mini");BX.addClass(this.callOverlay,"bx-messenger-call-overlay-maxi");BX.addClass(this.messenger.popupMessengerContent,"bx-messenger-call-maxi");BX.addClass(this.callOverlay,"bx-messenger-call-overlay-crm");BX.removeClass(this.callOverlay,"bx-messenger-call-overlay-crm-short");var e=this.phoneCrm.CONTACT&&this.phoneCrm.CONTACT.NAME?this.phoneCrm.CONTACT.NAME:"";if(this.phoneCrm.ACTIVITY_URL){e='<a href="'+this.phoneCrm.SHOW_URL+'" target="_blank" class="bx-messenger-call-crm-about-link">'+e+"</a>"}var t=BX.create("div",{props:{className:"bx-messenger-call-crm-about"},children:[BX.create("div",{props:{className:"bx-messenger-call-crm-about-block bx-messenger-call-crm-about-contact"},children:[BX.create("div",{props:{className:"bx-messenger-call-crm-about-block-header"},html:BX.message("IM_CRM_ABOUT_CONTACT")}),BX.create("div",{props:{className:"bx-messenger-call-crm-about-block-avatar"},html:this.phoneCrm.CONTACT&&this.phoneCrm.CONTACT.PHOTO?'<img src="'+this.phoneCrm.CONTACT.PHOTO+'" class="bx-messenger-call-crm-about-block-avatar-img">':""}),BX.create("div",{props:{className:"bx-messenger-call-crm-about-block-line-1"},html:e}),BX.create("div",{props:{className:"bx-messenger-call-crm-about-block-line-2"},html:this.phoneCrm.CONTACT&&this.phoneCrm.CONTACT.POST?this.phoneCrm.CONTACT.POST:""})]}),this.phoneCrm.COMPANY?BX.create("div",{props:{className:"bx-messenger-call-crm-about-block bx-messenger-call-crm-about-company"},children:[BX.create("div",{props:{className:"bx-messenger-call-crm-about-block-header"},html:BX.message("IM_CRM_ABOUT_COMPANY")}),BX.create("div",{props:{className:"bx-messenger-call-crm-about-block-line-1"},html:this.phoneCrm.COMPANY})]}):null]});var s=BX.create("div",{props:{className:"bx-messenger-call-crm-about"},children:[BX.create("div",{props:{className:"bx-messenger-call-crm-about-block bx-messenger-call-crm-about-contact"},children:this.phoneCrm.RESPONSIBILITY&&this.phoneCrm.RESPONSIBILITY.NAME?[BX.create("div",{props:{className:"bx-messenger-call-crm-about-block-header"},html:BX.message("IM_CRM_RESPONSIBILITY")}),BX.create("div",{props:{className:"bx-messenger-call-crm-about-block-avatar"},html:this.phoneCrm.RESPONSIBILITY.PHOTO?'<img src="'+this.phoneCrm.RESPONSIBILITY.PHOTO+'" class="bx-messenger-call-crm-about-block-avatar-img">':""}),BX.create("div",{props:{className:"bx-messenger-call-crm-about-block-line-1"},html:this.phoneCrm.RESPONSIBILITY.NAME?this.phoneCrm.RESPONSIBILITY.NAME:""}),BX.create("div",{props:{className:"bx-messenger-call-crm-about-block-line-2"},html:this.phoneCrm.RESPONSIBILITY.POST?this.phoneCrm.RESPONSIBILITY.POST:""})]:[]})]});var i=null;if(this.phoneCrm.ACTIVITY_URL||this.phoneCrm.INVOICE_URL||this.phoneCrm.DEAL_URL){i=BX.create("div",{props:{className:"bx-messenger-call-crm-buttons"},children:[this.phoneCrm.ACTIVITY_URL?BX.create("a",{attrs:{target:"_blank",href:this.phoneCrm.ACTIVITY_URL},props:{className:"bx-messenger-call-crm-button"},html:BX.message("IM_CRM_BTN_ACTIVITY")}):null,this.phoneCrm.DEAL_URL?BX.create("a",{attrs:{target:"_blank",href:this.phoneCrm.DEAL_URL},props:{className:"bx-messenger-call-crm-button"},html:BX.message("IM_CRM_BTN_DEAL")}):null,this.phoneCrm.INVOICE_URL?BX.create("a",{attrs:{target:"_blank",href:this.phoneCrm.INVOICE_URL},props:{className:"bx-messenger-call-crm-button"},html:BX.message("IM_CRM_BTN_INVOICE")}):null,this.phoneCrm.CURRENT_CALL_URL?BX.create("a",{attrs:{target:"_blank",href:this.phoneCrm.CURRENT_CALL_URL},props:{className:"bx-messenger-call-crm-link"},html:"+ "+BX.message("IM_CRM_BTN_CURRENT_CALL")}):null]})}var a=null;if(this.phoneCrm.ACTIVITIES&&this.phoneCrm.ACTIVITIES.length>0){crmArActivities=[];for(var n=0;n<this.phoneCrm.ACTIVITIES.length;n++){crmArActivities.push(BX.create("div",{props:{className:"bx-messenger-call-crm-activities-item"},children:[BX.create("a",{attrs:{target:"_blank",href:this.phoneCrm.ACTIVITIES[n].URL},props:{className:"bx-messenger-call-crm-activities-name"},html:this.phoneCrm.ACTIVITIES[n].TITLE}),BX.create("div",{props:{className:"bx-messenger-call-crm-activities-status"},html:(this.phoneCrm.ACTIVITIES[n].OVERDUE=="Y"?'<span class="bx-messenger-call-crm-activities-dot"></span>':"")+this.phoneCrm.ACTIVITIES[n].DATE})]}))}a=BX.create("div",{props:{className:"bx-messenger-call-crm-activities"},children:[BX.create("div",{props:{className:"bx-messenger-call-crm-activities-header"},html:BX.message("IM_CRM_ACTIVITIES")}),BX.create("div",{props:{className:"bx-messenger-call-crm-activities-items"},children:crmArActivities})]})}var o=null;if(this.phoneCrm.DEALS&&this.phoneCrm.DEALS.length>0){crmArDeals=[];for(var n=0;n<this.phoneCrm.DEALS.length;n++){crmArDeals.push(BX.create("div",{props:{className:"bx-messenger-call-crm-deals-item"},children:[BX.create("a",{attrs:{target:"_blank",href:this.phoneCrm.DEALS[n].URL},props:{className:"bx-messenger-call-crm-deals-name"},html:this.phoneCrm.DEALS[n].TITLE}),BX.create("div",{props:{className:"bx-messenger-call-crm-deals-status"},html:this.phoneCrm.DEALS[n].STAGE})]}))}o=BX.create("div",{props:{className:"bx-messenger-call-crm-deals"},children:[BX.create("div",{props:{className:"bx-messenger-call-crm-deals-header"},html:BX.message("IM_CRM_DEALS")}),BX.create("div",{props:{className:"bx-messenger-call-crm-deals-items"},children:crmArDeals})]})}var r=[];if(a&&o){r=[BX.create("div",{props:{className:"bx-messenger-call-crm-space"}}),t,a,o,BX.create("div",{props:{className:"bx-messenger-call-crm-space"}}),i]}else{if(a||o){r=[BX.create("div",{props:{className:"bx-messenger-call-crm-space"}}),t,BX.create("div",{props:{className:"bx-messenger-call-crm-space"}}),s,BX.create("div",{props:{className:"bx-messenger-call-crm-space"}}),BX.create("div",{props:{className:"bx-messenger-call-crm-space"}}),a?a:o,BX.create("div",{props:{className:"bx-messenger-call-crm-space"}}),i]}else if(!a&&!o&&i){BX.addClass(this.callOverlay,"bx-messenger-call-overlay-crm-short");this.callOverlayCrmBlock.innerHTML="";r=[BX.create("div",{props:{className:"bx-messenger-call-crm-space"}}),t,BX.create("div",{props:{className:"bx-messenger-call-crm-space"}}),s,BX.create("div",{props:{className:"bx-messenger-call-crm-space"}}),BX.create("div",{props:{className:"bx-messenger-call-crm-space"}}),i]}else{BX.addClass(this.callOverlay,"bx-messenger-call-overlay-crm-short");this.callOverlayCrmBlock.innerHTML="";r=[BX.create("div",{props:{className:"bx-messenger-call-crm-space"}}),BX.create("div",{props:{className:"bx-messenger-call-crm-space"}}),BX.create("div",{props:{className:"bx-messenger-call-crm-space"}}),t,BX.create("div",{props:{className:"bx-messenger-call-crm-space"}}),BX.create("div",{props:{className:"bx-messenger-call-crm-space"}}),BX.create("div",{props:{className:"bx-messenger-call-crm-space"}}),BX.create("div",{props:{className:"bx-messenger-call-crm-space"}}),s]}}}else if(this.phoneCrm.LEAD_URL||this.phoneCrm.CONTACT_URL){BX.removeClass(this.callOverlay,"bx-messenger-call-overlay-mini");BX.addClass(this.callOverlay,"bx-messenger-call-overlay-maxi");BX.addClass(this.messenger.popupMessengerContent,"bx-messenger-call-maxi");BX.addClass(this.callOverlay,"bx-messenger-call-overlay-crm");BX.addClass(this.callOverlay,"bx-messenger-call-overlay-crm-short");r=[BX.create("div",{props:{className:"bx-messenger-call-crm-phone-space"}}),BX.create("div",{props:{className:"bx-messenger-call-crm-phone-icon"},children:[BX.create("div",{props:{className:"bx-messenger-call-crm-phone-icon-block"}})]}),BX.create("div",{props:{className:"bx-messenger-call-crm-phone-space"}}),BX.create("div",{props:{className:"bx-messenger-call-crm-buttons bx-messenger-call-crm-buttons-center"},children:[this.phoneCrm.CONTACT_URL?BX.create("a",{attrs:{target:"_blank",href:this.phoneCrm.CONTACT_URL},props:{className:"bx-messenger-call-crm-button"},html:BX.message("IM_CRM_BTN_NEW_CONTACT")}):null,this.phoneCrm.LEAD_URL?BX.create("a",{attrs:{target:"_blank",href:this.phoneCrm.LEAD_URL},props:{className:"bx-messenger-call-crm-button"},html:BX.message("IM_CRM_BTN_NEW_LEAD")}):null]})]}BX.adjust(this.callOverlayCrmBlock,{children:r})};BX.IM.WebRTC.prototype.callDialogAllowShow=function(e){if(BX.MessengerCommon.isDesktop())return false;if(this.phoneMicAccess)return false;e=e!=false;if(!this.phoneAPI){if(this.callStreamSelf!=null)return false;if(e&&!this.callActive)return false}if(this.callDialogAllow)this.callDialogAllow.close();this.callDialogAllow=new BX.IM.Call.HardwareDialog({bindNode:this.messenger.popupMessengerDialog,offsetTop:this.messenger.popupMessengerDialog?this.callOverlayMinimize?-20:-this.messenger.popupMessengerDialog.offsetHeight/2-100:-20,offsetLeft:this.callOverlay?this.callOverlay.offsetWidth/2-170:0,onDestroy:function(){this.callDialogAllow=null}.bind(this)});this.callDialogAllow.show()};BX.IM.WebRTC.prototype.callNotifyWait=function(e,t,s,i,a){console.trace("Deprecated function callNotifyWait called");return;if(!this.callSupport())return false;a=a==true;s=s==true;i=i==true;this.initiator=false;this.callInitUserId=t;this.callInit=true;this.callActive=false;this.callUserId=i?0:t;this.callChatId=e;this.callToGroup=i;this.callGroupUsers=this.messenger.userInChat[e];this.callVideo=s;this.callView=new BX.IM.Call.View({messenger:this.messenger,toUserId:this.BXIM.userId,fromUserId:this.callToGroup?e:t,groupCall:this.callToGroup,users:this.callToGroup?this.messenger.userInChat[e]:[t],videoCall:s,title:this.callOverlayTitle(),status:BX.message(this.callToGroup?"IM_M_CALL_ST_INVITE_2":"IM_M_CALL_ST_INVITE"),uiState:BX.IM.Call.UiState.Incoming,callWithMobile:this.callToMobile,floating:!this.messenger.popupMessenger,join:a});this.bindCallViewCallbacks();this.callView.show();if(!this.BXIM.windowFocus&&this.BXIM.notifyManager.nativeNotifyGranted()){var n={title:BX.message("IM_PHONE_DESC"),text:BX.util.htmlspecialcharsback(this.callOverlayTitle()),icon:this.callUserId?this.messenger.users[this.callUserId].avatar:"",tag:"im-call",onshow:function(){var e=this;setTimeout(function(){e.close()},5e3)},onclick:function(){window.focus();this.close()}};this.BXIM.notifyManager.nativeNotify(n)}};BX.IM.WebRTC.prototype.callNotifyWaitDesktop=function(e,t,s,i,a){this.BXIM.ppServerStatus=true;if(!this.callSupport()||!this.desktop.ready())return false;a=a==true;s=s==true;i=i==true;this.initiator=false;this.callInitUserId=t;this.callInit=true;this.callActive=false;this.callUserId=i?0:t;this.callChatId=e;this.callToGroup=i;this.callGroupUsers=this.messenger.userInChat[e];this.callVideo=s;this.callOverlayShow({prepare:true,toUserId:this.BXIM.userId,fromUserId:this.callToGroup?e:t,callToGroup:this.callToGroup,video:s,status:BX.message(this.callToGroup?"IM_M_CALL_ST_INVITE_2":"IM_M_CALL_ST_INVITE"),buttons:[{text:BX.message("IM_M_CALL_BTN_ANSWER"),className:"bx-messenger-call-overlay-button-answer",events:{click:BX.delegate(function(){if(a)BX.desktop.onCustomEvent("main","bxCallJoin",[e,t,s,i]);else BX.desktop.onCustomEvent("main","bxCallAnswer",[e,t,s,i]);BX.desktop.windowCommand("close")},this)}},{text:BX.message("IM_M_CALL_BTN_HANGUP"),className:"bx-messenger-call-overlay-button-hangup",events:{click:BX.delegate(function(){BX.desktop.onCustomEvent("main","bxCallDecline",[]);BX.desktop.windowCommand("close")},this)}}]});this.desktop.drawOnPlaceholder(this.callOverlay);BX.desktop.setWindowPosition({X:STP_CENTER,Y:STP_VCENTER,Width:470,Height:120})};BX.IM.WebRTC.prototype.callFloatDialog=function(e,t,s){if(!BX.MessengerCommon.isDesktop())return false;this.audioMuted=s;var i=t?this.desktop.minCallVideoWidth:this.desktop.minCallWidth;var a=t?this.desktop.minCallVideoHeight:this.desktop.minCallHeight;var n={width:i+"px",height:a+"px"};this.callOverlay=BX.create("div",{props:{className:"bx-messenger-call-float"+(t?"":" bx-messenger-call-float-audio")},style:n,children:[this.callOverlayVideoMain=!t?null:BX.create("video",{attrs:{autoplay:true,src:t},props:{className:"bx-messenger-call-float-video"},events:{click:BX.delegate(function(){BX.desktop.onCustomEvent("main","bxCallOpenDialog",[])},this)}}),BX.create("div",{props:{className:"bx-messenger-call-float-buttons"},children:[BX.create("div",{props:{className:"bx-messenger-call-float-button bx-messenger-call-float-button-mic"+(this.audioMuted?" bx-messenger-call-float-button-mic-disabled":"")},events:{click:BX.delegate(function(e){this.audioMuted=!this.audioMuted;BX.desktop.onCustomEvent("main","bxCallMuteMic",[this.audioMuted]);BX.toggleClass(BX.proxy_context,"bx-messenger-call-float-button-mic-disabled");var t=BX.findChildByClassName(BX.proxy_context,"bx-messenger-call-float-button-text");t.innerHTML=BX.message("IM_M_CALL_BTN_MIC")+" "+BX.message("IM_M_CALL_BTN_MIC_"+(this.audioMuted?"OFF":"ON"));BX.PreventDefault(e)},this)},children:[BX.create("span",{props:{className:"bx-messenger-call-float-button-icon"}}),BX.create("span",{props:{className:"bx-messenger-call-float-button-text"},html:BX.message("IM_M_CALL_BTN_MIC")+" "+BX.message("IM_M_CALL_BTN_MIC_"+(this.audioMuted?"OFF":"ON"))})]}),BX.create("div",{props:{className:"bx-messenger-call-float-button bx-messenger-call-float-button-decline"},events:{click:BX.delegate(function(e){BX.desktop.onCustomEvent("main","bxCallDecline",[]);BX.desktop.windowCommand("close");BX.PreventDefault(e)},this)},children:[BX.create("span",{props:{className:"bx-messenger-call-float-button-icon"}}),BX.create("span",{props:{className:"bx-messenger-call-float-button-text"},html:BX.message("IM_M_CALL_BTN_HANGUP")})]})]})]});this.desktop.drawOnPlaceholder(this.callOverlay);BX.desktop.setWindowMinSize({Width:i,Height:a});BX.desktop.setWindowResizable(false);BX.desktop.setWindowClosable(false);BX.desktop.setWindowResizable(false);BX.desktop.setWindowTitle(BX.util.htmlspecialcharsback(BX.util.htmlspecialcharsback(e)));if(BXDesktopSystem.QuerySettings("global_topmost_x",null)){BX.desktop.setWindowPosition({X:parseInt(BXDesktopSystem.QuerySettings("global_topmost_x",STP_RIGHT)),Y:parseInt(BXDesktopSystem.QuerySettings("global_topmost_y",STP_TOP)),Width:i,Height:a,Mode:STP_FRONT});if(!BX.browser.IsMac())BX.desktop.setWindowPosition({X:parseInt(BXDesktopSystem.QuerySettings("global_topmost_x",STP_RIGHT)),Y:parseInt(BXDesktopSystem.QuerySettings("global_topmost_y",STP_TOP)),Width:i,Height:a,Mode:STP_FRONT})}else{BX.desktop.setWindowPosition({X:STP_RIGHT,Y:STP_TOP,Width:i,Height:a,Mode:STP_FRONT});if(!BX.browser.IsMac())BX.desktop.setWindowPosition({X:STP_RIGHT,Y:STP_TOP,Width:i,Height:a,Mode:STP_FRONT})}if(t){clearInterval(this.callAspectCheckInterval);this.callAspectCheckInterval=setInterval(BX.delegate(function(){if(this.callOverlayVideoMain.offsetWidth<this.callOverlayVideoMain.offsetHeight){if(this.callAspectHorizontal){this.callAspectHorizontal=false;BX.addClass(this.callOverlay,"bx-messenger-call-overlay-aspect-vertical");BX.desktop.setWindowSize({Width:this.desktop.minCallVideoHeight,Height:this.desktop.minCallVideoWidth})}}else{if(!this.callAspectHorizontal){this.callAspectHorizontal=true;BX.removeClass(this.callOverlay,"bx-messenger-call-overlay-aspect-vertical");BX.desktop.setWindowSize({Width:this.desktop.minCallVideoWidth,Height:this.desktop.minCallVideoHeight})}}},this),500)}BX.desktop.addCustomEvent("bxCallChangeMainVideo",BX.delegate(function(e){this.callOverlayVideoMain.src=e},this))};BX.IM.WebRTC.prototype.storageSet=function(e){if(e.key=="vite"){if(e.value===true||!this.BXIM.webrtc.callSelfDisabled){this.phoneTransferEnabled=e.value}}else if(e.key=="viExternalCard"){if(e.value===false){this.hideExternalCall()}}};BX.IM.WebRTC.prototype.phoneSupport=function(){return this.phoneEnabled&&(this.phoneDeviceActive||this.ready())};BX.IM.WebRTC.prototype.phoneMute=function(){if(!this.phoneCurrentCall)return false;this.phoneMicMuted=true;this.phoneCurrentCall.muteMicrophone()};BX.IM.WebRTC.prototype.phoneUnmute=function(){if(!this.phoneCurrentCall)return false;this.phoneMicMuted=false;this.phoneCurrentCall.unmuteMicrophone()};BX.IM.WebRTC.prototype.phoneToggleAudio=function(){if(!this.phoneCurrentCall)return false;if(this.phoneMicMuted){this.phoneCurrentCall.unmuteMicrophone();this.phoneCallView.setMuted(false)}else{this.phoneCurrentCall.muteMicrophone()}this.phoneMicMuted=!this.phoneMicMuted};BX.IM.WebRTC.prototype.phoneDeviceCall=function(e){var t=true;if(typeof e=="boolean"){this.BXIM.setLocalConfig("viDeviceCallBlock",!e);BX.localStorage.set("viDeviceCallBlock",!e,86400);if(this.phoneCallView)this.phoneCallView.setDeviceCall(e)}else{var s=this.BXIM.getLocalConfig("viDeviceCallBlock");if(!s){s=BX.localStorage.get("viDeviceCallBlock")}t=this.phoneDeviceActive&&s!=true}return t};BX.IM.WebRTC.prototype.openKeyPad=function(e){var t;var s;var i;var a=this.messenger.externalMenu&&!this.callActive?"left":"top";var n=this.messenger.externalMenu?this.callActive?120:76:94;if(!this.phoneSupport()&&!(this.BXIM.desktopStatus&&this.BXIM.desktopVersion>=18)&&!this.isRestLine(this.phoneDefaultLineId)){if(!BX.MessengerCommon.isDesktop()){this.BXIM.openConfirm(BX.message("IM_CALL_NO_WEBRT"),[this.BXIM.platformName==""?null:new BX.PopupWindowButton({text:BX.message("IM_M_CALL_BTN_DOWNLOAD"),className:"popup-window-button-accept",events:{click:BX.delegate(function(){window.open(BX.browser.IsMac()?"http://dl.bitrix24.com/b24/bitrix24_desktop.dmg":"http://dl.bitrix24.com/b24/bitrix24_desktop.exe","desktopApp");BX.proxy_context.popupWindow.close()},this)}}),new BX.PopupWindowButton({text:BX.message("IM_NOTIFY_CONFIRM_CLOSE"),className:"popup-window-button",events:{click:function(){this.popupWindow.close()}}})])}return false}if(this.callInit||this.callActive||this.phoneCurrentCall||BX.localStorage.get("viInitedCall")||BX.localStorage.get("viExternalCard")){return false}if(this.phoneKeypad!==null){this.phoneKeypad.close();return false}if(this.messenger.popupMessenger){if(!this.callActive){if(this.messenger.externalMenu){t=BX("bx-desktop-tab-im-phone");s=-110;i=60}else{BX.addClass(this.messenger.popupContactListSearchCall,"bx-messenger-input-search-call-active");t=this.messenger.popupContactListSearchCall;s=-10;i=-52}}else{t=BX("bx-messenger-call-overlay-button-keypad");s=7;i=BX.MessengerCommon.isPage()?-90:-65;if(BX.MessengerCommon.isPage()){BX.MessengerWindow.closeTab("im-phone")}}}else{t=this.notify.panelButtonCall;s=this.notify.panelButtonCallOffsetTop?this.notify.panelButtonCallOffsetTop:5;i=this.notify.panelButtonCallOffsetLeft?this.notify.panelButtonCallOffsetLeft:-75;a=this.notify.panelButtonCallAnlgePosition?this.notify.panelButtonCallAnlgePosition:a;n=this.notify.panelButtonCallAnlgeOffset?this.notify.panelButtonCallAnlgeOffset:n}this.messenger.setClosingByEsc(false);this.phoneKeypad=new BX.PhoneKeypad({bindElement:t,offsetTop:s,offsetLeft:i,anglePosition:a,angleOffset:n,defaultLineId:this.phoneDefaultLineId,lines:this.phoneLines,availableLines:this.phoneAvailableLines,history:this.phoneGetHistory(),onDial:function(e){var t={};this.phoneKeypad.close();if(e.lineId){t["LINE_ID"]=e.lineId}this.phoneCall(e.phoneNumber,t)}.bind(this),onClose:function(){this.phoneKeypad=null;if(this.messenger.popupMessenger&&this.messenger.externalMenu&&BX.MessengerCommon.isPage()){if(BX.MessengerWindow.lastTabTarget!="im"){BX.MessengerWindow.changeTab(this.BXIM.dialogOpen?"im":"notify")}else{BX.MessengerWindow.closeTab("im-phone")}}this.messenger.setClosingByEsc(true);BX.removeClass(this.messenger.popupContactListSearchCall,"bx-messenger-input-search-call-active")}.bind(this)});this.phoneKeypad.show()};BX.IM.WebRTC.prototype.phoneCount=function(e){var t=0;if(typeof e==="object"){if(e.PERSONAL_MOBILE)t++;else if(e.PERSONAL_PHONE)t++;else if(e.WORK_PHONE)t++}return t};BX.IM.WebRTC.prototype.phoneDisconnectAfterCall=function(e){if(BX.MessengerCommon.isDesktop()){e=false}this.phoneDisconnectAfterCallFlag=e===false?false:true;return true};BX.IM.WebRTC.prototype.phoneDisplayExternal=function(e){var t=e.phoneNumber;this.phoneLog(t,e);this.phoneNumberUser=BX.util.htmlspecialchars(t);t=BX.MessengerCommon.phoneCorrect(t);if(typeof e!="object")e={};if(this.callActive||this.callInit)return;if(this.phoneCallView)return;this.initiator=true;this.callInitUserId=this.BXIM.userId;this.callInit=true;this.callActive=false;this.callUserId=0;this.callChatId=0;this.callToGroup=0;this.callGroupUsers=[];this.phoneNumber=t;this.phoneCallView=new BX.PhoneCallView({BXIM:this.BXIM,callId:e.callId,config:e.config,direction:BX.PhoneCallView.Direction.outgoing,phoneNumber:this.phoneNumber,statusText:BX.message("IM_M_CALL_ST_CONNECT"),hasSipPhone:true,deviceCall:true,portalCall:e.portalCall,portalCallUserId:e.portalCallUserId,portalCallData:e.portalCallData,crm:e.showCrmCard,crmEntityType:e.crmEntityType,crmEntityId:e.crmEntityId,crmData:this.phoneCrm});this.bindPhoneViewCallbacks(this.phoneCallView);this.phoneCallView.setUiState(BX.PhoneCallView.UiState.idle);this.phoneCallView.setCallState(BX.PhoneCallView.CallState.connected);this.phoneCallView.show()};BX.IM.WebRTC.prototype.isRestLine=function(e){if(this.phoneLines.hasOwnProperty(e))return this.phoneLines[e].TYPE==="REST";else return false};BX.IM.WebRTC.prototype.setPhoneNumber=function(e){var t=/(\d+)([;#]*)([\d,]*)/.exec(e);this.phoneFullNumber=e;if(t){this.phoneNumber=t[1]}};BX.IM.WebRTC.prototype.phoneCall=function(e,t){if(BX.localStorage.get("viInitedCall"))return false;if(this.phoneCallView)return false;if(this.callActive||this.callInit)return false;if(this.popupKeyPad)this.popupKeyPad.close();if(e!=""){this.phoneAddToHistory(e)}var s=BX.type.isPlainObject(t)&&t["LINE_ID"]?t["LINE_ID"]:this.phoneDefaultLineId;if(this.isRestLine(s)){BX.MessengerCommon.phoneStartCallViaRestApp(e,s,t);return true}this.phoneLog(e,t);this.phoneNumberUser=BX.util.htmlspecialchars(e);numberOriginal=e;if(typeof t!="object")t={};var i=BX.MessengerCommon.phoneCorrect(e);if(i[0]==="+"){i=i.substr(1)}if(i.length<=0){this.BXIM.openConfirm({title:BX.message("IM_PHONE_WRONG_NUMBER"),message:BX.message("IM_PHONE_WRONG_NUMBER_DESC")});return false}this.setPhoneNumber(i);if(!this.phoneSupport()){if(!BX.MessengerCommon.isDesktop()){this.BXIM.openConfirm(BX.message("IM_CALL_NO_WEBRT"),[new BX.PopupWindowButton({text:BX.message("IM_M_CALL_BTN_DOWNLOAD"),className:"popup-window-button-accept",events:{click:BX.delegate(function(){window.open(BX.browser.IsMac()?"http://dl.bitrix24.com/b24/bitrix24_desktop.dmg":"http://dl.bitrix24.com/b24/bitrix24_desktop.exe","desktopApp");BX.proxy_context.popupWindow.close()},this)}}),new BX.PopupWindowButton({text:BX.message("IM_NOTIFY_CONFIRM_CLOSE"),className:"popup-window-button",events:{click:function(){this.popupWindow.close()}}})])}return false}this.initiator=true;this.callInitUserId=this.BXIM.userId;this.callInit=true;this.callActive=false;this.callUserId=0;this.callChatId=0;this.callToGroup=0;this.phoneCallExternal=this.phoneDeviceCall();this.callGroupUsers=[];this.phoneParams=t;this.phoneCallView=new BX.PhoneCallView({phoneNumber:this.phoneFullNumber,callTitle:this.phoneNumberUser,fromUserId:this.BXIM.userId,direction:BX.PhoneCallView.Direction.outgoing,uiState:BX.PhoneCallView.UiState.connectingOutgoing,status:BX.message("IM_M_CALL_ST_CONNECT"),hasSipPhone:this.phoneDeviceActive,deviceCall:this.phoneCallExternal,BXIM:this.BXIM,crmData:this.phoneCrm,autoFold:t["AUTO_FOLD"]===true});this.bindPhoneViewCallbacks(this.phoneCallView);this.phoneCallView.show();this.BXIM.playSound("start");if(this.phoneCallExternal){this.phoneCallDevice="PHONE";this.phoneCallView.setProgress("wait");this.phoneCallView.setStatusText(BX.message("IM_M_CALL_ST_PHONE_NOTICE"));BX.MessengerCommon.phoneCommand("deviceStartCall",{NUMBER:numberOriginal.toString().replace(/[^0-9+*#,;]/g,""),PARAMS:t},true,function(e){if(e.ERROR){this.phoneCallView.setProgress("error");this.phoneCallView.setStatusText(BX.message("IM_M_CALL_ST_PHONE_ERROR"));this.phoneCallView.setUiState(BX.PhoneCallView.UiState.error);this.phoneCallView.setCallState(BX.PhoneCallView.CallState.idle)}else{this.phoneCallId=e.CALL_ID;this.phoneCallExternal=e.EXTERNAL==true;this.phoneCallConfig=e.CONFIG;this.phoneCallView.setProgress("wait");this.phoneCallView.setStatusText(BX.message("IM_M_CALL_ST_WAIT_PHONE"));this.phoneCallView.setUiState(BX.PhoneCallView.UiState.connectingOutgoing);this.phoneCallView.setCallState(BX.PhoneCallView.CallState.connecting)}if(BX.MessengerCommon.isDesktop()){BX.desktop.changeTab("im");BX.desktop.windowCommand("show");this.BXIM.desktop.closeTopmostWindow()}}.bind(this))}else{this.phoneCallView.setStatusText(BX.message("IM_M_CALL_ST_CALL_INIT"));this.phoneApiInit().then(function(){this.phoneOnSDKReady()}.bind(this))}};BX.IM.WebRTC.prototype.phoneAddToHistory=function(e){var t=this.phoneHistory;var s=t.indexOf(e);if(s===0){}else if(s>0){t.splice(s,s);this.phoneHistory=[e].concat(t)}else{this.phoneHistory=[e].concat(t.slice(0,4))}this.BXIM.setLocalConfig("phone-history",this.phoneHistory)};BX.IM.WebRTC.prototype.phoneGetHistory=function(){return this.phoneHistory};BX.IM.WebRTC.prototype.startCallList=function(e,t){e=parseInt(e);if(e==0||this.callActive||this.callInit||this.phoneCallView||this.isCallListMode())return false;this.callListId=e;this.phoneCallView=new BX.PhoneCallView({crm:true,callListId:e,callListStatusId:t.callListStatusId,callListItemIndex:t.callListItemIndex,direction:BX.PhoneCallView.Direction.outgoing,makeCall:t.makeCall===true,uiState:BX.PhoneCallView.UiState.outgoing,BXIM:this.BXIM,webformId:t.webformId||0,webformSecCode:t.webformSecCode||"",hasSipPhone:this.phoneDeviceActive,deviceCall:this.phoneDeviceCall(),crmData:this.phoneCrm});this.bindPhoneViewCallbacks(this.phoneCallView);this.phoneCallView.show();return true};BX.IM.WebRTC.prototype.isCallListMode=function(){return this.callListId>0};BX.IM.WebRTC.prototype.callListMakeCall=function(e){if(this.isRestLine(this.phoneDefaultLineId)){BX.MessengerCommon.phoneStartCallViaRestApp(e.phoneNumber,this.phoneDefaultLineId,{ENTITY_TYPE:"CRM_"+e.crmEntityType,ENTITY_ID:e.crmEntityId,CALL_LIST_ID:e.callListId});return true}if(BX.localStorage.get("viInitedCall"))return false;if(this.callActive||this.callInit)return false;if(!this.phoneCallView)return false;this.lastCallListCallParams=e;if(typeof params!="object")params={};if(!this.phoneSupport()){this.phoneCallView.setStatusText(BX.message("IM_CALL_NO_WEBRT"));this.phoneCallView.setUiState(BX.PhoneCallView.UiState.error);this.phoneCallView.setCallState(BX.PhoneCallView.CallState.idle);return false}var t=e.phoneNumber;var s=t;var i=BX.MessengerCommon.phoneCorrect(t);if(i[0]==="+")i=i.substr(1);if(i.length<=0){this.phoneCallView.setStatusText(BX.message("IM_PHONE_WRONG_NUMBER_DESC"));return false}this.initiator=true;this.callInitUserId=this.BXIM.userId;this.callInit=true;this.callActive=false;this.callUserId=0;this.callChatId=0;this.callToGroup=0;this.phoneCallExternal=this.phoneDeviceCall();this.callGroupUsers=[];this.setPhoneNumber(i);this.phoneParams={ENTITY_TYPE:"CRM_"+e.crmEntityType,ENTITY_ID:e.crmEntityId,CALL_LIST_ID:e.callListId};this.BXIM.playSound("start");if(this.phoneCallExternal){this.phoneCallDevice="PHONE";this.phoneCallView.setProgress("wait");this.phoneCallView.setStatusText(BX.message("IM_M_CALL_ST_PHONE_NOTICE"));this.phoneCallView.setUiState(BX.PhoneCallView.UiState.connectingOutgoing);this.phoneCallView.setCallState(BX.PhoneCallView.CallState.connecting);BX.MessengerCommon.phoneCommand("deviceStartCall",{NUMBER:s.toString().replace(/[^0-9+*#,;]/g,""),PARAMS:this.phoneParams},true,function(e){if(e.ERROR){this.phoneCallView.setProgress("error");this.phoneCallView.setStatusText(BX.message("IM_M_CALL_ST_PHONE_ERROR"));this.phoneCallView.setUiState(BX.PhoneCallView.UiState.error);this.phoneCallView.setCallState(BX.PhoneCallView.CallState.idle)}else{this.phoneCallId=e.CALL_ID;this.phoneCallExternal=params.EXTERNAL==true;this.phoneCallConfig=params.CONFIG;this.phoneCallView.setProgress("wait");this.phoneCallView.setStatusText(BX.message("IM_M_CALL_ST_WAIT_PHONE"));this.phoneCallView.setUiState(BX.PhoneCallView.UiState.connectingOutgoing);this.phoneCallView.setCallState(BX.PhoneCallView.CallState.connecting)}if(BX.MessengerCommon.isDesktop()){BX.desktop.changeTab("im");BX.desktop.windowCommand("show");this.BXIM.desktop.closeTopmostWindow()}}.bind(this))}else{this.phoneCallView.setStatusText(BX.message("IM_M_CALL_ST_CALL_INIT"));this.phoneCallView.setUiState(BX.PhoneCallView.UiState.connectingOutgoing);this.phoneCallView.setCallState(BX.PhoneCallView.CallState.connecting);this.phoneApiInit().then(function(){this.phoneOnSDKReady()}.bind(this))}};BX.IM.WebRTC.prototype.phoneIncomingAnswer=function(){this.BXIM.stopRepeatSound("ringtone");this.callSelfDisabled=true;BX.MessengerCommon.phoneCommand("answer",{CALL_ID:this.phoneCallId});if(this.popupKeyPad)this.popupKeyPad.close();this.phoneCallView.setUiState(BX.PhoneCallView.UiState.connectingIncoming);this.phoneCallView.setCallState(BX.PhoneCallView.CallState.connecting);this.phoneApiInit().then(function(){BX.MessengerCommon.phoneCommand("ready",{CALL_ID:this.phoneCallId})}.bind(this))};BX.IM.WebRTC.prototype.phoneApiInit=function(){var e=new BX.Promise;if(!this.phoneSupport()){e.reject("Telephony is not supported");return e}if(this.phoneAPI&&this.phoneAPI.connected()){if(this.defaultMicrophone){this.phoneAPI.useAudioSource(this.defaultMicrophone)}if(this.defaultSpeaker){VoxImplant.Hardware.AudioDeviceManager.get().setDefaultAudioSettings({outputId:this.defaultSpeaker})}e.resolve();return e}var t={useRTCOnly:true,micRequired:true,videoSupport:false,progressTone:false};if(this.enableMicAutoParameters===false){t.audioConstraints={optional:[{echoCancellation:false},{googEchoCancellation:false},{googEchoCancellation2:false},{googDAEchoCancellation:false},{googAutoGainControl:false},{googAutoGainControl2:false},{mozAutoGainControl:false},{googNoiseSuppression:false},{googNoiseSuppression2:false},{googHighpassFilter:false},{googTypingNoiseDetection:false},{googAudioMirroring:false}]}}BX.Voximplant.getClient({debug:this.debug,apiParameters:t}).then(function(t){this.phoneAPI=t;if(this.defaultMicrophone){this.phoneAPI.useAudioSource(this.defaultMicrophone)}if(this.defaultSpeaker){VoxImplant.Hardware.AudioDeviceManager.get().setDefaultAudioSettings({outputId:this.defaultSpeaker})}if(BX.MessengerCommon.isDesktop()&&BX.type.isFunction(this.phoneAPI.setLoggerCallback)){this.phoneAPI.enableSilentLogging();this.phoneAPI.setLoggerCallback(function(e){this.phoneLog(e.label+": "+e.message)}.bind(this))}this.phoneAPI.addEventListener(VoxImplant.Events.ConnectionFailed,this.phoneOnConnectionFailed.bind(this));this.phoneAPI.addEventListener(VoxImplant.Events.ConnectionClosed,this.phoneOnConnectionClosed.bind(this));this.phoneAPI.addEventListener(VoxImplant.Events.IncomingCall,this.phoneOnIncomingCall.bind(this));this.phoneAPI.addEventListener(VoxImplant.Events.MicAccessResult,this.phoneOnMicResult.bind(this));this.phoneAPI.addEventListener(VoxImplant.Events.SourcesInfoUpdated,this.phoneOnInfoUpdated.bind(this));this.phoneAPI.addEventListener(VoxImplant.Events.NetStatsReceived,this.phoneOnNetStatsReceived.bind(this));e.resolve()}.bind(this)).catch(function(t){BX.MessengerCommon.phoneCommand("connectionError",{CALL_ID:this.BXIM.webrtc.phoneCallId,ERROR:t});this.phoneCallFinish();this.BXIM.playSound("error");this.callOverlayProgress("offline");this.callAbort(BX.message("IM_PHONE_ERROR"));this.phoneCallView.setUiState(BX.PhoneCallView.UiState.error);this.phoneCallView.setCallState(BX.PhoneCallView.CallState.idle);e.reject("Could not connect to Voximplant cloud")}.bind(this));return e;if(this.phoneAPI){if(this.phoneSDKinit){if(this.phoneIncoming){BX.MessengerCommon.phoneCommand("ready",{CALL_ID:this.phoneCallId})}else if(this.callInitUserId==this.BXIM.userId){this.phoneOnSDKReady()}}else{this.phoneOnSDKReady()}return true}this.phoneAPI=VoxImplant.getInstance();this.phoneAPI.addEventListener(VoxImplant.Events.SDKReady,BX.delegate(this.phoneOnSDKReady,this));this.phoneAPI.addEventListener(VoxImplant.Events.ConnectionEstablished,BX.delegate(this.phoneOnConnectionEstablished,this));this.phoneAPI.addEventListener(VoxImplant.Events.ConnectionFailed,BX.delegate(this.phoneOnConnectionFailed,this));this.phoneAPI.addEventListener(VoxImplant.Events.ConnectionClosed,BX.delegate(this.phoneOnConnectionClosed,this));this.phoneAPI.addEventListener(VoxImplant.Events.IncomingCall,BX.delegate(this.phoneOnIncomingCall,this));this.phoneAPI.addEventListener(VoxImplant.Events.AuthResult,BX.delegate(this.phoneOnAuthResult,this));this.phoneAPI.addEventListener(VoxImplant.Events.MicAccessResult,BX.delegate(this.phoneOnMicResult,this));this.phoneAPI.addEventListener(VoxImplant.Events.SourcesInfoUpdated,BX.delegate(this.phoneOnInfoUpdated,this));this.phoneAPI.addEventListener(VoxImplant.Events.NetStatsReceived,BX.delegate(this.phoneOnNetStatsReceived,this));var t={useRTCOnly:true,micRequired:true,videoSupport:false,progressTone:false};if(this.debug){t.showDebugInfo=true;t.showWarnings=true;t.prettyPrint=true}if(this.enableMicAutoParameters===false){t.audioConstraints={optional:[{echoCancellation:false},{googEchoCancellation:false},{googEchoCancellation2:false},{googDAEchoCancellation:false},{googAutoGainControl:false},{googAutoGainControl2:false},{mozAutoGainControl:false},{googNoiseSuppression:false},{googNoiseSuppression2:false},{googHighpassFilter:false},{googTypingNoiseDetection:false},{googAudioMirroring:false}]}}this.phoneAPI.init(t);if(this.defaultMicrophone){this.phoneAPI.useAudioSource(this.defaultMicrophone)}if(BX.MessengerCommon.isDesktop()&&BX.type.isFunction(this.phoneAPI.setLoggerCallback)){this.phoneAPI.enableSilentLogging();this.phoneAPI.setLoggerCallback(function(e){this.phoneLog(e.label+": "+e.message)}.bind(this))}this.phoneSDKinit=true;return true};BX.IM.WebRTC.prototype.phoneOnSDKReady=function(e){this.phoneLog("SDK ready");e=e||{};e.delay=e.delay||false;if(!e.delay&&this.phoneDeviceActive){if(!this.phoneIncoming&&!this.phoneDeviceCall()){if(BX.MessengerCommon.isPage()){BX.MessengerWindow.changeTab("im")}if(BX.MessengerCommon.isDesktop()){BX.desktop.windowCommand("show");this.desktop.closeTopmostWindow()}this.callOverlayProgress("wait");this.callDialogAllowTimeout=setTimeout(BX.delegate(function(){this.phoneOnSDKReady({delay:true})},this),5e3);return false}}if(BX.MessengerCommon.isDesktop()&&this.BXIM.init){BX.desktop.syncPause(true)}if(!this.phoneAPI.connected()){this.phoneAPI.connect(false);clearTimeout(this.callDialogAllowTimeout);this.callDialogAllowTimeout=setTimeout(BX.delegate(function(){this.callDialogAllowShow()},this),1500);this.phoneCallView.setProgress("wait");this.phoneCallView.setStatusText(BX.message("IM_M_CALL_ST_WAIT_ACCESS"));this.phoneCallView.setCallState(BX.PhoneCallView.CallState.connecting);if(this.phoneIncoming)this.phoneCallView.setUiState(BX.PhoneCallView.UiState.connectingIncoming);else this.phoneCallView.setUiState(BX.PhoneCallView.UiState.connectingOutgoing)}else{this.phoneLog("Connection exists");this.phoneCallView.setProgress("connect");this.phoneCallView.setStatusText(BX.message("IM_M_CALL_ST_CONNECT"));this.phoneOnAuthResult({result:true});this.phoneCallView.setCallState(BX.PhoneCallView.CallState.connecting);if(this.phoneIncoming)this.phoneCallView.setUiState(BX.PhoneCallView.UiState.connectingIncoming);else this.phoneCallView.setUiState(BX.PhoneCallView.UiState.connectingOutgoing)}};BX.IM.WebRTC.prototype.phoneOnConnectionEstablished=function(e){BX.MessengerCommon.phoneOnConnectionEstablished(e);this.phoneAPI.requestOneTimeLoginKey(this.phoneLogin+"@"+this.phoneServer)};BX.IM.WebRTC.prototype.phoneOnConnectionFailed=function(e){BX.MessengerCommon.phoneOnConnectionFailed(e)};BX.IM.WebRTC.prototype.phoneOnConnectionClosed=function(e){BX.MessengerCommon.phoneOnConnectionClosed(e)};BX.IM.WebRTC.prototype.phoneOnIncomingCall=function(e){BX.MessengerCommon.phoneOnIncomingCall(e)};BX.IM.WebRTC.prototype.phoneOnAuthResult=function(e){BX.MessengerCommon.phoneOnAuthResult(e)};BX.IM.WebRTC.prototype.phoneOnMicResult=function(e){BX.MessengerCommon.phoneOnMicResult(e)};BX.IM.WebRTC.prototype.phoneOnInfoUpdated=function(e){this.phoneLog("Info updated",this.phoneAPI.audioSources(),this.phoneAPI.videoSources())};BX.IM.WebRTC.prototype.phoneOnCallConnected=function(e){if(BX.MessengerCommon.isDesktop()&&this.BXIM.init){BX.desktop.syncPause(true)}this.BXIM.stopRepeatSound("ringtone",5e3);BX.localStorage.set("viInitedCall",true,7);clearInterval(this.phoneConnectedInterval);this.phoneConnectedInterval=setInterval(function(){BX.localStorage.set("viInitedCall",true,7)},5e3);this.desktop.closeTopmostWindow();this.phoneLog("Call connected",e);this.phoneCallView.setUiState(BX.PhoneCallView.UiState.connected);this.phoneCallView.setCallState(BX.PhoneCallView.CallState.connected);this.phoneCallView.setProgress("online");this.phoneCallView.setStatusText(BX.message("IM_M_CALL_ST_ONLINE"));this.callActive=true;if(!this.BXIM.windowFocus)this.desktop.openCallFloatDialog()};BX.IM.WebRTC.prototype.phoneOnCallDisconnected=function(e){BX.MessengerCommon.phoneOnCallDisconnected(e)};BX.IM.WebRTC.prototype.phoneOnCallFailed=function(e){BX.MessengerCommon.phoneOnCallFailed(e)};BX.IM.WebRTC.prototype.phoneOnProgressToneStart=function(e){BX.MessengerCommon.phoneOnProgressToneStart(e)};BX.IM.WebRTC.prototype.phoneOnProgressToneStop=function(e){BX.MessengerCommon.phoneOnProgressToneStop(e)};BX.IM.WebRTC.prototype.phoneOnNetStatsReceived=function(e){BX.MessengerCommon.phoneOnNetStatsReceived(e)};BX.IM.WebRTC.prototype.phoneCallFinish=function(){BX.MessengerCommon.phoneCallFinish()};BX.IM.WebRTC.prototype.bindPhoneViewCallbacks=function(e){if(!e instanceof BX.PhoneCallView)return false;e.setCallback("mute",function(){this.phoneMute()}.bind(this));e.setCallback("unmute",function(){this.phoneUnmute()}.bind(this));e.setCallback("hold",function(){BX.MessengerCommon.phoneHold()}.bind(this));e.setCallback("unhold",function(){BX.MessengerCommon.phoneUnhold()}.bind(this));e.setCallback("answer",this.phoneIncomingAnswer.bind(this));e.setCallback("skip",function(){BX.MessengerCommon.phoneCommand("skip",{CALL_ID:this.BXIM.webrtc.phoneCallId});this.phoneCallFinish();this.callAbort();this.phoneCallView.close()}.bind(this));e.setCallback("hangup",function(){if(this.phoneCallExternal&&this.phoneCallId){BX.MessengerCommon.phoneCommand("deviceHungup",{CALL_ID:this.phoneCallId})}this.phoneCallFinish();this.callAbort();this.BXIM.playSound("stop");this.phoneCallView.setStatusText(BX.message("IM_M_CALL_ST_FINISHED"));this.phoneCallView.setCallState(BX.PhoneCallView.CallState.idle);if(this.isCallListMode()){this.phoneCallView.setUiState(BX.PhoneCallView.UiState.outgoing);if(this.phoneCallView.isFolded()){this.phoneCallView.unfold()}}else{this.phoneCallView.close()}}.bind(this));e.setCallback("transfer",function(e){if(e.type=="user"){this.phoneTransferTargetType="user";this.phoneTransferTargetId=e.userId;this.sendInviteTransfer()}else if(e.type=="phone"){this.phoneTransferTargetType="pstn";this.phoneTransferTargetId=e.phone;this.sendInviteTransfer()}}.bind(this));e.setCallback("cancelTransfer",this.cancelInviteTransfer.bind(this));e.setCallback("completeTransfer",this.completeTransfer.bind(this));e.setCallback("callListMakeCall",this.callListMakeCall.bind(this));e.setCallback("close",function(){this.callListId=0;if(this.phoneCallView){this.phoneCallView.dispose();this.phoneCallView=null}if(this.phoneCallDevice=="PHONE"){this.phoneCallId="";this.callActive=false;this.callInit=false;this.phoneCallExternal=false;this.callSelfDisabled=false;clearInterval(this.BXIM.webrtc.phoneConnectedInterval);BX.localStorage.set("viExternalCard",false)}}.bind(this));e.setCallback("switchDevice",function(e){var t=e.phoneNumber;var s=this.lastCallListCallParams;if(this.phoneCallExternal&&this.phoneCallId){BX.MessengerCommon.phoneCommand("deviceHungup",{CALL_ID:this.phoneCallId})}this.phoneCallFinish();this.callAbort();this.phoneDeviceCall(!this.phoneDeviceCall());this.phoneCallView.setDeviceCall(this.phoneDeviceCall());if(this.isCallListMode()){this.callListMakeCall(s)}else{this.phoneCallView.close();this.phoneCall(t)}}.bind(this));e.setCallback("qualityGraded",function(e){var t={COMMAND:"gradeQuality",grade:e};if(this.phoneCurrentCall)this.phoneCurrentCall.sendMessage(JSON.stringify(t))}.bind(this));e.setCallback("dialpadButtonClicked",function(e){BX.MessengerCommon.phoneSendDTMF(e)}.bind(this))};BX.IM.WebRTC.prototype.phoneIncomingWait=function(e){e.isCallback=!!e.isCallback;this.phoneLog("incoming call",JSON.stringify(e));if(!this.phoneSupport()){if(!BX.MessengerCommon.isDesktop()){this.BXIM.openConfirm(BX.message("IM_CALL_NO_WEBRT"),[new BX.PopupWindowButton({text:BX.message("IM_M_CALL_BTN_DOWNLOAD"),className:"popup-window-button-accept",events:{click:BX.delegate(function(){window.open(BX.browser.IsMac()?"http://dl.bitrix24.com/b24/bitrix24_desktop.dmg":"http://dl.bitrix24.com/b24/bitrix24_desktop.exe","desktopApp");BX.proxy_context.popupWindow.close()},this)}}),new BX.PopupWindowButton({text:BX.message("IM_NOTIFY_CONFIRM_CLOSE"),className:"popup-window-button",events:{click:function(){this.popupWindow.close()}}})])}return false}this.phoneNumberUser=BX.util.htmlspecialchars(e.callerId);e.callerId=e.callerId.replace(/[^a-zA-Z0-9\.]/g,"");if(this.callActive||this.callInit)return false;this.initiator=true;this.callInitUserId=0;this.callInit=true;this.callActive=false;this.callUserId=0;this.callChatId=0;this.callToGroup=0;this.callGroupUsers=[];this.phoneIncoming=true;this.phoneCallId=e.callId;this.phoneNumber=e.callerId;this.phoneParams={};var t;if(e.isCallback)t=BX.PhoneCallView.Direction.callback;else t=BX.PhoneCallView.Direction.incoming;this.phoneCallView=new BX.PhoneCallView({BXIM:this.BXIM,userId:this.BXIM.userId,phoneNumber:this.phoneNumber,lineNumber:e.lineNumber,companyPhoneNumber:e.companyPhoneNumber,callTitle:this.phoneNumberUser,direction:t,transfer:this.phoneTransferEnabled,statusText:e.isCallback?BX.message("IM_PHONE_INVITE_CALLBACK"):BX.message("IM_PHONE_INVITE"),crm:e.showCrmCard,crmEntityType:e.crmEntityType,crmEntityId:e.crmEntityId,crmActivityId:e.crmActivityId,crmActivityEditUrl:e.crmActivityEditUrl,callId:this.phoneCallId,crmData:this.phoneCrm});this.bindPhoneViewCallbacks(this.phoneCallView);this.phoneCallView.setUiState(BX.PhoneCallView.UiState.incoming);this.phoneCallView.setCallState(BX.PhoneCallView.CallState.connecting);if(e.config){this.phoneCallView.setConfig(e.config)}this.phoneCallView.show();if(e.portalCall){this.phoneCallView.setPortalCall(true);this.phoneCallView.setPortalCallData(e.portalCallData);this.phoneCallView.setPortalCallUserId(e.portalCallUserId)}if(!this.BXIM.windowFocus&&this.BXIM.notifyManager.nativeNotifyGranted()){var s={title:BX.message("IM_PHONE_DESC"),text:BX.util.htmlspecialcharsback(this.phoneCallView.getTitle()),icon:this.callUserId?this.messenger.users[this.callUserId].avatar:"",tag:"im-call"};s.onshow=function(){var e=this;setTimeout(function(){e.close()},5e3)};s.onclick=function(){window.focus();this.close()};this.BXIM.notifyManager.nativeNotify(s)}};BX.IM.WebRTC.prototype.sendInviteTransfer=function(){if(!this.phoneCurrentCall&&this.phoneCallDevice=="WEBRTC")return false;if(!this.phoneTransferTargetType||!this.phoneTransferTargetId)return false;if(this.popupTransferDialog)this.popupTransferDialog.close();BX.MessengerCommon.phoneCommand("startTransfer",{CALL_ID:this.phoneCallId,TARGET_TYPE:this.phoneTransferTargetType,TARGET_ID:this.phoneTransferTargetId}).then(function(e){if(e.SUCCESS=="Y"){this.phoneTransferEnabled=true;BX.localStorage.set("vite",true,1);this.phoneTransferCallId=e.DATA.CALL.CALL_ID;this.phoneCallView.setStatusText(BX.message("IM_M_CALL_ST_TRANSFER"));this.phoneCallView.setUiState(BX.PhoneCallView.UiState.transferring)}else{console.error("Could not start call transfer. Error: ",e.ERRORS)}}.bind(this))};BX.IM.WebRTC.prototype.cancelInviteTransfer=function(){if(!this.phoneCurrentCall&&this.phoneCallDevice=="WEBRTC")return false;this.phoneCallView.setStatusText(BX.message("IM_M_CALL_ST_ONLINE"));this.phoneCallView.setUiState(BX.PhoneCallView.UiState.connected);if(this.phoneTransferEnabled){BX.MessengerCommon.phoneCommand("cancelTransfer",{CALL_ID:this.phoneTransferCallId})}this.phoneTransferTargetId=0;this.phoneTransferTargetType="";this.phoneTransferCallId="";this.phoneTransferEnabled=false;BX.localStorage.set("vite",false,1)};BX.IM.WebRTC.prototype.errorInviteTransfer=function(e,t){if(!this.phoneTransferEnabled)return false;if(e=="403"||e=="410"||e=="486"){this.phoneCallView.setStatusText(BX.message("IM_M_CALL_ST_TRANSFER_"+e))}else{this.phoneCallView.setStatusText(BX.message("IM_M_CALL_ST_TRANSFER_1"))}this.BXIM.playSound("error",true);this.phoneCallView.setUiState(BX.PhoneCallView.UiState.transferFailed);this.phoneTransferTargetId=0;this.phoneTransferTargetType="";this.phoneTransferCallId="";this.phoneTransferEnabled=false;BX.localStorage.set("vite",false,1)};BX.IM.WebRTC.prototype.completeTransfer=function(){BX.MessengerCommon.phoneCommand("completeTransfer",{CALL_ID:this.phoneTransferCallId})};BX.IM.WebRTC.prototype.startMicTest=function(){var e,t,s,i,a,n;var o;var r={audio:{deviceId:{ideal:this.defaultMicrophone}},video:{deviceId:{ideal:this.defaultCamera}}};var l;var p="waiting";var h=this;var c=[];var u=BX.create("div",{props:{className:"bx-messenger-mic-test"},children:[BX.create("div",{props:{className:"bx-messenger-mic-test-videos"},children:[BX.create("div",{props:{className:"bx-messenger-mic-test-video-wrap"},children:[a=BX.create("video",{props:{className:"bx-messenger-mic-test-video-self"}})]}),BX.create("div",{props:{className:"bx-messenger-mic-test-video-wrap"},children:[n=BX.create("video",{props:{className:"bx-messenger-mic-test-video-self"},events:{ended:function(){p="idle";t.innerText=BX.message("IM_CALL_MIC_TEST_PLAY_START");e.disabled=false}}})]})]}),BX.create("div",{props:{className:"bx-messenger-mic-test-buttons"},children:[e=BX.create("button",{text:BX.message("IM_CALL_MIC_TEST_RECORD_START"),events:{click:function(){if(p=="idle"){o=new MediaRecorder(h.micTestVideoStream,{mimeType:"video/webm; codecs=vp9"});o.start();o.ondataavailable=function(e){c.push(e.data)};o.onstop=function(){l=new Blob(c,{type:"video/webm"});n.srcObject=l;p="idle";t.disabled=false;e.innerText=BX.message("IM_CALL_MIC_TEST_RECORD_START")};n.src=null;e.innerText=BX.message("IM_CALL_MIC_TEST_RECORD_STOP");t.disabled=true;p="recording"}else if(p=="recording"){o.stop()}else if(p=="playing"){}}}}),t=BX.create("button",{text:BX.message("IM_CALL_MIC_TEST_PLAY_START"),events:{click:function(){if(p=="idle"){n.play();p="playing";t.innerText=BX.message("IM_CALL_MIC_TEST_PLAY_STOP");e.disabled=true}else if(p=="playing"){n.pause();p="idle";t.innerText=BX.message("IM_CALL_MIC_TEST_PLAY_START");e.disabled=false}}}}),s=BX.create("button",{text:BX.message("IM_CALL_MIC_TEST_CLOSE"),events:{click:function(){BX.webrtc.stopMediaStream(h.micTestVideoStream);h.micTestVideoStream=null;BX.remove(u)}}})]}),i=BX.create("div",{props:{className:"bx-messenger-mic-test-button-exit"}})]});this.messenger.popupMessengerContent.insertBefore(u,this.messenger.popupMessengerContent.firstChild);a.volume=0;e.disabled=true;t.disabled=true;navigator.mediaDevices.getUserMedia(r).then(function(t){h.micTestVideoStream=t;a.srcObject=h.micTestVideoStream;a.play();p="idle";e.disabled=false})};BX.IM.WebRTC.prototype.showExternalCall=function(e){var t=this;var s;if(this.phoneCallView)return;setTimeout(function(){BX.localStorage.set("viExternalCard",true,5)},100);clearInterval(this.phoneConnectedInterval);this.phoneConnectedInterval=setInterval(function(){if(t.phoneCallExternal){BX.localStorage.set("viExternalCard",true,5)}},5e3);this.phoneCallId=e.callId;this.callActive=true;this.phoneCallExternal=true;if(e.isCallback)s=BX.PhoneCallView.Direction.callback;else if(e.fromUserId>0)s=BX.PhoneCallView.Direction.outgoing;else s=BX.PhoneCallView.Direction.incoming;this.phoneCallView=new BX.PhoneCallView({BXIM:this.BXIM,callId:e.callId,direction:s,phoneNumber:e.phoneNumber,lineNumber:e.lineNumber,companyPhoneNumber:e.companyPhoneNumber,fromUserId:e.fromUserId,toUserId:e.toUserId,crm:e.showCrmCard,crmEntityType:e.crmEntityType,crmEntityId:e.crmEntityId,crmActivityId:e.crmActivityId,crmActivityEditUrl:e.crmActivityEditUrl,crmData:this.phoneCrm});this.bindPhoneViewCallbacksExternalCall(this.phoneCallView);this.phoneCallView.setUiState(BX.PhoneCallView.UiState.externalCard);this.phoneCallView.setCallState(BX.PhoneCallView.CallState.connected);this.phoneCallView.setConfig(e.config);this.phoneCallView.show();if(e.portalCall){this.phoneCallView.setPortalCall(true);this.phoneCallView.setPortalCallData(e.portalCallData);this.phoneCallView.setPortalCallUserId(e.portalCallUserId)}};BX.IM.WebRTC.prototype.bindPhoneViewCallbacksExternalCall=function(e){e.setCallback("close",function(){if(this.phoneCallView){this.phoneCallView.dispose();this.phoneCallView=null}this.phoneCallId="";this.callActive=false;this.phoneCallExternal=false;this.callSelfDisabled=false;clearInterval(this.BXIM.webrtc.phoneConnectedInterval);BX.localStorage.set("viExternalCard",false)}.bind(this))};BX.IM.WebRTC.prototype.hideExternalCall=function(e){if(this.phoneCallView){this.phoneCallView.autoClose()}};BX.IM.WebRTC.prototype.phoneLog=function(){if(BX.MessengerCommon.isDesktop()){var e="";for(var t=0;t<arguments.length;t++){if(BX.type.isPlainObject(arguments[t])){try{e=e+" | "+JSON.stringify(arguments[t])}catch(t){e=e+" | (circular structure)"}}else{e=e+" | "+arguments[t]}}BX.desktop.log("phone."+this.BXIM.userEmail+".log",e.substr(3))}if(this.debug){if(console){try{console.log("Phone Log",JSON.stringify(arguments))}catch(e){console.log("Phone Log",arguments[0])}}}};BX.IM.ScreenSharing=function(e,t){if(this.parent){this.parent.constructor.apply(this,arguments)}t=t||{};this.webrtc=e;this.BXIM=this.webrtc.BXIM;this.debug=true;this.sdpConstraints={mandatory:{OfferToReceiveAudio:false,OfferToReceiveVideo:true}};this.oneway=true;this.sourceSelf=null;this.sourceOpponent=null;this.callWindowBeforeUnload=null;BX.addCustomEvent("onImCallEnd",BX.delegate(function(e,t){this.callDecline(false)},this));BX.addCustomEvent("onPullEvent-im",BX.delegate(function(e,t){if(e=="screenSharing"){if(t.command=="inactive"){this.callDecline(false)}else if(!this.webrtc.callActive||this.webrtc.callUserId!=t.senderId){this.callCommand("inactive")}else{this.log("Incoming",t.command,t.senderId,JSON.stringify(t));if(t.command=="invite"){if(this.callInit){this.deleteEvents()}this.initiator=false;this.callVideo=true;this.callInit=true;this.callUserId=t.senderId;this.callInitUserId=t.senderId;this.callAnswer()}else if(t.command=="answer"&&this.initiator){this.startScreenSharing()}else if(t.command=="decline"){this.callDecline()}else if(t.command=="ready"){this.log("Opponent "+t.senderId+" ready!");this.connected[t.senderId]=true}else if(t.command=="reconnect"){clearTimeout(this.pcConnectTimeout[t.senderId]);clearTimeout(this.initPeerConnectionTimeout[t.senderId]);if(this.pc[t.senderId])this.pc[t.senderId].close();delete this.pc[t.senderId];delete this.pcStart[t.senderId];if(this.callStreamMain==this.callStreamUsers[t.senderId])this.callStreamMain=null;this.callStreamUsers[t.senderId]=null;this.initPeerConnection(t.senderId)}else if(t.command=="signaling"&&this.callActive){this.signalingPeerData(t.senderId,t.peer)}else{this.log('Command "'+t.command+'" skip')}}}},this));BX.garbage(function(){if(this.callInit){this.callCommand("decline",true)}},this)};if(BX.inheritWebrtc)BX.inheritWebrtc(BX.IM.ScreenSharing);BX.IM.ScreenSharing.prototype.startScreenSharing=function(){var e={mandatory:{chromeMediaSource:"screen",googLeakyBucket:true,maxWidth:window.screen.width,maxHeight:window.screen.height,maxFrameRate:5}};this.startGetUserMedia(e,false)};BX.IM.ScreenSharing.prototype.onUserMediaSuccess=function(e){var t=this.parent.onUserMediaSuccess.apply(this,arguments);if(!t)return false;if(this.initiator){BX.addClass(this.webrtc.callOverlay,"bx-messenger-call-overlay-screen-sharing-self");this.attachMediaStream(this.webrtc.callOverlayVideoSelf,this.callStreamSelf)}this.callCommand("ready");return true};BX.IM.ScreenSharing.prototype.onUserMediaError=function(e){var t=this.parent.onUserMediaError.apply(this,arguments);if(!t)return false;this.callDecline();return true};BX.IM.ScreenSharing.prototype.setLocalAndSend=function(e,t){var s=this.parent.setLocalAndSend.apply(this,arguments);if(!s)return false;BX.ajax({url:this.BXIM.pathToCallAjax+"?CALL_SIGNALING",method:"POST",dataType:"json",timeout:30,data:{IM_SHARING:"Y",COMMAND:"signaling",USER_ID:e,PEER:JSON.stringify(t),IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()}});return true};BX.IM.ScreenSharing.prototype.onRemoteStreamAdded=function(e,t,s){if(!s)return false;BX.addClass(this.webrtc.callOverlay,"bx-messenger-call-overlay-screen-sharing");this.attachMediaStream(this.webrtc.callOverlayVideoReserve,this.webrtc.callStreamMain);this.webrtc.callOverlayVideoReserve.play();this.attachMediaStream(this.webrtc.callOverlayVideoMain,this.callStreamMain);this.webrtc.callOverlayVideoMain.play();return true};BX.IM.ScreenSharing.prototype.onRemoteStreamRemoved=function(e,t){};BX.IM.ScreenSharing.prototype.onIceCandidate=function(e,t){BX.ajax({url:this.BXIM.pathToCallAjax+"?CALL_SIGNALING",method:"POST",dataType:"json",timeout:30,data:{IM_SHARING:"Y",COMMAND:"signaling",USER_ID:e,PEER:JSON.stringify(t),IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()}})};BX.IM.ScreenSharing.prototype.peerConnectionError=function(e,t){this.callDecline()};BX.IM.ScreenSharing.prototype.peerConnectionReconnect=function(e){var t=this.parent.peerConnectionReconnect.apply(this,arguments);if(!t)return false;BX.ajax({url:this.BXIM.pathToCallAjax+"?CALL_RECONNECT",method:"POST",dataType:"json",timeout:30,data:{IM_SHARING:"Y",COMMAND:"reconnect",USER_ID:e,IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()},onsuccess:BX.delegate(function(){this.initPeerConnection(e,true)},this)});return true};BX.IM.ScreenSharing.prototype.deleteEvents=function(){BX.removeClass(this.webrtc.callOverlay,"bx-messenger-call-overlay-screen-sharing-self");BX.removeClass(this.webrtc.callOverlay,"bx-messenger-call-overlay-screen-sharing");this.webrtc.callOverlayVideoReserve.src="";this.attachMediaStream(this.webrtc.callOverlayVideoSelf,this.webrtc.callStreamSelf);this.attachMediaStream(this.webrtc.callOverlayVideoMain,this.webrtc.callStreamMain);this.webrtc.callOverlayVideoMain.play();this.webrtc.callOverlayVideoSelf.play();this.parent.deleteEvents.apply(this,arguments);var e=BX.findChildByClassName(BX("bx-messenger-call-overlay-button-screen"),"bx-messenger-call-overlay-button-screen");if(e)BX.removeClass(e,"bx-messenger-call-overlay-button-screen-off");return true};BX.IM.ScreenSharing.prototype.callInvite=function(){if(this.callInit){this.deleteEvents()}this.initiator=true;this.callVideo=true;this.callInit=true;this.callActive=true;this.callUserId=this.webrtc.callUserId;this.callInitUserId=BXIM.userId;this.callCommand("invite");var e=BX.findChildByClassName(BX("bx-messenger-call-overlay-button-screen"),"bx-messenger-call-overlay-button-screen");if(e)BX.addClass(e,"bx-messenger-call-overlay-button-screen-off")};BX.IM.ScreenSharing.prototype.callAnswer=function(){this.callActive=true;this.startGetUserMedia();this.callCommand("answer")};BX.IM.ScreenSharing.prototype.callDecline=function(e){if(!this.callInit)return false;e=e!==false;if(e){this.callCommand("decline")}this.deleteEvents()};BX.IM.ScreenSharing.prototype.callCommand=function(e,t){if(!this.signalingReady())return false;BX.ajax({url:this.BXIM.pathToCallAjax+"?CALL_COMMAND",method:"POST",dataType:"json",timeout:30,async:t!=false,data:{IM_SHARING:"Y",COMMAND:e,USER_ID:this.callUserId,IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()}})};BX.IM.DiskManager=function(e,t){this.BXIM=e;this.notify=t.notifyClass;this.desktop=t.desktopClass;this.enable=t.enable;this.enableExternal=t.enableExternal;this.lightVersion=e.ieVersion==8||e.ieVersion==9;this.formBlocked={};this.formAgents={};this.files=t.files;for(var s in this.files){this.files[s].date=new Date(this.files[s].date)}this.filesProgress={};this.filesMessage={};this.filesRegister={};this.fileTmpId=1;this.timeout={};BX.garbage(function(){var e={};var t=0;for(var s in this.filesMessage){e[s]=this.filesMessage[s];if(this.messenger.message[e[s]]){t=this.messenger.message[e[s]].chatId}}if(t>0){BX.ajax({url:this.BXIM.pathToFileAjax+"?FILE_TERMINATE&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,async:false,data:{IM_FILE_UNREGISTER:"Y",CHAT_ID:t,FILES:JSON.stringify(this.filesProgress),MESSAGES:JSON.stringify(e),IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()}})}},this)};BX.IM.DiskManager.prototype.getFileMenuIcon=function(){if(!this.enable)return null;return BX.create("div",{attrs:{title:BX.message("IM_F_UPLOAD_MENU")},props:{className:"bx-messenger-textarea-file"+(this.lightVersion?" bx-messenger-textarea-file-light":"")},children:[BX.create("div",{attrs:{title:this.BXIM.ieVersion>1?BX.message("IM_F_UPLOAD_MENU"):" "},props:{className:"bx-messenger-textarea-file-popup"+(this.BXIM.context=="LINES"?" bx-messenger-textarea-file-popup-short":"")},children:[this.messenger.popupMessengerFileForm=BX.create("form",{attrs:{action:this.BXIM.pathToFileAjax,style:this.lightVersion?"z-index: 0":""},props:{className:"bx-messenger-textarea-file-form"},children:[BX.create("input",{attrs:{type:"hidden",name:"IM_FILE_UPLOAD",value:"Y"}}),this.messenger.popupMessengerFileFormChatId=BX.create("input",{attrs:{type:"hidden",name:"CHAT_ID",value:0}}),this.messenger.popupMessengerFileFormRegChatId=BX.create("input",{attrs:{type:"hidden",name:"REG_CHAT_ID",value:0}}),this.messenger.popupMessengerFileFormRegMessageId=BX.create("input",{attrs:{type:"hidden",name:"REG_MESSAGE_ID",value:0}}),this.messenger.popupMessengerFileFormRegParams=BX.create("input",{attrs:{type:"hidden",name:"REG_PARAMS",value:""}}),this.messenger.popupMessengerFileFormRegMessageHidden=BX.create("input",{attrs:{type:"hidden",name:"REG_MESSAGE_HIDDEN",value:"N"}}),BX.create("input",{attrs:{type:"hidden",name:"IM_AJAX_CALL",value:"Y"}}),this.messenger.popupMessengerFileFormInput=BX.create("input",{attrs:{type:"file",multiple:"true",title:this.BXIM.ieVersion>1?BX.message("IM_F_UPLOAD_MENU"):" "},props:{className:"bx-messenger-textarea-file-popup-input"}})]}),this.lightVersion?null:BX.create("div",{props:{className:"bx-messenger-popup-menu-item"},html:BX.browser.IsMobile()?BX.message("IM_F_UPLOAD_MENU_1_M"):BX.message("IM_F_UPLOAD_MENU_1")}),this.lightVersion||this.BXIM.context=="LINES"?null:BX.create("div",{props:{className:"bx-messenger-menu-hr"}}),this.BXIM.context=="LINES"?null:BX.create("div",{props:{className:"bx-messenger-popup-menu-item"},html:BX.message("IM_F_UPLOAD_MENU_2"),events:{click:BX.delegate(function(){this.openFileDialog()},this)}}),BX.create("div",{props:{className:"bx-messenger-textarea-file-popup-arrow"}})]})],events:{click:BX.delegate(function(e){if(this.messenger.popupMessengerConnectionStatusState!="online")return false;if(BX.hasClass(this.messenger.popupMessengerFileButton,"bx-messenger-textarea-file-active")){setTimeout(BX.delegate(function(){this.messenger.closePopupFileMenu()},this),100)}else{if(parseInt(this.messenger.popupMessengerFileFormChatId.value)<=0){return false}if(this.messenger.popupMessengerFileFormInput.getAttribute("disabled")){return BX.PreventDefault(e)}this.messenger.closeMenuPopup();this.messenger.popupPopupMenuDateCreate=+new Date;BX.addClass(this.messenger.popupMessengerFileButton,"bx-messenger-textarea-file-active");BX.onCustomEvent("onImOpenFileMenu",[]);if(BX.MessengerCommon.isPage()){BX.addClass(this.messenger.popupMessengerFileButton,"bx-messenger-textarea-file-desktop")}this.messenger.setClosingByEsc(false)}},this)}})};BX.IM.DiskManager.prototype.drawHistoryFiles=function(e,t,s){if(!this.enable)return[];if(typeof this.files[e]=="undefined")return[];var i=[];if(typeof t!="object"){t=parseInt(t);if(typeof this.files[e][t]=="undefined")return[];i.push(t)}else{i=t}s=s||{};var a=true;var n=[];for(var o=0;o<i.length;o++){var r=this.files[e][i[o]];if(!r)continue;if(!(r.status=="done"||r.status=="error"))continue;var l=BX.MessengerCommon.formatDate(r.date,[["tommorow","tommorow"],["today","today"],["yesterday","yesterday"],["",BX.Main.Date.convertBitrixFormat(BX.message("FORMAT_DATE"))]]);var p=BX.create("span",{props:{className:"bx-messenger-file-user"},children:[BX.create("span",{props:{className:"bx-messenger-file-author"},html:this.messenger.users[r.authorId]?this.messenger.users[r.authorId].name:r.authorName}),BX.create("span",{props:{className:"bx-messenger-file-date"},html:l})]});var h=null;if(r.type=="image"&&(r.preview||r.urlPreview)){if(r.urlPreview){var c=BX.create("img",{attrs:{src:r.urlPreview},props:{className:"bx-messenger-file-image-text"}})}else if(r.preview&&typeof r.preview!="string"){var c=r.preview}else{var c=BX.create("img",{attrs:{src:r.preview},props:{className:"bx-messenger-file-image-text"}})}if(a&&r.urlShow){h=BX.create("div",{props:{className:"bx-messenger-file-preview"},children:[BX.create("span",{props:{className:"bx-messenger-file-image"},children:[BX.create("a",{attrs:{href:r.urlShow,target:"_blank"},props:{className:"bx-messenger-file-image-src"},children:[c]})]}),BX.create("br")]})}else{h=BX.create("div",{props:{className:"bx-messenger-file-preview"},children:[BX.create("span",{props:{className:"bx-messenger-file-image"},children:[BX.create("span",{props:{className:"bx-messenger-file-image-src"},children:[c]})]}),BX.create("br")]})}}var u=r.name;if(u.length>23){u=u.substr(0,10)+"..."+u.substr(u.length-10,u.length)}var d=BX.create("span",{attrs:{title:r.name},props:{className:"bx-messenger-file-title"},html:u});if(a&&(r.urlShow||r.urlDownload)){d=BX.create("a",{props:{className:"bx-messenger-file-title-href"},attrs:{href:r.urlShow?r.urlShow:r.urlDownload,target:"_blank"},children:[d]})}d=BX.create("div",{props:{className:"bx-messenger-file-attrs"},children:[d,BX.create("span",{props:{className:"bx-messenger-file-size"},html:BX.UploaderUtils.getFormattedSize(r.size)}),BX.create("span",{attrs:{title:BX.message("IM_F_MENU")},props:{className:"bx-messenger-file-menu"}})]});var m=null;if(r.status=="error"){m=BX.create("span",{props:{className:"bx-messenger-file-status-error"},html:r.errorText?r.errorText:BX.message("IM_F_ERROR")})}if(i.length==1&&s.showInner=="Y"){n=[p,d,h,m]}else{n.push(BX.create("div",{attrs:{id:"im-file-history-panel-"+r.id,"data-chatId":r.chatId,"data-fileId":r.id},props:{className:"bx-messenger-file"},children:[p,d,h,m]}))}if(i.length==1&&s.getElement=="Y"){n=n[0]}}return n};BX.IM.DiskManager.prototype.chatDialogInit=function(){if(!this.messenger.popupMessengerFileFormInput||!BX.Uploader)return false;this.formAgents["imDialog"]=BX.Uploader.getInstance({id:"imDialog",allowUpload:"A",uploadMethod:"immediate",showImage:true,filesInputMultiple:true,input:this.messenger.popupMessengerFileFormInput,dropZone:this.messenger.popupMessengerBodyDialog,fields:{regTmpMessageId:{value:null},regHiddenMessageId:{value:null},regParams:{value:null},preview:{params:{width:"500",height:"500"}}}});BX.addCustomEvent(this.formAgents["imDialog"],"onAttachFiles",BX.delegate(function(e,t,s){if(this.messenger.popupMessengerFileFormInput.getAttribute("disabled"))return false;var i=s.form.CHAT_ID.value;if(this.messenger.chat[i]&&this.messenger.chat[i].type=="open"&&!BX.MessengerCommon.userInChat(i)){while(e.length>0){e.pop()}}else if(this.messenger.chat[i]&&i==this.messenger.generalChatId&&!this.messenger.canSendMessageGeneralChat){while(e.length>0){e.pop()}}},this));BX.addCustomEvent(this.formAgents["imDialog"].dropZone,"dragEnter",BX.delegate(function(e){if(this.messenger.currentTab.toString().substr(0,4)=="chat"){var t=this.messenger.getChatId();if(this.messenger.chat[t].type=="open"){if(!BX.MessengerCommon.userInChat(t))return false}if(t==this.messenger.generalChatId&&!this.messenger.canSendMessageGeneralChat){return false}if(this.messenger.chat[t]&&this.messenger.chat[t].type==="announcement"&&this.messenger.chat[t].manager_list&&!this.messenger.chat[t].manager_list.map(function(e){return parseInt(e)}).includes(parseInt(this.BXIM.userId))){return false}}if(parseInt(this.messenger.popupMessengerFileFormChatId.value)<=0||this.messenger.popupMessengerFileFormInput.getAttribute("disabled"))return false;var s=false;if(e&&e["dataTransfer"]&&e["dataTransfer"]["types"]){for(var i in e["dataTransfer"]["types"]){if(e["dataTransfer"]["types"][i]==="Files"){s=true;break}}}if(s===false)return false;BX.style(this.messenger.popupMessengerFileDropZone,"display","block");BX.style(this.messenger.popupMessengerFileDropZone,"width",this.messenger.popupMessengerBodyDialog.offsetWidth-2+"px");BX.style(this.messenger.popupMessengerFileDropZone,"height",this.messenger.popupMessengerBodyDialog.offsetHeight-2+"px");clearTimeout(this.messenger.popupMessengerFileDropZoneTimeout);this.messenger.popupMessengerFileDropZoneTimeout=setTimeout(BX.delegate(function(){BX.addClass(this.messenger.popupMessengerFileDropZone,"bx-messenger-file-dropzone-active")},this),10)},this));BX.addCustomEvent(this.formAgents["imDialog"].dropZone,"dragLeave",BX.delegate(function(){if(this.messenger.currentTab.toString().substr(0,4)=="chat"&&this.messenger.chat[this.messenger.currentTab.substr(4)].type=="open"){if(!BX.MessengerCommon.userInChat(this.messenger.currentTab.substr(4)))return false}BX.removeClass(this.messenger.popupMessengerFileDropZone,"bx-messenger-file-dropzone-active");clearTimeout(this.messenger.popupMessengerFileDropZoneTimeout);this.messenger.popupMessengerFileDropZoneTimeout=setTimeout(BX.delegate(function(){BX.style(this.messenger.popupMessengerFileDropZone,"display","none");BX.style(this.messenger.popupMessengerFileDropZone,"width",0);BX.style(this.messenger.popupMessengerFileDropZone,"height",0)},this),300)},this));BX.addCustomEvent(this.formAgents["imDialog"],"onError",BX.delegate(BX.MessengerCommon.diskChatDialogUploadError,BX.MessengerCommon));BX.addCustomEvent(this.formAgents["imDialog"],"onFileinputIsReinited",BX.delegate(function(e){if(!e&&!this.formAgents["imDialog"].fileInput)return false;this.messenger.popupMessengerFileFormInput=e?e:this.formAgents["imDialog"].fileInput;if(parseInt(this.messenger.popupMessengerFileFormChatId.value)<=0){this.messenger.popupMessengerFileFormInput.setAttribute("disabled",true)}},this));BX.addCustomEvent(this.formAgents["imDialog"],"onFileIsCreated",BX.delegate(function(e,t,s){BX.MessengerCommon.diskChatDialogFileInited(e,t,s);BX.addCustomEvent(t,"onUploadStart",BX.delegate(BX.MessengerCommon.diskChatDialogFileStart,BX.MessengerCommon));BX.addCustomEvent(t,"onUploadProgress",BX.delegate(BX.MessengerCommon.diskChatDialogFileProgress,BX.MessengerCommon));BX.addCustomEvent(t,"onUploadDone",BX.delegate(BX.MessengerCommon.diskChatDialogFileDone,BX.MessengerCommon));BX.addCustomEvent(t,"onUploadError",BX.delegate(BX.MessengerCommon.diskChatDialogFileError,BX.MessengerCommon))},this));if(BX.DiskFileDialog){if(!this.flagFileDialogInited){BX.addCustomEvent(BX.DiskFileDialog,"inited",BX.proxy(this.initEventFileDialog,this));this.flagFileDialogInited=true}BX.addCustomEvent(BX.DiskFileDialog,"loadItems",BX.delegate(function(e,t){if(t!="im-file-dialog")return false;BX.DiskFileDialog.target[t]=e.replace("/bitrix/tools/disk/uf.php",this.BXIM.pathToFileAjax)},this))}};BX.IM.DiskManager.prototype.saveToDiskAction=function(e,t){var s=BX.Disk.showActionModal({html:BX.message("IM_DISK_VIEWER_DESCR_PROCESS_SAVE_FILE_TO_OWN_FILES").replace("#NAME#",'<a href="#" class="bx-viewer-file-link">'+e.title+"</a>"),showLoaderIcon:true,autoHide:false});var i=BX.rest.callMethod("im.disk.file.save",{FILE_ID:t.fileId});if(i){i.then(function(e){var t=e.data();var s=BXIM.path.disk.localFile.replace("_FILE_ID_",t.file.id);BX.Disk.showActionModal({html:BX.message("IM_DISK_VIEWER_DESCR_SAVE_FILE_TO_OWN_FILES").replace("#NAME#",t.file.name).replace("#FOLDER#",'<a href="'+s+'" target="_blank">'+t.folder.name+"</a>"),showLoaderIcon:false,autoHide:true})}.bind(this)).catch(function(e){s.destroy()}.bind(this))}};BX.IM.DiskManager.prototype.saveToDisk=function(e,t,s){if(!this.files[e]||!this.files[e][t])return false;if(this.files[e][t].saveToDiskBlock)return false;s=s||{};this.files[e][t].saveToDiskBlock=true;var i=s.boxId?s.boxId:"im-file";var a=BX(i+"-"+t);var n=BX.findChildByClassName(a,"bx-messenger-file-download-disk");if(n){BX.addClass(n,"bx-messenger-file-download-block");n.innerHTML=BX.message("IM_SAVING")}else if(i=="im-file-history-panel"){n=BX.findChildByClassName(a,"bx-messenger-file-date");if(n){BX.addClass(n.parentNode.parentNode,"bx-messenger-file-download-block");n.setAttribute("data-date",n.innerHTML);n.innerHTML=BX.message("IM_SAVING")}}BX.ajax({url:this.BXIM.pathToFileAjax+"?FILE_SAVE_TO_DISK&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_FILE_SAVE_TO_DISK:"Y",CHAT_ID:e,FILE_ID:t,IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()},onsuccess:BX.delegate(function(s){this.files[e][t].saveToDiskBlock=false;var a=BX(i+"-"+t);var n=BX.findChildByClassName(a,"bx-messenger-file-download-disk");if(n){BX.removeClass(n,"bx-messenger-file-download-block");n.innerHTML=BX.message("IM_F_DOWNLOAD_DISK")}else if(i=="im-file-history-panel"){n=BX.findChildByClassName(a,"bx-messenger-file-date");if(n){BX.removeClass(n.parentNode.parentNode,"bx-messenger-file-download-block");n.innerHTML=n.getAttribute("data-date")}n=BX.findChildByClassName(a,"bx-messenger-file-title")}if(n&&s.ERROR==""){var o=this.BXIM.path.disk.localFile.replace("_FILE_ID_",s.NEW_FILE_ID);this.messenger.tooltip(n,BX.message("IM_F_SAVE_OK_2").replace("#URL_START#",'<a href="'+o+'" target="_blank" class="bx-messenger-file-link">').replace("#URL_END#","</a>"))}else{this.messenger.tooltip(n,BX.message("IM_F_SAVE_ERR"))}},this),onfailure:BX.delegate(function(){this.files[e][t].saveToDiskBlock=false;var s=BX(i+"-"+t);var a=BX.findChildByClassName(s,"bx-messenger-file-download-disk");if(a){BX.removeClass(a,"bx-messenger-file-download-block");a.innerHTML=BX.message("IM_F_DOWNLOAD_DISK");this.messenger.tooltip(a,BX.message("IM_F_SAVE_ERR"))}else if(i=="im-file-history-panel"){a=BX.findChildByClassName(s,"bx-messenger-file-date");if(a){BX.removeClass(a.parentNode.parentNode,"bx-messenger-file-download-block");a.innerHTML=a.getAttribute("data-date")}}},this)})};BX.IM.DiskManager.prototype.deleteFile=function(e,t,s){if(!this.files[e]||!this.files[e][t])return false;if(this.files[e][t].saveToDiskBlock)return false;s=s||{};this.files[e][t].saveToDiskBlock=true;var i=s.boxId?s.boxId:"im-file";var a=BX(i+"-"+t);var n=BX.findChildByClassName(a,"bx-messenger-file-download-disk");if(n){BX.addClass(n,"bx-messenger-file-download-block");n.innerHTML=BX.message("IM_DELETING")}else if(i=="im-file-history-panel"){n=BX.findChildByClassName(a,"bx-messenger-file-date");if(n){BX.addClass(n.parentNode.parentNode,"bx-messenger-file-download-block");n.setAttribute("data-date",n.innerHTML);n.innerHTML=BX.message("IM_DELETING")}}BX.ajax({url:this.BXIM.pathToFileAjax+"?FILE_DELETE&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_FILE_DELETE:"Y",CHAT_ID:e,FILE_ID:t,IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()},onsuccess:BX.delegate(function(s){delete this.files[e][t];var a=BX.MessengerCommon.getRecipientByChatId(e);if(BX("im-file-history-"+t)){this.messenger.drawHistory(a)}if(BX("im-file-"+t)){BX.MessengerCommon.drawTab(a,true)}var n=BX(i+"-"+t);BX.style(n,"transform","scale(0, 0)");BX.style(n,"height",n.offsetHeight+"px");setTimeout(function(){BX.style(n,"height","0px")},500);setTimeout(function(){BX.remove(n)},700);this.messenger.loadHistoryFiles(e,true)},this),onfailure:BX.delegate(function(){this.files[e][t].saveToDiskBlock=false;var s=BX(i+"-"+t);var a=BX.findChildByClassName(s,"bx-messenger-file-download-disk");if(a){BX.removeClass(a,"bx-messenger-file-download-block");a.innerHTML=BX.message("IM_F_DOWNLOAD_DISK");this.messenger.tooltip(a,BX.message("IM_F_SAVE_ERR"))}else if(i=="im-file-history-panel"){a=BX.findChildByClassName(s,"bx-messenger-file-date");if(a){BX.removeClass(a.parentNode.parentNode,"bx-messenger-file-download-block");a.innerHTML=a.getAttribute("data-date")}}},this)})};BX.IM.DiskManager.prototype.openFileDialog=function(){this.messenger.setClosingByEsc(false);BX.ajax({url:this.BXIM.pathToFileAjax+"?action=selectFile&dialogName=im-file-dialog",method:"GET",skipAuthCheck:true,timeout:30,onsuccess:BX.delegate(function(e){if(typeof e=="object"&&e.error){this.messenger.setClosingByEsc(true)}},this),onfailure:BX.delegate(function(){this.messenger.setClosingByEsc(true)},this)})};BX.IM.DiskManager.prototype.initEventFileDialog=function(e){if(e!="im-file-dialog"||!BX.DiskFileDialog)return false;BX.DiskFileDialog.obCallback[e]={saveButton:BX.delegate(function(e,t,s){this.uploadFromDisk(e,t,s)},this),popupShow:BX.delegate(function(){BX.DiskFileDialog.popupWindow.params.zIndex+=BX.MessengerCommon.getDefaultZIndex();BX.DiskFileDialog.popupWindow.adjustPosition();BX.bind(BX.DiskFileDialog.popupWindow.popupContainer,"click",BX.MessengerCommon.preventDefault);this.messenger.setClosingByEsc(false)},this),popupDestroy:BX.delegate(function(){this.messenger.setClosingByEsc(true)},this)};BX.DiskFileDialog.openDialog(e)};BX.IM.DiskManager.prototype.uploadFromDisk=function(e,t,s,i){i=i||"";var a=this.messenger.popupMessengerFileFormChatId.value;if(!this.files[a])this.files[a]={};var n=[];for(var o in s){var r=o.replace("n","");this.files[a]["disk"+r]={id:"disk"+r,templateId:"disk"+r,chatId:a,date:new Date(s[o].modifyDateInt*1e3),type:"file",preview:"",name:s[o].name,size:s[o].sizeInt,status:"upload",progress:-1,authorId:this.BXIM.userId,authorName:this.messenger.users[this.BXIM.userId].name,urlPreview:"",urlShow:"",urlDownload:""};n.push("disk"+r)}var l=0;if(this.messenger.chat[a]){l="chat"+a}else{for(var p in this.messenger.userChat){if(this.messenger.userChat[p]==a){l=p;break}}}if(!l)return false;var h="N";if(l.toString().substr(0,4)=="chat"&&this.BXIM.messenger.linesSilentMode&&this.BXIM.messenger.linesSilentMode[a]){h="Y"}var c="tempFile"+this.fileTmpId;this.messenger.message[c]={id:c,chatId:a,senderId:this.BXIM.userId,recipientId:l,date:new Date,text:i,params:{FILE_ID:n,CLASS:h=="Y"?"bx-messenger-content-item-system":""}};if(!this.messenger.showMessage[l])this.messenger.showMessage[l]=[];this.messenger.showMessage[l].push(c);BX.MessengerCommon.drawMessage(l,this.messenger.message[c]);BX.MessengerCommon.drawProgessMessage(c);this.messenger.sendMessageFlag++;this.messenger.popupMessengerFileFormInput.setAttribute("disabled",true);BX.ajax({url:this.BXIM.pathToFileAjax+"?FILE_UPLOAD_FROM_DISK&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_FILE_UPLOAD_FROM_DISK:"Y",CHAT_ID:a,RECIPIENT_ID:l,MESSAGE:i,MESSAGE_TMP_ID:c,OL_SILENT:h,FILES:JSON.stringify(n),IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()},onsuccess:BX.delegate(function(e){if(e.ERROR!=""){this.messenger.sendMessageFlag--;delete this.messenger.message[c];BX.MessengerCommon.drawTab(l);return false}this.messenger.sendMessageFlag--;var t=[];var s={};for(var i in e.FILES){var a=e.FILES[i];if(parseInt(a.id)>0){a.date=new Date(a.date);this.files[e.CHAT_ID][a.id]=a;delete this.files[e.CHAT_ID][i];if(BX("im-file-"+i)){BX("im-file-"+i).setAttribute("data-fileId",a.id);BX("im-file-"+i).id="im-file-"+a.id;BX.MessengerCommon.diskRedrawFile(e.CHAT_ID,a.id)}t.push(a.id)}else{this.files[e.CHAT_ID][i]["status"]="error";BX.MessengerCommon.diskRedrawFile(e.CHAT_ID,i)}}this.messenger.message[e.MESSAGE_ID]=BX.clone(this.messenger.message[e.MESSAGE_TMP_ID]);this.messenger.message[e.MESSAGE_ID]["id"]=e.MESSAGE_ID;this.messenger.message[e.MESSAGE_ID]["params"]["FILE_ID"]=t;if(this.messenger.popupMessengerLastMessage==e.MESSAGE_TMP_ID)this.messenger.popupMessengerLastMessage=e.MESSAGE_ID;delete this.messenger.message[e.MESSAGE_TMP_ID];var n=BX.util.array_search(""+e.MESSAGE_TMP_ID+"",this.messenger.showMessage[e.RECIPIENT_ID]);if(this.messenger.showMessage[e.RECIPIENT_ID][n])this.messenger.showMessage[e.RECIPIENT_ID][n]=""+e.MESSAGE_ID+"";if(BX("im-message-"+e.MESSAGE_TMP_ID)){BX("im-message-"+e.MESSAGE_TMP_ID).id="im-message-"+e.MESSAGE_ID;var o=BX.findChild(this.messenger.popupMessengerBodyWrap,{attribute:{"data-messageid":""+e.MESSAGE_TMP_ID}},true);if(o){o.setAttribute("data-messageid",""+e.MESSAGE_ID+"");if(o.getAttribute("data-blockmessageid")==""+e.MESSAGE_TMP_ID)o.setAttribute("data-blockmessageid",""+e.MESSAGE_ID+"")}else{var r=BX.findChild(this.messenger.popupMessengerBodyWrap,{attribute:{"data-blockmessageid":""+e.MESSAGE_TMP_ID}},true);if(r){r.setAttribute("data-blockmessageid",""+e.MESSAGE_ID+"")}}var p=BX.findChildByClassName(o,"bx-messenger-content-item-date");if(p)p.innerHTML=" &nbsp; "+BX.MessengerCommon.formatDate(this.messenger.message[e.MESSAGE_ID].date,BX.MessengerCommon.getDateFormatType("MESSAGE"))}BX.MessengerCommon.clearProgessMessage(e.MESSAGE_ID);if(this.messenger.history[e.RECIPIENT_ID])this.messenger.history[e.RECIPIENT_ID].push(e.MESSAGE_ID);else this.messenger.history[e.RECIPIENT_ID]=[e.MESSAGE_ID];if(BX.MessengerCommon.enableScroll(this.messenger.popupMessengerBody,200)){if(this.BXIM.animationSupport){if(this.messenger.popupMessengerBodyAnimation!=null)this.messenger.popupMessengerBodyAnimation.stop();(this.messenger.popupMessengerBodyAnimation=new BX.easing({duration:800,start:{scroll:this.messenger.popupMessengerBody.scrollTop},finish:{scroll:this.messenger.popupMessengerBody.scrollHeight-this.messenger.popupMessengerBody.offsetHeight},transition:BX.easing.makeEaseInOut(BX.easing.transitions.quart),step:BX.delegate(function(e){this.messenger.popupMessengerBody.scrollTop=e.scroll},this)})).animate()}else{this.messenger.popupMessengerBody.scrollTop=this.messenger.popupMessengerBody.scrollHeight-this.messenger.popupMessengerBody.offsetHeight}}this.messenger.popupMessengerFileFormInput.removeAttribute("disabled")},this),onfailure:BX.delegate(function(){this.messenger.sendMessageFlag--;delete this.messenger.message[c];BX.MessengerCommon.drawTab(l)},this)});this.fileTmpId++};BX.IM.DiskManager.prototype.uploadFromClipboard=function(e,t){var s=e.map(function(e){var t=BX.UploaderUtils.dataURLToBlob(e.source);t.name=e.name;return t});t=t.trim();this.formAgents["imDialog"].messageText=t?t:"";this.formAgents["imDialog"].onChange(s);return true};BX.IM.DiskManager.prototype.chatAvatarInit=function(){if(!BX.Uploader)return false;if(this.messenger.popupMessengerPanelAvatarUpload2){this.formAgents["popupMessengerPanelAvatarUpload2"]=BX.Uploader.getInstance({id:"popupMessengerPanelAvatarUpload2",allowUpload:"I",uploadMethod:"immediate",showImage:false,input:this.messenger.popupMessengerPanelAvatarUpload2,dropZone:this.messenger.popupMessengerPanelAvatarUpload2.parentNode});BX.addCustomEvent(this.formAgents["popupMessengerPanelAvatarUpload2"],"onFileinputIsReinited",BX.delegate(function(e){if(!e&&!this.formAgents["popupMessengerPanelAvatarUpload2"].fileInput)return false;this.messenger.popupMessengerPanelAvatarUpload2=e?e:this.formAgents["popupMessengerPanelAvatarUpload2"].fileInput},this));BX.addCustomEvent(this.formAgents["popupMessengerPanelAvatarUpload2"],"onFileIsInited",BX.delegate(function(e,t,s){this.chatAvatarAttached(s);BX.addCustomEvent(t,"onUploadDone",BX.delegate(this.chatAvatarDone,this));BX.addCustomEvent(t,"onUploadError",BX.delegate(this.chatAvatarError,this))},this))}if(this.messenger.popupMessengerPanelAvatarUpload3){this.formAgents["popupMessengerPanelAvatarUpload3"]=BX.Uploader.getInstance({id:"popupMessengerPanelAvatarUpload3",allowUpload:"I",uploadMethod:"immediate",showImage:false,input:this.messenger.popupMessengerPanelAvatarUpload3,dropZone:this.messenger.popupMessengerPanelAvatarUpload3.parentNode});BX.addCustomEvent(this.formAgents["popupMessengerPanelAvatarUpload3"],"onFileinputIsReinited",BX.delegate(function(e){if(!e&&!this.formAgents["popupMessengerPanelAvatarUpload3"].fileInput)return false;this.messenger.popupMessengerPanelAvatarUpload3=e?e:this.formAgents["popupMessengerPanelAvatarUpload3"].fileInput},this));BX.addCustomEvent(this.formAgents["popupMessengerPanelAvatarUpload3"],"onFileIsInited",BX.delegate(function(e,t,s){this.chatAvatarAttached(s);BX.addCustomEvent(t,"onUploadDone",BX.delegate(this.chatAvatarDone,this));BX.addCustomEvent(t,"onUploadError",BX.delegate(this.chatAvatarError,this))},this))}};BX.IM.DiskManager.prototype.avatarFormIsBlocked=function(e,t,s){var i=this.formBlocked[t+"_"+e]||BX.MessengerCommon.checkRestriction(e,"AVATAR")?true:false;if(this.messenger.chat[e]&&this.messenger.chat[e].type==="announcement"&&this.messenger.chat[e].manager_list&&!this.messenger.chat[e].manager_list.map(function(e){return parseInt(e)}).includes(parseInt(this.BXIM.userId))){i=true}if(this.messenger.currentTab!="chat"+e)return i;var a=this.formAgents[t]&&this.formAgents[t].fileInput?this.formAgents[t].fileInput:null;if(a){if(i){a.title="";a.disabled=true;a.style.cursor="default"}else{a.title=BX.message("IM_M_AVATAR_UPLOAD");a.removeAttribute("disabled");a.style.cursor=""}}if(s){if(i){BX.addClass(s.firstChild,"bx-messenger-panel-avatar-progress-on")}else{BX.removeClass(s.firstChild,"bx-messenger-panel-avatar-progress-on")}BX.removeClass(s,"bx-messenger-panel-avatar-upload-error")}return i};BX.IM.DiskManager.prototype.chatAvatarAttached=function(e){if(!e.form.CHAT_ID)return false;this.formBlocked[e.id+"_"+e.form.CHAT_ID.value]=true;this.avatarFormIsBlocked(e.form.CHAT_ID.value,e.id,e.form)};BX.IM.DiskManager.prototype.chatAvatarDone=function(e,t,s,i){this.formBlocked[s.id+"_"+t.file.chatId]=false;this.avatarFormIsBlocked(t.file.chatId,s.id,s.form);this.messenger.updateChatAvatar(t.file.chatId,t.file.chatAvatar)};BX.IM.DiskManager.prototype.chatAvatarError=function(e,t,s,i){var a=s.streams.packages.getItem(i).data;this.formBlocked[s.id+"_"+a.CHAT_ID]=false;this.avatarFormIsBlocked(a.CHAT_ID,s.id,s.form);BX.addClass(s.form,"bx-messenger-panel-avatar-upload-error");s.fileInput.title=t.error};BX.IM.NotifyManager=function(e){this.stack=[];this.stackTimeout=null;this.stackPopup={};this.stackPopupTimeout={};this.stackPopupTimeout2={};this.stackPopupId=0;this.stackOverflow=false;this.blockNativeNotify=false;this.blockNativeNotifyTimeout=null;this.notifyShow=0;this.notifyHideTime=5e3;this.notifyHeightCurrent=10;this.notifyHeightMax=0;this.notifyGarbageTimeout=null;this.notifyAutoHide=true;this.notifyAutoHideTimeout=null;if(BX.browser.SupportLocalStorage()){BX.addCustomEvent(window,"onLocalStorageSet",BX.proxy(this.storageSet,this))}this.BXIM=e};BX.IM.NotifyManager.prototype.storageSet=function(e){if(e.key=="mnnb"){this.blockNativeNotify=true;clearTimeout(this.blockNativeNotifyTimeout);this.blockNativeNotifyTimeout=setTimeout(BX.delegate(function(){this.blockNativeNotify=false},this),1e3)}};BX.IM.NotifyManager.prototype.add=function(e){if(typeof e!="object"||!e.html)return false;if(BX.type.isDomNode(e.html))e.html=e.html.outerHTML;this.stack.push(e);if(!this.stackOverflow)this.setShowTimer(300)};BX.IM.NotifyManager.prototype.remove=function(e){delete this.stack[e]};BX.IM.NotifyManager.prototype.draw=function(){this.show()};BX.IM.NotifyManager.prototype.show=function(){this.notifyHeightMax=document.body.offsetHeight;var e=BX.GetWindowScrollPos();for(var t=0;t<this.stack.length;t++){if(typeof this.stack[t]=="undefined")continue;var s=new BX.PopupWindow("bx-im-notify-flash-"+this.stackPopupId,{top:"-1000px",left:0},{darkMode:this.BXIM.settings.enableDarkTheme,lightShadow:true,zIndex:BX.MessengerCommon.getDefaultZIndex()+1e4,events:{onPopupClose:BX.delegate(function(){BX.removeClass(BX.proxy_context.popupContainer,"bx-notifyManager-animation");BX.addClass(BX.proxy_context.popupContainer,"bx-notifyManager-animation-close");this.notifyShow--;this.notifyHeightCurrent-=BX.proxy_context.popupContainer.offsetHeight+10;this.stackOverflow=false;setTimeout(BX.delegate(function(){this.destroy()},BX.proxy_context),400)},this),onPopupDestroy:BX.delegate(function(){BX.unbindAll(BX.findChildByClassName(BX.proxy_context.popupContainer,"bx-notifier-item-delete"));BX.unbindAll(BX.proxy_context.popupContainer);delete this.stackPopup[BX.proxy_context.uniquePopupId];delete this.stackPopupTimeout[BX.proxy_context.uniquePopupId];delete this.stackPopupTimeout2[BX.proxy_context.uniquePopupId]},this)},bindOnResize:false,content:BX.create("div",{props:{className:"bx-notifyManager-item"},html:this.stack[t].html})});BX.addClass(s.popupContainer,"bx-messenger-mark");s.notifyParams=this.stack[t];s.notifyParams.id=t;s.show();BX.onCustomEvent(window,"onNotifyManagerShow",[this.stack[t]]);s.popupContainer.style.left=document.body.offsetWidth-s.popupContainer.offsetWidth-10+"px";s.popupContainer.style.opacity=0;if(this.notifyHeightMax<this.notifyHeightCurrent+s.popupContainer.offsetHeight+10){if(this.notifyShow>0){s.destroy();this.stackOverflow=true;break}}BX.addClass(s.popupContainer,"bx-notifyManager-animation");BX.addClass(s.popupContainer,"bx-messenger-mark");s.popupContainer.style.opacity=1;s.popupContainer.style.top=e.scrollTop+this.notifyHeightCurrent+"px";this.notifyHeightCurrent=this.notifyHeightCurrent+s.popupContainer.offsetHeight+10;this.stackPopupId++;this.notifyShow++;this.remove(t);this.stackPopupTimeout[s.uniquePopupId]=null;BX.bind(s.popupContainer,"mouseover",BX.delegate(function(){this.clearAutoHide()},this));BX.bind(s.popupContainer,"mouseout",BX.delegate(function(){this.setAutoHide(this.notifyHideTime/2)},this));BX.bind(s.popupContainer,"contextmenu",BX.delegate(function(e){if(this.stackPopup[BX.proxy_context.id].notifyParams.tag)this.closeByTag(this.stackPopup[BX.proxy_context.id].notifyParams.tag);else this.stackPopup[BX.proxy_context.id].close();return BX.PreventDefault(e)},this));var i=BX.findChildren(s.popupContainer,{tagName:"a"},true);for(var a=0;a<i.length;a++){if(i[a].href!="#")i[a].target="_blank"}BX.bind(BX.findChildByClassName(s.popupContainer,"bx-notifier-item-delete"),"click",BX.delegate(function(e){var t=BX.proxy_context.parentNode.parentNode.parentNode.parentNode.id.replace("popup-window-content-","");if(this.stackPopup[t].notifyParams.close)this.stackPopup[t].notifyParams.close(this.stackPopup[t]);this.stackPopup[t].close();if(this.notifyAutoHide==false){this.clearAutoHide();this.setAutoHide(this.notifyHideTime/2)}return BX.PreventDefault(e)},this));BX.bindDelegate(s.popupContainer,"click",{className:"bx-notifier-item-button-confirm"},BX.delegate(function(e){var t=BX.proxy_context.getAttribute("data-id");this.BXIM.notify.confirmRequest({notifyId:t,notifyValue:BX.proxy_context.getAttribute("data-value"),notifyURL:BX.proxy_context.getAttribute("data-url"),notifyTag:this.BXIM.notify.notify[t]&&this.BXIM.notify.notify[t].tag?this.BXIM.notify.notify[t].tag:null,groupDelete:BX.proxy_context.getAttribute("data-group")!=null},true);for(var s in this.stackPopup){if(this.stackPopup[s].notifyParams.notifyId==t)this.stackPopup[s].close()}if(this.notifyAutoHide==false){this.clearAutoHide();this.setAutoHide(this.notifyHideTime/2)}return BX.PreventDefault(e)},this));if(s.notifyParams.click){s.popupContainer.style.cursor="pointer";BX.bind(s.popupContainer,"click",BX.delegate(function(e){this.notifyParams.click(this);if(this.notifyParams.notifyId!="network")return BX.PreventDefault(e)},s))}this.stackPopup[s.uniquePopupId]=s}if(this.stack.length>0){this.clearAutoHide(true);this.setAutoHide(this.notifyHideTime)}this.garbage()};BX.IM.NotifyManager.prototype.closeByTag=function(e){for(var t=0;t<this.stack.length;t++){if(typeof this.stack[t]!="undefined"&&this.stack[t].tag==e){delete this.stack[t]}}for(var t in this.stackPopup){if(this.stackPopup[t].notifyParams.tag==e)this.stackPopup[t].close()}};BX.IM.NotifyManager.prototype.setShowTimer=function(e){clearTimeout(this.stackTimeout);this.stackTimeout=setTimeout(BX.delegate(this.draw,this),e)};BX.IM.NotifyManager.prototype.setAutoHide=function(e){this.notifyAutoHide=true;clearTimeout(this.notifyAutoHideTimeout);this.notifyAutoHideTimeout=setTimeout(BX.delegate(function(){for(var t in this.stackPopupTimeout){this.stackPopupTimeout[t]=setTimeout(BX.delegate(function(){this.close()},this.stackPopup[t]),e-1e3);this.stackPopupTimeout2[t]=setTimeout(BX.delegate(function(){this.setShowTimer(300)},this),e-700)}},this),1e3)};BX.IM.NotifyManager.prototype.clearAutoHide=function(e){clearTimeout(this.notifyGarbageTimeout);this.notifyAutoHide=false;e=e==true;if(e){clearTimeout(this.stackTimeout);for(var t in this.stackPopupTimeout){clearTimeout(this.stackPopupTimeout[t]);clearTimeout(this.stackPopupTimeout2[t])}}else{clearTimeout(this.notifyAutoHideTimeout);this.notifyAutoHideTimeout=setTimeout(BX.delegate(function(){clearTimeout(this.stackTimeout);for(var e in this.stackPopupTimeout){clearTimeout(this.stackPopupTimeout[e]);clearTimeout(this.stackPopupTimeout2[e])}},this),300)}};BX.IM.NotifyManager.prototype.garbage=function(){clearTimeout(this.notifyGarbageTimeout);this.notifyGarbageTimeout=setTimeout(BX.delegate(function(){var e=[];for(var t=0;t<this.stack.length;t++){if(typeof this.stack[t]!="undefined")e.push(this.stack[t])}this.stack=e},this),1e4)};BX.IM.NotifyManager.prototype.nativeNotify=function(e,t){if(!e.title||e.title.length<=0)return false;if(this.blockNativeNotify)return false;if(!t){setTimeout(BX.delegate(function(){if(this.blockNativeNotify)return false;this.nativeNotify(e,true)},this),Math.floor(Math.random()*151)+50);return true}BX.localStorage.set("mnnb",true,1);var s=new Notification(e.title,{tag:e.tag?e.tag:"",body:e.text?e.text:"",icon:e.icon?e.icon:""});if(typeof e.onshow=="function")s.onshow=e.onshow;if(typeof e.onclick=="function")s.onclick=e.onclick;if(typeof e.onclose=="function")s.onclose=e.onclose;if(typeof e.onerror=="function")s.onerror=e.onerror;return true};BX.IM.NotifyManager.prototype.nativeNotifyShow=function(){this.show()};BX.IM.NotifyManager.prototype.nativeNotifyGranted=function(){var e=BX.localStorage.get("imNativeNotify");return e&&window.Notification&&window.Notification.permission&&window.Notification.permission.toLowerCase()=="granted"};BX.IM.NotifyManager.prototype.nativeNotifyAccessForm=function(){if(BX.MessengerCommon.isDesktop()){return this.nativeDesktopNotifyAccessForm()}clearTimeout(this.BXIM.messenger.popupMessengerTopLineTimeout);if(!this.BXIM.messenger.popupMessengerTopLine)return false;var e=BX.localStorage.get("imNativeNotify");if(!this.BXIM.xmppStatus&&!this.BXIM.desktopStatus&&window.Notification&&window.Notification.permission&&window.Notification.permission.toLowerCase()!=="denied"){clearTimeout(this.popupMessengerDesktopTimeout);var t=BX.delegate(function(){BX.localStorage.set("imNativeNotify",true,3e6);Notification.requestPermission();this.BXIM.messenger.hideTopLine()},this);var s=BX.delegate(function(){BX.localStorage.set("imNativeNotify",false,3e6);this.BXIM.saveSettings({nativeNotify:this.BXIM.settings.nativeNotify});this.BXIM.messenger.hideTopLine()},this);this.BXIM.messenger.showTopLine(BX.message("IM_WN_MAC")+"<br />"+BX.message("IM_WN_TEXT"),[{title:BX.message("IM_WN_ACCEPT"),callback:t},{title:BX.message("IM_DESKTOP_INSTALL_N"),callback:s}],BX.delegate(function(){BX.localStorage.set("imNativeNotify",false,86400);this.BXIM.messenger.hideTopLine()},this))}else{return false}return true};BX.IM.NotifyManager.prototype.nativeDesktopNotifyAccessForm=function(){clearTimeout(this.popupMessengerDesktopTimeout);var e=BX.delegate(function(){BXDesktopSystem.Notify("Native notification","","The desktop application requests the right to display notifications");BX.desktop.setLocalConfig("nativeNotify",true);this.BXIM.messenger.hideTopLine()},this);var t=BX.delegate(function(){BX.desktop.setLocalConfig("nativeNotify",false);this.BXIM.messenger.hideTopLine()},this);this.BXIM.messenger.showTopLine(BX.message("IM_WN_MAC")+"<br />"+BX.message("IM_WN_TEXT"),[{title:BX.message("IM_WN_ACCEPT"),callback:e},{title:BX.message("IM_DESKTOP_INSTALL_N"),callback:t}],BX.delegate(function(){this.BXIM.messenger.hideTopLine()},this))};BX.IM.LevelMeter=function(e){this.element=e;this.maximumLevel=1;this.mediaStream=null;this.audioContext=null;this.mediaStreamNode=null;this.scriptNode=null;this.instant=0;this.slow=0;this.clip=0;this.supported=window.AudioContext||window.webkitAudioContext;this.animationInterval=null;this.mask=BX.create("div",{attrs:{className:"bx-messenger-settings-level-meter-mask"}});this.filler=BX.create("div",{attrs:{className:"bx-messenger-settings-level-meter-filler"}});this.element.appendChild(this.mask);this.mask.appendChild(this.filler)};BX.IM.LevelMeter.prototype.render=function(){var e=Math.floor(this.slow*100);this.filler.style.width=e+"%"};BX.IM.LevelMeter.prototype.attachMediaStream=function(e){var t=this;if(!(e instanceof MediaStream))return;this.stop();this.audioContext=new(window.AudioContext||window.webkitAudioContext);this.scriptNode=this.audioContext.createScriptProcessor(2048,1,1);this.scriptNode.connect(this.audioContext.destination);this.mediaStream=e;this.mediaStreamNode=this.audioContext.createMediaStreamSource(this.mediaStream);this.mediaStreamNode.connect(this.scriptNode);this.scriptNode.onaudioprocess=function(e){var s=e.inputBuffer.getChannelData(0);var i;var a=0;var n=0;for(i=0;i<s.length;++i){a+=s[i]*s[i];if(Math.abs(s[i])>.99){n+=1}}t.instant=Math.sqrt(a/s.length);t.slow=.75*t.slow+.25*t.instant;t.clip=n/s.length};this.animationInterval=setInterval(this.render.bind(this),200)};BX.IM.LevelMeter.prototype.getVolume=function(){return{instant:this.instant,slow:this.slow}};BX.IM.LevelMeter.prototype.stop=function(){if(this.scriptNode)this.scriptNode.disconnect();if(this.mediaStreamNode)this.mediaStreamNode.disconnect();if(this.audioContext)this.audioContext.close();if(this.animationInterval)clearInterval(this.animationInterval);this.scriptNode=null;this.mediaStreamNode=null;this.mediaStream=null;this.audioContext=null;this.animationInterval=null}})();BX.PopupWindowSlider=function(){this.closeByEsc=true;this.setClosingByEsc=function(e){this.closeByEsc=e};this.close=function(){};this.destroy=function(){}};var MessengerSlider=function(){this.instances=new Map;BX.addCustomEvent("SidePanel.Slider:onCloseByEsc",function(e){var t=e.getSlider().getUrl().toString();if(!t.startsWith("im:slider")){return false}if(!this.canCloseByEsc()){e.denyAction()}}.bind(this));BX.addCustomEvent("SidePanel.Slider:onClose",function(e){var t=e.getSlider().getUrl().toString();if(!t.startsWith("im:slider")){return false}if(!this.canClose()){e.denyAction();return false}this.BXIM.messenger.closeMenuPopup();if(this.BXIM.messenger.popupHistory){this.BXIM.messenger.popupHistory.destroy()}if(BX.DiskFileDialog&&BX.DiskFileDialog.popupWindow){BX.DiskFileDialog.popupWindow.close()}var s=parseInt(t.substr(10));this.instances.delete(s);this.recover(this.getCurrent())}.bind(this));BX.addCustomEvent("SidePanel.Slider:onDestroy",function(e){var t=e.getSlider().getUrl().toString();if(!t.startsWith("im:slider")){return false}var s=parseInt(t.substr(10));this.instances.delete(s);this.recover(this.getCurrent());if(this.count()<=0){this.BXIM.messenger.closeMessenger()}}.bind(this))};MessengerSlider.prototype.count=function(){return this.instances.size};MessengerSlider.prototype.getCurrent=function(){return this.instances.get(this.getCurrentId())};MessengerSlider.prototype.getCurrentId=function(){return this.count()};MessengerSlider.prototype.getNextId=function(){return this.getCurrentId()+1};MessengerSlider.prototype.isOpen=function(){return this.count()>0};MessengerSlider.prototype.isFocus=function(){if(!this.isOpen()){return false}var e=BX.SidePanel.Instance.getTopSlider();if(!e){return false}if(e.getUrl().toString().startsWith("im:slider")){return true}return false};MessengerSlider.prototype.canClose=function(){if(this.BXIM.callController.hasActiveCall()){this.BXIM.openConfirm(BX.message("IM_M_CALL_CLOSE_CHAT"),[new BX.PopupWindowButton({text:BX.message("IM_M_CALL_CLOSE_CHAT_YES"),className:"popup-window-button-decline",events:{click:BX.delegate(function(){this.BXIM.callController.currentCall.hangup();this.close();BX.proxy_context.popupWindow.close()},this)}}),new BX.PopupWindowButton({text:BX.message("IM_M_CALL_CLOSE_CHAT_NO"),className:"popup-window-button",events:{click:function(){this.popupWindow.close()}}})]);return false}return true};MessengerSlider.prototype.canCloseByEsc=function(){var e=true;if(this.BXIM.messenger.popupSmileMenu){}else if(this.BXIM.messenger.popupMessengerFileButton!=null&&BX.hasClass(this.BXIM.messenger.popupMessengerFileButton,"bx-messenger-textarea-file-active")){}else if(this.BXIM.messenger.popupPopupMenu){}else if(this.BXIM.messenger.popupChatDialog&&this.BXIM.messenger.popupChatDialogContactListSearch.value.length>=0){}else if(this.BXIM.extraOpen){}else if(this.BXIM.messenger.renameChatDialogInput&&this.BXIM.messenger.renameChatDialogInput.value.length>0){}else if(this.BXIM.messenger.popupContactListSearchInput&&(this.BXIM.messenger.popupContactListSearchInput.value.length>0||this.BXIM.messenger.chatList)){}else{if(BX.util.trim(this.BXIM.messenger.popupMessengerEditTextarea.value).length>0){}else if(BX.util.trim(this.BXIM.messenger.popupMessengerTextarea.value).length<=0&&!this.BXIM.callController.hasActiveCall()){e=false}}return!e};MessengerSlider.prototype.recover=function(e){if(!e||!e.getData().has("currentTab")){return false}var t=e.getData().get("currentTab");e.getData().delete("currentTab");e.getContentContainer().appendChild(BX.MessengerWindow.content);this.BXIM.messenger.openChatFlag=t.toString().substr(0,4)=="chat";BX.MessengerCommon.openDialog(t,this.BXIM.dialogOpen?false:true);e.closeLoader();return true};MessengerSlider.prototype.open=function(){return new Promise(function(e,t){if(this.isFocus()){return e()}var s=this.getNextId();var i=this.getCurrent();if(i){i.showLoader();i.getContentContainer().innerHTML="";i.getData().set("currentTab",this.BXIM.messenger.currentTab)}var a="/bitrix/js/im/images/im-loader"+(this.BXIM.settings.enableDarkTheme?".dark":"")+".min.svg";if(this.BXIM.messenger.externalMenu){a="/bitrix/js/im/images/im-loader-page"+(this.BXIM.settings.enableDarkTheme?".dark":"")+".min.svg"}BX.SidePanel.Instance.open("im:slider:"+s,{data:{rightBoundary:0},cacheable:false,animationDuration:100,customLeftBoundary:0,loader:a,width:this.BXIM.fullScreen?undefined:1200,contentCallback:function(e){return BX.MessengerWindow.content},label:{text:BX.message("IM_SLIDER_TITLE")},events:{onOpenComplete:function(t){e()},onLoad:function(e){e.slider.showLoader();BX.MessengerWindow.drawAppearance();BX.MessengerWindow.drawTabs();BX.MessengerWindow.adjustSize();if(BXIM.settings.enableDarkTheme){e.slider.getContentContainer().classList.add("bx-messenger-dark")}}}});this.instances.set(s,BX.SidePanel.Instance.getSlider("im:slider:"+s))}.bind(this))};MessengerSlider.prototype.close=function(){if(!this.isOpen()){return false}BX.SidePanel.Instance.close("im:slider:"+this.getCurrentId())};MessengerSlider.prototype.setBxIm=function(e){this.BXIM=e};BX.MessengerSlider=new MessengerSlider;var MessengerCalls=function(){this.calls=[]};MessengerCalls.prototype.draw=function(e,t){t=t||false;e.dialogId=e.dialogId.toString();e.time=+new Date+15e3;var s=this.calls.findIndex(function(t){return t.dialogId===e.dialogId});if(s>-1){this.calls[s]=e;if(t){BX.MessengerCommon.recentListRedraw()}}else{this.calls.push(e);BX.MessengerCommon.recentListRedraw()}};MessengerCalls.prototype.hide=function(e){e=e.toString();this.calls=this.calls.filter(function(t){return t.dialogId!==e});BX.MessengerCommon.recentListRedraw()};MessengerCalls.prototype.get=function(){return this.calls};MessengerCalls.prototype.hasActiveCall=function(e){if(!this.BXIM||this.BXIM.callController.hasActiveCall()){return true}e=e?e.toString():"";var t;if(e){t=function(t){return t.dialogId===e&&t.state==="join"}}else{t=function(e){return e.state==="join"}}var s=this.calls.find(t);return!!s};MessengerCalls.prototype.hasWaitCall=function(e){if(this.hasActiveCall()){return false}e=e?e.toString():"";var t;if(e){t=function(t){return t.dialogId===e&&t.state==="wait"}}else{t=function(e){return e.state==="wait"}}var s=this.calls.find(t);return!!s};MessengerCalls.prototype.drawElement=function(e){if(!e||!e.dialogId)return null;var t=e.dialogId;var s=t.includes("chat");if(s){entity=this.BXIM.messenger.chat[t.substr(4)]||null}else{entity=this.BXIM.messenger.users[t]||null}if(!entity){this.hide(e.dialogId);return false}if(!entity.avatar){entity.avatar=e.call.associatedEntity.avatar||this.BXIM.pathToBlankImage}var i=e.call.associatedEntity.name||entity.name;var a=entity.avatar||"";var n=entity.color||"#3e99ce";n=BX.MessengerCommon.isBlankAvatar(entity.avatar)?'style="background-color: '+entity.color+'"':"";var o=s&&n?"bx-messenger-cl-avatar-status-hide":"";var r="";var l="bx-messenger-cl-item bx-messenger-cl-item-call bx-messenger-cl-id-"+t;if(t.includes("chat")){r="bx-messenger-cl-avatar-"+entity.type;l+=" bx-messenger-cl-item-chat bx-messenger-cl-item-chat-"+entity.type}else{l+=" bx-messenger-cl-status-"+BX.MessengerCommon.getUserStatus(entity)}if(e.state==="join"){l+=" bx-messenger-cl-item-call-join"}else{l+=" bx-messenger-cl-item-call-wait"}if(!(e.state==="wait"&&s||e.state==="join"&&this.BXIM.callController.hasActiveCall())){l+=" bx-messenger-cl-item-call-single"}var p="private";if(t.includes("chat")){p=entity.type}return BX.create("span",{props:{className:l},events:{click:this.onClick.bind(this)},attrs:{"data-userId":t,"data-callState":e.state,"data-name":BX.util.htmlspecialcharsback(i),"data-status":"call","data-avatar":a,"data-userIsChat":t.includes("chat"),"data-chatType":p,"data-isPinned":false,"data-userIsQueue":false},html:'<span title="'+i+'" class="bx-messenger-cl-avatar '+r+" "+o+'">'+'<img class="bx-messenger-cl-avatar-img'+(n?" bx-messenger-cl-avatar-img-default":"")+'" src="'+a+'" '+n+">"+'<span class="bx-messenger-cl-status"></span>'+"</span>"+'<span class="bx-messenger-cl-user">'+'<div class="bx-messenger-cl-user-title'+(entity.extranet?" bx-messenger-user-extranet":"")+'" title="'+i+'">'+i+"</div>"+(e.state==="wait"&&s?'<div class="bx-messenger-cl-user-desc">'+BX.message("IM_M_CALL_BTN_JOIN")+"</div>":"")+(e.state==="join"&&this.BXIM.callController.hasActiveCall()?'<div class="bx-messenger-cl-user-desc">'+BX.message(s?"IM_M_CALL_BTN_DISCONNECT":"IM_M_CALL_BTN_HANGUP")+"</div>":"")+"</span>"})};MessengerCalls.prototype.onClick=function(e){var t;if(e.target.className.includes("bx-messenger-cl-item")){t=e.target}else{t=BX.findParent(e.target,{className:"bx-messenger-cl-item"})}var s=t.getAttribute("data-userId");var i=t.getAttribute("data-callState");var a=t.getAttribute("data-chatType");if(a==="videoconf"){var n=BX.MessengerCommon.getVideoconfLink(s);if(n){this.BXIM.openVideoconfByUrl(n)}BX.MessengerCommon.openDialog(s);return BX.MessengerCommon.preventDefault(e)}else if(i==="join"){if(e.target.className==="bx-messenger-cl-user-desc"){this.BXIM.callController.leaveCurrentCall()}else{this.BXIM.callController.unfold();BX.MessengerCommon.openDialog(s)}return BX.MessengerCommon.preventDefault(e)}var o=this.calls.find(function(e){return e.dialogId===s});if(e.target.className==="bx-messenger-cl-user-desc"){BXIM.messenger.openPopupMenu(e.target,"callJoin",true,{currentCall:o});return BX.MessengerCommon.preventDefault(e)}};MessengerCalls.prototype.onCallCreated=function(e){var t=e.call;t.addEventListener(BX.Call.Event.onJoin,this.onCallJoin.bind(this));t.addEventListener(BX.Call.Event.onLeave,this.onCallLeave.bind(this));t.addEventListener(BX.Call.Event.onDestroy,this.onCallDestroy.bind(this));this.draw({dialogId:t.associatedEntity.id,name:t.associatedEntity.name,call:t,state:"wait"})};MessengerCalls.prototype.onCallJoin=function(e){this.draw({dialogId:e.call.associatedEntity.id,call:e.call,state:"join"},true)};MessengerCalls.prototype.onCallLeave=function(e){this.draw({dialogId:e.call.associatedEntity.id,call:e.call,state:"wait"},true)};MessengerCalls.prototype.onCallDestroy=function(e){this.hide(e.call.associatedEntity.id)};MessengerCalls.prototype.setBxIm=function(e){this.BXIM=e;if(!this.BXIM.init){return false}BX.addCustomEvent(window,"CallEvents::callCreated",this.onCallCreated.bind(this));BX.addCustomEvent(window,"CallController::onFold",function(){BX.MessengerCommon.readMessage(this.BXIM.messenger.currentTab)}.bind(this));return true};BX.MessengerCalls=new MessengerCalls;var MessengerPromo=function(){this.promo={"im:video:01042020:web":BX.message("IM_PROMO_VIDEO_01042020_WEB").split("#BR#").join("<br>")};this.promoActive={}};MessengerPromo.prototype.init=function(e,t){this.BXIM=t;if(!this.BXIM.init){return false}if(!e||!Array.isArray(e)){return false}e.forEach(function(e){this.promoActive[e]=true}.bind(this))};MessengerPromo.prototype.show=function(e){if(!this.promoActive[e]){return false}var t=null;var s=[new BX.PopupWindowButton({text:BX.message("IM_NOTIFY_CONFIRM_CLOSE"),className:"popup-window-button-accept",events:{click:BX.delegate(function(e){BX.proxy_context.popupWindow.close()},this)}})];if(typeof this.promo[e]==="string"){t=this.promo[e]}this.BXIM.openConfirm(this.promo[e],s);this.read(e);this.save(e);return true};MessengerPromo.prototype.read=function(e){this.promoActive[e]=false};MessengerPromo.prototype.save=function(e){BX.rest.callMethod("im.promotion.read",{id:e})};BX.MessengerPromo=new MessengerPromo;(function(){if(BX.desktopUtils)return;BX.desktopUtils=function(){this.runningCheckTimeout={};this.checkUrl="http://127.0.0.1:20141/";this._openedBxLink=false};BX.desktopUtils.prototype.runningCheck=function(e,t,s){if(typeof e=="undefined"){return false}if(typeof t=="undefined"){t=function(){}}s=typeof s=="undefined"||!s?false:true;var i=+new Date;if(typeof BXDesktopSystem!=="undefined"){if(BX.MessengerCommon.isDesktop()){t(false,i)}else{e(true,i)}return true}else if(typeof BXIM=="undefined"||BX.MessengerCommon.isDesktop()||!BXIM.desktopStatus||BXIM.desktopVersion<18){t(false,i);return false}else if(BXIM.desktopVersion<35){if(s){t(false,i)}else{e(true,i)}return true}var a=false;var n=BX.create("img",{attrs:{src:this.checkUrl+"icon.png?"+i,"data-id":i},props:{className:"bx-messenger-out-of-view"},events:{error:function(){if(a){return}var e=this.getAttribute("data-id");t(false,e);clearTimeout(BX.desktopUtils.runningCheckTimeout[e]);BX.remove(this)},load:function(){var t=this.getAttribute("data-id");e(true,t);clearTimeout(BX.desktopUtils.runningCheckTimeout[t]);BX.remove(this)}}});document.body.appendChild(n);this.runningCheckTimeout[i]=setTimeout(function(){t(false,i);clearTimeout(BX.desktopUtils.runningCheckTimeout[i]);BX.remove(this);a=true},500);return true};BX.desktopUtils.prototype.goToBx=function(e){if(typeof BXIM!="undefined"&&BXIM.desktopVersion>=36&&!e.match(/^bx:\/\/v(\d)\//)){e=e.replace("bx://","bx://v"+BXIM.desktopProtocolVersion+"/"+location.hostname+"/")}this._setOpenedBxLink();location.href=e};BX.desktopUtils.prototype._setOpenedBxLink=function(){this._openedBxLink=true;setTimeout(function(){BX.onCustomEvent("BXLinkOpened",[]);this._openedBxLink=false}.bind(this),1e3)};BX.desktopUtils.prototype.isChangedLocationToBx=function(){return this._openedBxLink};BX.desktopUtils.prototype.encodeParams=function(e){if(!BX.type.isPlainObject(e))return"";var t="";var s=true;for(var i in e){t=t+(s?"":"!!")+i+"!!"+e[i];s=false}return t};BX.desktopUtils.prototype.decodeParams=function(e){var t={};if(!BX.type.isNotEmptyString(e))return t;var s=e.split("!!");for(var i=0;i<s.length;i=i+2){t[s[i]]=s[i+1]}return t};BX.desktopUtils=new BX.desktopUtils})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:51:"/bitrix/js/im/call/simple_vad.min.js?15995682282434";s:6:"source";s:32:"/bitrix/js/im/call/simple_vad.js";s:3:"min";s:36:"/bitrix/js/im/call/simple_vad.min.js";s:3:"map";s:36:"/bitrix/js/im/call/simple_vad.map.js";}"*/
(function(){if(BX.SimpleVAD){return}var t=.1;var i=2e3;BX.SimpleVAD=function(t){this.mediaStream=t.mediaStream;this.audioContext=null;this.mediaStreamNode=null;this.analyserNode=null;this.audioTimeDomainData=null;this.voiceState=false;this.measureInterval=0;this.inactivityTimeout=0;this.callbacks={voiceStarted:BX.type.isFunction(t.onVoiceStarted)?t.onVoiceStarted:BX.DoNothing,voiceStopped:BX.type.isFunction(t.onVoiceStopped)?t.onVoiceStopped:BX.DoNothing};if(BX.SimpleVAD.isSupported()){this.init()}};BX.SimpleVAD.isSupported=function(){return(window.AudioContext||window.webkitAudioContext)&&window.AnalyserNode&&typeof window.AnalyserNode.prototype["getFloatTimeDomainData"]==="function"};BX.SimpleVAD.prototype.init=function(){if(!(this.mediaStream instanceof MediaStream)){return false}this.audioContext=new(window.AudioContext||window.webkitAudioContext);this.analyserNode=this.audioContext.createAnalyser();this.analyserNode.fftSize=128;this.mediaStreamNode=this.audioContext.createMediaStreamSource(this.mediaStream);this.mediaStreamNode.connect(this.analyserNode);this.audioTimeDomainData=new Float32Array(this.analyserNode.fftSize);this.measureInterval=setInterval(this.analyzeAudioStream.bind(this),100)};BX.SimpleVAD.prototype.analyzeAudioStream=function(){this.analyserNode.getFloatTimeDomainData(this.audioTimeDomainData);var i=this.getAverageVolume(this.audioTimeDomainData);this.setVoiceState(i>=t)};BX.SimpleVAD.prototype.setVoiceState=function(t){if(this.voiceState==t){return}if(t){this.callbacks.voiceStarted();clearTimeout(this.inactivityTimeout);this.inactivityTimeout=0;this.voiceState=true}else{if(!this.inactivityTimeout){this.inactivityTimeout=setTimeout(this.onInactivityTimeout.bind(this),i)}}};BX.SimpleVAD.prototype.onInactivityTimeout=function(){this.inactivityTimeout=0;this.voiceState=false;this.callbacks.voiceStopped()};BX.SimpleVAD.prototype.getAverageVolume=function(t){var i=0;for(var e=0;e<t.length;e++){i+=t[e]*t[e]}return Math.sqrt(i/t.length)};BX.SimpleVAD.prototype.destroy=function(){if(this.analyserNode){this.analyserNode.disconnect()}if(this.mediaStreamNode){this.mediaStreamNode.disconnect()}if(this.audioContext){this.audioContext.close()}clearInterval(this.measureInterval);this.analyserNode=null;this.mediaStreamNode=null;this.mediaStream=null;this.audioContext=null;this.callbacks={voiceStarted:BX.DoNothing,voiceStopped:BX.DoNothing}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:52:"/bitrix/js/im/call/controller.min.js?159956829635715";s:6:"source";s:32:"/bitrix/js/im/call/controller.js";s:3:"min";s:36:"/bitrix/js/im/call/controller.min.js";s:3:"map";s:36:"/bitrix/js/im/call/controller.map.js";}"*/
(function(){BX.namespace("BX.Call");if(BX.Call.Controller){return}var e=5;BX.Call.Controller=function(e){this.messenger=e.messenger;this.container=null;this.folded=false;this.currentCall=null;this.childCall=null;this.callView=null;this.callNotification=null;this.invitePopup=null;this.videoStrategy=null;this.isHttps=window.location.protocol==="https:";this.callWithMobile=false;this.autoCloseCallView=true;this.talkingUsers={};this._onCallUserInvitedHandler=this._onCallUserInvited.bind(this);this._onCallDestroyHandler=this._onCallDestroy.bind(this);this._onCallUserStateChangedHandler=this._onCallUserStateChanged.bind(this);this._onCallUserMicrophoneStateHandler=this._onCallUserMicrophoneState.bind(this);this._onCallLocalMediaReceivedHandler=this._onCallLocalMediaReceived.bind(this);this._onCallLocalMediaStoppedHandler=this._onCallLocalMediaStopped.bind(this);this._onCallUserStreamReceivedHandler=this._onCallUserStreamReceived.bind(this);this._onCallUserStreamRemovedHandler=this._onCallUserStreamRemoved.bind(this);this._onCallUserVoiceStartedHandler=this._onCallUserVoiceStarted.bind(this);this._onCallUserVoiceStoppedHandler=this._onCallUserVoiceStopped.bind(this);this._onCallUserScreenStateHandler=this._onCallUserScreenState.bind(this);this._onCallFailureHandler=this._onCallFailure.bind(this);this._onCallLeaveHandler=this._onCallLeave.bind(this);this._onCallJoinHandler=this._onCallJoin.bind(this);this._onBeforeUnloadHandler=this._onBeforeUnload.bind(this);this._onImTabChangeHandler=this._onImTabChange.bind(this);this._onUpdateChatCounterHandler=this._onUpdateChatCounter.bind(this);this._onChildCallFirstStreamHandler=this._onChildCallFirstStream.bind(this);this._onWindowFocusHandler=this._onWindowFocus.bind(this);this._onWindowBlurHandler=this._onWindowBlur.bind(this);if(BX.desktop&&false){this.floatingWindow=new BX.Call.FloatingVideo({onMainAreaClick:this._onFloatingVideoMainAreaClick.bind(this),onButtonClick:this._onFloatingVideoButtonClick.bind(this)});this.floatingWindowUser=0}this.showFloatingWindowTimeout=0;this.hideIncomingCallTimeout=0;this.init()};BX.Call.Controller.prototype={init:function(){BX.addCustomEvent(window,"CallEvents::incomingCall",this.onIncomingCall.bind(this));BX.addCustomEvent(BX.Call.Hardware,"HardwareManager::deviceChange",this._onDeviceChange.bind(this));if(BX.desktop&&this.floatingWindow){window.addEventListener("blur",this._onWindowBlurHandler);window.addEventListener("focus",this._onWindowFocusHandler);BX.desktop.addCustomEvent("BXForegroundChanged",function(e){if(e){this._onWindowFocus()}else{this._onWindowBlur()}}.bind(this))}if(window["VoxImplant"]){VoxImplant.getInstance().addEventListener(VoxImplant.Events.MicAccessResult,this.voxMicAccessResult.bind(this))}window.addEventListener("beforeunload",this._onBeforeUnloadHandler);BX.addCustomEvent("OnDesktopTabChange",this._onImTabChangeHandler);BX.addCustomEvent(window,"onImUpdateCounterMessage",this._onUpdateChatCounter.bind(this));BX.garbage(this.destroy,this)},voxMicAccessResult:function(e){if(e.stream&&e.stream.getAudioTracks().length>0&&this.callView){this.callView.microphoneId=e.stream.getAudioTracks()[0].getSettings().deviceId}},getCallUsers:function(e){var t=Object.keys(this.currentCall.getUsers());if(e){t.push(this.currentCall.userId)}return t},getActiveCallUsers:function(){var e=[];var t=this.currentCall.getUsers();for(var i in t){if(t.hasOwnProperty(i)){if(t[i]===BX.Call.UserState.Connected||t[i]===BX.Call.UserState.Connecting||t[i]===BX.Call.UserState.Calling){e.push(i)}}}return e},updateFloatingWindowContent:function(){if(!this.floatingWindow||!this.currentCall){return}this.floatingWindow.setTitle(this.currentCall.associatedEntity.name);BX.Call.Util.getUserAvatars(this.currentCall.id,this.getActiveCallUsers()).then(function(e){this.floatingWindow.setAvatars(e)}.bind(this))},onIncomingCall:function(e){console.warn("incoming.call");var t=this;var i=e.call;this.callWithMobile=e.isMobile===true;var l=this.currentCall&&(this.callView||this.callNotification);if(!l){if(this.callView){return}this.checkDesktop().then(function(){return BX.Call.Hardware.init()}).then(function(){this.currentCall=i;this.bindCallEvents();this.updateFloatingWindowContent();if(this.currentCall.associatedEntity.type==="chat"&&this.currentCall.associatedEntity.advanced["chatType"]==="videoconf"){this.isConferencePageOpened(this.currentCall.associatedEntity.id).then(function(e){if(e){this.removeCallEvents();this.currentCall=null}else{this.showIncomingConference()}}.bind(this))}else{var t=e.video===true;if(t&&!BX.Call.Hardware.hasCamera()){this.showNotification(BX.message("IM_CALL_ERROR_NO_CAMERA"));t=false}this.showIncomingCall({video:t})}}.bind(this),function(e){if(t.currentCall){t.removeVideoStrategy();t.removeCallEvents();t.currentCall=null}console.error(e);t.log(e);if(!t.isHttps){t.showNotification(BX.message("IM_CALL_INCOMING_ERROR_HTTPS_REQUIRED"))}else{t.showNotification(BX.message("IM_CALL_INCOMING_UNSUPPORTED_BROWSER"))}})}else{if(i.id==this.currentCall.id){}else if(i.parentId==this.currentCall.id){if(!this.childCall){this.childCall=i;this.childCall.users.forEach(function(e){this.callView.addUser(e,BX.Call.UserState.Calling)},this);this.answerChildCall()}}else{i.decline(486);return false}}},bindCallEvents:function(){this.currentCall.addEventListener(BX.Call.Event.onUserInvited,this._onCallUserInvitedHandler);this.currentCall.addEventListener(BX.Call.Event.onDestroy,this._onCallDestroyHandler);this.currentCall.addEventListener(BX.Call.Event.onUserStateChanged,this._onCallUserStateChangedHandler);this.currentCall.addEventListener(BX.Call.Event.onUserMicrophoneState,this._onCallUserMicrophoneStateHandler);this.currentCall.addEventListener(BX.Call.Event.onUserScreenState,this._onCallUserScreenStateHandler);this.currentCall.addEventListener(BX.Call.Event.onLocalMediaReceived,this._onCallLocalMediaReceivedHandler);this.currentCall.addEventListener(BX.Call.Event.onLocalMediaStopped,this._onCallLocalMediaStoppedHandler);this.currentCall.addEventListener(BX.Call.Event.onStreamReceived,this._onCallUserStreamReceivedHandler);this.currentCall.addEventListener(BX.Call.Event.onStreamRemoved,this._onCallUserStreamRemovedHandler);this.currentCall.addEventListener(BX.Call.Event.onUserVoiceStarted,this._onCallUserVoiceStartedHandler);this.currentCall.addEventListener(BX.Call.Event.onUserVoiceStopped,this._onCallUserVoiceStoppedHandler);this.currentCall.addEventListener(BX.Call.Event.onCallFailure,this._onCallFailureHandler);this.currentCall.addEventListener(BX.Call.Event.onJoin,this._onCallJoinHandler);this.currentCall.addEventListener(BX.Call.Event.onLeave,this._onCallLeaveHandler)},removeCallEvents:function(){this.currentCall.removeEventListener(BX.Call.Event.onUserInvited,this._onCallUserInvitedHandler);this.currentCall.removeEventListener(BX.Call.Event.onDestroy,this._onCallDestroyHandler);this.currentCall.removeEventListener(BX.Call.Event.onUserStateChanged,this._onCallUserStateChangedHandler);this.currentCall.removeEventListener(BX.Call.Event.onUserMicrophoneState,this._onCallUserMicrophoneStateHandler);this.currentCall.removeEventListener(BX.Call.Event.onUserScreenState,this._onCallUserScreenStateHandler);this.currentCall.removeEventListener(BX.Call.Event.onLocalMediaReceived,this._onCallLocalMediaReceivedHandler);this.currentCall.removeEventListener(BX.Call.Event.onLocalMediaStopped,this._onCallLocalMediaStoppedHandler);this.currentCall.removeEventListener(BX.Call.Event.onStreamReceived,this._onCallUserStreamReceivedHandler);this.currentCall.removeEventListener(BX.Call.Event.onStreamRemoved,this._onCallUserStreamRemovedHandler);this.currentCall.removeEventListener(BX.Call.Event.onUserVoiceStarted,this._onCallUserVoiceStartedHandler);this.currentCall.removeEventListener(BX.Call.Event.onUserVoiceStopped,this._onCallUserVoiceStoppedHandler);this.currentCall.removeEventListener(BX.Call.Event.onCallFailure,this._onCallFailureHandler);this.currentCall.removeEventListener(BX.Call.Event.onJoin,this._onCallJoinHandler);this.currentCall.removeEventListener(BX.Call.Event.onLeave,this._onCallLeaveHandler)},bindCallViewEvents:function(){this.callView.setCallback("onClose",this._onCallViewClose.bind(this));this.callView.setCallback("onDestroy",this._onCallViewDestroy.bind(this));this.callView.setCallback("onButtonClick",this._onCallViewButtonClick.bind(this));this.callView.setCallback("onBodyClick",this._onCallViewBodyClick.bind(this));this.callView.setCallback("onReplaceCamera",this._onCallViewReplaceCamera.bind(this));this.callView.setCallback("onReplaceMicrophone",this._onCallViewReplaceMicrophone.bind(this));this.callView.setCallback("onReplaceSpeaker",this._onCallViewReplaceSpeaker.bind(this));this.callView.setCallback("onSetCentralUser",this._onCallViewSetCentralUser.bind(this))},createVideoStrategy:function(){if(this.videoStrategy){this.videoStrategy.destroy()}var e=window.BXIM.settings.callAcceptIncomingVideo||BX.Call.VideoStrategy.Type.AllowAll;this.videoStrategy=new BX.Call.VideoStrategy({call:this.currentCall,callView:this.callView,strategyType:e})},removeVideoStrategy:function(){if(this.videoStrategy){this.videoStrategy.destroy()}this.videoStrategy=null},setVideoStrategyType:function(e){if(this.videoStrategy){this.videoStrategy.setType(e)}},isMessengerOpen:function(){return!!this.messenger.popupMessenger},createContainer:function(){this.container=BX.create("div",{props:{className:"bx-messenger-call-overlay"}});if(BX.MessengerWindow){BX.MessengerWindow.content.insertBefore(this.container,BX.MessengerWindow.content.firstChild)}else{this.messenger.popupMessengerContent.insertBefore(this.container,this.messenger.popupMessengerContent.firstChild)}this.messenger.popupMessengerContent.classList.add("bx-messenger-call")},resize:function(){},answerChildCall:function(){this.removeCallEvents();this.removeVideoStrategy();this.childCall.addEventListener(BX.Call.Event.onStreamReceived,this._onChildCallFirstStreamHandler);this.childCall.addEventListener(BX.Call.Event.onLocalMediaReceived,this._onCallLocalMediaReceivedHandler);this.childCall.answer({useVideo:this.currentCall.isVideoEnabled()})},_onChildCallFirstStream:function(e){this.log("Finishing one-to-one call, switching to group call");this.callView.setStream(e.userId,e.stream);this.childCall.removeEventListener(BX.Call.Event.onStreamReceived,this._onChildCallFirstStreamHandler);this.removeCallEvents();var t=this.currentCall;t.hangup();this.currentCall=this.childCall;this.childCall=null;if(this.currentCall.associatedEntity&&this.currentCall.associatedEntity.id){this.messenger.openMessenger(this.currentCall.associatedEntity.id)}if(t.muted){this.currentCall.setMuted(true)}this.bindCallEvents();this.createVideoStrategy()},checkDesktop:function(){return new Promise(function(e){BX.desktopUtils.runningCheck(function(){},function(){e()})})},isConferencePageOpened:function(e){return new Promise(function(t,i){var l=BX.Messenger.Lib.LocalStorage.get(BX.CallEngine.getSiteId(),BX.CallEngine.getCurrentUserId(),BX.CallEngine.getConferencePageTag(e),"N");return t(l==="Y")}.bind(this))},showIncomingCall:function(e){if(!BX.type.isPlainObject(e)){e={}}e.video=e.video==true;var t=this.callWithMobile?e.video===true:true;this.callNotification=new BX.Call.Notification({callerName:this.currentCall.associatedEntity.name,callerAvatar:this.currentCall.associatedEntity.avatar,video:e.video,hasCamera:BX.Call.Hardware.hasCamera()&&t,onClose:this._onCallNotificationClose.bind(this),onDestroy:this._onCallNotificationDestroy.bind(this),onButtonClick:this._onCallNotificationButtonClick.bind(this)});this.callNotification.show();this.scheduleCancelNotification();window.BXIM.repeatSound("ringtone",3500,true)},showIncomingConference:function(){this.callNotification=new BX.Call.NotificationConference({callerName:this.currentCall.associatedEntity.name,callerAvatar:this.currentCall.associatedEntity.avatar,onClose:this._onCallNotificationClose.bind(this),onDestroy:this._onCallNotificationDestroy.bind(this),onButtonClick:this._onCallConferenceNotificationButtonClick.bind(this)});this.callNotification.show();this.scheduleCancelNotification();console.warn("play sound");window.BXIM.repeatSound("ringtone",3500,true)},scheduleCancelNotification:function(){clearTimeout(this.hideIncomingCallTimeout);this.hideIncomingCallTimeout=setTimeout(function(){if(this.callNotification){this.callNotification.close()}if(this.currentCall){this.removeVideoStrategy();this.removeCallEvents();this.currentCall=null}}.bind(this),30*1e3)},showNotification:function(e){BX.UI.Notification.Center.notify({content:BX.util.htmlspecialchars(e),position:"top-right",autoHideDelay:5e3,closeButton:true})},showUnsupportedNotification:function(){if(BX.desktop&&BX.desktop.apiReady){window.BXIM.openConfirm(BX.message("IM_CALL_DESKTOP_TOO_OLD"),[updateButton=new BX.PopupWindowButton({text:BX.message("IM_M_CALL_BTN_UPDATE"),className:"popup-window-button-accept",events:{click:function(){window.open(BX.browser.IsMac()?"http://dl.bitrix24.com/b24/bitrix24_desktop.dmg":"http://dl.bitrix24.com/b24/bitrix24_desktop.exe","desktopApp");this.popupWindow.close()}}}),new BX.PopupWindowButton({text:BX.message("IM_NOTIFY_CONFIRM_CLOSE"),className:"popup-window-button-decline",events:{click:function(){this.popupWindow.close()}}})])}else{window.BXIM.openConfirm(BX.message("IM_CALL_WEBRTC_USE_CHROME_OR_DESKTOP"),[new BX.PopupWindowButton({text:BX.message("IM_CALL_DETAILS"),className:"popup-window-button-accept",events:{click:function(){this.popupWindow.close();top.BX.Helper.show("redirect=detail&code=11387752")}}}),new BX.PopupWindowButton({text:BX.message("IM_NOTIFY_CONFIRM_CLOSE"),className:"popup-window-button-decline",events:{click:function(){this.popupWindow.close()}}})])}},isUserAgentSupported:function(){if(BX.desktop&&BX.desktop.apiReady){return BX.desktop.enableInVersion(48)}if("VoxImplant"in window){return VoxImplant.getInstance().isRTCsupported()}return BX.Call.Util.isWebRTCSupported()},startCall:function(e,t){if(!this.isUserAgentSupported()){this.showUnsupportedNotification();return}if(this.callView||this.currentCall){return}var i=BX.Call.Provider.Plain;if(BX.Call.Util.isCallServerAllowed()&&e.toString().substr(0,4)==="chat"){i=BX.Call.Provider.Voximplant}var l=+new Date;this._openMessenger(e).then(function(){return BX.Call.Hardware.init()}.bind(this)).then(function(){this.createContainer();this.callView=new BX.Call.View({container:this.container,showChatButtons:true,userLimit:BX.Call.Util.getUserLimit(),language:window.BXIM.language,layout:e.toString().startsWith("chat")?BX.Call.View.Layout.Grid:BX.Call.View.Layout.Centered,microphoneId:BX.Call.Hardware.defaultMicrophone});this.bindCallViewEvents();if(t&&!BX.Call.Hardware.hasCamera()){this.showNotification(BX.message("IM_CALL_ERROR_NO_CAMERA"));t=false}return BX.Call.Engine.getInstance().createCall({entityType:"chat",entityId:e,provider:i,videoEnabled:!!t,enableMicAutoParameters:BX.Call.Hardware.enableMicAutoParameters,joinExisting:e.toString().startsWith("chat")})}.bind(this)).then(function(e){var i=+new Date;this.currentCall=e.call;this.log("Call creation time: "+(i-l)/1e3+" seconds");this.currentCall.useHdVideo(BX.Call.Hardware.preferHdQuality);if(BX.Call.Hardware.defaultMicrophone){this.currentCall.setMicrophoneId(BX.Call.Hardware.defaultMicrophone)}if(BX.Call.Hardware.defaultCamera){this.currentCall.setCameraId(BX.Call.Hardware.defaultCamera)}if(this.currentCall.associatedEntity&&this.currentCall.associatedEntity.id){if(this.messenger.currentTab!=this.currentCall.associatedEntity.id){this.messenger.openMessenger(this.currentCall.associatedEntity.id)}}this.autoCloseCallView=true;this.bindCallEvents();this.createVideoStrategy();this.callView.appendUsers(this.currentCall.getUsers());BX.Call.Util.getUsers(this.currentCall.id,this.getCallUsers(true)).then(function(e){this.callView.updateUserData(e)}.bind(this));this.callView.show();if(e.isNew){this.log("Inviting users");this.currentCall.inviteUsers();window.BXIM.repeatSound("dialtone",5e3,true)}else{this.log("Joining existing call");this.currentCall.answer({useVideo:t})}}.bind(this)).catch(function(e){console.error(e);var t;if(typeof e=="string"){t=e}else if(typeof e=="object"&&e.code){t=e.code=="access_denied"?"ACCESS_DENIED":e.code}else{t="UNKNOWN_ERROR"}this._onCallFailure({code:t,message:e.message||""})}.bind(this))},joinCall:function(e,t){if(!this.isUserAgentSupported()){this.showUnsupportedNotification();return}if(this.callView||this.currentCall){return}var i;this.log("Joining call "+e);BX.CallEngine.getCallWithId(e).then(function(e){this.currentCall=e.call;i=this.currentCall.associatedEntity.id.toString().startsWith("chat");return this.messenger.openMessenger()}.bind(this)).then(function(){return BX.Call.Hardware.init()}.bind(this)).then(function(){this.createContainer();this.callView=new BX.Call.View({container:this.container,showChatButtons:true,userLimit:BX.Call.Util.getUserLimit(),language:window.BXIM.language,layout:i?BX.Call.View.Layout.Grid:BX.Call.View.Layout.Centered,microphoneId:BX.Call.Hardware.defaultMicrophone});this.autoCloseCallView=true;this.bindCallViewEvents();this.callView.appendUsers(this.currentCall.getUsers());BX.Call.Util.getUsers(this.currentCall.id,this.getCallUsers(true)).then(function(e){this.callView.updateUserData(e)}.bind(this));this.callView.show();this.currentCall.useHdVideo(BX.Call.Hardware.preferHdQuality);if(BX.Call.Hardware.defaultMicrophone){this.currentCall.setMicrophoneId(BX.Call.Hardware.defaultMicrophone)}if(BX.Call.Hardware.defaultCamera){this.currentCall.setCameraId(BX.Call.Hardware.defaultCamera)}this.bindCallEvents();this.createVideoStrategy();if(t&&!BX.Call.Hardware.hasCamera()){this.showNotification(BX.message("IM_CALL_ERROR_NO_CAMERA"));t=false}this.currentCall.answer({useVideo:!!t})}.bind(this))},leaveCurrentCall:function(){if(this.callView){this.callView.releaseLocalMedia()}if(this.currentCall){this.currentCall.hangup()}if(this.callView){this.callView.close()}},hasActiveCall:function(){return this.currentCall!=null&&this.currentCall.isAnyoneParticipating()||this.callView!=null},hasVisibleCall:function(){return!!(this.callView&&this.callView.visible&&this.callView.size==BX.Call.View.Size.Full)},useDevicesInCurrentCall:function(e){if(!this.currentCall||!this.currentCall.ready){return}for(var t=0;t<e.length;t++){var i=e[t];switch(i.kind){case"audioinput":this.currentCall.setMicrophoneId(i.deviceId);break;case"videoinput":this.currentCall.setCameraId(i.deviceId);break;case"audiooutput":if(this.callView){this.callView.setSpeakerId(i.deviceId)}break}}},removeDevicesFromCurrentCall:function(e){if(!this.currentCall||!this.currentCall.ready){return}for(var t=0;t<e.length;t++){var i=e[t];switch(i.kind){case"audioinput":if(this.currentCall.microphoneId==i.deviceId){this.currentCall.setMicrophoneId("")}break;case"videoinput":if(this.currentCall.cameraId==i.deviceId){this.currentCall.setCameraId("")}break;case"audiooutput":if(this.callView&&this.callView.speakerId==i.deviceId){this.callView.setSpeakerId("")}break}}},showChat:function(){if(BX.desktop&&this.floatingWindow){this.detached=true;this.callView.hide();this.floatingWindow.setTitle(this.currentCall.associatedEntity.name);BX.Call.Util.getUserAvatars(this.currentCall.id,this.getActiveCallUsers()).then(function(e){this.floatingWindow.setAvatars(e);this.floatingWindow.show()}.bind(this));this.container.style.width=0}else{this.fold()}},fold:function(){if(this.folded||BX.desktop&&this.floatingWindow){return}this.folded=true;this.container.classList.add("bx-messenger-call-overlay-folded");this.callView.setTitle(this.currentCall.associatedEntity.name);this.callView.setSize(BX.Call.View.Size.Folded);BX.onCustomEvent(this,"CallController::onFold",{})},unfold:function(){if(this.detached){this.container.style.removeProperty("width");this.callView.show();this.detached=false;if(this.floatingWindow){this.floatingWindow.hide()}}if(this.folded){this.folded=false;this.container.classList.remove("bx-messenger-call-overlay-folded");this.callView.setSize(BX.Call.View.Size.Full)}BX.onCustomEvent(this,"CallController::onUnfold",{})},_openMessenger:function(e){return new Promise(function(t,i){this.messenger.openMessenger(e).then(function(){t()}).catch(function(e){i(e)})}.bind(this))},_onCallNotificationClose:function(e){clearTimeout(this.hideIncomingCallTimeout);window.BXIM.stopRepeatSound("ringtone");if(this.callNotification){this.callNotification.destroy()}},_onCallNotificationDestroy:function(e){this.callNotification=null},_onCallNotificationButtonClick:function(e){clearTimeout(this.hideIncomingCallTimeout);this.callNotification.close();switch(e.button){case"answer":if(BX.desktop){BX.desktop.windowCommand("show")}if(!this.isUserAgentSupported()){this.log("Error: unsupported user agent");this.removeVideoStrategy();this.removeCallEvents();this.currentCall.decline();this.currentCall=null;this.showUnsupportedNotification();return}if(this.callView){this.callView.destroy()}var t=this.currentCall.associatedEntity&&this.currentCall.associatedEntity.id?this.currentCall.associatedEntity.id:false;var i=t.toString().startsWith("chat");this.messenger.openMessenger(t).then(function(){this.createContainer();this.callView=new BX.Call.View({container:this.container,users:this.currentCall.users,userStates:this.currentCall.getUsers(),showChatButtons:true,userLimit:BX.Call.Util.getUserLimit(),layout:i?BX.Call.View.Layout.Grid:BX.Call.View.Layout.Centered,microphoneId:BX.Call.Hardware.defaultMicrophone});this.autoCloseCallView=true;if(this.callWithMobile){this.callView.disableAddUser()}this.bindCallViewEvents();BX.Call.Util.getUsers(this.currentCall.id,this.getCallUsers(true)).then(function(e){this.callView.updateUserData(e)}.bind(this));this.callView.show();this.currentCall.useHdVideo(BX.Call.Hardware.preferHdQuality);if(BX.Call.Hardware.defaultMicrophone){this.currentCall.setMicrophoneId(BX.Call.Hardware.defaultMicrophone)}if(BX.Call.Hardware.defaultCamera){this.currentCall.setCameraId(BX.Call.Hardware.defaultCamera)}this.currentCall.answer({useVideo:e.video,enableMicAutoParameters:BX.Call.Hardware.enableMicAutoParameters});this.createVideoStrategy()}.bind(this));break;case"decline":if(this.currentCall){this.removeVideoStrategy();this.removeCallEvents();this.currentCall.decline();this.currentCall=null}break}},_onCallConferenceNotificationButtonClick:function(e){clearTimeout(this.hideIncomingCallTimeout);this.callNotification.close();switch(e.button){case"answerConference":if(this.currentCall){this.currentCall.sendAnswer();BXIM.messenger.openVideoconf(this.currentCall.associatedEntity.id)}break;case"skipConference":if(this.currentCall){this.removeVideoStrategy();this.removeCallEvents();this.currentCall.decline();this.currentCall=null}break}},_onCallViewClose:function(e){this.callView.destroy();if(this.floatingWindow){this.floatingWindow.close()}},_onCallViewDestroy:function(e){if(this.messenger.popupMessengerContent){BX.remove(this.container)}this.messenger.popupMessengerContent.classList.remove("bx-messenger-call");this.container=null;this.callView=null;this.folded=false;this.autoCloseCallView=true;if(this.currentCall){this.currentCall.hangup()}},_onCallViewBodyClick:function(e){if(this.folded){this.unfold()}},_onCallViewButtonClick:function(e){var t=e.buttonName;var i={hangup:this._onCallViewHangupButtonClick.bind(this),close:this._onCallViewCloseButtonClick.bind(this),inviteUser:this._onCallViewInviteUserButtonClick.bind(this),toggleMute:this._onCallViewToggleMuteButtonClick.bind(this),toggleScreenSharing:this._onCallViewToggleScreenSharingButtonClick.bind(this),toggleVideo:this._onCallViewToggleVideoButtonClick.bind(this),showChat:this._onCallViewShowChatButtonClick.bind(this),showHistory:this._onCallViewShowHistoryButtonClick.bind(this),fullscreen:this._onCallViewFullScreenButtonClick.bind(this)};if(BX.type.isFunction(i[t])){i[t].call(this,e)}},_onCallViewHangupButtonClick:function(e){this.leaveCurrentCall()},_onCallViewCloseButtonClick:function(e){if(this.callView){this.callView.close()}},_onCallViewShowChatButtonClick:function(e){this.messenger.openMessenger(this.currentCall.associatedEntity.id);this.showChat()},_getDisconnectedUsers:function(){var e=[];var t=this.currentCall.getUsers();for(var i in t){if(t[i]!==BX.Call.UserState.Connected&&BX.Call.Util.userData[i]){e.push(BX.Call.Util.userData[i])}}return e},_onCallViewInviteUserButtonClick:function(e){if(this.invitePopup){this.invitePopup.close();return}var t=this.currentCall.getUsers();var i=this._getDisconnectedUsers();this.invitePopup=new BX.Call.InvitePopup({bindElement:e.node,zIndex:BX.MessengerCommon.getDefaultZIndex()+200,idleUsers:i,allowNewUsers:Object.keys(t).length<BX.Call.Util.getUserLimit()-1,onDestroy:this._onInvitePopupDestroy.bind(this),onSelect:this._onInvitePopupSelect.bind(this)});this.invitePopup.show()},_onCallViewToggleMuteButtonClick:function(e){this.currentCall.setMuted(e.muted);this.callView.setMuted(e.muted);if(this.floatingWindow){this.floatingWindow.setAudioMuted(e.muted)}},_onCallViewToggleScreenSharingButtonClick:function(e){if(this.currentCall.isScreenSharingStarted()){this.currentCall.stopScreenSharing()}else{this.callView.releaseLocalMedia();this.currentCall.startScreenSharing()}},_onCallViewToggleVideoButtonClick:function(e){if(!e.video){this.callView.releaseLocalMedia()}this.currentCall.setVideoEnabled(e.video)},_onCallViewShowHistoryButtonClick:function(e){this.messenger.openHistory(this.currentCall.associatedEntity.id)},_onCallViewFullScreenButtonClick:function(e){if(this.folded){this.unfold()}this.callView.toggleFullScreen()},_onCallViewReplaceCamera:function(e){if(this.currentCall){this.currentCall.setCameraId(e.deviceId)}BX.Call.Hardware.defaultCamera=e.deviceId},_onCallViewReplaceMicrophone:function(e){if(this.currentCall){this.currentCall.setMicrophoneId(e.deviceId)}if(this.currentCall instanceof BX.Call.VoximplantCall){this.callView.microphoneId=e.deviceId}BX.Call.Hardware.defaultMicrophone=e.deviceId},_onCallViewReplaceSpeaker:function(e){BX.Call.Hardware.defaultSpeaker=e.deviceId},_onCallViewSetCentralUser:function(e){if(e.stream&&this.floatingWindow){this.floatingWindowUser=e.userId}},_onCallUserInvited:function(e){if(this.callView){BX.Call.Util.getUsers(this.currentCall.id,[e.userId]).then(function(e){this.callView.updateUserData(e)}.bind(this));this.callView.addUser(e.userId)}},_onCallDestroy:function(e){if(this.currentCall){this.removeVideoStrategy();this.removeCallEvents();this.currentCall=null}this.callWithMobile=false;if(this.callNotification){this.callNotification.close()}if(this.invitePopup){this.invitePopup.close()}if(this.callView&&this.autoCloseCallView){this.callView.close()}if(this.floatingWindow){this.floatingWindow.close()}window.BXIM.messenger.dialogStatusRedraw();window.BXIM.stopRepeatSound("dialtone");window.BXIM.stopRepeatSound("ringtone")},_onCallUserStateChanged:function(e){setTimeout(this.updateFloatingWindowContent.bind(this),100);if(this.callView){this.callView.setUserState(e.userId,e.state);if(e.isMobile){this.callView.disableAddUser();this.callView.disableSwitchCamera();this.callView.disableScreenSharing();this.callView.disableMediaSelection();this.callView.updateButtons()}}if(e.state==BX.Call.UserState.Connecting||e.state==BX.Call.UserState.Connected){window.BXIM.stopRepeatSound("dialtone")}if(e.state==BX.Call.UserState.Connected){}else if(e.state==BX.Call.UserState.Idle&&e.previousState==BX.Call.UserState.Connected){}else if(e.state==BX.Call.UserState.Failed){BX.Call.Util.getUser(this.currentCall.id,e.userId).then(function(e){this.showNotification(BX.Call.Util.getCustomMessage("IM_M_CALL_USER_FAILED",{gender:e.gender,name:e.name}))}.bind(this))}else if(e.state==BX.Call.UserState.Declined){BX.Call.Util.getUser(this.currentCall.id,e.userId).then(function(e){this.showNotification(BX.Call.Util.getCustomMessage("IM_M_CALL_USER_DECLINED",{gender:e.gender,name:e.name}))}.bind(this))}else if(e.state==BX.Call.UserState.Busy){BX.Call.Util.getUser(this.currentCall.id,e.userId).then(function(e){this.showNotification(BX.Call.Util.getCustomMessage("IM_M_CALL_USER_BUSY",{gender:e.gender,name:e.name}))}.bind(this))}},_onCallUserMicrophoneState:function(e){if(!this.callView){return}this.callView.setUserMicrophoneState(e.userId,e.microphoneState)},_onCallLocalMediaReceived:function(e){this.log("Received local media stream "+e.tag);if(this.callView){this.callView.setLocalStream(e.stream,e.tag=="main");this.callView.setButtonActive("screen",e.tag=="screen");if(e.tag=="screen"){this.callView.disableSwitchCamera();this.callView.updateButtons()}else{if(!this.currentCall.callFromMobile){this.callView.enableSwitchCamera();this.callView.updateButtons()}}}if(this.currentCall&&this.currentCall.videoEnabled&&e.stream.getVideoTracks().length===0){this.showNotification(BX.message("IM_CALL_CAMERA_ERROR_FALLBACK_TO_MIC"))}},_onCallLocalMediaStopped:function(e){},_onCallUserStreamReceived:function(e){if(this.callView){this.callView.setStream(e.userId,e.stream)}if(this.floatingWindow&&this.floatingWindowUser==e.userId){}},_onCallUserStreamRemoved:function(e){},_onCallUserVoiceStarted:function(e){this.talkingUsers[e.userId]=true;if(this.callView){this.callView.setUserTalking(e.userId,true)}if(this.floatingWindow){this.floatingWindow.setTalking(Object.keys(this.talkingUsers).map(function(e){return Number(e)}))}},_onCallUserVoiceStopped:function(e){if(this.talkingUsers[e.userId]){delete this.talkingUsers[e.userId]}if(this.callView){this.callView.setUserTalking(e.userId,false)}if(this.floatingWindow){this.floatingWindow.setTalking(Object.keys(this.talkingUsers).map(function(e){return Number(e)}))}},_onCallUserScreenState:function(e){if(this.callView){this.callView.setUserScreenState(e.userId,e.screenState)}},_onCallFailure:function(e){var t=e.code||e.name||e.error;console.error("Call failure: ",e);var i;if(e.name=="AuthResult"||t=="AUTHORIZE_ERROR"){i=BX.message("IM_CALL_ERROR_AUTHORIZATION")}else if(e.name=="Failed"&&t==403){i=BX.message("IM_CALL_ERROR_HARDWARE_ACCESS_DENIED")}else if(t=="ERROR_UNEXPECTED_ANSWER"){i=BX.message("IM_CALL_ERROR_UNEXPECTED_ANSWER")}else if(t=="BLANK_ANSWER_WITH_ERROR_CODE"){i=BX.message("IM_CALL_ERROR_BLANK_ANSWER")}else if(t=="BLANK_ANSWER"){i=BX.message("IM_CALL_ERROR_BLANK_ANSWER")}else if(t=="ACCESS_DENIED"){i=BX.message("IM_CALL_ERROR_ACCESS_DENIED")}else if(t=="NO_WEBRTC"){i=this.isHttps?BX.message("IM_CALL_NO_WEBRT"):BX.message("IM_CALL_ERROR_HTTPS_REQUIRED")}else if(t=="UNKNOWN_ERROR"){i=BX.message("IM_CALL_ERROR_UNKNOWN")}else{i=BX.message("IM_CALL_ERROR_UNKNOWN_WITH_CODE").replace("#ERROR_CODE#",t)}if(this.callView){this.callView.showFatalError({text:i})}else{this.showNotification(i)}this.autoCloseCallView=false;if(this.currentCall){this.removeVideoStrategy();this.removeCallEvents();this.currentCall=null}},_onCallJoin:function(e){if(e.local){return}if(this.currentCall){this.removeVideoStrategy();this.removeCallEvents();this.currentCall=null}if(this.callView){this.callView.close()}if(this.callNotification){this.callNotification.close()}if(this.invitePopup){this.invitePopup.close()}if(this.floatingWindow){this.floatingWindow.close()}window.BXIM.stopRepeatSound("dialtone")},_onCallLeave:function(e){if(!e.local&&this.currentCall&&this.currentCall.ready){this.log(new Error("received remote leave with active call!"));return}if(this.currentCall){this.removeVideoStrategy();this.removeCallEvents();this.currentCall=null}if(this.callView){this.callView.close()}if(this.invitePopup){this.invitePopup.close()}if(this.floatingWindow){this.floatingWindow.close()}if(this.callNotification){this.callNotification.close()}window.BXIM.messenger.dialogStatusRedraw();window.BXIM.stopRepeatSound("dialtone");window.BXIM.stopRepeatSound("ringtone")},_onInvitePopupDestroy:function(e){this.invitePopup=null},_onInvitePopupSelect:function(e){this.invitePopup.close();if(!this.currentCall){return}var t=e.user.id;if(BX.Call.Util.isCallServerAllowed()&&this.currentCall instanceof BX.Call.PlainCall){this.removeVideoStrategy();this.removeCallEvents();BX.Call.Engine.getInstance().createChildCall(this.currentCall.id,BX.Call.Provider.Voximplant,[t]).then(function(e){this.childCall=e.call;this.childCall.addEventListener(BX.Call.Event.onStreamReceived,this._onChildCallFirstStreamHandler);this.childCall.addEventListener(BX.Call.Event.onLocalMediaReceived,this._onCallLocalMediaReceivedHandler);this.childCall.inviteUsers({users:this.childCall.users})}.bind(this));this.callView.addUser(t,BX.Call.UserState.Calling)}else{var i=this.currentCall.getUsers();if(Object.keys(i).length<BX.Call.Util.getUserLimit()-1||i.hasOwnProperty(t)){this.currentCall.inviteUsers({users:[t]})}}},_onWindowFocus:function(){if(!this.detached){clearTimeout(this.showFloatingWindowTimeout);if(this.floatingWindow){this.floatingWindow.hide()}}},_onWindowBlur:function(e){clearTimeout(this.showFloatingWindowTimeout);if(this.currentCall&&this.floatingWindow&&this.callView){this.showFloatingWindowTimeout=setTimeout(function(){if(this.currentCall&&this.floatingWindow&&this.callView){this.floatingWindow.setTitle(this.currentCall.associatedEntity.name);BX.Call.Util.getUserAvatars(this.currentCall.id,this.getActiveCallUsers()).then(function(e){this.floatingWindow.setAvatars(e);this.floatingWindow.show()}.bind(this))}}.bind(this),300)}},_onBeforeUnload:function(e){if(this.floatingWindow){this.floatingWindow.close()}if(this.callNotification){this.callNotification.close()}if(this.hasActiveCall()){e.preventDefault();e.returnValue=""}},_onImTabChange:function(e){if(e==="notify"&&this.currentCall&&this.callView){this.fold()}},_onUpdateChatCounter:function(){if(!this.currentCall||!this.currentCall.associatedEntity||!this.currentCall.associatedEntity.id||!this.callView){return}var e=BX.MessengerCommon.getDialogCounter(this.currentCall.associatedEntity.id);this.callView.setButtonCounter("chat",e)},_onDeviceChange:function(e){if(!this.currentCall||!this.currentCall.ready){return}var t=e.data.added;var i=e.data.removed;if(t.length>0){this.log("New devices: ",t);BX.UI.Notification.Center.notify({content:BX.message("IM_CALL_DEVICES_FOUND")+"<br><ul>"+t.map(function(e){return"<li>"+e.label})+"</ul>",position:"top-right",autoHideDelay:1e4,closeButton:true,actions:[{title:BX.message("IM_CALL_DEVICES_CLOSE"),events:{click:function(e,t,i){t.close()}.bind(this)}}]});this.useDevicesInCurrentCall(t)}if(i.length>0){this.log("Removed devices: ",i);this.removeDevicesFromCurrentCall(i);BX.UI.Notification.Center.notify({content:BX.message("IM_CALL_DEVICES_DETACHED")+"<br><ul>"+i.map(function(e){return"<li>"+e.label})+"</ul>",position:"top-right",autoHideDelay:1e4,closeButton:true,actions:[{title:BX.message("IM_CALL_DEVICES_CLOSE"),events:{click:function(e,t,i){t.close()}}}]})}},_onFloatingVideoMainAreaClick:function(e){BX.desktop.windowCommand("show");BX.desktop.changeTab("im");if(!this.currentCall){return}if(this.currentCall.associatedEntity&&this.currentCall.associatedEntity.id){this.messenger.openMessenger(this.currentCall.associatedEntity.id)}else if(!this.isMessengerOpen()){this.messenger.openMessenger()}if(this.detached){this.container.style.removeProperty("width");this.callView.show();this.detached=false}},_onFloatingVideoButtonClick:function(e){switch(e.buttonName){case"toggleMute":this._onCallViewToggleMuteButtonClick(e);break;case"hangup":this._onCallViewHangupButtonClick();break}},destroy:function(){if(this.floatingWindow){this.floatingWindow.destroy();this.floatingWindow=null}},log:function(){if(this.currentCall){var e=[this.currentCall.id];BX.CallEngine.log.apply(BX.CallEngine,e.concat(Array.prototype.slice.call(arguments)))}else{BX.CallEngine.log.apply(BX.CallEngine,arguments)}}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:48:"/bitrix/js/im/call/engine.min.js?159956829611520";s:6:"source";s:28:"/bitrix/js/im/call/engine.js";s:3:"min";s:32:"/bitrix/js/im/call/engine.min.js";s:3:"map";s:32:"/bitrix/js/im/call/engine.map.js";}"*/
(function(){BX.namespace("BX.Call");BX.Call.State={Incoming:"Incoming"};BX.Call.UserState={Idle:"Idle",Busy:"Busy",Calling:"Calling",Unavailable:"Unavailable",Declined:"Declined",Ready:"Ready",Connecting:"Connecting",Connected:"Connected",Failed:"Failed"};BX.Call.Type={Instant:1,Permanent:2};BX.Call.Provider={Plain:"Plain",Voximplant:"Voximplant",Janus:"Janus"};BX.Call.StreamTag={Main:"main",Screen:"screen"};BX.Call.Direction={Incoming:"Incoming",Outgoing:"Outgoing"};BX.Call.Quality={VeryHigh:"very_high",High:"high",Medium:"medium",Low:"low",VeryLow:"very_low"};BX.Call.UserMnemonic={all:"all",none:"none"};BX.Call.Event={onUserInvited:"onUserInvited",onUserStateChanged:"onUserStateChanged",onUserMicrophoneState:"onUserMicrophoneState",onUserScreenState:"onUserScreenState",onUserVoiceStarted:"onUserVoiceStarted",onUserVoiceStopped:"onUserVoiceStopped",onLocalMediaReceived:"onLocalMediaReceived",onLocalMediaStopped:"onLocalMediaStopped",onDeviceListUpdated:"onDeviceListUpdated",onRTCStatsReceived:"onRTCStatsReceived",onCallFailure:"onCallFailure",onStreamReceived:"onStreamReceived",onStreamRemoved:"onStreamRemoved",onJoin:"onJoin",onLeave:"onLeave",onDestroy:"onDestroy"};var e={createCall:"im.call.create",createChildCall:"im.call.createChildCall",getPublicChannels:"pull.channel.public.list",getCall:"im.call.get"};var l=false;BX.Call.Engine=function(){this.debugFlag=false;if(!l){throw new Error("Do not use this constructor directly, use BX.Call.Engine.getInstance instead")}this.calls={};this.userId=Number(BX.message("USER_ID"));this.siteId="";this.unknownCalls={};this.restClient=null;this.pullClient=null;this.init()};BX.Call.Engine.getInstance=function(){return BX.CallEngine};BX.Call.Engine.prototype.init=function(){BX.addCustomEvent("onPullEvent-im",this.__onPullEvent.bind(this));BX.addCustomEvent("onPullClientEvent-im",this.__onPullClientEvent.bind(this))};BX.Call.Engine.prototype.getSiteId=function(){return this.siteId||BX.message("SITE_ID")||""};BX.Call.Engine.prototype.setSiteId=function(e){this.siteId=e};BX.Call.Engine.prototype.getCurrentUserId=function(){return this.userId};BX.Call.Engine.prototype.setCurrentUserId=function(e){this.userId=Number(e)};BX.Call.Engine.prototype.setRestClient=function(e){this.restClient=e};BX.Call.Engine.prototype.setPullClient=function(e){this.pullClient=e};BX.Call.Engine.prototype.getRestClient=function(){return this.restClient||BX.rest};BX.Call.Engine.prototype.getPullClient=function(){return this.pullClient||BX.PULL};BX.Call.Engine.prototype.getLogService=function(){return BX.message("call_log_service")};BX.Call.Engine.prototype.createCall=function(l){var n=this;return new Promise(function(i,a){var o=l.type||BX.Call.Type.Instant;var r=l.provider||n.getDefaultProvider();if(l.joinExisting){for(var s in n.calls){if(n.calls.hasOwnProperty(s)){var c=n.calls[s];if(c.provider==l.provider&&c.associatedEntity.type==l.entityType&&c.associatedEntity.id==l.entityId){n.log(s,"Found existing call, attaching to it");return i({call:c,isNew:false})}}}}var u={type:o,provider:r,entityType:l.entityType,entityId:l.entityId,joinExisting:!!l.joinExisting,userIds:BX.type.isArray(l.userIds)?l.userIds:[]};n.getRestClient().callMethod(e.createCall,u).then(function(e){if(e.error()){var o=e.error().getError();return a({code:o.error,message:o.error_description})}var r=e.data();if(r.userData){BX.Call.Util.setUserData(r.userData)}if(r.publicChannels){BX.CallEngine.getPullClient().setPublicIds(Object.values(r.publicChannels))}var s=r.call;if(n.calls[s["ID"]]){if(n.calls[s["ID"]]instanceof t){n.calls[s["ID"]].destroy()}else{console.error("Call "+s["ID"]+" already exists");return i({call:n.calls[s["ID"]],isNew:false})}}var c=n.__getCallFabric(s["PROVIDER"]);var u=c.createCall({id:parseInt(s["ID"],10),instanceId:n.getUuidv4(),direction:BX.Call.Direction.Outgoing,users:r.users,videoEnabled:l.videoEnabled==true,enableMicAutoParameters:l.enableMicAutoParameters!==false,associatedEntity:s.ASSOCIATED_ENTITY,events:{onDestroy:n.__onCallDestroy.bind(n)},debug:l.debug===true,logToken:r.logToken});n.calls[s["ID"]]=u;if(r.isNew){n.log(u.id,"Creating new call")}else{n.log(u.id,"Server returned existing call, attaching to it")}BX.onCustomEvent(window,"CallEvents::callCreated",[{call:u}]);i({call:u,isNew:r.isNew})}).catch(function(e){if(BX.type.isFunction(e.error)){e=e.error().getError()}a({code:e.error,message:e.error_description})})})};BX.Call.Engine.prototype.createChildCall=function(l,t,n){var i=this;return new Promise(function(a,o){if(!i.calls[l]){return o("Parent call is not found")}var r=i.calls[l];var s={parentId:l,newProvider:t,newUsers:n};i.getRestClient().callMethod(e.createChildCall,s,function(e){var l=e.data();var t=l.call;var n=i.__getCallFabric(t["PROVIDER"]);var o=n.createCall({id:parseInt(t["ID"],10),instanceId:i.getUuidv4(),parentId:t["PARENT_ID"],direction:BX.Call.Direction.Outgoing,users:l.users,videoEnabled:r.isVideoEnabled(),enableMicAutoParameters:r.enableMicAutoParameters!==false,associatedEntity:t.ASSOCIATED_ENTITY,events:{onDestroy:i.__onCallDestroy.bind(i)},logToken:l.logToken});i.calls[t["ID"]]=o;BX.onCustomEvent(window,"CallEvents::callCreated",[{call:o}]);a({call:o,isNew:l.isNew})})})};BX.Call.Engine.prototype._instantiateCall=function(e,l,t){if(this.calls[e["ID"]]){console.error("Call "+e["ID"]+" already exists");return this.calls[e["ID"]]}var n=this.__getCallFabric(e["PROVIDER"]);var i=n.createCall({id:parseInt(e["ID"],10),instanceId:this.getUuidv4(),initiatorId:parseInt(e["INITIATOR_ID"],10),parentId:e["PARENT_ID"],direction:e["INITIATOR_ID"]==this.userId?BX.Call.Direction.Outgoing:BX.Call.Direction.Incoming,users:l,associatedEntity:e.ASSOCIATED_ENTITY,logToken:t,events:{onDestroy:this.__onCallDestroy.bind(this)}});this.calls[e["ID"]]=i;BX.onCustomEvent(window,"CallEvents::callCreated",[{call:i}]);return i};BX.Call.Engine.prototype.getCallWithId=function(l){var t=this;return new Promise(function(n,i){if(t.calls[l]){return n({call:t.calls[l],isNew:false})}t.getRestClient().callMethod(e.getCall,{callId:l}).then(function(e){var l=e.data();n({call:t._instantiateCall(l.call,l.users,l.logToken),isNew:false})}).catch(function(e){if(BX.type.isFunction(e.error)){e=e.error().getError()}i({code:e.error,message:e.error_description})})})};BX.Call.Engine.prototype.getUuidv4=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var l=Math.random()*16|0,t=e=="x"?l:l&3|8;return t.toString(16)})};BX.Call.Engine.prototype.__onPullEvent=function(e,l,t){var n={"Call::incoming":this.__onPullIncomingCall.bind(this)};if(e.substr(0,6)==="Call::"&&l.publicIds){BX.CallEngine.getPullClient().setPublicIds(Object.values(l.publicIds))}if(n[e]){n[e].call(this,l,t)}else if(e.substr(0,6)==="Call::"&&(l["call"]||l["callId"])){var i=l["call"]?l["call"]["ID"]:l["callId"];if(this.calls[i]){this.calls[i].__onPullEvent(e,l,t)}else if(e==="Call::ping"){this.__onUnknownCallPing(l,t).then(function(n){if(n&&this.calls[i]){this.calls[i].__onPullEvent(e,l,t)}}.bind(this))}}};BX.Call.Engine.prototype.__onPullClientEvent=function(e,l,t){if(e.substr(0,6)==="Call::"&&l["callId"]){var n=l["callId"];if(this.calls[n]){this.calls[n].__onPullEvent(e,l,t)}else if(e==="Call::ping"){this.__onUnknownCallPing(l,t).then(function(i){if(i&&this.calls[n]){this.calls[n].__onPullEvent(e,l,t)}}.bind(this))}}};BX.Call.Engine.prototype.__onPullIncomingCall=function(e,l){if(l.server_time_ago>30){console.error("Call was started too long time ago");return}var t=e.call;var n=parseInt(t.ID,10);var i;if(e.publicIds){BX.CallEngine.getPullClient().setPublicIds(Object.values(e.publicIds))}if(e.userData){BX.Call.Util.setUserData(e.userData)}if(this.calls[n]){i=this.calls[n]}else{var a=this.__getCallFabric(t.PROVIDER);i=a.createCall({id:n,instanceId:this.getUuidv4(),parentId:t.PARENT_ID||null,callFromMobile:e.isMobile===true,direction:BX.Call.Direction.Incoming,users:e.users,initiatorId:e.senderId,associatedEntity:t.ASSOCIATED_ENTITY,logToken:e.logToken,events:{onDestroy:this.__onCallDestroy.bind(this)}});this.calls[n]=i;BX.onCustomEvent(window,"CallEvents::callCreated",[{call:i}])}i.addInvitedUsers(e.invitedUsers);if(i){BX.onCustomEvent(window,"CallEvents::incomingCall",[{call:i,video:e.video===true,isMobile:e.isMobile===true}])}this.log(i.id,"Incoming call "+i.id)};BX.Call.Engine.prototype.__onUnknownCallPing=function(e,l){return new Promise(function(t,n){var i=Number(e.callId);if(l.server_time_ago>10){this.log(i,"Error: Ping was sent too long time ago");return t(false)}if(!this.__isCallAppInitialized()){return t(false)}if(this.unknownCalls[i]){return t(false)}this.unknownCalls[i]=true;if(e.userData){BX.Call.Util.setUserData(e.userData)}this.getCallWithId(i).then(function(e){this.unknownCalls[i]=false;t(true)}.bind(this)).catch(function(e){this.unknownCalls[i]=false;this.log(i,"Error: Could not instantiate call",e);t(false)}.bind(this))}.bind(this))};BX.Call.Engine.prototype.__onCallDestroy=function(e){var l=e.call.id;this.calls[l]=new t({callId:l,onDelete:function(){if(this.calls[l]){delete this.calls[l]}}.bind(this)});BX.onCustomEvent(window,"CallEvents::callDestroyed",[{callId:e.call.id}])};BX.Call.Engine.prototype.__isCallAppInitialized=function(){if("BXIM"in window){return BXIM.init}else if(BX.Messenger&&BX.Messenger.Application&&BX.Messenger.Application.call){return BX.Messenger.Application.call.inited}return false};BX.Call.Engine.prototype.getDefaultProvider=function(){return BX.Call.Provider.Plain};BX.Call.Engine.prototype.getConferencePageTag=function(e){return"conference-open-"+e};BX.Call.Engine.prototype.__getCallFabric=function(e){if(e==BX.Call.Provider.Plain){return BX.Call.PlainCallFabric}else if(e==BX.Call.Provider.Voximplant){return BX.Call.VoximplantCallFabric}else if(e==BX.Call.Provider.Janus){return BX.Call.JanusCallFabric}throw new Error("Unknown call provider type "+e)};BX.Call.Engine.prototype.debug=function(e){this.debugFlag=typeof e==="undefined"?true:!!e;return this.debugFlag};BX.Call.Engine.prototype.log=function(){var e=BX.Call.Util.getLogMessage.call(BX.Call.Util,arguments);if(BX.desktop&&BX.desktop.ready()){BX.desktop.log(BX.message("USER_ID")+".video.log",e.substr(3))}if(this.debugFlag){if(console){var l=["Call log ["+BX.Call.Util.getTimeForLog()+"]: "];console.log.apply(this,l.concat(Array.prototype.slice.call(arguments)))}}};BX.Call.Engine.prototype.getAllowedVideoQuality=function(e){if(e<4){return BX.Call.Quality.VeryHigh}else if(e<7){return BX.Call.Quality.High}else if(e<11){return BX.Call.Quality.Medium}else if(e<24){return BX.Call.Quality.Low}else{return BX.Call.Quality.VeryLow}};BX.Call.PlainCallFabric={createCall:function(e){return new BX.Call.PlainCall(e)}};BX.Call.VoximplantCallFabric={createCall:function(e){return new BX.Call.VoximplantCall(e)}};BX.Call.JanusCallFabric={createCall:function(e){return new BX.Call.JanusCall(e)}};var t=function(e){this.callId=e.callId;this.lifetime=e.lifetime||120;this.callbacks={onDelete:BX.type.isFunction(e.onDelete)?e.onDelete:BX.DoNothing};this.deleteTimeout=setTimeout(function(){this.callbacks.onDelete({callId:this.callId})}.bind(this),this.lifetime*1e3)};t.prototype.__onPullEvent=function(e,l,t){};t.prototype.isAnyoneParticipating=function(){return false};t.prototype.addEventListener=function(){return false};t.prototype.removeEventListener=function(){return false};t.prototype.destroy=function(){clearTimeout(this.deleteTimeout);this.callbacks.onDelete=BX.DoNothing};l=true;BX.CallEngine=new BX.Call.Engine;l=false})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:49:"/bitrix/js/im/call/hardware.min.js?15995682964177";s:6:"source";s:30:"/bitrix/js/im/call/hardware.js";s:3:"min";s:34:"/bitrix/js/im/call/hardware.min.js";s:3:"map";s:34:"/bitrix/js/im/call/hardware.map.js";}"*/
(function(){var e={defaultMicrophone:"bx-im-settings-default-microphone",defaultCamera:"bx-im-settings-default-camera",defaultSpeaker:"bx-im-settings-default-speaker",enableMicAutoParameters:"bx-im-settings-enable-mic-auto-parameters",preferHd:"bx-im-settings-camera-prefer-hd"};var t=function(){this.initialized=false;this._currentDeviceList=[];this.updating=false;Object.defineProperty(this,"cameraList",{get:this._getDeviceMap.bind(this,"videoinput")});Object.defineProperty(this,"microphoneList",{get:function(){return this._getDeviceMap("audioinput")}});Object.defineProperty(this,"audioOutputList",{get:function(){return this._getDeviceMap("audiooutput")}});Object.defineProperty(this,"defaultMicrophone",{get:function(){var t=localStorage?localStorage.getItem(e.defaultMicrophone):"";return this.microphoneList[t]?t:""},set:function(t){if(localStorage){localStorage.setItem(e.defaultMicrophone,t)}}});Object.defineProperty(this,"defaultCamera",{get:function(){var t=localStorage?localStorage.getItem(e.defaultCamera):"";return this.cameraList[t]?t:""},set:function(t){if(localStorage){localStorage.setItem(e.defaultCamera,t)}}});Object.defineProperty(this,"defaultSpeaker",{get:function(){var t=localStorage?localStorage.getItem(e.defaultSpeaker):"";return this.audioOutputList[t]?t:""},set:function(t){if(localStorage){localStorage.setItem(e.defaultSpeaker,t)}}});Object.defineProperty(this,"enableMicAutoParameters",{get:function(){return localStorage?localStorage.getItem(e.enableMicAutoParameters)!=="N":true},set:function(t){if(localStorage){localStorage.setItem(e.enableMicAutoParameters,t?"Y":"N")}}});Object.defineProperty(this,"preferHdQuality",{get:function(){return localStorage?localStorage.getItem(e.preferHd)!=="N":true},set:function(t){if(localStorage){localStorage.setItem(e.preferHd,t?"Y":"N")}}})};t.prototype={init:function(){return new Promise(function(e,t){if(this.initialized){return e()}this.enumerateDevices().then(function(t){this._currentDeviceList=t;navigator.mediaDevices.addEventListener("devicechange",BX.debounce(this.onNavigatorDeviceChanged.bind(this),500));this.initialized=true;e()}.bind(this)).catch(t)}.bind(this))},enumerateDevices:function(){return new Promise(function(e,t){if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices){return t("NO_WEBRTC")}navigator.mediaDevices.enumerateDevices().then(function(t){e(t)}.bind(this))}.bind(this))},hasCamera:function(){if(!this.initialized){throw new Error("HardwareManager is not initialized yet")}return Object.keys(this.cameraList).length>0},getMicrophoneList:function(){if(!this.initialized){throw new Error("HardwareManager is not initialized yet")}return Object.values(this._currentDeviceList).filter(function(e){return e.kind=="audioinput"})},getCameraList:function(){if(!this.initialized){throw new Error("HardwareManager is not initialized yet")}return Object.values(this._currentDeviceList).filter(function(e){return e.kind=="videoinput"})},getSpeakerList:function(){if(!this.initialized){throw new Error("HardwareManager is not initialized yet")}return Object.values(this._currentDeviceList).filter(function(e){return e.kind=="audiooutput"})},canSelectSpeaker:function(){return Object.keys(this.audioOutputList).length>0&&"setSinkId"in HTMLMediaElement.prototype},updateDeviceList:function(e){if(this.updating){return}this.updating=true;var t=this._currentDeviceList;var i=[];navigator.mediaDevices.enumerateDevices().then(function(e){e.forEach(function(e){var r=t.findIndex(function(t){return t.kind==e.kind&&t.deviceId==e.deviceId});if(r!=-1){t.splice(r,1)}else{i.push(e)}},this);BX.onCustomEvent(this,"HardwareManager::deviceChange",{added:i,removed:t});this._currentDeviceList=e;this.updating=false}.bind(this))},onNavigatorDeviceChanged:function(e){if(!this.initialized){return}this.updateDeviceList()},_getDeviceMap:function(e){var t={};if(!this.initialized){throw new Error("HardwareManager is not initialized yet")}for(var i=0;i<this._currentDeviceList.length;i++){if(this._currentDeviceList[i].kind==e){t[this._currentDeviceList[i].deviceId]=this._currentDeviceList[i].label}}return t}};BX.Call.Hardware=new t})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:56:"/bitrix/js/im/call/hardware_dialog.min.js?15995682281614";s:6:"source";s:37:"/bitrix/js/im/call/hardware_dialog.js";s:3:"min";s:41:"/bitrix/js/im/call/hardware_dialog.min.js";s:3:"map";s:41:"/bitrix/js/im/call/hardware_dialog.map.js";}"*/
(function(){BX.namespace("BX.Call");if(BX.Call.HardwareDialog)return;BX.Call.HardwareDialog=function(e){this.bindNode=e.bindNode;this.offsetTop=e.offsetTop;this.offsetLeft=e.offsetLeft;this.popup=null;this.callbacks={onDestroy:BX.type.isFunction(e.onDestroy)?e.onDestroy:BX.DoNothing}};BX.Call.HardwareDialog.prototype.createPopup=function(){this.popup=new BX.PopupWindow("bx-messenger-call-access",this.bindNode,{lightShadow:true,zIndex:200,offsetTop:this.offsetTop,offsetLeft:this.offsetLeft,events:{onPopupClose:function(){this.destroy()},onPopupDestroy:function(){this.popup=null;this.callbacks.onDestroy()}.bind(this)},content:this.createLayout()})};BX.Call.HardwareDialog.prototype.createLayout=function(){return BX.create("div",{props:{className:"bx-messenger-call-dialog-allow"},children:[BX.create("div",{props:{className:"bx-messenger-call-dialog-allow-image-block"},children:[BX.create("div",{props:{className:"bx-messenger-call-dialog-allow-center"},children:[BX.create("div",{props:{className:"bx-messenger-call-dialog-allow-arrow"}})]}),BX.create("div",{props:{className:"bx-messenger-call-dialog-allow-center"},children:[BX.create("div",{props:{className:"bx-messenger-call-dialog-allow-button"},html:BX.message("IM_M_CALL_ALLOW_BTN")})]})]}),BX.create("div",{props:{className:"bx-messenger-call-dialog-allow-text"},html:BX.message("IM_M_CALL_ALLOW_TEXT")})]})};BX.Call.HardwareDialog.prototype.show=function(){if(!this.popup){this.createPopup()}this.popup.show()};BX.Call.HardwareDialog.prototype.close=function(){if(this.popup){this.popup.close()}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:54:"/bitrix/js/im/call/abstract_call.min.js?15995682963690";s:6:"source";s:35:"/bitrix/js/im/call/abstract_call.js";s:3:"min";s:39:"/bitrix/js/im/call/abstract_call.min.js";s:3:"map";s:39:"/bitrix/js/im/call/abstract_call.map.js";}"*/
(function(){BX.namespace("BX.Call");BX.Call.AbstractCall=function(t){var e=this;this.id=t.id;this.instanceId=t.instanceId;this.parentId=t.parentId||null;this.direction=t.direction;this.ready=false;this.userId=BX.Call.Engine.getInstance().getCurrentUserId();this.initiatorId=t.initiatorId||"";this.users=BX.type.isArray(t.users)?t.users.filter(function(t){return t!=e.userId}):[];this.associatedEntity=BX.type.isPlainObject(t.associatedEntity)?t.associatedEntity:{};this.videoEnabled=t.videoEnabled===true;this.videoHd=t.videoHd===true;this.cameraId=t.cameraId||"";this.microphoneId=t.microphoneId||"";this.muted=t.muted===true;this.logToken=t.logToken||"";if(BX.CallEngine.getLogService()&&this.logToken){this.logger=new BX.Call.Logger(BX.CallEngine.getLogService(),this.logToken)}this.localStreams={main:null,screen:null};this.eventListeners={};if(BX.type.isPlainObject(t.events)){this.initEventListeners(t.events)}Object.defineProperty(this,"provider",{get:function(){if(this instanceof BX.Call.PlainCall){return BX.Call.Provider.Plain}else if(this instanceof BX.Call.VoximplantCall){return BX.Call.VoximplantCall}else{return""}}})};BX.Call.AbstractCall.prototype.initEventListeners=function(t){for(var e in t){this.addEventListener(e,t[e])}};BX.Call.AbstractCall.prototype.addEventListener=function(t,e){if(!BX.type.isArray(this.eventListeners[t])){this.eventListeners[t]=[]}if(BX.type.isFunction(e)){this.eventListeners[t].push(e)}};BX.Call.AbstractCall.prototype.removeEventListener=function(t,e){if(BX.type.isArray(this.eventListeners[t])&&this.eventListeners[t].indexOf(e)>=0){var i=this.eventListeners[t].indexOf(e);if(i>=0){this.eventListeners[t].splice(i,1)}}};BX.Call.AbstractCall.prototype.runCallback=function(t,e){if(BX.type.isArray(this.eventListeners[t])&&this.eventListeners[t].length>0){if(!BX.type.isPlainObject(e)){e={}}e.call=this;for(var i=0;i<this.eventListeners[t].length;i++){try{this.eventListeners[t][i].call(this,e)}catch(e){console.error(t+" callback error: ",e);this.log(t+" callback error: ",e)}}}};BX.Call.AbstractCall.prototype.getLocalStream=function(t){return this.localStreams[t]};BX.Call.AbstractCall.prototype.setLocalStream=function(t,e){e=e||"main";this.localStreams[e]=t};BX.Call.AbstractCall.prototype.isVideoEnabled=function(){return this.videoEnabled};BX.Call.AbstractCall.prototype.isAnyoneParticipating=function(){throw new Error("isAnyoneParticipating should be implemented")};BX.Call.AbstractCall.prototype.__onPullEvent=function(t,e){throw new Error("__onPullEvent should be implemented")};BX.Call.AbstractCall.prototype.inviteUsers=function(){throw new Error("inviteUsers is not implemented")};BX.Call.AbstractCall.prototype.cancel=function(){throw new Error("cancel is not implemented")};BX.Call.AbstractCall.prototype.answer=function(){throw new Error("answer is not implemented")};BX.Call.AbstractCall.prototype.decline=function(t,e){throw new Error("decline is not implemented")};BX.Call.AbstractCall.prototype.hangup=function(){throw new Error("hangup is not implemented")};BX.Call.AbstractCall.prototype.log=function(){var t=BX.Call.Util.getLogMessage.apply(BX.Call.Util,arguments);if(BX.desktop&&BX.desktop.ready()){BX.desktop.log(BX.message("USER_ID")+".video.log",t.substr(3))}if(BX.CallEngine.debugFlag&&console){var e=["Call log ["+BX.Call.Util.getTimeForLog()+"]: "];console.log.apply(this,e.concat(Array.prototype.slice.call(arguments)))}if(this.logger){this.logger.log(t)}if(BX.MessengerDebug){BX.MessengerDebug.addLog(this.id,t)}};BX.Call.AbstractCall.prototype.destroy=function(){if(this.logger){this.logger.destroy();this.logger=null}this.runCallback(BX.Call.Event.onDestroy)}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:52:"/bitrix/js/im/call/plain_call.min.js?159956829641352";s:6:"source";s:32:"/bitrix/js/im/call/plain_call.js";s:3:"min";s:36:"/bitrix/js/im/call/plain_call.min.js";s:3:"map";s:36:"/bitrix/js/im/call/plain_call.map.js";}"*/
(function(){BX.namespace("BX.Call");var e={invite:"im.call.invite",cancel:"im.call.cancel",answer:"im.call.answer",decline:"im.call.decline",hangup:"im.call.hangup",ping:"im.call.ping",negotiationNeeded:"im.call.negotiationNeeded",connectionOffer:"im.call.connectionOffer",connectionAnswer:"im.call.connectionAnswer",iceCandidate:"im.call.iceCandidate"};var t={ping:"Call::ping",negotiationNeeded:"Call::negotiationNeeded",connectionOffer:"Call::connectionOffer",connectionAnswer:"Call::connectionAnswer",iceCandidate:"Call::iceCandidate",voiceStarted:"Call::voiceStarted",voiceStopped:"Call::voiceStopped",microphoneState:"Call::microphoneState",hangup:"Call::hangup",userInviteTimeout:"Call::userInviteTimeout"};var n={offerToReceiveVideo:true,offerToReceiveAudio:true};var i=3e4;var a=1e4;var l=5e3;var o=25e3;var s=5500;BX.Call.PlainCall=function(e){this.superclass.constructor.apply(this,arguments);this.callFromMobile=e.callFromMobile;this.state=e.state||"";this.peers=this.initPeers(this.users);this.signaling=new BX.Call.PlainCall.Signaling({call:this});this.deviceList=[];this.turnServer=(BX.browser.IsFirefox()?BX.message("turn_server_firefox"):BX.message("turn_server"))||"turn.calls.bitrix24.com";this.turnServerLogin=BX.message("turn_server_login")||"bitrix";this.turnServerPassword=BX.message("turn_server_password")||"bitrix";this.pingUsersInterval=setInterval(this.pingUsers.bind(this),l);this.pingBackendInterval=setInterval(this.pingBackend.bind(this),o);this.reinviteTimeout=null;this._onUnloadHandler=this._onUnload.bind(this);this.enableMicAutoParameters=e.enableMicAutoParameters!==false;window.addEventListener("unload",this._onUnloadHandler)};BX.extend(BX.Call.PlainCall,BX.Call.AbstractCall);BX.Call.PlainCall.prototype.initPeers=function(e){var t={};for(var n=0;n<e.length;n++){var i=Number(e[n]);if(i==this.userId)continue;t[i]=this.createPeer(i)}return t};BX.Call.PlainCall.prototype.createPeer=function(e){var t=this;return new BX.Call.PlainCall.Peer({call:this,userId:e,ready:e==this.initiatorId,signalingConnected:e==this.initiatorId,isMobile:e==this.initiatorId&&this.callFromMobile,onStreamReceived:function(e){t.runCallback(BX.Call.Event.onStreamReceived,e)},onStreamRemoved:function(e){t.runCallback(BX.Call.Event.onStreamRemoved,e)},onStateChanged:this.__onPeerStateChanged.bind(this),onInviteTimeout:this.__onPeerInviteTimeout.bind(this),onRTCStatsReceived:this.__onPeerRTCStatsReceived.bind(this)})};BX.Call.PlainCall.prototype.getUsers=function(){var e={};for(var t in this.peers){e[t]=this.peers[t].calculatedState}return e};BX.Call.PlainCall.prototype.isReady=function(){return this.ready};BX.Call.PlainCall.prototype.setVideoEnabled=function(e){e=e===true;if(this.videoEnabled==e){return}this.videoEnabled=e;if(this.ready){this.replaceLocalMediaStream()}};BX.Call.PlainCall.prototype.setMuted=function(e){e=!!e;if(this.muted==e){return}this.muted=e;if(this.localStreams["main"]){var t=this.localStreams["main"].getAudioTracks();if(t[0]){t[0].enabled=!this.muted}}this.signaling.sendMicrophoneState(this.users,!this.muted)};BX.Call.PlainCall.prototype.setCameraId=function(e){if(this.cameraId==e){return}this.cameraId=e;if(this.ready&&this.videoEnabled){BX.debounce(this.replaceLocalMediaStream,100,this)()}};BX.Call.PlainCall.prototype.setMicrophoneId=function(e){if(this.microphoneId==e){return}this.microphoneId=e;if(this.ready){BX.debounce(this.replaceLocalMediaStream,100,this)()}};BX.Call.PlainCall.prototype.getCurrentMicrophoneId=function(){if(!this.localStreams["main"]){return this.microphoneId}var e=this.localStreams["main"].getAudioTracks();if(e.length>0){var t=e[0].getSettings();return t.deviceId}else{return this.microphoneId}};BX.Call.PlainCall.prototype.useHdVideo=function(e){this.videoHd=e===true};BX.Call.PlainCall.prototype.setVideoQuality=function(e){};BX.Call.PlainCall.prototype.stopSendingStream=function(e){};BX.Call.PlainCall.prototype.allowVideoFrom=function(e){};BX.Call.PlainCall.prototype.inviteUsers=function(e){var t=this;if(!BX.type.isPlainObject(e)){e={}}var n=BX.type.isArray(e.users)?e.users:Object.keys(this.peers);this.ready=true;if(e.localStream instanceof MediaStream&&!this.localStreams["main"]){this.localStreams["main"]=e.localStream}this.getLocalMediaStream("main",true).then(function(){return t.signaling.inviteUsers({userIds:n,video:t.videoEnabled?"Y":"N"})}).then(function(e){t.runCallback(BX.Call.Event.onJoin,{local:true});for(var i=0;i<n.length;i++){var a=Number(n[i]);if(!t.peers[a]){t.peers[a]=t.createPeer(a);t.runCallback(BX.Call.Event.onUserInvited,{userId:a})}t.peers[a].onInvited();t.scheduleRepeatInvite()}}).catch(function(e){console.error(e);t.runCallback(BX.Call.Event.onCallFailure,e)})};BX.Call.PlainCall.prototype.scheduleRepeatInvite=function(){return;clearTimeout(this.reinviteTimeout);this.reinviteTimeout=setTimeout(this.repeatInviteUsers.bind(this),s)};BX.Call.PlainCall.prototype.repeatInviteUsers=function(){clearTimeout(this.reinviteTimeout);if(!this.ready){return}var e=[];for(var t in this.peers){if(this.peers.hasOwnProperty(t)&&this.peers[t].calculatedState===BX.Call.UserState.Calling){e.push(t)}}if(e.length===0){return}this.signaling.inviteUsers({userIds:e,video:this.videoEnabled?"Y":"N"}).then(function(){this.scheduleRepeatInvite()}.bind(this))};BX.Call.PlainCall.prototype.getMediaConstraints=function(e){var t={};var n=e.videoEnabled?{}:false;hdVideo=!!e.hdVideo;var i=navigator.mediaDevices.getSupportedConstraints?navigator.mediaDevices.getSupportedConstraints():{};if(this.microphoneId){t.deviceId={ideal:this.microphoneId}}if(!this.enableMicAutoParameters){if(i.echoCancellation){t.echoCancellation=false}if(i.noiseSuppression){t.noiseSuppression=false}if(i.autoGainControl){t.autoGainControl=false}}if(n){if(this.cameraId){n.deviceId={exact:this.cameraId}}if(hdVideo){n.width={max:1920,min:1280};n.height={max:1080,min:720}}else{n.width={ideal:640};n.height={ideal:360}}}return{audio:t,video:n}};BX.Call.PlainCall.prototype.getUserMedia=function(e){return new Promise(function(t,n){var i=e[0];navigator.mediaDevices.getUserMedia(i).then(function(e){t(e)},function(a){this.log("getUserMedia error: ",a);this.log("Current constraints",i);if(e.length>1){this.getUserMedia(e.slice(1)).then(function(e){t(e)},function(e){n(e)})}else{this.log("Last fallback constraints used, failing");n(a)}}.bind(this))}.bind(this))};BX.Call.PlainCall.prototype.getLocalMediaStream=function(e,t){var n=this;if(!BX.type.isNotEmptyString(e)){e="main"}this.log("Requesting access to media devices");return new Promise(function(i,a){if(n.localStreams[e]){return i(n.localStreams[e])}var l=[];if(n.videoEnabled){if(n.videoHd){l.push(n.getMediaConstraints({videoEnabled:true,hdVideo:true}))}l.push(n.getMediaConstraints({videoEnabled:true,hdVideo:false}));if(t){l.push(n.getMediaConstraints({videoEnabled:false}))}}else{l.push(n.getMediaConstraints({videoEnabled:false}))}n.getUserMedia(l).then(function(t){n.log("Local media stream received");n.localStreams[e]=t;n.runCallback(BX.Call.Event.onLocalMediaReceived,{tag:e,stream:t});if(e==="main"){if(n.muted){var a=t.getAudioTracks();if(a[0]){a[0].enabled=false}}}if(n.deviceList.length===0){navigator.mediaDevices.enumerateDevices().then(function(e){n.deviceList=e;n.runCallback(BX.Call.Event.onDeviceListUpdated,{deviceList:n.deviceList})})}i(n.localStreams[e])}).catch(function(t){n.log("Could not get local media stream.",t);n.log("Request constraints: .",l);n.runCallback("onLocalMediaError",{tag:e,error:t});a(t)})})};BX.Call.PlainCall.prototype.startMediaCapture=function(){return this.getLocalMediaStream()};BX.Call.PlainCall.prototype.attachVoiceDetection=function(){if(this.voiceDetection){this.voiceDetection.destroy()}try{this.voiceDetection=new BX.SimpleVAD({mediaStream:this.localStreams["main"],onVoiceStarted:this.onLocalVoiceStarted.bind(this),onVoiceStopped:this.onLocalVoiceStopped.bind(this)})}catch(e){this.log("Could not attach voice detection to media stream")}};BX.Call.PlainCall.prototype.getDisplayMedia=function(){return new Promise(function(e,t){if(window["BXDesktopSystem"]){navigator.mediaDevices.getUserMedia({video:{mandatory:{chromeMediaSource:"screen",maxWidth:1920,maxHeight:1080,maxFrameRate:5}}}).then(function(t){e(t)},function(e){t(e)})}else if(navigator.mediaDevices.getDisplayMedia){navigator.mediaDevices.getDisplayMedia({video:{width:{max:1920},height:{max:1080},frameRate:{max:5}}}).then(function(t){e(t)},function(e){t(e)})}else{console.error("Screen sharing is not supported");t("Screen sharing is not supported")}})};BX.Call.PlainCall.prototype.startScreenSharing=function(){var e=this;if(this.localStreams["screen"]){return}this.getDisplayMedia().then(function(t){e.localStreams["screen"]=t;t.getVideoTracks().forEach(function(t){t.addEventListener("ended",function(){e.stopScreenSharing()})});e.runCallback(BX.Call.Event.onLocalMediaReceived,{tag:"screen",stream:t});if(e.ready){for(var n in e.peers){if(e.peers[n].calculatedState===BX.Call.UserState.Connected){e.peers[n].sendMedia()}}}}).catch(function(e){this.log(e)}.bind(this))};BX.Call.PlainCall.prototype.stopScreenSharing=function(){if(!this.localStreams["screen"]){return}this.localStreams["screen"].getTracks().forEach(function(e){e.stop()});this.localStreams["screen"]=null;this.runCallback(BX.Call.Event.onLocalMediaReceived,{tag:"main",stream:this.localStreams["main"]});for(var e in this.peers){if(this.peers[e].calculatedState===BX.Call.UserState.Connected){this.peers[e].sendMedia()}}};BX.Call.PlainCall.prototype.isScreenSharingStarted=function(){return this.localStreams["screen"]instanceof MediaStream};BX.Call.PlainCall.prototype.onLocalVoiceStarted=function(){this.signaling.sendVoiceStarted({userId:this.users})};BX.Call.PlainCall.prototype.onLocalVoiceStopped=function(){this.signaling.sendVoiceStopped({userId:this.users})};BX.Call.PlainCall.prototype.answer=function(e){var t=this;if(!BX.type.isPlainObject(e)){e={}}if(this.direction!==BX.Call.Direction.Incoming){throw new Error("Only incoming call could be answered")}this.ready=true;this.videoEnabled=e.useVideo==true;this.enableMicAutoParameters=e.enableMicAutoParameters!==false;if(e.localStream instanceof MediaStream){this.localStreams["main"]=e.localStream}return new Promise(function(e,n){t.getLocalMediaStream("main",true).then(function(){t.runCallback(BX.Call.Event.onJoin,{local:true});return t.sendAnswer()},function(e){t.runCallback(BX.Call.Event.onCallFailure,e)}).then(function(){e()})})};BX.Call.PlainCall.prototype.sendAnswer=function(){this.signaling.sendAnswer()};BX.Call.PlainCall.prototype.decline=function(t,n){this.ready=false;var i={callId:this.id,callInstanceId:this.instanceId};if(typeof t!="undefined"){i.code=t}if(typeof n!="undefined"){i.reason=n}BX.CallEngine.getRestClient().callMethod(e.decline,i).then(function(){this.destroy()}.bind(this))};BX.Call.PlainCall.prototype.hangup=function(){if(!this.ready){var e=new Error("Hangup in wrong state");this.log(e);return}var t=new Error;t.name="Call stack:";this.log("Hangup received \n"+t.stack);this.ready=false;return new Promise(function(e,t){for(var n in this.peers){this.peers[n].disconnect()}this.runCallback(BX.Call.Event.onLeave,{local:true});this.signaling.sendHangup({userId:this.users})}.bind(this))};BX.Call.PlainCall.prototype.pingUsers=function(){if(this.ready){this.signaling.sendPingToUsers({userId:this.users})}};BX.Call.PlainCall.prototype.pingBackend=function(){if(this.ready){this.signaling.sendPingToBackend()}};BX.Call.PlainCall.prototype.getState=function(){};BX.Call.PlainCall.prototype.replaceLocalMediaStream=function(e){var t=this;e=e||"main";if(this.localStreams[e]){BX.webrtc.stopMediaStream(this.localStreams[e]);this.localStreams[e]=null}this.getLocalMediaStream(e).then(function(){if(t.ready){for(var n in t.peers){if(t.peers[n].isReady()){t.peers[n].replaceMediaStream(e)}}}}).catch(function(e){console.error("Could not get access to hardware; don't really know what to do. error:",e)}.bind(this))};BX.Call.PlainCall.prototype.sendAllStreams=function(e){if(!this.peers[e])return;if(!this.peers[e].isReady())return;for(var t in this.localStreams){if(this.localStreams[t]){this.peers[e].sendMedia()}}};BX.Call.PlainCall.prototype.isAnyoneParticipating=function(){for(var e in this.peers){if(this.peers[e].isParticipating()){return true}}return false};BX.Call.PlainCall.prototype.getParticipatingUsers=function(){var e=[];for(var t in this.peers){if(this.peers[t].isParticipating()){e.push(t)}}return e};BX.Call.PlainCall.prototype.addJoinedUsers=function(e){for(var t=0;t<e.length;t++){var n=Number(e[t]);if(n==this.userId||this.peers[n]){continue}this.peers[n]=this.createPeer(n);if(!this.users.includes(n)){this.users.push(n)}}};BX.Call.PlainCall.prototype.addInvitedUsers=function(e){for(var t=0;t<e.length;t++){var n=Number(e[t]);if(n==this.userId){continue}if(this.peers[n]){if(this.peers[n].calculatedState===BX.Call.UserState.Failed||this.peers[n].calculatedState===BX.Call.UserState.Idle){this.peers[n].onInvited()}}else{this.peers[n]=this.createPeer(n);this.runCallback(BX.Call.Event.onUserInvited,{userId:n});this.peers[n].onInvited()}if(!this.users.includes(n)){this.users.push(n)}}};BX.Call.PlainCall.prototype.__onPullEvent=function(e,t,n){var i={"Call::answer":this.__onPullEventAnswer.bind(this),"Call::hangup":this.__onPullEventHangup.bind(this),"Call::ping":this.__onPullEventPing.bind(this),"Call::negotiationNeeded":this.__onPullEventNegotiationNeeded.bind(this),"Call::connectionOffer":this.__onPullEventConnectionOffer.bind(this),"Call::connectionAnswer":this.__onPullEventConnectionAnswer.bind(this),"Call::iceCandidate":this.__onPullEventIceCandidate.bind(this),"Call::voiceStarted":this.__onPullEventVoiceStarted.bind(this),"Call::voiceStopped":this.__onPullEventVoiceStopped.bind(this),"Call::microphoneState":this.__onPullEventMicrophoneState.bind(this),"Call::usersJoined":this.__onPullEventUsersJoined.bind(this),"Call::usersInvited":this.__onPullEventUsersInvited.bind(this),"Call::userInviteTimeout":this.__onPullEventUserInviteTimeout.bind(this),"Call::associatedEntityReplaced":this.__onPullEventAssociatedEntityReplaced.bind(this),"Call::finish":this.__onPullEventFinish.bind(this)};if(i[e]){this.log("Signaling: "+e+"; Parameters: "+JSON.stringify(t));i[e].call(this,t)}};BX.Call.PlainCall.prototype.__onPullEventUsersJoined=function(e){if(!this.ready){return}var t=e.users;this.addJoinedUsers(t)};BX.Call.PlainCall.prototype.__onPullEventUsersInvited=function(e){if(!this.ready){return}var t=e.users;this.addInvitedUsers(t)};BX.Call.PlainCall.prototype.__onPullEventUserInviteTimeout=function(e){this.log("__onPullEventUserInviteTimeout",e);var t=e.failedUserId;if(this.peers[t]){this.peers[t].onInviteTimeout(false)}};BX.Call.PlainCall.prototype.__onPullEventAnswer=function(e){var t=Number(e.senderId);if(t==this.userId){return this.__onPullEventAnswerSelf(e)}if(!this.ready){return}if(!this.peers[t]){return}this.peers[t].setSignalingConnected(true);this.peers[t].setReady(true);this.peers[t].isMobile=e.isMobile===true;if(this.ready){this.sendAllStreams(t)}};BX.Call.PlainCall.prototype.__onPullEventAnswerSelf=function(e){if(e.callInstanceId===this.instanceId)return;this.log("Call was answered elsewhere");this.runCallback(BX.Call.Event.onJoin,{local:false})};BX.Call.PlainCall.prototype.__onPullEventHangup=function(e){var t=e.senderId;if(this.userId==t){if(this.instanceId!=e.callInstanceId){this.runCallback(BX.Call.Event.onLeave,{local:false})}return}if(!this.peers[t])return;this.peers[t].disconnect(e.code);this.peers[t].setReady(false);if(e.code==603){this.peers[t].setDeclined(true)}if(!this.isAnyoneParticipating()){this.destroy()}};BX.Call.PlainCall.prototype.__onPullEventPing=function(e){var t=this.peers[e.senderId];if(!t)return;t.setSignalingConnected(true)};BX.Call.PlainCall.prototype.__onPullEventNegotiationNeeded=function(e){if(!this.ready){return}var t=this.peers[e.senderId];if(!t){return}t.setReady(true);if(e.restart){t.reconnect()}else{t.onNegotiationNeeded()}};BX.Call.PlainCall.prototype.__onPullEventConnectionOffer=function(e){if(!this.ready){return}var t=this.peers[e.senderId];if(!t){return}t.setReady(true);t.setUserAgent(e.userAgent);t.setConnectionOffer(e.connectionId,e.sdp)};BX.Call.PlainCall.prototype.__onPullEventConnectionAnswer=function(e){if(!this.ready){return}var t=this.peers[e.senderId];if(!t)return;var n=e.connectionId;t.setUserAgent(e.userAgent);t.setConnectionAnswer(n,e.sdp)};BX.Call.PlainCall.prototype.__onPullEventIceCandidate=function(e){if(!this.ready){return}var t=this.peers[e.senderId];var n;if(!t)return;try{n=e.candidates;for(var i=0;i<n.length;i++){t.addIceCandidate(e.connectionId,n[i])}}catch(e){this.log("Error parsing serialized candidate: ",e)}};BX.Call.PlainCall.prototype.__onPullEventVoiceStarted=function(e){this.runCallback(BX.Call.Event.onUserVoiceStarted,{userId:e.senderId})};BX.Call.PlainCall.prototype.__onPullEventVoiceStopped=function(e){this.runCallback(BX.Call.Event.onUserVoiceStopped,{userId:e.senderId})};BX.Call.PlainCall.prototype.__onPullEventMicrophoneState=function(e){this.runCallback(BX.Call.Event.onUserMicrophoneState,{userId:e.senderId,microphoneState:e.microphoneState})};BX.Call.PlainCall.prototype.__onPullEventAssociatedEntityReplaced=function(e){if(e.call&&e.call.ASSOCIATED_ENTITY){this.associatedEntity=e.call.ASSOCIATED_ENTITY}};BX.Call.PlainCall.prototype.__onPullEventFinish=function(e){this.destroy()};BX.Call.PlainCall.prototype.__onPeerStateChanged=function(e){this.runCallback(BX.Call.Event.onUserStateChanged,e);if(e.state==BX.Call.UserState.Failed||e.state==BX.Call.UserState.Unavailable){if(!this.isAnyoneParticipating()){this.hangup().then(this.destroy.bind(this)).catch(function(e){this.destroy()}.bind(this))}}else if(e.state==BX.Call.UserState.Connected){this.signaling.sendMicrophoneState(e.userId,!this.muted)}};BX.Call.PlainCall.prototype.__onPeerInviteTimeout=function(e){if(!this.ready){return}this.signaling.sendUserInviteTimeout({userId:this.users,failedUserId:e.userId})};BX.Call.PlainCall.prototype.__onPeerRTCStatsReceived=function(e){this.runCallback(BX.Call.Event.onRTCStatsReceived,e)};BX.Call.PlainCall.prototype._onUnload=function(t){if(!this.ready){return}BX.CallEngine.getRestClient().callMethod(e.hangup,{callId:this.id,callInstanceId:this.instanceId});for(var n in this.peers){this.peers[n].disconnect()}};BX.Call.PlainCall.prototype.destroy=function(){for(var e in this.peers){if(this.peers[e]){this.peers[e].destroy()}}for(var t in this.localStreams){if(this.localStreams[t]){BX.webrtc.stopMediaStream(this.localStreams[t]);this.localStreams[t]=null}}window.removeEventListener("unload",this._onUnloadHandler);clearInterval(this.pingUsersInterval);clearInterval(this.pingBackendInterval);clearTimeout(this.reinviteTimeout);this.superclass.destroy.apply(this,arguments)};BX.Call.PlainCall.Signaling=function(e){this.call=e.call};BX.Call.PlainCall.Signaling.prototype.isIceTricklingAllowed=function(){return BX.CallEngine.getPullClient().isPublishingSupported()};BX.Call.PlainCall.Signaling.prototype.inviteUsers=function(t){return this.__runRestAction(e.invite,t)};BX.Call.PlainCall.Signaling.prototype.sendAnswer=function(t){return this.__runRestAction(e.answer,t)};BX.Call.PlainCall.Signaling.prototype.sendConnectionOffer=function(n){if(BX.CallEngine.getPullClient().isPublishingSupported()){return this.__sendPullEvent(t.connectionOffer,n)}else{return this.__runRestAction(e.connectionOffer,n)}};BX.Call.PlainCall.Signaling.prototype.sendConnectionAnswer=function(n){if(BX.CallEngine.getPullClient().isPublishingSupported()){return this.__sendPullEvent(t.connectionAnswer,n)}else{return this.__runRestAction(e.connectionAnswer,n)}};BX.Call.PlainCall.Signaling.prototype.sendIceCandidate=function(n){if(BX.CallEngine.getPullClient().isPublishingSupported()){return this.__sendPullEvent(t.iceCandidate,n)}else{return this.__runRestAction(e.iceCandidate,n)}};BX.Call.PlainCall.Signaling.prototype.sendNegotiationNeeded=function(n){if(BX.CallEngine.getPullClient().isPublishingSupported()){return this.__sendPullEvent(t.negotiationNeeded,n)}else{return this.__runRestAction(e.negotiationNeeded,n)}};BX.Call.PlainCall.Signaling.prototype.sendVoiceStarted=function(e){if(BX.CallEngine.getPullClient().isPublishingSupported()){return this.__sendPullEvent(t.voiceStarted,e)}};BX.Call.PlainCall.Signaling.prototype.sendVoiceStopped=function(e){if(BX.CallEngine.getPullClient().isPublishingSupported()){return this.__sendPullEvent(t.voiceStopped,e)}};BX.Call.PlainCall.Signaling.prototype.sendMicrophoneState=function(e,n){if(BX.CallEngine.getPullClient().isPublishingSupported()){return this.__sendPullEvent(t.microphoneState,{userId:e,microphoneState:n},0)}};BX.Call.PlainCall.Signaling.prototype.sendPingToUsers=function(e){if(BX.CallEngine.getPullClient().isPublishingEnabled()){this.__sendPullEvent(t.ping,e,0)}};BX.Call.PlainCall.Signaling.prototype.sendPingToBackend=function(){var t=!BX.CallEngine.getPullClient().isPublishingEnabled();this.__runRestAction(e.ping,{retransmit:t})};BX.Call.PlainCall.Signaling.prototype.sendUserInviteTimeout=function(e){if(BX.CallEngine.getPullClient().isPublishingEnabled()){this.__sendPullEvent(t.userInviteTimeout,e,0)}};BX.Call.PlainCall.Signaling.prototype.sendHangup=function(n){if(BX.CallEngine.getPullClient().isPublishingSupported()){this.__sendPullEvent(t.hangup,n);n.retransmit=false;return this.__runRestAction(e.hangup,n)}else{n.retransmit=true;return this.__runRestAction(e.hangup,n)}};BX.Call.PlainCall.Signaling.prototype.__sendPullEvent=function(e,t,n){n=n||5;if(!t.userId){throw new Error("userId is not found in data")}if(!BX.type.isArray(t.userId)){t.userId=[t.userId]}t.callInstanceId=this.call.instanceId;t.senderId=this.call.userId;t.callId=this.call.id;t.requestId=BX.Call.Engine.getInstance().getUuidv4();this.call.log("Sending p2p signaling event "+e+"; "+JSON.stringify(t));BX.CallEngine.getPullClient().sendMessage(t.userId,"im",e,t,n)};BX.Call.PlainCall.Signaling.prototype.__runRestAction=function(e,t){if(!BX.type.isPlainObject(t)){t={}}t.callId=this.call.id;t.callInstanceId=this.call.instanceId;t.requestId=BX.Call.Engine.getInstance().getUuidv4();this.call.log("Sending ajax-based signaling event "+e+"; "+JSON.stringify(t));return BX.CallEngine.getRestClient().callMethod(e,t).catch(function(e){console.error(e)})};BX.Call.PlainCall.Peer=function(e){this.call=e.call;this.userId=e.userId;this.ready=e.ready===true;this.calling=false;this.inviteTimeout=false;this.declined=false;this.busy=false;this.signalingConnected=e.signalingConnected===true;this.failureReason="";this.userAgent="";this.isFirefox=false;this.isChrome=false;this.isMobile=e.isMobile===true;this.calculatedState=this.calculateState();this.localStreams={main:null,screen:null};this.senderMediaStream=null;this.peerConnection=null;this.pendingIceCandidates={};this.localIceCandidates=[];this.callbacks={onStateChanged:BX.type.isFunction(e.onStateChanged)?e.onStateChanged:BX.DoNothing,onInviteTimeout:BX.type.isFunction(e.onInviteTimeout)?e.onInviteTimeout:BX.DoNothing,onStreamReceived:BX.type.isFunction(e.onStreamReceived)?e.onStreamReceived:BX.DoNothing,onStreamRemoved:BX.type.isFunction(e.onStreamRemoved)?e.onStreamRemoved:BX.DoNothing,onRTCStatsReceived:BX.type.isFunction(e.onRTCStatsReceived)?e.onRTCStatsReceived:BX.DoNothing};this.answerTimeout=null;this.callingTimeout=null;this.connectionTimeout=null;this.signalingConnectionTimeout=null;this.candidatesTimeout=null;this.statsInterval=null;this.connectionOfferReplyTimeout=null;this.negotiationNeededReplyTimeout=null;this.reconnectAfterDisconnectTimeout=null;this.connectionAttempt=0;this._onPeerConnectionIceCandidateHandler=this._onPeerConnectionIceCandidate.bind(this);this._onPeerConnectionIceConnectionStateChangeHandler=this._onPeerConnectionIceConnectionStateChange.bind(this);this._onPeerConnectionIceGatheringStateChangeHandler=this._onPeerConnectionIceGatheringStateChange.bind(this);this._onPeerConnectionTrackHandler=this._onPeerConnectionTrack.bind(this);this._onPeerConnectionRemoveStreamHandler=this._onPeerConnectionRemoveStream.bind(this)};BX.Call.PlainCall.Peer.prototype.sendMedia=function(e){var t=[];if(!this.peerConnection){if(!this.isInitiator()){this.log("waiting for the other side to send connection offer");this.sendNegotiationNeeded(false);return}}if(this.call.localStreams["main"]){t=t.concat(this.call.localStreams["main"].getAudioTracks())}if(this.call.localStreams["screen"]){t=t.concat(this.call.localStreams["screen"].getVideoTracks())}else if(this.call.localStreams["main"]){t=t.concat(this.call.localStreams["main"].getVideoTracks())}this.log("User: "+this.userId+"; Sending media streams. Tracks: "+t.map(function(e){return e.id}).join("; "));if(t.length===0){this.log("No media streams to send");return}if(this.peerConnection){this.peerConnection.getSenders().forEach(function(e){this.peerConnection.removeTrack(e)}.bind(this))}else{var n=BX.Call.Engine.getInstance().getUuidv4();this._createPeerConnection(n)}if(this.senderMediaStream&&this.senderMediaStream.getTracks().length>0){this.log("removing old tracks");this.senderMediaStream.getTracks().forEach(function(e){this.senderMediaStream.removeTrack(e)},this)}this.senderMediaStream=new MediaStream;t.forEach(function(e){this.senderMediaStream.addTrack(e);this.peerConnection.addTrack(e,this.senderMediaStream)},this);if(!e){this.createAndSendOffer()}};BX.Call.PlainCall.Peer.prototype.replaceMediaStream=function(e){if(this.isRenegotiationSupported()){this.sendMedia()}else{this.localStreams[e]=this.call.getLocalStream(e);this.reconnect()}};BX.Call.PlainCall.Peer.prototype.isInitiator=function(){return this.call.userId<this.userId};BX.Call.PlainCall.Peer.prototype.isRenegotiationSupported=function(){return BX.browser.IsChrome()&&this.isChrome};BX.Call.PlainCall.Peer.prototype.setReady=function(e){this.ready=e;if(this.ready){this.declined=false;this.busy=false}if(this.calling){clearTimeout(this.callingTimeout);this.calling=false}this.updateCalculatedState()};BX.Call.PlainCall.Peer.prototype.isReady=function(){return this.ready};BX.Call.PlainCall.Peer.prototype.onInvited=function(){this.ready=false;this.inviteTimeout=false;this.declined=false;this.calling=true;if(this.callingTimeout){clearTimeout(this.callingTimeout)}this.callingTimeout=setTimeout(function(){this.onInviteTimeout(true)}.bind(this),3e4);this.updateCalculatedState()};BX.Call.PlainCall.Peer.prototype.onInviteTimeout=function(e){clearTimeout(this.callingTimeout);this.calling=false;this.inviteTimeout=true;if(e){this.callbacks.onInviteTimeout({userId:this.userId})}this.updateCalculatedState()};BX.Call.PlainCall.Peer.prototype.setUserAgent=function(e){this.userAgent=e;this.isFirefox=e.toLowerCase().indexOf("firefox")!=-1;this.isChrome=e.toLowerCase().indexOf("chrome")!=-1;this.isMobile=e==="Bitrix Mobile"};BX.Call.PlainCall.Peer.prototype.getUserAgent=function(){return this.userAgent};BX.Call.PlainCall.Peer.prototype.isParticipating=function(){if(this.calling)return true;if(this.declined||this.busy)return false;if(this.peerConnection){var e=this.peerConnection.iceConnectionState;if(e=="checking"||e=="connected"||e=="completed"){return true}}return false};BX.Call.PlainCall.Peer.prototype.setSignalingConnected=function(e){this.signalingConnected=e;this.updateCalculatedState();if(this.signalingConnected)this.refreshSignalingTimeout();else this.stopSignalingTimeout()};BX.Call.PlainCall.Peer.prototype.isSignalingConnected=function(){return this.signalingConnected};BX.Call.PlainCall.Peer.prototype.setDeclined=function(e){this.declined=e;if(this.calling){clearTimeout(this.callingTimeout);this.calling=false}this.updateCalculatedState()};BX.Call.PlainCall.Peer.prototype.setBusy=function(e){this.busy=e;if(this.calling){clearTimeout(this.callingTimeout);this.calling=false}this.updateCalculatedState()};BX.Call.PlainCall.Peer.prototype.isDeclined=function(){return this.declined};BX.Call.PlainCall.Peer.prototype.updateCalculatedState=function(){var e=this.calculateState();if(this.calculatedState!=e){this.callbacks.onStateChanged({userId:this.userId,state:e,previousState:this.calculatedState,isMobile:this.isMobile});this.calculatedState=e}};BX.Call.PlainCall.Peer.prototype.calculateState=function(){if(this.peerConnection){if(this.failureReason!==""){return BX.Call.UserState.Failed}if(this.peerConnection.iceConnectionState==="connected"||this.peerConnection.iceConnectionState==="completed"){return BX.Call.UserState.Connected}return BX.Call.UserState.Connecting}if(this.calling)return BX.Call.UserState.Calling;if(this.inviteTimeout)return BX.Call.UserState.Unavailable;if(this.declined)return BX.Call.UserState.Declined;if(this.busy)return BX.Call.UserState.Busy;if(this.ready)return BX.Call.UserState.Ready;return BX.Call.UserState.Idle};BX.Call.PlainCall.Peer.prototype.getSignaling=function(){return this.call.signaling};BX.Call.PlainCall.Peer.prototype.startStatisticsGathering=function(){clearInterval(this.statsInterval);this.statsInterval=setInterval(function(){if(!this.peerConnection){return false}this.peerConnection.getStats().then(function(e){this.callbacks.onRTCStatsReceived({userId:this.userId,stats:e})}.bind(this))}.bind(this),1e3)};BX.Call.PlainCall.Peer.prototype.stopStatisticsGathering=function(){clearInterval(this.statsInterval);this.statsInterval=null};BX.Call.PlainCall.Peer.prototype.updateCandidatesTimeout=function(){if(this.candidatesTimeout){clearTimeout(this.candidatesTimeout)}this.candidatesTimeout=setTimeout(this.sendIceCandidates.bind(this),500)};BX.Call.PlainCall.Peer.prototype.sendIceCandidates=function(){this.candidatesTimeout=null;this.log("User "+this.userId+": sending ICE candidates due to the timeout");if(this.localIceCandidates.length>0){this.getSignaling().sendIceCandidate({userId:this.userId,connectionId:this.peerConnection._id,candidates:this.localIceCandidates});this.localIceCandidates=[]}else{this.log("User "+this.userId+": ICE candidates pool is empty")}};BX.Call.PlainCall.Peer.prototype._createPeerConnection=function(e){this.log("User "+this.userId+": Creating peer connection");var t={iceServers:[{urls:"stun:"+this.call.turnServer},{urls:"turn:"+this.call.turnServer,username:this.call.turnServerLogin,credential:this.call.turnServerPassword}]};this.localIceCandidates=[];var n=new RTCPeerConnection(t);n._id=e;n.addEventListener("icecandidate",this._onPeerConnectionIceCandidateHandler);n.addEventListener("iceconnectionstatechange",this._onPeerConnectionIceConnectionStateChangeHandler);n.addEventListener("icegatheringstatechange",this._onPeerConnectionIceGatheringStateChangeHandler);n.addEventListener("negotiationneeded",this._onPeerConnectionNegotiationNeededHandler);n.addEventListener("track",this._onPeerConnectionTrackHandler);n.addEventListener("removestream",this._onPeerConnectionRemoveStreamHandler);this.peerConnection=n;this.failureReason="";this.updateCalculatedState();this.startStatisticsGathering()};BX.Call.PlainCall.Peer.prototype._destroyPeerConnection=function(){if(!this.peerConnection)return;var e=this.peerConnection._id;this.log("User "+this.userId+": Destroying peer connection "+e);this.stopStatisticsGathering();this.peerConnection.removeEventListener("icecandidate",this._onPeerConnectionIceCandidateHandler);this.peerConnection.removeEventListener("iceconnectionstatechange",this._onPeerConnectionIceConnectionStateChangeHandler);this.peerConnection.removeEventListener("icegatheringstatechange",this._onPeerConnectionIceGatheringStateChangeHandler);this.peerConnection.removeEventListener("negotiationneeded",this._onPeerConnectionNegotiationNeededHandler);this.peerConnection.removeEventListener("track",this._onPeerConnectionTrackHandler);this.peerConnection.removeEventListener("removestream",this._onPeerConnectionRemoveStreamHandler);this.localIceCandidates=[];if(this.pendingIceCandidates[e]){delete this.pendingIceCandidates[e]}this.peerConnection.close();this.peerConnection=null};BX.Call.PlainCall.Peer.prototype._onPeerConnectionIceCandidate=function(e){var t=e.candidate;var n=e.target;this.log("User "+this.userId+": ICE candidate discovered. Candidate: "+(t?t.candidate:t));if(t){if(this.getSignaling().isIceTricklingAllowed()){this.getSignaling().sendIceCandidate({userId:this.userId,connectionId:n._id,candidates:[t.toJSON()]})}else{this.localIceCandidates.push(t.toJSON());this.updateCandidatesTimeout()}}};BX.Call.PlainCall.Peer.prototype._onPeerConnectionIceConnectionStateChange=function(e){this.log("User "+this.userId+": ICE connection state changed. New state: "+this.peerConnection.iceConnectionState);if(this.peerConnection.iceConnectionState==="connected"){this.connectionAttempt=0;clearTimeout(this.reconnectAfterDisconnectTimeout)}else if(this.peerConnection.iceConnectionState==="failed"){this.log("ICE connection failed. Trying to restore connection immediately");this.reconnect()}else if(this.peerConnection.iceConnectionState==="disconnected"){this.log("ICE connection lost. Waiting 5 seconds before trying to restore it");clearTimeout(this.reconnectAfterDisconnectTimeout);this.reconnectAfterDisconnectTimeout=setTimeout(function(){this.reconnect()}.bind(this),5e3)}this.updateCalculatedState()};BX.Call.PlainCall.Peer.prototype._onPeerConnectionIceGatheringStateChange=function(e){var t=e.target;this.log("User "+this.userId+": ICE gathering state changed to : "+t.iceGatheringState);if(t.iceGatheringState==="complete"){this.log("User "+this.userId+": ICE gathering complete");if(!this.getSignaling().isIceTricklingAllowed()){if(this.localIceCandidates.length>0){this.getSignaling().sendIceCandidate({userId:this.userId,connectionId:t._id,candidates:this.localIceCandidates});this.localIceCandidates=[]}else{this.log("User "+this.userId+": ICE candidates already sent")}}}};BX.Call.PlainCall.Peer.prototype._onPeerConnectionNegotiationNeeded=function(e){this.log("User "+this.userId+": needed negotiation for peer connection");this.log("signaling state: ",e.target.signalingState);this.log("ice connection state: ",e.target.iceConnectionState);this.log("pendingRemoteDescription: ",e.target.pendingRemoteDescription);if(e.target.iceConnectionState!=="new"&&e.target.iceConnectionState!=="connected"&&e.target.iceConnectionState!=="completed"){this.log("User "+this.userId+": wrong connection state");return}if(this.isInitiator()){this.createAndSendOffer()}else{this.sendNegotiationNeeded(this.peerConnection._forceReconnect===true)}};BX.Call.PlainCall.Peer.prototype._onPeerConnectionTrack=function(e){this.log("User "+this.userId+": media track received: ",e.track.id+" ("+e.track.kind+")");this.callbacks.onStreamReceived({userId:this.userId,kind:e.track.kind,stream:e.streams[0]})};BX.Call.PlainCall.Peer.prototype._onPeerConnectionRemoveStream=function(e){this.log("User: "+this.userId+"_onPeerConnectionRemoveStream: ",e);this.callbacks.onStreamRemoved({userId:this.userId,stream:e.stream})};BX.Call.PlainCall.Peer.prototype.stopSignalingTimeout=function(){clearTimeout(this.signalingConnectionTimeout)};BX.Call.PlainCall.Peer.prototype.refreshSignalingTimeout=function(){clearTimeout(this.signalingConnectionTimeout);this.signalingConnectionTimeout=setTimeout(this._onLostSignalingConnection.bind(this),i)};BX.Call.PlainCall.Peer.prototype._onLostSignalingConnection=function(){this.setSignalingConnected(false)};BX.Call.PlainCall.Peer.prototype._onConnectionOfferReplyTimeout=function(e){this.log("did not receive connection answer for connection "+e);this.reconnect()};BX.Call.PlainCall.Peer.prototype._onNegotiationNeededReplyTimeout=function(){this.log("did not receive connection offer in time");this.reconnect()};BX.Call.PlainCall.Peer.prototype.setConnectionOffer=function(e,t){this.log("User "+this.userId+": applying connection offer for connection "+e);clearTimeout(this.negotiationNeededReplyTimeout);this.negotiationNeededReplyTimeout=null;if(!this.call.isReady())return;if(!this.isReady())return;if(this.peerConnection){if(this.peerConnection._id!==e){this._destroyPeerConnection();this._createPeerConnection(e)}}else{this._createPeerConnection(e)}this.applyOfferAndSendAnswer(t)};BX.Call.PlainCall.Peer.prototype.createAndSendOffer=function(e){var t=this;connectionConfig=n;for(var i in e){connectionConfig[i]=e[i]}t.peerConnection.createOffer(connectionConfig).then(function(e){t.log("User "+t.userId+": Created connection offer.");t.log("Applying local description");return t.peerConnection.setLocalDescription(e)}).then(function(){t.sendOffer()})};BX.Call.PlainCall.Peer.prototype.sendOffer=function(){var e=this.peerConnection._id;clearTimeout(this.connectionOfferReplyTimeout);this.connectionOfferReplyTimeout=setTimeout(function(){this._onConnectionOfferReplyTimeout(e)}.bind(this),a);this.getSignaling().sendConnectionOffer({userId:this.userId,connectionId:e,sdp:this.peerConnection.localDescription.sdp,userAgent:navigator.userAgent})};BX.Call.PlainCall.Peer.prototype.sendNegotiationNeeded=function(e){e=e===true;clearTimeout(this.negotiationNeededReplyTimeout);this.negotiationNeededReplyTimeout=setTimeout(function(){this._onNegotiationNeededReplyTimeout()}.bind(this),a);var t={userId:this.userId};if(e){t.restart=true}this.getSignaling().sendNegotiationNeeded(t)};BX.Call.PlainCall.Peer.prototype.applyOfferAndSendAnswer=function(e){var t=this;var n=new RTCSessionDescription({type:"offer",sdp:e});var i=this.peerConnection;this.log("User: "+this.userId+"; Applying remote offer");this.log("User: "+this.userId+"; Peer ice connection state ",i.iceConnectionState);i.setRemoteDescription(n).then(function(){if(i.iceConnectionState==="new"){t.sendMedia(true)}return t.peerConnection.createAnswer()}).then(function(e){t.log("Created connection answer.");t.log("Applying local description.");return t.peerConnection.setLocalDescription(e)}).then(function(){t.applyPendingIceCandidates();t.getSignaling().sendConnectionAnswer({userId:t.userId,connectionId:t.peerConnection._id,sdp:t.peerConnection.localDescription.sdp,userAgent:navigator.userAgent})}).catch(function(e){t.failureReason=e.toString();t.updateCalculatedState();t.log("Could not apply remote offer",e);console.error("Could not apply remote offer",e)})};BX.Call.PlainCall.Peer.prototype.setConnectionAnswer=function(e,t){var n=this;if(!this.peerConnection)return;if(this.peerConnection._id!=e){this.log("Could not apply answer, for unknown connection "+e);return}if(this.peerConnection.signalingState!=="have-local-offer"){this.log("Could not apply answer, wrong peer connection signaling state "+this.peerConnection.signalingState);return}var i=new RTCSessionDescription({type:"answer",sdp:t});clearTimeout(this.connectionOfferReplyTimeout);this.log("User: "+this.userId+"; Applying remote answer");this.peerConnection.setRemoteDescription(i).then(function(){n.applyPendingIceCandidates()}).catch(function(e){n.failureReason=e.toString();n.updateCalculatedState();n.log(e)})};BX.Call.PlainCall.Peer.prototype.addIceCandidate=function(e,t){if(!this.peerConnection)return;if(this.peerConnection._id!=e){this.log("Error: Candidate for unknown connection "+e);return}if(this.peerConnection.remoteDescription&&this.peerConnection.remoteDescription.type){this.peerConnection.addIceCandidate(t).then(function(){this.log("User: "+this.userId+"; Added remote ICE candidate: "+(t?t.candidate:t))}.bind(this)).catch(function(e){this.log(e)}.bind(this))}else{if(!this.pendingIceCandidates[e]){this.pendingIceCandidates[e]=[]}this.pendingIceCandidates[e].push(t)}};BX.Call.PlainCall.Peer.prototype.applyPendingIceCandidates=function(){var e=this;if(!this.peerConnection||!this.peerConnection.remoteDescription.type)return;var t=this.peerConnection._id;if(BX.type.isArray(this.pendingIceCandidates[t])){this.pendingIceCandidates[t].forEach(function(t){e.peerConnection.addIceCandidate(t).then(function(){this.log("User: "+this.userId+"; Added remote ICE candidate: "+(t?t.candidate:t))}.bind(this))},this);e.pendingIceCandidates[t]=[]}};BX.Call.PlainCall.Peer.prototype.onNegotiationNeeded=function(){if(this.peerConnection){if(this.peerConnection.signalingState=="have-local-offer"){this.sendOffer()}else{this.createAndSendOffer({iceRestart:true})}}else{this.sendMedia()}};BX.Call.PlainCall.Peer.prototype.reconnect=function(){clearTimeout(this.reconnectAfterDisconnectTimeout);this.connectionAttempt++;if(this.connectionAttempt>3){this.log("Error: Too many reconnection attempts, giving up");this.failureReason="Could not connect to user in time";this.updateCalculatedState();return}this.log("Trying to restore ICE connection. Attempt "+this.connectionAttempt);if(this.isInitiator()){this._destroyPeerConnection();this.sendMedia()}else{this.sendNegotiationNeeded(true)}};BX.Call.PlainCall.Peer.prototype.disconnect=function(){this._destroyPeerConnection()};BX.Call.PlainCall.Peer.prototype.log=function(){this.call.log.apply(this.call,arguments)};BX.Call.PlainCall.Peer.prototype.destroy=function(){this.disconnect();if(this.voiceDetection){this.voiceDetection.destroy();this.voiceDetection=null}for(var e in this.localStreams){this.localStreams[e]=null}clearTimeout(this.answerTimeout);this.answerTimeout=null;clearTimeout(this.connectionTimeout);this.connectionTimeout=null;clearTimeout(this.signalingConnectionTimeout);this.signalingConnectionTimeout=null;this.callbacks.onStateChanged=BX.DoNothing;this.callbacks.onStreamReceived=BX.DoNothing;this.callbacks.onStreamRemoved=BX.DoNothing}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:57:"/bitrix/js/im/call/voximplant_call.min.js?159956829835429";s:6:"source";s:37:"/bitrix/js/im/call/voximplant_call.js";s:3:"min";s:41:"/bitrix/js/im/call/voximplant_call.min.js";s:3:"map";s:41:"/bitrix/js/im/call/voximplant_call.map.js";}"*/
(function(){BX.namespace("BX.Call");var e={invite:"im.call.invite",cancel:"im.call.cancel",answer:"im.call.answer",decline:"im.call.decline",hangup:"im.call.hangup",ping:"im.call.ping"};var t={ping:"Call::ping",hangup:"Call::hangup",userInviteTimeout:"Call::userInviteTimeout"};var i={voiceStarted:"Call::voiceStarted",voiceStopped:"Call::voiceStopped",microphoneState:"Call::microphoneState",screenState:"Call::screenState",showUsers:"Call::showUsers",showAll:"Call::showAll",hideAll:"Call::hideAll"};var n={onCallConference:"VoximplantCall::onCallConference"};var a=5e3;var l=25e3;var s=5500;var o=15e3;if(window["BXDesktopSystem"]){navigator["getDisplayMedia"]=function(){var e={audio:false,video:{mandatory:{chromeMediaSource:"desktop",maxWidth:screen.width>1920?screen.width:1920,maxHeight:screen.height>1080?screen.height:1080},optional:[{googTemporalLayeredScreencast:true}]}};return navigator.mediaDevices.getUserMedia(e)}}BX.Call.VoximplantCall=function(e){BX.Call.VoximplantCall.superclass.constructor.apply(this,arguments);this.videoQuality=BX.Call.Quality.VeryHigh;this.voximplantCall=null;this.signaling=new BX.Call.VoximplantCall.Signaling({call:this});this.peers={};this.joinedElsewhere=false;this.localVideoShown=false;this.clientEventsBound=false;this._screenShared=false;this.videoAllowedFrom=BX.Call.UserMnemonic.all;Object.defineProperty(this,"screenShared",{get:function(){return this._screenShared},set:function(e){if(e!=this._screenShared){this._screenShared=e;this.signaling.sendScreenState(this._screenShared)}}});this.deviceList=[];this.__onLocalDevicesUpdatedHandler=this.__onLocalDevicesUpdated.bind(this);this.__onLocalMediaRendererAddedHandler=this.__onLocalMediaRendererAdded.bind(this);this.__onBeforeLocalMediaRendererRemovedHandler=this.__onBeforeLocalMediaRendererRemoved.bind(this);this.__onCallDisconnectedHandler=this.__onCallDisconnected.bind(this);this.__onCallMessageReceivedHandler=this.__onCallMessageReceived.bind(this);this.__onCallEndpointAddedHandler=this.__onCallEndpointAdded.bind(this);this.__onWindowUnloadHandler=this.__onWindowUnload.bind(this);window.addEventListener("unload",this.__onWindowUnloadHandler);this.initPeers();this.pingUsersInterval=setInterval(this.pingUsers.bind(this),a);this.pingBackendInterval=setInterval(this.pingBackend.bind(this),l);this.lastPingReceivedTimeout=null;this.lastSelfPingReceivedTimeout=null;this.reinviteTimeout=null};BX.extend(BX.Call.VoximplantCall,BX.Call.AbstractCall);BX.Call.VoximplantCall.prototype.initPeers=function(){this.users.forEach(function(e){e=Number(e);this.peers[e]=this.createPeer(e)},this)};BX.Call.VoximplantCall.prototype.reinitPeers=function(){for(var e in this.peers){if(this.peers.hasOwnProperty(e)&&this.peers[e]){this.peers[e].destroy();this.peers[e]=null}}this.initPeers()};BX.Call.VoximplantCall.prototype.pingUsers=function(){if(this.ready){var e=this.users.concat(this.userId);this.signaling.sendPingToUsers({userId:e},true)}};BX.Call.VoximplantCall.prototype.pingBackend=function(){if(this.ready){this.signaling.sendPingToBackend()}};BX.Call.VoximplantCall.prototype.createPeer=function(e){var t;if(this.videoAllowedFrom===BX.Call.UserMnemonic.all){t=true}else if(this.videoAllowedFrom===BX.Call.UserMnemonic.none){t=false}else if(BX.type.isArray(this.videoAllowedFrom)){t=this.videoAllowedFrom.some(function(t){return t==e})}else{t=true}return new BX.Call.VoximplantCall.Peer({call:this,userId:e,ready:e==this.initiatorId,isIncomingVideoAllowed:t,onStreamReceived:function(e){this.runCallback(BX.Call.Event.onStreamReceived,e)}.bind(this),onStreamRemoved:function(e){this.runCallback(BX.Call.Event.onStreamRemoved,e)}.bind(this),onStateChanged:this.__onPeerStateChanged.bind(this),onInviteTimeout:this.__onPeerInviteTimeout.bind(this)})};BX.Call.VoximplantCall.prototype.getUsers=function(){var e={};for(var t in this.peers){e[t]=this.peers[t].calculatedState}return e};BX.Call.VoximplantCall.prototype.getClient=function(){return new Promise(function(e,t){BX.Voximplant.getClient({restClient:BX.CallEngine.getRestClient()}).then(function(t){t.enableSilentLogging();t.setLoggerCallback(function(e){this.log(e.label+": "+e.message)}.bind(this));this.bindClientEvents();e(t)}.bind(this)).catch(t)}.bind(this))};BX.Call.VoximplantCall.prototype.bindClientEvents=function(){var e=VoxImplant.Hardware.StreamManager.get();if(!this.clientEventsBound){e.on(VoxImplant.Hardware.HardwareEvents.DevicesUpdated,this.__onLocalDevicesUpdatedHandler);e.on(VoxImplant.Hardware.HardwareEvents.MediaRendererAdded,this.__onLocalMediaRendererAddedHandler);e.on(VoxImplant.Hardware.HardwareEvents.MediaRendererUpdated,this.__onLocalMediaRendererAddedHandler);e.on(VoxImplant.Hardware.HardwareEvents.BeforeMediaRendererRemoved,this.__onBeforeLocalMediaRendererRemovedHandler);this.clientEventsBound=true}};BX.Call.VoximplantCall.prototype.removeClientEvents=function(){if(!("VoxImplant"in window)){return}var e=VoxImplant.Hardware.StreamManager.get();e.off(VoxImplant.Hardware.HardwareEvents.DevicesUpdated,this.__onLocalDevicesUpdatedHandler);e.off(VoxImplant.Hardware.HardwareEvents.MediaRendererAdded,this.__onLocalMediaRendererAddedHandler);e.off(VoxImplant.Hardware.HardwareEvents.BeforeMediaRendererRemoved,this.__onBeforeLocalMediaRendererRemovedHandler);this.clientEventsBound=false};BX.Call.VoximplantCall.prototype.setMuted=function(e){if(this.muted==e){return}this.muted=e;if(this.voximplantCall){if(this.muted){this.voximplantCall.muteMicrophone()}else{this.voximplantCall.unmuteMicrophone()}this.signaling.sendMicrophoneState(!this.muted)}};BX.Call.VoximplantCall.prototype.setVideoEnabled=function(e){e=e===true;if(this.videoEnabled==e){return}this.videoEnabled=e;if(this.voximplantCall){if(e){this._showLocalVideo()}else{if(this.localVideoShown){VoxImplant.Hardware.StreamManager.get().hideLocalVideo().then(function(){this.localVideoShown=false;this.runCallback(BX.Call.Event.onLocalMediaReceived,{tag:"main",stream:new MediaStream})}.bind(this))}}this.voximplantCall.sendVideo(this.videoEnabled)}};BX.Call.VoximplantCall.prototype.setCameraId=function(e){if(this.cameraId==e){return}this.cameraId=e;if(this.voximplantCall){VoxImplant.Hardware.CameraManager.get().getInputDevices().then(function(){VoxImplant.Hardware.CameraManager.get().setCallVideoSettings(this.voximplantCall,this.constructCameraParams())}.bind(this))}};BX.Call.VoximplantCall.prototype.setMicrophoneId=function(e){if(this.microphoneId==e){return}this.microphoneId=e;if(this.voximplantCall){VoxImplant.Hardware.AudioDeviceManager.get().getInputDevices().then(function(){VoxImplant.Hardware.AudioDeviceManager.get().setCallAudioSettings(this.voximplantCall,{inputId:this.microphoneId})}.bind(this))}};BX.Call.VoximplantCall.prototype.getCurrentMicrophoneId=function(){if(this.voximplantCall.peerConnection.impl.getTransceivers){var e=this.voximplantCall.peerConnection.impl.getTransceivers();if(e.length>0){var t=e[0].sender.track;var i=t.getSettings();return i.deviceId}}return this.microphoneId};BX.Call.VoximplantCall.prototype.constructCameraParams=function(){var e={};if(this.cameraId){e.cameraId=this.cameraId}if(this.videoQuality){var t=BX.Call.Util.getMaxResolution(this.videoQuality,this.videoHd);e.frameHeight=t.height;e.frameWidth=t.width}else{e.videoQuality=this.videoHd&&this.videoQuality===BX.Call.Quality.VeryHigh?VoxImplant.Hardware.VideoQuality.VIDEO_SIZE_HD:VoxImplant.Hardware.VideoQuality.VIDEO_SIZE_nHD}return e};BX.Call.VoximplantCall.prototype.useHdVideo=function(e){this.videoHd=e===true};BX.Call.VoximplantCall.prototype.setVideoQuality=function(e){if(this.videoQuality==e){return}this.videoQuality=e;this._applyCurrentVideoQuality()};BX.Call.VoximplantCall.prototype.allowVideoFrom=function(e){if(this.videoAllowedFrom==e){return}this.videoAllowedFrom=e;if(e===BX.Call.UserMnemonic.all){this.signaling.sendShowAll();e=Object.keys(this.peers)}else if(e===BX.Call.UserMnemonic.none){this.signaling.sendHideAll();e=[]}else if(BX.type.isArray(e)){this.signaling.sendShowUsers(e)}else{throw new Error("userList is in wrong format")}var t={};e.forEach(function(e){t[e]=true});for(var i in this.peers){if(!this.peers.hasOwnProperty(i)){continue}if(t[i]){this.peers[i].allowIncomingVideo(true)}else{this.peers[i].allowIncomingVideo(false)}}};BX.Call.VoximplantCall.prototype._setMaxBitrate=function(e){if(this.voximplantCall){var t=this.voximplantCall.peerConnection.getTransceivers();if(!t){return}t.forEach(function(t){if(t.sender&&t.sender.track&&t.sender.track.kind==="video"&&!t.stoped&&t.currentDirection.indexOf("send")!==-1){var i=t.sender;var n=i.getParameters();if(!n.encodings){n.encodings=[{}]}if(e===0){delete n.encodings[0].maxBitrate}else{n.encodings[0].maxBitrate=e*1e3}i.setParameters(n)}},this)}};BX.Call.VoximplantCall.prototype._applyCurrentVideoQuality=function(){this.log("Trying to apply video quality "+this.videoQuality);if(!this.voximplantCall){return}if("RTCRtpSender"in window&&"setParameters"in window.RTCRtpSender.prototype){this._setMaxBitrate(BX.Call.Util.getMaxBitrate(this.videoQuality))}VoxImplant.Hardware.CameraManager.get().setCallVideoSettings(this.voximplantCall,this.constructCameraParams())};BX.Call.VoximplantCall.prototype._showLocalVideo=function(){return new Promise(function(e,t){VoxImplant.Hardware.StreamManager.get().showLocalVideo().then(function(){this.localVideoShown=true;e()}.bind(this),function(){this.localVideoShown=true;e()}.bind(this))}.bind(this))};BX.Call.VoximplantCall.prototype._hideLocalVideo=function(){return new Promise(function(e,t){if(!("VoxImplant"in window)){e();return}VoxImplant.Hardware.StreamManager.get().hideLocalVideo().then(function(){this.localVideoShown=false;e()}.bind(this),function(){this.localVideoShown=false;e()}.bind(this))})};BX.Call.VoximplantCall.prototype.startScreenSharing=function(){if(!this.voximplantCall){return}var e=!this.videoEnabled;var t=this.videoEnabled;this.voximplantCall.shareScreen(e,t).then(function(){this.log("Screen shared");this.screenShared=true}.bind(this))};BX.Call.VoximplantCall.prototype.stopScreenSharing=function(){if(!this.voximplantCall){return}this.voximplantCall.stopSharingScreen().then(function(){this.log("Screen is no longer shared");this.screenShared=false}.bind(this))};BX.Call.VoximplantCall.prototype.isScreenSharingStarted=function(){return this.screenShared};BX.Call.VoximplantCall.prototype.inviteUsers=function(e){var t=this;this.ready=true;if(!BX.type.isPlainObject(e)){e={}}var i=BX.type.isArray(e.users)?e.users:this.users;this.attachToConference().then(function(){t.signaling.sendPingToUsers({userId:i});if(i.length>0){return t.signaling.inviteUsers({userIds:i,video:t.videoEnabled?"Y":"N"})}}).then(function(e){t.runCallback(BX.Call.Event.onJoin,{local:true});for(var n=0;n<i.length;n++){var a=parseInt(i[n],10);if(!t.users.includes(a)){t.users.push(a)}if(!t.peers[a]){t.peers[a]=t.createPeer(a);t.runCallback(BX.Call.Event.onUserInvited,{userId:a})}t.peers[a].onInvited();t.scheduleRepeatInvite()}}).catch(t.onFatalError.bind(t))};BX.Call.VoximplantCall.prototype.scheduleRepeatInvite=function(){clearTimeout(this.reinviteTimeout);this.reinviteTimeout=setTimeout(this.repeatInviteUsers.bind(this),s)};BX.Call.VoximplantCall.prototype.repeatInviteUsers=function(){clearTimeout(this.reinviteTimeout);if(!this.ready){return}var e=[];for(var t in this.peers){if(this.peers.hasOwnProperty(t)&&this.peers[t].calculatedState===BX.Call.UserState.Calling){e.push(t)}}if(e.length===0){return}this.signaling.inviteUsers({userIds:e,video:this.videoEnabled?"Y":"N"}).then(function(){this.scheduleRepeatInvite()}.bind(this))};BX.Call.VoximplantCall.prototype.answer=function(e){this.ready=true;if(!BX.type.isPlainObject(e)){e={}}this.videoEnabled=e.useVideo==true;this.sendAnswer();this.attachToConference().then(function(){this.log("Attached to conference");this.runCallback(BX.Call.Event.onJoin,{local:true})}.bind(this)).catch(this.onFatalError.bind(this))};BX.Call.VoximplantCall.prototype.sendAnswer=function(){this.signaling.sendAnswer()};BX.Call.VoximplantCall.prototype.decline=function(t){this.ready=false;var i={callId:this.id,callInstanceId:this.instanceId};if(t){i.code=t}BX.CallEngine.getRestClient().callMethod(e.decline,i)};BX.Call.VoximplantCall.prototype.hangup=function(e,t){if(!this.ready){var i=new Error("Hangup in wrong state");this.log(i);return}var n=new Error;n.name="Call stack:";this.log("Hangup received \n"+n.stack);var a={};this.ready=false;if(typeof e!="undefined"){a.code=e}if(typeof t!="undefined"){a.reason=t}this.runCallback(BX.Call.Event.onLeave,{local:true});a.userId=this.users;this.signaling.sendHangup(a);this.muted=false;this.reinitPeers();if(this.voximplantCall){this.voximplantCall._replaceVideoSharing=false;try{this.voximplantCall.hangup()}catch(e){console.error(e)}}this.screenShared=false;this._hideLocalVideo()};BX.Call.VoximplantCall.prototype.attachToConference=function(){var e=this;return new Promise(function(t,i){if(e.voximplantCall&&e.voximplantCall.state()==="CONNECTED"){return t()}e.getClient().then(function(n){VoxImplant.Hardware.CameraManager.get().setDefaultVideoSettings(e.constructCameraParams());if(e.microphoneId){VoxImplant.Hardware.AudioDeviceManager.get().setDefaultAudioSettings({inputId:this.microphoneId})}if(e.videoEnabled){e._showLocalVideo()}try{e.voximplantCall=n.callConference({number:"bx_conf_"+e.id,video:{sendVideo:e.videoEnabled,receiveVideo:true},customData:{}})}catch(e){console.error(e);return i(e)}if(!e.voximplantCall){e.log("Error: could not create voximplant call");return i({code:"VOX_NO_CALL"})}e.runCallback(BX.Call.VoximplantCall.Event.onCallConference,{call:e});e.bindCallEvents();var a=function(){e.log("Call connected");e.voximplantCall.removeEventListener(VoxImplant.CallEvents.Connected,a);e.voximplantCall.removeEventListener(VoxImplant.CallEvents.Failed,l);e.voximplantCall.addEventListener(VoxImplant.CallEvents.Failed,e.__onCallDisconnectedHandler);if(e.deviceList.length===0){navigator.mediaDevices.enumerateDevices().then(function(t){e.deviceList=t;e.runCallback(BX.Call.Event.onDeviceListUpdated,{deviceList:e.deviceList})})}else{e.runCallback(BX.Call.Event.onDeviceListUpdated,{deviceList:e.deviceList})}if(e.muted){e.voximplantCall.muteMicrophone()}e.signaling.sendMicrophoneState(!e.muted);if(e.videoAllowedFrom==BX.Call.UserMnemonic.none){e.signaling.sendHideAll()}else if(BX.type.isArray(e.videoAllowedFrom)){e.signaling.sendShowUsers(e.videoAllowedFrom)}t()};var l=function(t){e.log("Could not attach to conference",t);e.voximplantCall.removeEventListener(VoxImplant.CallEvents.Connected,a);e.voximplantCall.removeEventListener(VoxImplant.CallEvents.Failed,l);var n=VoxImplant.getInstance();n.enableSilentLogging(false);n.setLoggerCallback(null);i(t)};e.voximplantCall.addEventListener(VoxImplant.CallEvents.Connected,a);e.voximplantCall.addEventListener(VoxImplant.CallEvents.Failed,l)}).catch(e.onFatalError.bind(e))})};BX.Call.VoximplantCall.prototype.bindCallEvents=function(){this.voximplantCall.addEventListener(VoxImplant.CallEvents.Disconnected,this.__onCallDisconnectedHandler);this.voximplantCall.addEventListener(VoxImplant.CallEvents.MessageReceived,this.__onCallMessageReceivedHandler);this.voximplantCall.addEventListener(VoxImplant.CallEvents.EndpointAdded,this.__onCallEndpointAddedHandler)};BX.Call.VoximplantCall.prototype.removeCallEvents=function(){if(this.voximplantCall){this.voximplantCall.removeEventListener(VoxImplant.CallEvents.Disconnected,this.__onCallDisconnectedHandler);this.voximplantCall.removeEventListener(VoxImplant.CallEvents.MessageReceived,this.__onCallMessageReceivedHandler);this.voximplantCall.removeEventListener(VoxImplant.CallEvents.EndpointAdded,this.__onCallEndpointAddedHandler)}};BX.Call.VoximplantCall.prototype.addJoinedUsers=function(e){for(var t=0;t<e.length;t++){var i=Number(e[t]);if(i==this.userId||this.peers[i]){continue}this.peers[i]=this.createPeer(i);if(!this.users.includes(i)){this.users.push(i)}this.runCallback(BX.Call.Event.onUserInvited,{userId:i})}};BX.Call.VoximplantCall.prototype.addInvitedUsers=function(e){for(var t=0;t<e.length;t++){var i=Number(e[t]);if(i==this.userId){continue}if(this.peers[i]){if(this.peers[i].calculatedState===BX.Call.UserState.Failed||this.peers[i].calculatedState===BX.Call.UserState.Idle){this.peers[i].onInvited()}}else{this.peers[i]=this.createPeer(i);this.peers[i].onInvited()}if(!this.users.includes(i)){this.users.push(i)}this.runCallback(BX.Call.Event.onUserInvited,{userId:i})}};BX.Call.VoximplantCall.prototype.isAnyoneParticipating=function(){for(var e in this.peers){if(this.peers[e].isParticipating()){return true}}return false};BX.Call.VoximplantCall.prototype.getParticipatingUsers=function(){var e=[];for(var t in this.peers){if(this.peers[t].isParticipating()){e.push(t)}}return e};BX.Call.VoximplantCall.prototype.__onPeerStateChanged=function(e){this.runCallback(BX.Call.Event.onUserStateChanged,e);if(!this.ready){return}if(e.state==BX.Call.UserState.Failed||e.state==BX.Call.UserState.Unavailable||e.state==BX.Call.UserState.Declined||e.state==BX.Call.UserState.Idle){if(!this.isAnyoneParticipating()){this.hangup()}}};BX.Call.VoximplantCall.prototype.__onPeerInviteTimeout=function(e){if(!this.ready){return}this.signaling.sendUserInviteTimeout({userId:this.users,failedUserId:e.userId})};BX.Call.VoximplantCall.prototype.__onPullEvent=function(e,t,i){var n={"Call::answer":this.__onPullEventAnswer.bind(this),"Call::hangup":this.__onPullEventHangup.bind(this),"Call::usersJoined":this.__onPullEventUsersJoined.bind(this),"Call::usersInvited":this.__onPullEventUsersInvited.bind(this),"Call::userInviteTimeout":this.__onPullEventUserInviteTimeout.bind(this),"Call::ping":this.__onPullEventPing.bind(this),"Call::finish":this.__onPullEventFinish.bind(this)};if(n[e]){n[e].call(this,t)}};BX.Call.VoximplantCall.prototype.__onPullEventAnswer=function(e){var t=Number(e.senderId);if(t==this.userId){return this.__onPullEventAnswerSelf(e)}if(!this.peers[t]){this.peers[t]=this.createPeer(t);this.runCallback(BX.Call.Event.onUserInvited,{userId:t})}if(!this.users.includes(t)){this.users.push(t)}this.peers[t].setReady(true)};BX.Call.VoximplantCall.prototype.__onPullEventAnswerSelf=function(e){if(e.callInstanceId===this.instanceId){return}this.joinedElsewhere=true;this.runCallback(BX.Call.Event.onJoin,{local:false})};BX.Call.VoximplantCall.prototype.__onPullEventHangup=function(e){var t=e.senderId;if(this.userId==t&&this.instanceId!=e.callInstanceId){this.runCallback(BX.Call.Event.onLeave,{local:false});return}if(!this.peers[t])return;this.peers[t].setReady(false);if(e.code==603){this.peers[t].setDeclined(true)}else if(e.code==486){this.peers[t].setBusy(true);console.error("user "+t+" is busy")}if(this.ready&&!this.isAnyoneParticipating()){this.hangup()}};BX.Call.VoximplantCall.prototype.__onPullEventUsersJoined=function(e){this.log("__onPullEventUsersJoined",e);var t=e.users;this.addJoinedUsers(t)};BX.Call.VoximplantCall.prototype.__onPullEventUsersInvited=function(e){this.log("__onPullEventUsersInvited",e);var t=e.users;this.addInvitedUsers(t)};BX.Call.VoximplantCall.prototype.__onPullEventUserInviteTimeout=function(e){this.log("__onPullEventUserInviteTimeout",e);var t=e.failedUserId;if(this.peers[t]){this.peers[t].onInviteTimeout(false)}};BX.Call.VoximplantCall.prototype.__onPullEventPing=function(e){if(e.callInstanceId==this.instanceId){return}var t=Number(e.senderId);if(t==this.userId){if(!this.joinedElsewhere){this.runCallback(BX.Call.Event.onJoin,{local:false});this.joinedElsewhere=true}clearTimeout(this.lastSelfPingReceivedTimeout);this.lastSelfPingReceivedTimeout=setTimeout(this.__onNoSelfPingsReceived.bind(this),a*2.1)}clearTimeout(this.lastPingReceivedTimeout);this.lastPingReceivedTimeout=setTimeout(this.__onNoPingsReceived.bind(this),a*2.1);if(this.peers[t]){this.peers[t].setReady(true)}};BX.Call.VoximplantCall.prototype.__onNoPingsReceived=function(){if(!this.ready){this.destroy()}};BX.Call.VoximplantCall.prototype.__onNoSelfPingsReceived=function(){this.runCallback(BX.Call.Event.onLeave,{local:false});this.joinedElsewhere=false};BX.Call.VoximplantCall.prototype.__onPullEventFinish=function(e){this.destroy()};BX.Call.VoximplantCall.prototype.__onLocalDevicesUpdated=function(e){this.log("__onLocalDevicesUpdated",e)};BX.Call.VoximplantCall.prototype.__onLocalMediaRendererAdded=function(e){var t=e.renderer;var i=t.stream.getVideoTracks().length>0?t.stream.getVideoTracks()[0].label:"";this.log("__onLocalMediaRendererAdded",t.kind,i);if(t.kind==="video"){if(i.match(/^screen|window|tab/i)){var n="screen"}else{n="main"}this.screenShared=n==="screen";this.runCallback(BX.Call.Event.onLocalMediaReceived,{tag:n,stream:t.stream})}else if(t.kind==="sharing"){this.runCallback(BX.Call.Event.onLocalMediaReceived,{tag:"screen",stream:t.stream});this.screenShared=true}};BX.Call.VoximplantCall.prototype.__onBeforeLocalMediaRendererRemoved=function(e){var t=e.renderer;this.log("__onBeforeLocalMediaRendererRemoved",t.kind);if(t.kind==="sharing"&&!this.videoEnabled){this.runCallback(BX.Call.Event.onLocalMediaReceived,{tag:"main",stream:new MediaStream});this.screenShared=false}};BX.Call.VoximplantCall.prototype.__onCallDisconnected=function(e){this.log("__onCallDisconnected",e);this.ready=false;this.muted=false;this.reinitPeers();this._hideLocalVideo();this.removeCallEvents();this.voximplantCall=null;var t=VoxImplant.getInstance();t.enableSilentLogging(false);t.setLoggerCallback(null);this.runCallback(BX.Call.Event.onLeave,{local:true})};BX.Call.VoximplantCall.prototype.__onWindowUnload=function(){if(this.ready&&this.voximplantCall){this.signaling.sendHangup({userId:this.users})}};BX.Call.VoximplantCall.prototype.onFatalError=function(e){if(e&&e.call){delete e.call}this.log("onFatalError",e);this.ready=false;this.muted=false;this.reinitPeers();this._hideLocalVideo().then(function(){if(this.voximplantCall){this.removeCallEvents();try{this.voximplantCall.hangup({"X-Reason":"Fatal error","X-Error":typeof e==="string"?e:e.code||e.name})}catch(e){}this.voximplantCall=null}var t=VoxImplant.getInstance();t.enableSilentLogging(false);t.setLoggerCallback(null);if(typeof e==="string"){this.runCallback(BX.Call.Event.onCallFailure,{name:e})}else if(e.name){this.runCallback(BX.Call.Event.onCallFailure,e)}}.bind(this))};BX.Call.VoximplantCall.prototype.__onCallEndpointAdded=function(e){var t=e.endpoint;var i=t.userName;this.log("__onCallEndpointAdded ("+i+")",e.endpoint);if(BX.type.isNotEmptyString(i)&&i.substr(0,4)=="user"){var n=parseInt(i.substr(4));if(this.peers[n]){this.peers[n].setEndpoint(t)}this.setVideoQuality(BX.CallEngine.getAllowedVideoQuality(this.voximplantCall.getEndpoints().length-1))}else{t.addEventListener(VoxImplant.EndpointEvents.InfoUpdated,function(e){var t=e.endpoint;var i=t.userName;this.log("VoxImplant.EndpointEvents.InfoUpdated ("+i+")",e.endpoint);if(BX.type.isNotEmptyString(i)&&i.substr(0,4)=="user"){var n=parseInt(i.substr(4));if(this.peers[n]){this.peers[n].setEndpoint(t)}}this.setVideoQuality(BX.CallEngine.getAllowedVideoQuality(this.voximplantCall.getEndpoints().length-1))}.bind(this));this.log("Unknown endpoint "+i)}};BX.Call.VoximplantCall.prototype.__onCallMessageReceived=function(e){var t;try{t=JSON.parse(e.text)}catch(e){this.log("Could not parse scenario message.",e);return}var n=t.eventName;if(n===i.voiceStarted){this.runCallback(BX.Call.Event.onUserVoiceStarted,{userId:t.senderId})}else if(n===i.voiceStopped){this.runCallback(BX.Call.Event.onUserVoiceStopped,{userId:t.senderId})}else if(n===i.microphoneState){this.runCallback(BX.Call.Event.onUserMicrophoneState,{userId:t.senderId,microphoneState:t.microphoneState==="Y"})}else if(n===i.screenState){this.runCallback(BX.Call.Event.onUserScreenState,{userId:t.senderId,screenState:t.screenState==="Y"})}else if(n==="scenarioLogUrl"){console.warn("scenario log url: "+t.logUrl)}else{this.log("Unknown scenario event "+n)}};BX.Call.VoximplantCall.prototype.destroy=function(){this.ready=false;this._hideLocalVideo();if(this.voximplantCall){this.removeCallEvents();if(this.voximplantCall.state()!="ENDED"){this.voximplantCall.hangup()}this.voximplantCall=null}for(var e in this.peers){if(this.peers.hasOwnProperty(e)&&this.peers[e]){this.peers[e].destroy()}}this.removeClientEvents();clearTimeout(this.lastPingReceivedTimeout);clearTimeout(this.lastSelfPingReceivedTimeout);clearInterval(this.pingUsersInterval);clearInterval(this.pingBackendInterval);window.removeEventListener("unload",this.__onWindowUnloadHandler);this.superclass.destroy.apply(this,arguments)};BX.Call.VoximplantCall.Signaling=function(e){this.call=e.call};BX.Call.VoximplantCall.Signaling.prototype.inviteUsers=function(t){return this.__runRestAction(e.invite,t)};BX.Call.VoximplantCall.Signaling.prototype.sendAnswer=function(t){return this.__runRestAction(e.answer,t)};BX.Call.VoximplantCall.Signaling.prototype.sendCancel=function(t){return this.__runRestAction(e.cancel,t)};BX.Call.VoximplantCall.Signaling.prototype.sendHangup=function(i){if(BX.CallEngine.getPullClient().isPublishingEnabled()){this.__sendPullEvent(t.hangup,i);i.retransmit=false;this.__runRestAction(e.hangup,i)}else{i.retransmit=true;this.__runRestAction(e.hangup,i)}};BX.Call.VoximplantCall.Signaling.prototype.sendVoiceStarted=function(e){return this.__sendMessage(i.voiceStarted,e)};BX.Call.VoximplantCall.Signaling.prototype.sendVoiceStopped=function(e){return this.__sendMessage(i.voiceStopped,e)};BX.Call.VoximplantCall.Signaling.prototype.sendMicrophoneState=function(e){return this.__sendMessage(i.microphoneState,{microphoneState:e?"Y":"N"})};BX.Call.VoximplantCall.Signaling.prototype.sendScreenState=function(e){return this.__sendMessage(i.screenState,{screenState:e?"Y":"N"})};BX.Call.VoximplantCall.Signaling.prototype.sendShowUsers=function(e){return this.__sendMessage(i.showUsers,{users:e})};BX.Call.VoximplantCall.Signaling.prototype.sendShowAll=function(){return this.__sendMessage(i.showAll,{})};BX.Call.VoximplantCall.Signaling.prototype.sendHideAll=function(){return this.__sendMessage(i.hideAll,{})};BX.Call.VoximplantCall.Signaling.prototype.sendPingToUsers=function(e){if(BX.CallEngine.getPullClient().isPublishingEnabled()){this.__sendPullEvent(t.ping,e,0)}};BX.Call.VoximplantCall.Signaling.prototype.sendPingToBackend=function(){this.__runRestAction(e.ping,{retransmit:false})};BX.Call.VoximplantCall.Signaling.prototype.sendUserInviteTimeout=function(e){if(BX.CallEngine.getPullClient().isPublishingEnabled()){this.__sendPullEvent(t.userInviteTimeout,e,0)}};BX.Call.VoximplantCall.Signaling.prototype.__sendPullEvent=function(e,t,i){i=i||5;if(!t.userId){throw new Error("userId is not found in data")}if(!BX.type.isArray(t.userId)){t.userId=[t.userId]}if(t.userId.length===0){return}t.callInstanceId=this.call.instanceId;t.senderId=this.call.userId;t.callId=this.call.id;t.requestId=BX.Call.Engine.getInstance().getUuidv4();this.call.log("Sending p2p signaling event "+e+"; "+JSON.stringify(t));BX.CallEngine.getPullClient().sendMessage(t.userId,"im",e,t,i)};BX.Call.VoximplantCall.Signaling.prototype.__sendMessage=function(e,t){if(!this.call.voximplantCall){return}if(!BX.type.isPlainObject(t)){t={}}t.eventName=e;t.requestId=BX.Call.Engine.getInstance().getUuidv4();this.call.voximplantCall.sendMessage(JSON.stringify(t))};BX.Call.VoximplantCall.Signaling.prototype.__runRestAction=function(e,t){if(!BX.type.isPlainObject(t)){t={}}t.callId=this.call.id;t.callInstanceId=this.call.instanceId;t.requestId=BX.Call.Engine.getInstance().getUuidv4();return BX.CallEngine.getRestClient().callMethod(e,t)};BX.Call.VoximplantCall.Peer=function(e){this.userId=e.userId;this.call=e.call;this.ready=!!e.ready;this.calling=false;this.declined=false;this.busy=false;this.inviteTimeout=false;this.endpoint=null;this.stream=null;this.isIncomingVideoAllowed=e.isIncomingVideoAllowed!==false;this.tracks={audio:null,video:null,sharing:null};this.callingTimeout=0;this.connectionRestoreTimeout=0;this.callbacks={onStateChanged:BX.type.isFunction(e.onStateChanged)?e.onStateChanged:BX.DoNothing,onInviteTimeout:BX.type.isFunction(e.onInviteTimeout)?e.onInviteTimeout:BX.DoNothing,onStreamReceived:BX.type.isFunction(e.onStreamReceived)?e.onStreamReceived:BX.DoNothing,onStreamRemoved:BX.type.isFunction(e.onStreamRemoved)?e.onStreamRemoved:BX.DoNothing};this.__onEndpointRemoteMediaAddedHandler=this.__onEndpointRemoteMediaAdded.bind(this);this.__onEndpointRemoteMediaRemovedHandler=this.__onEndpointRemoteMediaRemoved.bind(this);this.__onEndpointRemovedHandler=this.__onEndpointRemoved.bind(this);this.calculatedState=this.calculateState()};BX.Call.VoximplantCall.Peer.prototype={setReady:function(e){e=!!e;if(this.ready==e){return}this.ready=e;if(this.calling){clearTimeout(this.callingTimeout);this.calling=false;this.inviteTimeout=false}if(this.ready){this.declined=false;this.busy=false}else{clearTimeout(this.connectionRestoreTimeout)}this.updateCalculatedState()},setDeclined:function(e){this.declined=e;if(this.calling){clearTimeout(this.callingTimeout);this.calling=false}if(this.declined){this.ready=false;this.busy=false}clearTimeout(this.connectionRestoreTimeout);this.updateCalculatedState()},setBusy:function(e){this.busy=e;if(this.calling){clearTimeout(this.callingTimeout);this.calling=false}if(this.busy){this.ready=false;this.declined=false}clearTimeout(this.connectionRestoreTimeout);this.updateCalculatedState()},setEndpoint:function(e){this.log("Adding endpoint with "+e.mediaRenderers.length+" media renderers");this.setReady(true);this.inviteTimeout=false;this.declined=false;clearTimeout(this.connectionRestoreTimeout);if(this.endpoint){this.removeEndpointEventHandlers();this.endpoint=null}this.endpoint=e;for(var t=0;t<this.endpoint.mediaRenderers.length;t++){this.addMediaRenderer(this.endpoint.mediaRenderers[t]);if(this.endpoint.mediaRenderers[t].element){BX.remove(this.endpoint.mediaRenderers[t].element)}}this.bindEndpointEventHandlers()},allowIncomingVideo:function(e){if(this.isIncomingVideoAllowed==e){return}this.isIncomingVideoAllowed=!!e;if(this.tracks.video){this.updateMediaStream()}},addMediaRenderer:function(e){this.log("Adding media renderer");if(!this.stream){this.stream=new MediaStream}e.stream.getTracks().forEach(function(t){if(t.kind=="audio"){this.tracks.audio=t}else if(t.kind=="video"){if(e.kind=="sharing"){this.tracks.sharing=t}else{this.tracks.video=t}}else{this.log("Unknown track kind "+t.kind)}},this);this.updateMediaStream();this.updateCalculatedState()},updateMediaStream:function(){if(!this.stream){this.stream=new MediaStream}this.stream.getTracks().forEach(function(e){if(!this.hasTrack(e)){this.stream.removeTrack(e)}},this);if(this.tracks.audio&&!this.stream.getTrackById(this.tracks.audio.id)){this.stream.addTrack(this.tracks.audio)}if(this.tracks.sharing){if(this.tracks.video&&this.stream.getTrackById(this.tracks.video.id)){this.stream.removeTrack(this.tracks.video)}if(!this.stream.getTrackById(this.tracks.sharing.id)){this.stream.addTrack(this.tracks.sharing)}}else{if(this.tracks.video&&!this.stream.getTrackById(this.tracks.video.id)&&this.isIncomingVideoAllowed){this.stream.addTrack(this.tracks.video)}}this.callbacks.onStreamReceived({userId:this.userId,stream:this.stream})},hasTrack:function(e){for(var t in this.tracks){if(!this.tracks.hasOwnProperty(t)){continue}if(this.tracks.kind&&this.tracks.kind.id==e.id){return true}}return false},removeTrack:function(e){for(var t in this.tracks){if(!this.tracks.hasOwnProperty(t)){continue}var i=this.tracks[t]?this.tracks[t].id:"";if(i==e.id){this.tracks[t]=null}}},bindEndpointEventHandlers:function(){this.endpoint.addEventListener(VoxImplant.EndpointEvents.RemoteMediaAdded,this.__onEndpointRemoteMediaAddedHandler);this.endpoint.addEventListener(VoxImplant.EndpointEvents.RemoteMediaRemoved,this.__onEndpointRemoteMediaRemovedHandler);this.endpoint.addEventListener(VoxImplant.EndpointEvents.Removed,this.__onEndpointRemovedHandler)},removeEndpointEventHandlers:function(){this.endpoint.removeEventListener(VoxImplant.EndpointEvents.RemoteMediaAdded,this.__onEndpointRemoteMediaAddedHandler);this.endpoint.removeEventListener(VoxImplant.EndpointEvents.RemoteMediaRemoved,this.__onEndpointRemoteMediaRemovedHandler);this.endpoint.removeEventListener(VoxImplant.EndpointEvents.Removed,this.__onEndpointRemovedHandler)},calculateState:function(){if(this.stream)return BX.Call.UserState.Connected;if(this.endpoint)return BX.Call.UserState.Connecting;if(this.calling)return BX.Call.UserState.Calling;if(this.inviteTimeout)return BX.Call.UserState.Unavailable;if(this.declined)return BX.Call.UserState.Declined;if(this.busy)return BX.Call.UserState.Busy;if(this.ready)return BX.Call.UserState.Ready;return BX.Call.UserState.Idle},updateCalculatedState:function(){var e=this.calculateState();if(this.calculatedState!=e){this.callbacks.onStateChanged({userId:this.userId,state:e,previousState:this.calculatedState});this.calculatedState=e}},isParticipating:function(){return(this.calling||this.ready||this.endpoint)&&!this.declined},waitForConnectionRestore:function(){clearTimeout(this.connectionRestoreTimeout);this.connectionRestoreTimeout=setTimeout(this.onConnectionRestoreTimeout.bind(this),o)},onInvited:function(){this.ready=false;this.inviteTimeout=false;this.declined=false;this.calling=true;clearTimeout(this.connectionRestoreTimeout);if(this.callingTimeout){clearTimeout(this.callingTimeout)}this.callingTimeout=setTimeout(function(){this.onInviteTimeout(true)}.bind(this),3e4);this.updateCalculatedState()},onInviteTimeout:function(e){clearTimeout(this.callingTimeout);if(!this.calling){return}this.calling=false;this.inviteTimeout=true;if(e){this.callbacks.onInviteTimeout({userId:this.userId})}this.updateCalculatedState()},onConnectionRestoreTimeout:function(){if(this.endpoint||!this.ready){return}this.log("Done waiting for connection restoration");this.setReady(false)},__onEndpointRemoteMediaAdded:function(e){this.log("VoxImplant.EndpointEvents.RemoteMediaAdded",e);if(e.mediaRenderer.element){e.mediaRenderer.element.volume=0;e.mediaRenderer.element.srcObject=null}this.addMediaRenderer(e.mediaRenderer)},__onEndpointRemoteMediaRemoved:function(e){this.log("VoxImplant.EndpointEvents.RemoteMediaRemoved, track id: "+e.mediaRenderer.stream.getTracks()[0].id,e);e.mediaRenderer.stream.getTracks().forEach(function(e){this.removeTrack(e)},this);if(this.stream){this.updateMediaStream()}this.updateCalculatedState()},__onEndpointRemoved:function(e){this.log("VoxImplant.EndpointEvents.Removed",e);if(this.endpoint){this.removeEndpointEventHandlers();this.endpoint=null}if(this.stream){this.stream=null}for(var t in this.tracks){if(this.tracks.hasOwnProperty(t)){this.tracks[t]=null}}if(this.ready){this.waitForConnectionRestore()}this.updateCalculatedState()},log:function(){this.call.log.apply(this.call,arguments)},destroy:function(){if(this.stream){this.stream.getTracks().forEach(function(e){e.stop()});this.stream=null}if(this.endpoint){this.removeEndpointEventHandlers();this.endpoint=null}for(var e in this.tracks){if(this.tracks.hasOwnProperty(e)){if(this.tracks[e]&&this.tracks[e].stop){this.tracks[e].stop()}this.tracks[e]=null}}this.callbacks["onStateChanged"]=BX.DoNothing;this.callbacks["onStreamReceived"]=BX.DoNothing;this.callbacks["onStreamRemoved"]=BX.DoNothing;clearTimeout(this.callingTimeout);clearTimeout(this.connectionRestoreTimeout);this.callingTimeout=null;this.connectionRestoreTimeout=null}};BX.Call.VoximplantCall.Event=n})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:45:"/bitrix/js/im/call/util.min.js?15995682966289";s:6:"source";s:26:"/bitrix/js/im/call/util.js";s:3:"min";s:30:"/bitrix/js/im/call/util.min.js";s:3:"map";s:30:"/bitrix/js/im/call/util.map.js";}"*/
(function(){BX.namespace("BX.Call");if(BX.Call.Util){return}var e="/bitrix/js/im/images/blank.gif";BX.Call.Util={userData:{},usersInProcess:{},updateUserData:function(e,r){var t=[];var a=this;for(var n=0;n<r.length;n++){if(this.userData.hasOwnProperty(r[n])){continue}t.push(r[n])}var s=new Promise(function(n,s){if(t.length===0){return n()}BX.CallEngine.getRestClient().callMethod("im.call.getUsers",{callId:e,userIds:t}).then(function(e){var t=BX.type.isPlainObject(e.answer.result)?e.answer.result:{};r.forEach(function(e){if(t[e]){a.userData[e]=t[e]}delete a.usersInProcess[e]});n()}).catch(function(e){s(e.answer)})});for(var n=0;n<t.length;n++){this.usersInProcess[t[n]]=s}return s},setUserData:function(e){for(var r in e){this.userData[r]=e[r]}},getDateForLog:function(){var e=new Date;return e.getFullYear()+"-"+this.lpad(e.getMonth(),2,"0")+"-"+this.lpad(e.getDate(),2,"0")+" "+this.lpad(e.getHours(),2,"0")+":"+this.lpad(e.getMinutes(),2,"0")+":"+this.lpad(e.getSeconds(),2,"0")+"."+e.getMilliseconds()},getTimeForLog:function(){var e=new Date;return this.lpad(e.getHours(),2,"0")+":"+this.lpad(e.getMinutes(),2,"0")+":"+this.lpad(e.getSeconds(),2,"0")+"."+e.getMilliseconds()},lpad:function(e,r,t){e=e.toString();t=t||" ";if(e.length>r){return e}var a="";for(var n=0;n<r-e.length;n++){a+=t}return a+e},getUser:function(e,r){var t=this;return new Promise(function(a,n){if(t.userData.hasOwnProperty(r)){return a(t.userData[r])}else if(t.usersInProcess.hasOwnProperty(r)){t.usersInProcess[r].then(function(){return a(t.userData[r])})}else{t.updateUserData(e,[r]).then(function(){return a(t.userData[r])})}})},getUsers:function(e,r){var t=this;return new Promise(function(a,n){t.updateUserData(e,r).then(function(){var e={};r.forEach(function(r){e[r]=t.userData[r]||{}});return a(e)})})},getUserName:function(e,r){var t=this;return new Promise(function(a,n){if(t.userData.hasOwnProperty(r)){return a(t.userData[r].name?t.userData[r].name:"")}else if(t.usersInProcess.hasOwnProperty(r)){t.usersInProcess[r].then(function(){return a(t.userData[r].name?t.userData[r].name:"")})}else{t.updateUserData(e,[r]).then(function(){return a(t.userData[r].name?t.userData[r].name:"")})}})},getUserAvatar:function(e,r){var a=this;return new Promise(function(n,s){if(a.userData.hasOwnProperty(r)){return n(a.userData[r].avatar_hr&&!t(a.userData[r].avatar_hr)?a.userData[r].avatar_hr:"")}else if(a.usersInProcess.hasOwnProperty(r)){a.usersInProcess[r].then(function(){return n(a.userData[r].avatar_hr&&!t(a.userData[r].avatar_hr)?a.userData[r].avatar_hr:"")})}else{a.updateUserData(e,[r]).then(function(){return n(a.userData[r].avatar_hr&&!t(a.userData[r].avatar_hr)?a.userData[r].avatar_hr:"")})}})},getUserAvatars:function(e,r){var a=this;return new Promise(function(n,s){a.updateUserData(e,r).then(function(){var e={};r.forEach(function(r){e[r]=a.userData[r].avatar_hr&&!t(a.userData[r].avatar_hr)?a.userData[r].avatar_hr:""});return n(e)})})},isAvatarBlank:function(e){var r=t(e);return r},getCustomMessage:function(e,r){var t;if(!BX.type.isPlainObject(r)){r={}}if(r.gender&&BX.message.hasOwnProperty(e+"_"+r.gender)){t=BX.message(e+"_"+r.gender)}else{t=BX.message(e)}r=this.convertKeysToUpper(r);return t.replace(/#.+?#/gm,function(e){var t=e.substr(1,e.length-2);return r.hasOwnProperty(t)?r[t]:e})},convertKeysToUpper:function(e){var r=BX.util.objectClone(e);for(var t in r){var a=t.toUpperCase();if(a!=t){r[a]=r[t];delete r[t]}}return r},appendChildren:function(e,r){r.forEach(function(r){e.appendChild(r)})},containsVideoTrack:function(e){if(!(e instanceof MediaStream))return false;return e.getVideoTracks().length>0},hasHdVideo:function(e){if(!(e instanceof MediaStream)||e.getVideoTracks().length===0)return false;var r=e.getVideoTracks()[0];var t=r.getSettings();return t.width>=1280},findBestElementSize:function(e,r,t){var a=0;for(var n=1;n<=t;n++){var s=this.getFilledArea(e,r,t,n);if(s.area>a){a=s.area;var i=s.elementWidth;var u=s.elementHeight}if(s.area<a){break}}return{width:i,height:u}},getFilledArea:function(e,r,t,a){var n=Math.ceil(t/a);var s=e/n;var i=r/a;var u=i/s;var o=9/16;var l;var c;if(u<o){l=i;c=s*(u/o)}else{c=s;l=i*(o/u)}var f=c*l*t;return{area:f,elementWidth:c,elementHeight:l}},isWebRTCSupported:function(){return typeof webkitRTCPeerConnection!="undefined"||typeof mozRTCPeerConnection!="undefined"||typeof RTCPeerConnection!="undefined"},isCallServerAllowed:function(){return BX.message("call_server_enabled")==="Y"},getUserLimit:function(){if(this.isCallServerAllowed()){return parseInt(BX.message("call_server_max_users"))}return parseInt(BX.message("turn_server_max_users"))},getMaxBitrate:function(e){switch(e){case BX.Call.Quality.VeryHigh:return 0;case BX.Call.Quality.High:return 1e3;case BX.Call.Quality.Medium:return 500;case BX.Call.Quality.Low:return 250;case BX.Call.Quality.VeryLow:return 100}},getMaxResolution:function(e,r){switch(e){case BX.Call.Quality.VeryHigh:return r?{width:1280,height:720}:{width:640,height:360};case BX.Call.Quality.High:return{width:640,height:360};case BX.Call.Quality.Medium:return{width:320,height:180};case BX.Call.Quality.Low:return{width:320,height:180};case BX.Call.Quality.VeryLow:return{width:320,height:180}}},getLogMessage:function(){var e=BX.Call.Util.getDateForLog();for(var r=0;r<arguments.length;r++){if(arguments[r]instanceof Error){e=arguments[r].message+"\n"+arguments[r].stack}else{try{e=e+" | "+(typeof arguments[r]=="object"?JSON.stringify(arguments[r]):arguments[r])}catch(r){e=e+" | (circular structure)"}}}return e},alterSDP:function(e,t){if(!t){return}var a=e.split("\n");var n=[];var s=false;for(var i=0;i<a.length;i++){var u=a[i];s=s||(u.match(/m=video/)!==null?i:false);if(!s){continue}var o=/a=rtpmap:(\d+)\s(.+)/.exec(u);if(o){n.push({rtpmap:o[1],codec:o[2]})}}if(!s){return}a[s]=r(a[s],n,t);return a.join("\n")}};function r(e,r,t){debugger;var a=e.split(" ");var n=a.slice(3);var s={};r.forEach(function(e){s[e.rtpmap]=e.codec});n.sort(function(e,r){e=e.trim();r=r.trim();var t=s[e];var a=s[r];if(t.substr(0,4)==="H264"&&a.substr(0,4)!=="H264"){return-1}else if(t.substr(0,4)!=="H264"&&a.substr(0,4)==="H264"){return 1}else{return e-r}});var i=a.slice(0,3).concat(n);return i.join(" ")}function t(r){return typeof r!=="string"||r==""||r.endsWith(e)}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:46:"/bitrix/js/im/call/view.min.js?159956829650925";s:6:"source";s:26:"/bitrix/js/im/call/view.js";s:3:"min";s:30:"/bitrix/js/im/call/view.min.js";s:3:"map";s:30:"/bitrix/js/im/call/view.map.js";}"*/
(function(){BX.namespace("BX.Call");if(BX.Call.View){return}var e={Grid:1,Centered:2};var t={Preparing:1,Initializing:2,Calling:3,Connected:4,Error:5};var s={onClose:"onClose",onDestroy:"onDestroy",onButtonClick:"onButtonClick",onBodyClick:"onBodyClick",onReplaceCamera:"onReplaceCamera",onReplaceMicrophone:"onReplaceMicrophone",onReplaceSpeaker:"onReplaceSpeaker",onSetCentralUser:"onSetCentralUser",onLayoutChange:"onLayoutChange"};var i=1e3;var r=1001;BX.Call.View=function(s){this.title=s.title;this.container=s.container;this.cameraId=s.cameraId;this.microphoneId=s.microphoneId;this.speakerId=BX.Call.Hardware.defaultSpeaker;this.speakerMuted=false;this.showChatButtons=s.showChatButtons===true;this.showShareButton=s.showShareButton===true;this.showButtonPanel=s.showButtonPanel!==false;this.language=s.language||"";this.lastPosition=1;this.userData={};if(s.userData){this.updateUserData(s.userData)}this.userLimit=s.userLimit||1;this.userId=BX.message("USER_ID");this.localUser=new a({id:this.userId,state:BX.Call.UserState.Connected,localUser:true,order:i,name:this.userData[this.userId]?this.userData[this.userId].name:"",avatar:this.userData[this.userId]?this.userData[this.userId].avatar_hr:""});this.mediaSelectionBlocked=false;this.visible=false;this.elements={root:null,watermark:null,container:null,overlay:null,panel:null,audioContainer:null,audio:{},center:null,userBlock:null,ear:{left:null,right:null},userList:{container:null,addButton:null}};this.buttons={title:null,grid:null,add:null,share:null,microphone:null,camera:null,speaker:null,screen:null,chat:null,history:null,hangup:null,fullscreen:null,overlay:null,status:null};this.size=BX.Call.View.Size.Full;this.isMuted=false;this.isCameraOn=false;this.isFullScreen=false;this.disabledButtons={};this.uiState=s.uiState||t.Calling;this.layout=s.layout||e.Centered;this.users={};if(BX.type.isPlainObject(s.userStates)){this.appendUsers(s.userStates)}this.eventEmitter=new BX.Event.EventEmitter(this,"BX.Call.View");this.scrollInterval=0;this._onFullScreenChangeHandler=this._onFullScreenChange.bind(this);this._onResizeHandler=this._onResize.bind(this);this.resizeObserver=new BX.ResizeObserver(this._onResizeHandler);this.switchPresenterTimeout=0;this.init();this.subscribeEvents(s)};BX.Call.View.prototype.init=function(){if(this.isFullScreenSupported()){if(BX.browser.IsChrome()||BX.browser.IsSafari()){window.addEventListener("webkitfullscreenchange",this._onFullScreenChangeHandler)}else if(BX.browser.IsFirefox()){window.addEventListener("mozfullscreenchange",this._onFullScreenChangeHandler)}}this.elements.audioContainer=BX.create("div",{props:{className:"bx-messenger-videocall-audio-container"}});this.container.appendChild(this.elements.audioContainer)};BX.Call.View.prototype.subscribeEvents=function(e){for(var t in s){if(s.hasOwnProperty(t)&&BX.type.isFunction(e[t])){this.setCallback(t,e[t])}}};BX.Call.View.prototype.setCallback=function(e,t){if(BX.type.isFunction(t)&&s.hasOwnProperty(e)){this.eventEmitter.subscribe(e,function(e){t(e.data)})}};BX.Call.View.prototype.subscribe=function(e,t){return this.eventEmitter.subscribe(e,t)};BX.Call.View.prototype.unsubscribe=function(e,t){return this.eventEmitter.unsubscribe(e,t)};BX.Call.View.prototype.getNextPosition=function(){return this.lastPosition++};BX.Call.View.prototype.appendUsers=function(e){if(!BX.type.isPlainObject(e)){return}var t=Object.keys(e);for(var s=0;s<t.length;s++){var i=t[s];this.users[i]=new a({id:i,state:e[i]?e[i]:BX.Call.UserState.Idle,order:this.getNextPosition(),onClick:this._onUserClick.bind(this),name:this.userData[i]?this.userData[i].name:"",avatar:this.userData[i]?this.userData[i].avatar_hr:""})}};BX.Call.View.prototype.setCentralUser=function(t){if(this.centralUser.userId==t){return}if(t==this.userId&&this.getUsersWithVideo().length>0){return}if(!this.users[t]&&t!=this.userId){return}this.centralUser.setUserId(t,this.userData[t]||{});if(this.layout==e.Centered){this.updateUserList()}this.eventEmitter.emit(s.onSetCentralUser,{userId:t,stream:t==this.userId?this.localUser.stream:this.users[t].stream})};BX.Call.View.prototype.getUserCount=function(){return Object.keys(this.users).length};BX.Call.View.prototype.getConnectedUserCount=function(){return this.getConnectedUsers().length};BX.Call.View.prototype.getUsersWithVideo=function(){var e=[];for(var t in this.users){if(this.users[t].hasVideo()){e.push(t)}}return e};BX.Call.View.prototype.getConnectedUsers=function(){var e=[];for(var t in this.users){if(this.users[t].state==BX.Call.UserState.Connected){e.push(t)}}return e};BX.Call.View.prototype.getPresenterUserId=function(){var e=this.layout===BX.Call.View.Layout.Centered?parseInt(this.centralUser.userId,10):0;var t;if(e&&this.users[e].screenState===true){return e}for(t in this.users){if(this.users.hasOwnProperty(t)&&this.users[t].screenState===true){return parseInt(t,10)}}if(e&&this.users[e].wasTalkingAgo()<1e3){return e}for(t in this.users){if(this.users.hasOwnProperty(t)&&this.users[t].wasTalkingAgo()<1e3){return parseInt(t,10)}}var s=0;var i=0;for(t in this.users){if(this.users.hasOwnProperty(t)&&this.users[t].talkingStop>s){s=this.users[t].talkingStop;i=parseInt(t,10)}}return i};BX.Call.View.prototype.switchPresenter=function(){var e=this.getPresenterUserId();if(!e||e==this.centralUser.userId){return}this.setCentralUser(e)};BX.Call.View.prototype.switchPresenterDeferred=function(){clearTimeout(this.switchPresenterTimeout);this.switchPresenterTimeout=setTimeout(this.switchPresenter.bind(this),1e3)};BX.Call.View.prototype.cancelSwitchPresenter=function(){clearTimeout(this.switchPresenterTimeout)};BX.Call.View.prototype.setUiState=function(e){if(this.uiState==e){return}this.uiState=e;if(this.uiState==t.Error&&this.elements.container){this.elements.container.textContent=""}if(this.elements.root){this.updateButtons()}};BX.Call.View.prototype.setLayout=function(t){if(t==this.layout){return}this.layout=t;if(this.layout==e.Centered){this.elements.root.classList.remove("bx-messenger-videocall-grid");this.elements.root.classList.add("bx-messenger-videocall-centered");this.elements.userBlock.appendChild(this.elements.userList.container);this.elements.container.appendChild(this.elements.center);this.elements.container.appendChild(this.elements.userBlock);this.switchPresenter();this.centralUser.playVideo();this.centralUser.updateAvatarWidth()}else if(this.layout==e.Grid){this.elements.root.classList.remove("bx-messenger-videocall-centered");this.elements.root.classList.add("bx-messenger-videocall-grid");this.elements.container.removeChild(this.elements.center);this.elements.container.removeChild(this.elements.userBlock);this.elements.container.appendChild(this.elements.userList.container)}this.renderUserList();this.toggleEars();this.eventEmitter.emit(s.onLayoutChange,{layout:this.layout})};BX.Call.View.prototype.setCameraState=function(e){e=!!e;if(this.isCameraOn==e){return}this.isCameraOn=e;if(this.buttons.camera){if(this.isCameraOn){this.buttons.camera.enable()}else{this.buttons.camera.disable()}}};BX.Call.View.prototype.setMuted=function(e){e=!!e;if(this.isMuted==e){return}this.isMuted=e;if(this.buttons.microphone){if(this.isMuted){this.buttons.microphone.disable()}else{this.buttons.microphone.enable()}}this.localUser.setMicrophoneState(!e)};BX.Call.View.prototype.addUser=function(e,t){if(this.users[e]){return}this.users[e]=new a({id:e,state:t||BX.Call.UserState.Idle,order:this.getNextPosition(),onClick:this._onUserClick.bind(this),name:this.userData[e]?this.userData[e].name:"",avatar:this.userData[e]?this.userData[e].avatar_hr:""});this.updateUserList();this.updateButtons()};BX.Call.View.prototype.setUserState=function(e,t){var s=this.users[e];if(!s){return}s.setState(t);if(this.centralUser.userId==this.userId&&t==BX.Call.UserState.Connected){this.setCentralUser(e)}else if(e==this.centralUser.userId){if(t==BX.Call.UserState.Connecting||t==BX.Call.UserState.Failed){this.centralUser.blurVideo()}else if(t==BX.Call.UserState.Connected){this.centralUser.blurVideo(false)}else if(t==BX.Call.UserState.Idle){var i=this.getUsersWithVideo();var r=this.getConnectedUsers();if(i.length>0){this.setCentralUser(i[0])}else if(r.length>0){this.setCentralUser(r[0])}else{this.centralUser.blurVideo()}}}this.updateUserList();this.updateButtons()};BX.Call.View.prototype.setTitle=function(e){this.title=e};BX.Call.View.prototype.setUserTalking=function(e,t){var s=this.users[e];if(!s){return}s.setTalking(t);if(this.centralUser.userId==e&&!t){this.switchPresenterDeferred()}else{this.switchPresenter()}};BX.Call.View.prototype.setUserMicrophoneState=function(e,t){var s=this.users[e];if(!s){return}s.setMicrophoneState(t)};BX.Call.View.prototype.setUserScreenState=function(e,t){var s=this.users[e];if(!s){return}s.setScreenState(t);if(t===true&&this.layout===BX.Call.View.Layout.Grid){this.setLayout(BX.Call.View.Layout.Centered)}this.switchPresenter()};BX.Call.View.prototype.setLocalStream=function(t,s){this.localUser.stream=t;this.localUser.flipVideo=!!s;this.setCameraState(this.localUser.hasVideo());var i=t.getVideoTracks();if(i.length>0){var r=i[0].getSettings();this.cameraId=r.deviceId||""}else{this.cameraId=""}var n=t.getAudioTracks();if(n.length>0){var a=n[0].getSettings();this.microphoneId=a.deviceId||""}if(this.layout==e.Centered&&this.centralUser.userId==this.userId){if(this.localUser.hasVideo()||Object.keys(this.users).length===0){this.centralUser.setStream(t)}else{this.setCentralUser(Object.keys(this.users)[0])}}else{this.updateUserList()}};BX.Call.View.prototype.setSpeakerId=function(e){if(!("setSinkId"in HTMLMediaElement.prototype)){console.error("Speaker selection is not supported")}this.speakerId=e;for(var t in this.elements.audio){this.elements.audio[t].setSinkId(this.speakerId)}};BX.Call.View.prototype.muteSpeaker=function(e){this.speakerMuted=!!e;for(var t in this.elements.audio){this.elements.audio[t].volume=this.speakerMuted?0:1}if(this.speakerMuted){this.buttons.speaker.disable();this.buttons.speaker.hideArrow()}else{this.buttons.speaker.enable();if(BX.Call.Hardware.canSelectSpeaker()){this.buttons.speaker.showArrow()}}};BX.Call.View.prototype.setStream=function(e,s){if(this.uiState==t.Calling){this.setUiState(t.Connected)}if(!this.users[e]){throw Error("User "+e+" is not a part of this call")}if(!this.elements.audio[e]){this.elements.audio[e]=BX.create("audio");this.elements.audioContainer.appendChild(this.elements.audio[e])}this.elements.audio[e].volume=this.speakerMuted?0:1;if(s.getAudioTracks().length>0&&s!=this.elements.audio[e].srcObject){if(this.speakerId&&this.elements.audio[e].setSinkId){this.elements.audio[e].setSinkId(this.speakerId).then(function(){this.elements.audio[e].srcObject=s;this.elements.audio[e].play().catch(BX.DoNothing)}.bind(this)).catch(console.error)}else{this.elements.audio[e].srcObject=s;this.elements.audio[e].play().catch(BX.DoNothing)}}this.users[e].stream=s;if(this.users[e].hasVideo()){if(this.centralUser.userId==this.userId){this.setCentralUser(e)}}else{if(this.centralUser.userId==e){var i=this.getUsersWithVideo();if(i.length>0){this.setCentralUser(i[0])}}}if(this.centralUser.userId==e){this.centralUser.setStream(s)}this.updateUserList()};BX.Call.View.prototype.show=function(){if(!this.elements.root){this.render()}this.container.appendChild(this.elements.root);this.updateButtons();this.updateUserList();this.resumeVideo();this.toggleEars();this.visible=true};BX.Call.View.prototype.hide=function(){BX.remove(this.elements.root);this.visible=false};BX.Call.View.prototype.showMessage=function(e){if(!this.elements.root){this.render();this.container.appendChild(this.elements.root)}var t=BX.create("div",{props:{className:"bx-messenger-videocall-user-status bx-messenger-videocall-user-status-wide"}});if(BX.type.isNotEmptyString(e.text)){var s=BX.create("div",{props:{className:"bx-messenger-videocall-status-text"},text:e.text});t.appendChild(s)}if(this.elements.overlay.childElementCount){BX.cleanNode(this.elements.overlay)}this.elements.overlay.appendChild(t)};BX.Call.View.prototype.hideMessage=function(){this.elements.overlay.textContent=""};BX.Call.View.prototype.showFatalError=function(e){this.showMessage(e);this.setUiState(t.Error)};BX.Call.View.prototype.close=function(){BX.cleanNode(this.container);this.visible=false;this.eventEmitter.emit(s.onClose)};BX.Call.View.prototype.setSize=function(e){if(this.size==e){return}this.size=e;if(this.size==BX.Call.View.Size.Folded){if(this.elements.panel){this.elements.panel.classList.add("bx-messenger-videocall-panel-folded")}BX.remove(this.elements.container);BX.remove(this.elements.watermark);this.updateButtons()}else{if(this.elements.panel){this.elements.panel.classList.remove("bx-messenger-videocall-panel-folded")}this.elements.wrap.appendChild(this.elements.watermark);this.elements.wrap.appendChild(this.elements.container);this.updateButtons();this.updateUserList();this.resumeVideo()}};BX.Call.View.prototype.toggleFullScreen=function(){if(this.isFullScreen){this.exitFullScreen()}else{this.enterFullScreen()}};BX.Call.View.prototype.isButtonDisabled=function(e){return this.disabledButtons.hasOwnProperty(e)};BX.Call.View.prototype.disableAddUser=function(){this.disabledButtons["add"]=true;if(this.elements.userList.addButton){BX.remove(this.elements.userList.addButton);this.elements.userList.addButton=null}};BX.Call.View.prototype.disableSwitchCamera=function(){this.disabledButtons["camera"]=true};BX.Call.View.prototype.enableSwitchCamera=function(){delete this.disabledButtons["camera"]};BX.Call.View.prototype.disableScreenSharing=function(){this.disabledButtons["screen"]=true};BX.Call.View.prototype.disableHistoryButton=function(){this.disabledButtons["history"]=true};BX.Call.View.prototype.disableMediaSelection=function(){this.mediaSelectionBlocked=true};BX.Call.View.prototype.isMediaSelectionAllowed=function(){return(this.uiState==t.Preparing||this.uiState==t.Connected)&&!this.mediaSelectionBlocked&&!this.isFullScreen};BX.Call.View.prototype.getButtonList=function(){if(this.uiState==t.Error){return["close"]}if(this.uiState==t.Initializing){return["hangup"]}if(this.size==BX.Call.View.Size.Folded){return["title","hangup","fullscreen"]}var e=[];if(this.uiState===t.Connected){e.push("grid")}if(this.getConnectedUserCount()<this.userLimit-1&&!this.isFullScreen&&this.uiState===t.Connected){e.push("add")}if(this.showShareButton&&!this.isFullScreen){e.push("share")}e.push("microphone");if(this.uiState===t.Preparing||this.uiState===t.Connected){e.push("camera")}e.push("speaker");if(this.isScreenSharingSupported()&&!this.isFullScreen&&this.uiState===t.Connected){e.push("screen")}if(this.showChatButtons&&!this.isFullScreen){e.push("chat");if(this.uiState!=t.Preparing){e.push("history")}}if(this.uiState==t.Preparing){e.push("close")}else{e.push("hangup")}if(this.uiState!=t.Preparing&&this.isFullScreenSupported()){e.push("fullscreen")}e=e.filter(function(e){return!this.isButtonDisabled(e)},this);return e};BX.Call.View.prototype.getWatermarkUrl=function(e){switch(e){case"ua":return"/bitrix/js/im/images/watermark-white-ua.svg";case"ru":case"kz":case"by":return"/bitrix/js/im/images/watermark-white-ru.svg";default:return"/bitrix/js/im/images/watermark-white-en.svg"}};BX.Call.View.prototype.render=function(){this.elements.root=BX.create("div",{props:{className:"bx-messenger-videocall"},children:[this.elements.wrap=BX.create("div",{props:{className:"bx-messenger-videocall-wrap"},children:[this.elements.watermark=BX.create("div",{props:{className:"bx-messenger-videocall-watermark"},children:[BX.create("img",{props:{className:"bx-messenger-videocall-watermark-img",src:this.getWatermarkUrl(this.language)}})]}),this.elements.container=BX.create("div",{props:{className:"bx-messenger-videocall-inner"}}),this.elements.overlay=BX.create("div",{props:{className:"bx-messenger-videocall-overlay"}})]})],events:{click:this._onBodyClick.bind(this)}});if(this.showButtonPanel){this.elements.panel=BX.create("div",{props:{className:"bx-messenger-videocall-panel"}});this.elements.wrap.appendChild(this.elements.panel)}else{this.elements.root.classList.add("bx-messenger-videocall-no-button-panel")}this.centralUser=new n({parent:this,video:false,stream:false,userId:this.userId,language:this.language});this.elements.center=this.centralUser.render();this.elements.userBlock=BX.create("div",{props:{className:"bx-messenger-videocall-user-block"},children:[this.elements.ear.left=BX.create("div",{props:{className:"bx-messenger-videocall-ear bx-messenger-videocall-ear-left"},events:{mouseenter:this.scrollUserBlockLeft.bind(this),mouseleave:this.stopScroll.bind(this)}}),this.elements.ear.right=BX.create("div",{props:{className:"bx-messenger-videocall-ear bx-messenger-videocall-ear-right"},events:{mouseenter:this.scrollUseBlockRight.bind(this),mouseleave:this.stopScroll.bind(this)}})]});this.elements.userList.container=BX.create("div",{props:{className:"bx-messenger-videocall-user-list"},children:[BX.create("div",{props:{className:"bx-messenger-videocall-user-extra"}})],events:{scroll:this.toggleEars.bind(this)}});this.elements.userList.addButton=BX.create("div",{props:{className:"bx-messenger-videocall-user-add"},children:[BX.create("div",{props:{className:"bx-messenger-videocall-user-add-inner"}})],style:{order:r},events:{click:this._onAddButtonClick.bind(this)}});if(this.layout==e.Centered){this.elements.container.appendChild(this.elements.center);this.elements.container.appendChild(this.elements.userBlock);this.elements.root.classList.add("bx-messenger-videocall-centered")}else if(this.layout==e.Grid){this.elements.root.classList.add("bx-messenger-videocall-grid")}this.resizeObserver.observe(this.elements.root);return this.elements.root};BX.Call.View.prototype.renderUserList=function(){var s=this.elements.userList.container.getBoundingClientRect();var i=this.localUser.hasVideo()&&(this.layout==e.Grid||this.centralUser.userId!=this.userId);var r=0;for(var n in this.users){var a=this.users[n];if(this.layout==e.Centered&&n==this.centralUser.userId){a.dismount();continue}if(a.state==BX.Call.UserState.Idle||a.state==BX.Call.UserState.Declined||a.state==BX.Call.UserState.Unavailable||a.state==BX.Call.UserState.Busy){a.dismount();continue}a.mount(this.elements.userList.container);r++}if(i){this.localUser.mount(this.elements.userList.container,true);r++}else{this.localUser.dismount()}if(this.layout==e.Grid){var l=BX.Call.Util.findBestElementSize(s.width,s.height,r);this.elements.userList.container.style.setProperty("--grid-user-width",l.width+"px");this.elements.userList.container.style.setProperty("--grid-user-height",l.height+"px")}var o=this.layout==e.Centered&&r>0&&!this.isFullScreen&&this.uiState===t.Connected&&!this.isButtonDisabled("add")&&this.getConnectedUserCount()<this.userLimit-1;if(o&&!this.isFullScreen){this.elements.userList.container.appendChild(this.elements.userList.addButton)}else{BX.remove(this.elements.userList.addButton)}};BX.Call.View.prototype.renderButtons=function(e){var s;var i;var r;var n;s=BX.create("div",{props:{className:"bx-messenger-videocall-panel-inner"},children:[i=BX.create("div",{props:{className:"bx-messenger-videocall-panel-block"}}),r=BX.create("div",{props:{className:"bx-messenger-videocall-panel-block"}}),n=BX.create("div",{props:{className:"bx-messenger-videocall-panel-block"}})]});for(var a=0;a<e.length;a++){switch(e[a]){case"title":this.buttons.title=new l({text:this.title,isGroupCall:Object.keys(this.users).length>1});i.appendChild(this.buttons.title.render());break;case"grid":this.buttons.grid=new o({class:"grid",text:BX.message("IM_M_CALL_BTN_GRID"),onClick:this._onGridButtonClick.bind(this)});i.appendChild(this.buttons.grid.render());break;case"add":this.buttons.add=new o({class:"add",text:BX.message("IM_M_CALL_BTN_ADD"),onClick:this._onAddButtonClick.bind(this)});i.appendChild(this.buttons.add.render());break;case"share":this.buttons.share=new o({class:"share",text:BX.message("IM_M_CALL_BTN_LINK"),onClick:this._onShareButtonClick.bind(this)});i.appendChild(this.buttons.share.render());break;case"microphone":this.buttons.microphone=new c({class:"microphone",text:BX.message("IM_M_CALL_BTN_MIC"),enabled:!this.isMuted,arrowEnabled:this.isMediaSelectionAllowed(),onClick:this._onMicrophoneButtonClick.bind(this),onArrowClick:this._onMicrophoneArrowClick.bind(this)});r.appendChild(this.buttons.microphone.render());break;case"camera":this.buttons.camera=new c({class:"camera",text:BX.message("IM_M_CALL_BTN_CAMERA"),enabled:this.isCameraOn,arrowEnabled:this.isMediaSelectionAllowed(),onClick:this._onCameraButtonClick.bind(this),onArrowClick:this._onCameraArrowClick.bind(this)});r.appendChild(this.buttons.camera.render());break;case"speaker":this.buttons.speaker=new c({class:"speaker",text:BX.message("IM_M_CALL_BTN_SPEAKER"),enabled:!this.speakerMuted,arrowEnabled:BX.Call.Hardware.canSelectSpeaker(),onClick:this._onSpeakerButtonClick.bind(this),onArrowClick:this._onSpeakerArrowClick.bind(this)});r.appendChild(this.buttons.speaker.render());break;case"screen":if(!this.buttons.screen){this.buttons.screen=new o({class:"screen",text:BX.message("IM_M_CALL_BTN_SCREEN"),onClick:this._onScreenButtonClick.bind(this)})}r.appendChild(this.buttons.screen.render());break;case"chat":if(!this.buttons.chat){this.buttons.chat=new o({class:"chat",text:BX.message("IM_M_CALL_BTN_CHAT"),onClick:this._onChatButtonClick.bind(this)})}r.appendChild(this.buttons.chat.render());break;case"history":this.buttons.history=new o({class:"history",text:BX.message("IM_M_CALL_BTN_HISTORY"),onClick:this._onHistoryButtonClick.bind(this)});r.appendChild(this.buttons.history.render());break;case"hangup":this.buttons.hangup=new h({text:Object.keys(this.users).length>1?BX.message("IM_M_CALL_BTN_DISCONNECT"):BX.message("IM_M_CALL_BTN_HANGUP"),onClick:this._onHangupButtonClick.bind(this)});if(this.uiState==t.Initializing){r.appendChild(this.buttons.hangup.render())}else{n.appendChild(this.buttons.hangup.render())}break;case"close":this.buttons.close=new h({text:BX.message("IM_M_CALL_BTN_CLOSE"),onClick:this._onCloseButtonClick.bind(this)});if(this.uiState==t.Initializing){r.appendChild(this.buttons.close.render())}else{n.appendChild(this.buttons.close.render())}break;case"fullscreen":this.buttons.fullscreen=new o({class:"resize",text:"",onClick:this._onFullScreenButtonClick.bind(this)});n.appendChild(this.buttons.fullscreen.render());break}}return s};BX.Call.View.prototype.setButtonActive=function(e,t){if(!this.buttons[e]){return}this.buttons[e].setActive(t)};BX.Call.View.prototype.setButtonCounter=function(e,t){if(!this.buttons[e]){return}this.buttons[e].setCounter(t)};BX.Call.View.prototype.updateUserList=function(){this.renderUserList();if(this.layout==e.Centered){if(!this.elements.userList.container.parentElement){this.elements.userBlock.appendChild(this.elements.userList.container)}this.centralUser.setFullSize(this.elements.userList.container.childElementCount===0)}else if(this.layout==e.Grid){if(!this.elements.userList.container.parentElement){this.elements.container.appendChild(this.elements.userList.container)}}this.toggleEars()};BX.Call.View.prototype.resumeVideo=function(){for(var t in this.users){var s=this.users[t];s.playVideo()}this.localUser.playVideo(true);if(this.layout==e.Centered){this.centralUser.playVideo()}};BX.Call.View.prototype.updateButtons=function(){if(!this.elements.panel){return}var e=this.getButtonList();BX.cleanNode(this.elements.panel);this.elements.panel.appendChild(this.renderButtons(e))};BX.Call.View.prototype.updateUserData=function(e){for(var t in e){if(!this.userData[t]){this.userData[t]={name:"",avatar_hr:""}}if(e[t].name){this.userData[t].name=e[t].name}if(e[t].avatar_hr){this.userData[t].avatar_hr=BX.Call.Util.isAvatarBlank(e[t].avatar_hr)?"":e[t].avatar_hr}if(t==this.userId){this.localUser.updateName(this.userData[t].name);this.localUser.updateAvatar(this.userData[t].avatar_hr)}if(t==this.centralUser.userId){this.centralUser.name=this.userData[t].name;this.centralUser.avatar=this.userData[t].avatar_hr;this.centralUser.updateUserInfo()}if(this.users[t]){this.users[t].updateName(this.userData[t].name);this.users[t].updateAvatar(this.userData[t].avatar_hr)}}};BX.Call.View.prototype.isScreenSharingSupported=function(){return navigator.mediaDevices&&typeof navigator.mediaDevices.getDisplayMedia==="function"||typeof BXDesktopSystem!=="undefined"};BX.Call.View.prototype.isFullScreenSupported=function(){if(BX.browser.IsChrome()||BX.browser.IsSafari()){return document.webkitFullscreenEnabled===true}else if(BX.browser.IsFirefox()){return document.fullscreenEnabled===true}else{return false}};BX.Call.View.prototype.enterFullScreen=function(){if(BX.browser.IsChrome()||BX.browser.IsSafari()){this.elements.root.webkitRequestFullScreen()}else if(BX.browser.IsFirefox()){this.elements.root.requestFullscreen()}};BX.Call.View.prototype.exitFullScreen=function(){if(document.cancelFullScreen){document.cancelFullScreen()}else if(document.mozCancelFullScreen){document.mozCancelFullScreen()}else if(document.webkitCancelFullScreen){document.webkitCancelFullScreen()}else if(document.document.exitFullscreen()){document.exitFullscreen()}};BX.Call.View.prototype.toggleEars=function(){this.toggleRightEar();this.toggleLeftEar()};BX.Call.View.prototype.toggleRightEar=function(){if(this.layout==e.Centered&&this.elements.userList.container.scrollWidth>this.elements.userList.container.offsetWidth&&this.elements.userList.container.offsetWidth+this.elements.userList.container.scrollLeft<this.elements.userList.container.scrollWidth){this.elements.ear.right.classList.add("bx-messenger-videocall-ear-show")}else{this.elements.ear.right.classList.remove("bx-messenger-videocall-ear-show")}};BX.Call.View.prototype.toggleLeftEar=function(){if(this.layout==e.Centered&&this.elements.userList.container.scrollLeft>0){this.elements.ear.left.classList.add("bx-messenger-videocall-ear-show")}else{this.elements.ear.left.classList.remove("bx-messenger-videocall-ear-show")}};BX.Call.View.prototype.scrollUserBlockLeft=function(){this.stopScroll();this.scrollInterval=setInterval(function(){this.elements.userList.container.scrollLeft-=10}.bind(this),20)};BX.Call.View.prototype.scrollUseBlockRight=function(){this.stopScroll();this.scrollInterval=setInterval(function(){this.elements.userList.container.scrollLeft+=10}.bind(this),20)};BX.Call.View.prototype.stopScroll=function(){if(this.scrollInterval){clearInterval(this.scrollInterval);this.scrollInterval=0}};BX.Call.View.prototype._onBodyClick=function(e){this.eventEmitter.emit(s.onBodyClick)};BX.Call.View.prototype._onFullScreenChange=function(e){if(BX.browser.IsChrome()||BX.browser.IsSafari()){this.isFullScreen=document.webkitFullscreenElement==this.elements.root}else if(BX.browser.IsFirefox()){this.isFullScreen=document.fullscreenElement==this.elements.root}this.updateUserList();this.updateButtons()};BX.Call.View.prototype._onResize=function(){if(!this.elements.root){return}if(this.centralUser){this.centralUser.updateAvatarWidth()}if(this.layout==e.Grid){this.updateUserList()}else{this.toggleEars()}};BX.Call.View.prototype._onUserClick=function(t){if(this.layout==e.Grid){return}var s=t.userId;if(s==this.userId){return}this.setCentralUser(s)};BX.Call.View.prototype._onGridButtonClick=function(t){this.setLayout(this.layout==e.Centered?e.Grid:e.Centered)};BX.Call.View.prototype._onAddButtonClick=function(e){e.stopPropagation();this.eventEmitter.emit(s.onButtonClick,{buttonName:"inviteUser",node:e.currentTarget})};BX.Call.View.prototype._onShareButtonClick=function(e){e.stopPropagation();this.eventEmitter.emit(s.onButtonClick,{buttonName:"share",node:e.currentTarget})};BX.Call.View.prototype._onMicrophoneButtonClick=function(e){e.stopPropagation();this.eventEmitter.emit(s.onButtonClick,{buttonName:"toggleMute",muted:!this.isMuted})};BX.Call.View.prototype._onMicrophoneArrowClick=function(e){e.stopPropagation();u.create({parentElement:e.currentTarget,deviceList:BX.Call.Hardware.getMicrophoneList(),current:this.microphoneId,onSelect:this._onMicrophoneSelected.bind(this)}).show()};BX.Call.View.prototype._onMicrophoneSelected=function(e){if(e.deviceId===this.microphoneId){return}this.eventEmitter.emit(s.onReplaceMicrophone,e)};BX.Call.View.prototype._onCameraButtonClick=function(e){e.stopPropagation();this.eventEmitter.emit(s.onButtonClick,{buttonName:"toggleVideo",video:!this.isCameraOn})};BX.Call.View.prototype._onCameraArrowClick=function(e){e.stopPropagation();if(!BX.Call.Hardware.hasCamera()){return false}u.create({parentElement:e.currentTarget,deviceList:BX.Call.Hardware.getCameraList(),current:this.cameraId,onSelect:this._onCameraSelected.bind(this)}).show()};BX.Call.View.prototype._onCameraSelected=function(e){if(e.deviceId===this.cameraId){return}this.eventEmitter.emit(s.onReplaceCamera,e)};BX.Call.View.prototype._onSpeakerButtonClick=function(e){this.muteSpeaker(!this.speakerMuted)};BX.Call.View.prototype._onSpeakerArrowClick=function(e){e.stopPropagation();u.create({parentElement:e.currentTarget,deviceList:BX.Call.Hardware.getSpeakerList(),current:this.speakerId,onSelect:this._onSpeakerSelected.bind(this)}).show()};BX.Call.View.prototype._onSpeakerSelected=function(e){this.setSpeakerId(e.deviceId);this.eventEmitter.emit(s.onReplaceSpeaker,e)};BX.Call.View.prototype._onScreenButtonClick=function(e){e.stopPropagation();this.eventEmitter.emit(s.onButtonClick,{buttonName:"toggleScreenSharing",node:e.target})};BX.Call.View.prototype._onChatButtonClick=function(e){e.stopPropagation();this.eventEmitter.emit(s.onButtonClick,{buttonName:"showChat",node:e.target})};BX.Call.View.prototype._onHistoryButtonClick=function(e){e.stopPropagation();this.eventEmitter.emit(s.onButtonClick,{buttonName:"showHistory",node:e.target})};BX.Call.View.prototype._onHangupButtonClick=function(e){e.stopPropagation();this.eventEmitter.emit(s.onButtonClick,{buttonName:"hangup",node:e.target})};BX.Call.View.prototype._onCloseButtonClick=function(e){e.stopPropagation();this.eventEmitter.emit(s.onButtonClick,{buttonName:"close",node:e.target})};BX.Call.View.prototype._onFullScreenButtonClick=function(e){e.stopPropagation();this.eventEmitter.emit(s.onButtonClick,{buttonName:"fullscreen",node:e.target})};BX.Call.View.prototype.releaseLocalMedia=function(){this.localUser.releaseStream();if(this.centralUser.userId==this.userId){this.centralUser.releaseStream()}};BX.Call.View.prototype.destroy=function(){if(this.elements.root){BX.cleanNode(this.elements.root,true);this.elements.root=null}this.visible=false;window.removeEventListener("webkitfullscreenchange",this._onFullScreenChangeHandler);window.removeEventListener("mozfullscreenchange",this._onFullScreenChangeHandler);this.resizeObserver.disconnect();for(var e in this.users){if(this.users.hasOwnProperty(e)){this.users[e].destroy()}}this.userData=null;this.centralUser.destroy();clearTimeout(this.switchPresenterTimeout);this.eventEmitter.emit(s.onDestroy);this.eventEmitter.unsubscribeAll()};var n=function(e){this.parent=e.parent;this.stream=e.stream||null;this.userId=e.userId;this.language=e.language;this.name=e.name||"";this.avatar=e.avatar&&!BX.Call.Util.isAvatarBlank(e.avatar)?e.avatar:"";this.hasVideo=false;this.elements={container:null,inner:null,video:null,user:null,userBlock:null,avatar:null,nameBlock:null,name:null};this.loader=null;this.checkAspectInterval=setInterval(this.checkVideoAspect.bind(this),500)};n.prototype.render=function(){this.elements.container=BX.create("div",{props:{className:"bx-messenger-videocall-video-block"}});this.elements.video=BX.create("video",{props:{className:"bx-messenger-videocall-video",autoplay:true,volume:0}});this.elements.user=BX.create("div",{props:{className:"bx-messenger-audiocall"},children:[BX.create("div",{props:{className:"bx-messenger-audiocall-wrap"},children:[this.elements.inner=BX.create("div",{props:{className:"bx-messenger-audiocall-inner"},children:[this.elements.userBlock=BX.create("div",{props:{className:"bx-messenger-audiocall-user-block"},children:[BX.create("div",{props:{className:"bx-messenger-audiocall-user-block-inner"},children:[BX.create("div",{props:{className:"bx-messenger-audiocall-user"},children:[this.elements.avatar=BX.create("div",{props:{className:"bx-messenger-audiocall-user-item"}})]})]})]}),this.elements.nameBlock=BX.create("div",{props:{className:"bx-messenger-audiocall-user-name"},children:[this.elements.name=BX.create("span",{props:{className:"bx-messenger-audiocall-user-link"}})]})]})]})]});if(this.stream&&BX.Call.Util.containsVideoTrack(this.stream)){this.elements.container.appendChild(this.elements.video);this.elements.container.classList.remove("bx-messenger-videocall-audio");if(this.userId==this.parent.userId&&this.parent.localUser.flipVideo){this.elements.video.classList.add("bx-messenger-videocall-video-flipped")}else{this.elements.video.classList.remove("bx-messenger-videocall-video-flipped")}}else{this.elements.container.classList.add("bx-messenger-videocall-audio")}this.loader=new BX.Loader({target:this.elements.container});this.updateUserInfo();return this.elements.container};n.prototype.blurVideo=function(e){e=e!==false;if(e){this.elements.video.pause();this.elements.video.classList.add("bx-messenger-videocall-video-blurred");this.loader.show()}else{this.elements.video.play().catch(BX.DoNothing);this.elements.video.classList.remove("bx-messenger-videocall-video-blurred");this.loader.hide()}};n.prototype.updateUserInfo=function(){if(this.elements.name){this.elements.name.innerText=this.name}if(this.elements.avatar){if(this.avatar!=""){this.elements.avatar.style.backgroundImage="url('"+this.avatar+"')"}else{this.elements.avatar.style.removeProperty("background-image")}}this.updateAvatarWidth()};n.prototype.updateAvatarWidth=function(){this.elements.userBlock.style.maxWidth=Math.min(200,this.elements.inner.offsetHeight-this.elements.nameBlock.offsetHeight)+"px"};n.prototype.setUserId=function(e,t){if(this.userId==e){return}if(e==this.parent.userId&&this.parent.localUser.flipVideo){this.setStream(this.parent.localUser.stream);this.elements.video.classList.add("bx-messenger-videocall-video-flipped")}else{this.setStream(this.parent.users[e].stream);this.elements.video.classList.remove("bx-messenger-videocall-video-flipped")}this.userId=e;this.name=t.name||"";this.avatar=t.avatar_hr||"";this.updateUserInfo()};n.prototype.setStream=function(e){this.stream=e;var t=BX.Call.Util.containsVideoTrack(e);if(this.stream){if(this.hasVideo&&!t){BX.remove(this.elements.video);this.elements.container.appendChild(this.elements.user);this.elements.container.classList.add("bx-messenger-videocall-audio");this.updateAvatarWidth()}else if(!this.hasVideo&&t){BX.remove(this.elements.user);this.elements.container.appendChild(this.elements.video);this.elements.container.classList.remove("bx-messenger-videocall-audio")}}else{BX.remove(this.elements.video);this.elements.container.appendChild(this.elements.user);this.elements.container.classList.add("bx-messenger-videocall-audio");this.updateAvatarWidth()}this.hasVideo=t;if(this.hasVideo){if(this.elements.video.srcObject!=e){this.elements.video.srcObject=e}this.blurVideo(false);if(this.userId==this.parent.userId&&this.parent.localUser.flipVideo){this.elements.video.classList.add("bx-messenger-videocall-video-flipped")}else{this.elements.video.classList.remove("bx-messenger-videocall-video-flipped")}}};n.prototype.playVideo=function(){if(this.elements.video){this.elements.video.play().catch(BX.DoNothing)}};n.prototype.releaseStream=function(){this.elements.video.srcObject=null;this.stream=null};n.prototype.setFullSize=function(e){if(e){this.elements.container.classList.add("bx-messenger-videocall-video-block-full")}else{this.elements.container.classList.remove("bx-messenger-videocall-video-block-full")}this.updateAvatarWidth()};n.prototype.isVideo=function(){};n.prototype.checkVideoAspect=function(){if(!this.elements.video){return}if(this.elements.video.videoHeight>this.elements.video.videoWidth){this.elements.video.classList.add("bx-messenger-videocall-video-vertical")}else{this.elements.video.classList.remove("bx-messenger-videocall-video-vertical")}};n.prototype.destroy=function(){this.stream=null;if(this.loader){this.loader.destroy();this.loader=null}clearInterval(this.checkAspectInterval)};var a=function(e){this.id=e.id;this.name=e.name||"";this.avatar=e.avatar&&!BX.Call.Util.isAvatarBlank(e.avatar)?e.avatar:"";this.state=e.state;this.order=e.order;this._stream=e.stream;Object.defineProperty(this,"stream",{get:function(){return this._stream},set:function(e){this._stream=e;this.update()}});this._flipVideo=false;Object.defineProperty(this,"flipVideo",{get:function(){return this._flipVideo},set:function(e){this._flipVideo=e;this.update()}});this.talking=false;this.talkingStart=0;this.talkingStop=(new Date).getTime();this.isMicrophoneOn=e.isMicrophoneOn!==false;this.localUser=e.localUser===true;this.hidden=false;this.screenState=false;this.elements={root:null,container:null,videoContainer:null,video:null,videoBorder:null,avatar:null,nameContainer:null,name:null,overlay:null,state:null,removeButton:null,micState:null};this.callBacks={onClick:BX.type.isFunction(e.onClick)?e.onClick:BX.DoNothing};this.checkAspectInterval=setInterval(this.checkVideoAspect.bind(this),500)};a.prototype.render=function(){var e=this;this.elements.root=BX.create("div",{props:{className:"bx-messenger-videocall-user"},dataset:{userId:this.id,order:this.order},children:[this.elements.container=BX.create("div",{props:{className:"bx-messenger-videocall-user-inner"}})],style:{order:this.order},events:{click:function(e){e.stopPropagation();this.callBacks.onClick({userId:this.id})}.bind(this)}});if(this.talking){this.elements.root.classList.add("bx-messenger-videocall-user-talking")}if(this.localUser){this.elements.root.classList.add("bx-messenger-videocall-user-self")}this.elements.avatar=BX.create("div",{props:{className:"bx-message-videocall-user-avatar"}});if(this.avatar!==""){this.elements.avatar.style.backgroundImage="url('"+this.avatar+"')"}else{e.elements.avatar.style.removeProperty("background-image")}if(!this.hasVideo()){this.elements.container.appendChild(this.elements.avatar)}this.elements.videoContainer=BX.create("div",{props:{className:"bx-messenger-videocall-video-container"},children:[this.elements.video=BX.create("video",{props:{className:"bx-messenger-videocall-video",volume:0,autoplay:true}}),this.elements.videoBorder=BX.create("div",{props:{className:"bx-messenger-videocall-video-border"}})]});this.elements.container.appendChild(this.elements.videoContainer);if(this.stream&&this.stream.active){this.elements.video.srcObject=this.stream}if(this.flipVideo){this.elements.video.classList.add("bx-messenger-videocall-video-flipped")}this.elements.overlay=BX.create("div",{props:{className:"bx-messenger-videocall-overlay"}});this.elements.root.appendChild(this.elements.overlay);this.elements.state=this.renderState();if(this.elements.state){this.elements.overlay.appendChild(this.elements.state)}this.elements.nameContainer=BX.create("div",{props:{className:"bx-messenger-videocall-user-name"},children:[this.elements.name=BX.create("span",{props:{className:"bx-messenger-videocall-user-text"},text:this.name}),BX.create("div",{props:{className:"bx-messenger-videocall-user-shadow"}})]});this.elements.videoContainer.appendChild(this.elements.nameContainer);this.elements.micState=BX.create("div",{props:{className:"bx-messenger-videocall-user-mic-state"+(this.isMicrophoneOn?" hidden":"")},children:[BX.create("div",{props:{className:"bx-messenger-videocall-user-mic-state-icon"}})]});this.elements.nameContainer.insertBefore(this.elements.micState,this.elements.name);return this.elements.root};a.prototype.updateAvatar=function(e){this.avatar=e;if(this.elements.avatar){if(this.avatar!==""){this.elements.avatar.style.backgroundImage="url('"+this.avatar+"')"}else{this.elements.avatar.style.removeProperty("background-image")}}};a.prototype.updateName=function(e){this.name=e;if(this.elements.name){this.elements.name.innerText=this.name}};a.prototype.update=function(){if(!this.elements.root){return}if(this.hasVideo()){if(this.elements.video.srcObject!=this.stream){this.elements.video.srcObject=this.stream}BX.remove(this.elements.avatar);if(this.flipVideo){this.elements.video.classList.add("bx-messenger-videocall-video-flipped")}else{this.elements.video.classList.remove("bx-messenger-videocall-video-flipped")}}else{this.elements.video.srcObject=null;this.elements.container.appendChild(this.elements.avatar)}};a.prototype.playVideo=function(){if(this.elements.video){this.elements.video.play().catch(BX.DoNothing)}};a.prototype.renderState=function(){var e;switch(this.state){case BX.Call.UserState.Idle:break;case BX.Call.UserState.Calling:e=BX.create("div",{props:{className:"bx-messenger-videocall-user-status"},children:[BX.create("span",{props:{className:"bx-messenger-videocall-user-status-pic"},children:[BX.create("span",{props:{className:"bx-messenger-videocall-user-status-dot"}}),BX.create("span",{props:{className:"bx-messenger-videocall-user-status-dot"}}),BX.create("span",{props:{className:"bx-messenger-videocall-user-status-dot"}})]}),BX.create("span",{props:{className:"bx-messenger-videocall-user-status-text"},text:BX.message("IM_M_CALL_STATUS_WAIT_ANSWER")})]});break;case BX.Call.UserState.Declined:e=BX.create("div",{props:{className:"bx-messenger-videocall-user-status bx-messenger-videocall-user-status-wide"},children:[BX.create("span",{props:{className:"bx-messenger-videocall-user-status-pic"},children:[BX.create("span",{props:{className:"bx-messenger-videocall-user-status-cross"}})]}),BX.create("span",{props:{className:"bx-messenger-videocall-user-status-text"},text:BX.message("IM_M_CALL_STATUS_DECLINED")})]});break;case BX.Call.UserState.Ready:case BX.Call.UserState.Connecting:e=BX.create("div",{props:{className:"bx-messenger-videocall-user-status"},children:[BX.create("span",{props:{className:"bx-messenger-videocall-user-status-pic"},children:[BX.create("span",{props:{className:"bx-messenger-videocall-user-status-dot"}}),BX.create("span",{props:{className:"bx-messenger-videocall-user-status-dot"}}),BX.create("span",{props:{className:"bx-messenger-videocall-user-status-dot"}})]}),BX.create("span",{props:{className:"bx-messenger-videocall-user-status-text"},text:BX.message("IM_M_CALL_STATUS_WAIT_CONNECT")})]});break;case BX.Call.UserState.Connected:break;case BX.Call.UserState.Failed:case BX.Call.UserState.Unavailable:e=BX.create("div",{props:{className:"bx-messenger-videocall-user-status bx-messenger-videocall-user-status-wide"},children:[BX.create("span",{props:{className:"bx-messenger-videocall-user-status-pic"},children:[BX.create("span",{props:{className:"bx-messenger-videocall-user-status-cross"}})]}),BX.create("span",{props:{className:"bx-messenger-videocall-user-status-text"},text:this.state==BX.Call.UserState.Failed?BX.message("IM_M_CALL_STATUS_CONNECTION_ERROR"):BX.message("IM_M_CALL_STATUS_UNAVAILABLE")})]});break}return e?e:null};a.prototype.mount=function(e,t){t=t===true;if(!this.elements.root){this.render()}if(this.isMounted()&&!t){return false}e.appendChild(this.elements.root);this.update()};a.prototype.dismount=function(){if(!this.isMounted()){return false}this.elements.video.srcObject=null;BX.remove(this.elements.root)};a.prototype.isMounted=function(){return!!(this.elements.root&&this.elements.root.parentElement)};a.prototype.setState=function(e){if(this.state==e){return}this.state=e;if(!this.elements.root){return}if(this.elements.state){BX.cleanNode(this.elements.overlay);this.elements.state=null}this.elements.state=this.renderState();if(this.elements.state){this.elements.overlay.appendChild(this.elements.state)}};a.prototype.setTalking=function(e){if(this.talking==e){return}this.talking=e;if(!this.elements.root){return}if(this.talking){this.elements.root.classList.add("bx-messenger-videocall-user-talking");this.talkingStart=(new Date).getTime()}else{this.talkingStop=(new Date).getTime();this.elements.root.classList.remove("bx-messenger-videocall-user-talking")}};a.prototype.wasTalkingAgo=function(){if(this.talking){return 0}return(new Date).getTime()-this.talkingStop};a.prototype.setMicrophoneState=function(e){if(this.isMicrophoneOn==e){return}this.isMicrophoneOn=e;if(!this.elements.root){return}if(this.isMicrophoneOn){this.elements.micState.classList.add("hidden")}else{this.elements.micState.classList.remove("hidden")}};a.prototype.setScreenState=function(e){this.screenState=e};a.prototype.hide=function(){if(!this.elements.root){return}this.elements.root.dataset.hidden=1};a.prototype.show=function(){if(!this.elements.root){return}delete this.elements.root.dataset.hidden};a.prototype.hasVideo=function(){return this.state==BX.Call.UserState.Connected&&BX.Call.Util.containsVideoTrack(this.stream)};a.prototype.checkVideoAspect=function(){if(!this.elements.video){return}if(this.elements.video.videoHeight>this.elements.video.videoWidth){this.elements.video.classList.add("bx-messenger-videocall-video-vertical")}else{this.elements.video.classList.remove("bx-messenger-videocall-video-vertical")}};a.prototype.releaseStream=function(){if(this.elements.video){this.elements.video.srcObject=null}this.stream=null};a.prototype.destroy=function(){this.releaseStream();clearInterval(this.checkAspectInterval)};var l=function(e){this.elements={root:null};this.text=BX.type.isNotEmptyString(e.text)?e.text:"";this.isGroupCall=e.isGroupCall};l.prototype.render=function(){this.elements.root=BX.create("div",{props:{className:"bx-messenger-videocall-panel-title"},html:this.getTitle(this.text)});return this.elements.root};l.prototype.getTitle=function(e){var t='<span class="bx-messenger-videocall-panel-title-name">'+this.text+"</span>";if(this.isGroupCall){return BX.message("IM_M_GROUP_CALL_WITH").replace("#CHAT_NAME#",t)}else{return BX.message("IM_M_CALL_WITH").replace("#USER_NAME#",t)}};var o=function(e){this.class=e.class;this.text=BX.type.isNotEmptyString(e.text)?e.text:"";this.isActive=false;this.counter=e.counter||0;this.elements={root:null,counter:null,counterValue:null};this.callbacks={onClick:BX.type.isFunction(e.onClick)?e.onClick:BX.DoNothing}};o.prototype.render=function(){if(this.elements.root){return this.elements.root}var e;if(this.text!==""){e=BX.create("div",{props:{className:"bx-messenger-videocall-panel-text"},text:this.text})}else{e=null}this.elements.root=BX.create("div",{props:{className:"bx-messenger-videocall-panel-item"},children:[BX.create("div",{props:{className:"bx-messenger-videocall-panel-icon bx-messenger-videocall-panel-icon-"+this.class},children:[this.elements.counter=BX.create("span",{props:{className:"bx-messenger-cl-count"},style:{display:this.counter>0?"inline-block":"none",position:"absolute",right:"-19px",top:"-13px"},children:[this.elements.counterValue=BX.create("span",{props:{className:"bx-messenger-cl-count-digit"},text:this.counter})]})]}),e],events:{click:this.callbacks.onClick}});if(this.isActive){this.elements.root.classList.add("active")}return this.elements.root};o.prototype.setActive=function(e){if(this.isActive==e){return}this.isActive=e;if(!this.elements.root){return}if(this.isActive){this.elements.root.classList.add("active")}else{this.elements.root.classList.remove("active")}};o.prototype.setCounter=function(e){this.counter=e;if(this.counter==0){this.elements.counter.style.display="none"}else{this.elements.counter.style.removeProperty("display")}this.elements.counterValue.innerText=e};var h=function(e){this.text=e.text;this.elements={root:null};this.callbacks={onClick:BX.type.isFunction(e.onClick)?e.onClick:BX.DoNothing}};h.prototype.render=function(){if(this.elements.root){return this.elements.root}this.elements.root=BX.create("div",{props:{className:"bx-messenger-videocall-panel-item bx-messenger-videocall-panel-item-btn"},children:[BX.create("button",{props:{className:"ui-btn ui-btn-round bx-messenger-videocall-panel-btn ui-btn-icon-phone-down"},text:this.text})],events:{click:this.callbacks.onClick}});return this.elements.root};var c=function(e){this.class=e.class;this.text=e.text;this.enabled=e.enabled==true;this.arrowEnabled=e.arrowEnabled==true;this.elements={root:null,icon:null,arrow:null};this.callbacks={onClick:BX.type.isFunction(e.onClick)?e.onClick:BX.DoNothing,onArrowClick:BX.type.isFunction(e.onArrowClick)?e.onArrowClick:BX.DoNothing}};c.prototype.render=function(){if(this.elements.root){return this.elements.root}this.elements.root=BX.create("div",{props:{className:"bx-messenger-videocall-panel-item"},children:[this.elements.icon=BX.create("div",{props:{className:this.getIconClass()}}),BX.create("div",{props:{className:"bx-messenger-videocall-panel-text"},text:this.text})],events:{click:this.callbacks.onClick}});this.elements.arrow=BX.create("div",{props:{className:"bx-messenger-videocall-panel-arrow"},events:{click:function(e){this.callbacks.onArrowClick.apply(this,arguments);e.stopPropagation()}.bind(this)}});if(this.arrowEnabled){this.elements.icon.appendChild(this.elements.arrow)}return this.elements.root};c.prototype.getIconClass=function(){return"bx-messenger-videocall-panel-icon bx-messenger-videocall-panel-icon-"+this.class+(this.enabled?"":"-off")};c.prototype.enable=function(){if(this.enabled){return}this.enabled=true;this.elements.icon.className=this.getIconClass()};c.prototype.disable=function(){if(!this.enabled){return}this.enabled=false;this.elements.icon.className=this.getIconClass()};c.prototype.showArrow=function(){if(this.arrowEnabled){return}this.arrowEnabled=true;this.elements.icon.appendChild(this.elements.arrow)};c.prototype.hideArrow=function(){if(!this.arrowEnabled){return}this.arrowEnabled=false;this.elements.icon.removeChild(this.elements.arrow)};var u=function(e){this.deviceList=e.deviceList;this.current=e.current;this.parentElement=e.parentElement;this.menu=null;this.callbacks={onSelect:BX.type.isFunction(e.onSelect)?e.onSelect:BX.DoNothing}};u.create=function(e){return new u(e)};u.prototype.show=function(){var e=this;var t=[];this.deviceList.forEach(function(s){t.push({id:s.deviceId,text:s.label||"("+BX.message("IM_M_CALL_DEVICE_NO_NAME")+")",className:e.current==s.deviceId?"menu-popup-item-accept":"device-selector-empty",onclick:function(){e.menu.close();e.callbacks.onSelect(s)}})});this.menu=BX.PopupMenu.create("call-view-select-device",this.parentElement,t,{autoHide:true,zIndex:window["BX"]&&BX.MessengerCommon?BX.MessengerCommon.getDefaultZIndex()+500:500,closeByEsc:true,offsetTop:0,offsetLeft:0,bindOptions:{position:"top"},angle:{position:"bottom"},overlay:{backgroundColor:"white",opacity:0},events:{onPopupClose:function(){e.menu.popupWindow.destroy();BX.PopupMenu.destroy("call-view-select-device")},onPopupDestroy:function(){e.menu=null}}});this.menu.popupWindow.show()};BX.Call.View.Layout=e;BX.Call.View.Size={Folded:"folded",Full:"full"};BX.Call.View.UiState=t;BX.Call.View.Event=s})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:53:"/bitrix/js/im/call/notification.min.js?15995682286073";s:6:"source";s:34:"/bitrix/js/im/call/notification.js";s:3:"min";s:38:"/bitrix/js/im/call/notification.min.js";s:3:"map";s:38:"/bitrix/js/im/call/notification.map.js";}"*/
(function(){BX.namespace("BX.Call");if(BX.Call.Notification){return}var t={onButtonClick:"CallNotification::onButtonClick"};BX.Call.Notification=function(o){this.popup=null;this.window=null;this.callerAvatar=BX.type.isNotEmptyString(o.callerAvatar)?o.callerAvatar:"";if(this.callerAvatar=="/bitrix/js/im/images/blank.gif"){this.callerAvatar=""}this.callerName=o.callerName;this.video=o.video;this.hasCamera=o.hasCamera==true;this.callbacks={onClose:BX.type.isFunction(o.onClose)?o.onClose:BX.DoNothing,onDestroy:BX.type.isFunction(o.onDestroy)?o.onDestroy:BX.DoNothing,onButtonClick:BX.type.isFunction(o.onButtonClick)?o.onButtonClick:BX.DoNothing};this._onContentButtonClickHandler=this._onContentButtonClick.bind(this);if(BX.desktop){BX.desktop.addCustomEvent(t.onButtonClick,this._onContentButtonClickHandler)}};BX.Call.Notification.prototype.show=function(){if(BX.desktop){var t={video:this.video,hasCamera:this.hasCamera,callerAvatar:this.callerAvatar,callerName:this.callerName};if(this.window){this.window.BXDesktopWindow.ExecuteCommand("show")}else{this.window=BXDesktopSystem.ExecuteCommand("topmost.show.html",BX.desktop.getHtmlPage("","window.callNotification = new BX.Call.NotificationContent("+JSON.stringify(t)+"); window.callNotification.showInDesktop();"))}}else{this.content=new BX.Call.NotificationContent({video:this.video,hasCamera:this.hasCamera,callerAvatar:this.callerAvatar,callerName:this.callerName,onClose:this.callbacks.onClose,onDestroy:this.callbacks.onDestroy,onButtonClick:this.callbacks.onButtonClick});this.createPopup(this.content.render());this.popup.show()}};BX.Call.Notification.prototype.createPopup=function(t){this.popup=new BX.PopupWindow("bx-messenger-call-notify",null,{content:t,closeIcon:false,noAllPaddings:true,zIndex:BX.MessengerCommon.getDefaultZIndex()+200,offsetLeft:0,offsetTop:0,closeByEsc:false,draggable:{restrict:false},overlay:{backgroundColor:"black",opacity:30},events:{onPopupClose:function(){this.callbacks.onClose()}.bind(this),onPopupDestroy:function(){this.popup=null}.bind(this)}})};BX.Call.Notification.prototype.close=function(){if(this.popup){this.popup.close()}if(this.window){this.window.BXDesktopWindow.ExecuteCommand("hide")}this.callbacks.onClose()};BX.Call.Notification.prototype.destroy=function(){if(this.popup){this.popup.destroy();this.popup=null}if(this.window){this.window.BXDesktopWindow.ExecuteCommand("close");this.window=null}if(BX.desktop){BX.desktop.removeCustomEvents(t.onButtonClick)}this.callbacks.onDestroy()};BX.Call.Notification.prototype._onContentButtonClick=function(t){this.callbacks.onButtonClick(t)};BX.Call.NotificationContent=function(t){this.video=t.video;this.hasCamera=t.hasCamera;this.callerAvatar=t.callerAvatar;this.callerName=t.callerName;this.elements={root:null,avatar:null};this.callbacks={onClose:BX.type.isFunction(t.onClose)?t.onClose:BX.DoNothing,onDestroy:BX.type.isFunction(t.onDestroy)?t.onDestroy:BX.DoNothing,onButtonClick:BX.type.isFunction(t.onButtonClick)?t.onButtonClick:BX.DoNothing}};BX.Call.NotificationContent.prototype.render=function(){this.elements.root=BX.create("div",{props:{className:"bx-messenger-call-window"},children:[BX.create("div",{props:{className:"bx-messenger-call-window-body"},children:[BX.create("div",{props:{className:"bx-messenger-call-window-photo"},children:[BX.create("div",{props:{className:"bx-messenger-call-window-photo-left"},children:[BX.create("div",{props:{className:"bx-messenger-call-window-photo-block"},children:[this.elements.avatar=BX.create("img",{props:{className:"bx-messenger-call-window-overlay-photo-img",src:this.callerAvatar||"/bitrix/js/im/images/hidef-avatar-v3.png"},style:{backgroundColor:"#df532d"}})]})]})]}),BX.create("div",{props:{className:"bx-messenger-call-window-info"},children:[BX.create("div",{props:{className:"bx-messenger-call-window-title"},children:[BX.create("div",{props:{className:"bx-messenger-call-window-title-block"},children:[document.createTextNode(this.video?BX.message("IM_M_VIDEO_CALL_FROM"):BX.message("IM_M_CALL_FROM")),BX.create("span",{props:{className:"bx-messenger-call-overlay-title-caller"},text:BX.util.htmlspecialcharsback(this.callerName)})]})]}),BX.create("div",{props:{className:"bx-messenger-call-window-buttons"},children:[BX.create("div",{props:{className:"bx-messenger-call-window-buttons-block"},children:[BX.create("button",{props:{className:"ui-btn ui-btn-sm ui-btn-round ui-btn-primary-dark ui-btn-icon-camera bx-messenger-call-window-button"+(!this.hasCamera?" ui-btn-disabled":"")},text:BX.message("IM_M_CALL_BTN_ANSWER_VIDEO"),events:{click:this._onAnswerWithVideoButtonClick.bind(this)}}),BX.create("button",{props:{className:"ui-btn ui-btn-sm ui-btn-round ui-btn-primary-dark ui-btn-icon-phone-up bx-messenger-call-window-button"},text:BX.message("IM_M_CALL_BTN_ANSWER"),events:{click:this._onAnswerButtonClick.bind(this)}}),BX.create("button",{props:{className:"ui-btn ui-btn-sm ui-btn-round ui-btn-danger-dark ui-btn-icon-phone-down"},text:BX.message("IM_M_CALL_BTN_DECLINE"),events:{click:this._onDeclineButtonClick.bind(this)}})]})]})]})]})]});return this.elements.root};BX.Call.NotificationContent.prototype.showInDesktop=function(){this.render();document.body.appendChild(this.elements.root);BX.desktop.setWindowPosition({X:STP_CENTER,Y:STP_VCENTER,Width:635,Height:125})};BX.Call.NotificationContent.prototype._onAnswerButtonClick=function(o){if(BX.desktop){BX.desktop.onCustomEvent("main",t.onButtonClick,[{button:"answer",video:false}])}else{this.callbacks.onButtonClick({button:"answer",video:false})}};BX.Call.NotificationContent.prototype._onAnswerWithVideoButtonClick=function(o){if(!this.hasCamera){return}if(BX.desktop){BX.desktop.onCustomEvent("main",t.onButtonClick,[{button:"answer",video:true}])}else{this.callbacks.onButtonClick({button:"answer",video:true})}};BX.Call.NotificationContent.prototype._onDeclineButtonClick=function(o){if(BX.desktop){BX.desktop.onCustomEvent("main",t.onButtonClick,[{button:"decline"}])}else{this.callbacks.onButtonClick({button:"decline"})}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:64:"/bitrix/js/im/call/notification_conference.min.js?15995682965523";s:6:"source";s:45:"/bitrix/js/im/call/notification_conference.js";s:3:"min";s:49:"/bitrix/js/im/call/notification_conference.min.js";s:3:"map";s:49:"/bitrix/js/im/call/notification_conference.map.js";}"*/
(function(){BX.namespace("BX.Call");if(BX.Call.NotificationConference){return}var e={onButtonClick:"ConferenceNotification::onButtonClick"};BX.Call.NotificationConference=function(t){this.popup=null;this.window=null;this.callerAvatar=BX.type.isNotEmptyString(t.callerAvatar)?t.callerAvatar:"";if(this.callerAvatar=="/bitrix/js/im/images/blank.gif"){this.callerAvatar=""}this.callerName=t.callerName;this.callbacks={onClose:BX.type.isFunction(t.onClose)?t.onClose:BX.DoNothing,onDestroy:BX.type.isFunction(t.onDestroy)?t.onDestroy:BX.DoNothing,onButtonClick:BX.type.isFunction(t.onButtonClick)?t.onButtonClick:BX.DoNothing};this._onContentButtonClickHandler=this._onContentButtonClick.bind(this);if(BX.desktop){BX.desktop.addCustomEvent(e.onButtonClick,this._onContentButtonClickHandler)}};BX.Call.NotificationConference.prototype.show=function(){if(BX.desktop){var e={callerAvatar:this.callerAvatar,callerName:this.callerName};if(this.window){this.window.BXDesktopWindow.ExecuteCommand("show")}else{this.window=BXDesktopSystem.ExecuteCommand("topmost.show.html",BX.desktop.getHtmlPage("","window.conferenceNotification = new BX.Call.NotificationConferenceContent("+JSON.stringify(e)+"); window.conferenceNotification.showInDesktop();"))}}else{this.content=new BX.Call.NotificationConferenceContent({callerAvatar:this.callerAvatar,callerName:this.callerName,onClose:this.callbacks.onClose,onDestroy:this.callbacks.onDestroy,onButtonClick:this.callbacks.onButtonClick});this.createPopup(this.content.render());this.popup.show()}};BX.Call.NotificationConference.prototype.createPopup=function(e){this.popup=new BX.PopupWindow("bx-messenger-call-notify",null,{content:e,closeIcon:false,noAllPaddings:true,zIndex:BX.MessengerCommon.getDefaultZIndex()+200,offsetLeft:0,offsetTop:0,closeByEsc:false,draggable:{restrict:false},overlay:{backgroundColor:"black",opacity:30},events:{onPopupClose:function(){this.callbacks.onClose()}.bind(this),onPopupDestroy:function(){this.popup=null}.bind(this)}})};BX.Call.NotificationConference.prototype.close=function(){if(this.popup){this.popup.close()}if(this.window){this.window.BXDesktopWindow.ExecuteCommand("hide")}this.callbacks.onClose()};BX.Call.NotificationConference.prototype.destroy=function(){if(this.popup){this.popup.destroy();this.popup=null}if(this.window){this.window.BXDesktopWindow.ExecuteCommand("close");this.window=null}if(BX.desktop){BX.desktop.removeCustomEvents(e.onButtonClick)}this.callbacks.onDestroy()};BX.Call.NotificationConference.prototype._onContentButtonClick=function(e){this.callbacks.onButtonClick(e)};BX.Call.NotificationConferenceContent=function(e){this.callerAvatar=e.callerAvatar;this.callerName=e.callerName;this.elements={root:null,avatar:null};this.callbacks={onClose:BX.type.isFunction(e.onClose)?e.onClose:BX.DoNothing,onDestroy:BX.type.isFunction(e.onDestroy)?e.onDestroy:BX.DoNothing,onButtonClick:BX.type.isFunction(e.onButtonClick)?e.onButtonClick:BX.DoNothing}};BX.Call.NotificationConferenceContent.prototype.render=function(){this.elements.root=BX.create("div",{props:{className:"bx-messenger-call-window"},children:[BX.create("div",{props:{className:"bx-messenger-call-window-body"},children:[BX.create("div",{props:{className:"bx-messenger-call-window-photo"},children:[BX.create("div",{props:{className:"bx-messenger-call-window-photo-left"},children:[BX.create("div",{props:{className:"bx-messenger-call-window-photo-block"},children:[this.elements.avatar=BX.create("img",{props:{className:"bx-messenger-call-window-overlay-photo-img",src:this.callerAvatar||"/bitrix/js/im/images/hidef-avatar-v3.png"},style:{backgroundColor:"#df532d"}})]})]})]}),BX.create("div",{props:{className:"bx-messenger-call-window-info"},children:[BX.create("div",{props:{className:"bx-messenger-call-window-title"},children:[BX.create("div",{props:{className:"bx-messenger-call-window-title-block"},children:[document.createTextNode(BX.message("IM_M_VIDEO_CALL_FROM")),BX.create("span",{props:{className:"bx-messenger-call-overlay-title-caller"},text:BX.util.htmlspecialcharsback(this.callerName)})]})]}),BX.create("div",{props:{className:"bx-messenger-call-window-buttons"},children:[BX.create("div",{props:{className:"bx-messenger-call-window-buttons-block"},children:[BX.create("button",{props:{className:"ui-btn ui-btn-sm ui-btn-round ui-btn-primary-dark ui-btn-icon-camera bx-messenger-call-window-button"},text:BX.message("IM_M_CALL_BTN_ANSWER_CONFERENCE"),events:{click:this._onAnswerConferenceButtonClick.bind(this)}}),BX.create("button",{props:{className:"ui-btn ui-btn-sm ui-btn-round ui-btn-danger-dark ui-btn-icon-phone-down"},text:BX.message("IM_M_CALL_BTN_SKIP_CONFERENCE"),events:{click:this._onSkipConferenceButtonClick.bind(this)}})]})]})]})]})]});return this.elements.root};BX.Call.NotificationConferenceContent.prototype.showInDesktop=function(){this.render();document.body.appendChild(this.elements.root);BX.desktop.setWindowPosition({X:STP_CENTER,Y:STP_VCENTER,Width:635,Height:125})};BX.Call.NotificationConferenceContent.prototype._onAnswerConferenceButtonClick=function(t){if(BX.desktop){BX.desktop.onCustomEvent("main",e.onButtonClick,[{button:"answerConference"}])}else{this.callbacks.onButtonClick({button:"answerConference"})}};BX.Call.NotificationConferenceContent.prototype._onSkipConferenceButtonClick=function(t){if(BX.desktop){BX.desktop.onCustomEvent("main",e.onButtonClick,[{button:"skipConference"}])}else{this.callbacks.onButtonClick({button:"skipConference"})}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:53:"/bitrix/js/im/call/invite_popup.min.js?15995682968269";s:6:"source";s:34:"/bitrix/js/im/call/invite_popup.js";s:3:"min";s:38:"/bitrix/js/im/call/invite_popup.min.js";s:3:"map";s:38:"/bitrix/js/im/call/invite_popup.map.js";}"*/
(function(){BX.namespace("BX.Call");if(BX.Call.InvitePopup){return}BX.Call.InvitePopup=function(e){if(!BX.type.isPlainObject(e)){e={}}this.idleUsers=e.idleUsers||[];this.recentUsers=[];this.bindElement=e.bindElement;this.allowNewUsers=e.allowNewUsers;this.elements={root:null,inputBox:null,input:null,destinationContainer:null,contactList:null,moreButton:null};this.popup=null;this.zIndex=e.zIndex||0;this.searchPhrase="";this.searchNext=0;this.searchResult=[];this.searchTotalCount=0;this.searchTimeout=0;this.fetching=false;this.callbacks={onSelect:BX.type.isFunction(e.onSelect)?e.onSelect:BX.DoNothing,onClose:BX.type.isFunction(e.onClose)?e.onClose:BX.DoNothing,onDestroy:BX.type.isFunction(e.onDestroy)?e.onDestroy:BX.DoNothing}};BX.Call.InvitePopup.prototype={show:function(){if(!this.elements.root){this.render()}this.createPopup();this.popup.show();if(this.allowNewUsers){this.showLoader();this.getRecent().then(this.updateContactList.bind(this))}else{this.updateContactList()}},close:function(){if(this.popup){this.popup.close()}},createPopup:function(){var e=this;this.popup=new BX.PopupWindow("bx-call-popup-invite",this.bindElement,{zIndex:this.zIndex,lightShadow:true,darkMode:BXIM.settings.enableDarkTheme,autoHide:true,closeByEsc:true,content:this.elements.root,bindOptions:{position:"top"},angle:{position:"bottom",offset:49},buttons:[new BX.PopupWindowButton({text:BX.message("IM_CALL_INVITE_INVITE"),className:"popup-window-button-accept",events:{click:function(e){if(this.selectedUser){this.callbacks.onSelect({user:this.selectedUser})}}.bind(this)}}),new BX.PopupWindowButton({text:BX.message("IM_CALL_INVITE_CANCEL"),events:{click:function(){e.popup.close()}}})],events:{onPopupClose:function(){this.destroy()},onPopupDestroy:function(){e.popup=null;e.elements.contactList=null;e.callbacks.onDestroy()}}});BX.addClass(this.popup.popupContainer,"bx-messenger-mark")},getRecent:function(){var e=this;return new Promise(function(t,s){BX.CallEngine.getRestClient().callMethod("im.recent.get",{SKIP_OPENLINES:"Y",SKIP_CHAT:"Y"}).then(function(s){var n=s.answer;e.recentUsers=Object.values(n.result).map(function(e){return e.user});t()})})},search:function(){var e=this;return new Promise(function(t,s){e.searchResult=[];e.searchNext=0;e.searchTotalCount=0;BX.CallEngine.getRestClient().callMethod("im.search.user.list",{FIND:e.searchPhrase}).then(function(s){var n=s.answer;e.searchTotalCount=n.total;e.searchNext=n.next;e.searchResult=e.searchResult.concat(Object.values(n.result));t()})})},fetchMoreSearchResults:function(){var e=this;return new Promise(function(t,s){BX.CallEngine.getRestClient().callMethod("im.search.user.list",{FIND:e.searchPhrase,OFFSET:e.searchNext}).then(function(s){var n=s.answer;e.searchTotalCount=n.total;e.searchNext=n.next;var i=Object.values(n.result);e.searchResult=e.searchResult.concat(i);t(i)})})},render:function(){this.elements.root=BX.create("div",{props:{className:"bx-messenger-popup-newchat-wrap"},children:[BX.create("div",{props:{className:"bx-messenger-popup-newchat-caption"},text:BX.message("IM_CALL_INVITE_INVITE_USER")})]});this.elements.inputBox=BX.create("div",{props:{className:"bx-messenger-popup-newchat-box bx-messenger-popup-newchat-dest bx-messenger-popup-newchat-dest-even"},children:[this.elements.destinationContainer=BX.create("span",{props:{className:"bx-messenger-dest-items"}}),this.elements.input=BX.create("input",{props:{className:"bx-messenger-input"},attrs:{type:"text",placeholder:this.allowNewUsers?BX.message("IM_M_SEARCH_PLACEHOLDER"):BX.message("IM_M_CALL_REINVITE_PLACEHOLDER"),value:"",disabled:!this.allowNewUsers},events:{keyup:this._onInputKeyUp.bind(this)}})]});this.elements.root.appendChild(this.elements.inputBox);this.elements.contactList=BX.create("div",{props:{className:"bx-messenger-popup-newchat-box bx-messenger-popup-newchat-cl bx-messenger-recent-wrap"},children:[]});this.elements.root.appendChild(this.elements.contactList)},updateDestination:function(){if(!this.elements.inputBox){return}BX.cleanNode(this.elements.destinationContainer);if(this.selectedUser){this.elements.destinationContainer.appendChild(this.renderDestinationUser(this.selectedUser));this.elements.input.style.display="none"}else{this.elements.input.style.removeProperty("display");this.elements.input.focus()}},updateContactList:function(){BX.cleanNode(this.elements.contactList);this.elements.contactList.appendChild(this.renderContactList())},showLoader:function(){BX.cleanNode(this.elements.contactList);this.elements.contactList.appendChild(BX.create("div",{props:{className:"bx-messenger-cl-item-load"},text:BX.message("IM_CL_LOAD")}))},renderContactList:function(){var e=document.createDocumentFragment();var t;if(this.idleUsers.length>0){e.appendChild(this.renderSeparator(BX.message("IM_CALL_INVITE_CALL_PARTICIPANTS")));for(t=0;t<this.idleUsers.length;t++){e.appendChild(this.renderUser(this.idleUsers[t]))}}if(this.searchPhrase!=""){if(this.searchResult.length>0){e.appendChild(this.renderSeparator(BX.message("IM_CALL_INVITE_SEARCH_RESULTS")));for(t=0;t<this.searchResult.length;t++){e.appendChild(this.renderUser(this.searchResult[t]))}if(this.searchTotalCount>this.searchResult.length){this.elements.moreButton=this.renderMoreButton();e.appendChild(this.elements.moreButton)}}else{}}else if(this.recentUsers.length>0){e.appendChild(this.renderSeparator(BX.message("IM_CALL_INVITE_RECENT")));for(t=0;t<this.recentUsers.length;t++){e.appendChild(this.renderUser(this.recentUsers[t]))}}return e},renderSeparator:function(e){return BX.create("div",{props:{className:"bx-messenger-chatlist-group"},children:[BX.create("span",{props:{className:"bx-messenger-chatlist-group-title"},text:e})]})},renderUser:function(e){var t=e.work_position;var s;var n=BX.create("span",{props:{className:"bx-messenger-cl-item"},dataset:{id:e.id,name:e.name,status:e.status,avatar:e.avatar},events:{click:function(t){this.setSelectedUser(e)}.bind(this)},children:[BX.create("span",{props:{className:"bx-messenger-cl-avatar"},children:[s=BX.create("img",{props:{className:"bx-messenger-cl-avatar-img bx-messenger-cl-avatar-img-default"},style:{backgroundColor:e.color}}),BX.create("span",{props:{className:"bx-messenger-cl-status"}})]}),BX.create("span",{props:{className:"bx-messenger-cl-user"},children:[BX.create("div",{props:{className:"bx-messenger-cl-user-title"},text:e.name}),BX.create("div",{props:{className:"bx-messenger-cl-user-desc"},text:t})]})]});if(e.avatar){s.src=e.avatar}return n},renderDestinationUser:function(e){return BX.create("span",{props:{className:"bx-messenger-dest-block"},children:[BX.create("span",{props:{className:"bx-messenger-dest-text"},text:e.name}),BX.create("span",{props:{className:"bx-messenger-dest-del"},events:{click:this.removeSelectedUser.bind(this)}})]})},renderMoreButton:function(){return BX.create("div",{props:{className:"bx-messenger-chatlist-more-wrap"},events:{click:this._onMoreButtonClick.bind(this)},children:[BX.create("span",{props:{className:"bx-messenger-chatlist-more"},text:BX.message("IM_CALL_INVITE_MORE")+" "+(this.searchTotalCount-this.searchResult.length)})]})},setSelectedUser:function(e){this.selectedUser=e;this.updateDestination()},removeSelectedUser:function(){this.selectedUser=null;this.updateDestination()},_onMoreButtonClick:function(){if(this.fetching){return}this.fetching=true;this.fetchMoreSearchResults().then(function(e){var t=document.createDocumentFragment();var s=null;for(var n=0;n<e.length;n++){t.appendChild(this.renderUser(e[n]))}if(this.searchTotalCount>this.searchResult.length){s=this.renderMoreButton();t.appendChild(s)}BX.replace(this.elements.moreButton,t);this.elements.moreButton=s;this.fetching=false}.bind(this))},_onInputKeyUp:function(e){var t=this;if(e.keyCode==16||e.keyCode==17||e.keyCode==18||e.keyCode==20||e.keyCode==244||e.keyCode==224||e.keyCode==91){return false}if(e.keyCode==27&&this.elements.input.value!==""){BX.MessengerCommon.preventDefault(e)}if(e.keyCode==27){this.elements.input.value=""}if(this.searchTimeout){clearTimeout(this.searchTimeout)}this.searchTimeout=setTimeout(function(){t.searchPhrase=t.elements.input.value;if(t.searchPhrase==""){t.updateContactList()}else{t.search().then(function(){t.updateContactList()})}},300)}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:56:"/bitrix/js/im/call/floating_video.min.js?159956822815062";s:6:"source";s:36:"/bitrix/js/im/call/floating_video.js";s:3:"min";s:40:"/bitrix/js/im/call/floating_video.min.js";s:3:"map";s:40:"/bitrix/js/im/call/floating_video.map.js";}"*/
(function(){BX.namespace("BX.Call");if(BX.Call.FloatingVideo){return}var e={setStream:"FloatingVideo::setStream",setAudioMuted:"FloatingVideo::setAudioMuted",setTitle:"FloatingVideo::setTitle",setAvatars:"FloatingVideo::setAvatars",setTalking:"FloatingVideo::setTalking",onMainAreaClick:"FloatingVideo::onMainAreaClick",onMicButtonClick:"FloatingVideo::onMicButtonClick",onHangupButtonClick:"FloatingVideo::onHangupButtonClick",connectionOffer:"FloatingVideo::connectionOffer",connectionAnswer:"FloatingVideo::connectionAnswer",connectionClose:"FloatingVideo::connectionClose",connectionIceCandidate:"FloatingVideo::connectionIceCandidate"};var t=320;var n=180;var i=320;var s=70;BX.Call.FloatingVideo=function(e){if(typeof e!=="object"){e={}}this.stream=e.stream&&BX.Call.Util.containsVideoTrack(e.stream)?e.stream:null;this.audioMuted=e.audioMuted||false;this.title=e.title||"";this.avatars=e.avatars||{};this.window=null;this.visible=false;this.peerConnection=null;this.callbacks={onMainAreaClick:BX.type.isFunction(e.onMainAreaClick)?e.onMainAreaClick:BX.DoNothing,onButtonClick:BX.type.isFunction(e.onButtonClick)?e.onButtonClick:BX.DoNothing};this._onContentMainAreaClickHandler=this._onContentMainAreaClick.bind(this);this._onContentMicButtonClickHandler=this._onContentMicButtonClick.bind(this);this._onContentHangupButtonClickHandler=this._onContentHangupButtonClick.bind(this);this._onPCNegotiationNeededHandler=this._onPCNegotiationNeeded.bind(this);this._onPCIceCandidateHandler=this._onPCIceCandidate.bind(this);this._onConnectionAnswerHandler=this._onConnectionAnswer.bind(this);this._onConnectionIceCandidateHandler=this._onConnectionIceCandidate.bind(this);this.bindEventHandlers()};BX.Call.FloatingVideo.prototype={bindEventHandlers:function(){BX.desktop.addCustomEvent(e.onMainAreaClick,this._onContentMainAreaClickHandler);BX.desktop.addCustomEvent(e.onMicButtonClick,this._onContentMicButtonClickHandler);BX.desktop.addCustomEvent(e.onHangupButtonClick,this._onContentHangupButtonClickHandler);BX.desktop.addCustomEvent(e.connectionAnswer,this._onConnectionAnswerHandler);BX.desktop.addCustomEvent(e.connectionIceCandidate,this._onConnectionIceCandidateHandler)},_onContentMainAreaClick:function(){this.callbacks.onMainAreaClick()},_onContentMicButtonClick:function(){this.callbacks.onButtonClick({buttonName:"toggleMute",muted:!this.audioMuted})},_onContentHangupButtonClick:function(){this.callbacks.onButtonClick({buttonName:"hangup"})},setStream:function(e){if(BX.Call.Util.containsVideoTrack(e)){this.stream=e}else{this.stream=null}if(this.window&&this.visible){if(this.stream){this.sendVideo()}else{this.stopSendingVideo()}}},setTitle:function(t){this.title=t;if(this.window){BX.desktop.onCustomEvent(this.window,e.setTitle,[this.title])}},setAvatars:function(t){this.avatars=t;if(this.window&&this.visible){BX.desktop.onCustomEvent(this.window,e.setAvatars,[this.avatars])}},setTalking:function(t){if(this.window){BX.desktop.onCustomEvent(this.window,e.setTalking,[t])}},sendVideo:function(){if(!this.peerConnection){this.peerConnection=new RTCPeerConnection;this.peerConnection.addEventListener("negotiationneeded",this._onPCNegotiationNeededHandler);this.peerConnection.addEventListener("icecandidate",this._onPCIceCandidateHandler)}this.peerConnection.addTrack(this.stream.getVideoTracks()[0],this.stream)},_onPCNegotiationNeeded:function(){var t;this.peerConnection.createOffer().then(function(e){t=e;return this.peerConnection.setLocalDescription(e)}.bind(this)).then(function(){BX.desktop.onCustomEvent(this.window,e.connectionOffer,[t.sdp])}.bind(this))},_onPCIceCandidate:function(t){var n=t.candidate;if(n){BX.desktop.onCustomEvent(this.window,e.connectionIceCandidate,[n.toJSON()])}},_onConnectionAnswer:function(e){if(this.peerConnection){var t=new RTCSessionDescription({type:"answer",sdp:e});this.peerConnection.setRemoteDescription(t)}},_onConnectionIceCandidate:function(e){if(this.peerConnection){this.peerConnection.addIceCandidate(e)}},stopSendingVideo:function(){if(this.peerConnection){this.peerConnection.close();this.peerConnection.removeEventListener("negotiationneeded",this._onPCNegotiationNeededHandler);this.peerConnection.removeEventListener("icecandidate",this._onPCIceCandidateHandler);this.peerConnection=null}BX.desktop.onCustomEvent(this.window,e.connectionClose,[])},setAudioMuted:function(t){if(this.audioMuted==t){return}this.audioMuted=t;if(this.window&&this.visible){BX.desktop.onCustomEvent(this.window,e.setAudioMuted,[this.audioMuted])}},show:function(){if(!BX.desktop){return}if(this.window){this.window.BXDesktopWindow.ExecuteCommand("show");BX.desktop.onCustomEvent(this.window,e.setAudioMuted,[this.audioMuted]);BX.desktop.onCustomEvent(this.window,e.setAvatars,[this.avatars]);if(this.stream){this.sendVideo()}}else{var t={audioMuted:this.audioMuted,title:this.title,avatars:this.avatars};this.window=BXDesktopSystem.ExecuteCommand("topmost.show.html",BX.desktop.getHtmlPage("","window.FVC = new BX.Call.FloatingVideoContent("+JSON.stringify(t)+");"));setTimeout(function(){if(this.stream&&this.visible){this.sendVideo()}}.bind(this),2e3)}this.visible=true},hide:function(){if(!this.window||!this.window.document){return false}this.stopSendingVideo();this.window.BXDesktopWindow.ExecuteCommand("hide");this.visible=false},close:function(){if(!this.window||!this.window.document){return false}this.window.BXDesktopWindow.ExecuteCommand("close");this.window=null;this.visible=false},destroy:function(){if(this.window){this.window.BXDesktopWindow.ExecuteCommand("close");this.window=null}this.stream=null;BX.desktop.removeCustomEvents(e.onMainAreaClick);BX.desktop.removeCustomEvents(e.onMicButtonClick);BX.desktop.removeCustomEvents(e.onHangupButtonClick)}};BX.Call.FloatingVideoContent=function(e){this.stream=e.stream;this.audioMuted=e.audioMuted;this.avatars=e.avatars||{};this.title=e.title||"";this.talking=[];this.elements={container:null,video:null,avatars:null,title:null,micButton:null,micButtonText:null,hangupButton:null};this.render();this.adjustWindow();this.bindEventHandlers();this.callAspectHorizontal=true;if(this.stream){this.callAspectCheckInterval=setInterval(this.checkVideoAspect.bind(this),500)}this.slavePeerConnection=null;this._onSlavePCIceCandidateHandler=this._onSlavePCIceCandidate.bind(this);this._onSlavePCIceConnectionStateChangeHandler=this._onSlavePCIceConnectionStateChange.bind(this)};BX.Call.FloatingVideoContent.prototype={bindEventHandlers:function(){BX.desktop.addCustomEvent(e.setStream,this.setStream.bind(this));BX.desktop.addCustomEvent(e.setAudioMuted,this.setAudioMuted.bind(this));BX.desktop.addCustomEvent(e.setTitle,this.setTitle.bind(this));BX.desktop.addCustomEvent(e.setAvatars,this.setAvatars.bind(this));BX.desktop.addCustomEvent(e.setTalking,this.setTalking.bind(this));BX.desktop.addCustomEvent(e.connectionOffer,this._onConnectionOfferFromMain.bind(this));BX.desktop.addCustomEvent(e.connectionIceCandidate,this._onIceCandidateFromMain.bind(this));BX.desktop.addCustomEvent(e.connectionClose,this._onRTCconnectionClose.bind(this));window.addEventListener("beforeunload",this.destroy.bind(this))},render:function(){var e=this.stream?t:i;var o=this.stream?n:s;var a={width:e+"px",height:o+"px"};this.elements.container=BX.create("div",{props:{className:"bx-messenger-call-float"+(this.stream?"":" bx-messenger-call-float-audio")},style:a,events:{click:this.onMainAreaClick.bind(this)},children:[BX.create("div",{props:{className:"bx-messenger-call-float-audio-unfold"},children:[this.elements.avatars=BX.create("div",{props:{className:"bx-messenger-call-float-avatars"}}),this.elements.title=BX.create("span",{props:{className:"bx-messenger-call-float-button-text"},text:this.title})]}),BX.create("div",{props:{className:"bx-messenger-call-float-buttons"},children:[this.elements.micButton=BX.create("div",{props:{className:"bx-messenger-call-float-button bx-messenger-call-float-button-mic"+(this.audioMuted?" bx-messenger-call-float-button-mic-disabled":"")},events:{click:this.onMicButtonClick.bind(this)},children:[BX.create("span",{props:{className:"bx-messenger-call-float-button-icon"}}),this.elements.micButtonText=BX.create("span",{props:{className:"bx-messenger-call-float-button-text"},text:BX.message("IM_M_CALL_BTN_MIC")+" "+BX.message("IM_M_CALL_BTN_MIC_"+(this.audioMuted?"OFF":"ON"))})]}),this.elements.hangupButton=BX.create("div",{props:{className:"bx-messenger-call-float-button bx-messenger-call-float-button-decline"},events:{click:this.onHangupButtonClick.bind(this)},children:[BX.create("span",{props:{className:"bx-messenger-call-float-button-icon"}}),BX.create("span",{props:{className:"bx-messenger-call-float-button-text"},text:BX.message("IM_M_CALL_BTN_HANGUP")})]})]})]});this.elements.video=BX.create("video",{attrs:{autoplay:true,src:this.stream},props:{className:"bx-messenger-call-float-video",volume:0}});if(this.stream){BX.prepend(this.elements.video,this.elements.container)}this.setAvatars(this.avatars);document.body.appendChild(this.elements.container)},adjustWindow:function(e,o){var a=this.stream?t:i;var d=this.stream?n:s;e=e||a;o=o||d;if(!this.stream){var l=Math.ceil(Object.keys(this.avatars).length/4);o+=l*74+10}this.elements.container.style.width=e+"px";this.elements.container.style.height=o+"px";BX.desktop.setWindowMinSize({Width:e,Height:o});BX.desktop.setWindowResizable(false);BX.desktop.setWindowClosable(false);BX.desktop.setWindowResizable(false);BX.desktop.setWindowTitle(this.title);if(BXDesktopSystem.QuerySettings("global_topmost_x",null)){BX.desktop.setWindowPosition({X:parseInt(BXDesktopSystem.QuerySettings("global_topmost_x",STP_RIGHT)),Y:parseInt(BXDesktopSystem.QuerySettings("global_topmost_y",STP_TOP)),Width:e,Height:o,Mode:STP_FRONT});if(!BX.browser.IsMac())BX.desktop.setWindowPosition({X:parseInt(BXDesktopSystem.QuerySettings("global_topmost_x",STP_RIGHT)),Y:parseInt(BXDesktopSystem.QuerySettings("global_topmost_y",STP_TOP)),Width:e,Height:o,Mode:STP_FRONT})}else{BX.desktop.setWindowPosition({X:STP_RIGHT,Y:STP_TOP,Width:e,Height:o,Mode:STP_FRONT});if(!BX.browser.IsMac())BX.desktop.setWindowPosition({X:STP_RIGHT,Y:STP_TOP,Width:e,Height:o,Mode:STP_FRONT})}},checkVideoAspect:function(){if(this.elements.video.videoWidth<this.elements.video.videoHeight){if(this.callAspectHorizontal){this.callAspectHorizontal=false;BX.addClass(this.elements.container,"bx-messenger-call-overlay-aspect-vertical");BX.desktop.setWindowSize({Width:n,Height:t})}}else{if(!this.callAspectHorizontal){this.callAspectHorizontal=true;BX.removeClass(this.elements.container,"bx-messenger-call-overlay-aspect-vertical");BX.desktop.setWindowSize({Width:t,Height:n})}}},_onConnectionOfferFromMain:function(t){if(this.slavePeerConnection){this.slavePeerConnection.removeEventListener("icecandidate",this._onSlavePCIceCandidateHandler);this.slavePeerConnection.removeEventListener("iceconnectionstatechange",this._onSlavePCIceConnectionStateChangeHandler);this.slavePeerConnection.close()}this.slavePeerConnection=new RTCPeerConnection;this.slavePeerConnection.addEventListener("icecandidate",this._onSlavePCIceCandidateHandler);this.slavePeerConnection.addEventListener("iceconnectionstatechange",this._onSlavePCIceConnectionStateChangeHandler);var n=new RTCSessionDescription({type:"offer",sdp:t});this.slavePeerConnection.setRemoteDescription(n).then(function(){if(this.slavePeerConnection){this.slavePeerConnection.createAnswer().then(function(t){this.slavePeerConnection.setLocalDescription(t);BX.desktop.onCustomEvent("main",e.connectionAnswer,[t.sdp])}.bind(this))}}.bind(this))},_onIceCandidateFromMain:function(e){setTimeout(function(){if(this.slavePeerConnection){this.slavePeerConnection.addIceCandidate(e)}}.bind(this),200)},_onRTCconnectionClose:function(){if(this.slavePeerConnection){this.slavePeerConnection.removeEventListener("icecandidate",this._onSlavePCIceCandidateHandler);this.slavePeerConnection.removeEventListener("iceconnectionstatechange",this._onSlavePCIceConnectionStateChangeHandler);this.slavePeerConnection.close();this.slavePeerConnection=null}this.setStream(null)},_onSlavePCIceCandidate:function(t){var n=t.candidate;if(n){BX.desktop.onCustomEvent("main",e.connectionIceCandidate,[n.toJSON()])}},_onSlavePCIceConnectionStateChange:function(e){if(this.slavePeerConnection.iceConnectionState==="connected"){this.setStream(this.slavePeerConnection.getRemoteStreams()[0])}else if(this.slavePeerConnection.iceConnectionState==="disconnected"){this.setStream(null);this.slavePeerConnection.removeEventListener("icecandidate",this._onSlavePCIceCandidateHandler);this.slavePeerConnection.removeEventListener("iceconnectionstatechange",this._onSlavePCIceConnectionStateChangeHandler)}},setStream:function(e){clearInterval(this.callAspectCheckInterval);this.stream=e;var o=this.stream?t:i;var a=this.stream?n:s;var d={width:o+"px",height:a+"px"};if(this.elements.container){if(this.stream){if(!this.elements.video.parentNode){BX.prepend(this.elements.video,this.elements.container);BX.removeClass(this.elements.container,"bx-messenger-call-float-audio")}this.elements.video.srcObject=this.stream}else{BX.remove(this.elements.video);BX.addClass(this.elements.container,"bx-messenger-call-float-audio")}BX.adjust(this.elements.container,{style:d})}if(this.stream){this.callAspectCheckInterval=setInterval(this.checkVideoAspect.bind(this),500)}this.adjustWindow()},setAudioMuted:function(e){this.audioMuted=e;if(this.audioMuted){BX.addClass(this.elements.micButton,"bx-messenger-call-float-button-mic-disabled");BX.adjust(this.elements.micButtonText,{text:BX.message("IM_M_CALL_BTN_MIC")+" "+BX.message("IM_M_CALL_BTN_MIC_OFF")})}else{BX.removeClass(this.elements.micButton,"bx-messenger-call-float-button-mic-disabled");BX.adjust(this.elements.micButtonText,{text:BX.message("IM_M_CALL_BTN_MIC")+" "+BX.message("IM_M_CALL_BTN_MIC_ON")})}},setTitle:function(e){this.title=e;this.elements.title.innerText=e;BX.desktop.setWindowTitle(this.title)},setAvatars:function(e){this.avatars=e;this.elements.avatars.innerHTML="";for(var t in this.avatars){var n=this.avatars[t];var i=BX.create("div",{props:{className:"bx-messenger-call-float-avatar"},dataset:{userId:t}});if(n!=""){i.style.backgroundImage="url('"+n+"')"}this.elements.avatars.appendChild(i)}this.adjustWindow()},setTalking:function(e){this.talking=e;if(this.elements.avatars){for(var t=0;t<this.elements.avatars.children.length;t++){var n=this.elements.avatars.children[t];var i=Number(n.dataset.userId);if(this.talking.includes(i)){n.classList.add("talking")}else{n.classList.remove("talking")}}}},onMainAreaClick:function(t){BX.desktop.onCustomEvent("main",e.onMainAreaClick,[]);t.stopPropagation()},onMicButtonClick:function(t){BX.desktop.onCustomEvent("main",e.onMicButtonClick,[this.audioMuted]);t.stopPropagation()},onHangupButtonClick:function(t){BX.desktop.onCustomEvent("main",e.onHangupButtonClick,[]);t.stopPropagation()},destroy:function(){this.stream=null;BX.desktop.removeCustomEvents(e.setStream);BX.desktop.removeCustomEvents(e.setAudioMuted)}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:47:"/bitrix/js/im/call/logger.min.js?15995682962518";s:6:"source";s:28:"/bitrix/js/im/call/logger.js";s:3:"min";s:32:"/bitrix/js/im/call/logger.min.js";s:3:"map";s:32:"/bitrix/js/im/call/logger.map.js";}"*/
(function(){BX.namespace("BX.Call");BX.Call.Logger=function(e,t){this.serviceUrl=e;this.token=t;this.socket=null;this.attempt=0;this.reconnectTimeout=null;this.unsentMessages=[];this.onSocketOpenHandler=this.onSocketOpen.bind(this);this.onSocketCloseHandler=this.onSocketClose.bind(this);this.onSocketErrorHandler=this.onSocketError.bind(this);Object.defineProperty(this,"isConnected",{get:function(){return this.socket&&this.socket.readyState===1}});this.connect()};BX.Call.Logger.prototype={log:function(e){if(typeof e!="string"){console.error("Message should be string");return}if(this.isConnected){this.socket.send(JSON.stringify({action:"log",message:e}))}else{this.unsentMessages.push(e)}},connect:function(){if(this.socket){return}if(!this.serviceUrl){console.error("Logging service url is empty");return}if(!this.serviceUrl.startsWith("ws://")&&!this.serviceUrl.startsWith("wss://")){console.error("Logging service url should start with ws:// or wss://");return}if(!this.token){console.eror("Logging token is empty");return}this.attempt++;this.socket=new WebSocket(this.serviceUrl+"?token="+this.token);this.bindSocketEvents()},scheduleReconnect:function(){clearTimeout(this.reconnectTimeout);if(this.attempt>3){console.error("Could not connect to the logging service, giving up");return}this.reconnectTimeout=setTimeout(this.connect.bind(this),this.getConnectionDelay(this.attempt)*1e3)},getConnectionDelay:function(e){switch(e){case 0:case 1:return 15;case 2:return 30;default:return 60}},disconnect:function(){clearTimeout(this.reconnectTimeout);if(this.socket){this.removeSocketEvents();this.socket.close(1e3);this.socket=null}},bindSocketEvents:function(){this.socket.addEventListener("open",this.onSocketOpenHandler);this.socket.addEventListener("close",this.onSocketCloseHandler);this.socket.addEventListener("error",this.onSocketErrorHandler)},removeSocketEvents:function(){this.socket.removeEventListener("open",this.onSocketOpenHandler);this.socket.removeEventListener("close",this.onSocketCloseHandler);this.socket.removeEventListener("error",this.onSocketErrorHandler)},onSocketOpen:function(){this.attempt=0;for(var e=0;e<this.unsentMessages.length;e++){this.socket.send(JSON.stringify({action:"log",message:this.unsentMessages[e]}))}this.unsentMessages=[]},onSocketClose:function(){this.socket=null;this.scheduleReconnect()},onSocketError:function(){this.socket=null;this.scheduleReconnect()},destroy:function(){this.disconnect();this.unsentMessages=null}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:55:"/bitrix/js/im/call/video_strategy.min.js?15995682964901";s:6:"source";s:36:"/bitrix/js/im/call/video_strategy.js";s:3:"min";s:40:"/bitrix/js/im/call/video_strategy.min.js";s:3:"map";s:40:"/bitrix/js/im/call/video_strategy.map.js";}"*/
(function(){BX.namespace("BX.Call");if(BX.Call.VideoStrategy){return}var e={AllowAll:"AllowAll",AllowNone:"AllowNone",OnlySpeaker:"OnlySpeaker",CurrentlyTalking:"CurrentlyTalking"};var t=20;BX.Call.VideoStrategy=function(t){this.call=t.call;this.callView=t.callView;this.strategyType=t.strategyType||e.AllowAll;this.onCallUserVoiceStartedHandler=this.onCallUserVoiceStarted.bind(this);this.onCallUserVoiceStoppedHandler=this.onCallUserVoiceStopped.bind(this);this.onCallViewSetCentralUserHandler=this.onCallViewSetCentralUser.bind(this);this.onCallViewLayoutChangeHandler=this.onCallViewLayoutChange.bind(this);this.users={};this.init()};BX.Call.VideoStrategy.prototype.init=function(){if(this.strategyType===BX.Call.VideoStrategy.AllowAll){this.call.allowVideoFrom(BX.Call.UserMnemonic.all)}else if(this.strategyType===BX.Call.VideoStrategy.AllowNone){this.call.allowVideoFrom(BX.Call.UserMnemonic.none)}this.bindEvents()};BX.Call.VideoStrategy.prototype.bindEvents=function(){this.call.addEventListener(BX.Call.Event.onUserVoiceStarted,this.onCallUserVoiceStartedHandler);this.call.addEventListener(BX.Call.Event.onUserVoiceStopped,this.onCallUserVoiceStoppedHandler);this.callView.subscribe(BX.Call.View.Event.onSetCentralUser,this.onCallViewSetCentralUserHandler);this.callView.subscribe(BX.Call.View.Event.onLayoutChange,this.onCallViewLayoutChangeHandler)};BX.Call.VideoStrategy.prototype.removeEvents=function(){if(this.call){this.call.removeEventListener(BX.Call.Event.onUserVoiceStarted,this.onCallUserVoiceStartedHandler);this.call.removeEventListener(BX.Call.Event.onUserVoiceStopped,this.onCallUserVoiceStoppedHandler)}if(this.callView){this.callView.unsubscribe(BX.Call.View.Event.onSetCentralUser,this.onCallViewSetCentralUserHandler);this.callView.unsubscribe(BX.Call.View.Event.onLayoutChange,this.onCallViewLayoutChangeHandler)}};BX.Call.VideoStrategy.prototype.setType=function(e){if(e==this.strategyType){return}this.strategyType=e;this.applyVideoLimit()};BX.Call.VideoStrategy.prototype.applyVideoLimit=function(){if(this.strategyType===e.AllowAll){this.call.allowVideoFrom(BX.Call.UserMnemonic.all)}else if(this.strategyType===e.AllowNone){this.call.allowVideoFrom(BX.Call.UserMnemonic.none)}else if(this.strategyType===e.CurrentlyTalking){var t=this.getActiveUsers();console.log("talking users",t);if(t.length===0){this.call.allowVideoFrom(BX.Call.UserMnemonic.none)}else{this.call.allowVideoFrom(this.getActiveUsers())}}};BX.Call.VideoStrategy.prototype.getActiveUsers=function(){var e=[];for(var t in this.users){var i=this.users[t];if(i.active){e.push(i.id)}}return e};BX.Call.VideoStrategy.prototype.onUserActiveChanged=function(){if(this.strategyType==e.CurrentlyTalking){this.applyVideoLimit()}};BX.Call.VideoStrategy.prototype.onCallUserVoiceStarted=function(e){var t=e.userId;if(!this.users[t]){this.users[t]=new i({id:t,onActiveChanged:this.onUserActiveChanged.bind(this)})}this.users[t].setTalking(true)};BX.Call.VideoStrategy.prototype.onCallUserVoiceStopped=function(e){var t=e.userId;if(!this.users[t]){this.users[t]=new i({id:t,onActiveChanged:this.onUserActiveChanged.bind(this)})}this.users[t].setTalking(false)};BX.Call.VideoStrategy.prototype.onCallViewSetCentralUser=function(t){var i=t.data.userId;if(this.strategyType===e.OnlySpeaker){console.log("requesting video only from "+i);this.call.allowVideoFrom([i])}};BX.Call.VideoStrategy.prototype.onCallViewLayoutChange=function(e){};BX.Call.VideoStrategy.prototype.destroy=function(){this.removeEvents();this.call=null;this.callView=null;for(var e in this.users){if(this.users.hasOwnProperty(e)){this.users[e].destroy()}}this.users={}};var i=function(e){this.id=e.id;this.talking=false;this.sharing=false;this.active=false;this.callbacks={onActiveChanged:BX.type.isFunction(e.onActiveChanged)?e.onActiveChanged:BX.DoNothing};this.turnOffVideoTimeout=null};i.prototype.setTalking=function(e){if(this.talking==e){return}this.talking=e;if(this.talking){this.cancelTurnOffVideo();this.updateActive()}else{this.scheduleTurnOffVideo()}};i.prototype.setSharing=function(e){if(this.sharing==e){return}this.sharing=e;if(this.sharing){this.cancelTurnOffVideo();this.updateActive()}else{this.scheduleTurnOffVideo()}};i.prototype.updateActive=function(){var e=!!(this.sharing||this.talking||this.turnOffVideoTimeout);if(e!=this.active){this.active=e}this.callbacks.onActiveChanged({userId:this.id,active:this.active})};i.prototype.scheduleTurnOffVideo=function(){clearTimeout(this.turnOffVideoTimeout);this.turnOffVideoTimeout=setTimeout(function(){this.turnOffVideoTimeout=null;this.updateActive()}.bind(this),t*1e3)};i.prototype.cancelTurnOffVideo=function(){clearTimeout(this.turnOffVideoTimeout);this.turnOffVideoTimeout=null};i.prototype.destroy=function(){this.callbacks.onActiveChanged=BX.DoNothing;clearTimeout(this.turnOffVideoTimeout)};BX.Call.VideoStrategy.Type=e})();
/* End */
;
//# sourceMappingURL=kernel_im.map.js